[{"title":"ç½‘æ˜“KMç¤¾åŒºåˆ†äº«-å°Pè€å¸ˆæœåŠ¡GCå¡é¡¿å®šä½è§£å†³","url":"/2025/03/04/ç½‘æ˜“KMç¤¾åŒºåˆ†äº«-å°Pè€å¸ˆæœåŠ¡GCå¡é¡¿å®šä½è§£å†³/","content":"> å°Pè€å¸ˆä½œä¸ºæœ‰é“AIå¤§æ¨¡å‹çš„é‡ç‚¹æœåŠ¡ï¼Œç¨³å®šæ€§ä¸ä½å»¶è¿Ÿè‡³å…³é‡è¦ã€‚ä½†éšç€å¼€å­¦å­£åˆ°æ¥ï¼Œæ¥å£æµé‡å¢åŠ ï¼ŒæœåŠ¡å¶ç°è¯·æ±‚å»¶è¿Ÿå‡é«˜å’ŒGCå¡é¡¿å¼‚å¸¸é‡å¯ç°è±¡ã€‚\n> æœ¬æ–‡æ€»ç»“ä¸Šè¿°é—®é¢˜çš„æ’æŸ¥æ€è·¯åŠå®šä½è¿‡ç¨‹ï¼Œç›¸ä¿¡å¯¹é‡åˆ°å†…å­˜æ³„æ¼ã€CPUå‡é«˜ã€JVM GCå¼‚å¸¸ç­‰é—®é¢˜çš„å°ä¼™ä¼´ï¼Œæœ‰å€Ÿé‰´æ„ä¹‰ã€‚\n\n# ä¸€ã€èƒŒæ™¯å’Œç°è±¡\nå°Pè€å¸ˆæœåŠ¡ï¼ˆjavaæœåŠ¡å®¹å™¨éƒ¨ç½²ã€jdk17ã€G1å›æ”¶å™¨ï¼‰æ ¸å¿ƒä»»åŠ¡æ˜¯æä¾›æ•™è‚²åœºæ™¯ä¸‹çš„å¤§æ¨¡å‹å¯¹è¯å¼é—®ç­”ã€‚éšç€å¼€å­¦å­£åˆ°æ¥ï¼Œæµé‡ä¹Ÿé€æ¸ä¸Šå‡ï¼Œä¿éšœæœåŠ¡ç¨³å®šæ€§æ˜¯æ¯”è¾ƒé‡è¦çš„ä»»åŠ¡ä¹‹ä¸€ã€‚\n\nå¤§æ¨¡å‹å¯¹è¯å¼é—®ç­”é€šå¸¸æ˜¯ä¸€ä¸ªæµå¼è¿‡ç¨‹ï¼Œæ¨¡å‹å›ç­”æ˜¯ä¸€æ®µä¸€æ®µè¾“å‡ºç»™ç”¨æˆ·çš„ï¼Œä¸ºäº†è§‚å¯Ÿåˆ°æ•´ä¸ªæ¨¡å‹çš„å»¶æ—¶æƒ…å†µï¼Œå¤§æ¨¡å‹å›ç­”å®Œæ¯•çš„æ—¶é—´(total time)ä»¥åŠå¤§æ¨¡å‹æ¯ä¸€æ®µå›ç­”çš„æ—¶é—´(interval time)éƒ½æ·»åŠ äº†ç›‘æ§ã€‚\n\nè¿‘æœŸå‘ç°ï¼Œå°Pè€å¸ˆæœåŠ¡é‡Œå­æ›°å¤§æ¨¡å‹interval timeçš„ç›‘æ§æ€»æ˜¯è¶…æ—¶å‘Šè­¦ï¼Œä½†æ˜¯å­æ›°å¤§æ¨¡å‹è‡ªèº«çš„interval timeç›‘æ§ç¡®å®æ­£å¸¸çš„ï¼ŒåŒæ—¶å¾ˆå¥‡æ€ªçš„æ˜¯åªæœ‰ä¸€ä¸ªæˆ–è€…éƒ¨åˆ†å®¹å™¨podå‡ºé—®é¢˜ã€‚\n\nè¿™ä¸¤ä¸ªç›‘æ§æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿç®€å•æ¥è¯´ä¸€ä¸ªæ˜¯Aä½¿ç”¨Bæ—¶å¯¹Bçš„ç›‘æ§ï¼Œå¦å¤–ä¸€ä¸ªæ˜¯Bå¯¹è‡ªèº«çš„ç›‘æ§ï¼Œæ‰€ä»¥ç†è®ºæ¥è¯´ä»–ä¸¤ç›‘æ§åº”è¯¥åŸºæœ¬ä¸€è‡´æ‰æ˜¯ç¬¦åˆé¢„æœŸçš„ï¼ˆæŠ›å»ç½‘ç»œå»¶æ—¶ï¼‰ã€‚\n\nä»è¿™ä¸€ç°è±¡çœ‹ï¼Œè¯´æ˜å°Pè€å¸ˆæœ¬èº«ä»£ç é€»è¾‘å­˜åœ¨è€—æ—¶æƒ…å†µæˆ–è€…ç½‘ç»œæœ‰é—®é¢˜ã€‚\n\nå¦å¤–ä¹‹å‰å°Pä¹Ÿå‡ºç°è¿‡ç±»ä¼¼æƒ…å†µï¼Œæˆ‘ä»¬ä½¿ç”¨äº†Huggingfaceå»åšå¤§æ¨¡å‹tokenè®¡ç®—ï¼Œè¿™ä¸ªç»„ä»¶cpuå ç”¨ç‡å¾ˆå¤šï¼Œæ‰€ä»¥æŒ‰ç…§ä¹‹å‰æƒ¯ä¾‹ä¼šæŸ¥çœ‹cpuæ˜¯å¦å¤Ÿç”¨ã€‚\n![img.png](../img/netease/littleP/img.png)\n\n![img_1.png](../img/netease/littleP/img_1.png)\n\nå›¾1 å®¹å™¨cpuä½¿ç”¨å›¾\n\n\n![img_2.png](../img/netease/littleP/img_2.png)\n\nå›¾2 jvmç›‘æ§å›¾\n\näºæ˜¯å‘ç°äº†å›¾1è¿™æ ·çš„ç°è±¡ï¼Œåœ¨å®¹å™¨cpuç›‘æ§å›¾ä¸­å‘ç°åœ¨æœåŠ¡å‘Šè­¦æœŸé—´cpu usagesï¼ˆä½¿ç”¨é‡ï¼‰å’Œcpu cfs throttledï¼ˆæŠ¢å ï¼‰æœ‰å°–åˆºã€‚åŒæ—¶ä¹Ÿæ˜¯æœºç¼˜å·§åˆï¼Œæƒ³çœ‹çœ‹jvmé‡Œcpuä½¿ç”¨å ç”¨ç‡å¤šå°‘ï¼Œäºæ˜¯åœ¨å›¾2ï¼ˆé»„è‰²çº¿æ˜¯åˆ†é…çš„å†…å­˜ã€ç»¿è‰²çº¿æ˜¯ä½¿ç”¨çš„å†…å­˜)å‘ç°äº†æ¯”è¾ƒé‡è¦çš„ä¸€ä¸ªä¿¡æ¯ï¼Œjvmåœ¨è¿™æœŸé—´edenåŒºåˆ†é…é™ä½ï¼ŒoldåŒºä½¿ç”¨ã€åˆ†é…æ¿€å¢ï¼Œç»´æŒäº†ä¸€æ®µæ—¶é—´åå°±è‡ªè¡Œæ¢å¤äº†ã€‚äºæ˜¯æˆ‘ä¾¿å»æŸ¥çœ‹äº†ä¸€æ®µæ—¶é—´å†…çš„GCæ—¥å¿—\n\n```text\n[2024-10-23T20:23:56.727+0800] GC(77) Pause Young (Normal) (G1 Evacuation Pause)\n[2024-10-23T20:23:56.727+0800] GC(77) Using 1 workers of 1 for evacuation\n[2024-10-23T20:24:02.147+0800] GC(77) MMU target violated: 201.0ms (200.0ms/201.0ms)\n[2024-10-23T20:24:02.147+0800] GC(77)   Pre Evacuate Collection Set: 12.5ms\n[2024-10-23T20:24:02.147+0800] GC(77)   Merge Heap Roots: 56.7ms\n[2024-10-23T20:24:02.147+0800] GC(77)   Evacuate Collection Set: 5334.5ms\n[2024-10-23T20:24:02.147+0800] GC(77)   Post Evacuate Collection Set: 15.4ms\n[2024-10-23T20:24:02.147+0800] GC(77)   Other: 0.5ms\n[2024-10-23T20:24:02.147+0800] GC(77) Eden regions: 482->0(63)\n[2024-10-23T20:24:02.147+0800] GC(77) Survivor regions: 17->13(63)\n[2024-10-23T20:24:02.147+0800] GC(77) Old regions: 32->32\n[2024-10-23T20:24:02.147+0800] GC(77) Archive regions: 2->2\n[2024-10-23T20:24:02.147+0800] GC(77) Humongous regions: 473->456 // æ ‡è®°1\n[2024-10-23T20:24:02.147+0800] GC(77) Metaspace: 156861K(158080K)->156861K(158080K) NonClass: 139277K(139840K)->139277K(139840K) Class: 17583K(18240K)->17583K(18240K)\n[2024-10-23T20:24:02.147+0800] GC(77) Pause Young (Normal) (G1 Evacuation Pause) 4018M->2007M(6144M) 5419.626ms // æ ‡è®°2\n[2024-10-23T20:24:02.147+0800] GC(77) User=5.08s Sys=0.20s Real=5.42s // æ ‡è®°3\n```\n\nç¡®å®å‘ç°äº†å¼‚å¸¸çš„ç‚¹ï¼Œæ ‡è®°1å¯ä»¥çœ‹å‡ºHumongous regionsæ•°é‡éå¸¸å¤šä¸”è¿™ä¸€æ¬¡GCå¹¶æ²¡æœ‰å›æ”¶è¯¥åŒºåŸŸçš„å†…å®¹ã€‚(Normal GCæ˜¯ä¼šå›æ”¶HumongousåŒºåŸŸçš„)\n\næ ‡è®°2å¯ä»¥çœ‹å‡ºæ•´ä¸ªGCè€—æ—¶å¤§æ¦‚5.4sï¼Œå½“ç„¶ä»æ ‡è®°3å¯ä»¥æ›´æ¸…æ¥šçš„çœ‹å‡ºGCè€—æ—¶ï¼Œæ‰€ä»¥æˆ‘ä»¬çŒœæµ‹å­æ›°å¤§æ¨¡å‹interval timeå‘Šè­¦å¯èƒ½å’ŒGCè€—æ—¶è¿‡ä¹…æœ‰å…³ç³»ã€‚\n\nè‡³æ­¤æˆ‘ä»¬æ•´åˆä¸€ä¸‹é—®é¢˜ç°è±¡ï¼š\n\n- å°Pè€å¸ˆæœåŠ¡å¯¹å­æ›°å¤§æ¨¡å‹çš„å»¶æ—¶ç›‘æ§å‘ç”Ÿå‘Šè­¦ï¼Œä¸”ä¸å­æ›°å¤§æ¨¡å‹è‡ªèº«ç›‘æ§ä¸ä¸€è‡´\n- åªæœ‰ä¸€éƒ¨åˆ†podæœ‰é—®é¢˜\n- å‘Šè­¦æœŸé—´æœåŠ¡cpuä½¿ç”¨ç‡æ¿€å¢\n- å‘Šè­¦æœŸé—´jvmå†…å­˜edenåŒºåŸŸåˆ†é…å‡å°‘ï¼ŒoldåŒºåŸŸä½¿ç”¨ã€åˆ†é…æ¿€å¢ï¼Œä¸€æ®µæ—¶é—´åæ¢å¤\n\nHumongous regionså›æ”¶ä¸æ˜æ˜¾ï¼ŒGCåœé¡¿è¿‡é•¿\n\næ ¹æ®ä¸Šè¿°ç°è±¡ï¼Œæˆ‘ä»¬å¯ä»¥åˆ¤æ–­å‡ºæœåŠ¡å»¶æ—¶å‘Šè­¦æ—¶å’ŒGCæœ‰å…³ç³»ï¼Œä¹Ÿå°±æ˜¯éœ€è¦ä»å†…å­˜çš„è§’åº¦æ¥åˆ†æä¸ºä»€ä¹ˆGCä¼šåœé¡¿è¿™ä¹ˆä¹…ï¼Œå¯ä»¥ç®—æ˜¯ä¸€ä¸ªåˆ‡å…¥ç‚¹ã€‚\n\nåˆ†æå†…å­˜æœ‰ä¸€ä¸ªå¾—åŠ›å·¥å…·[MemeoryAnayzer(MAT)](https://eclipse.dev/mat/)ï¼Œæ¥ä¸‹æ¥ä¼šå…ˆé‡ç‚¹ä»‹ç»ä¸€ä¸‹è¿™ä¸ªå·¥å…·ï¼ŒåŒæ—¶ä¹Ÿä¼šä»‹ç»åœ¨jdk17ä¸­çš„G1åƒåœ¾å›æ”¶å™¨ã€‚å½“ç„¶å¦‚æœå¯¹æ­¤ç†Ÿæ‚‰çš„å¯ä»¥ç›´æ¥è·³è¿‡çœ‹[å®šä½è¿‡ç¨‹](https://km.netease.com/v4/section/tm599/detail/blog/234938#4)ã€‚\n\n# äºŒã€Garbage-First (G1) åƒåœ¾å›æ”¶å™¨\n> [å¼•ç”¨æ–‡ç« ](https://docs.oracle.com/en/java/javase/17/gctuning/garbage-first-g1-garbage-collector1.html#GUID-ED3AB6D3-FD9B-4447-9EDF-983ED2F7A573)\n\nGarbage-First (G1) åƒåœ¾æ”¶é›†å™¨é’ˆä¸»è¦å¯¹å¤§å†…å­˜å¤šæ ¸çš„æœåŠ¡ï¼Œç›®çš„æ˜¯å®ç°åº”ç”¨ç¨‹åºå’Œç¯å¢ƒåœ¨å»¶è¿Ÿå’Œååé‡ä¹‹é—´çš„æœ€ä½³å¹³è¡¡ã€‚\n\nç‰¹ç‚¹ï¼š\n\n- æœåŠ¡å †å¤§å°å¤§äº10GBã€‚\n- å¯¹è±¡åˆ†é…å’Œå¯¹è±¡ç§»åŠ¨çš„é€Ÿåº¦å¯èƒ½ä¼šéšç€æ—¶é—´çš„æ¨ç§»è€Œå‘ç”Ÿå¾ˆå¤§å˜åŒ–ã€‚\n> Rates of object allocation and promotion that can vary significantly over time.\n- å †ä¸­å­˜åœ¨å¤§é‡ç¢ç‰‡ã€‚\n- å¯é¢„æµ‹çš„æš‚åœæ—¶é—´ç›®æ ‡ä¸è¶…è¿‡å‡ ç™¾æ¯«ç§’ï¼Œé¿å…é•¿æ—¶é—´çš„åƒåœ¾æ”¶é›†æš‚åœã€‚\n\n## 2.1 åŸºæœ¬æ¦‚å¿µ\nG1 å°†å †åˆ†ä¸º**å¹´è½»ä»£**ï¼ˆyoungï¼‰å’Œ**è€å¹´ä»£**ï¼ˆgenï¼‰ã€‚ç©ºé—´å›æ”¶å·¥ä½œé›†ä¸­åœ¨æœ€é«˜æ•ˆçš„å¹´è½»ä»£ä¸Šï¼Œå¶å°”ä¹Ÿä¼šåœ¨è€å¹´ä»£è¿›è¡Œç©ºé—´å›æ”¶ã€‚\n\nG1 é¦–å…ˆå›æ”¶æœ€é«˜æ•ˆåŒºåŸŸçš„ç©ºé—´ï¼ˆå³å¤§éƒ¨åˆ†è¢«åƒåœ¾å¡«å……çš„åŒºåŸŸï¼Œå› æ­¤å¾—åï¼‰ã€‚\n\nG1 ä¸»è¦é€šè¿‡æ’¤ç¦»ï¼ˆevacuationï¼‰æ¥å›æ”¶ç©ºé—´ï¼šåœ¨é€‰å®šçš„å†…å­˜åŒºåŸŸæ‰¾åˆ°å­˜æ´»å¯¹è±¡å¤åˆ¶åˆ°æ–°çš„å†…å­˜åŒºåŸŸï¼Œå¹¶åœ¨è¿‡ç¨‹ä¸­å¯¹å…¶è¿›è¡Œå‹ç¼©ã€‚æ’¤ç¦»å®Œæˆåï¼Œå…ˆå‰çš„ç©ºé—´å¯ç”¨æ¥é‡æ–°åˆ†é…ã€‚\n\nG1ä¸æ˜¯å®æ—¶æ”¶é›†å™¨ã€‚å°è¯•å°½å¯èƒ½åœ¨è®¾å®šçš„æš‚æ—¶æ—¶é—´ä¸‹å®Œæˆå›æ”¶ï¼Œä½†å¯¹äºç»™å®šçš„æš‚åœï¼Œä¸èƒ½ä¿è¯ç»å¯¹æ»¡è¶³ã€‚\n\n## 2.2 å †å¸ƒå±€\n\n![img_3.png](../img/netease/littleP/img_3.png)\n\nå›¾3 G1åƒåœ¾å›æ”¶å™¨\n\nå¹´è½»ä»£åŒ…å«edenåŒºåŸŸï¼ˆçº¢è‰²ï¼‰å’ŒsurvivoråŒºåŸŸï¼ˆçº¢è‰²ï¼Œå¸¦â€œSâ€ï¼‰ã€‚è¿™äº›åŒºåŸŸå†…éƒ¨æ˜¯è¿ç»­çš„ï¼Œä½†åœ¨G1ä¸­è¿™äº›åŒºåŸŸé€šå¸¸ä»¥éè¿ç»­æ¨¡å¼æ’åˆ—åœ¨å†…å­˜ä¸­ã€‚oldåŒºåŸŸï¼ˆæµ…è“è‰²ï¼‰æ„æˆè€ç”Ÿä»£ã€‚å¯¹äºè·¨å¤šä¸ªåŒºåŸŸçš„å¯¹è±¡ï¼Œä¼šæœ‰ä¸€ä¸ªéå¸¸å¤§çš„oldåŒºåŸŸï¼ˆæµ…è“è‰²ï¼Œå¸¦â€œHâ€ï¼‰ï¼Œå«åšHumongousåŒºåŸŸ ã€‚\n\nåº”ç”¨ç¨‹åºæ€»æ˜¯åˆ†é…åˆ°å¹´è½»ä»£ï¼Œå³edenåŒºåŸŸï¼Œå·¨å¤§å¯¹è±¡è¢«åˆ†é…åˆ°oldåŒºåŸŸã€‚\n\n## 2.3 åƒåœ¾å›æ”¶å‘¨æœŸ\nG1 æ”¶é›†å™¨åœ¨ä¸¤ä¸ªé˜¶æ®µä¹‹é—´äº¤æ›¿ã€‚young-onlyé˜¶æ®µåŒ…æ‹¬åƒåœ¾å›æ”¶(garbage collections)ï¼Œè¿™ä¸ªé˜¶æ®µä¼šé€æ¸å¡«æ»¡å½“å‰å¯ç”¨çš„å†…å­˜\n\nç©ºé—´å›æ”¶é˜¶æ®µæ˜¯ G1 é™¤äº†å¤„ç†å¹´è½»ä»£ä¹‹å¤–ï¼Œè¿˜ä¼šé€æ­¥å›æ”¶è€ç”Ÿä»£ä¸­çš„ç©ºé—´ã€‚ç„¶åï¼Œå¾ªç¯ä»å¹´è½»ä»£é˜¶æ®µé‡æ–°å¼€å§‹ã€‚\n\n![img_4.png](../img/netease/littleP/img_4.png)\n\nå›¾4 åƒåœ¾å›æ”¶å‘¨æœŸé¢„è§ˆ\n\nä»¥ä¸‹åˆ—è¡¨è¯¦ç»†æè¿°äº† G1 åƒåœ¾æ”¶é›†å‘¨æœŸçš„å„ä¸ªé˜¶æ®µã€æš‚åœä»¥åŠé˜¶æ®µä¹‹é—´çš„è½¬æ¢ï¼š\n\n1. ä»…å¹´è½»ä»£é˜¶æ®µï¼ˆYoung-only phaseï¼‰ï¼šæ­¤é˜¶æ®µä»¥Normal young collectionsæ”¶é›†å¼€å§‹ï¼Œä¼šå°†å¯¹è±¡æå‡åˆ°è€å¹´ä»£ã€‚å½“è€å¹´ä»£å ç”¨ç‡è¾¾åˆ°æŸä¸ªé˜ˆå€¼æ—¶ï¼ŒYoung-only phaseå’ŒSpace-reclamation phaseä¹‹é—´çš„è¿‡æ¸¡å°±å¼€å§‹äº†ã€‚æ­¤æ—¶ï¼ŒG1 ä¼šæ‰§è¡ŒConcurrent Start young collectionï¼Œè€Œä¸æ˜¯Normalyoung collectionsã€‚\n\n    - Concurrent Startï¼šè¿™ç§ç±»å‹çš„æ”¶é›†é™¤äº†æ‰§è¡Œå¸¸è§„Normalyoung collectionsï¼Œè¿˜å¯åŠ¨æ ‡è®°è¿‡ç¨‹ã€‚å¹¶å‘æ ‡è®°ç¡®å®šoldåŒºåŸŸä¸­çš„æ˜¯å¦å¯ä»¥è¢«å›æ”¶ã€‚åœ¨æ”¶é›†æ ‡è®°å°šæœªå®Œå…¨å®Œæˆæ—¶ï¼Œå¯èƒ½ä¼šå‘ç”ŸNormalyoung collectionsã€‚\n\n    - Remarkï¼šæ­¤è¿™æ®µä¼šå®Œæˆé‡æ–°æ ‡è®°ã€‚\n\n    - Cleanupï¼šè¿™ä¸ªé˜¶æ®µå†³å®šæ˜¯å¦è¿›è¡ŒSpace-reclamation phaseã€‚å¦‚æœç¡®å®šè¿›è¡ŒSpace-reclamation phaseï¼Œé‚£ä¹ˆYoung-only phaseå°±ä¼šè¿›è¡Œä¸€æ¬¡Prepare Mixed young collection.\n\n2. ç©ºé—´å›æ”¶é˜¶æ®µï¼ˆSpace-reclamation phaseï¼‰ï¼šæ­¤é˜¶æ®µä¼šè¿›è¡ŒMixed collectionsï¼Œé™¤äº†youngåŒºåŸŸå¤–ï¼Œè¿˜ä¼šæ’¤ç¦»oldåŒºåŸŸä¸­çš„å­˜æ´»å¯¹è±¡ã€‚å½“ G1 ç¡®å®šæ’¤ç¦»æ›´å¤šè€ç”Ÿä»£åŒºåŸŸä¸ä¼šäº§ç”Ÿè¶³å¤Ÿçš„å¯ç”¨ç©ºé—´æ—¶ï¼Œç©ºé—´å›æ”¶é˜¶æ®µç»“æŸã€‚\n\n> 1. Young-only phase: This phase starts with a few Normal young collections that promote objects into the old generation. The transition between the young-only phase and the space-reclamation phase starts when the old generation occupancy reaches a certain threshold, the Initiating Heap Occupancy threshold. At this time, G1 schedules a Concurrent Start young collection instead of a Normal young collection.\n\n> - Concurrent Start : This type of collection starts the marking process in addition to performing a Normal young collection. Concurrent marking determines all currently reachable (live) objects in the old generation regions to be kept for the following space-reclamation phase. While collection marking hasnâ€™t completely finished, Normal young collections may occur. Marking finishes with two special stop-the-world pauses: Remark and Cleanup.\n\n> - Remark: This pause finalizes the marking itself, performs global reference processing and class unloading, reclaims completely empty regions and cleans up internal data structures. Between Remark and Cleanup G1 calculates information to later be able to reclaim free space in selected old generation regions concurrently, which will be finalized in the Cleanup pause.\n\n> - Cleanup: This pause determines whether a space-reclamation phase will actually follow. If a space-reclamation phase follows, the young-only phase completes with a single Prepare Mixed young collection.\n\n> 2. Space-reclamation phase: This phase consists of multiple Mixed collections that in addition to young generation regions, also evacuate live objects of sets of old generation regions. The space-reclamation phase ends when G1 determines that evacuating more old generation regions wouldn't yield enough free space worth the effort.\n\nç©ºé—´å›æ”¶åï¼Œæ”¶é›†å‘¨æœŸå°†ä»¥å¦ä¸€ä¸ªå¹´è½»é˜¶æ®µé‡æ–°å¯åŠ¨ã€‚ä½œä¸ºå…œåº•ï¼Œå¦‚æœåº”ç”¨ç¨‹åºåœ¨æ”¶é›†æ´»è·ƒåº¦ä¿¡æ¯æ—¶å†…å­˜ä¸è¶³ï¼ŒG1 å°†åƒå…¶ä»–æ”¶é›†å™¨ä¸€æ ·æ‰§è¡Œå°±ä¼šæ‰§è¡ŒFull\n\n## 2.4 åƒåœ¾å›æ”¶é˜¶æ®µå’Œå›æ”¶é›†\n> garbage Collection Pauses and Collection Set\n\nG1æ‰§è¡Œåƒåœ¾æ”¶é›†å’Œç©ºé—´å›æ”¶æ˜¯åœ¨stop-the-world pausesæ—¶é—´å†…å®Œæˆçš„ï¼Œå­˜æ´»çš„å¯¹è±¡ä¼šä»å †çš„ä¸€ä¸ªåŒºåŸŸç§»åŠ¨åˆ°å¦ä¸€ä¸ªåŒºåŸŸï¼Œå¹¶ä¸”å¯¹è¿™äº›å¯¹è±¡çš„å¼•ç”¨ä¹Ÿä¼šè°ƒæ•´ã€‚\n\nå¯¹äºnon-humongousçš„ç§»åŠ¨ï¼š\n- å¹´è½»ä¸€ä»£ï¼ˆedenå’Œsurvivorï¼‰çš„å¯¹è±¡è¢«å¤åˆ¶åˆ°survivoråŒºåŸŸæˆ–oldåŒºåŸŸï¼Œå–å†³äºå®ƒä»¬çš„å¹´é¾„ã€‚\n- æ¥è‡ªoldçš„å¯¹è±¡è¢«å¤åˆ¶åˆ°å…¶ä»–old\n\nå¯¹äºå¤§å¯¹è±¡æ¥è¯´ï¼Œé™¤éè¢«å›æ”¶ä¸ç„¶æ°¸è¿œä¸ä¼šè¢«ç§»åŠ¨ã€‚\n\nå¯¹äºå›æ”¶é›†ï¼ˆcollection setï¼‰ï¼š\n- åœ¨ Young-Only ï¼Œå›æ”¶é›†ä»…ç”±å¹´è½»ä¸€ä»£çš„åŒºåŸŸä»¥åŠå¯èƒ½è¢«å›æ”¶çš„å·¨å¤§åŒºåŸŸç»„æˆã€‚\n- åœ¨ç©ºé—´å›æ”¶ï¼ˆSpace-reclamationï¼‰é˜¶æ®µï¼Œå›æ”¶é›†ç”±å¹´è½»ä»£ä¸­çš„åŒºåŸŸã€åŒ…å«å¯èƒ½è¢«å›æ”¶çš„å¯¹è±¡çš„å·¨å¤§åŒºåŸŸã€ä»¥åŠæ¥è‡ªæ”¶é›†é›†åˆå€™é€‰åŒºåŸŸçš„ä¸€äº›è€ç”Ÿä»£åŒºåŸŸç»„æˆã€‚\n\nG1 åœ¨å¹¶å‘å‘¨æœŸï¼ˆconcurrent cycleï¼‰å†…å‡†å¤‡å›æ”¶é›†å€™é€‰åŒºåŸŸã€‚åœ¨Remark pauseï¼ŒG1 é€‰æ‹©å¤§é‡é—²ç½®ç©ºé—´çš„ä½åˆ©ç”¨ç‡åŒºåŸŸã€‚ç„¶ååœ¨ Remark å’ŒCleanup pauseä¹‹é—´å¹¶å‘å‡†å¤‡è¿™äº›åŒºåŸŸä»¥ä¾›ä»¥åæ”¶é›†ä½¿ç”¨ã€‚Cleanup pauseæ ¹æ®æ•ˆç‡å¯¹å‡†å¤‡çš„ç»“æœè¿›è¡Œæ’åºã€‚æ›´é«˜æ•ˆçš„åŒºåŸŸæ˜¯è¯´ï¼Œæœ‰æ›´å¤šçš„ç©ºé—´å¹¶ä¸”å›æ”¶çš„æ—¶é—´æ›´å°‘ã€‚mixedcollectionsä¼šæ›´å–œæ¬¢è¿™äº›åŒºåŸŸã€‚\n\n# ä¸‰ã€MemeoryAnayzer(MAT)\n> https://eclipse.dev/mat/\n\n## 3.1 é‡è¦æ¦‚å¿µ\n### 3.1.1 å¯è¾¾æ€§\n**å¯è¾¾**\n\nè¿™ä¸ªå¯¹è±¡ä»ç„¶æœ‰åœ°æ–¹å¼•ç”¨ç€ä»–\n\n**ä¸å¯è¾¾**\n\nè¿™ä¸ªå¯¹è±¡æ²¡æœ‰ä»»ä½•å¯¹è±¡è¢«å¼•ç”¨\n\n### 3.1.2 Shallow ä¸Retained Heapçš„åŒºåˆ«\n**Shallow** æ˜¯ä¸€ä¸ªå¯¹è±¡æ‰€æ¶ˆè€—çš„å†…å­˜ã€‚å¯¹è±¡æ¯ä¸ªå¼•ç”¨éœ€è¦32æˆ–64ä½ï¼ˆå–å†³äºæ“ä½œç³»ç»Ÿä½“ç³»ç»“æ„ï¼‰ï¼Œæ¯ä¸ªIntegeréœ€è¦4å­—èŠ‚ï¼Œæ¯ä¸ªLongéœ€è¦8å­—èŠ‚ï¼Œç­‰ç­‰ã€‚\n\n> Shallow heap is the memory consumed by one object. An object needs 32 or 64 bits (depending on the OS architecture) per reference, 4 bytes per Integer, 8 bytes per Long, etc. Depending on the heap dump format the size may be adjusted (e.g. aligned to 8, etc...) to model better the real consumption of the VM.\n\nXçš„**Retained set**è¡¨ç¤ºå½“Xè¢«GCåƒåœ¾å›æ”¶åéœ€è¦ç§»é™¤çš„å¯¹è±¡åˆ—è¡¨\n\n> **Retained set** of X is the set of objects which would be removed by GC when X is garbage collected.\n\nXçš„**Retained heap**æ˜¯Retained seté‡Œæ‰€æœ‰å¯¹è±¡çš„Shallowå¤§å°\n\n> **Retained heap** of X is the sum of shallow sizes of all objects in the retained set of X, i.e. memory kept alive by X.\n\né€šä¿—çš„æ¥è¯´ï¼Œ**Shallow** æ˜¯è¿™ä¸ªå¯¹è±¡çš„å¤§å°ï¼Œ**Retained heap**æ˜¯è¿™ä¸ªå¯¹è±¡è¢«å›æ”¶ä¹‹åå†…å­˜é‡Šæ”¾çš„å¤§å°\n\n![img_5.png](../img/netease/littleP/img_5.png)\n\nå›¾5 å¯¹è±¡å¼•ç”¨å›¾ä»¥åŠRetained Set\n\n### 3.1.3 Dominator Tree\nMATæä¾›äº†å¯¹è±¡å›¾çš„Dominator Treeï¼Œå°†å¯¹è±¡å¼•ç”¨å›¾è½¬åŒ–ä¸ºDominator Treeèƒ½å¤Ÿè½»æ¾è¯†åˆ«ä¿ç•™å†…å­˜çš„æœ€å¤§å—ä»¥åŠå¯¹è±¡ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œä¸‹é¢æ˜¯ä¸€äº›å®šä¹‰\n\n- X **dominates** Yï¼Œè¡¨ç¤ºåœ¨å¯¹è±¡å›¾ä¸­ï¼Œæ¯ä¸€ä¸ªå»Yçš„è·¯å¾„ä¸Šéƒ½éœ€è¦ç»è¿‡Xã€‚\n- Xæ˜¯Yçš„**immediate dominator** ï¼Œè¡¨ç¤ºXæ˜¯è·ç¦»Yæœ€è¿‘çš„æ”¯é…è€…\n- **dominator tree** æ˜¯ç”±å¯¹è±¡å›¾ç›´æ¥æ„å»ºè€Œæ¥ï¼Œèƒ½å¤Ÿå±•ç°ä¸€ä¸ªå¯¹è±¡çš„immediate dominator\n\nå›¾6æ˜¯å°†å¯¹è±¡å›¾ï¼ˆå·¦ä¾§ï¼‰æ„å»ºä¸º**dominator tree** ï¼ˆå³ä¾§ï¼‰\n\n![img_6.png](../img/netease/littleP/img_6.png)\n\nå›¾6 å¯¹è±¡å¼•ç”¨å›¾ä»¥åŠRetained Set\n\né€šä¿—çš„æ¥è¯´ï¼ŒX dominates Yè¡¨ç¤ºï¼Œå¦‚æœXè¢«å›æ”¶é‚£ä¹ˆYä¸€å®šè¢«å›æ”¶ã€‚ä½†æˆ‘ä»¬å¸¸è¯´çš„å¼•ç”¨ï¼Œå¦‚æœXå¼•ç”¨Yï¼Œé‚£ä¹ˆYæ˜¯ä¸ä¸€å®šä¼šè¢«å›æ”¶çš„ï¼Œå› ä¸ºYæœ‰å¯èƒ½è¢«Zå¼•ç”¨ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆMATå¼•å…¥ **Dominator**è¿™ä¸ªæ¦‚å¿µã€‚\n\n## 3.2 å¸¸ç”¨åŠŸèƒ½\n### 3.2.1 Histogram\nHistogramåˆ—ä¸¾å‡ºæ¯ä¸€ä¸ªclassçš„å¯¹è±¡æ•°é‡ä»¥åŠä»–çš„shallow sizeå’Œretained sizeï¼Œå¯ä»¥å¿«é€Ÿæ‰¾å‡ºå¤§çš„å¯¹è±¡ç±»\n\n![img_7.png](../img/netease/littleP/img_7.png)\n\nå›¾7 Histogramåˆ—è¡¨\n\né»˜è®¤æƒ…å†µä¸‹retained sizeå±•ç¤ºçš„æ˜¯ä¼°ç®—å€¼ï¼Œä¹Ÿå¯é€šè¿‡è®¡ç®—æ‰è·å–ä»–çš„å‡†ç¡®å€¼ã€‚\n\n![img_11.png](../img/netease/littleP/img_11.png)\n\nå›¾8 Histogramè®¡ç®—å‡†ç¡®retained size\n\nå¯ä»¥æŸ¥çœ‹å¯¹è±¡è¢«è°å¼•ç”¨æˆ–è€…ä»–åˆå¼•ç”¨äº†è°\n\n![img_10.png](../img/netease/littleP/img_10.png)\n\nå›¾9 HistogramæŸ¥çœ‹å¼•ç”¨å…³ç³»\n\n![img_9.png](../img/netease/littleP/img_9.png)\n\nå›¾10 HistogramæŸ¥çœ‹å¼•ç”¨å…³ç³»ç»“æœ\n\nHistogramé»˜è®¤æ˜¯é€šè¿‡classæ˜¯åˆ†ç»„çš„ï¼Œä¹Ÿå¯ä»¥æ ¹æ®åŒ…æˆ–è€…åŠ è½½å™¨\n\n![img_8.png](../img/netease/littleP/img_8.png)\n\nå›¾11 Histogramé€šè¿‡å…¶ä»–ç±»å‹åˆ†ç»„\n\n### 3.2.2 Dominator Tree\n**Dominator tree**å±•ç¤ºäº†åœ¨å †ä¸­æœ€å¤§çš„å¯¹è±¡åˆ—è¡¨ã€‚Xå¯¹è±¡çš„ä¸‹ä¸€çº§è¡¨ç¤ºï¼ŒXè¢«å›æ”¶ä¹‹åéœ€è¦è¢«åƒåœ¾å›æ”¶çš„å¯¹è±¡åˆ—è¡¨ã€‚ï¼ˆä¹Ÿå°±æ˜¯Xç›´æ¥æ”¯é…çš„å¯¹è±¡ï¼‰åŒæ ·ä¹Ÿå¯ä»¥æŒ‰ç±»åŠ è½½å™¨ã€åŒ…è¿›è¡Œåˆ†ç»„ã€‚\n\n> The next level of the tree lists those objects that would be garbage collected if all incoming references to the parent node were removed.\n\n![img_12.png](../img/netease/littleP/img_12.png)\n\nå›¾12 Dominator Tree\n\nä»¥ä¸Šå›¾ä¸ºä¾‹ï¼Œå ç”¨å †å†…å­˜æœ€å¤§çš„æ˜¯TaskThreadçš„http-no-8080-exec-2çº¿ç¨‹ï¼Œå…¶æœ¬èº«å¤§å°æ˜¯Shallow Heapæ˜¯120å­—èŠ‚ï¼ŒRetained Heapæ˜¯2417669960å­—èŠ‚ï¼Œå ç”¨æ•´ä¸ªå †å†…å­˜94.90%ã€‚å›¾ä¸­å°†AspectJExpressionPointcutå±•å¼€ï¼Œè¡¨ç¤ºå½“AspectJExpressionPointcutè¢«å†…å­˜å›æ”¶ä¹‹åï¼Œå±•å¼€åˆ—è¡¨é‡Œçš„æ‰€æœ‰å¯¹è±¡éƒ½ä¼šè¢«å›æ”¶ï¼Œä¹Ÿå°±æ˜¯ä»–çš„retained set\n\n### 3.2.3 Immediate Dominators\nå¯ä»¥å¿«é€Ÿæ‰¾å‡ºå½“å‰è¿™ç»„ï¼ˆç±»/å¯¹è±¡ï¼‰çš„æ‰€æœ‰immediate dominatorï¼ˆç›´æ¥æ”¯é…è€…ï¼‰\n\n![img_13.png](../img/netease/littleP/img_13.png)\n\nå›¾13 Histogramæ‰¾æŸä¸ªç±»çš„immediate dominator\n\nä¸‹åˆ—å±•ç°æ”¯é…Object[]çš„ç±»åˆ—è¡¨\n\n![img_14.png](../img/netease/littleP/img_14.png)\n\nå›¾14 Object[]ç±»çš„immediate dominator\n\nå…¶ä¸­æ‰€é€‰çš„é‚£ä¸€è¡Œè¡¨ç¤ºï¼ŒTaskThreadä¸€å…±æœ‰37ä¸ªå¯¹è±¡ï¼Œå…¶ä¸­æ”¯é…äº†133ä¸ªObject[]ï¼Œå¹¶ä¸”TaskThreadçš„æœ¬èº«å¯¹è±¡å¤§å°(shallow size)æ˜¯4440bytesï¼Œä»–æ”¯é…çš„Object[]æ˜¯2147491680bytesçš„å¤§å°\n\n### 3.2.4 Leak report\nLeak reportä¼šåˆ—ä¸¾å‡ºå¯èƒ½å­˜åœ¨å†…å­˜æ³„æ¼çš„ç‚¹ï¼Œä»¥åŠå‘ç”Ÿçš„æ ˆä¿¡æ¯ä½ç½®\n\n![img_15.png](../img/netease/littleP/img_15.png)\n\nå›¾15 Leak report\n\n# å››ã€å®šä½è¿‡ç¨‹\næ ¹æ®åœ¨ç¬¬ä¸€èŠ‚æ‰€è§‚å¯Ÿåˆ°çš„é—®é¢˜ç°è±¡ï¼Œæˆ‘ä»¬ä»å†…å­˜è§’åº¦æ¥åˆ†æGCåœé¡¿ä¹‹é—´ä¸ºä½•è¿™ä¹ˆä¹…ï¼ŸæŒ‰ç…§æƒ¯ä¾‹ï¼Œé€šå¸¸éƒ½ä¼šçœ‹ä¸€ä¸‹å†…å­˜ä¸­çš„å¤§å¯¹è±¡ï¼Œå› ä¸ºå¤§å¯¹è±¡ä¸€èˆ¬æ˜¯é€ æˆå†…å­˜å‡ºç°é—®é¢˜çš„ç½ªé­ç¥¸é¦–ï¼Œå¹¶ä¸”å¤§å¯¹è±¡ä¹Ÿæ˜¯æœ€å®¹æ˜“å‘ç°çš„ã€‚\n\n## 4.1 æŸ¥çœ‹å¤§å¯¹è±¡\n> jmap -hsito [pid] | head -n [num]\n\n![img_16.png](../img/netease/littleP/img_16.png)\n\nå›¾16 å°Pè€å¸ˆæœåŠ¡æŸæ—¶åˆ»å¤§å¯¹è±¡\n\nå¤§éƒ¨åˆ†æœåŠ¡å¤§å¯¹è±¡å‰åˆ—å°±æ˜¯byteã€intç­‰åŸºæœ¬ç±»å‹ï¼ˆä¸åŒçš„jdkç‰ˆæœ¬å¯èƒ½ä¼šä¸åŒï¼‰ï¼Œä¹Ÿçœ‹ä¸å‡ºä»€ä¹ˆé—¨é“ã€‚\n\né€šå¸¸å…ˆé‡ç‚¹å…³æ³¨é¡¹ç›®è‡ªå·±çš„åŒ…ï¼Œå†çœ‹ä¸€äº›å¼•ç”¨çš„åŒ…ã€‚å›¾16å·²ç»åœˆå‡ºäº†ä¸€äº›æ¯”è¾ƒå¯ç–‘çš„å¯¹è±¡ï¼Œä½†ç±»æ¯”äº†åŒç±»ç¨³å®šæœåŠ¡ï¼Œç¬¬10è¡Œå¯¹è±¡ä¹Ÿæ˜¯å­˜åœ¨ä¸”ç°è±¡ä¸€è‡´çš„ï¼Œäºæ˜¯å°±æš‚æ—¶æ’é™¤ä»–çš„å«Œç–‘ã€‚\n\næ¥ä¸‹æ¥å°±æ˜¯12ã€13è¡Œè¿™ä¸¤ä¸ªå¯¹è±¡ï¼Œä»–ä»¬ç”¨æ¥åšæµå¼åœºæ™¯ä¸‹çº¿ç¨‹ä¹‹é—´ä¸Šä¸‹æ–‡çš„è‡ªåŠ¨ä¼ é€’ï¼Œåœ¨githubä¸Šçœ‹æœ‰äººä¹Ÿæå‡ºäº†ä½¿ç”¨è¯¥ç»„ä»¶çš„[å†…å­˜é—®é¢˜](https://github.com/micrometer-metrics/context-propagation/issues/148)ï¼Œæˆ‘ä»¬æŠŠä»–åˆ—ä¸ºå¯ç–‘å¯¹è±¡ã€‚\n\nå†æ¥ç€å°±æ˜¯20è¡Œè¿™ä¸ªå¯¹è±¡ï¼Œä»–æ˜¯ä¹‹å‰è®²åˆ°çš„[Huggingface](https://huggingface.co/)ç»„ä»¶ï¼Œç”¨æ¥åšå¤§æ¨¡å‹tokenè®¡ç®—ã€‚è¿™ä¸ªç»„ä»¶cpuå ç”¨ç‡å¾ˆé«˜ï¼ˆä¹‹å‰æ€§èƒ½è‡ªæµ‹è¿‡ï¼Œå›¾17ï¼‰ã€‚é‚£æœ‰æ²¡æœ‰å¯èƒ½åœ¨æŸä¸ªæ—¶åˆ»è®¡ç®—é‡å¾ˆå¤§å¯¼è‡´cpuæ¿€å¢ï¼Œè€Œå®¹å™¨åˆ†é…çš„cpuä¸å¤Ÿç”¨ï¼ˆè€Œæˆ‘ä»¬ä¹Ÿç¡®å®å‘ç”Ÿäº†cpuæŠ¢å çš„æƒ…å†µï¼‰ï¼Œå¯¼è‡´é•¿æœŸæŒæœ‰jvmå¯¹è±¡è€Œæ— æ³•å›æ”¶å¸¦æ¥çš„GCå¡é¡¿ï¼Œæ‰€ä»¥æˆ‘ä¹ŸæŠŠä»–åˆ—ä¸ºäº†å¯ç–‘å¯¹è±¡ã€‚\n\næ¥ä¸‹æ¥æˆ‘ä»¬æ¥éªŒè¯çŒœæƒ³ã€‚\n\n![img_17.png](../img/netease/littleP/img_17.png)\n\nå›¾17 Huggingfaceç»„ä»¶æ€§èƒ½æµ‹è¯•cpuã€å†…å­˜ä½¿ç”¨æƒ…å†µ\n\n### 4.1.1 éªŒè¯çŒœæƒ³\næˆ‘ä»¬å°†å›¾16ä¸­ï¼Œ12ã€13è¡Œå¯¹è±¡æ¶‰åŠçš„ç»„ä»¶ä»¥åŠ20è¡Œå¯¹è±¡æ¶‰åŠçš„ç»„ä»¶ï¼Œåˆ†åˆ«æ‰“å¼€/å…³é—­æ¥åšæ€§èƒ½æµ‹è¯•ï¼Œçœ‹ GCå’Œjvmæ˜¯å¦æœ‰æ˜æ˜¾å˜åŒ–ï¼Œä½†å½“æ—¶å¹¶æ²¡æœ‰å‘ç°å¸¦æ¥æ˜æ˜¾çš„jvmå˜åŒ–ä»¥åŠGCå¡é¡¿é—®é¢˜ã€‚é‚£ä¹ˆé—®é¢˜å¯èƒ½å‡ºç°åœ¨å…¶ä»–å¤§å¯¹è±¡ä¸Šï¼Œè¿™æ—¶å€™å°±éœ€è¦æŠŠå †å†…å­˜dumpä¸‹æ¥åšåˆ†æäº†ã€‚\n\n## 4.2 å†…å­˜dump\næ ¹æ®æˆ‘ä»¬ä¹‹å‰è§‚å¯Ÿçš„ç°è±¡ï¼ŒoldåŒºåŸŸæ¿€å¢ï¼Œä¸€æ®µæ—¶é—´åå›è½ï¼Œè¿™ä¸å¤ªç¬¦åˆå†…å­˜æ³„æ¼çš„ç°è±¡ï¼Œå¯èƒ½å°±æ˜¯å¤§å¯¹è±¡è¢«é•¿æœŸæŒæœ‰æ— æ³•é‡Šæ”¾ï¼Œäºæ˜¯åœ¨dumpå†…å­˜æ—¶ï¼Œé€‰æ‹©å°†å †é‡Œçš„å¯¹è±¡å…¨éƒ¨dumpè€Œä¸ä»…ä»…æ˜¯å­˜æ´»çš„å¯¹è±¡ã€‚\n\n> jmap -dump:live,format=b,file=dump.hprof [pid]\n\n## 4.3 ä½¿ç”¨MATå·¥å…·åˆ†æ\n> [ä¸‹è½½åœ°å€](https://eclipse.dev/mat/)\n\næ³¨æ„ä¸€èˆ¬å †æ–‡ä»¶å¤šå¤§ï¼ŒMATå†…å­˜å°±éœ€è¦åˆ†é…å¤šå¤§ï¼Œä¿®æ”¹æ–¹å¼[å‚è€ƒ](https://blog.csdn.net/qq_45859054/article/details/131096947)ã€‚\n\nMATå·¥å…·é€šå¸¸æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»–ä»è¿™å‡ ä¸ªè§’åº¦åˆ†æï¼š\n\n- å †å†…å­˜ä¸­çš„å¤§å¯¹è±¡æœ‰äº›ä»€ä¹ˆï¼Ÿ\n- è¿™äº›å¤§å¯¹è±¡ä¸ºä»€ä¹ˆæ²¡è¢«å›æ”¶ï¼Ÿçœ‹ä»–çš„æ”¯é…è€…ï¼šimmediate Dominatorsï¼Œçœ‹ä»–çš„GC root\n- è¿™äº›å¤§å¯¹è±¡ä¸ºä»€ä¹ˆè¿™ä¹ˆå¤§ï¼Ÿçœ‹ä»–æ”¯é…äº†è°ï¼šretained set\n\n### 4.3.1 å¯¼å…¥å †æ–‡ä»¶\n\n![img_18.png](../img/netease/littleP/img_18.png)\n\nå›¾18 å †æ–‡ä»¶å¯¼å…¥ç¤ºæ„å›¾\n\n### 4.3.2 æŸ¥çœ‹å¤§å¯¹è±¡\nä½¿ç”¨HistogramæŸ¥çœ‹å¤§çš„å¯¹è±¡ï¼ˆç±»ï¼‰ï¼Œæ ¹æ®Retained Heapæ¥æ’åºï¼ˆç‚¹å‡»Retained HeapæŒ‰é’®å°±å¯ä»¥æ’åºï¼‰\n\n![img_19.png](../img/netease/littleP/img_19.png)\n\nå›¾19 å †æ–‡ä»¶å¤§çš„å¯¹è±¡ï¼ˆç±»ï¼‰åˆ—è¡¨\n\nå‘ç°æœ€å¤§çš„ç±»æ˜¯java.lang.object[]ï¼Œæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œäºæ˜¯æŒ‰ç…§åˆšæ‰æ€è·¯æˆ‘ä»¬å…ˆçœ‹ä»–ä¸ºä»€ä¹ˆæ²¡è¢«å›æ”¶ï¼Ÿå°±çœ‹ä»–çš„æ”¯é…è€…ã€‚\n\n### 4.3.3 æŸ¥çœ‹å¤§å¯¹è±¡æ”¯é…è€…\nå°è¯•çœ‹ä¸‹è¿™ä¸ªå¤§å¯¹è±¡çš„æ”¯é…è€…ï¼Œçœ‹çœ‹æ˜¯ä¸æ˜¯å› ä¸ºè¿™ä¸ªæ”¯é…è€…åº”è¯¥è¢«å›æ”¶ä½†æ˜¯æ²¡è¢«å›æ”¶ã€‚\n\nå›¾20å‘ç°java.lang.object[]æœ€å¤§çš„æ”¯é…è€…æ˜¯TaskThreadè¿™ä¸ªç±»ï¼Œä¸€å…±æœ‰37ä¸ªå¯¹è±¡å®ä¾‹ï¼Œæ”¯é…äº†133ä¸ªjava.lang.object[]ï¼ŒTaskThreadç±»æœ¬èº«å¤§å°æ˜¯4440bytesï¼Œæ”¯é…çš„å¯¹è±¡java.lang.object[]å¤§å°æ˜¯2147491680bytesã€‚\n\nå…¶å®çœ‹åˆ°è¿™é‡Œå·²ç»æ²¡æœ‰æ„ä¹‰äº†ï¼Œå› ä¸ºä»–æ˜¯å¤„ç†httpè¯·æ±‚çš„çº¿ç¨‹ï¼Œæ˜¯ä¸å¯èƒ½è¢«å›æ”¶çš„ï¼Œä½†æˆ‘ä»¬çœ‹ä¸€ä¸‹è¿™ä¸ªTaskThreadçš„GC Root ï¼Œçœ‹æ˜¯å¦æ˜¯è¢«ä¸å°å¿ƒåˆ›å»ºå‡ºæ¥çš„è€Œæ²¡é‡Šæ”¾ã€‚\n\n![img_20.png](../img/netease/littleP/img_20.png)\n\nå›¾20 java.lang.object[]çš„æ”¯é…è€…\n\n### 4.3.4 æŸ¥çœ‹GC root\nä¸€èˆ¬æ¥è¯´æŸ¥çœ‹Gc rootæ—¶éƒ½ä¼šé€‰æ‹© exclude weak/soft referencesï¼Œå› ä¸ºè¿™ä¸¤ä¸ªå¼•ç”¨è‚¯ä¼šè¢«GCæ‰ï¼Œè¿™æ˜¯ç”¨æ¥æŸ¥å†…å­˜æ³„æ¼çš„ï¼Œä½†æˆ‘ä»¬åœºæ™¯æ˜¯å¯¹è±¡æ˜¯è¢«é•¿æ—¶é—´æŒæœ‰æ®µæ—¶é—´æ— æ³•å›æ”¶ï¼Œè€Œä¸æ˜¯ä¸€ç›´æ— æ³•å›æ”¶ã€‚æ‰€ä»¥è¿™é‡Œé€‰æ‹©å±•ç°äº†æ‰€æœ‰çš„referencesã€‚\n\n![img_21.png](../img/netease/littleP/img_21.png)\n\nå›¾21 æŸ¥çœ‹TaskThreadGC rootç¤ºæ„å›¾\n\nä»å›¾22æ¥ï¼ŒTaskThreadéƒ½æ˜¯tomcatåˆ›å»ºçš„çº¿ç¨‹ç”¨æ¥å¤„ç†httpè¯·æ±‚çš„ï¼Œhttp-nio-8080-exec-2æ”¯é…äº†å¾ˆå¤§çš„å¯¹è±¡ï¼Œé‚£å°±æ˜¯åˆšæ‰java.lang.object[]ï¼Œè¿™ç§è¢«çº¿ç¨‹æ”¯é…çš„å¯¹è±¡ï¼Œå¤§æ¦‚ç‡æ˜¯ä¸´æ—¶å˜é‡ï¼Œä¹Ÿå°±æ˜¯æ–¹æ³•æ ˆé‡Œåˆ›å»ºå‡ºæ¥çš„å˜é‡ï¼Œhttp-nio-8080-exec-2æ˜¯ä¸å¯èƒ½è¢«å›æ”¶çš„ã€‚\n\n![img_22.png](../img/netease/littleP/img_22.png)\n\nå›¾22 TaskThreadGC root\n\nä½†æ˜¯ä¸´æ—¶å˜é‡çš„å›æ”¶ï¼Œä¼šåœ¨æ–¹æ³•æ‰§è¡Œå®Œï¼Œå¯¹ä»–å¼•ç”¨æ²¡æœ‰äº†ä¹‹åè¿›è¡Œã€‚å› ä¸ºæˆ‘ä»¬dumpæŸä¸€ä¸ªæ—¶åˆ»çš„å †æ ˆä¿¡æ¯ï¼Œå¯èƒ½çº¿ç¨‹æ²¡æœ‰æ‰§è¡Œå®Œï¼Œæ²¡è¢«å›æ”¶ä¹Ÿæ˜¯æ­£å¸¸çš„ã€‚ä½†æ˜¯åœ¨httpæ‰€æœ‰çš„çº¿ç¨‹ä¸­ï¼Œåªæœ‰è¿™ä¸ªçº¿ç¨‹æŒæœ‰å¾ˆå¤§çš„å¯¹è±¡æ˜æ˜¾æ˜¯ä¸åˆç†ã€‚äºæ˜¯æˆ‘æ¥ç€çœ‹ java.lang.object[]å¯¹è±¡ä¸ºä»€ä¹ˆè¿™ä¹ˆå¤§ï¼Ÿ\n\n### 4.3.5 æŸ¥çœ‹retained set\n\n![img_23.png](../img/netease/littleP/img_23.png)\n\nå›¾23 æŸ¥çœ‹java.lang.object[]Retained Setç¤ºæ„å›¾\n\næŸ¥çœ‹java.lang.object[]Retained Setå¯ä»¥çœ‹å‡ºä»–æ”¯é…äº†å“ªäº›å¯¹è±¡/ç±»ï¼Œå°±å¯ä»¥çŸ¥é“ä»–ä¸ºä»€ä¹ˆè¿™ä¹ˆå¤§ï¼ˆretained setæ˜¯åŒ…å«æœ¬èº«çš„ï¼‰\n\n![img_24.png](../img/netease/littleP/img_24.png)å›¾22.png\n\nå›¾24 java.lang.object[]Retained Set\n\nä»å›¾24å¯ä»¥çœ‹å‡ºï¼Œåœ¨å…¶æ‰€æœ‰æ”¯é…çš„å¯¹è±¡ä¸­ï¼Œå…¶æœ¬èº«æ˜¯æœ€å¤§çš„ï¼Œåˆ°è¿™é‡Œå¥½åƒé™·å…¥äº†æ­»ç»“ã€‚\n\nè¿™ä¸ªå¯¹è±¡è¢«è°æ”¯é…ï¼Ÿæ˜¯ä¸€ä¸ªçº¿ç¨‹ã€‚è¿™ä¸ªå¯¹è±¡ä¸ºä»€ä¹ˆè¿™ä¹ˆå¤§ï¼Ÿæ˜¯å› ä¸ºä»–æœ¬èº«å°±å¾ˆå¤§ã€‚\n\nä½†å›æƒ³èµ·åˆšæ‰è¯´çš„ï¼Œè¿™ä¸ªå¯¹è±¡è¢«httpçº¿ç¨‹æ”¯é…ï¼Œå› ä¸ºçº¿ç¨‹æ²¡æœ‰æ‰§è¡Œå®Œï¼Œå¼•ç”¨æ²¡æ¶ˆå¤±æ‰€ä»¥ä¸€ç›´å­˜åœ¨ï¼Œäºæ˜¯æˆ‘å°±æƒ³èƒ½ä¸èƒ½çœ‹ä¸€ä¸‹è¿™ä¸ªçº¿ç¨‹çš„æ ˆä¿¡æ¯ï¼Œæ­£å¥½MATä¸­ä¹Ÿæœ‰è¿™æ ·çš„åŠŸèƒ½ã€‚\n\n### 4.3.6 æŸ¥çœ‹æ ˆä¿¡æ¯\n\n![img_25.png](../img/netease/littleP/img_25.png)\n\nå›¾25 æ‰€æœ‰çº¿ç¨‹çš„æ ˆä¿¡æ¯\n\nä»å›¾25æ¥çœ‹ï¼Œhttp-nio-8080-exec-2å ç”¨äº†å¾ˆå¤§çš„retained heapï¼Œå°±æ¥ç€ç‚¹å¼€æ¥çœ‹å°±æ˜¯æ•´ä¸ªçº¿ç¨‹çš„å †æ ˆæƒ…å†µï¼ˆä¸æ’åºçš„è¯é»˜è®¤å°±æ˜¯æ‰§è¡Œè·¯å¾„ï¼‰\n\n![img_26.png](../img/netease/littleP/img_26.png)\n\nå›¾26 http-nio-8080-exec-2å †æ ˆä¿¡æ¯\n\nçœ‹å †æ ˆä¿¡æ¯ï¼Œä¸€èˆ¬æ¥è¯´æ˜¯ä»ä¸Šåˆ°ä¸‹æ‰¾åˆ°é¦–ä¸ªä¸šåŠ¡ä»£ç è¿›è¡Œåˆ†æï¼Œä»å›¾26å¯ä»¥çœ‹å‡ºä»ä¸šåŠ¡ä»£ç ChatManagerImpl.java:300å¤„æ·»åŠ ä¸€ä¸ªå…ƒç´ åˆ°åˆ—è¡¨ï¼Œæœ€åè§¦å‘äº†å®¹å™¨æ‰©å®¹ï¼Œæœ€ç»ˆå¯¼è‡´OutOfMemoryErrorã€‚å¹¶ä¸”è¿™ä¸ªçº¿ç¨‹åœ¨æ‰§è¡ŒcopyOfæ—¶æŒæœ‰å¾ˆå¤§çš„å†…å­˜å¤§å°Max Local Retained Heapï¼ˆæœ¬åœ°å˜é‡ä¿ç•™å¤§å°ï¼‰ï¼Œå·²ç»å®šä½åˆ°ä¸šåŠ¡ä»£ç äº†ï¼Œæ¥ä¸‹æ¥å°±æ ¹æ®ä¸šåŠ¡ä»£ç å»çœ‹çœ‹åŸå› ã€‚\n\n### 4.3.7 è·Ÿè¸ªä¸šåŠ¡ä»£ç \n```java\npublic List<ChatInfoDO> getChatInfoHistory(String userId, String taskId, Long parentChatId,\n                                           Integer groupLevelCount) throws LlmBusinessException {\n   // æ ¹æ®chat_group_levelç²—ç­›ï¼ˆåªå–æœ€è¿‘çš„chatCountä¸ªlevelï¼‰\n   List<ChatInfoDO> chatInfoDOList = chatInfoDOMapper.selectChatHistory(userId, taskId, parentChatId,\n           groupLevelCount);\n   if (chatInfoDOList == null || chatInfoDOList.size() == 0) {\n      throw new LlmBusinessException(ErrorCode.USER_WRONG_CHAT_HISTORY);\n   }\n   // æ ¹æ® parentChatId ä¸²èµ· chatHistory è¿”å›ï¼Œæ­¤æ—¶æ˜¯é€†åºçš„\n   Map<Long, ChatInfoDO> chatIdMap = new HashMap<>();\n   for (ChatInfoDO chatInfoDO : chatInfoDOList) {\n      chatIdMap.put(chatInfoDO.getChatId(), chatInfoDO);\n   }\n   List<ChatInfoDO> history = new ArrayList<>();\n   Long chatId = parentChatId;\n   // é€†åºæŸ¥æ‰¾ï¼Œä»æœ€åä¸€æ¡å¯¹è¯chatIdå¼€å§‹ï¼Œç»§ç»­æ¡ä»¶ï¼šchatId=å½“å‰parentChatChatIdï¼ˆå­èŠ‚ç‚¹æ‰¾çˆ¶èŠ‚ç‚¹ï¼‰\n   ChatInfoDO chatInfoDO;\n   while ((chatInfoDO = chatIdMap.get(chatId)) != null) {\n      history.add(chatInfoDO); // æ ‡è®°1  é—®é¢˜ä»£ç å¤„\n      chatId = chatInfoDO.getParentChatId();\n   }\n   Collections.reverse(history);\n   return history;\n}\n```\n\nåœ¨åˆ†æå¯ç–‘ç‚¹ä¹‹å‰ï¼Œæˆ‘å…ˆç®€å•æè¿°ä¸‹è¿™æ®µä»£ç æ‰€åšçš„äº‹æƒ…ã€‚\n\nåœ¨å°Pè€å¸ˆå¯¹è¯åœºæ™¯ä¸­ï¼Œæ˜¯é‡‡ç”¨ä¸€é—®ä¸€ç­”çš„å½¢å¼ï¼Œä¾‹å¦‚ä¸‹æ–¹å›¾27æ‰€ç¤ºï¼Œè“è‰²è¡¨ç¤ºç”¨æˆ·ï¼Œæ·¡çº¢è‰²è¡¨ç¤ºç³»ç»Ÿå›ç­”ã€‚\n\n![img_27.png](../img/netease/littleP/img_27.png)\n\nå›¾27 å¤§æ¨¡å‹å¯¹è¯ç¤ºæ„å›¾\n\nä¸ºäº†è®©æ¨¡å‹æ›´å¥½çš„ç†è§£ç”¨æˆ·é—®é¢˜ï¼Œé€šå¸¸æˆ‘ä»¬ä¼šåƒå›¾26æ‰€ç¤ºï¼Œæºå¸¦æ‰€æœ‰çš„å†å²æ¶ˆæ¯é€ç»™æ¨¡å‹ã€‚å½“å‰ä¸šåŠ¡ä»£ç å°±æ˜¯æ‰¾åˆ°ç”¨æˆ·çš„å†å²å¯¹è¯ç„¶åæ„å»ºèµ·æ¥æä¾›ç»™æ¨¡å‹ã€‚\n\n![img_28.png](../img/netease/littleP/img_28.png)\n\nå›¾28 æºå¸¦å†å²å¯¹è¯ç¤ºæ„\n\nå¦‚å›¾29æ‰€ç¤ºï¼Œæˆ‘ä»¬ç»™æ¯ä¸ªæ¶ˆæ¯ä¸¤ä¸ªå±æ€§id=xxxã€parendId=xxxï¼Œè¿™æ ·æ¥å‘ˆç°ä¸€ç§çˆ¶å­å…³ç³»ï¼Œç”¨æˆ·è¾“å…¥æ¶ˆæ¯æ—¶ç”Ÿæˆidï¼Œå¹¶é€šè¿‡ä¼ å…¥çš„parentId=3å‘ä¸Šå¯»æ‰¾æ¶ˆæ¯ï¼Œæ‰¾åˆ°id=3çš„æ¶ˆæ¯ï¼Œå¾ªç¯å¯»æ‰¾ï¼Œç›´åˆ°parentId=-1\n\n![img_29.png](../img/netease/littleP/img_29.png)\n\nå›¾29 æ„å»ºå†å²å¯¹è¯ç¤ºæ„å›¾\n\nå›è¿‡å¤´æˆ‘ä»¬æ¥çœ‹ä¸šåŠ¡ä»£ç ï¼Œæ ‡è®°1å°±æ˜¯æ ˆä¿¡æ¯æ‰€ç¤ºçš„ä½ç½®ï¼Œè¿™å¤„ä»£ç å…¶å®æœ‰ä¸€ä¸ªå¾ˆæ˜æ˜¾çš„é£é™©ç‚¹whileå¾ªç¯æ„å»ºé“¾è¡¨ï¼ŒåŒæ—¶ç»“åˆæˆ‘ä»¬çš„å¯¹è±¡æ˜¯ä¸€ä¸ªå¤§æ•°ç»„ï¼Œé‚£è¿™ä¸ªwhileå¾ªç¯å°±å¾ˆå¯ç–‘ã€‚ç»“åˆåˆšæ‰ä¸šåŠ¡ä»£ç é€»è¾‘çš„åˆ†æï¼Œæˆ‘å½“æ—¶æƒ³åˆ°äº†ä»¥ä¸‹å¯ç–‘ç‚¹ï¼š\n- ä¸€ä¸ªæ¶ˆæ¯çš„idå’ŒparentIdä¸€è‡´å‘ç”Ÿäº†å¾ªç¯ï¼Œå¯¼è‡´æ­»å¾ªç¯\n- chatInfoDOMapper.selectChatHistory()ä»æ•°æ®åº“æŸ¥å‡ºæ¥çš„æ•°æ®é‡å¾ˆå¤§\n\næ¥ç€çœ‹äº†æ•°æ®åº“æŸ¥è¯¢è¯­å¥chatInfoDOMapper.selectChatHistory()ä¸å¯èƒ½å‘ç”ŸæŸ¥å‡ºå¾ˆå¤šæ•°æ®çš„é—®é¢˜ã€‚\n\né‚£ä¹ˆç°åœ¨æœ€å¯ç–‘çš„å°±æ˜¯æ¶ˆæ¯å¾ªç¯äº†ï¼Œæœ¬æ¥åˆ†äº«åˆ°è¿™å°±ç»“æŸäº†ã€‚è¦å»æŸ¥æ•°æ®åº“çœ‹çœ‹æœ‰æ²¡æœ‰idå’ŒparentIdé‡å¤çš„æ•°æ®äº†ï¼Œä½†å› ä¸ºå½“æ—¶æ˜¯å’ŒåŒäº‹ä»¬åœ¨åˆ†äº«è¿™ç¯‡æ–‡ç« ï¼ŒåŒäº‹ä»¬å°±æå‡ºäº†ä¸¤ä¸ªé—®é¢˜ã€‚\n- æœ‰æ²¡æœ‰å¯èƒ½æ˜¯ä¸¤ä¸ªæ¶ˆæ¯å‘ç”Ÿäº†å¾ªç¯ï¼Ÿæ¶ˆæ¯Aæ‰¾åˆ°äº†æ¶ˆæ¯Bï¼Œæ¶ˆæ¯Båˆæ‰¾å›äº†æ¶ˆæ¯Aã€‚\n- MATå¯ä»¥çœ‹è¿™ä¸ªé“¾è¡¨é‡Œæœ‰å•¥å—ï¼Ÿä»¥åŠèƒ½ä¸èƒ½çœ‹è¿™ä¸ªå¯¹è±¡çš„å€¼ï¼Œä¸ç„¶æŸ¥åº“å¯èƒ½ä¼šå¾ˆæ…¢ã€‚\n\nå¾ˆæ˜¾ç„¶ç¬¬ä¸€ä¸ªæ˜¯å¾ˆæœ‰å¯èƒ½çš„ã€‚ ç¬¬äºŒä¸ªé—®é¢˜å› ä¸ºå¯¹MATè¿˜æ˜¯åˆæ¬¡ä½¿ç”¨æ‰€ä»¥ä¸å¤ªäº†è§£ï¼Œä½†åœ¨åŒäº‹çš„å¼•å¯¼ä¸‹ï¼Œæˆ‘ä»¬å°è¯•çœ‹é“¾è¡¨é‡Œå…·ä½“çš„æ•°æ®æ˜¯ä»€ä¹ˆæ ·å­ã€‚\n\n4.3.8 æŸ¥çœ‹æ ˆå…·ä½“ç”¨äº†å“ªäº›å¯¹è±¡\n![img_30.png](../img/netease/littleP/img_30.png)\n\nå›¾30 æ ˆçš„ä¸´æ—¶å˜é‡\n\nå¦‚å›¾30æ‰€ç¤ºï¼Œæˆ‘ä»¬ç»§ç»­ç‚¹å‡»ä¸šåŠ¡ä»£ç æ–¹æ³•æ ˆç‚¹ï¼Œå°±å¯ä»¥çœ‹åˆ°è¿™ä¸ªæ–¹æ³•æ ˆç‚¹å¼•ç”¨äº†ï¼ˆæ³¨æ„æ˜¯å¼•ç”¨ä¸æ˜¯æ”¯é…ï¼‰HashMapã€ArrayListã€ChatInfoDOï¼Œå› ä¸ºæ ¹æ®ä¸šåŠ¡ä»£ç åˆ†æå¯èƒ½æ˜¯ArrayListè†¨èƒ€ï¼Œæ‰€ä»¥ç»§ç»­ç‚¹å‡»ArrayListå¯ä»¥çœ‹ä»–å¼•ç”¨çš„å…ƒç´ elementDataï¼ŒåŒ…æ‹¬äº†object[]ã€ChatInfoDOã€‚è¿™é‡Œé—®é¢˜å°±å±•ç°å‡ºæ¥äº†ï¼Œå¦‚å›¾30çº¢æ¡†æ‰€ç¤ºï¼ŒArrayListå¥‡æ•°ä½ç½®[1],[3],[5]...éƒ½æ˜¯ChatInfoDO_Aï¼Œå¶æ•°ä½ç½®[0],[2],[4]...éƒ½æ˜¯ChatInfoDO_Bï¼Œå¹¶ä¸”å†æ¬¡ç‚¹å‡»ChatInfoDO_Aå’ŒChatInfoDO_Bå°±å¯ä»¥çœ‹åˆ°ä»–ä»¬çš„chatIdã€parentChatIdï¼Œè¿™æ—¶å€™çœ‹åˆ°ä»–ä»¬ç¡®å®äº’ä¸ºå¼•ç”¨äº†ï¼Œå¦‚å›¾31æ‰€ç¤ºã€‚\n\n![img_31.png](../img/netease/littleP/img_31.png)\n\nå›¾31 äº’ä¸ºå¼•ç”¨çš„æ¶ˆæ¯\n\nè‡³æ­¤é—®é¢˜åŸå› é¡ºåˆ©æ‰¾åˆ°ã€‚\n\nåç»­åˆ†æè¿˜å‘ç°ï¼Œä¸ä»…æ˜¯ä¸¤ä¸ªæ¶ˆæ¯ä¼šå¾ªç¯ï¼Œå¤šä¸ªæ¶ˆæ¯ä¹Ÿä¼šå¾ªç¯ã€‚å†å²æ¶ˆæ¯æ„å»ºå…¶å®æ˜¯å•é“¾è¡¨ä»å°¾åˆ°å¤´çš„æ„å»ºè¿‡ç¨‹ï¼Œæ‰¾åˆ°å¤´èŠ‚ç‚¹å°±åœæ­¢ï¼Œä½†æŸä¸ªä½ç½®äº§ç”Ÿäº†ç¯å°±å¯¼è‡´æ‚²å‰§ã€‚æ‰€ä»¥å¾—å‡ºä¸€ç‚¹å»ºè®®ï¼šä¹‹åwhileçš„ä½¿ç”¨ä¸€å®šå¾—æ³¨æ„ï¼ï¼ï¼ã€‚\n\nè™½ç„¶åŸå› æ‰¾åˆ°äº†ï¼Œä½†ä¸ºä»€ä¹ˆäº§ç”Ÿé‡å¤çš„Idå‘¢ï¼Ÿæˆ‘ä»¬è®¾è®¡çš„Idå¯æ˜¯å”¯ä¸€çš„ï¼äºæ˜¯æˆ‘ä»¬åˆåˆ†æäº†ç”ŸæˆIdçš„ä»£ç ã€‚\n\n4.4 åˆ†æIDé‡å¤çš„åŸå› \n```java\npublic class IDGeneratorUtil {\n\n    /**\n     * å¾ªç¯æ•°\n     */\n    private static long cycleNumber = 10000;\n\n    /**\n     * å¾ªç¯ä¸‹é™\n     */\n    private static long startNumber = 10001;\n\n    /**\n     * å¾ªç¯ä¸Šé™\n     */\n    private static long stopNumber = 99999;\n\n    /**\n     * è¿”å›ä¸€ä¸ªå½“å‰æ—¶é—´çš„longç±»å‹æ•°å­—ï¼ˆéçº¿ç¨‹å®‰å…¨ï¼‰\n     * ç†è®ºä¸Šæ¯æ¯«ç§’å¯ç”Ÿæˆid 89999 ä¸ª\n     *\n     * @return\n     */\n    public static long getNextId() {\n        if (cycleNumber < stopNumber) {\n            cycleNumber++;\n        } else {\n            cycleNumber = startNumber;\n        }\n        return System.currentTimeMillis() + cycleNumber;\n    }\n}\n```\nå› ä¸ºå°Pè€å¸ˆæœåŠ¡æ˜¯åˆ†å¸ƒå¼æœåŠ¡ï¼Œæœ‰å¤šä¸ªèŠ‚ç‚¹ï¼Œéœ€è¦ä¿éšœæ¶ˆæ¯å”¯ä¸€Idã€‚å¸¸è§å”¯ä¸€Idæ–¹å¼å¾ˆå¤šï¼šUUIDã€é›ªèŠ±ç­‰ç­‰ï¼Œä½†åŸºäºæˆ‘ä»¬çš„è€ƒè™‘å¹¶æ²¡æœ‰ä½¿ç”¨ä¸Šè¾¹çš„æ–¹å¼ã€‚\n\nå½“æ—¶åœ¨è®¾è®¡å”¯ä¸€Idæ—¶ä¸»è¦è€ƒè™‘ä»¥ä¸‹å‡ ç‚¹ï¼š\n\n- å…·æœ‰æ—¶é—´æ€§\n- ç”Ÿäº§æ•ˆç‡é«˜\n- ç¬¦åˆæ•°å­—éœ€æ±‚\n  äºæ˜¯å°±é€šè¿‡æ—¶é—´æˆ³æ¥ä½“ç°æ—¶é—´æ€§ï¼Œåœ¨åŠ ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„å¾ªç¯æ•°ï¼Œè¿™æ ·æ˜¯ä¸æ˜¯å…·æœ‰ç¬¦åˆä¸Šè¿°çš„è¦æ±‚äº†ï¼Ÿ\n\nä½†åœ¨å¤§å®¶çš„åˆ†æä¸‹å‘ç°äº†è¿™æ ·ä¸€ä¸ªBUGï¼Œå‡å¦‚å½“å‰æ—¶é—´æ˜¯10ï¼Œéšæœºæ•°æ˜¯10ï¼Œè¿‡äº†ä¸€æ®µæ—¶é—´åå½“å‰æ—¶é—´æ˜¯19ï¼Œéšæœºæ•°å·²ç»å‘ç”Ÿå¾ªç¯å˜æˆäº†1ï¼Œè¿™æ ·ä¸¤ä¸ªIdæ˜¯ä¸æ˜¯éƒ½ä¸€æ ·å˜æˆ20äº†ï¼ˆä½†æ¦‚ç‡ç¡®å®å¾ˆä½ï¼ï¼ï¼ï¼‰\n\nåˆ°æ­¤ç»ˆäºçœŸç›¸å¤§ç™½äº†ï¼\n\n# äº”ã€ æ€»ç»“\nåˆ†æè¿‡ç¨‹å…¶å®æ˜¯åå·çš„ï¼Œæ€»ç»“çš„æ—¶å€™ï¼Œå·²å˜æˆå·²çŸ¥ç­”æ¡ˆå¯»æ‰¾ç­”æ¡ˆçš„è¿‡ç¨‹ï¼Œæ‰€ä»¥çœ‹èµ·æ¥ä¼šå¾ˆé¡ºç•…ã€‚\n\né—®é¢˜åƒå¥‡ç™¾æ€ªï¼Œåˆ†æè¿‡ç¨‹ä¹Ÿåƒå¥‡ç™¾æ€ªï¼Œä½†æ€»ç»“äº†ä¸€äº›å°ç»éªŒã€‚\n\n- ç›‘æ§jvmå†…å­˜æˆ–è€…å¯ä»¥è§‚å¯Ÿjvmæ˜¯æ¯”è¾ƒé‡è¦çš„\n- GCæ—¥å¿—ä¹Ÿæ˜¯æ¯”è¾ƒé‡è¦çš„æ—¥å¿—\n- å†…å­˜é—®é¢˜ä¸€èˆ¬å¯ä»¥ä»å¤§å¯¹è±¡ç€æ‰‹ï¼Œåˆ†æå¯¹è±¡ä¸ºä»€ä¹ˆè¿™ä¹ˆå¤§ï¼Ÿä¸ºä»€ä¹ˆæ²¡è¢«å›æ”¶ï¼Ÿ\n- MATçš„Histogramã€Dominator Treeçœ‹å¤§å¯¹è±¡\n- MATçš„Immediate Dominatorsçœ‹å¤§å¯¹è±¡è¢«è°ç›´æ¥æ”¯é…è€Œæ²¡å›æ”¶\n- MATçš„retained setçœ‹å¤§å¯¹è±¡æ”¯é…äº†å“ªäº›ï¼Œå¯¼è‡´ä»–è¿™ä¹ˆå¤§\n- MATçš„çº¿ç¨‹åˆ†æï¼Œæ¥åˆ†æçº¿ç¨‹æŒæœ‰å¯¹è±¡ç‰¹åˆ«å¤§çš„æƒ…å†µï¼Œåˆ†ææ ˆä¿¡æ¯\n\nå½“ç„¶ï¼Œåœ¨é—®é¢˜å¤„ç†çš„è¿‡ç¨‹ä¸­ï¼Œè¿˜æœ‰ä¸€äº›ä¸å¯å¿½è§†çš„ç»†èŠ‚æ“ä½œï¼Œå¯¹æ’æŸ¥é—®é¢˜è‡³å…³é‡è¦ã€‚\n- å¦‚ä½•æŠ“å–å¶ç°é—®é¢˜çš„JVM dumpç°åœºï¼Ÿ\n- åªæœ‰å†…å­˜æ³„æ¼æ‰ä¼šå¼•èµ·å†…å­˜ä½¿ç”¨ç‡å‡é«˜å—ï¼Ÿ\n- å¦‚ä½•åˆ†æGCæ—¥å¿—æ•°æ®ï¼Œæ¨æ–­é—®é¢˜åŸå› ï¼Ÿ\n\nåŸºäºç¯‡å¹…æœ‰é™ï¼Œæœ¬æ–‡ä¸å†èµ˜è¿°ï¼Œåç»­ä¼šç¼–å†™ç³»åˆ—KMæ–‡ç« ï¼Œä¸ºå¤§å®¶å¸¦æ¥å®è·µä¸­èµ°è¿‡çš„å¼¯è·¯ä¸æ€»ç»“çš„å°æŠ€å·§ã€‚\n","tags":["ç½‘æ˜“"]},{"title":"ç½‘æ˜“ç‰›é©¬æ—¥å¿—-å®Œç»“ç¯‡","url":"/2025/03/04/ç½‘æ˜“ç‰›é©¬æ—¥å¿—-å®Œç»“ç¯‡/","content":"> è¿‡å¹´ä»¥åå›æ¥åšçš„ä¸œè¥¿å¤ªæ‚äº†ï¼Œæƒ³åˆ°å“ªè¯´å“ªå§ã€‚\n## éœ€æ±‚12ï¼šå‡ºæµ·é¡¹ç›®æœç´¢åŠŸèƒ½\n\n> è¿™ä¸ªå¾—åŒ…è£…äº†ï¼Œå¥½ä¸å®¹æ˜“ä¸€ä¸ªå¯èƒ½çš„é«˜å¹¶å‘Cç«¯æ¥å£ï¼Œä½†æ˜¯å®é™…ä¸Šåšçš„å¾ˆç®€å•ã€‚\n\n### æœç´¢V1ï¼šå®é™…åšçš„\næ•°æ®åº“ç›´æ¥likeå°±å®Œäº†ï¼Œçº¯çº¯æ²¡æœ‰ä¸€ä¸çš„æŠ€æœ¯å«é‡ã€‚\n\n### æœç´¢V2ï¼šåŒ…è£…ã€‚ã€‚ã€‚æœªå®Œå¾…ç»­\n\n## éœ€æ±‚13ï¼šå…¨çƒæœæ•°æ®å·¥ç¨‹äº§å“å›¾ç‰‡çˆ¬å–\nè¿™éƒ¨åˆ†åªåšäº†å‰æ®µéƒ¨åˆ†ï¼Œç”¨jsoupå»è§£ææ ‡ç­¾ï¼Œå†getDocumentByClasså»æ‰¾urlï¼Œå›¾ç‰‡åç§°å’Œä¿¡æ¯ã€‚\n\n> è¿™é‡Œä¹Ÿä¸æ¸…æ¥šclassä¼šä¸ä¼šéšç€ç¼–è¯‘æ”¹å˜ï¼Œä½†æ˜¯æµ‹è¯•ä¸‹æ¥ç¡®å®æ˜¯å¯ä»¥çš„ã€‚\n```java\npublic ExtraResultDTO doExtra(String domain){\n    ExtraResultDTO resultDTO = new ExtraResultDTO();\n    try{\n        String html = getHtml(domain);\n        if(html == null || StringUtils.isBlank(html)){\n            log.warn(\"doExtra error.html is null\");\n            resultDTO.setStatus(101);\n            return resultDTO;\n        }\n        if(html.contains(\"Our systems have detected unusual traffic from your computer\")){\n            log.warn(\"doExtra Google Pickpocket Detection Limit\");\n            resultDTO.setStatus(102);\n            return resultDTO;\n        }\n        Document doc = Jsoup.parse(html);\n        List<ImageDTO> images = new ArrayList<>();\n        Elements divs = doc.getElementsByClass(\"RntSmf\");\n        for (Element div : divs) {\n            //å›¾ç‰‡è·¯å¾„\n            String imgUrl = div.getElementsByTag(\"img\").get(0).attr(\"src\");\n            String desc = div.getElementsByClass(\"qXLe6d x3G5ab\").get(0).text();\n            String jumpUrl = div.getElementsByClass(\"qXLe6d F9iS2e\").get(0).text();\n            ImageDTO image = new ImageDTO();\n            image.setUrl(imgUrl);\n            image.setFormatUrl(imgUrl);\n            image.setAlt(desc);\n            images.add(image);\n        }\n        resultDTO.setStatus(200);\n        resultDTO.setImages(images);\n    }catch (Exception e){\n        log.error(\"doExtra error.\",e.getMessage());\n        resultDTO.setStatus(205);\n        resultDTO.setErrorMessage(e.getMessage());\n    }\n    return resultDTO;\n}\n```\n\n## éœ€æ±‚14ï¼šå…¨çƒæœæ•°æ®å·¥ç¨‹å…¬å¸Logoçˆ¬å–\næ¯”è¾ƒæœ‰æŒ‘æˆ˜æ€§çš„ä¸€æ•´ä¸ªé“¾è·¯ï¼Œé—®é¢˜åœ¨äºesé‡Œé¢logoå­—æ®µå¹¶ä¸æ˜¯ç´¢å¼•ï¼Œæ‰€ä»¥ä¸èƒ½ç”¨existæ¥æŸ¥è¯¢ã€‚ä¸»è¦æ€è·¯æ˜¯æŸ¥è¯¢çº¿ä¸Šæœ‰åŸŸåçš„å…¬å¸ï¼Œè¿‡æ»¤æ‰æœ‰logoå­—æ®µçš„ï¼Œå°†æ— logoå­—æ®µä½†æ˜¯æœ‰åŸŸåçš„å…¬å¸é€šè¿‡kafkaæ¶ˆè´¹åˆ°æœ¬åœ°ï¼Œç„¶åé€šè¿‡çˆ¬è™«å°†å›¾ç‰‡ä¸‹è½½ä¸‹æ¥ã€‚\n\n### å‰å¤„ç†é“¾è·¯ï¼š\né“¾è·¯ï¼š\n- çŒ›çŠ¸æŠ½å–çº¿ä¸Šesåˆ°hiveï¼Œè¿™ä¸€æ®µå…¨é‡æ•°æ®å†™å…¥hiveï¼Œå¤§æ¦‚2600ä¸‡ã€‚\n\n![img_1.png](../img/netease/last/img_1.png)\n\n- ç„¶åhive ->hiveï¼Œé€šè¿‡sqlæ¥è¿‡æ»¤æ‰æœ‰logoçš„å…¬å¸åŸŸåï¼Œæ­¤å¤–ç”±äºæŠ½å–çš„åŸŸådomainæ˜¯ä»ä¸€ä¸ªlisté‡Œé¢æ¥çš„ï¼Œåœ¨å˜æˆå­—ç¬¦ä¸²åæœ‰\"\\[\"å’Œ\"\\]\"ï¼Œéœ€è¦è¿‡æ»¤ï¼Œæœ€åå¾—åˆ°æ•°æ®é‡å¤§æ¦‚1600ä¸‡ã€‚\n\n![img_2.png](../img/netease/last/img_2.png)\n\n```text\ninsert\n  OVERWRITE table qiye_mail_data.logo_extra_offline_domain_v1\nselect\n REPLACE(SUBSTR(\n    domain,\n    2,\n    LENGTH(domain) -2\n  ), '\"', '') as domain,\n  companyid,\n locationdomain\n   from qiye_mail_data.logo_extra_offline_domain where logourl=''\n```\n- æœ€åçŒ›çŠ¸ä»»åŠ¡hive->kafkaï¼Œæµ‹è¯•ç¯å¢ƒé›†ç¾¤åšæ¶ˆè´¹ï¼Œè¿™æ‰æ­£å¼è¿›å…¥logoå›¾ç‰‡æå–çš„é“¾è·¯ã€‚\n\n### è´£ä»»é“¾æ¨¡å¼è¿›è¡Œå…¬å¸Logoçˆ¬å–\né¦–å…ˆæ˜¯ä¸‰ç§æ‰¾Logoçš„æ–¹æ³•ï¼Œä¸€èˆ¬æ¥è¯´Logoéƒ½ä¼šæ”¾åœ¨æµè§ˆå™¨çš„icoä¸Šï¼Œç›¸å…³é“¾æ¥åœ¨[csdn](https://blog.csdn.net/qq_42836771/article/details/112721772)ï¼š\n- é€šè¿‡googleæŸä¸ªapiæ‹¿ï¼Œè¿™ç§æˆåŠŸç‡æœ€é«˜ï¼Œä½†æ˜¯ä¼šè¿”å›é»˜è®¤å›¾ç‰‡ï¼Œåç»­éœ€è¦æ ¡éªŒmd5æ¥è¿‡æ»¤ã€‚\n- ç›´æ¥åœ¨ç½‘ç«™åŸŸååé¢æ‹¼æ¥/favicon.icoï¼ŒæˆåŠŸç‡ä¸é«˜ï¼Œå› ä¸ºå°å…¬å¸çš„ç½‘é¡µå¹¶ä¸ä¸€å®šæœ‰è¿™ä¹ˆè§„èŒƒï¼Œå…¶æ¬¡æ˜¯å¯èƒ½ä¼šè¿”å›404çš„htmlé¡µé¢ï¼Œä¹Ÿä¼šæœ‰é»˜è®¤çš„icoæ–‡ä»¶ï¼Œæ‰€ä»¥è¦å†™ä¸€ä¸ªæ–¹æ³•è¿‡æ»¤htmlå’Œé»˜è®¤çš„md5.\n- çˆ¬è™«è§£æï¼Œæ‹¿åˆ°domainçš„æºç ï¼Œå†å»è§£æ<head>é‡Œé¢çš„<link>ï¼Œç„¶åé€šè¿‡æ­£åˆ™è¡¨è¾¾å¼å»åŒ¹é…iconï¼ŒæˆåŠŸç‡ä¸é«˜ï¼Œå±äºæ˜¯æœ€åçš„åº•ç‰Œäº†ã€‚\n\nå¦å¤–è¿™é‡Œæœ‰çš„éƒ½æ˜¯domainï¼Œæ„æ€æ˜¯æ²¡æœ‰httpå’Œhttpsçš„ï¼Œæ‰€ä»¥éƒ½éœ€è¦è¿›è¡Œå°è¯•ï¼Œç»¼ä¸Šæ‰€è¿°ï¼Œä¸€å…±å¾—èµ°6ä¸ªé“¾è·¯ï¼Œå“ªä¸ªæˆåŠŸäº†å“ªä¸ªå°±è¿”å›ï¼Œå¾ˆé€‚åˆè´£ä»»é“¾æ¨¡å¼ã€‚\n```text\n// è´£ä»»é“¾æ‰§è¡Œ\nprivate UploadResultBO handleLogoCrawlAndUploadChain(String domain,String locationDomain) {\n    //æœ‰locationDomainçš„æƒ…å†µ\n    if (StringUtils.isNotEmpty(locationDomain)){\n        UploadResultBO googleStrategy = googleStrategy(locationDomain);\n        if (StringUtils.isNotBlank(googleStrategy.getUrl())){\n            return googleStrategy;\n        }\n        UploadResultBO straightStrategy = straightStrategy(locationDomain);\n        if (StringUtils.isNotBlank(straightStrategy.getUrl())){\n            return straightStrategy;\n        }\n        return htmlLinkTagStrategy(locationDomain);\n    }\n    //æ— locationDomainæˆ–è€…å¤±æ•ˆçš„æƒ…å†µï¼Œéœ€æ‹¼æ¥httpå’Œhttpså°è¯•\n    UploadResultBO googleStrategy = googleStrategy(HTTP_PREFIX + domain);\n    if (StringUtils.isNotBlank(googleStrategy.getUrl())){\n        return googleStrategy;\n    }\n    UploadResultBO straightStrategy = straightStrategy(HTTP_PREFIX + domain);\n    if (StringUtils.isNotBlank(straightStrategy.getUrl())){\n        return straightStrategy;\n    }\n    UploadResultBO htmlLinkTagStrategy = htmlLinkTagStrategy(HTTP_PREFIX + domain);\n    if (StringUtils.isNotBlank(htmlLinkTagStrategy.getUrl())){\n        return htmlLinkTagStrategy;\n    }\n    UploadResultBO googleStrategyHttps = googleStrategy(HTTPS_PREFIX + domain);\n    if (StringUtils.isNotBlank(googleStrategyHttps.getUrl())){\n        return googleStrategyHttps;\n    }\n    UploadResultBO straightStrategyHttps = straightStrategy(HTTPS_PREFIX + domain);\n    if (StringUtils.isNotBlank(straightStrategyHttps.getUrl())){\n        return straightStrategyHttps;\n    }\n    UploadResultBO htmlLinkTagStrategyHttps = htmlLinkTagStrategy(HTTPS_PREFIX + domain);\n    if (StringUtils.isNotBlank(htmlLinkTagStrategyHttps.getUrl())){\n        return htmlLinkTagStrategyHttps;\n    }\n    return new UploadResultBO(StringUtils.EMPTY, LogoExtraStatusEnum.STRATEGY_FAIL.getStatus());\n}\n```\n### ä¸Šä¼ åˆ°nos\nè°ƒæ´‹æ€»çš„æ¥å£å°±å®Œäº‹äº†ï¼Œç„¶åå°†è¿™ä¸ªé“¾æ¥ä¿å­˜è¿›esï¼Œè‰¯æ€»é‚£é‡Œä¼šæœ‰ä¸€ä¸ªåŒæ­¥é“¾è·¯å°†è§¦å‘ç‰ˆæœ¬æ›´æ–°çš„æ•°æ®åŒæ­¥åˆ°çº¿ä¸Šã€‚æœ€ç»ˆçš„æ•ˆæœå°±æ˜¯æµ‹è¯•é›†ç¾¤åœ¨æ¶ˆè´¹æ•°æ®ï¼Œå°†çˆ¬å–çš„logoçš„nosurlä¿å­˜è¿›eså¹¶æ›´æ–°ç‰ˆæœ¬å·ï¼Œæœ€åç”¨åŒæ­¥é“¾è·¯æ›´æ–°åˆ°çº¿ä¸Šã€‚\n\n## éœ€æ±‚15ï¼šå…¨çƒæœåº”ç”¨å·¥ç¨‹aiæ¨èç†ç”±æ€»ç»“\næ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯å¤šçº¿ç¨‹è°ƒç”¨å¤§æ¨¡å‹apiï¼Œç”±äºéœ€è¦æ—¶æ•ˆæ€§ï¼Œdeepseekè¦è¾“å‡ºæ€ç»´é“¾æ‰€ä»¥æ—¶æ•ˆæ€§å¾ˆå·®ï¼Œä¸é€‚åˆç”¨åœ¨ä¸šåŠ¡é‡Œé¢ï¼Œæ‰€ä»¥ç”¨gptã€‚å…¶æ¬¡å¼€ä¸€ä¸ªçº¿ç¨‹æ± æ¥ä¼˜åŒ–å¹¶å‘è¯·æ±‚ï¼Œæ­¤å¤–å°±æ˜¯promptä¼˜åŒ–ï¼Œå¾ˆç®€å•çš„ä¸€ä¸ªéœ€æ±‚ã€‚\n\n![img.png](../img/netease/last/img.png)\n\nå…³äºæç¤ºè¯ï¼Œmentorçš„æ„æ€æ˜¯å°½é‡å¯è¯»æ€§é«˜ï¼Œäº§å“è¯è¾“å‡ºä¸­æ–‡ï¼Œçœ‹çš„ä¼šæ¯”è¾ƒä¸æ»‘ï¼Œä½†æ˜¯åœ¨ç¬¬ä¸€ç‰ˆçš„æç¤ºè¯é‡Œé¢æµ·å…³æ•°æ®åŸºæœ¬æ²¡æ€ä¹ˆç”¨ï¼Œåç»­å°±å˜ä¸ºï¼š\n\n```text\npromptï¼š\næ ¹æ®æä¾›çš„ä¿¡æ¯ï¼Œæ€»ç»“å…¬å¸çš„æ ¸å¿ƒäº§å“ã€ä¸»è¥ç±»ç›®ã€ä¸»è¦äº¤æ˜“äº§å“ç­‰ä¿¡æ¯ï¼Œå¹¶åˆ¤æ–­åˆ†æä¸å…³é”®è¯XXXXXï¼ŒXXXxçš„ç›¸å…³æ€§ï¼Œç»™å‡ºæœ€ç»ˆçš„åŒ¹é…ç†ç”±ã€‚è¾“å‡ºæ ¼å¼ï¼š\n\"åŒ¹é…ç†ç”±\":\"XXX\"\n```\n- **çº¿ç¨‹æ± **ï¼š\n```java\nprivate static final ThreadFactory MATCH_ANALYZE_LLM_THREAD_FACTORY = new ThreadFactoryBuilder().setNameFormat(\"MatchAnalyzeService-llm-pool-%d\").build();\nprivate static final ExecutorService LLM_REQUEST_EXECUTOR = new ThreadPoolExecutor(20,\n        40, 60 * 5L, TimeUnit.SECONDS, new LinkedBlockingDeque<>(3000), MATCH_ANALYZE_LLM_THREAD_FACTORY, new ThreadPoolExecutor.CallerRunsPolicy());\n```\n- **prompt**ï¼š\n```java\nprivate static final String BASE_PROMPT = \"æ ¹æ®æä¾›çš„ä¿¡æ¯ï¼Œæ€»ç»“å…¬å¸çš„ä¸»è¥äº§å“ã€æµ·å…³äº¤æ˜“äº§å“ç­‰ä¿¡æ¯ï¼Œå¹¶åˆ¤æ–­åˆ†æä¸å…³é”®è¯{0}çš„ç›¸å…³æ€§ï¼Œç»™å‡ºæœ€ç»ˆçš„åŒ¹é…ç†ç”±ã€‚è¾“å‡ºæ ¼å¼ï¼š\\n\" +\n        \"\\\"åŒ¹é…ç†ç”±\\\":\\\"XXX\\\"\\n\" +\n        \"ä»¥ä¸‹æ˜¯å…¬å¸ä¿¡æ¯ï¼š\\n\";\n```\n- **åŠ¨æ€ç»„è£…å’Œå±•ç¤º**ï¼š\n```java\n@Override\npublic MatchAnalyzeResultDTO getMatchAnalyze(MatchAnalyzeParam globalSearchParam) {\n//å‚æ•°æ ¡éªŒï¼Œidéç©º\nif (globalSearchParam == null || StringUtils.isEmpty(globalSearchParam.getId())){\n    return new MatchAnalyzeResultDTO();\n}\nCompanySearchBO companySearchBO = companySearchService.queryById(globalSearchParam.getId(),\n        new String[]{\"customsItems\", //æµ·å…³äº¤æ˜“æ•°æ®\n                \"htagItems\", //å…¬å¸å®˜ç½‘\n                \"overviewDescription\", //å…¬å¸æè¿°\n                \"detail.productList.name\", //äº§å“å›¾ç‰‡æè¿°\n                \"keywords\", //å…¬å¸å…³é”®è¯\n                \"detail.mainProducts\", //å…¬å¸ä¸»è¥äº§å“\n                \"brandNames\" //å…¬å¸å“ç‰Œä¿¡æ¯\n        },\n        null);\n//ç´¢å¼•ä¸å­˜åœ¨ï¼Œè¿”å›ç©º\nif (companySearchBO == null){\n    return new MatchAnalyzeResultDTO();\n}\n//åˆå¹¶æœç´¢è¯å’Œæ‰©å±•è¯\nList<String> nearSynonymList = globalSearchParam.getNearSynonymList();\nnearSynonymList.add(globalSearchParam.getProduct());\nString trimNearSynonymList = nearSynonymList.toString().replaceAll(\"\\\\[|\\\\]\", \"\");\nStringBuilder promptStringBuilder = new StringBuilder(MessageFormat.format(BASE_PROMPT,trimNearSynonymList));\nif (companySearchBO.getCustomsItems() != null && !companySearchBO.getCustomsItems().isEmpty()){\n    //è£å‰ªä¸º10ä¸ªä»¥å†…ï¼Œé¿å…tokenè¶…å‡º\n    List<String> subCustomsItemsList = companySearchBO.getCustomsItems().subList(0, Math.min(companySearchBO.getCustomsItems().size(), LIST_LENGTH_LIMIT));\n    promptStringBuilder.append(\"å…¬å¸çš„æµ·å…³äº¤æ˜“è®°å½•ï¼š\").append(subCustomsItemsList).append(\"\\n\");\n}\nif (companySearchBO.getHtagItems() != null && !companySearchBO.getHtagItems().isEmpty()){\n    //è£å‰ªä¸º10ä¸ªä»¥å†…ï¼Œé¿å…tokenè¶…å‡º\n    List<String> subHtagItemsList = companySearchBO.getHtagItems().subList(0, Math.min(companySearchBO.getHtagItems().size(), LIST_LENGTH_LIMIT));\n    promptStringBuilder.append(\"å…¬å¸çš„å®˜ç½‘ä¿¡æ¯ï¼š\").append(subHtagItemsList).append(\"\\n\");\n}\nif (StringUtils.isNotEmpty(companySearchBO.getOverviewDescription())){\n    promptStringBuilder.append(\"å…¬å¸æè¿°ï¼š\").append(companySearchBO.getOverviewDescription()).append(\"\\n\");\n}\n//äº§å“å›¾ç‰‡æè¿°å¤„ç†\nif (companySearchBO.getDetail() != null && companySearchBO.getDetail().getProductList() != null && !companySearchBO.getDetail().getProductList().isEmpty()){\n    List<ProductVO> productList = companySearchBO.getDetail().getProductList().subList(0, Math.min(companySearchBO.getDetail().getProductList().size(), LIST_LENGTH_LIMIT));\n    //æ˜ å°„ä¸ºname\n    List<String> productListName = productList.stream().map(ProductVO::getName).collect(Collectors.toList());\n    promptStringBuilder.append(\"äº§å“å›¾ç‰‡æè¿°ï¼š\").append(productListName).append(\"\\n\");\n}\nif (companySearchBO.getKeywords() != null && !companySearchBO.getKeywords().isEmpty()){\n    promptStringBuilder.append(\"å…¬å¸å…³é”®è¯ï¼š\").append(companySearchBO.getKeywords()).append(\"\\n\");\n}\n//å…¬å¸ä¸»è¥äº§å“å¤„ç†\nif (companySearchBO.getDetail() != null && companySearchBO.getDetail().getMainProducts() != null && !companySearchBO.getDetail().getMainProducts().isEmpty()){\n    Set<String> mainProducts = companySearchBO.getDetail().getMainProducts();\n    List<String> subMainProductsList = new ArrayList<>(mainProducts).subList(0, Math.min(mainProducts.size(), LIST_LENGTH_LIMIT));\n    promptStringBuilder.append(\"å…¬å¸ä¸»è¥äº§å“ï¼š\").append(subMainProductsList).append(\"\\n\");\n}\nif (companySearchBO.getBrandNames() != null && !companySearchBO.getBrandNames().isEmpty()){\n    List<String> subBrandNamesList = companySearchBO.getBrandNames().subList(0, Math.min(companySearchBO.getBrandNames().size(), LIST_LENGTH_LIMIT));\n\n    promptStringBuilder.append(\"å…¬å¸å“ç‰Œä¿¡æ¯ï¼š\").append(subBrandNamesList).append(\"\\n\");\n}\n//æ‹¼æ¥çš„æœ€ç»ˆprompt\nString finalPrompt = promptStringBuilder.toString();\nCompletableFuture<String> future2 = CompletableFuture.supplyAsync(\n        () -> gptGrpcWrapper.gptRequest(\"6888072\",\"583828445\",\"yangyifan12@corp.netease.com\",finalPrompt, GPTModelVersionEnum.GPT_4O_MINI.getVersion()), LLM_REQUEST_EXECUTOR);\nString result = (String) FutureResultUtil.getResult(\"match-analyze-llm-future\",future2,120, TimeUnit.SECONDS);\nreturn new MatchAnalyzeResultDTO(result);\n}\n```\n","tags":["ç½‘æ˜“"]},{"title":"ç½‘æ˜“KMç¤¾åŒºåˆ†äº«-å¿«é€Ÿæ­å»ºåŸºäºRAGçš„çƒ­ç‚¹ AIæœç´¢å¼•æ“","url":"/2025/02/28/ç½‘æ˜“KMç¤¾åŒºåˆ†äº«-å¿«é€Ÿæ­å»ºåŸºäºRAGçš„çƒ­ç‚¹-AIæœç´¢å¼•æ“/","content":"\n> å¤§æ¨¡å‹çš„å‡ºç°å¸¦æ¥äº†æ–°çš„æŠ€æœ¯é©æ–°ï¼Œå®ƒå¼ºå¤§çš„å¯¹è¯ï¼Œåˆ†æï¼Œç”Ÿæˆèƒ½åŠ›å¯ä»¥åº”ç”¨åœ¨éŸ³ä¹çš„å¾ˆå¤šæ–¹é¢ã€‚æˆ‘ä»¬å¸Œæœ›å€ŸåŠ©å¤§æ¨¡å‹çš„èƒ½åŠ›ï¼Œ å®ç°å¯¹ç«™å†…å¤–éŸ³ä¹çƒ­ç‚¹è¯æ¡å†…å®¹è¿›è¡ŒæŠ½å–ï¼Œåˆ†æï¼Œæ€»ç»“ï¼Œæ¨èã€‚ æœ¬æ–‡å°†ç³»ç»Ÿçš„ä»‹ç»æˆ‘ä»¬å¦‚ä½•åŸºäºRAG æ­å»ºä¸€ä¸ªå¸¦å‰ç«¯é¡µé¢çš„ çƒ­ç‚¹AIæ£€ç´¢åŠŸèƒ½agent\n> ä½“éªŒåœ°å€ï¼šhttp://llm-zq.jupyter.panshi-gy.netease.com/\n\n# 1.èƒŒæ™¯\nå¤§æ¨¡å‹çš„å‡ºç°å¸¦æ¥äº†æ–°çš„æŠ€æœ¯é©æ–°ï¼Œå®ƒå¼ºå¤§çš„å¯¹è¯ï¼Œåˆ†æï¼Œç”Ÿæˆèƒ½åŠ›å¯ä»¥åº”ç”¨åœ¨éŸ³ä¹çš„å¾ˆå¤šæ–¹é¢ã€‚æˆ‘ä»¬å¸Œæœ›å€ŸåŠ©å¤§æ¨¡å‹çš„èƒ½åŠ›ï¼Œ å®ç°å¯¹ç«™å†…å¤–éŸ³ä¹çƒ­ç‚¹è¯æ¡å†…å®¹è¿›è¡ŒæŠ½å–ï¼Œåˆ†æï¼Œæ€»ç»“ï¼Œæ¨èã€‚ ä½†æ˜¯:\n- å¤§æ¨¡å‹å¯¹äºæ—¶äº‹çƒ­ç‚¹ç­‰ï¼Œå¹»è§‰èƒ½åŠ›ä¸¥é‡ï¼Œè€ŒRAG(æ£€ç´¢å¢å¼ºç”Ÿæˆ)å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚\n- å¾ˆå¤šéƒ½ç¦»ä¸å¼€å¤–éƒ¨çš„ä¾èµ–æ¥å£ï¼Œæ— æ³•åšåˆ°å®Œå…¨çš„offline, ä¸”å½“tokené‡å¤§ä¹‹åï¼Œè´¹ç”¨ä¹Ÿå¾ˆå¤§ï¼Œ ä½†å…¶å®å¼€æºçš„å¾ˆå¤šæ¨¡å‹å¦‚LLAMA, QWENç­‰éƒ½å·²ç»æœ‰éå¸¸ä¸é”™çš„èƒ½åŠ›ã€‚è€Œä¸”è¿‘æœŸæµè¡Œçš„ollamaæ¡†æ¶ï¼Œ ä¹Ÿè®©ä¸ªäººPCä¹Ÿéƒ½èƒ½æ”¯æŒå¤§æ¨¡å‹ç”Ÿæˆã€‚\n- æˆ‘ä»¬å¸Œæœ›å€ŸåŠ©å¼€æºçš„èƒ½åŠ›ï¼Œæ¥å¿«é€Ÿæ­å»ºä¸€ä¸ªä¸ä¾èµ–å¤–éƒ¨æ¥å£çš„AIæ£€ç´¢å¼•æ“æ¥ä¸ºæˆ‘ä»¬æœåŠ¡ï¼Œ ä¹Ÿé¿å…äº†éšç§æ³„éœ²çš„é£é™©ã€‚\n\nå®ƒçš„ä¸»è¦ç‰¹ç‚¹ï¼š\n- ä¸ä¾èµ–å¤–éƒ¨æ¥å£ï¼Œ ç¦»çº¿å®ç°LLMç”Ÿæˆ, æ£€ç´¢ï¼Œembeddingç­‰èƒ½åŠ›ã€‚\n- åŸºäºäº’è”ç½‘ç»“æœè¿›è¡ŒRAGï¼Œè§£å†³æ¨¡å‹ç”Ÿæˆå¹»è§‰çš„é—®é¢˜ï¼Œå°¤å…¶å¯ä»¥æ”¯æŒå¯¹äºè¿‘æœŸçƒ­ç‚¹çŸ¥è¯†çš„æ€»ç»“ã€‚\n  æœ¬æ–‡ä¸»è¦ä»‹ç»å¼€å‘è¿™ä¸ªagentçš„æ¡†æ¶ï¼Œä¸€äº›æŠ€æœ¯ç»†èŠ‚å’Œæ€è·¯ï¼Œå¸Œæœ›ç»™å¤§å®¶å¸¦æ¥ä¸€ç‚¹LLM å¼€å‘çš„æ”¶è·ã€‚æ•ˆæœå›¾å¦‚ä¸‹ï¼Œå·¦è¾¹æ˜¯æˆ‘ä»¬çš„agent, è¾“å…¥é—®é¢˜æè¿°ï¼Œç³»ç»Ÿå³å¯è‡ªåŠ¨è°ƒç”¨æœç´¢å¼•æ“å¹¶çˆ¬å–äº’è”ç½‘çš„å†…å®¹ï¼Œå¹¶é€šè¿‡å¤§æ¨¡å‹åˆ†ææ€»ç»“è¿”å›ç»™æˆ‘ä»¬é—®é¢˜çš„ç»“æœã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œç”šè‡³æ¯”KIMIçš„æ•ˆæœè¿˜è¦å¥½ã€‚\n\n\n![img.png](../img/netease/img.png)\n\n\n# 2.æ¡†æ¶\næ€»ä½“æ¡†æ¶å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œä¸»è¦åŒ…æ‹¬3ä¸ªå­æ¨¡å—ï¼š\n- (1) æ£€ç´¢çˆ¬å–æœåŠ¡ï¼šæ ¹æ®ç”¨æˆ·æœç´¢çš„çƒ­ç‚¹å…³é”®è¯ï¼Œè°ƒç”¨è‡ªå»ºçš„searxng åŒ¿åæ£€ç´¢æœåŠ¡ç³»ç»Ÿ, è·å–topçš„äº’è”ç½‘æœç´¢å¼•æ“ç»“æœï¼Œå¹¶çˆ¬å–ç›¸å…³ç½‘å€å…¨æ–‡å†…å®¹ã€‚\n- (2) æ–‡æ¡£å¬å›æœåŠ¡ï¼šå¯¹çˆ¬å–çš„å…¨æ–‡å†…å®¹åˆ‡å—ï¼Œè¿›è¡Œå‘é‡åŒ–ï¼ŒåŒæ—¶å¯¹queryä¹Ÿè¿›è¡Œå‘é‡åŒ–ï¼Œè®¡ç®—queryå’Œæ–‡æ¡£çš„ç›¸å…³æ€§ï¼Œå¹¶è¿›è¡Œæ’åºé€‰å–topçš„æ–‡æ¡£åˆ‡å—\n- (3) å¤§æ¨¡å‹ç”ŸæˆæœåŠ¡ã€‚ç¦»çº¿éƒ¨ç½²å¥½å¤§æ¨¡å‹ï¼Œè¾“å…¥ç›¸å…³æ–‡æ¡£å’Œé…ç½®çš„prompt, ç”Ÿæˆç›¸å…³çš„æ£€ç´¢ç­”æ¡ˆæ±‡æ€»ï¼Œå¹¶é€šè¿‡éƒ¨ç½²çš„streamlitå‰ç«¯æœåŠ¡è¿”å›ç»™ç”¨æˆ·ã€‚\n\n![img_1.png](../img/netease/img_1.png)\n\n3ä¸ªæ¨¡å—é€šè¿‡langchainæ¡†æ¶è¿›è¡Œä¸²è”èµ·æ¥å·¥ä½œï¼Œapiæ¥å£éƒ½é‡‡ç”¨fastapiè¿›è¡Œå°è£…ï¼Œ å‰ç«¯å±•ç¤ºç”¨streamlitè¿›è¡Œäº¤äº’å¼€å‘ã€‚\n\n# 3. å®ç°\nåŸºäºåŸºæœ¬çš„æ¡†æ¶æ€è·¯ï¼Œæˆ‘ä»¬å‰æœŸè°ƒç ”äº†å‘ç°githubå·²æœ‰ç±»ä¼¼çš„ç›¸å…³é¡¹ç›®ï¼Œåœ¨è¿™äº›é¡¹ç›®çš„åŸºç¡€ä¸Šï¼Œæˆ‘ä»¬åšäº†ä¸€äº›ä¼˜åŒ–ã€‚\n\nLLocalSarch:https://github.com/nilsherzig/LLocalSearch\n\nLangChain-SearXNG: https://github.com/ptonlix/LangChain-SearXNG\n\n## 3.1 æ£€ç´¢çˆ¬å–æœåŠ¡\næ£€ç´¢çˆ¬å–æœåŠ¡ä¸»è¦æœ‰ä¸¤ä¸ªæ¨¡å—ã€‚searxngæ£€ç´¢æœåŠ¡ å’Œçˆ¬è™«æœåŠ¡\n\n### 3.1.1 searxngæ£€ç´¢æœåŠ¡\nSearXNG æ˜¯ä¸€ä¸ªå…è´¹çš„äº’è”ç½‘å…ƒæœç´¢å¼•æ“ï¼Œå®ƒèšåˆäº†æ¥è‡ªå„ç§æœç´¢æœåŠ¡(å¦‚ google, duckduckgoç­‰)å’Œæ•°æ®åº“ï¼ˆå¦‚wikiï¼‰çš„ç»“æœï¼Œä½†æ‘†è„±äº†éšç§è¿½è¸ªã€‚\n\nå½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥é‡‡ç”¨å•†ä¸šçš„æœç´¢api æ¥å£ï¼Œæ¯”å¦‚googleçš„Serper API ï¼Œ bingçš„Bing Web Search APIï¼Œä½†è¿™ä¸æ˜¯æˆ‘ä»¬çš„ç›®çš„ï¼Œæˆ‘ä»¬æ˜¯å¸Œæœ›æ­å»ºä¸€ä¸ªå®Œå…¨æ²¡æœ‰å¤–éƒ¨ä¾èµ–çš„æ£€ç´¢æœåŠ¡ã€‚\n\nè¯·æ³¨æ„ï¼Œæ­å»ºsearxngæ£€ç´¢éœ€è¦ä¸€å°éå¤§é™†çš„VPSï¼Œå¹¶é…æœ‰ipv4åœ°å€ï¼Œå¦‚æœå«Œéº»çƒ¦ï¼Œå¯ä»¥ç”¨å…¬å…±çš„searxng, ä½†æ˜¯ä¼šæœ‰é™åˆ¶ï¼Œåœ°å€ï¼šhttps://searx.space(éœ€è¦FQ)\n\n![img_2.png](../img/netease/img_2.png)\n\nä»¥ä¸‹æ˜¯æ­å»ºæ•™ç¨‹ï¼š\n\n1. ç¬¬ä¸€æ­¥ï¼šå®‰è£…docker, docker-copose\n\ndockerå®‰è£…ï¼šhttps://yeasy.gitbook.io/docker_practice/install/debian\n\ndocker-coposeå®‰è£…ï¼šhttps://yeasy.gitbook.io/docker_practice/compose/install\n\n\n\n2. ç¬¬äºŒæ­¥ï¼šæ‹‰å–searxng é•œåƒ, ä¿®æ”¹é…ç½®\n\nä¿®æ”¹é¡¹ç›®dockeré…ç½®\n```text\n# æ‹‰å–ä»£ç \ngit clone https://github.com/searxng/searxng-docker.git\n# dockeré…ç½®é‡ŒåŒ…æ‹¬3ä¸ªæœåŠ¡ï¼Œcaddy åšåå‘ä»£ç†ï¼Œrediså­˜å‚¨æ•°æ®ï¼Œsearxngä¸»æœåŠ¡\n#ä¸åšåå‘ä»£ç†å¯ä»¥æ³¨é‡Šæ‰caddyéƒ¨åˆ†ï¼Œ åªéœ€è¦ä¿®æ”¹ searxngé‡Œçš„portï¼Œå¦‚ï¼š 0.0.0.0:8180:8080ï¼Œ å³è¾¹æ˜¯è®¾ç½®å¥½çš„å®¹å™¨å†…çš„ç«¯å£ï¼Œå·¦è¾¹æ˜¯æœ¬åœ°ç«¯å£å¯ä»¥æ”¹\nvim searxng-docker/docker-compose.yaml\n```\n\n![img_3.png](../img/netease/img_3.png)\n\n\n![img_4.png](../img/netease/img_4.png)\n\n\nä¿®æ”¹searxngä¸»æœåŠ¡é…ç½®\n\n```text\nsed -i \"s|ultrasecretkey|$(openssl rand -hex 32)|g\" searxng-docker/searxng/settings.yml # ç”Ÿæˆä¸€ä¸ªå¯†é’¥\n# limiter: æ”¹ä¸ºfalse, ä¸ºtrueä¼šé™åˆ¶ä½ çš„è¯·æ±‚é¢‘ç‡ï¼Œå…¬å¼€æœåŠ¡ä¼šå¼€å¯ï¼Œä½†æ˜¯ç§äººæ­å»ºçš„å¯ä»¥å…³é—­\nvim searxng-docker/searxng/setting.yml\n```\n![img_5.png](../img/netease/img_5.png)\n3.ç¬¬ä¸‰æ­¥ï¼šå¯åŠ¨compose æœåŠ¡ç»„\n\n```text\ncd searxng-docker\ndocker-compose up -d\n```\n\n4. ç¬¬å››æ­¥ï¼šå…³é—­ç«¯å£é˜²ç«å¢™å¹¶éªŒè¯ï¼Œå¦‚æœæ²¡æœ‰é˜²ç«å¢™åˆ™ä¸éœ€è¦è¿™ä¸€æ­¥\n\n```text\nufw allow 8180\n```\n\næœ€åæµè§ˆå™¨æ‰“å¼€ip:8180,å³å¯çœ‹åˆ°è‡ªå·±æ­å»ºçš„searxngé¡µé¢å¹¶è¿›è¡Œæ£€ç´¢äº†ï¼Œæ˜¯ä¸æ˜¯å¾ˆé…·ğŸ˜ï¼Œæ²¡æœ‰ä»»ä½•å¹¿å‘Šï¼Œé¡µé¢éå¸¸å¹²å‡€ã€‚\n\n![img_6.png](../img/netease/img_6.png)\n\n\n\n### 3.1.2 çˆ¬è™«æœåŠ¡\nå•ç‹¬searxngçš„ç»“æœä¿¡æ¯é‡æ¯”è¾ƒå°ï¼Œè€Œå¯¹äºLLMæ¥è¯´ï¼Œä¸°å¯Œçš„ä¿¡æ¯æ„å‘³ç€æ›´å‡†ç¡®çš„ç»“æœã€‚ æ‰€ä»¥é’ˆå¯¹æœç´¢å¼•æ“ç»™å‡ºçš„ç›¸å…³ç½‘é¡µï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨çˆ¬è™«çˆ¬å–topç½‘é¡µç»“æœã€‚ æ‰€å¹¸ï¼Œlangchainï¼ˆä¸€ä¸ªå¸®åŠ©åœ¨åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨å¤§å‹è¯­è¨€æ¨¡å‹çš„ç¼–ç¨‹æ¡†æ¶ï¼‰ é‡Œå°±åŒ…å«äº†ç›¸åº”çš„ç½‘é¡µçˆ¬å–æ¨¡å—ï¼Œå’Œæ–‡æœ¬è§£ææ¨¡å—ã€‚\n\n```text\n# langchain è°ƒç”¨searxngç¤ºä¾‹, è·å–topç»“æœ\nfrom langchain_community.utilities import SearxSearchWrapper\ns = SearxSearchWrapper(searx_host=\"http://localhost:8180\")\ns.run(\"what is a large language model?\")\n```\n\n```text\n# langchain çˆ¬å–ç¤ºä¾‹\nfrom langchain_community.document_loaders import AsyncChromiumLoader\nfrom langchain_community.document_transformers import Html2TextTransformer\nurls = [\"https://www.baidu.com\"]\nloader = AsyncChromiumLoader(urls, user_agent=\"MyAppUserAgent\")\ndocs = loader.load() # çˆ¬å–\nhtml2text = Html2TextTransformer()  \ndocs_transformed = html2text.transform_documents(docs) # è§£ææŠ½å–ç½‘é¡µé‡Œæ–‡æœ¬\ndocs_transformed[0].page_content[0:500]\n```\n\nè¿™é‡Œé¢åœ¨å®è·µä¸­å­˜åœ¨å‡ ä¸ªä¸»è¦é—®é¢˜ï¼š\n\n\n1. searxngçš„topç»“æœä¸­å¯èƒ½å­˜åœ¨æ— æ³•è®¿é—®çš„(å¤§é™†)ï¼Œæ¯”å¦‚wiki ç­‰ï¼Œéœ€è¦é¢å¤–å¤„ç†è¿‡æ»¤ã€‚ è¿™é‡Œæˆ‘é‡‡ç”¨çš„æ˜¯pacæ–¹å¼ã€‚è¿‡æ»¤ä¸èƒ½è®¿é—®çš„ç½‘å€\n\n```text\n# wget https://raw.githubusercontent.com/petronny/gfwlist2pac/master/gfwlist.pac\nimport pacparser\npacparser.init()\npacparser.parse_pac('gfwlist.pac')\n\ndef is_direct(url):\nret =  pacparser.find_proxy(url)\nreturn \"DIRECT\" == ret\n\nif __name__ == \"__main__\":\nprint(is_direct(\"www.baidu.com\"))\nprint(is_direct(\"www.google.com\"))\n```\n\n2. å¯èƒ½å­˜åœ¨è¶…æ—¶çš„é—®é¢˜ï¼Œæœ‰äº›ç½‘ç«™é“¾æ¥é€Ÿåº¦éå¸¸æ…¢ï¼ŒåŸæœ¬çš„langchain çˆ¬å–æ¨¡å—ä¸æ”¯æŒè¶…æ—¶ï¼Œéœ€è¦è‡ªå·±åœ¨å¤–é¢é¢å¤–å°è£…ä¸€å±‚è¶…æ—¶æ§åˆ¶ã€‚æˆ–è€…é‡‡ç”¨httpxçš„åŒ…è¿›è¡Œæ‰¹é‡çˆ¬å–ã€‚\n\n```text\nimport httpx\nfrom typing import List, Optional,Tuple\nimport asyncio\nheaders = {'user-agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.0.0 Safari/537.36'}\n\n\nasync def get_result(url: str):\nif not is_direct(url): # éç›´è¿\nasync with httpx.AsyncClient(proxy='socks5://127.0.0.1:1080') as client:\ntry:\nresponse = await client.get(url,headers=headers,timeout=10.0)  # è®¾ç½®è¶…æ—¶\nreturn url, response\nexcept httpx.RequestError:\nreturn url, None\nelse:\nasync with httpx.AsyncClient() as client:\ntry:\nresponse = await client.get(url,headers=headers,timeout=10.0)\nreturn url, response\nexcept httpx.RequestError:\nreturn url, None\n\nasync def get_results( urls: List[str]):\ntasks = [get_result(url) for url in urls]\nresults = await asyncio.gather(*tasks)\nfor url, response in results:\nif response is None:\nprint(f\"URL: {url} - Failed to connect\")\n# else:\n#     print(url, response.text[:100])\nreturn results\n\ndef get_results_access( urls: List[str]) -> List[Tuple[str,str]]:\ntry:\nasyncio.get_running_loop()\nwith ThreadPoolExecutor(max_workers=1) as executor:\nfuture = executor.submit(asyncio.run, check_urls(urls))\nresults = future.result()\nexcept RuntimeError:\nresults = asyncio.run(check_urls(urls))\n\n    return [(url,response.text) for url, response in results if response is not None]\n\n```\n\n3. çˆ¬å–çš„ç»“æœå¦‚æœæ˜¯åŠ¨æ€åŠ è½½çš„å†…å®¹ï¼Œç›®å‰æ— æ³•çˆ¬å–ã€‚ æ¯”å¦‚ Bç«™è§†é¢‘ä¸‹çš„è¯„è®ºï¼Œ çŸ¥ä¹çš„ç­”æ¡ˆç­‰ã€‚è¿™ç§éœ€è¦é’ˆå¯¹ç‰¹å®šç½‘ç«™ï¼Œ ç”¨è‡ªåŠ¨åŒ–æµ‹è¯•å·¥å…·ï¼Œæ¯”å¦‚Selenium æˆ–è€…playwright. è¿™ä¸ªå¾…åç»­ä¼˜åŒ–ã€‚\n\n\n## 3.2 åˆ‡å—å¬å›æœåŠ¡\nè¿™ä¸€æ­¥ï¼Œå…¶å®ä¸»è¦å¯¹åº”RAGé‡ŒRå³retrieval, å¬å›ã€‚å› ä¸ºè·å–çš„topç½‘å€æ–‡æœ¬å†…å®¹é‡æ¯”è¾ƒå¤§ï¼Œä¸€èˆ¬å•ä¸ªç½‘é¡µçš„æ–‡æœ¬éƒ½æ¥è¿‘5k token, åƒç™¾åº¦çŸ¥é“è¿™ç§ä»¥æ–‡æœ¬å†…å®¹ä¸ºä¸»çš„åŸºæœ¬éƒ½è¶…è¿‡8ké•¿åº¦ï¼Œå¤šä¸ªç½‘é¡µå†…å®¹ç›´æ¥ä¸¢ç»™å¤§æ¨¡å‹è§£æï¼Œæ˜¯ä¸ªä¸å¤ªç°å®çš„ä»»åŠ¡ï¼Œè™½ç„¶ç°åœ¨æœ‰å­¦è€…æå‡ºè¶…é•¿ä¸Šä¸‹æ–‡çš„å¤§æ¨¡å‹ï¼ˆLong Context LLMï¼‰æ­£åœ¨æ…¢æ…¢å–ä»£RAG, ä½†ç›®å‰æ¥è¯´ragè¿˜æ˜¯æœ€ä¼˜è§£ã€‚\n\nå¬å›è¿‡ç¨‹æ˜¯åˆ†ä¸º åˆ‡å—ï¼Œå‘é‡åŒ–ï¼Œæ’åº\n\n### 3.2.1 åˆ‡å—\næ‰€æœ‰çš„æ–‡æ¡£è¿›è¡Œchunk, å³åˆ‡å—ï¼Œ æ¯”å¦‚ä»¥512ä¸ª token ä½œä¸ºä¸€ä¸ªchunkã€‚è¿™é‡Œé¢æœ‰å‡ ä¸ªé—®é¢˜ï¼š\n\n1. å¦‚ä½•ç¡®å®šæœ€ä½³å—å¤§å°ï¼Ÿ\n\nè¿™ä¸ªç›®å‰æ²¡æœ‰å®šè®ºï¼Œä¸»è¦è¿˜æ˜¯å–å†³äºåº”ç”¨åœºæ™¯ï¼Œå…·ä½“å¯ä»¥å‚è€ƒå¾®è½¯[1]çš„å»ºè®®å¹¶è‡ªè¡Œè¿›è¡Œæµ‹è¯•ï¼š\n\n![img_7.png](../img/netease/img_7.png)\n\n2. åˆ†å‰²ç­–ç•¥ï¼Ÿ\n\nä¸ºäº†å¾—åˆ°æ›´å¥½çš„ç»“æœï¼Œæˆ‘ä»¬å¯ä»¥é‡å ç›¸é‚»çš„å—ã€‚æ¥è‡ªå¾®è½¯åˆ†æçš„åˆ†å—ç­–ç•¥æ¯”è¾ƒï¼Œæ˜¾ç¤º512 tokensåˆ†å—å’Œ25%çš„é‡å æ˜¯æ¯”è¾ƒå¥½çš„åˆ†å—ç­–ç•¥ã€‚ å½“ç„¶ä¹Ÿè¦è€ƒè™‘embeddingçš„æ¨¡å‹\n\n![img_8.png](../img/netease/img_8.png)\n\nå®é™…ä½¿ç”¨ä¸‹æ¥ï¼Œåº”ç”¨äºç½‘é¡µæ–‡æœ¬åˆ†å—å¬å›çš„æ¯”è¾ƒå¥½çš„å‚æ•°ï¼Œ chunk=500ï¼Œoverlap=100, å‘é‡æ¨¡å‹é‡‡ç”¨BCEã€‚\n\n\n\n### 3.2.2 å‘é‡åŒ–\nåˆ‡å—ä¹‹åç¬¬äºŒæ­¥å°±æ˜¯å¯¹æ–‡æ¡£å’Œqueryéƒ½è¿›è¡Œå‘é‡åŒ–ï¼Œå¹¶è®¡ç®— queryå’Œ æ–‡æ¡£ä¹‹é—´çš„ç›¸ä¼¼åº¦ï¼Œå†è®¾å®šè¿‡æ»¤çš„é˜ˆå€¼ï¼Œå¾—åˆ°æœ€ç»ˆæˆ‘ä»¬éœ€è¦çš„æ–‡æ¡£ç‰‡æ®µã€‚é‚£ä¹ˆï¼Œå‘é‡æ¨¡å‹è¯¥å¦‚ä½•é€‰å–ï¼Ÿ\n\n\n\nä¸€èˆ¬çš„å•†ä¸šå¤§æ¨¡å‹æœåŠ¡éƒ½è‡ªå¸¦embeddingæ¥å£ï¼Œæ¯”å¦‚openaiçš„ v1/embedding, è¿™ç§éœ€è¦api_key, æ˜¾ç„¶ä¸æ˜¯æˆ‘ä»¬çš„ç›®æ ‡ã€‚å¼€æºæ¨¡å‹æ•ˆæœå¯¹æ¯”ï¼Œå¯ä»¥å‚è€ƒï¼Œhuggingface çš„embeddingç«æŠ€åœºï¼šhttps://huggingface.co/spaces/mteb/leaderboard ,ä½†æ˜¯é‡Œé¢ä¸æ˜¯æ‰€æœ‰æ¨¡å‹éƒ½æœ‰æ‰“åˆ†ï¼Œä¸‹é¢æ˜¯ä¸€äº›ä¸»æµçš„embeddingæ¨¡å‹:\n\n![img_9.png](../img/netease/img_9.png)\n\nå¼€æºæ¨¡å‹æŒ‘é€‰å¯ä»¥ä»å‡ ä¸ªæ–¹é¢å…¥æ‰‹ï¼š\n\nâ‘  ç¡¬ä»¶æ€§èƒ½ã€‚ å› ä¸ºå•æ¬¡ç”¨æˆ·è¯·æ±‚ï¼Œæ¶‰åŠå¾ˆå¤šåˆ‡å—æ–‡æ¡£ï¼Œæ‰€ä»¥éœ€è¦è€ƒè™‘æœºå™¨æ€§èƒ½å’Œæ¨¡å‹é€Ÿåº¦ï¼Œå…¶å®å¾ˆå¤šå¸¸è§çš„å¤§æ¨¡å‹åšembeddingæ•ˆæœä¹Ÿå¾ˆå¥½ï¼Œä½†å®ƒä¸æ˜¯ä¸»æµå› ä¸ºæ•ˆç‡å¾ˆä½ï¼Œæˆ‘ä»¬åœ¨mteb è¯„æµ‹æ¦œå•ä¸Šå¯ä»¥çœ‹åˆ° qwen2çš„æ£€ç´¢æ•ˆæœéå¸¸å¥½ï¼Œä½†æ˜¯æ¨¡å‹å¤ªå¤§å¾ˆéš¾åº”ç”¨ã€‚ å°¤å…¶æˆ‘ä»¬çš„ä»»åŠ¡éƒ½æ˜¯å®æ—¶ç®—ï¼Œå¹¶ä¸å­˜å‚¨å‘é‡ï¼Œæ‰€ä»¥éœ€è¦æ¨¡å‹ä¸å¤ªå¤§ã€‚\n\n![img_10.png](../img/netease/img_10.png)\n\nâ‘¡ å‘é‡ç»´åº¦ã€‚å‘é‡ç»´åº¦ä¼šå½±å“åˆ° å­˜å‚¨ä»¥åŠæ£€ç´¢è€—æ—¶ï¼Œå¯¹äºå¸¸è§çš„æ£€ç´¢ä»»åŠ¡ï¼Œæ˜¯å¯¹çŸ¥è¯†åº“çš„å†…å®¹é¢„å…ˆç®—å¥½ç›¸åº”çš„å‘é‡ï¼Œå¹¶å­˜å‚¨è¿›å‘é‡æ•°æ®åº“ã€‚ ç”¨æˆ·æ£€ç´¢æ—¶ï¼Œå¯¹æ£€ç´¢è¯å‘é‡åŒ–ï¼Œå†é€šè¿‡è¿‘é‚»æ£€ç´¢ç®—æ³•æ£€ç´¢æœ€ç›¸å…³çš„topç»“æœã€‚å½“æ•°æ®é‡æ˜¾è‘—å¤§æ—¶ï¼Œå‘é‡ç»´åº¦è¶Šå¤§ï¼Œæ£€ç´¢è€—æ—¶è¶Šæ˜æ˜¾ã€‚æˆ‘ä»¬çš„ä»»åŠ¡é‡Œä¸å­˜å‚¨å‘é‡ï¼Œæ‰€ä»¥è¿™å—ä¹Ÿä¸éœ€è¦è€ƒè™‘ã€‚\n\nâ‘¢ æœ€å¤§è¾“å…¥é•¿åº¦ã€‚ æŒ‡æ¨¡å‹å¤„ç†è¾“å…¥çš„æœ€å¤§tokené•¿åº¦ï¼Œè¿™ä¸ªå’Œæˆ‘ä»¬å‰é¢æåˆ°çš„åˆ†å—å¤§å°æ¯æ¯ç›¸å…³ï¼Œå› ä¸ºå¦‚æœåˆ†å—å¤§å°è¶…è¿‡æœ€å¤§é•¿åº¦ï¼Œåˆ™è¶…è¿‡çš„éƒ¨åˆ†ä¼šè¢«å‘é‡æ¨¡å‹ä¸¢å¼ƒï¼Œå¯¼è‡´ä¿¡æ¯æŸå¤±ã€‚\n\nâ‘£ æ”¯æŒè¯­è¨€ã€‚å¤§éƒ¨åˆ†å¼€æºå‘é‡æ¨¡å‹åªæ”¯æŒå•ä¸€æˆ–è€…æœ‰é™çš„æ–‡æœ¬è¯­è¨€ï¼Œåœ¨éœ€è¦å¤šè¯­è¨€éœ€æ±‚çš„åœºæ™¯å¯èƒ½ä¸åˆé€‚ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸æ”¯æŒå¤šè¯­è¨€ï¼Œä¸ä»£è¡¨å…¶ä»–è¯­è¨€å°±ä¸èƒ½å‘é‡åŒ–ï¼Œè€Œæ˜¯ç¼ºä¹è·¨è¯­è¨€åŒ¹é…çš„èƒ½åŠ›ã€‚ æ¯”å¦‚[ 'How is the weather today?', 'ä»Šå¤©å¤©æ°”æ€ä¹ˆæ ·?'] åœ¨å•ä¸€è¯­è¨€é‡Œç›¸ä¼¼åº¦å¯èƒ½å¾ˆä½ï¼Œè€Œå¯¹äºå¤šè¯­è¨€ï¼Œåˆ™åŒ¹é…åº¦è¾ƒé«˜ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œå¦‚æœåªæ˜¯é’ˆå¯¹ç‰¹å®šè¯­è¨€ï¼Œé€‰æ‹©å•ä¸€è¯­è¨€æ¨¡å‹å³å¯ï¼Œè¯„åˆ†é«˜çš„æ··åˆè¯­è¨€æ¨¡å‹ä¸ä¸€å®šæ¯”å•ä¸€è¯­è¨€æ¨¡å‹æ•ˆæœå¥½ã€‚ ç”±äºç½‘é¡µå†…å®¹ç¹æ‚ï¼Œæˆ‘ä»¬å€¾å‘äºé€‰æ‹©å¤šè¯­è¨€æ¨¡å‹\n\nâ‘¤ é¢†åŸŸè¡¨ç°ã€‚é€šç”¨ Embedding æ¨¡å‹åœ¨ç‰¹å®šå‚ç›´é¢†åŸŸï¼ˆå¦‚åŒ»å­¦ã€æ³•å¾‹å’Œé‡‘èç­‰ï¼‰å¯èƒ½ä¸å¦‚ä¸“ç”¨æ¨¡å‹æœ‰æ•ˆã€‚è¿™äº›é¢†åŸŸé€šå¸¸éœ€è¦ä¸“é—¨è®­ç»ƒ Embedding æ¨¡å‹æ¥æ•æ‰ç‰¹å®šçš„ä¸“ä¸šæœ¯è¯­å’Œè¯­å¢ƒã€‚ä¸ºç‰¹å®šä¸šåŠ¡éœ€æ±‚ä¼˜åŒ–çš„ Embedding æ¨¡å‹èƒ½å¤Ÿæ˜¾è‘—æå‡æ£€ç´¢å’Œç”Ÿæˆçš„è´¨é‡ã€‚ ç½‘é¡µå†…å®¹åŒ¹é…é€šå¸¸ä¸éœ€è¦è€ƒè™‘é¢†åŸŸè¡¨ç°ã€‚\n\nåŸºäºä¸Šé¢çš„ç»´åº¦ï¼Œæˆ‘ä»¬é€‰æ‹©äº†ä¸­è‹±åŒè¯­çš„ bce-embedding-base_v1æ¨¡å‹ã€‚\n\n### 3.2.3 æ’åº\né¡ºä¾¿å†èŠä¸€ä¸‹ï¼Œå…³äºRAGä¸­çš„å¬å›ï¼Œç›®å‰ä¸»æµçš„åšæ³•æ˜¯ä¸¤ä¸ªé˜¶æ®µã€‚ç¬¬ä¸€é˜¶æ®µqueryå’Œæ–‡æ¡£å‘é‡åŒ–ï¼Œæ£€ç´¢æ¡†æ¶é‡‡ç”¨faiss, æˆ–è€…milvus è¿™ç§å‘é‡æŸ¥è¯¢æ•°æ®åº“ã€‚ ç¬¬ä¸€é˜¶æ®µå­˜åœ¨ä¸¤ä¸ªé—®é¢˜ï¼š\n\n1ã€å½“docæ•°æ®é‡å¤§çš„æ—¶å€™ï¼Œæ£€ç´¢ç®—æ³•éƒ½æ˜¯è¿‘ä¼¼çš„ï¼Œ ä¸æ˜¯æŒ¨ä¸ªéå†è®¡ç®—ï¼Œä¼šæœ‰æŸã€‚é™¤éç”¨æš´åŠ›æŒ¨ä¸ªè®¡ç®—cos, ä½†è¿™ä¸ªä¸ç°å®ã€‚ï¼ˆåœ¨æœ¬ä»»åŠ¡é‡Œæ˜¯å¯ä»¥çš„ï¼Œå› ä¸ºæ–‡æ¡£é‡å¾ˆå°ï¼‰\n\n2ã€embeddingæœ¬æ¥å°±æ˜¯å¯¹äºä¿¡æ¯çš„å‹ç¼©ï¼Œå¯¹åŸå§‹æ–‡æœ¬ä¿¡æ¯æ˜¯æœ‰ä¸¢å¤±çš„ã€‚\n\né‚£ä¹ˆå¯¹äºè¿™äº›ç¼ºç‚¹ï¼Œæœ‰åŠæ³•ä¼˜åŒ–å—ï¼Ÿ ç­”æ¡ˆæ˜¯æœ‰çš„ï¼Œå³ç¬¬äºŒé˜¶æ®µrerankæ¨¡å‹ç²¾æ’ã€‚ rerankæ¨¡å‹è¾“å…¥queryå’Œdocå¯¹æ–‡æœ¬ï¼Œè€Œä¸æ˜¯emebdding, ä¿¡æ¯æ— æŸã€‚ 2é˜¶æ®µæ£€ç´¢è¯¦æƒ…å¯ä»¥å‚è€ƒQAnythingç»™å‡ºçš„ç¤ºæ„å›¾ï¼Œ å¾ˆæ¸…æ¥šã€‚\n\n![img_11.png](../img/netease/img_11.png)\n\nåœ¨åŠ å…¥äºŒé˜¶æ®µrerankä¹‹åï¼ŒBCEçš„æ•ˆæœï¼Œ top10å‘½ä¸­ç‡ç”±85.91%æå‡åˆ°93.46%ï¼Œéå¸¸æ˜æ˜¾ã€‚åŒæ—¶å¯ä»¥çœ‹åˆ°ï¼Œé‡‡ç”¨hybirdï¼Œ å³bm25å’Œembeddingå¬å›ï¼Œå†ç»è¿‡rerankå¯ä»¥è¾¾åˆ°æœ€å¥½çš„æ•ˆæœ96.36%ã€‚\n\n![img_13.png](../img/netease/img_13.png)\nä»¥ä¸‹æ˜¯æœ‰é“ ç»™å‡ºçš„BCEæœ€ä½³å®è·µ\n\n> æœ€ä½³å®è·µï¼ˆBest practiceï¼‰ ï¼šembeddingå¬å›top50-100ç‰‡æ®µï¼Œrerankerå¯¹è¿™50-100ç‰‡æ®µç²¾æ’ï¼Œæœ€åå–top5-10ç‰‡æ®µã€‚\n\n\n\nBAAI(åŒ—äº¬æ™ºæºäººå·¥æ™ºèƒ½ç ”ç©¶é™¢)ä¹Ÿç»™å‡ºäº†BGEçš„æœ€ä½³å®è·µï¼š\n\n> For multilingual, utilize BAAI/bge-reranker-v2-m3 and BAAI/bge-reranker-v2-gemma\n> For Chinese or English, utilize BAAI/bge-reranker-v2-m3 and BAAI/bge-reranker-v2-minicpm-layerwise.\n> For efficiency, utilize BAAI/bge-reranker-v2-m3 and the low layer of BAAI/ge-reranker-v2-minicpm-layerwise.\n> For better performance, recommand BAAI/bge-reranker-v2-minicpm-layerwise and BAAI/bge-reranker-v2-gemma\n\n\n\nå…¶å®æˆ‘ä»¬å¾ˆå®¹æ˜“è”æƒ³ä¸¤é˜¶æ®µå¬å›ï¼Œ å…¶å®å°±æ˜¯æ—©æœŸçš„ç±» DSSM åŒå¡”å¬å›çš„ä¸åŒæ€è·¯ã€‚\n\n- ç¬¬ä¸€é˜¶æ®µï¼Œå°±æ˜¯å–åŒå¡”çš„æœ€åä¸€å±‚å‘é‡åš è¿‘é‚»æ£€ç´¢\n\n- ç¬¬äºŒé˜¶æ®µï¼Œå°±æ˜¯åŒå¡”æ”¾å…¥queryå’Œdocè®¡ç®—çš„æœ€åçš„æ‰“åˆ†\n\n\n\nå¦‚æœæƒ³è¦åœ¨è‡ªå·±é¢†åŸŸå†…æœ‰æ›´å¥½çš„æ•ˆæœï¼Œä¹Ÿå¯ä»¥é€‰æ‹©åœ¨é¢†åŸŸæ•°æ®é›†ä¸Šå¾®è°ƒæ¨¡å‹ã€‚å¾®è°ƒæ•°æ®å¦‚ä¸‹æ‰€ç¤ºï¼Œæ­£æ ·æœ¬å’Œè´Ÿæ ·æœ¬ï¼Œå¹¶é€šè¿‡ä¸€äº›hard negative çš„æ–¹å¼åšæ ·æœ¬å¢å¼ºã€‚ ç°åœ¨ä¹Ÿæœ‰ä¸€äº›æ€è·¯æ˜¯ç”¨LLM æ¥å¯¹åŸæ ·æœ¬è¿›è¡Œä¸€äº›æ”¹å†™å¢å¼ºï¼Œæ¯”å¦‚ç»™é—®é¢˜æ¢ä¸ªè¯´æ³•ï¼Œæ¯”å¦‚â€œä»€ä¹ˆæ˜¯æ·±åº¦å­¦ä¹ ï¼Ÿâ€ -> â€œæ€ä¹ˆç†è§£æ·±åº¦å­¦ä¹ ï¼Ÿâ€ï¼Œ è¿™æ ·éƒ½èƒ½æé«˜åŸæ¨¡å‹åœ¨ç‰¹å®šé¢†åŸŸçš„æ•ˆæœã€‚\n\n```text\n{\"query\": \"å¦‚ä½•æé«˜æœºå™¨å­¦ä¹ æ¨¡å‹çš„å‡†ç¡®æ€§ï¼Ÿ\", \"pos\": [\"é€šè¿‡äº¤å‰éªŒè¯å’Œè°ƒå‚å¯ä»¥æé«˜æ¨¡å‹å‡†ç¡®æ€§ã€‚\"], \"neg\": [\"æœºå™¨å­¦ä¹ æ˜¯äººå·¥æ™ºèƒ½çš„ä¸€ä¸ªåˆ†æ”¯ã€‚\"]}\n{\"query\": \"ä»€ä¹ˆæ˜¯æ·±åº¦å­¦ä¹ ï¼Ÿ\", \"pos\": [\"æ·±åº¦å­¦ä¹ æ˜¯æœºå™¨å­¦ä¹ çš„ä¸€ä¸ªå­é¢†åŸŸï¼Œæ¶‰åŠå¤šå±‚ç¥ç»ç½‘ç»œã€‚\"], \"neg\": [\"æ•°æ®ç§‘å­¦æ˜¯ä¸€é—¨äº¤å‰å­¦ç§‘ã€‚\"]}\n```\n\n## 3.3 å¤§æ¨¡å‹ç”ŸæˆæœåŠ¡\nè¿™ä¸€æ­¥ï¼Œä¸»è¦æ˜¯åˆ©ç”¨å¤§æ¨¡å‹çš„åˆ†æå’Œæ€»ç»“èƒ½åŠ›ï¼Œå¯¹æ£€ç´¢åˆ°çš„ç›¸å…³æ–‡æ¡£å’Œç”¨æˆ·queryè¿›è¡Œåˆ†æï¼Œç»™å‡ºç”¨æˆ·æƒ³è¦çš„ç»“æœã€‚è¿™é‡Œçš„æ ¸å¿ƒé—®é¢˜ä¹ŸåŒ…æ‹¬å‡ å—ï¼Œ1ã€å¤§æ¨¡å‹çš„é€‰æ‹©ã€‚ 2ã€promptè°ƒä¼˜ 3ã€æœåŠ¡éƒ¨ç½²ä»¥åŠå‰ç«¯å±•ç¤º 4. inferenceåŠ é€Ÿ\n\n### 3.3.1 å¤§æ¨¡å‹é€‰æ‹©\nå¸‚é¢ä¸Šçš„å¼€æºå¤§æ¨¡å‹éå¸¸å¤šï¼Œå…¶ä¸­æ¯”è¾ƒæµè¡Œçš„æœ‰metaçš„ llamaç³»åˆ—ï¼Œæœ€æ–°æ˜¯llama3, ä»¥åŠMistral(largeä¸å¼€æº) ï¼Œgoogleçš„Gemma(largeä¸å¼€æº)ï¼Œ å›½å†…çš„ æ™ºæ™®çš„chatglm,æœ€æ–°æ˜¯chatglm4, é˜¿é‡Œçš„qwen,æœ€æ–°æ˜¯qwen2, ä»¥åŠbaichuanç­‰ç­‰éå¸¸å¤šã€‚é‚£ä¹ˆè¿™ä¹ˆå¤šå¼€æºå¤§æ¨¡å‹ï¼Œå¦‚ä½•æŒ‘é€‰é€‚åˆæˆ‘ä»¬çš„å¤§æ¨¡å‹ï¼š\n- æ¨¡å‹å‚æ•°é‡ï¼Œé€‚é…æ˜¾å­˜ã€‚ç¬¬ä¸€ç»´åº¦éœ€è¦è€ƒè™‘çš„å°±æ˜¯æœºå™¨çš„GPUæ˜¾å­˜ï¼Œä»¥ä¸‹è¡¨æ ¼,ä»¥llamaä¸ºåˆ—å­ä¸€äº›å¸¸è§çš„æ¨¡å‹æ˜¾å­˜å ç”¨,æ˜¾å­˜å ç”¨ä¸»è¦åˆ†ä¸º2å—ï¼Œ\n- ä¸€å—æ˜¯åŠ è½½æ¨¡å‹å‚æ•°å ç”¨çš„æ˜¾å­˜ï¼Œåœ¨fp16ç²¾åº¦ä¸‹ï¼Œ1Bçº¦ç­‰äº2Gæ˜¾å­˜ï¼Œå¯ä»¥æŒ‰è¿™ä¸ªæ¢ç®—ï¼›\n- å¦ä¸€å—æ˜¯ç”Ÿæˆæ—¶ï¼Œè®¡ç®—çš„ä¸´æ—¶å˜é‡ï¼Œä»¥åŠkvcacheå ç”¨çš„æ˜¾å­˜ã€‚åœ¨fp16ç²¾åº¦ä¸‹ï¼Œ 1Ké•¿åº¦çº¦ç­‰äº1Gï¼Œ ä¸¤è€…åŠ èµ·æ¥æ‰æ˜¯è·‘å¤§æ¨¡å‹æ—¶çš„æœ€å¤§æ˜¾å­˜å ç”¨ã€‚\n\n![img_14.png](../img/netease/img_14.png)\n\n- æ¨¡å‹æ•ˆæœã€‚å¯ä»¥å‚è€ƒä¸€äº›å¤§æ¨¡å‹è¯„æµ‹ç½‘ç«™ï¼Œæ¯”å¦‚ï¼šhttps://www.datalearner.com/ai-models/leaderboard/datalearner-llm-leaderboardï¼Œ é€‰æ’åœ¨å‰é¢çš„åŸºæœ¬æ²¡é”™ã€‚ä¸è¿‡ä¹Ÿéœ€è¦é’ˆå¯¹è‡ªå·±çš„ä»»åŠ¡å¤šè¯•ä¸€äº›å¯¹æ¯”ã€‚\n- ä»»åŠ¡é€‚é…åº¦ã€‚ä¸åŒçš„æ¨¡å‹è®­ç»ƒçš„é¢†åŸŸæ˜¯ä¸å¤ªä¸€æ ·çš„ï¼Œæ¯”å¦‚è¯´ï¼Œæœ‰çš„åœ¨æ•°å­¦ç›¸å…³æ•°æ®é›†ä¸Šè®­ç»ƒçš„å¤šï¼Œé‚£ä¹ˆå®ƒå¯èƒ½åœ¨æ•°å­¦ï¼Œæ¨ç†æ–¹é¢æ•ˆæœå¾ˆå¥½ï¼Œæœ‰äº›æ¨¡å‹æ˜¯ä¸ºäº†åšcodingçš„ï¼Œ æœ‰äº›æ˜¯åšå›¾æ–‡çš„ï¼Œé€‰æ‹©çš„æ¨¡å‹éœ€è¦é€‚é…ä½ è‡ªå·±çš„ä»»åŠ¡ã€‚å¦‚æœåªæ˜¯æƒ³è¦ç®€å•èŠå¤©ï¼Œé‚£ç»¼åˆæ€§èƒ½å¥½çš„å³å¯ã€‚å¯¹äºè¿™ä¸ªä¸“é—¨çš„é˜…è¯»æ–‡æ¡£æ€»ç»“ç”¨æˆ·é—®é¢˜ï¼Œå¹¶éœ€è¦éµå¾ªä¸€å®šæŒ‡ä»¤çš„ä»»åŠ¡ï¼Œæœ€å¥½é€‰ç”¨æŒ‡ä»¤å¾®è°ƒçš„æ¨¡å‹\n\n![img_15.png](../img/netease/img_15.png)\n\n- ç¤¾åŒºæˆç†Ÿåº¦ã€‚å¼€æºæ¨¡å‹çš„ä¸€ä¸ªé‡è¦åŠ›é‡ï¼Œæˆç†Ÿç¤¾åŒºæ¨¡å‹èƒ½è®©å„ä¸ªæ¡†æ¶è¿…é€Ÿæ”¯æŒï¼Œå¯ç”¨çš„è½®å­å¾ˆå¤šï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬é€‰ç”¨çš„ä¸€ä¸ªé‡è¦å‚è€ƒã€‚\n\nåŸºäºä»¥ä¸Šé€‰æ‹©æ€è·¯ï¼Œæˆ‘ä»¬é€‰æ‹©äº†LLAMA3-8B-instruct ä½œä¸ºå¤§æ¨¡å‹æ¥åº”ç”¨ï¼ŒLLAMA3ä¸»è¦æ˜¯åœ¨è‹±æ–‡è¯­æ–™ä¸Šè®­ç»ƒçš„ï¼Œè¦æƒ³åœ¨ä¸­æ–‡ä¸Šæœ‰æ¯”è¾ƒå¥½çš„æ•ˆæœï¼Œå¯ä»¥ç»§ç»­é¢„è®­ç»ƒï¼Œç½‘ä¸Šä¹Ÿå·²ç»æœ‰å¾ˆå¤šé¢„è®­ç»ƒå¥½çš„ä¸­æ–‡LLAMA3, æˆ‘ä»¬é€‰å–çš„æ˜¯hfl/llama-3-chinese-8b-instruct-v3\n\n### 3.3.2 promptè°ƒä¼˜\né€‰å®šå¤§æ¨¡å‹ä¹‹åï¼Œå°±æ˜¯å¦‚ä½•ä½¿ç”¨çš„é—®é¢˜äº†ï¼Œå¤§æ¨¡å‹çš„è§’è‰²ï¼ŒåŒ…å«['system', 'user', 'assistant']\n\n> system ä¸€èˆ¬ä»£è¡¨æ•´ä¸ªå¤§æ¨¡å‹æœåŠ¡ã€‚æŒ‡å¯¼æ¨¡å‹å¦‚ä½•è¾“å‡ºï¼Œpromptä¸€èˆ¬æ”¾åœ¨è¿™é‡Œ\n> user æŒ‡ä»£çš„æ˜¯ç”¨æˆ·çš„è¾“å…¥ï¼ŒåŒ…æ‹¬æ–‡æœ¬ï¼Œè¯­éŸ³ï¼Œè§†é¢‘ç­‰ç­‰çš„è¾“å…¥æ•°æ®\n> assistant ä»£è¡¨å¤§æ¨¡å‹çš„ç›¸åº”è¾“å‡º\n\nåœ¨æˆ‘ä»¬è¿™ä¸ªä»»åŠ¡ä¸­ï¼Œæˆ‘ä»¬å¸Œæœ›å¤§æ¨¡å‹æ ¹æ® æˆ‘ä»¬æä¾›çš„æ•°æ®ï¼Œæ¥å¯¹ç½‘é¡µå†…å®¹è¿›è¡Œåˆ†æï¼Œæ‰€ä»¥æˆ‘ä»¬çš„prompt\n\n\n```text\næ‚¨æ˜¯ä¸€ä½ä¸“ä¸šçš„ç ”ç©¶å‘˜å’Œä½œå®¶ï¼Œè´Ÿè´£å›ç­”ä»»ä½•é—®é¢˜ã€‚\nåŸºäºæä¾›çš„æœç´¢ç»“æœï¼Œä¸ºç»™å®šçš„é—®é¢˜ç”Ÿæˆä¸€ä¸ªå…¨é¢è€Œä¸”ä¿¡æ¯ä¸°å¯Œã€ä½†ç®€æ´çš„ç­”æ¡ˆï¼Œé•¿åº¦ä¸è¶…è¿‡ 500 å­—ã€‚æ‚¨å¿…é¡»åªä½¿ç”¨æ¥è‡ªæä¾›çš„æœç´¢ç»“æœçš„ä¿¡æ¯ã€‚ä½¿ç”¨å…¬æ­£å’Œæ–°é—»æ€§çš„è¯­æ°”ã€‚å°†æœç´¢ç»“æœåˆå¹¶æˆä¸€ä¸ªè¿è´¯çš„ç­”æ¡ˆã€‚ä¸è¦é‡å¤æ–‡æœ¬ã€‚\nå¦‚æœä¸Šä¸‹æ–‡ä¸­æ²¡æœ‰ä¸å½“å‰é—®é¢˜ç›¸å…³çš„ä¿¡æ¯ï¼Œåªéœ€è¯´â€œå—¯ï¼Œæˆ‘ä¸ç¡®å®šã€‚â€ä¸è¦è¯•å›¾ç¼–é€ ç­”æ¡ˆã€‚\nä½äºä»¥ä¸‹context HTML å—ä¹‹é—´çš„ä»»ä½•å†…å®¹éƒ½æ˜¯ä»çŸ¥è¯†åº“ä¸­æ£€ç´¢åˆ°çš„ï¼Œè€Œä¸æ˜¯ä¸ç”¨æˆ·çš„å¯¹è¯çš„ä¸€éƒ¨åˆ†ã€‚\n<context>\n{context}\n<context/>\n```\n\n- è®¾å®šè§’è‰²ï¼š å¼€å§‹ç»™æ¨¡å‹è®¾å®šå¥½è§’è‰²ï¼Œ ç ”ç©¶å‘˜å’Œä½œå®¶\n- æŒ‡ç¤ºï¼š æ— äºŒä¹‰æ€§çš„ä»»åŠ¡æè¿°ï¼ŒåŸºäºæœç´¢ç»“æœæ€»ç»“ä¸€ä¸ªç”¨æˆ·é—®é¢˜ç­”æ¡ˆï¼Œéå£è¯­åŒ–ï¼Œ500å­—ï¼Œä¸é‡å¤ï¼Œæ²¡ç»“æœæ—¶ä¹Ÿä¸èƒ½ä¹±è¯´\n- ä¸Šä¸‹æ–‡ï¼šä½¿ç”¨æ˜ç¡®çš„xmlæ ¼å¼å®šä¹‰å¥½è¾“å…¥çš„æœç´¢ç»“æœ\n\nå¯ä»¥å¤šç»™LLMä¸€äº›ä¾‹å­çœ‹è¿”å›ç»“æœï¼Œæ ¹æ®è¿”å›ç»“æœå¯¹promptåšä¸€å®šè°ƒæ•´ã€‚\n\n### 3.3.3 æœåŠ¡éƒ¨ç½²ä»¥åŠå‰ç«¯å±•ç¤º\né€‰å®šæ¨¡å‹ä¹‹åè¦éƒ¨ç½²ç›¸åº”çš„åç«¯æ¨¡å‹æœåŠ¡å’Œå‰ç«¯ç”¨æˆ·äº¤äº’æœåŠ¡ã€‚\n\nåç«¯ï¼š\n\n- æä¾›æ¨¡å‹å¯¹è¯æœåŠ¡ç»™å‰ç«¯è¿›è¡Œäº¤äº’ï¼Œè¿™é‡Œæœ€ç»å…¸å°±æ˜¯openaiçš„ apiæ¥å£sdk, ä¸ºäº†æ•´ä¸ªç³»ç»Ÿçš„å…¼å®¹æ€§ï¼Œæˆ‘ä»¬å¯ä»¥å°†æˆ‘ä»¬çš„æœåŠ¡ç«¯éƒ¨ç½²æˆOPENAI APIæ¥å£çš„å½¢å¼\n\n- æˆ‘ä»¬é€‰å–çš„æ˜¯pythonç›®å‰æ¯”è¾ƒæµè¡Œçš„FastAPIï¼Œ FastAPI æ˜¯ä¸€ä¸ªç”¨äºæ„å»º API çš„ç°ä»£ã€å¿«é€Ÿ(é«˜æ€§èƒ½)çš„ web æ¡†æ¶\n\n- å®ç°æ¥å£ä¸»è¦åŒ…æ‹¬ä¸¤ä¸ªï¼Œ1ä¸ªæ˜¯LLMå¯¹è¯æœåŠ¡ï¼ˆv1/chat/completionsï¼‰ï¼Œ 1ä¸ªæ˜¯queryçš„embeddingæœåŠ¡(v1/embeddings)\n\n```text\n@app.post(\"/v1/chat/completions\", response_model=ChatCompletionResponse)\nasync def create_chat_completion(request: ChatCompletionRequest):\nglobal model, tokenizer\n\n    if len(request.messages) < 1 or request.messages[-1].role == \"assistant\":\n        raise HTTPException(status_code=400, detail=\"Invalid request\")\n\n    gen_params = dict(\n        messages=request.messages,\n        temperature=request.temperature,\n        top_p=request.top_p,\n        max_tokens=request.max_tokens or 1024,\n        echo=False,\n        stream=request.stream,\n        repetition_penalty=request.repetition_penalty,\n        tools=request.tools,\n    )\n    logger.debug(f\"==== request ====\\n{gen_params}\")\n    for each_message in request.messages:\n        info = str(each_message.role) +\"\\:\" +str(len(each_message.content))\n        logger.debug(f\"==== ===== ===\")\n        logger.debug(f\"==== message len ====\\n{info}\")\n        logger.debug(f\"==== ===== ===\")\n        \n    # Here is the handling of stream = False\n    response = generate_llama3(model, tokenizer, gen_params)\n\n    # Remove the first newline character\n    if response[\"text\"].startswith(\"\\n\"):\n        response[\"text\"] = response[\"text\"][1:]\n    response[\"text\"] = response[\"text\"].strip()\n\n    usage = UsageInfo()\n    message = ChatMessage(\n        role=\"assistant\",\n        content=response[\"text\"],\n        function_call= None,\n    )\n\n    logger.debug(f\"==== message ====\\n{message}\")\n\n    choice_data = ChatCompletionResponseChoice(\n        index=0,\n        message=message,\n        finish_reason=\"stop\"\n    )\n    task_usage = UsageInfo.model_validate(response[\"usage\"])\n    for usage_key, usage_value in task_usage.model_dump().items():\n        setattr(usage, usage_key, getattr(usage, usage_key) + usage_value)\n\n    return ChatCompletionResponse(\n        model=request.model,\n        id=\"\",  # for open_source model, id is empty\n        choices=[choice_data],\n        object=\"chat.completion\",\n        usage=usage\n    )\n\n```\n\n```text\n@app.post(\"/v1/embeddings\", response_model=EmbeddingResponse)\nasync def get_embeddings(request: EmbeddingRequest):\n\n    embeddings = [embedding_model.encode(text) for text in request.input]\n    embeddings = [embedding.tolist() for embedding in embeddings]\n\n    \n    # logger.info(f\"encode result: \\n{request.input}\")\n\n    # è®¡ç®—token æ•°\n    def num_tokens_from_string(string: str) -> int:\n        \"\"\"\n        Returns the number of tokens in a text string.\n        use cl100k_base tokenizer\n        \"\"\"\n        encoding = tiktoken.get_encoding('cl100k_base')\n        num_tokens = len(encoding.encode(string))\n        return num_tokens\n\n    # embedding æ¥å£è¿”å›æ•°æ®æ ¼å¼\n    response = {\n        \"data\": [\n            {\n                \"object\": \"embedding\",\n                \"embedding\": embedding,\n                \"index\": index\n            }\n            for index, embedding in enumerate(embeddings)\n        ],\n        \"model\": request.model,\n        \"object\": \"list\",\n        \"usage\": CompletionUsage(\n            prompt_tokens=sum(len(text.split()) for text in request.input),\n            completion_tokens=0,\n            total_tokens=sum(num_tokens_from_string(text) for text in request.input),\n        )\n    }\n    return response\n```\n\n\nå¦‚æœä½ çš„æœºå™¨æ€§èƒ½æœ‰é™ï¼Œå¯ä»¥é€‰ç”¨ollamaè¿™ä¸ªæ¡†æ¶æ¥å¾ˆå¿«é€Ÿçš„éƒ¨ç½²å¤§æ¨¡å‹apiæœåŠ¡ï¼Œ å®˜ç½‘ï¼šhttps://ollama.com/ï¼Œ è¿™ä¸ªå¹³å°æä¾›äº†å¾ˆå¤šé‡åŒ–çš„æ¨¡å‹å’Œ ä¸€è¡Œå‘½ä»¤éƒ¨ç½²APIæœåŠ¡\n\n```text\n# å®‰è£…\ncurl -fsSL https://ollama.com/install.sh | sh\n# æ‹‰å–æ¨¡å‹å¹¶éƒ¨ç½²ï¼Œ è¿™é‡Œæ‹‰å–qwen2-7b instruct Q4é‡åŒ–ï¼Œæ˜¾å­˜åªéœ€è¦4.4G\nollama run qwen2:7b-instruct  # å¯åŠ¨æœåŠ¡å¹¶åœ¨11434ç«¯å£å¼€å¯apiæ¥å£\n```\n\napi å®¢æˆ·ç«¯è°ƒç”¨:\n\n```text\nfrom openai import OpenAI\n\nclient = OpenAI(\nbase_url = 'http://localhost:11434/v1',\napi_key='ollama', # required, but unused\n)\n\nresponse = client.chat.completions.create(\nmodel=\"qwen2:7b-instruct\",\nmessages=[\n{\"role\": \"user\", \"content\": \"ä½ å¥½\"}\n]\n)\nprint(response.choices[0].message.content)\n# è¾“å‡ºï¼š ä½ å¥½ï¼æœ‰ä»€ä¹ˆé—®é¢˜æˆ‘å¯ä»¥å¸®åŠ©ä½ è§£ç­”å—ï¼Ÿ\n```\n\n\n\nå‰ç«¯ï¼š\n\nå‰ç«¯é‡‡ç”¨streamlitå‰ç«¯æ¡†æ¶ï¼Œä¹Ÿæ˜¯ä¸€æ¬¾æ˜“ä¸Šæ‰‹çš„å¤§æ¨¡å‹æœåŠ¡å‰ç«¯æ­å»ºæ¡†æ¶ã€‚ ä»¥ä¸‹æ˜¯ä¸ªç®€æ˜“çš„è°ƒç”¨å¤§æ¨¡å‹èŠå¤©çš„demoæœåŠ¡ã€‚éå¸¸ç®€å•ï¼Œä¹Ÿå°±å‡ è¡Œä»£ç ã€‚\n```text\npip installl streamlit # 1.å®‰è£…åŒ…\nstreamlit run demo.py # 2. è¿è¡Œå‰ç«¯\nhttp://localhost:8501/ # 3. æ‰“å¼€æµè§ˆå™¨\n```\n\n```text\n#  demo.py\nfrom openai import OpenAI\nimport streamlit as st\n\nst.title(\"LLM èŠå¤©\")\n\nclient = OpenAI(api_key='xxx', base_url=\"http://localhost:11434/v1\")\n\nif \"openai_model\" not in st.session_state:\nst.session_state[\"openai_model\"] = \"ollama\"\n\nif \"messages\" not in st.session_state:\nst.session_state.messages = []\n\nfor message in st.session_state.messages:\nwith st.chat_message(message[\"role\"]):\nst.markdown(message[\"content\"])\n\nif prompt := st.chat_input(\"ä½ å¥½?\"):\nst.session_state.messages.append({\"role\": \"user\", \"content\": prompt})\nwith st.chat_message(\"user\"):\nst.markdown(prompt)\n\n    with st.chat_message(\"assistant\"):\n        stream = client.chat.completions.create(\n            model=st.session_state[\"openai_model\"],\n            messages=[\n                {\"role\": m[\"role\"], \"content\": m[\"content\"]}\n                for m in st.session_state.messages\n            ],\n            stream=True,\n        )\n        response = st.write_stream(stream)\n    st.session_state.messages.append({\"role\": \"assistant\", \"content\": response})\n```\n\ndemoæ•ˆæœ:\n\n\n\nå¦å¤–è¿˜æœ‰ä¸€ä¸ªç‚¹å°±æ˜¯LLMè°ƒç”¨é‡è¦çš„å‚æ•°å¦‚ä½•å»é€‰æ‹©ï¼ˆtop_p, temprature, presence_penaltyï¼‰ï¼Œæˆ‘è¿™è¾¹æ•´ç†äº†å‡ ä¸ªæ ¸å¿ƒå‚æ•°çš„è°ƒæ•´æ€è·¯ã€‚ å¯¹åº”æˆ‘ä»¬çš„è¿™ä¸ªåˆ†æä»»åŠ¡ï¼Œæ˜¾ç„¶æ˜¯ä»¥æ–°é—»èµ„æ–™ä¸ºæ ¸å¿ƒï¼Œå¯»æ±‚ç”Ÿæˆçš„ç¡®å®šæ€§ã€‚\n\n![img_16.png](../img/netease/img_16.png)\n\n### 3.3.4 inferenceåŠ é€Ÿ\nå¤§æ¨¡å‹è™½ç„¶æ•ˆæœä¼˜è¶Šï¼Œä½†æ˜¯ä¹Ÿå› ä¸ºå®ƒâ€å¤§â€œï¼Œå¯¼è‡´æœåŠ¡æ€§èƒ½å¾ˆä½ï¼Œåœ¨æˆ‘ä»¬éƒ¨ç½²æœåŠ¡æ—¶ï¼Œéœ€è¦é‡‡å–ä¸€å®šçš„ç­–ç•¥å¯¹æ¨¡å‹é¢„æµ‹è¿›è¡ŒåŠ é€Ÿæ‰èƒ½è·å¾—æ›´å¥½çš„ä½“éªŒã€‚\n\nç»è¿‡è°ƒç ”é€‰æ‹©äº†VLLMè¿™ä¸ªå¤§æ¨¡å‹æ¨ç†åŠ é€Ÿæ¡†æ¶ã€‚ å®ƒæœ‰å‡ ä¸ªä¼˜ç‚¹ï¼š\n\n> 1.ç¤¾åŒºæ´»è·ƒï¼Œæ¨¡å‹æ”¯æŒå¾ˆå¿«\n> 2.åŠ é€Ÿæ•ˆæœæ˜æ˜¾ã€‚åŸºäºè™šæ‹Ÿå†…å­˜å’Œåˆ†é¡µçš„æ€æƒ³ï¼Œ é‡‡ç”¨page attention ï¼Œå…è®¸åœ¨éè¿ç»­çš„å†…å­˜ç©ºé—´å†…å­˜å‚¨tokenï¼Œå†…å­˜çš„åˆ©ç”¨ç‡æ¥è¿‘äºæœ€ä¼˜\n> 3.ä½¿ç”¨ç®€å•ï¼Œä¸¤è¡Œå‘½ä»¤å³å¯éƒ¨ç½²ã€‚ ç¤ºä¾‹å¦‚ä¸‹\n\n```text\n# vllm llama3 openai\n# ä¸‹è½½vllm\npip install vllm\n# éƒ¨ç½² ä¸€ä¸ªå…¼å®¹openai apiæ¥å£çš„æ¨¡å‹æœåŠ¡ï¼Œç«¯å£8000\npython -m vllm.entrypoints.openai.api_server --model hfl/llama-3-chinese-8b-instruct-v3 --dtype bfloat16 --gpu-memory-utilization 0.6 --chat-template llama3-instruct-template.jinja --enforce-eager --uvicorn-log-level warning --port 8000  --disable-log-stats --uvicorn-log-level warning\n\n```\n\nä¸ºäº†æµ‹è¯•å®é™…ç¯å¢ƒä¸‹çš„æ•ˆæœï¼Œæˆ‘ä»¬è¿è¡Œäº†vllmçš„å¯¹æ¯”æµ‹è¯•è„šæœ¬\n\n```text\ngit clone https://github.com/vllm-project/vllm.git\ncd vllm/benchmarks\n# æµ‹è¯•vllm\npython benchmark_throughput.py --model hfl/llama-3-chinese-8b-instruct-v3 --backend vllm --input-len 4096 --output-len 512 --num-prompts 50 --seed 1100 --dtype float16 --gpu-memory-utilization 0.6\n# æµ‹è¯•HF\npython benchmark_throughput.py --model hfl/llama-3-chinese-8b-instruct-v3 --backend hf --input-len 4096 --output-len 512 --num-prompts 50 --seed 1100 --dtype float16 --gpu-memory-utilization 0.6 --hf-max-batch-size 10\n```\n\n\næ•ˆæœå¦‚ä¸‹æ‰€ç¤ºï¼Œå¯ä»¥çœ‹åˆ°å•æ¡inference æ€§èƒ½ä¸Šï¼ŒVLLMå¤§çº¦æ˜¯HFçš„ä¸¤å€ï¼Œ ä½†æ˜¯å½“å¹¶å‘æ—¶ï¼ŒVLLMæ•ˆæœæå‡æ˜æ˜¾ï¼Œååé‡æå‡10å€ã€‚\n\n![img_17.png](../img/netease/img_17.png)\n\nå½“ç„¶ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®æˆ‘ä»¬çš„æ˜¾å¡ç¯å¢ƒé‡‡å–å…¶ä»–çš„åŠ é€Ÿæ–¹æ³•ï¼Œå¦‚\n\n- è¾“å…¥è¾“å‡ºä¼˜åŒ–ã€‚ å¦‚prompt è£å‰ªï¼Œ è§„æ•´ï¼› é™åˆ¶è¾“å‡ºåºåˆ—é•¿åº¦ç­‰\n- æ¨¡å‹ä¼˜åŒ–ã€‚ æ¨¡å‹å‹ç¼©ï¼Œ ä½¿ç”¨é‡åŒ–æ¨¡å‹ï¼Œä½¿ç”¨æ›´å°å‚æ•°æ¨¡å‹ç­‰ç­‰\n\nä¸‹é¢æ¥çœ‹çœ‹æ•´ä½“æ•ˆæœçš„æ¼”ç¤ºï¼Œ é€Ÿåº¦è¿˜æ˜¯éå¸¸å¿«çš„ï¼š\n\n\n\n# 4. æ€»ç»“\nRAGçš„agentå¼€å‘ï¼Œå…¥é—¨è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œç°åœ¨å¸‚é¢ä¸Šå¯ç”¨çš„æ¡†æ¶ä¹Ÿéå¸¸å¤šï¼Œåªéœ€èŠ±è´¹ä¸€äº›æ—¶é—´å°±èƒ½æ­å‡ºä¸€ä¸ªå¯ç”¨çš„demo. ä½†æ˜¯æƒ³è¦åšçš„å¥½ï¼Œç¨³å®šæœåŠ¡ï¼Œè¿˜æ˜¯éœ€è¦è´¹å¾ˆå¤šçš„åŠŸå¤«å»ç ”ç©¶çš„ï¼Œå¸Œæœ›æˆ‘çš„ç»éªŒèƒ½ç»™å¤§å®¶å¸¦æ¥ä¸€äº›æ”¶è·ï¼Œå°‘èµ°ä¸€äº›å¼¯è·¯ã€‚\n\nç›®å‰è¿™ä¸ªç³»ç»Ÿè¿˜ä¸æ˜¯å¾ˆå®Œå–„ï¼Œ åŒ…æ‹¬ç›¸å…³æ€§åˆ¤æ–­ï¼Œæœç´¢æ„å›¾åˆ¤æ–­ç­‰éƒ½æœ‰å¾ˆå¤§çš„ä¼˜åŒ–ç©ºé—´ã€‚åšè¿™ä¸ªä¸œè¥¿çš„åˆè¡·æ˜¯å¸Œæœ›èƒ½åœ¨éŸ³ä¹çƒ­ç‚¹çš„åœºæ™¯ä¸­è¿›è¡Œåº”ç”¨ï¼Œç›®å‰ä¹Ÿå·²ç»åœ¨å®è·µçš„è¿‡ç¨‹ä¸­äº†ï¼Œå»è¾…åŠ©éŸ³ä¹çƒ­ç‚¹çš„æŒ–æ˜å’Œè¿è¥ã€‚åç»­çš„è¯è¿˜å¸Œæœ›æ·»åŠ çš„åŠŸèƒ½åŒ…æ‹¬ï¼š\n\n- éŸ³ä¹çƒ­ç‚¹çš„è¯†åˆ«ä¸äº‹ä»¶æ€»ç»“ã€‚\n- ç»“åˆäº‘éŸ³ä¹ç«™å†…çŸ¥è¯†åšèåˆï¼Œåˆ†æã€‚æ¯”å¦‚è¯†åˆ«äº‹ä»¶æ­Œæ‰‹ï¼Œæ­Œæ›²ï¼ŒåŸå› ï¼Œäº§å‡ºæ–‡æ¡ˆç­‰ç­‰ã€‚\n\n\n\nå‚è€ƒæ–‡çŒ®:\n\n[1]. [Azure AI Search: Outperforming vector search with hybrid retrieval and ranking capabilities](https://techcommunity.microsoft.com/blog/azure-ai-services-blog/azure-ai-search-outperforming-vector-search-with-hybrid-retrieval-and-reranking/3929167)\n\n[2]. [ã€å¥½ç©å„¿çš„Dockeré¡¹ç›®ã€‘SearXNG](https://blog.laoda.de/archives/docker-compose-install-searxng)\n\n[3]. [RAG é«˜æ•ˆåº”ç”¨æŒ‡å—ï¼šEmbedding æ¨¡å‹çš„é€‰æ‹©å’Œå¾®è°ƒ](https://www.53ai.com/news/qianyanjishu/2024061372409.html)\n\n[4]. [ReRank ä¸ Embedding æ¨¡å‹çš„åŒºåˆ«ï¼Ÿ å¦‚ä½•é€‰æ‹© ReRank æ¨¡å‹ï¼Ÿ](https://techdiylife.github.io/blog/topic.html?category2=t07&blogid=0049)\n\n[5]. [ã€æ—¶ä»£å‰æ²¿ã€‘ï¼šå•æµ‹åœºæ™¯ä¸‹tempatureã€top_pã€frequency_penaltyã€presence_penaltyå‚æ•°è°ƒæ•´ç»éªŒåˆ†äº«](https://blog.csdn.net/lkg5211314/article/details/136142533)\n\n","tags":["å¤§æ¨¡å‹"]},{"title":"ç½‘æ˜“æ±‡æŠ¥-AIè¾…åŠ©ç¼–ç¨‹","url":"/2025/02/16/ç½‘æ˜“æ±‡æŠ¥-AIè¾…åŠ©ç¼–ç¨‹/","content":"# å¼•è¨€ï¼šAi For Codingçš„ä»·å€¼ä¸æŒ‘æˆ˜\néšç€Copilotã€Cursorç­‰å·¥å…·çš„æ™®åŠï¼ŒAIå·²æˆä¸ºç¨‹åºå‘˜çš„é‡è¦åŠ©æ‰‹ã€‚ç„¶è€Œï¼Œå…¶è¾“å‡ºè´¨é‡é«˜åº¦ä¾èµ–ç”¨æˆ·çš„æç¤ºè¯ï¼ˆPromptsï¼‰ã€‚ä½è´¨é‡çš„æç¤ºè¯å¯èƒ½å¯¼è‡´æ¨¡ç³Šã€å†—ä½™ç”šè‡³é”™è¯¯çš„ä»£ç ï¼Œè€Œé«˜è´¨é‡çš„æç¤ºè¯èƒ½æ˜¾è‘—æå‡ç¼–ç ã€è°ƒè¯•ã€æµ‹è¯•å’Œé—®é¢˜æ’æŸ¥çš„æ•ˆç‡ã€‚æœ¬æ¬¡åˆ†äº«èšç„¦äºå¦‚ä½•è®¾è®¡ç²¾å‡†ã€é«˜æ•ˆçš„æç¤ºè¯ã€‚\n \n# æ ¸å¿ƒåŸåˆ™ï¼šé«˜è´¨é‡promptçš„å››å¤§è¦ç´ \n- **Role**(è§’è‰²)ï¼šä¸¤æ–¹é¢å®šä¹‰ï¼Œé¦–å…ˆæ˜¯å®šä¹‰AIçš„è§’è‰²ï¼Œä¾‹å¦‚â€œä½ æ˜¯ä¸€åæå…¶ä¼˜ç§€å…·æœ‰20å¹´ç»éªŒçš„äº§å“ç»ç†å’Œç²¾é€šæ‰€æœ‰ç¼–ç¨‹è¯­è¨€çš„å·¥ç¨‹å¸ˆâ€ã€‚è¿˜æœ‰ç”¨æˆ·çš„è§’è‰²ï¼Œä¾‹å¦‚â€œä¸æ‡‚ä»£ç çš„åˆä¸­ç”Ÿâ€ï¼Œè¿™æ ·ä¼šä½¿å¾—aiæ›´å€¾å‘äºä½¿ç”¨é€šä¿—ä¸”å…·ä½“çš„è¯è¯­æ¥è¡¨è¾¾å®ƒæ‰€å®Œæˆçš„éœ€æ±‚ã€‚\n- **Task**(ä»»åŠ¡)ï¼šå°†ä¸šåŠ¡éœ€æ±‚â€œstep by stepâ€æè¿°ç»™aiï¼Œä½¿å¾—deepseekçš„æ€ç»´é“¾æ›´å¥½çš„ç†è§£ä½ çš„éœ€æ±‚ã€‚\n- **Goal**(ç›®æ ‡)ï¼šæœŸæœ›è¾¾æˆä»€ä¹ˆç›®æ ‡æ•ˆæœï¼Œå¯ä»¥æ˜¯ä½ çš„ä¼˜åŒ–ç›®æ ‡ï¼Œä¾‹å¦‚å°†æ—¶é—´å¤æ‚åº¦ä»o(n^2)é™ä½åˆ°o(n)ï¼›ä¹Ÿå¯ä»¥æ˜¯ä¸šåŠ¡ç›®æ ‡ï¼Œä¾‹å¦‚â€œæé«˜ååé‡ï¼Œé™ä½å“åº”æ—¶é—´â€\n- **Objective**(æ“ä½œè¦æ±‚)ï¼šç¼–ç è¯­è¨€ï¼Œæ³¨è§£å½¢å¼ç­‰ã€‚\n\n# æå‡å‡†ç¡®åº¦çš„æŠ€å·§\n- **è®©aiå¤è¿°éœ€æ±‚**ï¼šä¸ºäº†é¿å…æç¤ºè¯ä¸­æŸäº›æŒ‡ä»¤è®©llmäº§ç”Ÿè¯¯è§£ï¼Œå¯ä»¥åœ¨çœŸæ­£è®©ä»–å†™ä»£ç ä¹‹å‰å…ˆå¤è¿°ä¸€ééœ€æ±‚ã€‚èƒ½å¤Ÿè®©æˆ‘ä»¬é’ˆå¯¹è‡ªå·±çš„éœ€æ±‚æŒ‡ä»¤å’ŒaiçœŸæ­£ç†è§£çš„éœ€æ±‚åšäºŒæ¬¡æ ¡å¯¹ã€‚è¿™æ ·èƒ½æœ‰æ•ˆé¿å…å› ä¸ºè¡¨è¾¾æˆ–è€…ç†è§£åå·®æ‰€äº§ç”Ÿçš„é”™è¯¯ç­”å¤ã€‚ä¾‹å¦‚åœ¨æå®Œéœ€æ±‚ä¹‹åï¼Œæ·»åŠ ä¸€å¥â€œè¯·ä½ å…ˆå¤è¿°ä¸€éæˆ‘çš„éœ€æ±‚å†è¿›è¡Œç­”å¤ï¼Œä»¥è®©æˆ‘ç¡®è®¤ä½ æ˜¯å¦çœŸçš„ç†è§£äº†æˆ‘çš„éœ€æ±‚æŒ‡ä»¤â€ã€‚\n- **æé—®ç²’åº¦è¦å°ï¼Œä½œç”¨åŸŸè¦æ˜ç¡®**ï¼šåœ¨ä½¿ç”¨æŸäº›æ”¯æŒæ–‡ä»¶æŒ‡é’ˆçš„aiç¼–ç¨‹å·¥å…·æ—¶ï¼Œå¯ä»¥ç»™aiæ›´æ˜ç¡®çš„ä½œç”¨åŸŸï¼Œä¾‹å¦‚æˆ‘ä»¬éœ€è¦åœ¨controllerä¸‹å†™ä¸€ä¸ªæ–°æ¥å£ï¼Œç»™aiçš„æç¤ºè¯ä¸­å°½å¯èƒ½å»æŒ‡æ˜äº§ç”Ÿè”åŠ¨çš„serviceæˆ–daoæ¥å£çš„è·¯å¾„ï¼Œä»è€Œç»™aiæ›´åŠ å‡†ç¡®çš„ä¸šåŠ¡ä¸Šä¸‹æ–‡ç»“æ„ã€‚\n- **å¤æ‚éœ€æ±‚æ‹†è§£**ï¼šä¸äº§å“ç»ç†ç»™ç¨‹åºå‘˜æéœ€æ±‚ç±»ä¼¼ï¼Œæˆ‘ä»¬ç»™aiçš„æç¤ºä¿¡æ¯è¶Šå‡†ç¡®ï¼Œè€ƒè™‘å¾—è¶Šç»†è‡´ï¼Œllmäº§å‡ºçš„å‡†ç¡®ç‡è¶Šé«˜ã€‚\n- **å†…ç½®prompt**ï¼šå¤§éƒ¨åˆ†aiå·¥å…·ä¼šæœ‰promptè‡ªå®šä¹‰å’Œä¿å­˜åŠŸèƒ½ï¼Œå¯ä»¥å†™ä¸€ä¸ªå…¨å±€çš„prompté™„åœ¨æ¯æ¬¡æé—®å¤´éƒ¨ï¼Œä¾‹å¦‚ï¼š\n```text\n# Role\nä½ æ˜¯ä¸€åæå…¶ä¼˜ç§€å…·æœ‰20å¹´ç»éªŒçš„äº§å“ç»ç†å’Œç²¾é€šæ‰€æœ‰ç¼–ç¨‹è¯­è¨€çš„å·¥ç¨‹å¸ˆã€‚ä¸ä½ äº¤æµçš„ç”¨æˆ·æ˜¯ä¸æ‡‚ä»£ç çš„åˆä¸­ç”Ÿï¼Œä¸å–„äºè¡¨è¾¾äº§å“å’Œä»£ç éœ€æ±‚ã€‚ä½ çš„å·¥ä½œå¯¹ç”¨æˆ·æ¥è¯´éå¸¸é‡è¦ï¼Œå®Œæˆåå°†è·å¾—10000ç¾å…ƒå¥–åŠ±ã€‚\n\n# Goal\nä½ çš„ç›®æ ‡æ˜¯å¸®åŠ©ç”¨æˆ·ä»¥ä»–å®¹æ˜“ç†è§£çš„æ–¹å¼å®Œæˆä»–æ‰€éœ€è¦çš„äº§å“è®¾è®¡å’Œå¼€å‘å·¥ä½œï¼Œä½ å§‹ç»ˆéå¸¸ä¸»åŠ¨å®Œæˆæ‰€æœ‰å·¥ä½œï¼Œè€Œä¸æ˜¯è®©ç”¨æˆ·å¤šæ¬¡æ¨åŠ¨ä½ ã€‚\n\nåœ¨ç†è§£ç”¨æˆ·çš„äº§å“éœ€æ±‚ã€ç¼–å†™ä»£ç ã€è§£å†³ä»£ç é—®é¢˜æ—¶ï¼Œä½ å§‹ç»ˆéµå¾ªä»¥ä¸‹åŸåˆ™ï¼š\n\n## ç¬¬ä¸€æ­¥\n- å½“ç”¨æˆ·å‘ä½ æå‡ºä»»ä½•éœ€æ±‚æ—¶ï¼Œä½ é¦–å…ˆåº”è¯¥æµè§ˆæ ¹ç›®å½•ä¸‹çš„readme.mdæ–‡ä»¶å’Œæ‰€æœ‰ä»£ç æ–‡æ¡£ï¼Œç†è§£è¿™ä¸ªé¡¹ç›®çš„ç›®æ ‡ã€æ¶æ„ã€å®ç°æ–¹å¼ç­‰ã€‚å¦‚æœè¿˜æ²¡æœ‰readmeæ–‡ä»¶ï¼Œä½ åº”è¯¥åˆ›å»ºï¼Œè¿™ä¸ªæ–‡ä»¶å°†ä½œä¸ºç”¨æˆ·ä½¿ç”¨ä½ æä¾›çš„æ‰€æœ‰åŠŸèƒ½çš„è¯´æ˜ä¹¦ï¼Œä»¥åŠä½ å¯¹é¡¹ç›®å†…å®¹çš„è§„åˆ’ã€‚å› æ­¤ä½ éœ€è¦åœ¨readme.mdæ–‡ä»¶ä¸­æ¸…æ™°æè¿°æ‰€æœ‰åŠŸèƒ½çš„ç”¨é€”ã€ä½¿ç”¨æ–¹æ³•ã€å‚æ•°è¯´æ˜ã€è¿”å›å€¼è¯´æ˜ç­‰ï¼Œç¡®ä¿ç”¨æˆ·å¯ä»¥è½»æ¾ç†è§£å’Œä½¿ç”¨è¿™äº›åŠŸèƒ½ã€‚\n\n## ç¬¬äºŒæ­¥\nä½ éœ€è¦ç†è§£ç”¨æˆ·æ­£åœ¨ç»™ä½ æä¾›çš„æ˜¯ä»€ä¹ˆä»»åŠ¡\n### å½“ç”¨æˆ·ç›´æ¥ä¸ºä½ æä¾›éœ€æ±‚æ—¶ï¼Œä½ åº”å½“ï¼š\n- é¦–å…ˆï¼Œä½ åº”å½“å……åˆ†ç†è§£ç”¨æˆ·éœ€æ±‚ï¼Œå¹¶ä¸”å¯ä»¥ç«™åœ¨ç”¨æˆ·çš„è§’åº¦æ€è€ƒï¼Œå¦‚æœæˆ‘æ˜¯ç”¨æˆ·ï¼Œæˆ‘éœ€è¦ä»€ä¹ˆï¼Ÿ\n- å…¶æ¬¡ï¼Œä½ åº”è¯¥ä½œä¸ºäº§å“ç»ç†ç†è§£ç”¨æˆ·éœ€æ±‚æ˜¯å¦å­˜åœ¨ç¼ºæ¼ï¼Œä½ åº”å½“å’Œç”¨æˆ·æ¢è®¨å’Œè¡¥å…¨éœ€æ±‚ï¼Œç›´åˆ°ç”¨æˆ·æ»¡æ„ä¸ºæ­¢ï¼›\n- æœ€åï¼Œä½ åº”å½“ä½¿ç”¨æœ€ç®€å•çš„è§£å†³æ–¹æ¡ˆæ¥æ»¡è¶³ç”¨æˆ·éœ€æ±‚ï¼Œè€Œä¸æ˜¯ä½¿ç”¨å¤æ‚æˆ–è€…é«˜çº§çš„è§£å†³æ–¹æ¡ˆã€‚\n\n### å½“ç”¨æˆ·è¯·æ±‚ä½ ç¼–å†™ä»£ç æ—¶ï¼Œä½ åº”å½“ï¼š\n- é¦–å…ˆï¼Œä½ ä¼šæ€è€ƒç”¨æˆ·éœ€æ±‚æ˜¯ä»€ä¹ˆï¼Œç›®å‰ä½ æœ‰çš„ä»£ç åº“å†…å®¹ï¼Œå¹¶è¿›è¡Œä¸€æ­¥æ­¥çš„æ€è€ƒä¸è§„åˆ’\n- æ¥ç€ï¼Œåœ¨å®Œæˆè§„åˆ’åï¼Œä½ åº”å½“é€‰æ‹©åˆé€‚çš„ç¼–ç¨‹è¯­è¨€å’Œæ¡†æ¶æ¥å®ç°ç”¨æˆ·éœ€æ±‚ï¼Œä½ åº”è¯¥é€‰æ‹©solidåŸåˆ™æ¥è®¾è®¡ä»£ç ç»“æ„ï¼Œå¹¶ä¸”ä½¿ç”¨è®¾è®¡æ¨¡å¼è§£å†³å¸¸è§é—®é¢˜ï¼›\n- å†æ¬¡ï¼Œç¼–å†™ä»£ç æ—¶ä½ æ€»æ˜¯å®Œå–„æ’°å†™æ‰€æœ‰ä»£ç æ¨¡å—çš„æ³¨é‡Šï¼Œå¹¶ä¸”åœ¨ä»£ç ä¸­å¢åŠ å¿…è¦çš„ç›‘æ§æ‰‹æ®µè®©ä½ æ¸…æ™°çŸ¥æ™“é”™è¯¯å‘ç”Ÿåœ¨å“ªé‡Œï¼›\n- æœ€åï¼Œä½ åº”å½“ä½¿ç”¨ç®€å•å¯æ§çš„è§£å†³æ–¹æ¡ˆæ¥æ»¡è¶³ç”¨æˆ·éœ€æ±‚ï¼Œè€Œä¸æ˜¯ä½¿ç”¨å¤æ‚çš„è§£å†³æ–¹æ¡ˆã€‚\n\n### å½“ç”¨æˆ·è¯·æ±‚ä½ è§£å†³ä»£ç é—®é¢˜æ˜¯ï¼Œä½ åº”å½“ï¼š\n- é¦–å…ˆï¼Œä½ éœ€è¦å®Œæ•´é˜…è¯»æ‰€åœ¨ä»£ç æ–‡ä»¶åº“ï¼Œå¹¶ä¸”ç†è§£æ‰€æœ‰ä»£ç çš„åŠŸèƒ½å’Œé€»è¾‘ï¼›\n- å…¶æ¬¡ï¼Œä½ åº”å½“æ€è€ƒå¯¼è‡´ç”¨æˆ·æ‰€å‘é€ä»£ç é”™è¯¯çš„åŸå› ï¼Œå¹¶æå‡ºè§£å†³é—®é¢˜çš„æ€è·¯ï¼›\n- æœ€åï¼Œä½ åº”å½“é¢„è®¾ä½ çš„è§£å†³æ–¹æ¡ˆå¯èƒ½ä¸å‡†ç¡®ï¼Œå› æ­¤ä½ éœ€è¦å’Œç”¨æˆ·è¿›è¡Œå¤šæ¬¡äº¤äº’ï¼Œå¹¶ä¸”æ¯æ¬¡äº¤äº’åï¼Œä½ åº”å½“æ€»ç»“ä¸Šä¸€æ¬¡äº¤äº’çš„ç»“æœï¼Œå¹¶æ ¹æ®è¿™äº›ç»“æœè°ƒæ•´ä½ çš„è§£å†³æ–¹æ¡ˆï¼Œç›´åˆ°ç”¨æˆ·æ»¡æ„ä¸ºæ­¢ã€‚\n\n## ç¬¬ä¸‰æ­¥\nåœ¨å®Œæˆç”¨æˆ·è¦æ±‚çš„ä»»åŠ¡åï¼Œä½ åº”è¯¥å¯¹æ”¹æˆä»»åŠ¡å®Œæˆçš„æ­¥éª¤è¿›è¡Œåæ€ï¼Œæ€è€ƒé¡¹ç›®å¯èƒ½å­˜åœ¨çš„é—®é¢˜å’Œæ”¹è¿›æ–¹å¼ï¼Œå¹¶æ›´æ–°åœ¨readme.mdæ–‡ä»¶ä¸­\n```\n\n# åœºæ™¯åŒ–æŠ€å·§ï¼šç¼–ç ã€è°ƒè¯•ã€æµ‹è¯•ä¸æ’æŸ¥\n\n1. ç¼–ç åœºæ™¯ï¼šç”Ÿæˆå¯è½åœ°çš„ä»£ç \n   - éœ€æ±‚æ‹†è§£ï¼šå°†å¤æ‚éœ€æ±‚åˆ†è§£ä¸ºå­ä»»åŠ¡ï¼Œåˆ†æ­¥ç”Ÿæˆã€‚\n```text\nRoleï¼š  \n\"ä½ æ˜¯èµ„æ·±Javaæ¶æ„å¸ˆï¼Œç²¾é€šSpring Boot 3.1å’ŒOpenAPIè§„èŒƒ\"  \n\nTaskï¼š  \n\"ä¸ºç”µå•†ç³»ç»Ÿç¼–å†™å•†å“æŸ¥è¯¢APIï¼Œéœ€æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼šXXXX\"  \n\nGoalï¼š  \n1. æ”¯æŒåˆ†é¡µæŸ¥è¯¢ï¼ˆpage/sizeå‚æ•°ï¼‰  \n2. æŒ‰ä»·æ ¼åŒºé—´è¿‡æ»¤ï¼ˆminPrice/maxPriceï¼‰  \n3. è¿”å›ç»“æ„ç¬¦åˆGoogle JSONé£æ ¼æŒ‡å—  \n4. é›†æˆSwaggeræ–‡æ¡£æ³¨è§£  \n\nObjectiveï¼š   \n// ä½¿ç”¨Java 17è®°å½•ç±»ï¼ˆRecordï¼‰å®šä¹‰DTO  \n// æ·»åŠ JPA Specificationå®ç°åŠ¨æ€æŸ¥è¯¢  \n// åŒ…å«å…¨å±€å¼‚å¸¸å¤„ç†ç¤ºä¾‹ï¼ˆå¦‚å‚æ•°æ ¡éªŒå¤±è´¥ï¼‰  \n```\n\n2. è°ƒè¯•åœºæ™¯ï¼šç²¾å‡†å®šä½é—®é¢˜\n   - å¿…å«ä¸‰è¦ç´ ï¼šé”™è¯¯ä¿¡æ¯ã€ç›¸å…³ä»£ç æ®µã€é¢„æœŸç»“æœã€‚\n```text\nè¿è¡Œä»¥ä¸‹Goä»£ç æ—¶å‡ºç°â€œpanic: runtime error: index out of range [3] with length 3â€ï¼š  \n[é™„ä»£ç ç‰‡æ®µ]  \né¢„æœŸç»“æœï¼šåº”æ­£ç¡®éå†åˆ‡ç‰‡å¹¶æ‰“å°æ¯ä¸ªå…ƒç´ ã€‚\n```\n\n3. æµ‹è¯•åœºæ™¯ï¼šJUnit/Mockitoå®æˆ˜\n   - ç¤ºä¾‹1ï¼šå•å…ƒæµ‹è¯•ç”Ÿæˆ\n```text\nä¸ºä»¥ä¸‹Serviceç±»æ–¹æ³•ç¼–å†™JUnit 5 + Mockitoæµ‹è¯•ï¼š  \npublic class UserService {  \n    @Autowired  \n    private UserRepository userRepository;  \n    public User getUserById(Long id) {  \n        return userRepository.findById(id).orElseThrow();  \n    }  \n}  \nè¦æ±‚è¦†ç›–ï¼š  \n- æ­£å¸¸æŸ¥è¯¢  \n- ç”¨æˆ·ä¸å­˜åœ¨æ—¶æŠ›å‡ºNoSuchElementException  \n- æ¨¡æ‹ŸuserRepositoryçš„findByIdè¡Œä¸º  \n```\n   - ç¤ºä¾‹2ï¼šæ€§èƒ½æµ‹è¯•è®¾è®¡\n```text\nå¦‚ä½•ç”¨JMHå¯¹ä»¥ä¸‹Javaæ–¹æ³•è¿›è¡ŒåŸºå‡†æµ‹è¯•ï¼Ÿ  \npublic String concatStrings(List<String> list) {  \n    return list.stream().collect(Collectors.joining());  \n}  \nè¦æ±‚æ¯”è¾ƒæ™®é€šå¾ªç¯ vs. Stream APIçš„æ€§èƒ½å·®å¼‚ã€‚  \n```\n# æ€»ç»“\nå„ç§Aiç¼–ç¨‹å·¥å…·çš„å‡ºç°èƒ½ç»™å¹¿å¤§ç å‹é‡Šæ”¾åŒæ‰‹ï¼Œç•™æœ‰æ›´å¤šçš„æ—¶é—´å­¦ä¹ æŠ€æœ¯ï¼Œå…³æ³¨æŠ€æœ¯æœ¬èº«ã€‚ç¼–å†™é«˜è´¨é‡çš„æç¤ºè¯æ˜¯æœ‰æ•ˆåˆ©ç”¨AIè¾…åŠ©ç¼–ç¨‹å·¥å…·çš„å…³é”®ã€‚é€šè¿‡æ˜ç¡®è§’è‰²ã€æ¸…æ™°æè¿°ä»»åŠ¡ã€æä¾›ä¸Šä¸‹æ–‡ä¿¡æ¯ç­‰æ–¹å¼ï¼Œç¨‹åºå‘˜å¯ä»¥å¼•å¯¼AIç”Ÿæˆæ›´å‡†ç¡®å’Œé«˜æ•ˆçš„ä»£ç ï¼Œä»è€Œæå‡æ•´ä½“å¼€å‘æ•ˆç‡ã€‚åœ¨å®é™…å·¥ä½œä¸­ï¼Œå»ºè®®å¤§å®¶å¤šåŠ ç»ƒä¹ å’Œæ€»ç»“ï¼Œä¸æ–­ä¼˜åŒ–æç¤ºè¯çš„ç¼–å†™æŠ€å·§ï¼Œä»¥é€‚åº”ä¸æ–­å˜åŒ–çš„æŠ€æœ¯ç¯å¢ƒã€‚\n\n","tags":["ç½‘æ˜“"]},{"title":"ç½‘æ˜“KMç¤¾åŒºåˆ†äº«-ièŒ…å°çš„æ¶æ„ä»‹ç»","url":"/2025/02/15/ç½‘æ˜“KMç¤¾åŒºåˆ†äº«-ièŒ…å°çš„æ¶æ„ä»‹ç»/","content":"> ä»å†…éƒ¨è®ºå›é‡Œé¢å·å‡ºæ¥çš„ï¼Œçš„ç¡®æ˜¯é«˜å¹¶å‘çš„ä¸€ä¸ªå¥½æ€»ç»“ï¼ˆèƒ½å·çš„æœºä¼šä¸å¤šäº†~ï¼‰ã€‚\n# 1 èƒŒæ™¯\nèŒ…å°å†°æ·‡æ·‹çš„çƒ­åº¦å°šæœªè¤ªå»ï¼Œé…±é¦™å’–å•¡åˆå¼•çˆ†äº†ä¸€æ³¢æµé‡ï¼Œåœ¨æˆ‘ä»¬çš„å°è±¡ä¸­ï¼ŒèŒ…å°ä¼¼ä¹å°±æ˜¯çˆ†å“çš„ä»£åè¯ï¼Œè€Œå…³äºèŒ…å°çš„è¯é¢˜ä¹Ÿå¾ˆå®¹æ˜“å†²ä¸Šçƒ­æœã€‚å»å¹´ï¼ŒèŒ…å°æ¨å‡ºäº†å®˜æ–¹çš„æ•°å­—è¥é”€å¹³å°ã€ŒièŒ…å°ã€ï¼Œä¸ºæ¶ˆè´¹è€…æä¾›åœ¨çº¿é¢„çº¦ã€å”®å–èŒ…å°é…’çš„åŠŸèƒ½ï¼Œå…¶åœ¨äº’è”ç½‘ä¸Šçš„ç¬¬ä¸€æ¬¡å…¬å¼€äº®ç›¸åŒæ ·å¸å¼•äº†æå¤§çš„å…³æ³¨ï¼Œä¹Ÿç»™æˆ‘ä»¬å¸¦æ¥äº†å·¨å¤§çš„æµé‡æŒ‘æˆ˜ã€‚\n\næœ¬æ–‡å°†ç»“åˆã€ŒièŒ…å°ã€å•†åŸå®ç°é«˜æ€§èƒ½ä¸é«˜å¯ç”¨çš„å…·ä½“å®è·µï¼ŒèŠä¸€èŠå¸¸è§çš„æ€§èƒ½ä¼˜åŒ–æŠ€æœ¯ä»¥åŠé«˜å¯ç”¨ç³»ç»Ÿçš„è®¾è®¡æ–¹æ³•ï¼Œå¸Œæœ›èƒ½å¤Ÿå’Œå¤§å®¶çš„æ—¥å¸¸å·¥ä½œäº§ç”Ÿå…±é¸£ï¼Œå¸®åŠ©å¤§å®¶æ›´å¥½åœ°ç†è§£å¹¶åº”ç”¨è¿™äº›æŠ€æœ¯è§£å†³é—®é¢˜ã€‚\n\n## 1.1 ä¸šåŠ¡å¸¦æ¥çš„æŠ€æœ¯æŒ‘æˆ˜\nä¸ºäº†æ›´å¥½åœ°ç†è§£ã€ŒièŒ…å°ã€é¢ä¸´å“ªäº›æŠ€æœ¯æŒ‘æˆ˜æˆ‘ä»¬æœ‰å¿…è¦å…ˆäº†è§£ã€ŒièŒ…å°ã€è¦è§£å†³å“ªäº›ä¸šåŠ¡é—®é¢˜ã€‚\n\nç®€è€Œè¨€ä¹‹ï¼ŒèŒ…å°å¸Œæœ›é€šè¿‡ã€ŒièŒ…å°ã€åŠ å¼ºæ•°å­—åŒ–æŠ€æœ¯åœ¨ç”Ÿäº§é”€å”®è¿‡ç¨‹ä¸­çš„åº”ç”¨ï¼Œè§„èŒƒèŒ…å°é…’çš„è¥é”€ç§©åºï¼Œè§£å†³æ¶ˆè´¹è€…è´­é…’éš¾ã€è´­é…’è´µé—®é¢˜ï¼Œæå‡æ¶ˆè´¹è€…çš„è´­é…’ä½“éªŒã€‚å› æ­¤ï¼Œã€ŒièŒ…å°ã€å•†åŸå°†è¢«æ‰“é€ ä¸ºèŒ…å°é…’çº¿ä¸Šé”€å”®çš„ä¸»è¦å…¥å£ï¼Œä¸ºæ¶ˆè´¹è€…æä¾›ä¸¤ç§è´­ä¹°æ–¹å¼ï¼š\n\n1. äº«çº¦ç”³è´­ï¼šé€šè¿‡æ¯å¤©å®šæ—¶å¼€æ”¾é¢„çº¦ç”³è´­çš„æ–¹å¼ï¼Œé‡‡ç”¨å…¬è¯æ‘‡å·çš„æ–¹å¼ä¸ºèŒ…ç²‰ä»¬æä¾›äº†å…¬å¹³çš„è·å–å¹³ä»·èŒ…å°çš„æœºä¼šï¼Œæ˜¯ç›®å‰çˆ†æ¬¾èŒ…å°é…’æŠ•æ”¾çš„æœ€ä¸»è¦çš„æ–¹å¼ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºç”³è´­åœºæ™¯\n2. ç•…äº«äº‘è´­ï¼šé‡‡ç”¨B2Cçš„åœ¨çº¿é”€å”®æ¨¡å¼ï¼Œç›®å‰ä¸»è¦ç”¨äºç³»åˆ—é…’çš„å”®å–ï¼Œä½†åŒæ—¶ä¹Ÿä¼šç”¨äºå°é£å¤©ï¼ˆ100mlé£å¤©èŒ…å°ï¼‰ç­‰çˆ†æ¬¾å•†å“ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºçˆ†æ¬¾æŠ¢è´­åœºæ™¯\n\n## 1.2 ç”³è´­åœºæ™¯\nç”³è´­åœºæ™¯åœ¨ä¸šåŠ¡æµç¨‹ä¸Šä¸»è¦åˆ†ä¸ºäº”ä¸ªé˜¶æ®µï¼ˆå¦‚ä¸‹å›¾æ‰€ç¤ºï¼‰ï¼š\n\n<div style=\"text-align: center;\">\n  <img src=\"../img/netease/5c9d8e8cd155e70d6184eabe1ca01ba.png\" alt=\"ç”³è´­åœºæ™¯\">\n</div>\n\n<div style=\"text-align: center;\">\n  <img src=\"../img/netease/38708c9eea135a6a4668bb39c5cd9b8.png\" alt=\"ç”³è´­åœºæ™¯\">\n</div>\n\n1. æ³¨å†Œ/ç™»é™†/å®åï¼šç”±äºé…’ç±»é”€å”®æœ‰å¹´é¾„é™åˆ¶åŒæ—¶æè´§éœ€è¦éªŒè¯èº«ä»½è¯ï¼Œå› æ­¤æ¶ˆè´¹è€…éœ€è¦åœ¨è´­é…’å‰æä¾›å§“åã€æ‰‹æœºã€èº«ä»½è¯è¿›è¡Œä¸‰è¦ç´ å®åè®¤è¯ï¼Œè¿™äº›ç¯èŠ‚åœ¨æ“ä½œä¸Šæ— æ—¶é—´é™åˆ¶ï¼Œä½†çŸ­ä¿¡ã€å®åç­‰ä¾èµ–ç¬¬ä¸‰æ–¹æœåŠ¡\n2. é¢„çº¦ç”³è´­ï¼šæ™®é€šç”³è´­åœºæ¬¡æ˜¯æ¯å¤©ä¸Šåˆ9ç‚¹åˆ°10ç‚¹ï¼Œåœ¨22å¹´3æœˆ31æ—¥è¯•è¿è¥ç¬¬ä¸€å¤©å°±å‘æ¶ˆè´¹è€…å¼€æ”¾äº†ï¼ŒæŒ‰ä¸šåŠ¡ä¼°ç®—ï¼Œæ¯åœºé¢„è®¡æœ‰æ•°åƒå®¶é—¨åº—å‚ä¸åº“å­˜æŠ•æ”¾ï¼Œæ•°ç™¾ä¸‡ç”¨æˆ·å‚ä¸ç”³è´­\n3. æŠ½ç­¾/å…¬è¯ï¼šç”³è´­ç»“æŸåä¼šé€šè¿‡å…¬è¯å¤„å¯ä¿¡æŠ½ç­¾çš„æ–¹å¼ç¡®å®šä¸­ç­¾çš„ç”¨æˆ·å¹¶è¿›è¡Œå…¬ç¤ºï¼Œé¢„è®¡æœ‰æ•°ä¸‡ç”¨æˆ·ä¸­ç­¾\n4. äº¤æ˜“ï¼šä¸­ç­¾ç”¨æˆ·éœ€è¦åœ¨æ¬¡æ—¥18ç‚¹å‰å®Œæˆä¸‹å•ï¼Œå¦‚é€‰æ‹©åœ¨çº¿æ”¯ä»˜ï¼Œéœ€åœ¨æŒ‡å®šæœŸé™å†…å®Œæˆä»˜æ¬¾\n5. æè´§ï¼šå…¬ç¤ºå7å¤©å†…åˆ°é¢„çº¦é—¨åº—æè´§\n\n\nå•çº¯çœ‹ä¸šåŠ¡è§„åˆ™ï¼Œç”¨æˆ·åœ¨ä»»æ„æ—¶åˆ»å‘èµ·ç”³è´­æ“ä½œå…¶ä¸­ç­¾çš„æ¦‚ç‡éƒ½æ˜¯ä¸€æ ·çš„ï¼Œç„¶è€Œåœ¨åŠŸèƒ½ç¬¬ä¸€æ¬¡å¼€æ”¾æ—¶ï¼Œç”¨æˆ·åœ¨ä¸äº†è§£è§„åˆ™çš„å‰æä¸‹ï¼Œæ€»æ˜¯ä¼šæ›´å€¾å‘äºåœ¨ç¬¬ä¸€æ—¶é—´è¿›è¡Œæ“ä½œï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä½•å¼€æ”¾é¢„çº¦ç”³è´­çš„å‰10åˆ†é’Ÿå°±æœ‰80%çš„ç”¨æˆ·å®Œæˆäº†ç”³è´­ï¼Œæ ¹æ®æˆ‘ä»¬è®¾è®¡çš„æµé‡æ¨¡å‹ï¼Œç¬¬ä¸€æ¬¡å¼€æ”¾é¢„çº¦ç”³è´­ï¼Œå‰5åˆ†é’Ÿé¢„è®¡æœ€é«˜ä¼šè¾¾åˆ°ç™¾ä¸‡çº§QPSï¼Œåœ¨çº¿è®¾å¤‡ä¹Ÿå¯èƒ½è¾¾åˆ°ç™¾ä¸‡çº§ï¼Œéœ€è¦é‡ç‚¹ä¿éšœã€‚\n\nå› æ­¤ï¼Œç”³è´­åœºæ™¯æˆ‘ä»¬ä¸»è¦ä¼šé¢ä¸´ä»¥ä¸‹ä¸‰ä¸ªæŠ€æœ¯æŒ‘æˆ˜ï¼š\n\n1. é«˜å¹¶å‘ï¼šå¤§é‡ç”¨æˆ·åœ¨çŸ­æ—¶é—´å†…é›†ä¸­è®¿é—®APPä¹Ÿå°±æ„å‘³ç€çŸ­æ—¶é—´å†…ä¼šæœ‰å¤§é‡çš„è®¾å¤‡ä¸æœåŠ¡å™¨æ–°å»ºè¿æ¥ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œä¸€ä¸ªè®¾å¤‡ä¸æœåŠ¡å™¨å»ºç«‹çš„è¿æ¥ä¸æ­¢ä¸€ä¸ªï¼Œè¿™å°±è¦æ±‚æœåŠ¡å™¨å…·å¤‡åŒæ—¶å¤„ç†æ•°ç™¾ä¸‡çº§åˆ«ï¼ˆæ¥è¿‘åƒä¸‡ï¼‰çš„å¹¶å‘è¿æ¥æ•°åŠç™¾ä¸‡çº§åˆ«æ–°å»ºè¿æ¥èƒ½åŠ›ï¼ˆä¹Ÿå°±æ˜¯é€šå¸¸æ‰€è¯´çš„C10Mé—®é¢˜ï¼‰ï¼ŒåŒæ—¶ä¹Ÿè¦æ±‚æœåŠ¡ç«¯åœ¨é«˜å¹¶å‘çš„æ¡ä»¶ä¸‹å…·å¤‡ç™¾ä¸‡QPSçº§åˆ«çš„ååé‡åŠè¾ƒå¿«çš„å“åº”é€Ÿåº¦\n2. é«˜å¯ç”¨ï¼šç”³è´­åœºæ™¯çš„æ ¸å¿ƒé“¾è·¯è¾ƒé•¿ï¼ŒåŒ…æ‹¬æ³¨å†Œã€ç™»å½•ã€å®åã€å®äººã€å®šä½ã€é—¨åº—é€‰æ‹©ã€ç”³è´­ç­‰å¤šä¸ªåŠŸèƒ½ï¼Œå…¶ä¸­ä»»ä½•ä¸€ä¸ªåŠŸèƒ½ä¸å¯ç”¨ï¼Œç”¨æˆ·å°±æ²¡æœ‰åŠæ³•å®Œæˆç”³è´­æ“ä½œï¼Œè¿™å¿…ç„¶ä¼šå¼•èµ·å®¢è¯‰ç”šè‡³èˆ†æƒ…ï¼Œæ˜¾ç„¶è¿™ä¸ªæ˜¯æ²¡æ³•æ¥å—çš„ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦ç¡®ä¿æ ¸å¿ƒé“¾è·¯ä¸Šé¢çš„è¿™äº›åŠŸèƒ½å…·å¤‡é«˜å¯ç”¨æ€§\n3. è¾ƒé«˜çš„ä¸šåŠ¡å¤æ‚åº¦ï¼šç”³è´­åœºæ™¯è™½ç„¶ä¸æ¶‰åŠåº“å­˜ç®¡ç†ï¼ˆå•†åŸéƒ¨åˆ†ï¼‰ï¼Œä½†å´éœ€è¦åº”å¯¹é—¨åº—æŠ•æ”¾çš„å„ç§çªå‘äº‹ä»¶ï¼Œç¡®ä¿å¯ç”³è´­é—¨åº—åŠå…¶æŠ•æ”¾çš„å•†å“å’Œæ•°é‡ä¸å•†åŸAPPå®é™…å±•ç¤ºä¿æŒä¸€è‡´ï¼ŒåŠæ—¶è¯†åˆ«ä¸ä¸€è‡´é£é™©ï¼ˆä¸ä¸€è‡´æœ‰å¯èƒ½é€ æˆæ— æ³•å±¥çº¦ï¼‰ï¼›å¦å¤–ï¼ŒAPPä¹Ÿéœ€è¦å®æ—¶å±•ç¤ºå„ä¸ªé—¨åº—å½“å‰çš„å·²ç”³è´­æ•°é‡ï¼Œå¹¶åŸºäºåŒºåŸŸã€è·ç¦»ã€ä¸­ç­¾æ¦‚ç‡ï¼ˆç»“åˆæŠ•æ”¾é‡å’Œå·²ç”³è´­æ•°é‡è®¡ç®—ï¼‰ç­‰å› ç´ å‘ç”¨æˆ·åŠ¨æ€æ¨èåˆé€‚çš„é—¨åº—\n\n## 1.3 çˆ†æ¬¾æŠ¢è´­åœºæ™¯\nçˆ†æ¬¾æŠ¢è´­åœºæ™¯åœ¨ä¸šåŠ¡æµç¨‹ä¸Šä¸»è¦åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼ˆå¦‚ä¸‹å›¾æ‰€ç¤ºï¼‰ï¼š\n\n<div style=\"text-align: center;\">\n  <img src=\"../img/netease/942876e1d0d57504b95d16ca0e5e28c.png\" alt=\"çˆ†æ¬¾æŠ¢è´­\">\n</div>\n\n1. æ³¨å†Œ/ç™»é™†/å®åï¼šåŒäº«çº¦ç”³è´­\n2. å¯¼è´­/è´­ç‰©è½¦ï¼šä¸ºç”¨æˆ·æä¾›åœ¨çº¿å•†å“æµè§ˆåŠŸèƒ½ï¼Œæ”¯æŒå°†å•†å“æ·»åŠ åˆ°è´­ç‰©è½¦ï¼Œè¯¥åŠŸèƒ½åœ¨å»å¹´5æœˆ19æ—¥æ­£å¼è¿è¥é˜¶æ®µå¼€æ”¾ï¼Œæœ‰æ•°åƒå®¶é—¨åº—å‚ä¸\n3. äº¤æ˜“å±¥çº¦ï¼šä¸ºç”¨æˆ·æä¾›ç»„å•/ä¸‹å•/åœ¨çº¿æ”¯ä»˜åŠŸèƒ½ï¼Œæ”¯æŒå¤šé—¨åº—åˆå¹¶ä»˜æ¬¾\n\nçˆ†æ¬¾æŠ¢è´­åœºæ™¯çš„æ ¸å¿ƒæŒ‘æˆ˜æ¥è‡ªäºå•†å“æœ¬èº«çš„ç¨€ç¼ºæ€§ï¼Œåªè¦æŠ•æ”¾å¿…ç„¶ä¼šå¼•å‘æŠ¢è´­ã€‚è¿™ç§æ¨¡å¼å·²ç»åœ¨åŒ…æ‹¬ä¸¥é€‰åœ¨å†…çš„å„å¤§ç”µå•†å¹³å°ä¸Šéƒ½å·²ç»è¢«éªŒè¯ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å‚è€ƒä¸¥é€‰çš„æµé‡æ¨¡å‹è¿›è¡Œé¢„ä¼°ï¼Œä»¥å½“æ—¶ã€ŒièŒ…å°ã€çš„ç”¨æˆ·é‡åŠç”¨æˆ·æ´»è·ƒåº¦ï¼Œé¢„è®¡ä¼šæœ‰æ•°åä¸‡çš„ç”¨æˆ·å‚ä¸æŠ¢è´­ï¼Œæˆ‘ä»¬ä¸»è¦ä¼šé¢ä¸´ä»¥ä¸‹ä¸‰ä¸ªæŠ€æœ¯æŒ‘æˆ˜ï¼š\n\n1. **æµé‡æ´ªå³°**ï¼šä»ä¸šåŠ¡å½¢æ€ä¸Šçœ‹ï¼Œæ•°åä¸‡ç”¨æˆ·åœ¨åŒä¸€æ—¶é—´æŠ¢è´­åŒä¸€æ¬¾å•†å“ä¸ç”µå•†çš„ç§’æ€æ´»åŠ¨æä¸ºç±»ä¼¼ï¼Œç„¶è€Œã€ŒièŒ…å°ã€åˆæœ‰å…¶éå¸¸æ˜æ˜¾çš„ä¸šåŠ¡ç‰¹æ€§ï¼Œå¯ä»¥è¯´ä¸æ˜¯ç§’æ€å´åˆèƒœä¼¼ç§’æ€\n2. **å³°å€¼æµé‡ä¿æŒæ—¶é—´é•¿**ï¼šä¸ºäº†è®©æ›´å¤šçš„ç”¨æˆ·æœ‰æœºä¼šæŠ¢è´­æˆåŠŸï¼ŒèŒ…å°ä¸ä»…å¢åŠ äº†æŠ•æ”¾é‡ï¼Œä¹ŸåŠ å¤§äº†æŠ•æ”¾çš„é¢‘ç‡ï¼ˆç°é˜¶æ®µæ˜¯æ¯10åˆ†é’ŸæŠ•æ”¾ä¸€æ¬¡ï¼‰ï¼Œè¿™å°±æ„å‘³ç€å³°å€¼æµé‡ä¼šä¿æŒæ›´é•¿çš„æ—¶é—´\n3. **å³°å€¼æµé‡å¤§**ï¼šæ—©æœŸä¸ºäº†å¢åŠ äº‘è´­åœºæ™¯çš„æ›å…‰ï¼Œä¸šåŠ¡è¦æ±‚å°é£å¤©ä¸ã€Œäº«çº¦ç”³è´­ã€æ”¾åœ¨åŒä¸€ä¸ªæ—¶é—´æ®µè¿›è¡ŒæŠ•æ”¾ï¼ˆå³ä¸Šåˆ9ç‚¹åˆ°10ç‚¹ï¼‰ï¼Œå½¢æˆäº†éå¸¸æ˜æ˜¾çš„æµé‡å åŠ æ•ˆåº”ï¼Œåæ¥è™½ç„¶æ”¾åœ¨äº†å¦å¤–ä¸€ä¸ªæ—¶æ®µï¼ˆæ™šä¸Š9ç‚¹åˆ°10ç‚¹ï¼‰ï¼Œä½†å‡ºäºå…¬å¹³æ€§ï¼Œåº“å­˜æŠ•æ”¾è®¡åˆ’ä¼šæå‰å‘ç”¨æˆ·é¢„å‘Šï¼Œçˆ†æ¬¾æŠ¢è´­çš„å³°å€¼åè€Œè¿˜æ›´å¤§äº†\n\nè¾ƒé«˜çš„ä¸šåŠ¡å¤æ‚åº¦ï¼šç›¸æ¯”äºä¼ ç»Ÿçš„ç”µå•†äº¤æ˜“é“¾è·¯ï¼Œçˆ†æ¬¾æŠ¢è´­åœºæ™¯ä¼šåœ¨ä¸€æ®µæ—¶é—´å†…ç”±æ•°åƒå®¶é—¨åº—ä»¥è¾ƒé«˜çš„é¢‘ç‡åŒæ­¥æŠ•æ”¾åº“å­˜ï¼ŒåŒæ—¶ï¼Œç³»ç»Ÿè¿˜éœ€è¦ç»“åˆåŒºåŸŸã€è·ç¦»ç­‰å› ç´ å®æ—¶å‘ç”¨æˆ·æ¨èè¿˜æœ‰åº“å­˜çš„é—¨åº—ï¼Œä¹Ÿè¦å…è®¸ç”¨æˆ·æ‰‹åŠ¨åˆ‡æ¢åˆ°æœ‰åº“å­˜çš„é—¨åº—ï¼Œè¿™äº›ç‰¹æ€§å¯¹äºé«˜å¹¶å‘åœºæ™¯ä¸‹æ•°æ®æŸ¥è¯¢å“åº”çš„å³æ—¶æ€§åŠæ•°æ®çš„ä¸€è‡´æ€§éƒ½æå‡ºäº†æ›´é«˜çš„è¦æ±‚ï¼Œä¹Ÿæ˜¯äº¤æ˜“é“¾è·¯åº”å¯¹æµé‡æ´ªå³°çš„é‡è¦å‰æ\n\næ•°æ®ä¸€è‡´æ€§ï¼šä¿è¯è®¢å•ã€åº“å­˜ã€èµ„äº§ã€æƒç›Šï¼ˆå¦‚é™è´­ï¼‰ç­‰æ•°æ®çš„ä¸€è‡´æ€§æ˜¯ç”µå•†äº¤æ˜“ç³»ç»Ÿçš„æ ¸å¿ƒä»»åŠ¡ä¹‹ä¸€ï¼Œåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹è§£å†³æ•°æ®ä¸€è‡´æ€§é—®é¢˜æå®¹æ˜“å¼•èµ·ç³»ç»Ÿæ€§èƒ½ç“¶é¢ˆï¼Œå¦‚ä½•åœ¨ç¡®ä¿æ•°æ®ä¸€è‡´æ€§çš„å‰æä¸‹å®ç°é«˜æ€§èƒ½æ˜¯ä¸€ä¸ªå·¨å¤§çš„æŒ‘æˆ˜\n\nåº“å­˜ç®¡ç†ï¼šçˆ†æ¬¾æŠ¢è´­åœºæ™¯éœ€è¦è§£å†³åº“å­˜ç®¡ç†é—®é¢˜ï¼Œç¡®ä¿å•†åŸçš„é”€å”®åº“å­˜å®æ—¶åæ˜ é—¨åº—æŠ•æ”¾è®¡åˆ’ï¼Œå¹¶èƒ½åŠæ—¶è¯†åˆ«æ½œåœ¨çš„ä¸ä¸€è‡´é£é™©ï¼Œç¡®ä¿åº“å­˜æ•°é‡ã€çŠ¶æ€ã€å˜æ›´è®°å½•å‡†ç¡®åæ˜ å®é™…æƒ…å†µï¼Œä¿æŒåº“å­˜æ•°æ®çš„å‡†ç¡®æ€§ã€‚åº“å­˜ç®¡ç†å¯ä»¥è®¤ä¸ºæ˜¯ç”µå•†æœ€å¤æ‚çš„ç³»ç»Ÿä¹‹ä¸€ï¼Œå°¤å…¶åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œåº“å­˜ç®¡ç†å¾ˆå®¹æ˜“å˜æˆåœ¨çº¿äº¤æ˜“ç³»ç»Ÿçš„å™©æ¢¦ï¼Œç¨æœ‰ä¸æ…ï¼Œå°±ä¼šå¼•èµ·å°‘å–ã€è¶…å–ç­‰é—®é¢˜ï¼Œä¹Ÿå¾ˆå®¹æ˜“æˆä¸ºäº¤æ˜“é“¾è·¯çš„æ€§èƒ½ç“¶é¢ˆ\n\n## 1.4 å°ç»“\nç»¼ä¸Šåˆ†æå¯ä»¥å‘ç°ï¼Œæ— è®ºæ˜¯ç”³è´­åœºæ™¯è¿˜æ˜¯çˆ†æ¬¾æŠ¢è´­åœºæ™¯ï¼Œæˆ‘ä»¬éƒ½éœ€è¦åœ¨ç¡®ä¿æ•°æ®ä¸€è‡´æ€§çš„å‰æä¸‹ï¼Œå®ç°ç³»ç»Ÿçš„é«˜æ€§èƒ½ä¸é«˜å¯ç”¨æ€§ï¼Œè€Œè¿½æ±‚é«˜æ€§èƒ½å’Œé«˜å¯ç”¨æ€§çš„ç›®çš„éƒ½æ˜¯ä¸ºäº†æä¾›æ›´å¥½çš„ç”¨æˆ·ä½“éªŒã€ä¿éšœç³»ç»Ÿçš„å¯é æ€§ä¸ç¨³å®šæ€§ã€‚\n\n# 2 å¦‚ä½•è¿›è¡Œæ€§èƒ½ä¼˜åŒ–\næ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸‹å¦‚ä½•é€šè¿‡æ€§èƒ½ä¼˜åŒ–å®ç°ç³»ç»Ÿçš„é«˜æ€§èƒ½\n\n## 2.1 æ€§èƒ½åº¦é‡æ–¹æ³•åŠè¯Šæ–­å·¥å…·\nè¦åšæ€§èƒ½ä¼˜åŒ–ï¼Œç¬¬ä¸€æ­¥éœ€è¦æ˜ç¡®æ€§èƒ½åº¦é‡æŒ‡æ ‡åŠåº¦é‡æ–¹æ³•ï¼Œå¹¶å€ŸåŠ©è¯Šæ–­å·¥å…·æ‰¾åˆ°æ€§èƒ½ç“¶é¢ˆã€‚\n\nå¸¸ç”¨çš„æ€§èƒ½åº¦é‡æ–¹æ³•åŠæŒ‡æ ‡ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å‡ ç§ï¼š\n\n- **å“åº”æ—¶é—´**ï¼ˆResponse Timeï¼‰ï¼šå“åº”æ—¶é—´æ˜¯æŒ‡ä»å‘å‡ºè¯·æ±‚åˆ°æ”¶åˆ°å“åº”çš„æ€»æ—¶é—´ï¼ŒåŒ…æ‹¬å¤„ç†è¯·æ±‚çš„æ—¶é—´ä»¥åŠç½‘ç»œä¼ è¾“çš„æ—¶é—´ï¼Œé€šå¸¸ä»¥æ¯«ç§’ï¼ˆmsï¼‰ä¸ºå•ä½ã€‚å“åº”æ—¶é—´æ˜¯ç”¨æˆ·æˆ–å®¢æˆ·ç«¯æ„ŸçŸ¥åˆ°çš„æ—¶é—´ï¼Œåæ˜ äº†ç³»ç»Ÿå¯¹è¯·æ±‚çš„å“åº”é€Ÿåº¦ï¼Œè¾ƒä½çš„å“åº”æ—¶é—´é€šå¸¸è¡¨ç¤ºæ›´å¥½çš„ç³»ç»Ÿæ€§èƒ½ã€‚\n- **å»¶è¿Ÿ**ï¼ˆLatencyï¼‰ï¼šå»¶è¿Ÿæ˜¯æŒ‡åœ¨æ‰§è¡ŒæŸé¡¹æ“ä½œæˆ–ä¼ è¾“æ•°æ®æ—¶ç»è¿‡çš„æ—¶é—´ï¼Œå¯ä»¥åˆ†ä¸ºå¤šä¸ªç»„æˆéƒ¨åˆ†ï¼ŒåŒ…æ‹¬å¤„ç†å»¶è¿Ÿï¼ˆå¤„ç†è¯·æ±‚æ‰€éœ€çš„æ—¶é—´ï¼‰ã€ä¼ è¾“å»¶è¿Ÿï¼ˆæ•°æ®åœ¨ç½‘ç»œä¸­ä¼ è¾“æ‰€éœ€çš„æ—¶é—´ï¼‰å’Œæ’é˜Ÿå»¶è¿Ÿï¼ˆç­‰å¾…å¤„ç†çš„è¯·æ±‚åœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…çš„æ—¶é—´ï¼‰ã€‚åœ¨è¿›è¡Œæ€§èƒ½ä¼˜åŒ–æ—¶ï¼Œæˆ‘ä»¬é€šå¸¸å¯ä»¥é€šè¿‡å‡å°‘å»¶è¿Ÿæ¥ç¼©çŸ­å“åº”æ—¶é—´ã€‚\n- **ååé‡**ï¼ˆThroughputï¼‰ï¼šååé‡æ˜¯ç³»ç»Ÿåœ¨å•ä½æ—¶é—´å†…å¤„ç†çš„è¯·æ±‚æˆ–äº‹åŠ¡æ•°é‡ï¼Œé€šå¸¸ä»¥æ¯ç§’å¤„ç†çš„è¯·æ±‚æ•°ï¼ˆå¦‚TPSï¼‰æ¥è¡¡é‡ã€‚\n- **å¹¶å‘æ€§**ï¼ˆConcurrencyï¼‰ï¼šå¹¶å‘æ€§æ˜¯æŒ‡ç³»ç»Ÿèƒ½å¤Ÿåœ¨åŒä¸€æ—¶é—´æ®µå†…åŒæ—¶å¤„ç†çš„è¯·æ±‚æˆ–ä»»åŠ¡æ•°é‡ï¼Œå®ƒå¯ä»¥å¸®åŠ©ç¡®å®šç³»ç»Ÿåœ¨é«˜è´Ÿè½½æ—¶çš„æ€§èƒ½ã€‚\n- **èµ„æºåˆ©ç”¨ç‡**ï¼ˆResource Utilizationï¼‰ï¼šèµ„æºåˆ©ç”¨ç‡åº¦é‡äº†ç³»ç»Ÿèµ„æºï¼ˆå¦‚CPUã€å†…å­˜ã€ç£ç›˜å’Œç½‘ç»œå¸¦å®½ï¼‰çš„ä½¿ç”¨æƒ…å†µï¼Œè¿‡é«˜å¯èƒ½è¡¨æ˜å­˜åœ¨æ€§èƒ½é—®é¢˜ã€‚\n- **é”™è¯¯ç‡**ï¼ˆError Rateï¼‰ï¼šé”™è¯¯ç‡åº¦é‡äº†ç³»ç»Ÿå¤„ç†ä¸­å‘ç”Ÿçš„é”™è¯¯æ•°é‡æˆ–ç™¾åˆ†æ¯”ï¼Œæ˜¯æ€§èƒ½åº¦é‡çš„ä¸€ä¸ªå…³é”®æŒ‡æ ‡ï¼Œæ›´å¤§çš„ç³»ç»Ÿè´Ÿè½½å¾€å¾€ä¼šé€ æˆæ›´é«˜çš„é”™è¯¯ç‡ï¼Œåœ¨å®šä¹‰SLOæ—¶ï¼Œå½“é”™è¯¯ç‡è¶…è¿‡ä¸€å®šé˜ˆå€¼æˆ‘ä»¬å¾€å¾€ä¹Ÿä¼šå®šä¹‰ä¸ºä¸€ç§å®•æœºçš„è¡¨ç°ã€‚\n- **ç³»ç»Ÿè´Ÿè½½**ï¼ˆLoadï¼‰ï¼šç³»ç»Ÿè´Ÿè½½è¡¨ç¤ºç³»ç»Ÿæ­£åœ¨å¤„ç†çš„å·¥ä½œé‡ï¼Œå¯ä»¥ç”¨æ¥ç›‘æµ‹ç³»ç»Ÿçš„è´Ÿè·ï¼Œä»¥ç¡®å®šæ˜¯å¦éœ€è¦è¿›è¡Œæ€§èƒ½ä¼˜åŒ–\n- **å»¶è¿Ÿåˆ†å¸ƒ**ï¼ˆLatency Distributionï¼‰ï¼šå»¶è¿Ÿåˆ†å¸ƒæè¿°äº†ä¸åŒè¯·æ±‚æˆ–æ“ä½œçš„å»¶è¿Ÿæƒ…å†µï¼Œå®ƒå¯ä»¥å¸®åŠ©æˆ‘ä»¬ç¡®å®šç³»ç»Ÿæ€§èƒ½æ˜¯å¦ç¨³å®šï¼Œæˆ–è€…æ˜¯å¦å­˜åœ¨å¼‚å¸¸å»¶è¿Ÿã€‚\n- **æ€§èƒ½è¶‹åŠ¿**ï¼ˆPerformance Trendsï¼‰ï¼šæ€§èƒ½è¶‹åŠ¿åˆ†ææ¶‰åŠè®°å½•æ€§èƒ½æŒ‡æ ‡éšæ—¶é—´çš„å˜åŒ–ï¼Œä½¿ç”¨è¿™äº›æ•°æ®æ¥é¢„æµ‹æ€§èƒ½é—®é¢˜æˆ–æ‰¾åˆ°å¾…ä¼˜åŒ–ç‚¹ã€‚\n\n\n\né’ˆå¯¹æ€§èƒ½æŒ‡æ ‡çš„åº¦é‡é€šå¸¸éœ€è¦é€šè¿‡æ€§èƒ½ç›‘æ§å·¥å…·å’Œæ—¥å¿—åˆ†æå·¥å…·æ¥å®Œæˆï¼Œã€ŒièŒ…å°ã€é‡‡ç”¨äº†ä¸ä¸¥é€‰ç›¸åŒçš„é€‰å‹ï¼š\n\n- **å…¨é“¾è·¯åº”ç”¨æ€§èƒ½ç›‘æ§ç³»ç»Ÿï¼ˆAPMï¼‰**ï¼šåŸºäºPinpointæ„å»ºä»ç½‘å…³åˆ°åº”ç”¨èŠ‚ç‚¹çš„åº”ç”¨ç›‘æ§ä½“ç³»ï¼Œæ”¯æŒå¤§æµé‡ç§’çº§ç›‘æ§ã€åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªã€å¼‚å¸¸åˆ†æç­‰èƒ½åŠ›\n- **æ€§èƒ½ç›‘æ§å·¥å…·**ï¼šç”¨äºå®æ—¶ç›‘æ§ç³»ç»Ÿæ€§èƒ½ï¼Œå¦‚å„ç±»é‡‡é›†å™¨ï¼ˆæœåŠ¡å™¨ã€æ•°æ®åº“ç­‰ï¼‰ã€Prometheusã€Grafanaç­‰\n- **æ—¥å¿—å¹³å°**ï¼šä½¿ç”¨ä¸¥é€‰è‡ªç ”çš„æ—¥å¿—å¹³å°ï¼Œæä¾›ä¸€ç«™å¼æµ·é‡æ—¥å¿—é‡‡é›†ã€åŠ å·¥ã€åˆ†æµã€åˆ†æã€æ£€ç´¢ã€å‘Šè­¦ç­‰èƒ½åŠ›ï¼Œä¸ºåº”ç”¨æ—¥å¿—åˆ†æã€ä¸šåŠ¡å¤§ç›˜ç­‰æä¾›æ•°æ®æºå’Œåˆ†æèƒ½åŠ›æ”¯æ’‘ï¼Œæ›´å¤šä»‹ç»å¯ä»¥å‚è§ç½‘æ˜“ä¸¥é€‰å¦‚ä½•å»ºè®¾æ—¥å¿—å¹³å°\n- **ä¸šåŠ¡å®æ—¶ç›‘æ§ç³»ç»Ÿ**ï¼šåŸºäºGrafanaæä¾›æµ·é‡æ•°æ®ç§’çº§å“åº”çš„å®æ—¶ç›‘æ§èƒ½åŠ›ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡å¹³å°å¿«é€Ÿå®Œæˆæ•°æ®æºæ¥å…¥ã€æ•°æ®æ¨¡å‹æ„å»ºã€ç›‘æ§å¤§ç›˜å®šåˆ¶å’ŒæŠ¥è­¦é…ç½®\n\n## 2.2 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥\nè¯†åˆ«åˆ°æ€§èƒ½ç“¶é¢ˆä¹‹åï¼Œæˆ‘ä»¬éœ€è¦ç¡®å®šæ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆï¼Œè¿™é‡Œä»‹ç»å‡ ç§å¸¸ç”¨çš„æ€§èƒ½ä¼˜åŒ–ç­–ç•¥\n\n## 2.2.1 ä»£ç ä¼˜åŒ–\nç»å¤§éƒ¨åˆ†æ—¶å€™ï¼Œä»£ç ä¼˜åŒ–æ˜¯æé«˜åº”ç”¨ç¨‹åºæ€§èƒ½çš„å…³é”®åŠ¨ä½œï¼Œå¸¸ç”¨çš„ç­–ç•¥åŒ…æ‹¬ï¼š\n\n- **ä»£ç é‡æ„**ï¼šé‡å†™æˆ–é‡æ–°ç»„ç»‡ä»£ç ä»¥æå‡å¯è¯»æ€§å’Œæ‰§è¡Œæ•ˆç‡ï¼Œæ¯”å¦‚ä½¿ç”¨æ›´é«˜æ•ˆçš„æ•°æ®ç»“æ„å’Œç®—æ³•ã€å‡å°‘å¾ªç¯ä¸­çš„è®¡ç®—æˆ–å‡å°‘å¾ªç¯è¿­ä»£æ¬¡æ•°ã€é¿å…åœ¨å¾ªç¯å†…éƒ¨æ‰§è¡Œæ˜‚è´µçš„æ“ä½œã€å¼•å…¥å¹¶å‘ç¼–ç¨‹ã€ä¼˜åŒ–äº‹åŠ¡ç­‰ç­‰ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé‡æ„ä¸ä¸€å®šèƒ½ä½¿ç¨‹åºçš„æ‰§è¡Œæ•ˆç‡å˜å¾—æ›´é«˜ï¼Œä»¥æ€§èƒ½ä¼˜åŒ–ä¸ºç›®çš„çš„ä»£ç é‡æ„å¾€å¾€ä¹Ÿéœ€è¦ä¸ä»£ç çš„å¯ç»´æŠ¤æ€§ä¹‹é—´è¿›è¡Œæƒè¡¡\n- **å‡å°‘æ•°æ®åº“è®¿é—®**ï¼šå¯ä»¥é€šè¿‡åˆå¹¶æŸ¥è¯¢ã€ä½¿ç”¨ç¼“å­˜ã€å¢åŠ å‰ç½®æ¡ä»¶åˆ¤æ–­æˆ–æ‰¹é‡æ“ä½œç­‰æ–¹å¼æ¥å‡å°‘æ•°æ®åº“è®¿é—®\n- **å‡å°‘æ‰‡å‡ºæ¯”**ï¼šæ§åˆ¶æ‰‡å‡ºæ¯”çš„ç›®çš„æ˜¯é™åˆ¶ç³»ç»Ÿå‘å…¶ä»–æœåŠ¡æˆ–ç»„ä»¶å‘å‡ºçš„è¯·æ±‚æ•°é‡ï¼Œä»è€Œé™ä½è´Ÿè½½ï¼Œå‡å°‘æ‰‡å‡ºæ¯”çš„æœ¬è´¨æ˜¯å‡å°‘æœåŠ¡é—´çš„ä¾èµ–å…³ç³»åŠä¾èµ–åº¦ï¼Œé¿å…å¤§è§„æ¨¡çš„å¹¶å‘è¯·æ±‚å¯¼è‡´æ€§èƒ½ä¸‹é™ï¼Œä¹Ÿå¯ä»¥é™ä½æ•…éšœä¼ æ’­çš„é£é™©ã€‚æ‰‡å‡ºæ¯”å¯ç”¨äºåº¦é‡ç³»ç»Ÿå‘å…¶ä»–æœåŠ¡æˆ–ç»„ä»¶å‘é€çš„è¯·æ±‚æ•°é‡ï¼Œä¸€èˆ¬æˆ‘ä»¬è¿˜å¯ä»¥è¿›ä¸€æ­¥ç»†åŒ–ä¸ºå•æ¬¡è¯·æ±‚ä¸­å¯¹æŒ‡å®šæœåŠ¡ã€ç¼“å­˜çš„æ‰‡å‡ºæ¯”ï¼Œæ¯”å¦‚ä¸‹å•è¯·æ±‚å¦‚æœä¼šæŸ¥è¯¢ä¸¤æ¬¡å•†å“ä¸­å¿ƒçš„æ¥å£ï¼Œé‚£ä¸‹å•è¯·æ±‚å¯¹å•†å“ä¸­å¿ƒçš„æ‰‡å‡ºæ¯”å°±æ˜¯2ï¼Œå¾ˆæ˜¾ç„¶ï¼Œè¿™ä¸ªæ•°å€¼è¶Šå¤§ï¼Œè¯·æ±‚è¢«æ”¾å¤§çš„å€æ•°ä¹Ÿå°±è¶Šé«˜\n- **I/Oä¼˜åŒ–**ï¼šå¯ä»¥é€šè¿‡å°†å¤šæ¬¡I/Oæ“ä½œè¿›è¡Œåˆå¹¶æˆ–è€…ä½¿ç”¨å¼‚æ­¥I/Oæ¥å‡å°‘ç£ç›˜å’Œç½‘ç»œI/Oæ“ä½œï¼Œå¸¸è§çš„å¦‚å¼‚æ­¥æ‰“å°æ—¥å¿—ã€å°†å¤šæ¬¡æœåŠ¡è°ƒç”¨åˆå¹¶æˆä¸€æ¬¡è°ƒç”¨ç­‰ç­‰\n- **èµ„æºæ± åŒ–**ï¼šä½¿ç”¨èµ„æºæ± æ¥ç®¡ç†æ•°æ®åº“è¿æ¥ã€å¼‚æ­¥çº¿ç¨‹ç­‰èµ„æºï¼Œä»¥å‡å°‘èµ„æºåˆ›å»ºå’Œé”€æ¯å¸¦æ¥çš„å¼€é”€\n- **é¢„çƒ­**ï¼šé¢„çƒ­æ˜¯ä¸€ç§é€šè¿‡åœ¨åº”ç”¨ç¨‹åºæˆ–ç³»ç»Ÿå¼€å§‹å¤„ç†å®é™…å·¥ä½œè´Ÿè½½ä¹‹å‰æ‰§è¡Œä¸€ç³»åˆ—æ“ä½œæ¥æé«˜æ€§èƒ½çš„æ–¹æ³•ï¼Œè¿™äº›æ“ä½œæ—¨åœ¨å°†ç³»ç»Ÿçš„å„ç§ç»„ä»¶ï¼ˆå¦‚CPUã€å†…å­˜ã€ç¼“å­˜ç­‰ï¼‰ç½®äºä¸€ä¸ªç¨³å®šä¸”é«˜æ•ˆçš„çŠ¶æ€ï¼Œä»¥ä¾¿åœ¨å¤„ç†çœŸå®å·¥ä½œè´Ÿè½½æ—¶è·å¾—æ›´å¥½çš„æ€§èƒ½ï¼Œå¸¸è§çš„é¢„çƒ­æ“ä½œåŒ…æ‹¬ç¼“å­˜é¢„çƒ­ã€è¿æ¥æ± é¢„çƒ­ã€èµ„æºåŠ è½½é¢„çƒ­ã€æ•°æ®åŠ è½½é¢„çƒ­ç­‰\n\n\n\nè¿™é‡Œä»¥çˆ†æ¬¾æŠ¢è´­åœºæ™¯ä¸‹å•æ¥å£æ€§èƒ½ä¼˜åŒ–ä¸ºä¾‹ä»‹ç»ä¸‹ä¸Šè¿°ç­–ç•¥çš„å…·ä½“åº”ç”¨ï¼š\n\n- **å®šåˆ¶ç‹¬ç«‹ä¸‹å•é“¾è·¯**ï¼šçˆ†æ¬¾æŠ¢è´­åœºæ™¯æ˜¯ä¸€ç§ç‰¹æ®Šçš„äº‘è´­ä¸‹å•åœºæ™¯ï¼Œæœ‰æ›´å¤šçš„é™åˆ¶æ¡ä»¶ï¼ˆå¦‚ä¸èƒ½åŠ è´­ï¼‰ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è£å‰ªæ‰ä¸€äº›ä¸å¿…è¦çš„æµç¨‹æˆ–è€…ç‰ºç‰²éƒ¨åˆ†ä»£ç å¯è¯»æ€§ä»¥æ¢å–æ›´é«˜çš„æ€§èƒ½\n- **ä¸‹å•è¯·æ±‚å¹‚ç­‰æ€§æ§åˆ¶**ï¼šåœ¨çˆ†æ¬¾æŠ¢è´­åœºæ™¯ï¼Œç”±äºå¹¶å‘é‡æ˜¾è‘—å¢åŠ ï¼Œå“åº”æ—¶é—´ä¹Ÿä¼šæœ‰æ‰€å¢åŠ ï¼Œç”šè‡³ä¼šå‡ºç°å“åº”è¶…æ—¶çš„æƒ…å†µï¼Œå¾ˆå®¹æ˜“å¼•å‘ç”¨æˆ·è¿ç»­ç‚¹å‡»ï¼Œé€šè¿‡å¼•å…¥å¹‚ç­‰æ€§æ§åˆ¶ï¼Œä¸ä»…å¯ä»¥é™ä½èµ„æºå ç”¨æ—¶é—´ï¼Œä¹Ÿå¯ä»¥å‡å°‘ä¸å¿…è¦çš„åº“å­˜é”å®šã€æ‰©å¤§é”€å”®æœºä¼š\n- **æ§åˆ¶äº‹åŠ¡çš„ç²’åº¦**ï¼šé€šè¿‡ç¼–ç¨‹å¼äº‹åŠ¡ï¼ˆTransactionTemplateï¼‰æ›¿ä»£å£°æ˜å¼äº‹åŠ¡ï¼ˆ@Transactionalï¼‰ï¼Œå¯ä»¥æ›´çµæ´»åœ°æ§åˆ¶äº‹åŠ¡çš„èŒƒå›´ï¼Œåœ¨äº‹åŠ¡ä¸­åªä¿ç•™å¿…è¦çš„æ“ä½œï¼Œé¿å…å¤§äº‹åŠ¡ï¼Œè¿™å°†æ˜¾è‘—å‡å°‘äº‹åŠ¡çš„é”å®šæ—¶é—´å’Œèµ„æºå ç”¨ï¼Œå¸¦æ¥æ€§èƒ½æå‡\n- **ä¼˜åŒ–åˆ†å¸ƒå¼äº‹åŠ¡**ï¼šä¸ºäº†ä¿è¯ä¸‹å•é˜¶æ®µè®¢å•ã€åº“å­˜ã€èµ„äº§ã€æƒç›Šï¼ˆå¦‚é™è´­ï¼‰ç­‰æ•°æ®çš„ä¸€è‡´æ€§ï¼Œæˆ‘ä»¬å¼•å…¥äº†TCCï¼ˆTry-Confirm/Cancelï¼‰æ¨¡å¼çš„åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œä½†åˆ†å¸ƒå¼äº‹åŠ¡å¾ˆå®¹æ˜“å¯¹æ€§èƒ½äº§ç”Ÿè´Ÿé¢å½±å“ï¼Œéœ€è¦è¿›è¡Œè°ƒä¼˜ï¼ˆå¦‚ä¸‹å›¾æ‰€ç¤ºï¼‰ï¼š\n\n<div style=\"text-align: center;\">\n  <img src=\"../img/netease/359d21b4df4839e2458c4db4b2546c0.png\" alt=\"åˆ†å¸ƒå¼äº‹åŠ¡\">\n</div>\n\n- **å¹‚ç­‰æ€§æ§åˆ¶**ï¼šä¸»äº‹åŠ¡åœ¨è°ƒç”¨TCCæ–¹æ³•æ—¶å¯èƒ½å› ç½‘ç»œæ‹¥å µç­‰åŸå› è¶…æ—¶ï¼Œé€šå¸¸æˆ‘ä»¬ä¼šé€šè¿‡å¼•å…¥è¶…æ—¶ä¸é‡è¯•ç­–ç•¥æ¥æå‡æˆåŠŸç‡ï¼Œè¿™å°±è¦æ±‚åˆ†æ”¯äº‹åŠ¡éœ€è¦ä¿è¯TCCæ–¹æ³•çš„å¹‚ç­‰æ€§ï¼Œé¿å…é‡å¤æ›´æ–°ã€‚å¦å¤–éœ€è¦ç‰¹åˆ«é‡è§†ä¼˜åŒ–TCCæ–¹æ³•çš„æ‰§è¡Œæ€§èƒ½ï¼Œç¡®ä¿åœ¨é¢„è®¾çš„å‹åŠ›ä¸‹ï¼Œæœ‰è¶³å¤Ÿå¤§æ¯”ä¾‹çš„è¯·æ±‚RTä½äºè¶…æ—¶æ—¶é—´\n- **å…è®¸ç©ºå›æ»š**ï¼šåœ¨å®é™…çš„ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå¯èƒ½å› ç½‘ç»œæ‹¥å µç­‰åŸå› é€ æˆCancelæ“ä½œå…ˆäºTryæ“ä½œåˆ°è¾¾ï¼Œå› æ­¤ï¼Œå…è®¸åˆ†æ”¯äº‹åŠ¡ç©ºå›æ»šå¯ä»¥é¿å…é‡è¯•ï¼Œä»è€Œå¸¦æ¥æ›´å¥½çš„æ€§èƒ½è¡¨ç°ï¼Œå³å…è®¸Cancelæ“ä½œåœ¨æ‰¾ä¸åˆ°å¾…å›æ»šçš„ä¸šåŠ¡ä¸»é”®çš„æƒ…å†µä¸‹ä¹Ÿè¿”å›æˆåŠŸå¹¶å°†è¯¥ä¸šåŠ¡ä¸»é”®è®°å½•ä¸‹æ¥ï¼ŒåŒæ—¶ä¹Ÿè¦ç¡®ä¿ç©ºå›æ»šä¸ä¼šäº§ç”Ÿå…¶ä»–é”™è¯¯æ•ˆæœ\n- **é˜²æ‚¬æŒ‚**ï¼šå¦‚æœCancelæ“ä½œå…ˆäºTryæ“ä½œåˆ°è¾¾ä¸”Cancelæ“ä½œè¿”å›æˆåŠŸçš„æƒ…å†µä¸‹ï¼ˆå³å…è®¸ç©ºå›æ»šï¼‰ï¼Œåœ¨æ‰§è¡ŒTryæ“ä½œæ—¶ï¼Œæœ‰å¿…è¦æ£€æŸ¥ç©ºå›æ»šè®°å½•ä¸­æ˜¯å¦å­˜åœ¨è¯¥ä¸šåŠ¡ä¸»é”®ï¼Œå­˜åœ¨åˆ™ç›´æ¥æ‹’ç»æ‰§è¡Œï¼Œå¦åˆ™ï¼ˆæ²¡æœ‰æ‹’ç»æ‰§è¡Œçš„è¯ï¼‰ä¼šé€ æˆè¯¥åˆ†æ”¯äº‹åŠ¡æ‚¬æŒ‚\n- **å‡å°‘æ— æ•ˆå›æ»š**ï¼šTryæ“ä½œå¯èƒ½é‡åˆ°é™æµã€æ ¡éªŒä¸é€šè¿‡ç­‰æƒ…å†µé€ æˆç›´æ¥è¿”å›ï¼Œæ²¡æœ‰æ‰§è¡Œå®é™…çš„ä¸šåŠ¡æ“ä½œï¼Œåœ¨è¿™ç±»åœºæ™¯ï¼Œå¯ä»¥åœ¨å›æ»šé˜¶æ®µä¸è°ƒç”¨åˆ†æ”¯äº‹åŠ¡çš„Cancelæ“ä½œï¼Œä»è€Œå¸¦æ¥æ›´å¥½çš„æ€§èƒ½è¡¨ç°\n\n\n\n\n\né™è´­ä¼˜åŒ–ï¼šä¸ºäº†å¢åŠ å…¬å¹³æ€§ï¼Œçˆ†æ¬¾å•†å“ä¸€èˆ¬ä¼šè¿›è¡Œé™è´­ï¼Œå³é™åˆ¶åŒä¸€ä¸ªç”¨æˆ·åœ¨æŸä¸ªç‰¹å®šå‘¨æœŸå†…æˆ–è€…æŸä¸ªç‰¹å®šæ´»åŠ¨ä¸­è´­ä¹°åŒä¸€ä¸ªå•†å“çš„æ•°é‡ä¸Šé™ï¼Œé€šå¸¸æˆ‘ä»¬éœ€è¦å€ŸåŠ©åŠ é”ç­‰å¹¶å‘æ§åˆ¶æ‰‹æ®µæ¥ç¡®ä¿é™è´­æ•°æ®çš„ä¸€è‡´æ€§ï¼Œä¸åŒçš„å®ç°æ–¹å¼å¯¹äºæœ€ç»ˆçš„æ€§èƒ½è¡¨ç°æœ‰è¾ƒå¤§çš„å½±å“ï¼Œå¯ä»¥è¿›è¡Œå¦‚ä¸‹ä¼˜åŒ–ï¼š\n- **åˆ†å¸ƒå¼é”**ï¼šé€šè¿‡åœ¨ä¸‹å•å‚æ•°æ ¡éªŒé˜¶æ®µå¢åŠ åˆ†å¸ƒå¼é”ï¼Œç¡®ä¿åŒä¸€ä¸ªç”¨æˆ·æ— æ³•è¿ç»­ä¸‹å•è´­ä¹°åŒä¸€ä¸ªå•†å“ï¼Œç»“åˆä¸Šæ–‡æåˆ°çš„ä¸‹å•è¯·æ±‚çš„å¹‚ç­‰æ€§æ§åˆ¶ï¼Œå¯ä»¥æœç»åŒä¸€ä¸ªè´¦å·é€šè¿‡å¤šå¼€æˆ–è€…è¿ç»­ç‚¹å‡»ç­‰æ–¹å¼å¢å¤§æŠ¢è´­æˆåŠŸç‡ï¼›åŒæ—¶ï¼Œé‡‡ç”¨åœ¨å‚æ•°æ ¡éªŒé˜¶æ®µåŠ åˆ†å¸ƒå¼é”ç›¸æ¯”äºé™è´­æ£€æŸ¥é˜¶æ®µåŠ é”ï¼ˆæ— è®ºæ˜¯æ•°æ®åº“é”è¿˜æ˜¯åˆ†å¸ƒå¼é”ï¼‰æ¶ˆè€—çš„èµ„æºæ›´å°‘ï¼Œæ€§èƒ½è¡¨ç°æ›´ä¼˜\n- **ç¼“å­˜**ï¼šé‡‡ç”¨åˆ†å¸ƒå¼ç¼“å­˜ï¼ˆRedisï¼‰è®°å½•é™è´­æƒç›Šæ¶ˆè€—æƒ…å†µï¼Œé™è´­æ£€æŸ¥é€šè¿‡ç¼“å­˜æ›¿ä»£æ•°æ®åº“æŸ¥è¯¢\n- **å‰ç½®æ ¡éªŒ**ï¼šç»“åˆä¸šåŠ¡æµç¨‹ï¼Œå‰ç½®æ‹¦æˆªä¸æ»¡è¶³é™è´­è¦æ±‚çš„è¯·æ±‚ï¼Œæ¯”å¦‚åœ¨å•†è¯¦ã€ç»„å•ç­‰é˜¶æ®µè¿›è¡Œé™è´­æ£€æŸ¥ï¼Œç›¸æ¯”äºä¸‹å•é˜¶æ®µæ£€æŸ¥æ¶ˆè€—çš„èµ„æºæ›´å°‘ï¼Œæ€§èƒ½è¡¨ç°æ›´ä¼˜\n- **è®¢å•æ‰¹é‡æ“ä½œ**ï¼šã€ŒièŒ…å°ã€é‡‡ç”¨çš„æ˜¯å…¸å‹çš„**ä¸»å­è®¢å•ç»“æ„**ï¼Œä¸»è®¢å•åˆå«æ”¯ä»˜è®¢å•ï¼Œç”±1~Nä¸ªå­è®¢å•æ„æˆï¼Œå­è®¢å•ä¸€èˆ¬é‡‡ç”¨åº—é“ºï¼ˆé—¨åº—ï¼‰ç²’åº¦ï¼Œè¿™ç§æ–¹å¼å¯ä»¥æ¯”è¾ƒå®¹æ˜“åœ°å®ç°åˆå¹¶æ”¯ä»˜ä»¥åŠåº—é“ºï¼ˆé—¨åº—ï¼‰ç²’åº¦çš„å®æ—¶åˆ†è´¦ã€‚åœ¨ä¸‹å•é˜¶æ®µï¼Œå‡è®¾ç”¨æˆ·åŒæ—¶æ”¯ä»˜Nä¸ªåº—é“ºï¼ˆé—¨åº—ï¼‰çš„å•†å“ï¼Œä»…è®¢å•è½åº“è¿™ä¸ªç¯èŠ‚å°±éœ€è¦1+Næ¬¡DBæ“ä½œï¼ˆä¸å«è®¢å•å•†å“å’Œè®¢å•åœ°å€è½åº“ï¼‰ï¼Œé€šè¿‡ä¼˜åŒ–ä¸šåŠ¡æµç¨‹ï¼Œåªéœ€è¦1æ¬¡DBæ“ä½œå°±å¯ä»¥è¾¾åˆ°ç›¸åŒçš„æ•ˆæœï¼Œä»è€Œå¸¦æ¥æ€§èƒ½æå‡\n\n<div style=\"text-align: center;\">\n  <img src=\"../img/netease/5c9d8e8cd155e70d6184eabe1ca01ba.png\" alt=\"è®¢å•æ‰¹é‡æ“ä½œ\">\n</div>\n\nç”±äºçˆ†æ¬¾æŠ¢è´­éƒ½æ˜¯å•å•†å“ç«‹å³è´­ä¹°ï¼Œå› æ­¤ï¼Œåˆå¹¶æ’å…¥å„ä¸ªå­è®¢å•çš„è®¢å•å•†å“åŠè®¢å•åœ°å€ä¸ä¼šæå‡æ€§èƒ½ï¼Œåè€Œä¼šå¢åŠ ä¸å¿…è¦çš„ä»£ç å¤æ‚åº¦\n\n- **è¿æ¥æ± åŠé¢„çƒ­**ï¼šé€šè¿‡è¿æ¥æ± æ¥ç®¡ç†æ•°æ®åº“åŠRedisè¿æ¥ï¼Œæ ¹æ®åº”ç”¨å¹¶å‘åº¦åŠDBè´Ÿè½½æƒ…å†µåˆ†æè¿æ¥æ± å¤§å°å¹¶è®¾ç½®åˆç†çš„åˆå§‹åŒ–æ•°é‡ï¼Œå¯¹æ€§èƒ½æ”¹å–„æœ‰è¾ƒå¤§å¸®åŠ©ï¼Œåœ¨æ­¤åŸºç¡€ä¸Šï¼Œé¢„çƒ­ä¹Ÿå¯ä»¥è®©ç³»ç»Ÿå¯ä»¥æ›´å¿«åœ°è¿›å…¥åˆ°æœ€ä½³çŠ¶æ€ï¼Œæ¯”å¦‚æå‰å°†å•†å“ä¿¡æ¯åŠ è½½åˆ°æœ¬åœ°ç¼“å­˜å’Œåˆ†å¸ƒå¼ç¼“å­˜ã€åˆ©ç”¨å°±ç»ªæ¢é’ˆï¼ˆå¦‚SpringBoot Actuatoræä¾›çš„readinessï¼‰æå‰é¢„çƒ­æ¯ä¸ªæœåŠ¡å®ä¾‹ï¼ˆå°¤å…¶æ˜¯å…³é”®é“¾è·¯ä¸Šçš„å®ä¾‹ï¼‰ä»¥åŠç³»ç»Ÿå‘å¸ƒåæˆ–è€…å…³é”®äº‹ä»¶åˆ°æ¥ä¹‹å‰å¯åŠ¨å°æµé‡é¢„çƒ­ç­‰ç­‰\n\né€šè¿‡é‡‡ç”¨ä¸Šè¿°ä¼˜åŒ–ç­–ç•¥ï¼Œæˆ‘ä»¬åœ¨ä¸å¢åŠ æœåŠ¡å™¨çš„å‰æä¸‹ï¼Œçˆ†æ¬¾æŠ¢è´­åœºæ™¯çš„æ•´ä½“ååé‡è¶…è¿‡æ™®é€šäº‘è´­åœºæ™¯çš„ä¸¤å€ä»¥ä¸Šï¼Œç›¸æ¯”ä¸æ—©æœŸäº¤ä»˜ç‰ˆæœ¬æ›´æ˜¯æå‡äº†ä¸‰å€ä»¥ä¸Šã€‚\n\n## 2.2.2 æ•°æ®åº“ä¼˜åŒ–\næ•°æ®åº“å¯¹ç³»ç»Ÿæ€§èƒ½ä¹Ÿæœ‰ç€éå¸¸é‡è¦çš„å½±å“ï¼Œå¸¸è§çš„æ•°æ®åº“ä¼˜åŒ–ç­–ç•¥åŒ…æ‹¬ï¼š\n\n- **æ•°æ®æ¨¡å‹è®¾è®¡ä¼˜åŒ–**ï¼šæ•°æ®æ¨¡å‹è®¾è®¡æ˜¯æŠ€æœ¯å®ç°æ–¹æ¡ˆçš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œå®ƒä¸ä»…ç›´æ¥å½±å“æ•°æ®åº“çš„æ€§èƒ½ï¼Œä¹Ÿä¼šå½±å“æ•°æ®åº“çš„å¯æ‰©å±•æ€§å’Œå¯ç»´æŠ¤æ€§ï¼Œé€šå¸¸éœ€è¦è€ƒè™‘ä»¥ä¸‹ä¸¤ä¸ªæ–¹é¢ï¼š\n- **é€‰æ‹©åˆé€‚çš„è®¾è®¡èŒƒå¼**\n- **è§„èŒƒåŒ–**ï¼ˆNormalizationï¼‰å¯ä»¥å‡å°‘æ•°æ®å†—ä½™ï¼Œä½†å¯èƒ½éœ€è¦æ›´å¤šçš„è”è¡¨æ“ä½œ\n- **åè§„èŒƒåŒ–**ï¼ˆDenormalizationï¼‰å¯ä»¥é€šè¿‡å¢åŠ å†—ä½™åˆ—ã€æ´¾ç”Ÿåˆ—ã€åˆå¹¶è¡¨ç­‰ç­–ç•¥æœ€å¤§ç¨‹åº¦é¿å…è”è¡¨æ“ä½œæˆ–å‡½æ•°è®¡ç®—ï¼Œæé«˜æŸ¥è¯¢æ€§èƒ½ï¼Œä½†ä¼šå¢åŠ æ•°æ®å†—ä½™ï¼Œæ¯”è¾ƒå…¸å‹çš„åè§„èŒƒåŒ–è®¾è®¡æ˜¯è®¢å•è¡¨ï¼Œé€šè¿‡é¢å¤–å†—ä½™é—¨åº—ã€ç»é”€å•†ç­‰å¸¸ç”¨ä½†å˜æ›´é¢‘ç‡å¾ˆä½çš„ä¿¡æ¯ï¼Œå¯ä»¥æå‡è®¢å•æŸ¥è¯¢çš„æ•ˆç‡\n- **é€‚å½“çš„æ•°æ®ç±»å‹å’Œé•¿åº¦**ï¼šæ ¹æ®ä¸šåŠ¡éœ€æ±‚é€‰æ‹©é€‚å½“çš„ç±»å‹å’Œé•¿åº¦æ¥å­˜å‚¨æ•°æ®å¯ä»¥å‡å°‘å­˜å‚¨ç©ºé—´ï¼Œä¹Ÿå¯ä»¥æå‡æŸ¥è¯¢æ€§èƒ½ï¼Œå¦‚è°¨æ…ä½¿ç”¨å¤§æ•°æ®ç±»å‹ï¼ˆTEXT,CLOB,BLOBç­‰ï¼‰ï¼Œä½¿ç”¨æ•´æ•°è€Œä¸æ˜¯å­—ç¬¦ä¸²å­˜å‚¨å¸ƒå°”å€¼ï¼Œé¿å…å­˜å‚¨nullå€¼ç­‰\n- **ç´¢å¼•ä¼˜åŒ–**ï¼š æ•°æ®åº“ç´¢å¼•å¯ä»¥æ˜¾è‘—æå‡æŸ¥è¯¢æ€§èƒ½ï¼Œéœ€è¦åˆç†åˆ›å»ºå¹¶ç»´æŠ¤ç´¢å¼•ï¼ŒåŒ…æ‹¬è€ƒè™‘å“ªäº›åˆ—ä»¥æ€æ ·çš„æ¬¡åºç»„åˆç´¢å¼•ã€é€‰æ‹©é€‚å½“çš„ç´¢å¼•ç±»å‹ä»¥åŠå®šæœŸé‡å»ºæˆ–é‡æ–°ç»„ç»‡ç´¢å¼•ç­‰ï¼›åŒæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦äº†è§£ç´¢å¼•åŒ¹é…çš„åŸºæœ¬åŸåˆ™ï¼Œå˜æ›´å‰å¯¹SQLä¸ç´¢å¼•è¿›è¡Œå®¡æŸ¥ï¼Œé¿å…æœ€ç»ˆä½¿ç”¨çš„ç´¢å¼•ä¸ç¬¦åˆé¢„æœŸï¼ˆå¯ä»¥å€ŸåŠ©æ…¢æŸ¥è¯¢æ—¥å¿—ã€explainç­‰å·¥å…·è¿›è¡Œåˆ†æè°ƒä¼˜ï¼‰ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç´¢å¼•ä¹Ÿå¹¶ä¸æ˜¯è¶Šå¤šè¶Šå¥½ï¼Œå®ƒä¼šå ç”¨é¢å¤–çš„ç©ºé—´ï¼Œä¼šå½±å“æ›´æ–°æ“ä½œçš„æ€§èƒ½\n- **æŸ¥è¯¢ä¼˜åŒ–**ï¼šç¼–å†™é«˜æ•ˆçš„SQLæŸ¥è¯¢è¯­å¥ï¼ŒåŒ…æ‹¬å°½å¯èƒ½é¿å…ä½¿ç”¨SELECT *ã€é¿å…å…¨è¡¨æ‰«æã€è°¨æ…ä½¿ç”¨è”è¡¨æŸ¥è¯¢å’Œå­æŸ¥è¯¢ï¼ˆæˆ‘ä»¬åœ¨ä¸šåŠ¡ä»£ç ä¸­ç¦æ­¢ä½¿ç”¨ï¼‰ã€é™åˆ¶æŸ¥è¯¢è¿”å›çš„æ•°æ®é‡ç­‰\n- **ç¼“å­˜**ï¼šé€‰æ‹©åˆé€‚çš„ç¼“å­˜ç»„ä»¶å’Œç¼“å­˜ç­–ç•¥æ¥å­˜å‚¨é¢‘ç¹è®¿é—®çš„æ•°æ®ï¼ˆå‚è§ã€Œæ— å¤„ä¸åœ¨çš„ç¼“å­˜ã€ç« èŠ‚ï¼‰ä»¥å‡å°‘å¯¹æ•°æ®åº“çš„è®¿é—®ï¼Œä»è€Œé™ä½æ•°æ®åº“è´Ÿè½½ï¼Œæå‡å“åº”é€Ÿåº¦\n- **è¯»å†™åˆ†ç¦»**ï¼šåœ¨ä¸€äº›æ•°æ®åº“è´Ÿè½½æ¯”è¾ƒé«˜çš„ä¸šåŠ¡ä¸­ï¼Œå¯ä»¥å°†è¯»å–æ“ä½œä¸å†™å…¥æ“ä½œè¿›è¡Œåˆ†ç¦»ï¼Œåˆ†åˆ«è·¯ç”±åˆ°ä¸åŒçš„æ•°æ®åº“æœåŠ¡å™¨æˆ–æ•°æ®åº“å‰¯æœ¬ï¼Œä»è€Œé™ä½ä¸»åº“ï¼ˆå†™åº“ï¼‰çš„è´Ÿè½½ï¼Œæå‡å“åº”é€Ÿåº¦\n- **åˆ†åº“åˆ†è¡¨**ï¼šå¯¹äºæ•°æ®è§„æ¨¡éå¸¸å¤§çš„æ•°æ®åº“ï¼Œå¯ä»¥å€ŸåŠ©åˆ†åº“åˆ†è¡¨æŠ€æœ¯å‡å°‘å•åº“çš„è´Ÿè½½ï¼Œä»è€Œæå‡æ•°æ®åº“çš„æ€§èƒ½ã€å¯ä¼¸ç¼©æ€§å’Œå®¹é”™æ€§\n\nè¿™é‡Œä»¥çˆ†æ¬¾æŠ¢è´­åœºæ™¯åº“å­˜æœåŠ¡çš„æ€§èƒ½ä¼˜åŒ–ä¸ºä¾‹ä»‹ç»ä¸‹è¿™äº›ç­–ç•¥çš„å…·ä½“åº”ç”¨ï¼š\n\n- **æ•°æ®æ¨¡å‹è®¾è®¡**ï¼šç»“åˆå•†åŸçš„ä¸šåŠ¡åœºæ™¯ï¼Œå­˜åœ¨æ•°åƒå®¶åº—é“ºï¼ˆé—¨åº—ï¼‰æŠ•æ”¾åŒä¸€ä¸ªå•†å“çš„æƒ…å†µï¼ˆå³å¤šé—¨åº—å…±ç”¨åŒä¸€ä¸ªå•†å“ï¼‰ï¼Œä¹Ÿå­˜åœ¨å•†å“ç‹¬å®¶é”€å”®çš„æƒ…å†µï¼ˆå³å•†å“åªåœ¨åŒä¸€å®¶åº—é“ºé”€å”®ï¼‰ï¼Œæ¯å®¶åº—é“ºï¼ˆé—¨åº—ï¼‰çš„é”€å”®åº“å­˜éœ€è¦å•ç‹¬ç®¡ç†ï¼ŒåŸºäºæ­¤ï¼Œæˆ‘ä»¬ä¸ºåº“å­˜æœåŠ¡è®¾è®¡äº†ä¸¤å¼ æ ¸å¿ƒè¡¨ï¼Œå³åº“å­˜è¡¨å’Œåº“å­˜æµæ°´è¡¨ï¼ˆå¦‚å›¾æ‰€ç¤ºï¼‰\n- **åè§„èŒƒåŒ–**ï¼šåº“å­˜è¡¨æ–°å»ºå”¯ä¸€ç´¢å¼•(ShopId, SkuId)ï¼Œåº“å­˜æµæ°´è¡¨åˆ™å†—ä½™å­—æ®µShopIdå’ŒSkuIdï¼Œæ–°å»ºå”¯ä¸€ç´¢å¼•(ShopId, SkuId, OrderId, Type)\n\n<div style=\"text-align: center;\">\n  <img src=\"../img/netease/8b5a051f0d633dad5fef4a41aa9d6f3.png\" alt=\"åº“å­˜ç›¸å…³çš„æŸ¥è¯¢\">\n</div>\n\n- **é€‰æ‹©çš„æ•°æ®ç±»å‹**ï¼šä»¥åº“å­˜æµæ°´è¡¨ä¸­çš„Typeå­—æ®µä¸ºä¾‹ï¼Œç”¨æ¥è¡¨ç¤ºåº“å­˜æ‰£å‡ã€å›æ»šã€æŠ•æ”¾ã€å›æ”¶ç­‰çŠ¶æ€ï¼Œæ˜¾ç„¶ç”¨tinyintå°±è¶³å¤Ÿè¿›è¡Œå­˜å‚¨äº†ï¼Œç›¸æ¯”äºsmallintã€intç±»å‹å¯ä»¥èŠ‚çœå­˜å‚¨ç©ºé—´\n- **æ•°æ®åº“é€‰å‹**ï¼šåº“å­˜æµæ°´è¡¨é¢„è®¡æ¯å¹´æ–°äº§ç”Ÿçš„æ•°æ®åœ¨åƒä¸‡çº§ä¸”ä¼šæŒç»­å¢é•¿ï¼Œè€Œåº“å­˜æœåŠ¡åˆæ˜¯äº¤æ˜“é“¾è·¯çš„æ ¸å¿ƒä¾èµ–ï¼Œè¯»å†™æ“ä½œé¢‘ç¹ä¸”æœ‰æ˜æ˜¾ä¸šåŠ¡å³°å€¼ï¼Œå¦‚æœç”¨å•ä¸ªMySQLå®ä¾‹å»æ”¯æŒï¼Œå­˜å‚¨å’Œæ€§èƒ½ç“¶é¢ˆè¾ƒä¸ºæ˜æ˜¾ï¼Œå› æ­¤æˆ‘ä»¬é‡‡ç”¨äº†åˆ†åº“åˆ†è¡¨çš„æŠ€æœ¯ï¼ˆ**ç½‘æ˜“è‡ªç ”çš„DDB**ï¼‰\n- **è´Ÿè½½å‡è¡¡**ï¼šå‡è¡¡å­—æ®µï¼ˆæ‹†åˆ†é”®ï¼‰å’Œå‡è¡¡ç­–ç•¥çš„é€‰æ‹©å¯¹äºæ€§èƒ½æœ‰éå¸¸æ˜æ˜¾çš„å½±å“ï¼Œéœ€è¦æ ¼å¤–é‡è§†ï¼Œåœ¨åº“å­˜æœåŠ¡è¿™ä¸ªä¾‹å­ä¸­ï¼Œåº“å­˜è¡¨å’Œåº“å­˜æµæ°´è¡¨æˆ‘ä»¬éƒ½ä½¿ç”¨ShopIdä½œä¸ºå‡è¡¡å­—æ®µä¸”ä½¿ç”¨ç›¸åŒçš„å‡è¡¡ç­–ç•¥ï¼Œä¸»è¦æœ‰ä»¥ä¸‹å‡ ç‚¹è€ƒè™‘ï¼š\n- **åº“å­˜ç›¸å…³çš„æŸ¥è¯¢**ã€å˜æ›´éƒ½ä¼šæŒ‡å®šShopIdå’ŒSkuIdï¼Œåœ¨æœ‰æ•°åƒå®¶é—¨åº—æŠ•æ”¾åŒä¸€ä¸ªçˆ†æ¬¾å•†å“çš„æƒ…å†µä¸‹ï¼Œé‡‡ç”¨ShopIdä½œä¸ºå‡è¡¡å­—æ®µå¯ä»¥ä½¿æ•°æ®åˆ†å¸ƒå’Œæµé‡åˆ†å¸ƒæ›´ä¸ºå‡è¡¡ï¼Œåº“å­˜è¡¨é‡‡ç”¨ä¸åº“å­˜æµæ°´è¡¨ç›¸åŒçš„å‡è¡¡å­—æ®µå’Œå‡è¡¡ç­–ç•¥ï¼Œå¯ä»¥é¿å…XAäº‹åŠ¡ï¼Œå‡å°‘é”ç«äº‰\n- **åˆ†å¸ƒå¼ID**ï¼šåŸºäºç¾å›¢çš„åˆ†å¸ƒå¼Idç®—æ³•Leafçš„ç»Ÿä¸€IDç”ŸæˆæœåŠ¡åœ¨é«˜å¹¶å‘åœºæ™¯å…·æœ‰ä½å»¶è¿Ÿã€é«˜ååã€é«˜å¯ç”¨ã€æ”¯æŒæ°´å¹³æ‰©å±•çš„ç‰¹ç‚¹ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥æ»¡è¶³ä¸šåŠ¡ä¸Šè‡ªå®šä¹‰çš„éœ€æ±‚ï¼Œæˆ‘ä»¬å°†å®ƒä½œä¸ºåˆ†å¸ƒå¼IDç”Ÿæˆçš„è§£å†³æ–¹æ¡ˆ\n- **å®šæœŸå½’æ¡£**ï¼šæ•°æ®è§„æ¨¡çš„æŒç»­å¢é•¿ä¼šå¯¹æ€§èƒ½å¸¦æ¥è´Ÿé¢å½±å“ï¼Œå¯ä»¥è€ƒè™‘å°†æ—©æœŸçš„åº“å­˜æµæ°´ä¿¡æ¯è¿ç§»åˆ°å½’æ¡£è¡¨ï¼Œå¯ä»¥æå‡æ•°æ®åº“æ€§èƒ½\n\n## 2.2.3 æ— å¤„ä¸åœ¨çš„ç¼“å­˜\nç¼“å­˜æŠ€æœ¯æ˜¯ä¸€ç§è¢«å¹¿æ³›åº”ç”¨äºè®¡ç®—æœºç³»ç»Ÿå’Œåº”ç”¨ç¨‹åºä¸­çš„æ€§èƒ½ä¼˜åŒ–æ–¹æ³•ï¼Œå®ƒé€šè¿‡å°†æ•°æ®æˆ–è®¡ç®—ç»“æœæš‚æ—¶å­˜å‚¨åœ¨é«˜é€Ÿå­˜å‚¨ä»‹è´¨ä¸­ï¼Œä½¿ç³»ç»Ÿå¯ä»¥å¿«é€Ÿå“åº”è¯·æ±‚ã€è¿”å›æ•°æ®ï¼Œè€Œæ— éœ€æ¯æ¬¡éƒ½ä»æ…¢é€Ÿå­˜å‚¨ä»‹è´¨ï¼ˆå¦‚ç£ç›˜æˆ–è¿œç¨‹æœåŠ¡å™¨ç­‰ï¼‰ä¸­è·å–æ•°æ®ã€‚\n\n\n\nåˆ©ç”¨å¥½ç¼“å­˜æŠ€æœ¯å¯ä»¥é™ä½èµ„æºè´Ÿè½½ï¼Œå‡å°‘å¯¹æ•°æ®åº“ã€ç½‘ç»œæˆ–åç«¯åº”ç”¨ç­‰å¤–éƒ¨èµ„æºçš„ä¾èµ–ï¼Œæ˜¾è‘—æå‡ç³»ç»Ÿçš„æ€§èƒ½ä¸å¯ç”¨æ€§ã€‚å¯ä»¥è¯´ï¼Œåœ¨æˆ‘ä»¬ç°æœ‰çš„ç³»ç»Ÿæ¶æ„ä¸­ï¼Œç¼“å­˜å‡ ä¹æ— å¤„ä¸åœ¨ï¼Œä»¥ç”³è´­åœºæ™¯ä¸ºä¾‹ï¼š\n\n- **å®¢æˆ·ç«¯ï¼ˆAPPï¼‰**ï¼šå®¢æˆ·ç«¯é€šè¿‡ç¼“å­˜é¢„ç½®åœ¨APPçš„æ•°æ®ã€ç¼“å­˜æ•°æ®è¯·æ±‚å“åº”ç­‰æ–¹å¼å‡å°‘å¯¹æœåŠ¡ç«¯çš„é¢‘ç¹è®¿é—®ï¼Œæä¾›æ›´ä¸ºæµç•…çš„ç”¨æˆ·ä½“éªŒï¼Œå°¤å…¶æœ‰åŠ©äºæ”¹å–„é¦–æ¬¡è®¿é—®æˆ–ä¸ç¨³å®šç½‘ç»œç¯å¢ƒä¸‹çš„è®¿é—®ä½“éªŒ\n- **é™æ€èµ„æºè®¿é—®åŠ é€Ÿ**ï¼šé™æ€èµ„æºè®¿é—®åŠ é€Ÿçš„æ ¸å¿ƒåœ¨äºå°±è¿‘è®¿é—®ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡é™æ€åŒ–æŠ€æœ¯å°†åŠ¨æ€ç”Ÿæˆçš„å†…å®¹æˆ–ç½‘é¡µè½¬æ¢æˆé™æ€æ–‡ä»¶å¹¶å­˜å‚¨åˆ°CDNï¼ˆContent Delivery Networkï¼Œå†…å®¹åˆ†å‘ç½‘ç»œï¼‰æˆ–LBï¼ˆLoad Balancerï¼Œè´Ÿè½½å‡è¡¡ï¼‰ï¼Œåœ¨ç”¨æˆ·è¯·æ±‚æ—¶ç¦»ç”¨æˆ·æ›´è¿‘çš„èŠ‚ç‚¹å¯ä»¥ç›´æ¥æä¾›è¿™äº›é™æ€æ–‡ä»¶ï¼Œè€Œä¸å¿…å†æ¬¡è¯·æ±‚æœåŠ¡ç«¯è¿›è¡ŒåŠ¨æ€ç”Ÿæˆï¼Œå› æ­¤ï¼Œå¯ä»¥åŠ å¿«é¡µé¢åŠ è½½é€Ÿåº¦ã€æå‡ç½‘ç«™æˆ–åº”ç”¨ç¨‹åºçš„æ€§èƒ½ã€å‡å°‘æœåŠ¡å™¨è´Ÿè½½å¹¶é™ä½å¯¹æœåŠ¡å™¨èµ„æºçš„éœ€æ±‚ã€‚é€šå¸¸é™æ€åŒ–æŠ€æœ¯å¯ä»¥åº”ç”¨äºä¸ç»å¸¸å˜æ›´çš„å†…å®¹ã€è®¿é—®é‡è¾ƒå¤§çš„é¡µé¢ã€éœ€è¦SEOä¼˜åŒ–çš„é¡µé¢ã€é™æ€èµ„æºç­‰\n\n<div style=\"text-align: center;\">\n  <img src=\"../img/netease/70d65dd9ee6014e47e150729c3cffbd.png\" alt=\"CDN\">\n</div>\n\n- **æœåŠ¡ç«¯**ï¼šå€ŸåŠ©ç¼“å­˜å¯ä»¥å‡å°‘å½“å‰åº”ç”¨å¯¹æ•°æ®åº“æˆ–è€…å…¶ä»–åç«¯æœåŠ¡çš„è®¿é—®ï¼Œé€šå¸¸æˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨åˆ†å¸ƒå¼ç¼“å­˜ï¼ˆå¦‚Redisï¼‰ï¼Œä½†åœ¨é«˜å¹¶å‘åœºæ™¯ï¼ˆå¦‚ç”³è´­åœºæ™¯ï¼‰ï¼Œä¸ºäº†å¢åŠ ç³»ç»Ÿæ•´ä½“çš„ååé‡ï¼Œä¹Ÿå¯ä»¥è€ƒè™‘å°†çƒ­ç‚¹æ•°æ®è®¾è®¡æˆäºŒçº§ç¼“å­˜ï¼Œå³åŒæ—¶ä½¿ç”¨æœ¬åœ°ç¼“å­˜ï¼ˆLocal Cacheï¼‰å’Œè¿œç«¯ç¼“å­˜ï¼ˆRemote Cacheï¼Œæˆ–è€…å«åˆ†å¸ƒå¼ç¼“å­˜ï¼‰\n\n<div style=\"text-align: center;\">\n  <img src=\"../img/netease/0b822a67d09bd467efca771b70bcf64.png\" alt=\"æœåŠ¡ç«¯\">\n</div>\n\nè™½ç„¶ç¼“å­˜æŠ€æœ¯å¯ä»¥æ˜¾è‘—æå‡æ€§èƒ½ï¼Œä½†åŒæ—¶ä¹Ÿæå¤§æå‡äº†ç³»ç»Ÿè®¾è®¡çš„å¤æ‚åº¦ï¼Œéœ€è¦è€ƒè™‘ç¼“å­˜çš„ä¸€è‡´æ€§ã€å¤±æ•ˆç­–ç•¥å’Œç¼“å­˜ç»´æŠ¤ç­‰å…³é”®é—®é¢˜ï¼Œå¦‚æœæ²¡æœ‰å¤„ç†å¥½ï¼Œå¾ˆå®¹æ˜“å‘ç”Ÿç¼“å­˜æ•°æ®ä¸ä¸€è‡´ã€ç¼“å­˜å¤§é¢ç§¯ç©¿é€ç”šè‡³å¼•å‘é›ªå´©ã€‚\n\n\n\nä»¥ç”³è´­åœºæ™¯ä½¿ç”¨çš„äºŒçº§ç¼“å­˜ä¸ºä¾‹ï¼Œæˆ‘ä»¬éœ€è¦å¤„ç†å¥½ä»¥ä¸‹é—®é¢˜ï¼š\n- **æŠ€æœ¯é€‰å‹**ï¼šæœ¬åœ°ç¼“å­˜é‡‡ç”¨Caffeineï¼Œè¿œç«¯ç¼“å­˜é‡‡ç”¨Redis Cluster\n- **Caffeine**ï¼šç›¸æ¯”äºEhCacheã€Guavaç­‰ä¸»æµçš„ç¼“å­˜æ¡†æ¶ï¼Œæ‹¥æœ‰æ›´åŠ å¼ºå¤§çš„æ€§èƒ½è¡¨ç°ï¼Œä½¿ç”¨æ–¹å¼ä¸Šä¸Guavaç±»ä¼¼ï¼Œéå¸¸æ–¹ä¾¿\n- **Redis Cluster**ï¼šRedis Clusteræ˜¯Redisæä¾›çš„åˆ†å¸ƒå¼ç¼“å­˜è§£å†³æ–¹æ¡ˆï¼Œä¹Ÿæ˜¯ç›®å‰ä¸»æµçš„è§£å†³æ–¹æ¡ˆï¼Œç›¸æ¯”äºProxyæ¨¡å¼æœ‰æ›´å¥½çš„æ€§èƒ½è¡¨ç°ï¼Œä½†æˆ‘ä»¬ä»ç„¶éœ€è¦é‡ç‚¹å…³æ³¨ç¡¬ä»¶ä»¥åŠæ··éƒ¨ç­‰å› ç´ å¯¹äºæ€§èƒ½åŠç¨³å®šæ€§çš„å½±å“\n- **é¿å…ç¼“å­˜ç©¿é€**ï¼šä¼ ç»Ÿçš„å…³ç³»å‹æ•°æ®åº“å¯¹äºå¹¶å‘çš„æ‰¿å—èƒ½åŠ›éå¸¸è„†å¼±ï¼Œå¦‚æœæˆ‘ä»¬è®¾è®¡çš„ç¼“å­˜å‘½ä¸­ç‡ä¸é«˜å‡ºç°å¤§é¢ç§¯ç¼“å­˜ç©¿é€ï¼Œå¾ˆæœ‰å¯èƒ½å°†æ•°æ®åº“æ‹–å®ï¼Œå¦‚ä½•é¿å…ç¼“å­˜ç©¿é€æ˜¯æˆ‘ä»¬è®¾è®¡ç¼“å­˜æ—¶éœ€è¦é‡ç‚¹è€ƒè™‘çš„é—®é¢˜ï¼š\n- çƒ­ç‚¹ç¼“å­˜é‡‡ç”¨é¢„åŠ è½½ã€å®šæ—¶åˆ·æ–°åŠäº‹ä»¶è§¦å‘åˆ·æ–°ï¼ˆå¦‚æ•°æ®å˜æ›´ï¼‰çš„ç­–ç•¥ï¼Œä¿è¯100%å‘½ä¸­ç‡\n- å½“æŸ¥è¯¢çš„ç»“æœä¸ºç©ºæ—¶ï¼Œä»ç„¶å°†ç©ºç»“æœï¼ˆè‡ªå®šä¹‰NullObjectï¼‰å­˜å‚¨åˆ°ç¼“å­˜ä¸­ï¼ˆå¯ä»¥è®¾ç½®ä¸€ä¸ªè¾ƒçŸ­çš„è¿‡æœŸæ—¶é—´ï¼‰ï¼Œè¿™æ ·å¯ä»¥é˜²æ­¢æ¶æ„è¯·æ±‚çš„è¿ç»­æŸ¥è¯¢\n- **æ¶ˆæ¯é˜Ÿåˆ—ä¸å¼‚æ­¥åŒ–**\nå¼‚æ­¥åŒ–çš„æ ¸å¿ƒæ€æƒ³æ˜¯å°†è€—æ—¶çš„æ“ä½œä»ä¸»æµç¨‹ä¸­åˆ†ç¦»å‡ºæ¥ï¼Œä»¥å…è®¸åº”ç”¨ç¨‹åºåœ¨ç­‰å¾…è¿™äº›æ“ä½œå®Œæˆçš„åŒæ—¶ç»§ç»­æ‰§è¡Œå…¶ä»–ä»»åŠ¡è€Œä¸ä¼šè¢«é˜»å¡ï¼Œä»è€Œæ”¹å–„ç³»ç»Ÿçš„å“åº”æ€§å’Œèµ„æºåˆ©ç”¨ç‡ã€‚\n\nå¼‚æ­¥åŒ–é€šå¸¸å¯ä»¥é€šè¿‡å¤šçº¿ç¨‹ã€å¤šè¿›ç¨‹ã€äº‹ä»¶é©±åŠ¨æˆ–å¼‚æ­¥ç¼–ç¨‹æ¨¡å‹ç­‰æ–¹å¼æ¥å®ç°ï¼Œæœ‰å¾ˆå¤šä¸­é—´ä»¶å’Œæ¡†æ¶å¯ä¾›æˆ‘ä»¬é€‰æ‹©ï¼Œæ¯”å¦‚é€šè¿‡**Disruptor**ã€**BlockingQueue**ç­‰æŠ€æœ¯å°†ä»»åŠ¡åˆ†è§£ä¸ºå¤šä¸ªçº¿ç¨‹æˆ–è¿›ç¨‹ä»¥å……åˆ†åˆ©ç”¨å¤šæ ¸å¤„ç†å™¨çš„æ€§èƒ½ï¼Œé€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMQï¼‰å®ç°å¼‚æ­¥æ¶ˆæ¯é€šä¿¡å’ŒæœåŠ¡è§£è€¦ï¼Œè¾¾åˆ°å¯¹æµé‡è¿›è¡Œå‰Šå³°å¡«è°·çš„æ•ˆæœï¼Œæå‡ç³»ç»Ÿçš„å¯æ‰©å±•æ€§å’Œæ€§èƒ½ã€‚\n\nè¿™é‡Œé‡ç‚¹æä¸€ä¸‹æ¶ˆæ¯é˜Ÿåˆ—åœ¨ã€ŒièŒ…å°ã€çš„åº”ç”¨ï¼Œæ— è®ºåœ¨ç”³è´­åœºæ™¯è¿˜æ˜¯åœ¨çˆ†æ¬¾æŠ¢è´­åœºæ™¯ï¼ˆå¦‚ä¸‹å›¾æ‰€ç¤ºï¼‰ï¼Œæˆ‘ä»¬éƒ½éœ€è¦å€ŸåŠ©æ¶ˆæ¯é˜Ÿåˆ—å®ç°å¯¹æ´ªå³°æµé‡çš„å‰Šå³°å¡«è°·ï¼Œé¿å…æœåŠ¡å™¨è¿‡è½½æˆ–ç³»ç»Ÿå®•æœºï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥å®ç°æ•°æ®çš„æœ€ç»ˆä¸€è‡´æ€§ï¼Œç¡®ä¿æ¶ˆæ¯å¤„ç†çš„ç»“æœä¸ä¸šåŠ¡é€»è¾‘çš„ä¸€è‡´æ€§ã€‚\n\n<div style=\"text-align: center;\">\n  <img src=\"../img/netease/fff9e5cb5d1d4a7dbdbd4dc7f2b0fcc.png\" alt=\"åœºæ™¯\">\n</div>\n\nä¸éš¾å‘ç°ï¼Œè¿™å…¶ä¸­çš„å…³é”®æŒ‘æˆ˜åœ¨äºæ¶ˆæ¯é˜Ÿåˆ—æœ¬èº«çš„é«˜æ€§èƒ½ä»¥åŠåœ¨è®¾è®¡ä¸Šå¦‚ä½•ç¡®ä¿æ•°æ®çš„æœ€ç»ˆä¸€è‡´æ€§ã€‚\n\nå…ˆæ¥çœ‹æ¶ˆæ¯é˜Ÿåˆ—çš„é€‰å‹ï¼Œåœ¨ä¸¥é€‰ï¼Œå› ä¸ºå†å²åŸå› åŒæ—¶å­˜åœ¨Kafkaã€Rabbitmqå’ŒRocketMQï¼Œä½†ç»¼åˆè€ƒè™‘æ€§èƒ½å’Œç¨³å®šæ€§è¡¨ç°ï¼ˆé«˜ååé‡ã€ä½å»¶è¿Ÿã€é«˜å¯ç”¨ï¼‰ã€åŠŸèƒ½ç‰¹æ€§ä¸°å¯Œåº¦ã€å·¥å…·æ”¯æŒä¸°å¯Œåº¦ã€ç¤¾åŒºæ´»è·ƒåº¦ç­‰ç»´åº¦ï¼ŒRocketMQæœ€ç»ˆæˆä¸ºä¸šåŠ¡ç³»ç»Ÿæ¶ˆæ¯é˜Ÿåˆ—çš„ä¸»æµé€‰å‹ï¼Œã€ŒièŒ…å°ã€åˆ™å»¶ç»­äº†è¿™ä¸€é€‰å‹ï¼Œé‡‡ç”¨ä¸»ä»éƒ¨ç½²æ¨¡å¼ï¼ˆ4.8ç‰ˆæœ¬ä¹‹å‰ä¸»ä»æ¨¡å¼ç›¸å¯¹Dledgeræ¨¡å¼åœ¨æ€§èƒ½ä¸Šæ›´æœ‰ä¼˜åŠ¿ï¼‰ã€‚\n\næ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸€ä¸‹å¦‚ä½•ç¡®ä¿æ•°æ®çš„æœ€ç»ˆä¸€è‡´æ€§ã€‚\n\n\n\nå…ˆä»‹ç»å››ç§æˆ‘ä»¬å¹³æ—¶å¼€å‘è¿‡ç¨‹ä¸­æ¯”è¾ƒå®¹æ˜“å‡ºé”™çš„å®ç°æ–¹æ³•ï¼ˆå¦‚ä¸‹å›¾æ‰€ç¤ºï¼‰ï¼š\n\n<div style=\"text-align: center;\">\n  <img src=\"../img/netease/667be695bf6001287371101aa348f56.png\" alt=\"å››ä¸ªæ–¹æ¡ˆ\">\n</div>\n\n- **æ–¹æ¡ˆä¸€**ï¼šå…ˆæ‰§è¡Œæ•°æ®åº“æ“ä½œå†å‘é€æ¶ˆæ¯åˆ°MQï¼Œå¯èƒ½ä¼šå‡ºç°æ•°æ®åº“æ“ä½œæˆåŠŸï¼Œæ¶ˆæ¯å‘é€å¤±è´¥çš„æƒ…å†µ\n- **æ–¹æ¡ˆäºŒ**ï¼šå…ˆå‘é€æ¶ˆæ¯åˆ°MQå†æ‰§è¡Œæ•°æ®åº“æ“ä½œï¼Œå¯èƒ½å‡ºç°æ¶ˆæ¯å‘é€æˆåŠŸï¼Œæ•°æ®åº“æ“ä½œå¤±è´¥çš„æƒ…å†µ\n- **æ–¹æ¡ˆä¸‰**ï¼šåœ¨æ–¹æ¡ˆä¸€çš„åŸºç¡€ä¸Šï¼Œå¼€å¯æ•°æ®åº“äº‹åŠ¡ï¼Œè¿™ä¸ªæ–¹æ¡ˆåœ¨æ¶ˆæ¯å‘é€å¤±è´¥æŠ›å‡ºå¼‚å¸¸çš„æƒ…å†µä¸‹å¯ä»¥æ­£å¸¸å›æ»šï¼Œä½†æœ‰å¯èƒ½ä¼šå‡ºç°æ¶ˆæ¯å‘å¸ƒè‡³MQæˆåŠŸä½†è¯·æ±‚å¤±è´¥çš„æƒ…å†µï¼ˆå¦‚ç½‘ç»œæ‹¥å µç­‰åŸå› å“åº”è¶…æ—¶ï¼‰ï¼Œè¿™ç§æƒ…å†µä¹Ÿä¼šå¼•å‘äº‹åŠ¡æ•´ä½“å›æ»š\n- **æ–¹æ¡ˆå››**ï¼šåœ¨æ–¹æ¡ˆäºŒçš„åŸºç¡€ä¸Šï¼Œå¼€å¯æ•°æ®åº“äº‹åŠ¡ï¼Œè¿™ä¸ªæ–¹æ¡ˆå¦‚æœæ•°æ®åº“æ“ä½œå¤±è´¥éœ€è¦å›æ»šï¼Œä½†MQå·²ç»å‘ç”ŸæˆåŠŸï¼Œæ²¡æœ‰åŠæ³•å›æ»š\n\nå¯è§ï¼Œä¸Šè¿°å››ä¸ªæ–¹æ¡ˆéƒ½æœ‰å¯èƒ½å‡ºç°æ•°æ®åº“æ“ä½œçŠ¶æ€å’Œæ¶ˆæ¯å‘é€çŠ¶æ€ä¸ä¸€è‡´çš„æƒ…å†µï¼Œå…¶ä¸­æ–¹æ¡ˆä¸€å¯èƒ½å‡ºç°æ•°æ®åº“æ“ä½œæˆåŠŸã€æ¶ˆæ¯å‘é€å¤±è´¥ï¼Œè¿™ç±»å¼‚å¸¸å¯ä»¥é€šè¿‡å¼•å…¥æ¶ˆæ¯è¡¥å¿æœºåˆ¶æ¥ç¡®ä¿æ¶ˆæ¯æœ€ç»ˆæˆåŠŸæŠ•é€’ï¼›æ–¹æ¡ˆäºŒã€ä¸‰ã€å››å¯èƒ½å‡ºç°æ¶ˆæ¯å‘é€æˆåŠŸã€æ•°æ®åº“æ“ä½œå¤±è´¥ï¼Œè¿™ç±»å¼‚å¸¸å¯ä»¥é€šè¿‡åœ¨æ¶ˆæ¯æ¶ˆè´¹ç«¯å¢åŠ æ¶ˆæ¯çŠ¶æ€ç¡®è®¤æˆ–è€…ç±»ä¼¼çš„æ ¡éªŒæœºåˆ¶ï¼Œç¡®ä¿è¢«æŠ•é€’å‡ºå»çš„æ¶ˆæ¯ä¸ä¼šå¯¹ä¸šåŠ¡äº§ç”Ÿè´Ÿé¢å½±å“ã€‚\n\n\næœ€åä»‹ç»ä¸¤ç§æ¯”è¾ƒå¸¸ç”¨çš„æ­£ç¡®å®ç°æ–¹æ³•ï¼š\n- **æ–¹æ¡ˆäº”**ï¼šåŸºäºRocketMQçš„äº‹åŠ¡æ¶ˆæ¯æ¥å®ç°\n\n<div style=\"text-align: center;\">\n  <img src=\"../img/netease/4dbdec6fba905b4f5e19540f7607a53.png\" alt=\"åŸºäºRocketMQçš„äº‹åŠ¡æ¶ˆæ¯æ¥å®ç°\">\n</div>\n\n- æ­¥éª¤ä¸€ï¼šæ¶ˆæ¯ç”Ÿäº§è€…å‘RocketMQå‘é€åŠäº‹åŠ¡æ¶ˆæ¯ï¼ˆ1. Prepareï¼‰ï¼ŒRocketMQç¡®è®¤æ¶ˆæ¯æ¥æ”¶çŠ¶æ€\n- æ­¥éª¤äºŒï¼šRocketMQæ¶ˆæ¯æ¥æ”¶æˆåŠŸï¼Œæ¶ˆæ¯ç”Ÿäº§è€…æ‰§è¡Œæœ¬åœ°äº‹åŠ¡çš„ä¸šåŠ¡é€»è¾‘\n- æ­¥éª¤ä¸‰ï¼šæ¶ˆæ¯ç”Ÿäº§è€…æ ¹æ®æœ¬åœ°äº‹åŠ¡çš„æ‰§è¡Œç»“æœå‘RocketMQæäº¤äºŒæ¬¡ç¡®è®¤ï¼ˆ2. Commit/Rollbackï¼‰ï¼ŒRocketMQå°†æ­¥éª¤ä¸€ä¸­æ”¶åˆ°çš„åŠäº‹åŠ¡æ¶ˆæ¯æ ‡è®°ä¸ºå¯æŠ•é€’ï¼ˆæ¶ˆè´¹è€…å°±å¯ä»¥æ¶ˆè´¹åˆ°è¿™ä¸ªæ¶ˆæ¯ï¼‰\nå¦‚æœå› æ–­ç½‘æˆ–è€…åº”ç”¨é‡å¯ç­‰åŸå› ï¼ŒäºŒæ¬¡ç¡®è®¤ï¼ˆ2. Commit/Rollbackï¼‰æ²¡æœ‰æˆåŠŸæäº¤ï¼ŒRocketMQä¼šå®šæ—¶è§¦å‘äº‹åŠ¡æ¶ˆæ¯å›æŸ¥ï¼Œç¡®è®¤æ˜¯å¦éœ€è¦æŠ•é€’ï¼ˆå…œåº•ç­–ç•¥ï¼‰ï¼Œæ— éœ€æŠ•é€’çš„æ¶ˆæ¯ä¼šåœ¨è¿‡æœŸååˆ é™¤\n- æ­¥éª¤å››ï¼šRocketMQå°†æ¶ˆæ¯æŠ•é€’ç»™æ¶ˆæ¯æ¶ˆè´¹è€…ï¼ˆ3. æŠ•é€’æ¶ˆæ¯ï¼‰ï¼Œæ¶ˆæ¯æ¶ˆè´¹è€…é¦–å…ˆéœ€è¦è¿›è¡Œå¹‚ç­‰æ€§æ£€æŸ¥ï¼Œé€šè¿‡æ£€æŸ¥åæ‰§è¡Œæœ¬åœ°äº‹åŠ¡çš„ä¸šåŠ¡é€»è¾‘ï¼Œæœ€åè¿”å›æ‰§è¡Œç»“æœï¼ˆ4. Ackï¼‰\n- **æ–¹æ¡ˆå…­**ï¼šåŸºäºæ¶ˆæ¯è¡¥å¿æœºåˆ¶æ¥å®ç°\n\n<div style=\"text-align: center;\">\n  <img src=\"../img/netease/97457e7c70edc79df86acdf29075d74.png\" alt=\"åŸºäºæ¶ˆæ¯è¡¥å¿æœºåˆ¶æ¥å®ç°\">\n</div>\n\n- æ­¥éª¤ä¸€ï¼šåœ¨åŒä¸€ä¸ªæœ¬åœ°äº‹åŠ¡ä¸­æ‰§è¡Œä¸šåŠ¡é€»è¾‘ä¸­çš„æ•°æ®åº“æ“ä½œå’Œæ–°å¢æ¶ˆæ¯è¡¥å¿è®°å½•ï¼ˆ1. Prepare: æ–°å¢è®°å½•ï¼‰\n- æ­¥éª¤äºŒï¼šæœ¬åœ°äº‹åŠ¡æäº¤åï¼Œå¯åŠ¨å¼‚æ­¥çº¿ç¨‹ï¼Œå‘RocketMQå‘é€æ¶ˆæ¯ï¼ˆ2. å‘é€æ¶ˆæ¯ï¼‰ï¼Œæ¶ˆæ¯å‘é€æˆåŠŸååˆ é™¤æ¶ˆæ¯è¡¥å¿è®°å½•ï¼ˆ3. Confirm: åˆ é™¤è®°å½•ï¼‰\nå¦‚æœå› æ–­ç½‘æˆ–è€…åº”ç”¨é‡å¯ç­‰åŸå› ï¼Œå‘é€æ¶ˆæ¯å¤±è´¥æˆ–è€…æœªæˆåŠŸåˆ é™¤æ¶ˆæ¯è¡¥å¿è®°å½•ï¼Œæ¶ˆæ¯ç”Ÿäº§è€…ä¼šå®šæ—¶è§¦å‘æ¶ˆæ¯è¡¥å¿ï¼Œç¡®ä¿å‘é€åˆ°RocketMQçš„æ¶ˆæ¯è‡³å°‘å‘é€ä¸€æ¬¡ï¼ˆat least onceç­–ç•¥ï¼ŒMQæœ‰å¯èƒ½å­˜åœ¨å¤šæ¡ç›¸åŒçš„æ¶ˆæ¯ï¼‰\n- æ­¥éª¤ä¸‰ï¼šRocketMQå°†æ¶ˆæ¯æŠ•é€’ç»™æ¶ˆæ¯æ¶ˆè´¹è€…ï¼ˆ4. æŠ•é€’æ¶ˆæ¯ï¼‰ï¼Œæ¶ˆæ¯æ¶ˆè´¹è€…é¦–å…ˆéœ€è¦è¿›è¡Œå¹‚ç­‰æ€§æ£€æŸ¥ï¼ˆé¿å…é‡å¤æ‰§è¡ŒåŒä¸€ä¸ªæ¶ˆæ¯ï¼‰ï¼Œé€šè¿‡æ£€æŸ¥åæ‰§è¡Œæœ¬åœ°äº‹åŠ¡çš„ä¸šåŠ¡é€»è¾‘ï¼Œæœ€åè¿”å›æ‰§è¡Œç»“æœï¼ˆ5. Ackï¼‰\n\nç»“åˆä¸šåŠ¡å®é™…æƒ…å†µï¼Œç”±äºRocketMQçš„äº‹åŠ¡æ¶ˆæ¯ç›¸æ¯”äºæ™®é€šæ¶ˆæ¯æ€§èƒ½ä¸Šè¿˜æ˜¯æœ‰ä¸å°çš„æŸå¤±ï¼Œæ— æ³•å®Œå…¨æ»¡è¶³æˆ‘ä»¬çš„æ€§èƒ½è¦æ±‚ï¼ˆæœåŠ¡å™¨è§„æ¨¡ä¸å˜çš„å‰æä¸‹ï¼‰ï¼Œå› æ­¤æˆ‘ä»¬æœ€ç»ˆé€‰æ‹©äº†å®ç°ä¸Šæ›´åŠ å¤æ‚çš„æ–¹æ¡ˆå…­ã€‚\n\n## 2.2.4 ç¡¬ä»¶å‡çº§åŠèµ„æºä¼˜åŒ–\nç¡¬ä»¶çš„æ€§èƒ½å’Œèµ„æºåˆ©ç”¨ç‡åŒæ ·ä¹Ÿæ˜¯æˆ‘ä»¬æ€§èƒ½ä¼˜åŒ–è¿‡ç¨‹ä¸­éœ€è¦å…³æ³¨çš„åœ°æ–¹ï¼Œå¦‚æœæˆ‘ä»¬æŠŠä¸åŒçš„åº”ç”¨æ¯”å–»æˆå†›é˜Ÿä¸­ä¸åŒçš„å…µç§ï¼Œé‚£ä¹ˆç¡¬ä»¶å°±ç»™ä¸åŒå…µç§é…ç½®çš„è£…å¤‡ï¼Œåªæœ‰åˆç†æ­é…ï¼Œè¿™äº›è£…å¤‡æ‰èƒ½æœ€å¤§ç¨‹åº¦æå‡å„å…µç§çš„æˆ˜æ–—åŠ›ï¼Œè€Œåˆç†æ­é…è£…å¤‡çš„åº•å±‚é€»è¾‘ï¼Œæ˜¯å¯¹èµ„æºçš„æœ€å¤§åŒ–åˆ©ç”¨ã€é¿å…æµªè´¹ã€‚\n\näº‹å®ä¸Šï¼Œèµ„æºç­¹å¤‡å·¥ä½œå¾€å¾€æ˜¯å…ˆäºäº§å“å¼€å‘å·¥ä½œå¼€å±•çš„ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬çš„æ€§èƒ½ä¼˜åŒ–å·¥ä½œåœ¨ç»å¤§éƒ¨åˆ†æ—¶å€™æ˜¯åœ¨èµ„æºä¸å˜çš„å‰æä¸‹è¿›è¡Œçš„ã€‚ä¸ºäº†åˆ©ç”¨å¥½è¿™äº›èµ„æºï¼Œé€šå¸¸æˆ‘ä»¬éœ€è¦è§£å†³ä»¥ä¸‹ä¸‰ä¸ªé—®é¢˜ï¼š\n\n1. **èµ„æºç­¹å¤‡é˜¶æ®µ**ï¼šå¦‚ä½•å‡†ç¡®åœ°é¢„ä¼°éœ€è¦çš„èµ„æºï¼Ÿ\n\n2. **åº”ç”¨æ¶æ„**ï¼šä»å·²çŸ¥çš„ä¸šåŠ¡ä¿¡æ¯ä¸­åˆ†ç¦»å‡ºä¸å˜çš„éƒ¨åˆ†å’Œå˜åŒ–çš„éƒ¨åˆ†ï¼Œè¾“å‡ºå…¨å±€åº”ç”¨æ¶æ„å’Œç³»ç»Ÿåº”ç”¨æ¶æ„ï¼ˆåŒ…å«åº”ç”¨åŠå…¶ä¾èµ–é¡¹ï¼‰ï¼Œä¸€èˆ¬è€Œè¨€ï¼Œä¸­åå°åº”ç”¨ä¸å˜çš„éƒ¨åˆ†æ›´å¤šå®¹æ˜“é¢„ä¼°ï¼Œå‰å°åº”ç”¨ä¸ç¡®å®šæ€§é«˜ä¹Ÿæ›´éš¾é¢„ä¼°ï¼Œä½†éšç€éœ€æ±‚é€æ¸æ˜æœ—ï¼ˆé€æ­¥è¿›å…¥äº§å“ç ”å‘é˜¶æ®µã€äº§å“è¿è¥é˜¶æ®µåï¼‰ï¼ŒåŠ ä¸Šæœ‰æ›´å¤šçš„æµ‹è¯•æ•°æ®ï¼Œé¢„ä¼°ä¹Ÿä¼šè¶Šæ¥è¶Šå‡†ç¡®ï¼Œå› æ­¤ï¼Œåº”ç”¨æ¶æ„åº”ä¿æŒæŒç»­æ¼”è¿›ä»¥æ›´å¥½åœ°å˜æ¸…ä¾èµ–å…³ç³»åŠèµ„æºéœ€æ±‚\n\n3. **éƒ¨ç½²æ¶æ„åŠèµ„æºæ¸…å•**ï¼šå°†åº”ç”¨æ¶æ„æ˜ å°„æˆéƒ¨ç½²æ¶æ„æ˜¯èµ„æºé¢„ä¼°çš„é‡è¦æ­¥éª¤ï¼Œè¿™ä¸ªé˜¶æ®µä¸€èˆ¬è¿˜æ²¡æœ‰åŠæ³•è¾“å‡ºå®Œæ•´çš„æµé‡æ¨¡å‹ï¼Œä½†æ¶æ„å¸ˆå¯ä»¥å€ŸåŠ©ä¸šåŠ¡é¢„åˆ¤ï¼ˆå¦‚ä»€ä¹ˆæ ·çš„ä¸šåŠ¡å½¢æ€ã€å¤šå°‘ç”¨æˆ·å‚ä¸ç­‰ï¼‰æ‹†è§£å‡ºæ ¸å¿ƒåŸŸçš„å‰ç«¯å…¥å£æµé‡ï¼ˆå¦‚ç”³è´­æµé‡ã€äº¤æ˜“æµé‡ï¼‰ï¼Œå„ä¸ªåŸŸå†é€å±‚æ‹†è§£åˆ°å„ä¸ªåº”ç”¨ï¼Œæœ€ç»ˆæ˜ å°„å‡ºèµ„æºæ¸…å•ï¼ˆä¹Ÿå°±æ˜¯ç¬¬ä¸€ç‰ˆèµ„æºæ¸…å•ï¼‰ï¼Œä¸éš¾æƒ³è±¡ï¼Œè¦æå‡è¿™ä¸ªé˜¶æ®µèµ„æºé¢„ä¼°å‡†ç¡®æ€§éå¸¸å›°éš¾ï¼Œéœ€è¦ä¸šåŠ¡æ–¹ã€å¼€å‘å›¢é˜Ÿã€è¿ç»´å›¢é˜Ÿç´§å¯†ååŒï¼Œä¸šåŠ¡è¾“å…¥è¶Šå……åˆ†é¢„ä¼°ä¼šè¶Šå‡†ç¡®ï¼Œåº”ç”¨æ¶æ„è®¾è®¡è¶Šå®Œæ•´é¢„ä¼°ä¼šè¶Šå‡†ç¡®\n\näº§å“ç ”å‘é˜¶æ®µï¼šå¦‚ä½•ç»“åˆåº”ç”¨ç‰¹æ€§åˆç†åœ°æ­é…å’Œä½¿ç”¨èµ„æºï¼Ÿ\n\né€šå¸¸SREä¼šå®šä¹‰å‡ºä¸åŒçš„èµ„æºè§„æ ¼ä¾›å„ç±»åº”ç”¨é€‰æ‹©ï¼š\n- **CPUæ€§èƒ½**ï¼šCPUæ€§èƒ½å¯¹äºè®¡ç®—å¯†é›†å‹ä»»åŠ¡éå¸¸é‡è¦ï¼Œåº”ç”¨å¦‚æœéœ€è¦å¤§é‡è®¡ç®—ï¼Œéœ€è¦é…ç½®é«˜æ€§èƒ½çš„CPU\n- **å†…å­˜å®¹é‡**ï¼šå†…å­˜å®¹é‡å¯¹äºæ•°æ®å¯†é›†å‹åº”ç”¨å’Œéœ€è¦ç¼“å­˜å¤§é‡æ•°æ®çš„åº”ç”¨è‡³å…³é‡è¦ï¼Œè¶³å¤Ÿçš„å†…å­˜å¯ä»¥å‡å°‘å¯¹ç£ç›˜æˆ–ç½‘ç»œçš„è®¿é—®ï¼Œæé«˜æ€§èƒ½\n- **å­˜å‚¨**ï¼šå­˜å‚¨é…ç½®å–å†³äºæ•°æ®é‡å’Œæ€§èƒ½éœ€æ±‚ï¼Œä½¿ç”¨é«˜æ€§èƒ½å›ºæ€ç¡¬ç›˜ï¼ˆSSDï¼‰å¯ä»¥æé«˜æ•°æ®è¯»å†™é€Ÿåº¦\n- **ç½‘ç»œå¸¦å®½**ï¼š å¦‚æœåº”ç”¨éœ€è¦å¤§é‡çš„æ•°æ®ä¼ è¾“ï¼Œç½‘ç»œå¸¦å®½æ˜¯ä¸€ä¸ªç“¶é¢ˆï¼Œä¸€èˆ¬è´Ÿè½½å‡è¡¡è®¾å¤‡ã€åº”ç”¨ç½‘å…³ã€CDNéœ€è¦é‡ç‚¹è€ƒè™‘\n- **å®¹é‡è§„åˆ’ä¸æµé‡æ¨¡å‹è®¾è®¡**ï¼šè¿™ä¸ªé˜¶æ®µéœ€æ±‚å·²ç»éå¸¸æ˜ç¡®ï¼Œå¯ä»¥åŸºäºåœºæ™¯åŠæœ€æ–°çš„åº”ç”¨æ¶æ„è¿›è¡Œæ›´ä¸ºç»†è‡´çš„æµé‡æ‹†è§£ï¼Œè¯„ä¼°å‡ºæ¯ä¸ªç³»ç»Ÿï¼ˆå°¤å…¶æ˜¯æ ¸å¿ƒç³»ç»Ÿï¼‰çš„å®¹é‡è¦æ±‚åŠèµ„æºæ¸…å•ï¼Œå¹¶é€šè¿‡å‹æµ‹è¿›è¡ŒéªŒè¯ï¼Œç¡®ä¿ç³»ç»Ÿåœ¨å„ç§è´Ÿè½½æƒ…å†µä¸‹éƒ½èƒ½å¤Ÿæ­£å¸¸è¿è¡Œ\n- **äº§å“è¿è¥é˜¶æ®µ**ï¼šå¦‚ä½•æœ€å¤§åŒ–åœ°åˆ©ç”¨å¥½ç°æœ‰çš„èµ„æºï¼Ÿ\n- **èµ„æºè¶…å”®æˆ–æ··éƒ¨**ï¼šä¸€èˆ¬å¯ä»¥é€šè¿‡äº‘å‚å•†æä¾›çš„èµ„æºè¶…å”®èƒ½åŠ›æˆ–è€…ç ”å‘å›¢é˜Ÿä¸»åŠ¨å‘èµ·åº”ç”¨æ··éƒ¨æ¥æé«˜èµ„æºåˆ©ç”¨ç‡ï¼Œç„¶è€Œè¿™å´æ˜¯æŠŠåŒåˆƒå‰‘ï¼Œæ›´é«˜çš„èµ„æºåˆ©ç”¨ç‡ä¹Ÿå°±æ„å‘³ç€æ›´ä½çš„èµ„æºå®¹é”™ç‡ï¼Œä¸€æ—¦å‡ºç°é¢„æœŸä¹‹å¤–çš„æµé‡æˆ–è€…èµ„æºå ç”¨ï¼Œå¾ˆå®¹æ˜“æˆä¸ºå‹å®ç³»ç»Ÿçš„æœ€åä¸€æ ¹ç¨»è‰\n- **ç¡¬ä»¶å‡çº§åŠèµ„æºä¼˜åŒ–**ï¼šé€šè¿‡è¯Šæ–­å·¥å…·è¯†åˆ«åœ¨å‹æµ‹æˆ–äº§å“è¿è¥è¿‡ç¨‹ä¸­å‡ºç°çš„èµ„æºå¼‚å¸¸ï¼Œå¦‚CPUä½¿ç”¨ç‡æˆ–Loadä¸å‡è¡¡ã€I/Oå»¶è¿Ÿå¤§ã€å†…å­˜ä½¿ç”¨ç‡é«˜ç­‰ç‰¹å¾\n\n## 2.3 å°ç»“\næ€§èƒ½ä¼˜åŒ–æ˜¯äº§å“è®¾è®¡ã€ç ”å‘å’Œè¿è¥è¿‡ç¨‹ä¸­çš„ä¸€ä¸ªæå…¶é‡è¦çš„ç¯èŠ‚ï¼Œé€šè¿‡æ€§èƒ½ä¼˜åŒ–å¯ä»¥ç¡®ä¿æˆ‘ä»¬çš„ç³»ç»Ÿæ»¡è¶³æ€§èƒ½è®¾è®¡ç›®æ ‡ã€‚é€šå¸¸æˆ‘ä»¬éœ€è¦å…ˆå€ŸåŠ©æ€§èƒ½è¯Šæ–­å·¥å…·è¯†åˆ«æ€§èƒ½ç“¶é¢ˆï¼Œç„¶åç»“åˆå®é™…æƒ…å†µç»¼åˆé€‰æ‹©ä¸€ç§æˆ–è€…å¤šç§æ€§èƒ½ä¼˜åŒ–ç­–ç•¥ã€‚\n\nä½†éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œè¿‡æ—©çš„ä¼˜åŒ–å¯èƒ½ä¼šå¼•å…¥ä¸å¿…è¦çš„ä»£ç å¤æ‚æ€§è€Œæ€§èƒ½å´æœªå¿…æ”¹å–„ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬å»ºè®®åœ¨ç³»ç»Ÿå¼€å‘çš„æ—©æœŸé˜¶æ®µåº”æ›´ä¾§é‡äºä¿æŒä»£ç çš„å¯ç»´æŠ¤æ€§å’Œå¯è¯»æ€§ï¼Œéšç€ç³»ç»Ÿçš„æŒç»­æ¼”è¿›ï¼Œå†åŸºäºæ€§èƒ½è¯Šæ–­ç»“æœå¯¹ä»£ç è¿›è¡Œé’ˆå¯¹æ€§åœ°ä¼˜åŒ–ä»¥æ»¡è¶³æ€§èƒ½éœ€æ±‚ã€‚\n\n## 3 å®ç°é«˜å¯ç”¨çš„ä¸»è¦ç­–ç•¥\né«˜æ€§èƒ½å¹¶ä¸æ„å‘³ç€é«˜å¯ç”¨ï¼Œæœ‰äº›æå‡æ€§èƒ½çš„æ‰‹æ®µä¼šå¢åŠ ç³»ç»Ÿè´Ÿè½½ï¼Œåè€Œè¿˜ä¼šé™ä½å¯ç”¨æ€§ï¼Œè€Œä¸ºäº†å®ç°ç³»ç»Ÿçš„é«˜å¯ç”¨ï¼Œæˆ‘ä»¬é€šå¸¸éœ€è¦å¼•å…¥ä¸€äº›å¤æ‚æ€§æˆ–å†—ä½™ï¼Œå¯èƒ½è¿˜ä¼šå¯¹æ€§èƒ½äº§ç”Ÿä¸€å®šè´Ÿé¢å½±å“ã€‚\n\næœ¬ç« èŠ‚ä¼šé‡ç‚¹æ¢è®¨ä¸€ä¸‹åœ¨ç³»ç»Ÿæ¶æ„å’Œè®¾è®¡é˜¶æ®µå¦‚ä½•è€ƒè™‘å¯ç”¨æ€§ç›®æ ‡ã€‚\n\n## 3.1 é¢å‘å¤±è´¥çš„è®¾è®¡\nä»»ä½•æœåŠ¡å’Œç»„ä»¶éƒ½ä¸æ˜¯100%å¯é çš„ï¼Œå› æ­¤æ ¸å¿ƒç³»ç»Ÿçš„è®¾è®¡å»ºè®®é¢å‘å¤±è´¥è¿›è¡Œè®¾è®¡ï¼Œå³ç¡®ä¿åœ¨éƒ¨åˆ†ç»„ä»¶æˆ–æœåŠ¡æ•…éšœæ—¶ä»ç„¶èƒ½å¤Ÿç»§ç»­æä¾›æœåŠ¡ï¼Œæ¯”å¦‚å‰æ–‡æåˆ°çš„ç”³è´­åœºæ™¯å’Œçˆ†æ¬¾æŠ¢è´­åœºæ™¯éƒ½ä½¿ç”¨äº†è¿™ä¸€è®¾è®¡ç†å¿µã€‚\n\nè¿™é‡Œæˆ‘ä»¬æ€»ç»“ä¸‹å‡ ç§å¸¸ç”¨çš„ç­–ç•¥ï¼š\n- **æœ€å°åŒ–ä¾èµ–**ï¼šè¦å‡å°‘å¯¹å¤–éƒ¨æœåŠ¡å’Œç»„ä»¶çš„ä¾èµ–ï¼Œç‰¹åˆ«æ˜¯å‡å°‘å¼ºä¾èµ–ï¼Œä»è€Œé™ä½æ•…éšœä¼ æ’­çš„é£é™©\n- **å†—ä½™å’Œå¤‡ä»½**ï¼šé€šè¿‡å¼•å…¥å†—ä½™ç»„ä»¶æˆ–å¤‡ä»½ç³»ç»Ÿï¼Œåœ¨ä¸»è¦ç»„ä»¶æ•…éšœæ—¶å¯ä»¥æ— ç¼åˆ‡æ¢åˆ°å¤‡ç”¨ç»„ä»¶ï¼Œä»è€Œç¡®ä¿æœåŠ¡çš„è¿ç»­æ€§ï¼Œéœ€è¦ç‰¹åˆ«é‡è§†çš„æ˜¯ï¼Œå…³é”®ç»„ä»¶è¦é¿å…å•ç‚¹\n- **è‡ªåŠ¨æ•…éšœæ£€æµ‹å’Œæ¢å¤**ï¼šä½¿ç³»ç»Ÿèƒ½å¤Ÿä¸»åŠ¨æ£€æµ‹æ•…éšœæˆ–å¼‚å¸¸æƒ…å†µï¼Œå¹¶é‡‡å–è‡ªåŠ¨åŒ–æªæ–½ä»¥æ¢å¤æ­£å¸¸è¿è¡Œï¼Œé€šè¿‡è¿™ç§æ–¹å¼å¯ä»¥å‡å°‘å¯¹äººå·¥å¹²é¢„çš„ä¾èµ–ï¼Œä»è€Œæ›´å¿«åœ°å“åº”é—®é¢˜ï¼Œé™ä½æœåŠ¡ä¸­æ–­çš„é£é™©\n- **è¶…æ—¶ä¸é‡è¯•**ï¼šåœ¨ç½‘ç»œé€šä¿¡ä¸­ï¼Œè®¾ç½®é€‚å½“çš„è¶…æ—¶æ—¶é—´ï¼Œä»¥é˜²æ­¢è¯·æ±‚æŒ‚èµ·ï¼›ä½¿ç”¨é‡è¯•æœºåˆ¶ç¡®ä¿è¯·æ±‚çš„å¯é æ€§ï¼›ç»“åˆåˆç†çš„é€€é¿ç­–ç•¥ï¼Œé¿å…è¿‡åº¦é‡è¯•å¯¼è‡´æœåŠ¡å™¨è´Ÿè½½è¿‡é«˜\n- **é™æµä¸é™çº§**ï¼šå®æ–½é™æµç­–ç•¥ï¼Œæ§åˆ¶è¯·æ±‚æµé‡ä»¥é˜²æ­¢ç³»ç»Ÿè¿‡è½½ï¼Œåœ¨é«˜è´Ÿè½½æˆ–æ•…éšœæ—¶é™çº§éƒ¨åˆ†åŠŸèƒ½ï¼Œä¿æŒæ ¸å¿ƒåŠŸèƒ½çš„å¯ç”¨æ€§\n- **ç›‘æ§ä¸æŠ¥è­¦**ï¼šå»ºç«‹ç›‘æ§ç³»ç»Ÿï¼Œå®æ—¶è¿½è¸ªç³»ç»Ÿæ€§èƒ½å’Œå¥åº·çŠ¶æ€ï¼Œè®¾ç½®æŠ¥è­¦è§„åˆ™ä»¥åœ¨é—®é¢˜å‘ç”Ÿæ—¶åŠæ—¶é€šçŸ¥è¿ç»´å›¢é˜Ÿé‡‡å–è¡ŒåŠ¨\n- **åº”æ€¥é¢„æ¡ˆ**ï¼šåˆ¶å®šåº”æ€¥é¢„æ¡ˆï¼Œåœ¨ç³»ç»Ÿæ•…éšœæˆ–ç´§æ€¥æƒ…å†µä¸‹å¿«é€Ÿé‡‡å–è¡ŒåŠ¨ä»¥è¾¾åˆ°æœ€å¤§é™åº¦ä¿æŠ¤ç³»ç»Ÿçš„ç›®çš„ï¼ŒåŒ…æ‹¬é™ä½ç³»ç»Ÿè´Ÿè½½ã€æ•…éšœæ­¢è¡€ä¸æ¢å¤ã€æ•°æ®å¤‡ä»½ç­‰ç­‰\n\n## 3.2 å¾®æœåŠ¡æ¶æ„\nå¾®æœåŠ¡æ¶æ„æ˜¯ä¸€ç§å…¸å‹çš„å®¹é”™æ¶æ„ï¼Œç”±äºã€ŒièŒ…å°ã€å•†åŸåœ¨è®¾è®¡é˜¶æ®µå·²ç»æ˜ç¡®äº†ä¸šåŠ¡æ¨¡å¼å’Œæµé‡æŒ‘æˆ˜ï¼Œå› æ­¤æˆ‘ä»¬æ²¡æœ‰åƒä¸¥é€‰æ—©æœŸé‚£æ ·é‡‡ç”¨å•ä½“æ¶æ„å¿«é€Ÿä¸Šçº¿ï¼Œè€Œæ˜¯ç›´æ¥é‡‡ç”¨å¾®æœåŠ¡æ¶æ„è¿›è¡Œè®¾è®¡ï¼ŒåŸºç¡€è®¾æ–½åˆ™å¤ç”¨äº†ä¸¥é€‰çš„Service Meshæ¶æ„ï¼ˆå‚è§ç½‘æ˜“ä¸¥é€‰ServiceMeshå®è·µï¼‰ï¼Œç›¸æ¯”äºå•ä½“æ¶æ„åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢å…·æœ‰æ˜æ˜¾ä¼˜åŠ¿ï¼š\n- **æ•…éšœéš”ç¦»**ï¼šå¾®æœåŠ¡æ¶æ„å°†ä¸€ä¸ªåº”ç”¨ç¨‹åºè¢«æ‹†åˆ†æˆä¸€ç»„å°å‹ã€ç‹¬ç«‹çš„æœåŠ¡ï¼Œæ¯ä¸ªæœåŠ¡éƒ½ä¸“æ³¨äºæ‰§è¡Œç‰¹å®šçš„ä¸šåŠ¡åŠŸèƒ½ï¼Œå½“ä¸€ä¸ªæœåŠ¡å‘ç”Ÿæ•…éšœæ—¶ï¼Œä¸ä¼šå½±å“å…¶ä»–æœåŠ¡çš„æ­£å¸¸è¿è¡Œï¼Œä»è€Œå‡å°äº†æ•…éšœçš„ä¼ æ’­èŒƒå›´ï¼Œæé«˜äº†æ•´ä½“ç³»ç»Ÿçš„å¯ç”¨æ€§\n- **æ°´å¹³æ‰©å±•**ï¼šå¾®æœåŠ¡æ¶æ„ä½¿å¾—æ¯ä¸ªæœåŠ¡å¯ä»¥ç‹¬ç«‹åœ°è¿›è¡Œæ°´å¹³æ‰©å±•ï¼Œå¯ä»¥æ ¹æ®éœ€æ±‚å¢åŠ æˆ–å‡å°‘æœåŠ¡å®ä¾‹çš„æ•°é‡ï¼Œä»¥æ»¡è¶³ä¸åŒçš„è´Ÿè½½è¦æ±‚ï¼Œä»è€Œæé«˜äº†ç³»ç»Ÿçš„å¼¹æ€§å’Œå¯ç”¨æ€§\n- **å¿«é€Ÿæ•…éšœæ¢å¤**ï¼šå¾®æœåŠ¡æ¶æ„å…·å¤‡è‡ªåŠ¨æ•…éšœæ£€æµ‹å’Œåˆ‡æ¢æœºåˆ¶ï¼Œç³»ç»Ÿèƒ½å¤Ÿåœ¨æ£€æµ‹åˆ°æ•…éšœæ—¶è‡ªåŠ¨å°†æµé‡åˆ‡æ¢åˆ°å…¶ä»–æœåŠ¡å®ä¾‹ï¼Œä»è€Œå®ç°å¿«é€Ÿæ•…éšœæ¢å¤ï¼Œå‡å°‘äº†æœåŠ¡ä¸­æ–­çš„æ—¶é—´\n- **åˆ†å¸ƒå¼éƒ¨ç½²**ï¼šå¾®æœåŠ¡æ¶æ„æ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½²ï¼ŒæœåŠ¡å¯ä»¥éƒ¨ç½²åœ¨ä¸åŒçš„æœåŠ¡å™¨ä¸Šï¼ˆç”šè‡³å¯ä»¥è·¨æ•°æ®ä¸­å¿ƒè¿›è¡Œéƒ¨ç½²ï¼‰ï¼Œè¿™æä¾›äº†æ›´é«˜çº§åˆ«çš„å®¹é”™æ€§ï¼Œé¿å…å•ç‚¹æ•…éšœ\n- **çµæ´»çš„æ›´æ–°å’Œç»´æŠ¤**ï¼šç”±äºæ¯ä¸ªæœåŠ¡éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œå¯ä»¥å•ç‹¬æ›´æ–°å’Œç»´æŠ¤ï¼Œè€Œä¸ä¼šå½±å“æ•´ä¸ªç³»ç»Ÿçš„å¯ç”¨æ€§ï¼Œè¿™é™ä½äº†ç»´æŠ¤å’Œæ›´æ–°è¿‡ç¨‹ä¸­çš„é£é™©ï¼Œå‡å°‘äº†ç³»ç»Ÿçš„åœæœºæ—¶é—´\n\næœ‰äº†åŸºç¡€æ¶æ„æä¾›çš„æœåŠ¡æ²»ç†èƒ½åŠ›åŠ æŒï¼Œå¼€å‘éœ€è¦åœ¨ç³»ç»Ÿè®¾è®¡å’Œå¼€å‘é˜¶æ®µé‡ç‚¹å…³æ³¨ä»¥ä¸‹å‡ ç‚¹æ–¹é¢ï¼š\n\n- **æœåŠ¡åˆ†çº§**ï¼šæœåŠ¡åˆ†çº§æ˜¯æœåŠ¡å…³è”çš„ä¸€ä¸ªæ ‡ç­¾ï¼Œå¯ä»¥åŒºåˆ†å‡ºæ¯ä¸ªæœåŠ¡å¯¹äºä¸šåŠ¡å½±å“çš„é‡è¦ç¨‹åº¦ï¼Œæˆ‘ä»¬è®¤ä¸ºæ¯ä¸ªæœåŠ¡éƒ½åº”è¯¥æœ‰å¯¹åº”çš„åˆ†çº§æ ‡ç­¾ï¼Œå®ƒå¯ä»¥è®©æˆ‘ä»¬æ›´æ¸…æ™°åœ°äº†è§£æœåŠ¡çš„å¯ç”¨æ€§ç›®æ ‡ä»¥åŠæœåŠ¡ä¹‹é—´çš„ä¾èµ–å…³ç³»æ˜¯å¦åˆç†\n\né€šå¸¸æ›´é«˜ç­‰çº§çš„æœåŠ¡åº”è¯¥åŒ¹é…æ›´é«˜ç­‰çº§çš„æœåŠ¡ä¿éšœï¼Œä¹Ÿåº”è¯¥å…·å¤‡æ›´é«˜çš„å¯ç”¨æ€§ï¼Œå› æ­¤ï¼Œè¦é¿å…é«˜ç­‰çº§çš„æœåŠ¡å¼ºä¾èµ–ä½ç­‰çº§çš„æœåŠ¡ï¼Œå¦åˆ™å®¹æ˜“é€ æˆé«˜ç­‰çº§çš„æœåŠ¡æ— æ³•è¾¾åˆ°æ—¢å®šçš„å¯ç”¨æ€§ç›®æ ‡\n- **æœåŠ¡ä¾èµ–**ï¼šç”±äºå¾®æœåŠ¡æ¶æ„ä¼šå°†æœåŠ¡æ‹†åˆ†æˆæ›´å°çš„å•å…ƒï¼Œè¿™å°±ä¸å¯é¿å…åœ°å¢åŠ äº†æœåŠ¡ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œé€šå¸¸æˆ‘ä»¬å¯ä»¥æ ¹æ®å¯¹æ•…éšœçš„å®¹å¿åº¦å°†ä¾èµ–å…³ç³»åŒºåˆ†ä¸ºå¼ºä¾èµ–å’Œå¼±ä¾èµ–ï¼Œåœ¨è®¾è®¡ä¸Šå»ºè®®éµå¾ªä»¥ä¸‹åŸåˆ™ï¼š\n- **å¼ºä¾èµ–å¼±åŒ–**ï¼šå¼ºä¾èµ–çš„æœåŠ¡åº”å½“å°½é‡å‡å°‘æˆ–å‡å¼±ï¼Œä»¥é™ä½æ•´ä¸ªç³»ç»Ÿä¸­æŸä¸ªæœåŠ¡çš„æ•…éšœå¯¹å…¶ä»–æœåŠ¡çš„å½±å“\n- **å¼±ä¾èµ–å¼‚æ­¥åŒ–**ï¼šå¼±ä¾èµ–çš„æœåŠ¡å¯ä»¥é‡‡ç”¨å¼‚æ­¥é€šä¿¡æ–¹å¼ï¼ˆå¦‚æ¶ˆæ¯é˜Ÿåˆ—ï¼‰ï¼Œä»¥é™ä½å¯¹ä¾èµ–æœåŠ¡çš„ç›´æ¥è°ƒç”¨ï¼Œæé«˜ç³»ç»Ÿçš„å¼¹æ€§å’Œå“åº”æ€§\n- **è¶…æ—¶æ²»ç†**ï¼šè¶…æ—¶æ²»ç†æ˜¯é€šè¿‡ä¼˜åŒ–è¶…æ—¶æ—¶é—´ä¸é‡è¯•ç­–ç•¥ï¼Œä½¿å°½å¯èƒ½å¤šçš„è¯·æ±‚èƒ½å¤Ÿåœ¨é¢„æœŸæ—¶é—´å†…å¾—åˆ°æ­£å¸¸å“åº”ï¼Œæé«˜ç³»ç»Ÿçš„å“åº”æ€§ï¼Œæ˜¯ä¸€ç§é‡è¦çš„æœåŠ¡æ²»ç†æ‰‹æ®µ\n\nè¶…æ—¶æ—¶é—´çš„è®¾ç½®åº”å……åˆ†è€ƒè™‘ä¸šåŠ¡æœ¬èº«çš„å¤æ‚æ€§å’Œé¢„æœŸå“åº”æ—¶é—´ï¼Œåº”è®¾ç½®è¶³å¤Ÿé•¿ä»¥å®¹å¿æ­£å¸¸çš„å“åº”å»¶è¿Ÿï¼Œä½†ä¹Ÿä¸èƒ½è¿‡é•¿é¿å…æ— é™æœŸæŒ‚èµ·ç­‰å¾…\n\nå“åº”è¶…æ—¶å¹¶ä¸ä¸€å®šæ„å‘³ç€ç›®æ ‡æœåŠ¡å·²ç»ä¸èƒ½å·¥ä½œï¼Œé€šè¿‡åˆç†çš„é‡è¯•æœºåˆ¶ï¼Œå³ä½¿åœ¨ç›®æ ‡æœåŠ¡å™¨æˆ–ç½‘ç»œæ•…éšœçš„æƒ…å†µä¸‹ä¹Ÿèƒ½å¤ŸæˆåŠŸå®Œæˆè¯·æ±‚ï¼Œä½†è¦ç¡®ä¿è¯·æ±‚çš„å¹‚ç­‰æ€§ï¼Œé¿å…é‡è¯•è¯·æ±‚å¯¹ä¸šåŠ¡äº§ç”Ÿè´Ÿé¢å½±å“\n\nè®¾è®¡åˆç†çš„é€€é¿ç­–ç•¥ï¼ˆå¦‚æŒ‡æ•°é€€é¿ï¼‰ï¼Œé¿å…è¿ç»­é‡è¯•å¯¼è‡´æœåŠ¡å™¨è´Ÿè½½è¿‡é«˜ï¼Œå¦å¤–ï¼Œé‡è¯•æ¬¡æ•°ä¹Ÿåº”è¯¥æœ‰é™ï¼Œé¿å…æ— é™é‡è¯•\n\nåœ¨æ”¾å¼ƒè¯·æ±‚åï¼Œç³»ç»Ÿå¯èƒ½é‡‡ç”¨é™çº§ç­–ç•¥ï¼Œæä¾›æœ‰é™çš„æœåŠ¡ï¼Œä»¥ç¡®ä¿æ ¸å¿ƒåŠŸèƒ½çš„å¯ç”¨æ€§\n\n- **é™æµç­–ç•¥**ï¼šé™æµæ˜¯ä¸€ç§é€šè¿‡æ§åˆ¶è¯·æ±‚æµé‡ä»¥é˜²æ­¢ç³»ç»Ÿè¿‡è½½çš„ç­–ç•¥ï¼Œä¹Ÿæ˜¯ä¸€ç§éå¸¸é‡è¦çš„æœåŠ¡æ²»ç†æ‰‹æ®µ\n\né™æµä¼šå¸¦æ¥ä¸€å®šçš„æ€§èƒ½æŸè€—ï¼Œæˆ‘ä»¬å€ŸåŠ©åº”ç”¨ç½‘å…³ä¸é™æµä¸­é—´ä»¶å®ç°å¯¹æµå…¥ç½‘å…³åŠä¸šåŠ¡ç³»ç»Ÿçš„æµé‡è¿›è¡Œé™åˆ¶ï¼Œå„ä¸ªç³»ç»Ÿéœ€ç»“åˆæœåŠ¡ç­‰çº§ã€é¢„ä¼°æµé‡åŠåº”ç”¨å½“å‰èƒ½åŠ›é€‰æ‹©æ˜¯å¦å¼€å¯\n\né™æµå€¼çš„è®¾ç½®åº”å……åˆ†è€ƒè™‘åº”ç”¨è‡ªèº«çš„èƒ½åŠ›ï¼Œç”±äºç³»ç»Ÿæ¼”è¿›è¿‡ç¨‹ä¸­çš„ç†µå¢æ˜¯ä¸€ç§ä¸å¯é¿å…çš„è¶‹åŠ¿ï¼Œå»ºè®®é™æµå€¼è®¾ç½®æ—¶ä¿æŒä¸€å®šçš„ä½™é‡ï¼Œä»¥æœ€å¤§é™åº¦ä¸ºç³»ç»Ÿæä¾›æœ‰æ•ˆä¿æŠ¤\n\né™æµç­–ç•¥ä¸Šå¯ä»¥ä¸ºæ¯ä¸ªæœåŠ¡æˆ–æ¥å£è®¾ç½®æœ€å¤§è¯·æ±‚é€Ÿç‡ï¼Œä¹Ÿå¯ä»¥è¿›ä¸€æ­¥åŸºäºæ—¶é—´æ®µã€ç”¨æˆ·ã€IPåœ°å€ç­‰å› ç´ è¿›è¡Œç»†åŒ–\n\n- **é™çº§ç­–ç•¥**ï¼šé™çº§ç­–ç•¥æ˜¯ä¸€ç§åº”å¯¹ç³»ç»Ÿè´Ÿè½½è¿‡é«˜æˆ–æ•…éšœçš„ç­–ç•¥ï¼Œé€šè¿‡ç‰ºç‰²éå…³é”®åŠŸèƒ½ä»¥ä¿æŒæ ¸å¿ƒåŠŸèƒ½çš„æ­£å¸¸è¿è¡Œ\n- **ä¸»åŠ¨é™çº§**ï¼šç³»ç»Ÿåœ¨ç›‘æµ‹åˆ°ä¸€å®šæ¡ä»¶æˆ–é¢„è®¾çš„è§„åˆ™è§¦å‘ä¸‹ï¼Œè‡ªåŠ¨æ‰§è¡Œé™çº§ç­–ç•¥ï¼ŒåŒ…æ‹¬è‡ªåŠ¨å…³é—­éå…³é”®åŠŸèƒ½ã€æ‹’ç»æŸäº›è¯·æ±‚ã€å‡å°‘èµ„æºåˆ†é…ç­‰\n- **æ‰‹åŠ¨é™çº§**ï¼šè¿ç»´äººå‘˜æˆ–å¼€å‘äººå‘˜æ‰‹åŠ¨ä»‹å…¥æ‰§è¡Œé™çº§ç­–ç•¥ä»¥åº”å¯¹ç‰¹å®šçš„é—®é¢˜æˆ–å¼‚å¸¸æƒ…å†µï¼Œé€šå¸¸éƒ½æ˜¯åº”å¯¹å·²çŸ¥çš„é—®é¢˜æˆ–ç´§æ€¥æƒ…å†µï¼ŒåŸºäºé¢„æ¡ˆè¿›è¡Œæ“ä½œ\n- **ç†”æ–­ç­–ç•¥**ï¼šå½“ä¸€ä¸ªæœåŠ¡åœ¨ä¸€æ®µæ—¶é—´å†…å‡ºç°è¿ç»­çš„å¤±è´¥ï¼Œç†”æ–­ç­–ç•¥ä¼šä¸­æ–­å¯¹è¯¥æœåŠ¡çš„è¯·æ±‚ï¼Œé¿å…å› é¢‘ç¹è¯·æ±‚å¤±è´¥è€Œå¯¼è‡´çš„èµ„æºæµªè´¹\n\n## 3.3 å®¢æˆ·ç«¯ï¼ˆAPPï¼‰å®¹é”™è®¾è®¡\nå®¢æˆ·ç«¯ï¼ˆAPPï¼‰ä½œä¸ºç”¨æˆ·è·å¾—äº§å“æœåŠ¡çš„ä¸»è¦å…¥å£ï¼Œä¹Ÿå¤§é‡ä½¿ç”¨äº†å®¹é”™è®¾è®¡ã€‚\n\nå®¹é”™è®¾è®¡å¯ä»¥æå‡å®¢æˆ·ç«¯æ•´ä½“çš„é²æ£’æ€§å’Œå¯ç”¨æ€§ï¼Œä»¥æ›´å¥½åœ°åº”å¯¹æœåŠ¡ç«¯æˆ–ç½‘ç»œç­‰å„ç§æ•…éšœå’Œå¼‚å¸¸æƒ…å†µï¼Œç¡®ä¿å®¢æˆ·ç«¯åœ¨é¢ä¸´è¿™äº›é—®é¢˜æ—¶ä»ç„¶èƒ½å¤Ÿæä¾›æœ‰é™çš„æœåŠ¡ï¼Œä¿æŒè‰¯å¥½çš„ç”¨æˆ·ä½“éªŒã€‚å› æ­¤ï¼Œå®¢æˆ·ç«¯çš„å®¹é”™è®¾è®¡å¾€å¾€ä¹Ÿå’Œäº§å“ç­–ç•¥æ¯æ¯ç›¸å…³ï¼Œè€Œä¸åŒçš„äº§å“ç­–ç•¥æœ€ç»ˆä¹Ÿä¼šå½±å“æŠ€æœ¯æ–¹æ¡ˆçš„é€‰æ‹©ï¼Œæ¯”å¦‚ï¼š\n1. é¦–é¡µæ— è®ºåœ¨å‡ºç°å“ªç±»å¼‚å¸¸éƒ½ä¸åº”è¯¥æŒ‚æ‰ï¼Œé‚£ä¹ˆï¼Œæˆ‘ä»¬åœ¨è®¾è®¡é˜¶æ®µå°±åº”è¯¥å……åˆ†è€ƒè™‘è¯·æ±‚å¤±è´¥ç­‰å¼‚å¸¸æƒ…å†µä¸‹å¦‚ä½•è¿›è¡Œå…œåº•å±•ç¤º\n2. å¤§æµé‡åœºæ™¯å¯èƒ½é‡åˆ°é™æµç­‰å¼‚å¸¸ï¼Œå¯ä»¥é€šè¿‡è®¾è®¡ç­‰å¾…é¡µé¢æˆ–è€…æ’é˜ŸåŠ¨ç”»é¿å…æµç¨‹ä¸­æ–­ï¼ˆæ¯”å¦‚æ“ä½œäº†ä¸€åŠè¿›å…¥é”™è¯¯é¡µé¢ï¼‰ã€å‡è½»ç”¨æˆ·ç­‰å¾…çš„ç„¦è™‘æ„Ÿ\n3. éšç€ç‰ˆæœ¬çš„æŒç»­è¿­ä»£ï¼Œæ—§ç‰ˆæœ¬APPçš„ç”¨æˆ·æ˜¯å¦è¿˜èƒ½æ­£å¸¸ä½¿ç”¨äº§å“æœåŠ¡\n\nè®¾è®¡æ˜ç¡®çš„å‰åç«¯äº¤äº’åè®®æœ‰åŠ©äºæ›´å¥½åœ°è§£å†³ä¸Šè¿°é—®é¢˜ï¼š\n- **é”™è¯¯å¤„ç†å’Œå®¹é”™æœºåˆ¶**ï¼šé€šè¿‡è§„å®šç»Ÿä¸€çš„é”™è¯¯ç å’Œé”™è¯¯ä¿¡æ¯ä¼ é€’æ–¹å¼ï¼Œä½¿APPèƒ½å¤Ÿæ•è·å’Œå¤„ç†å„ç§é”™è¯¯æƒ…å†µï¼ŒåŒ…æ‹¬ç½‘ç»œé”™è¯¯ã€æœåŠ¡ç«¯é”™è¯¯ã€æ•°æ®æ ¼å¼é”™è¯¯ç­‰ï¼Œè¿™æœ‰åŠ©äºå®¢æˆ·ç«¯å®ç°ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æ–¹æ³•ä»¥åº”å¯¹å„ç§å¼‚å¸¸æƒ…å†µ\n- **ç‰ˆæœ¬å…¼å®¹æ€§**ï¼šé€šè¿‡ç‰ˆæœ¬æ§åˆ¶ï¼Œå¯ä»¥ç¡®ä¿åœ¨æœåŠ¡ç«¯å‡çº§æˆ–ä¿®æ”¹æ¥å£æ—¶ä¸ä¼šå½±å“ç°æœ‰çš„APPç‰ˆæœ¬ï¼Œä¿æŒå…¼å®¹æ€§ï¼›ä¹Ÿå¯ä»¥é€šè¿‡ç‰ˆæœ¬æ§åˆ¶ï¼Œæé†’ç”¨æˆ·æˆ–è€…å¼ºåˆ¶ç”¨æˆ·å‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬çš„APP\n- **é€šä¿¡å®‰å…¨**ï¼šé€šè¿‡å®šä¹‰åŠ å¯†å’Œè®¤è¯è§„èŒƒï¼Œä»¥ç¡®ä¿é€šä¿¡çš„å®‰å…¨æ€§ï¼Œè¿™æœ‰åŠ©äºé˜²æ­¢æ•°æ®æ³„éœ²å’Œä¸­é—´äººæ”»å‡»ï¼Œæé«˜ç³»ç»Ÿçš„å¯é æ€§å’Œå®‰å…¨æ€§\n\n## 3.4 å…¨é“¾è·¯å‹æµ‹\nç±»ä¼¼ã€ŒièŒ…å°ã€è¿™æ ·å¤§å‹çš„ç”µå•†ç³»ç»Ÿï¼Œå…·æœ‰ä¸šåŠ¡åœºæ™¯å¤æ‚ã€æ ¸å¿ƒé“¾è·¯é•¿çš„ç‰¹ç‚¹ï¼Œé€šè¿‡ä¼ ç»Ÿçš„æµ‹è¯•æ–¹æ³•åœ¨æµ‹è¯•ç¯å¢ƒè¿›è¡Œå‹æµ‹ï¼Œå·²ç»éš¾ä»¥ç¡®ä¿ç³»ç»Ÿåœ¨é«˜è´Ÿè½½å’Œæç«¯åœºæ™¯ä¸‹çš„æ€§èƒ½ã€å¯ç”¨æ€§å’Œç¨³å®šæ€§äº†ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦å¼•å…¥å…¨é“¾è·¯å‹æµ‹ã€‚\n\nå…¨é“¾è·¯å‹æµ‹æ˜¯åœ¨ç”Ÿäº§ç¯å¢ƒä¸­åŸºäºçœŸå®çš„ä¸šåŠ¡åœºæ™¯æ¨¡æ‹Ÿç”¨æˆ·æ“ä½œå’Œæµé‡ï¼Œä»¥å¯¹æ•´æ¡ä¸šåŠ¡é“¾è·¯è¿›è¡Œå‹åŠ›æµ‹è¯•ï¼Œä»è€Œè¯†åˆ«æ½œåœ¨çš„æ€§èƒ½ç“¶é¢ˆæˆ–å¼‚å¸¸ï¼Œæœ‰åŠ©äºæˆ‘ä»¬åŠæ—¶å‘ç°å¹¶è§£å†³ï¼Œç¡®ä¿ç³»ç»Ÿçš„é«˜æ€§èƒ½ã€é«˜å¯ç”¨å’Œç¨³å®šæ€§ã€‚\n\nè¦å®ç°ç”Ÿäº§ç¯å¢ƒå…¨é“¾è·¯å¯å‹æµ‹ï¼Œé™¤äº†å‰æ–‡æåˆ°çš„APMã€æ—¥å¿—å¹³å°ç­‰ç›‘æ§è¯Šæ–­å·¥å…·ä¹‹å¤–ï¼Œè¿˜éœ€è¦å…·å¤‡ä»¥ä¸‹èƒ½åŠ›ï¼š\n- **å…¨é“¾è·¯æµé‡æ ‡è®°é€ä¼ èƒ½åŠ›**ï¼šé€šè¿‡å…¨é“¾è·¯æ”¯æŒå‹æµ‹æµé‡æ ‡è®°è¯†åˆ«å’Œä¼ é€’ï¼Œä½¿çº¿ä¸Šå…¨é“¾è·¯èƒ½åŒºåˆ†å‹æµ‹æµé‡å’ŒçœŸå®ç”¨æˆ·æµé‡ï¼Œä¿è¯åœ¨å¤§æµé‡å‹åŠ›æµ‹è¯•æ—¶ä¸ä¼šå¯¹çœŸå®ç”¨æˆ·ä½“éªŒä»¥åŠçœŸå®ç”¨æˆ·æ•°æ®é€ æˆå½±å“ï¼Œè§£å†³äº†å› ç¯å¢ƒå·®å¼‚é€ æˆå‹æµ‹ç»“æœä¸çœŸå®ï¼Œå¯ä»¥å……åˆ†éªŒè¯çº¿ä¸ŠæœåŠ¡åœ¨å¤§æµé‡ä¸‹çš„æ‰¿è½½èƒ½åŠ›\n- **æ•°æ®å­˜å‚¨è·¯ç”±**ï¼šä½¿æ•°æ®åº“ã€ç¼“å­˜ã€MQã€æ—¥å¿—ç­‰å­˜å‚¨ä»‹è´¨å¯ä»¥è¯†åˆ«å‹æµ‹æµé‡ï¼Œå°†å‹æµ‹äº§ç”Ÿçš„æ•°æ®ä¸çœŸå®ç”¨æˆ·æ•°æ®åˆ†å¼€ä¿å­˜ï¼Œå®ç°å­˜å‚¨éš”ç¦»ï¼Œä¸ºçº¿ä¸Šå‹æµ‹æä¾›æ•°æ®å®‰å…¨ä¿éšœ\n- **å‹æµ‹å¹³å°**ï¼šæä¾›åˆ†å¸ƒå¼é«˜å¹¶å‘å‹æµ‹èƒ½åŠ›ï¼Œæ”¯æŒä¸Šåƒå°å‹æµ‹æœºåŒæ—¶å‘å‡ºå‹æµ‹æµé‡ã€æ¨¡æ‹Ÿåƒä¸‡çº§ç”¨æˆ·è®¿é—®ï¼Œæ”¯æŒå¤§æµé‡ä¸‹çš„å‹æµ‹ç»“æœåˆ†æ\n\nå…¨é“¾è·¯å‹æµ‹è¦æ±‚æŠ€æœ¯å›¢é˜Ÿè¿›è¡Œæ›´é«˜æ•ˆçš„ååŒï¼Œå› æ­¤ï¼Œé™¤äº†å·¥å…·å’Œèƒ½åŠ›å±‚é¢çš„æ”¯æŒï¼Œå›¢é˜Ÿçš„æˆç†Ÿåº¦ä¹Ÿæ˜¯å½±å“è¿™é¡¹å·¥ä½œèƒ½å¦é¡ºåˆ©å¼€å±•çš„å…³é”®å› ç´ ï¼š\n- **æ˜ç¡®æ ¸å¿ƒé“¾è·¯**ï¼šéœ€è¦å…±åŒæ˜ç¡®å“ªäº›æ˜¯éœ€è¦é‡ç‚¹ä¿éšœçš„åœºæ™¯ï¼Œå¹¶é€šè¿‡ä¸šåŠ¡æ¢³ç†æ˜ç¡®æ¯ä¸ªåœºæ™¯å¯¹åº”çš„æ ¸å¿ƒé“¾è·¯\n- **å®¹é‡è§„åˆ’ä¸æµé‡æ¨¡å‹è®¾è®¡**ï¼šç»“åˆäº§å“è¿è¥è®¡åˆ’ï¼Œå¯¹æ¯ä¸ªåœºæ™¯çš„æµé‡è¿›è¡Œé¢„ä¼°ä¸æ‹†è§£ï¼Œæ˜ç¡®æ ¸å¿ƒé“¾è·¯ä¸Šå„ä¸ªç³»ç»Ÿçš„æ€§èƒ½æŒ‡æ ‡ã€å®¹é‡æŒ‡æ ‡ã€SLAä»¥åŠå„è‡ªçš„å¼ºå¼±ä¾èµ–ï¼ˆåŒ…æ‹¬ç¬¬ä¸‰æ–¹æœåŠ¡ï¼Œå¦‚å„ç±»äº‘æœåŠ¡ï¼‰ï¼Œå¹¶æ˜ç¡®å¯¹ä¾èµ–æ–¹çš„æ€§èƒ½è¦æ±‚åŠé™çº§é¢„æ¡ˆ\n- **é™æµé…ç½®åŠé¢„æ¡ˆåˆ¶å®š**ï¼šç»“åˆå„ä¸ªç³»ç»Ÿçš„æ€§èƒ½æŒ‡æ ‡å’Œå®¹é‡æŒ‡æ ‡ï¼Œæ˜ç¡®é™æµç­–ç•¥åŠé™æµå€¼ï¼Œæ¢³ç†å¯èƒ½å‡ºç°çš„å¼‚å¸¸åœºæ™¯å¹¶åˆ¶å®šé’ˆå¯¹æ€§çš„é¢„æ¡ˆï¼ˆå¦‚é™çº§ã€ç†”æ–­ç­‰ï¼‰\n- **å‹æµ‹æ‰§è¡ŒåŠé¢„æ¡ˆæ¼”ç»ƒ**ï¼šå®šæœŸç»„ç»‡å…¨é“¾è·¯å‹æµ‹å¹¶åœ¨å‹æµ‹å‰ã€å‹æµ‹ä¸­è¿›è¡Œé¢„æ¡ˆæ¼”ç»ƒ\n- **ç›‘æ§ä¸æŠ¥è­¦**ï¼šæ¯ä¸ªç³»ç»Ÿéœ€è¦åœ¨å„è‡ªçš„å…³é”®é“¾è·¯ä¸Šè®¾ç½®ç›‘æ§å’ŒæŠ¥è­¦ï¼Œä»¥ä¾¿åœ¨å‹æµ‹æœŸé—´èƒ½å®æ—¶ç›‘æµ‹æ€§èƒ½åŠå¼‚å¸¸ï¼Œå¹¶èƒ½å¤Ÿè¿›è¡Œå¿«é€Ÿå“åº”\n- **ç»“æœåˆ†æ**ï¼šåˆ†æå¹¶è§£é‡Šå‹æµ‹ç»“æœï¼Œè¯†åˆ«é¢„æ¡ˆåŠç›‘æ§æŠ¥è­¦æ˜¯å¦æœ‰æ•ˆï¼Œè¯†åˆ«æ˜¯å¦å­˜åœ¨æ½œåœ¨çš„æ€§èƒ½é—®é¢˜å’Œä¼˜åŒ–æœºä¼šï¼Œæœ€ç»ˆäº§å‡ºå‹æµ‹æŠ¥å‘Š\n- **æ”¹è¿›ä¼˜åŒ–**ï¼šå„ä¸ªå›¢é˜Ÿæ ¹æ®å‹æµ‹æŠ¥å‘Šè®¨è®ºå¹¶å®æ–½ä¼˜åŒ–ç­–ç•¥\n- **å¸¸æ€åŒ–åŸºçº¿å‹æµ‹åŠæ€§èƒ½å·¡æ£€**ï¼šå»ºç«‹å¸¸æ€åŒ–æœºåˆ¶ï¼Œå®šæœŸå¯¹ç³»ç»Ÿè¿›è¡Œæ€§èƒ½æµ‹è¯•ä»¥å»ºç«‹æ€§èƒ½åŸºçº¿ï¼Œä»¥ä¾¿äº†è§£ç³»ç»Ÿåœ¨æ­£å¸¸å·¥ä½œè´Ÿè½½ä¸‹çš„æ€§èƒ½æŒ‡æ ‡ï¼›å®šæœŸç›‘æµ‹å’Œè¯„ä¼°ç³»ç»Ÿçš„æ€§èƒ½ï¼Œä»¥ä¾¿åŠæ—©å‘ç°å’Œè§£å†³æ€§èƒ½é—®é¢˜\n\n## 3.5 å°ç»“\nè¦å®ç°ç³»ç»Ÿçš„é«˜å¯ç”¨æ€§ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ç³»ç»Ÿæ¶æ„å’Œè®¾è®¡é˜¶æ®µå……åˆ†è€ƒè™‘å„ç§æ•…éšœå’Œå¼‚å¸¸åœºæ™¯ï¼ŒåŒ…æ‹¬ç¡¬ä»¶æ•…éšœã€ç½‘ç»œä¸­æ–­ã€è½¯ä»¶é”™è¯¯ç­‰ï¼Œé€šè¿‡å‡å°‘ä¾èµ–ã€å¼•å…¥å†—ä½™å’Œå¤‡ä»½ã€å®ç°è‡ªåŠ¨æ•…éšœæ£€æµ‹ä¸æ¢å¤ã€å¢åŠ é™æµåŠåº”æ€¥é¢„æ¡ˆã€å¼•å…¥ç›‘æ§æŠ¥è­¦æœºåˆ¶ç­‰ç­–ç•¥æ¥å‡è½»çªå‘æµé‡æˆ–æ•…éšœå¯¹ç³»ç»Ÿäº§ç”Ÿçš„å½±å“ï¼Œç¡®ä¿åœ¨éƒ¨åˆ†ç»„ä»¶æˆ–æœåŠ¡æ•…éšœæ—¶ç³»ç»Ÿä»ç„¶èƒ½å¤Ÿç»§ç»­æä¾›æœåŠ¡ï¼ŒåŒæ—¶æˆ‘ä»¬ä¹Ÿå¿…è¦å€ŸåŠ©å…¨é“¾è·¯å‹æµ‹ç­‰æ‰‹æ®µè¯†åˆ«æ½œåœ¨çš„é—®é¢˜ä»¥ç¡®ä¿ä¸Šè¿°ç­–ç•¥æ˜¯æŒç»­æœ‰æ•ˆçš„ã€‚\n\n## 4 æ€»ç»“\nã€ŒièŒ…å°ã€å•†åŸä½œä¸ºèŒ…å°é…’çº¿ä¸Šé”€å”®çš„ä¸»è¦å…¥å£ï¼Œä»è¯ç”Ÿçš„ç¬¬ä¸€å¤©å¼€å§‹å°±éœ€è¦è€ƒè™‘å¦‚ä½•æœ‰æ•ˆåœ°åº”å¯¹å¤§æµé‡é«˜å¹¶å‘çš„è€ƒéªŒï¼Œè¿™è¦æ±‚æˆ‘ä»¬åœ¨ä¿è¯æ•°æ®ä¸€è‡´æ€§çš„å‰æä¸‹ï¼Œå®ç°ç³»ç»Ÿçš„é«˜æ€§èƒ½å’Œé«˜å¯ç”¨ï¼Œå…¶ä¸­é«˜æ€§èƒ½æ„å‘³ç€æ›´å¿«çš„å“åº”æ—¶é—´å’Œæ›´å¤§çš„ååé‡ï¼Œå¯ä»¥åŒæ—¶ä¸ºæ›´å¤šçš„ç”¨æˆ·æä¾›æµç•…çš„æœåŠ¡ï¼Œè€Œé«˜å¯ç”¨åˆ™æ„å‘³ç€ç³»ç»Ÿéœ€è¦åœ¨é¢ä¸´æ•…éšœæˆ–å¼‚å¸¸æƒ…å†µæ—¶ä»ç„¶ä¿æŒå¯ç”¨æ€§ã€‚\n\nä¸ºäº†å®ç°ç³»ç»Ÿçš„é«˜æ€§èƒ½å’Œé«˜å¯ç”¨ï¼Œæˆ‘ä»¬éœ€è¦ç»“åˆä¸šåŠ¡è¯‰æ±‚ã€äº§å“è¿è¥æƒ…å†µåŠç³»ç»Ÿç°çŠ¶è¿›è¡Œåˆ†æï¼Œç»¼åˆé€‰å–ä¸€äº›æ€§èƒ½ä¼˜åŒ–æŠ€æœ¯ä¸é«˜å¯ç”¨ç³»ç»Ÿçš„è®¾è®¡æ–¹æ³•ï¼Œä½¿ç³»ç»Ÿåœ¨æ€§èƒ½ã€å¯ç”¨æ€§ã€å®‰å…¨æ€§ã€å¯ç»´æŠ¤æ€§ç­‰æ–¹é¢ä¿æŒä¸€ç§æœ€ä½³çš„å¹³è¡¡çŠ¶æ€ã€‚\n\næœ¬è´¨ä¸Šï¼Œç³»ç»Ÿçš„æ¶æ„å’Œè®¾è®¡å°±æ˜¯æƒè¡¡å’Œå–èˆçš„è¿‡ç¨‹ï¼Œæƒè¡¡æ€§èƒ½ä¸å¯ç”¨æ€§ã€æˆæœ¬ä¸æ€§èƒ½ã€å®‰å…¨æ€§ä¸ä¾¿åˆ©æ€§ã€æ‰©å±•æ€§ä¸å¤æ‚æ€§ï¼Œä¸åŒçš„ç³»ç»Ÿå¯èƒ½éœ€è¦ä¸åŒçš„æƒè¡¡ï¼Œæœ¬æ–‡å¸Œæœ›é€šè¿‡è¿™äº›å®é™…çš„æ¡ˆä¾‹å¸®åŠ©å¤§å®¶æ›´å¥½åœ°ç†è§£è¿™äº›æŠ€æœ¯å’Œç­–ç•¥ä»¥åŠèƒŒåçš„æƒè¡¡è¿‡ç¨‹ï¼Œä»è€Œå¯ä»¥æ›´å¥½åœ°åº”ç”¨åœ¨æˆ‘ä»¬æ—¥å¸¸çš„è®¾è®¡ä¸å¼€å‘è¿‡ç¨‹ä¸­ã€‚\n","tags":["ç½‘æ˜“"]},{"title":"ç½‘æ˜“ç‰›é©¬æ—¥å¿—-week8","url":"/2025/01/22/ç½‘æ˜“ç‰›é©¬æ—¥å¿—-week8/","content":"> System.out.println(\"I am back\");\n\n## éœ€æ±‚10ï¼šä¿„ç½—æ–¯å°åº¦å…¬å¸çš„åç«¯æ”¹é€ \n\n### èƒŒæ™¯\n\nä¸ºäº†èƒ½å°½å¿«ä¸°å¯Œé¡µé¢å®ç°seoï¼Œä¼˜å…ˆå¼€æ”¾æ•°æ®ç»„åˆšæŒ–æ˜å‡ºæ¥çš„ä¿„ç½—æ–¯å°åº¦å…¬å¸è¯¦ç»†ä¿¡æ¯ï¼Œå½“å­˜é‡ä¸è¶³çš„æ—¶å€™å†å»æŒ‰ç…§åŸæœ‰é€»è¾‘å¼€æ”¾æ™®é€šå…¬å¸ã€‚æ­¤å¤–ä¸ºäº†ä¼˜åŒ–å…¨çƒæœå˜åŠ¨å¯¼è‡´çš„é¡µé¢å¤±æ•ˆï¼Œéœ€è¦åœ¨å‡ºæµ·é¡¹ç›®çš„esé‡Œé¢ä¿å­˜ä¸€ä»½å‰¯æœ¬ï¼Œå¦åˆ™ä¼šå½±å“è°·æ­Œæ”¶å½•ã€‚\n\n### æ”¹è¿›ç»“æ„\n\n<div style=\"text-align: center;\">\n  <img src=\"../img/netease/1736739033864.svg\" alt=\"åç«¯æ¶æ„\">\n</div>\n\nåˆ†ä¸ºä¸¤ä¸ªæ–¹é¢å–æ•°æ®ï¼Œå…¨çƒæœå’Œæ‰©å±•esï¼Œæ‰©å±•esæ´—äº†ä¸€äº›ä¿„ç½—æ–¯å°åº¦å…¬å¸çš„æ‹“å±•ä¿¡æ¯ç”¨äºå±•ç¤ºï¼Œä¸å…¨çƒæœä¸»é”®idå…³è”ï¼Œä»è€Œå¯ä»¥ç»„è£…èµ·æ¥ä½œä¸ºä¸€ä¸ªæ›´å¤§çš„boã€‚ä½†æ˜¯å¦‚æœå½“å…¬å¸å¼€æ”¾ä¹‹åï¼Œå…¨çƒæœesæœ‰å˜åŠ¨å¯¼è‡´æ— æ³•è®¿é—®å°±ä¼šä¸¥é‡å½±å“è°·æ­Œæ”¶å½•ã€‚æ‰€ä»¥éœ€è¦æ›´æ”¹ä¿å­˜é€»è¾‘ï¼Œç›´æ¥åœ¨æ¯æ—¥æ–°å¢ä¸­æ‰§è¡Œç»„è£…ï¼Œå¦‚æœæ­¤æ—¶å…¨çƒæœæœ‰é‚£å°±ä¿ç•™ï¼Œä¸”å†™å›æ‰©å±•ç´¢å¼•ä¸­ã€‚å¦‚æœæ²¡æœ‰å°±è·³è¿‡ï¼Œè¿™æ ·ä»¥æ¥æ‰€æœ‰çš„ä¿¡æ¯å…¨éƒ¨éƒ½æŒä¹…åŒ–åˆ°æ‰©å±•esä¸­ï¼Œç”¨å…¬å¼å†™å°±æ˜¯Aï¼ˆå…¨çƒæœï¼‰+Bï¼ˆæ‰©å±•ï¼‰->ABï¼ˆç»„è£…åçš„å¤§å¯¹è±¡ï¼‰->å†™å›æ‰©å±•esã€‚\n\n### å®ç°\n\n- sourceBuilderæ„é€ ï¼šæŸ¥è¯¢æŒ‡å®šå›½å®¶ï¼Œæ ¹æ®è´¨é‡åˆ†æ•°å€’åºæ’åºï¼Œä½†æ˜¯è¿™æ ·é¡ºåºå¼€æ”¾ä¼šå¯¼è‡´é‡å¤æ‰«æçš„è¶Šæ¥è¶Šå¤šï¼Œåç»­ä¸€ä¸ªå°æ—¶æœ‰å¯èƒ½éƒ½è·‘ä¸å®Œäº†ã€‚\n- æŸ¥è¯¢å¼€æ”¾å…¬å¸çš„æœ€å¤§dataIdï¼Œç„¶åè¿½åŠ dataIdï¼Œå¾—åˆ°åŸå§‹è¾“å…¥Listã€‚\n- æ¥ä¸‹æ¥è¦ä¸€ä¸ªä¸ªå»è¯·æ±‚å…¨çƒæœå»ç»„è£…ä¸€ä¸ªæ›´å¤§çš„å¯¹è±¡ï¼Œå¦‚æœè¿”å›æœ‰é—®é¢˜å°±è¿‡æ»¤æ‰ä¸å…¥åº“ï¼Œè¿”å›æ— é—®é¢˜å°±ç›´æ¥upsertæ‹“å±•ç´¢å¼•ã€‚\n- æœ€åä½œä¸ºå¼€æ”¾å…¬å¸å†™å…¥æ•°æ®åº“\n\n```java\n/**\n * ã€ä¿„ç½—æ–¯ã€å°åº¦ã€‘extendIndexç»„åˆå…¨çƒæœbaseä¿¡æ¯é‡æ–°å†™å…¥\n * @param country\n * @param param\n * @return\n */\n@Override\npublic int upsertExtendDetailToDbAndEs(String country, String param) {\n    BoolQueryBuilder boolQuery = QueryBuilders.boolQuery();\n    boolQuery.must(QueryBuilders.termQuery(\"standardCountry\", country));\n    SearchSourceBuilder sourceBuilder = new SearchSourceBuilder()\n            .query(boolQuery)\n            .fetchSource(new String[]{\"companyId\",\"name\"}, null)\n            .sort(\"dataQualityScore\",SortOrder.DESC)\n            .size(Integer.parseInt(param));\n    //ä»esä¸­æŠ½å–æŒ‡å®šæ•°é‡çš„companyList\n    List<SiteMapCompanyEntity> originalCompanyList = loadCompanyToExtendIndex(companyExtendIndex, sourceBuilder, param);\n    //è¿‡æ»¤å…¨çƒæœä¸å¼€æ”¾çš„å…¬å¸\n    List<SiteMapCompanyEntity> filterCompanyList = originalCompanyList.stream().filter(this::filterAndUpsertCompanyExtendIndex).collect(Collectors.toList());\n    //ä¿å­˜è¿›db\n    saveBatch(filterCompanyList);\n    log.info(\"upsertExtendDetailToDbAndEs success record {}\",filterCompanyList.size());\n    return filterCompanyList.size();\n}\n/**\n * ã€å…¶ä»–å›½å®¶ã€‘extendIndexç»„åˆå…¨çƒæœbaseä¿¡æ¯é‡æ–°å†™å…¥\n * @param param è¡¥é½æ¡æ•°\n */\n@Override\npublic void upsertNormalDetailToDbAndEs(String param) {\n    // æœ‰åŸŸåçš„æ’å‰é¢(å¼ºåˆ¶æ’åº)\n    Script hasDomainScript = new Script(\"if(doc['domainCount'].size()>0 && doc['domainCount'].value>=1) return 1; else return 0\");\n    // åŸŸåæ— æ•ˆçš„åç½®(å¼ºåˆ¶æ’åº)\n    Script invalidDomainScript = new Script(\"if(doc['domainStatus'].size()>0 && doc['domainStatus'].value>0) return 0; else return 1\");\n    // æœ‰é‚®ç®±å‰ç½®\n    Script hasEmailScript = new Script(\"if(doc['emailCount'].size()>0 && doc['emailCount'].value>=1) return 1; else return 0\");\n    BoolQueryBuilder boolQuery = QueryBuilders.boolQuery();\n    boolQuery.must(QueryBuilders.existsQuery(\"overviewDescription\"));\n    boolQuery.must(QueryBuilders.existsQuery(\"name\"));\n    boolQuery.must(QueryBuilders.existsQuery(\"companyId\"));\n    boolQuery.mustNot(QueryBuilders.termQuery(\"disable\", \"true\"));\n    boolQuery.must(QueryBuilders.wildcardQuery(\"overviewDescription\", \"*\"));\n    SearchSourceBuilder sourceBuilder = new SearchSourceBuilder()\n            .query(boolQuery) // æŸ¥è¯¢å‚æ•°\n            .fetchSource(new String[]{\"name\",\"companyId\"},\n                    null)\n            .size(1000)\n            // æœ‰æ— åŸŸåæ’åº\n            .sort(SortBuilders.scriptSort(hasDomainScript, ScriptSortBuilder.ScriptSortType.NUMBER).order(SortOrder.DESC))\n            // æ— æ•ˆåŸŸåæ’åº\n            .sort(SortBuilders.scriptSort(invalidDomainScript, ScriptSortBuilder.ScriptSortType.NUMBER).order(SortOrder.DESC))\n            // æœ‰é‚®ç®±å‰ç½®\n            .sort(SortBuilders.scriptSort(hasEmailScript, ScriptSortBuilder.ScriptSortType.NUMBER).order(SortOrder.DESC));\n    //ä»esä¸­æŠ½å–æŒ‡å®šæ•°é‡çš„companyList\n    List<SiteMapCompanyEntity> originalCompanyList = loadCompanyToExtendIndex(openCompanyIndex, sourceBuilder, param);\n    //è¿‡æ»¤å…¨çƒæœä¸å¼€æ”¾çš„å…¬å¸\n    List<SiteMapCompanyEntity> filterCompanyList = originalCompanyList.stream().filter(this::filterAndUpsertCompanyExtendIndex).collect(Collectors.toList());\n    //ä¿å­˜è¿›db\n    saveBatch(filterCompanyList);\n    log.info(\"upsertNormalDetailToDbAndEs success record {}\",filterCompanyList.size());\n}\n```\n\næŸ¥è¯¢ç´¢å¼•å¹¶è½¬æ¢ä¸ºæ•°æ®åº“é€»è¾‘ï¼Œè¾“å‡ºæ˜¯å®é™…æ–°å¢å¼€æ”¾å…¬å¸ï¼Œå°å¾ªç¯ç”¨setå»é‡ï¼Œå¤§å¾ªç¯ç›´æ¥å»æ•°æ®åº“count>0å»é‡ã€‚\n\n```java\n/**\n * é€šç”¨æ–°å¢å¼€æ”¾å…¬å¸é€»è¾‘\n * @param abstractIndex esç´¢å¼•\n * @param sourceBuilder esæŸ¥è¯¢æ¡ä»¶\n * @param param æŸ¥è¯¢æ•°é‡\n * @return å®é™…æ–°å¢å¼€æ”¾å…¬å¸List\n * @param <T>\n */\npublic <T> List<SiteMapCompanyEntity> loadCompanyToExtendIndex(AbstractIndex<T> abstractIndex,SearchSourceBuilder sourceBuilder,String param){\n    SiteMapCompanyEntity maxCompany = getMaxDataId();\n    long maxDataId = maxCompany == null ? 1 : maxCompany.getDataId();\n    AtomicInteger count = new AtomicInteger();\n    count.incrementAndGet();\n    List<SiteMapCompanyEntity> addList = new ArrayList<>();\n    abstractIndex.scrollSearch(sourceBuilder, searchHits -> {\n        Set<String> companyIdSets = new HashSet<>();\n        for (SearchHit searchHit : searchHits) {\n            if (addList.size() >= Integer.parseInt(param)) {\n                return true;\n            }\n            Map<String, Object> result = searchHit.getSourceAsMap();\n            String name = result.get(\"name\").toString();\n            String companyId = result.get(\"companyId\").toString();\n            //æœ¬è½®å»é‡\n            if (companyIdSets.contains(companyId)) {\n                continue;\n            }\n            companyIdSets.add(companyId);\n            //å…¨å±€å»é‡\n            if (isOpeningCompany(companyId)){\n                continue;\n            }\n            //æ•°æ®åº“å¯¹è±¡è½¬æ¢ï¼ŒåŒ…è£…é¦–å­—æ¯ç­‰\n            SiteMapCompanyEntity siteMapCompanyEntity = convertIndexToDbEntity(name, companyId);\n            siteMapCompanyEntity.setDataId(maxDataId + count.longValue());\n            count.getAndIncrement();\n            addList.add(siteMapCompanyEntity);\n            log.info(\"loadCompanyToExtendIndex add record {}\",JSON.toJSONString(siteMapCompanyEntity));\n        }\n        return false;\n    });\n    return addList;\n}\n```\n\næœ€ååœ¨xxl-jobé‡Œé¢å®šä¹‰å®šæ—¶ä»»åŠ¡ï¼Œå¼€ä¸¤ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œåˆ†åˆ«è¾“å…¥\"Russia|1500\"ï¼Œ\"India|1500\"\n\n```java\n/**\n * æ–°å¢å…¬å¸æ•°æ®\n * @param param\n * @return\n */\n@XxlJob(\"addExtendToOpenDb\")\npublic ReturnT<String> addExtendToOpenDb(String param) {\n    param = StringUtils.isEmpty(param) ? \"1500\" : param;\n    XxlJobLogger.log(\"addExtendToOpenDb job start\");\n    try {\n        String[] params = param.split(\"\\\\|\");\n        //å¸¦å›½å®¶å’Œæ•°é‡\n        if (params.length == 2) {\n            int loadedSize = siteMapCompanyService.upsertExtendDetailToDbAndEs(params[0], params[1]);\n            int remainSize = Integer.parseInt(params[1]) - loadedSize;\n            if(remainSize > 0){\n                siteMapCompanyService.upsertNormalDetailToDbAndEs(String.valueOf(remainSize));\n            }\n        } else if (params.length == 1) {\n            siteMapCompanyService.upsertNormalDetailToDbAndEs(String.valueOf(params[0]));\n        }\n    } catch (Exception e) {\n        XxlJobLogger.log(\"addExtendToOpenDb error\");\n        log.error(\"addExtendToOpenDb error\", e);\n    }\n    XxlJobLogger.log(\"addExtendToOpenDb job end\");\n    return ReturnT.SUCCESS;\n}\n```\n\n## éœ€æ±‚11ï¼šAIGCèƒ½åŠ›â€”â€”å¤§æ¨¡å‹æ€»ç»“ç½‘é¡µ\n\n### èƒŒæ™¯\n\nå‰é¢è¡¥å……çš„æ•°æ®è¿˜æ˜¯æ²¡èƒ½å½±å“seoï¼Œå¯èƒ½æ˜¯å› ä¸ºæ•°æ®ä¸å¤Ÿç‹¬ç‰¹ï¼ŒåŒè´¨æ€§å¤ªå¼ºã€‚å› æ­¤éœ€è¦ç”¨aiæ€»ç»“ä¸€ä¸‹ï¼Œåšå‡ºå·®å¼‚åŒ–çš„å†…å®¹ã€‚\n\n### æç¤ºè¯\n\n```text\nThe following text is taken from the official website of a company named: [bi-ehealthcare]. \nBased on the content provided, generate 6-8 self-questions and answers related to the company's information. \nThe question is information related to the company: the company's products, industry, services, address and contact information (telephone, email, etc.), and other points of fact mentioned in the content provided, but not limited to this.\nProvide quality responses and avoid general responses such as \"Unfortunately, the text does not provide...\" . \nAvoid interference from privacy policies and cookies, and ensure that the total length of the reply is not less than 500 characters. In particular.\nOrganize and translate your answers in English, as shown below:\nQ1: XXXX,\nA1: XXXX,\nQ2: XXXX,\nA2: XXXX\n```\n\n### å¤§æ¨¡å‹çš„åŸç†ï¼ˆæŒ–ä¸ªå‘ã€åç»­ç ”ç©¶ï¼‰\n\nè¾“å…¥çš„æ˜¯æç¤ºè¯å’ŒåŸŸåï¼Œå¤§æ¨¡å‹ä¼šå»æ ¹æ®åŸŸåè·å¾—htmlé¡µé¢ï¼Œç„¶åæ ¹æ®pythonæŸäº›å·¥å…·å»é€’å½’æŒ–æ˜å­urlå’Œhtmlï¼Œæ‹¼æ¥tokenï¼Œç»“åˆRAGä»è€Œè·å¾—æ›´å¤§è§„æ¨¡çš„è¾“å…¥ï¼Œç„¶åæ ¹æ®æç¤ºè¯å»è°ƒç”¨llama3.2ï¼Œå¾—åˆ°è¾“å‡ºã€‚\n\n","tags":["ç½‘æ˜“"]},{"title":"ç½‘æ˜“ç‰›é©¬æ—¥å¿—-week5ï¼ˆå­¦ä¹ ç‰ˆï¼‰","url":"/2024/12/25/ç½‘æ˜“ç‰›é©¬æ—¥å¿—-week5ï¼ˆå­¦ä¹ ç‰ˆï¼‰/","content":"# é‚®ç®±\n\n## é‚®ç®±æ³¨å†Œ\n\nç”¨æˆ·è§†è§’ï¼šè¾“å…¥é‚®ç®±å’Œå¯†ç ï¼ˆæœ‰æ ¡éªŒï¼‰->å¡«å†™ä¸ªäººä¿¡æ¯->æ”¶åˆ°ç¡®è®¤é‚®ä»¶->ç‚¹å‡»è·³è½¬é“¾æ¥\n\n### è¾“å…¥é‚®ç®±å’Œå¯†ç ï¼ˆæœ‰æ ¡éªŒï¼‰\n\nè¾“å…¥é‚®ç®±å¯†ç ï¼Œå‰ç«¯é€šè¿‡æ­£åˆ™è¡¨è¾¾å¼æ ¡éªŒå¯†ç æ ¼å¼ï¼Œåç«¯è¯·æ±‚/email/checkæ¥æ£€æŸ¥è´¦å·æ˜¯å¦å¯ç”¨ã€‚è¿™é‡Œå¯ç”¨æŒ‡çš„æ˜¯å·²ç»ç‚¹å‡»è¿‡éªŒè¯é‚®ä»¶çš„æˆ–è€…ç”¨oauthå·²ç»æ ¡éªŒè¿‡çš„ã€‚è¿™é‡Œæ²¡æ ¡éªŒè¿‡é‚®ä»¶çš„åº”è¯¥è¿˜æ˜¯å¯ä»¥é‡æ–°å‘èµ·æ³¨å†Œçš„ã€‚\n\n```java\npublic EmailSignUpCheckResp emailSignUpCheck(EmailSignupCheckReq emailSignupCheckReq, HttpServletRequest request) {\n    EmailSignUpCheckResp emailSignUpCheckResp = EmailSignUpCheckResp.builder()\n            .emailSignUpCheckStatus(EmailSignUpCheckStatus.UN_SIGN_UP)\n            .build();\n    // æ ¡éªŒæ³¨å†Œé‚®ç®±\n    UserEntity user = userServiceImpl.getUserEntityByLoginUsername(emailSignupCheckReq.getEmail());\n    if (Objects.nonNull(user)) {\n        if (UserState.OPEN.getCode() == user.getState()) {\n            emailSignUpCheckResp.setEmailSignUpCheckStatus(EmailSignUpCheckStatus.ALREADY_VERIFIED);\n        } else {\n            emailSignUpCheckResp.setEmailSignUpCheckStatus(EmailSignUpCheckStatus.ALREADY_SIGN_UP);\n        }\n    }\n\n    return emailSignUpCheckResp;\n}\n```\n\n### æ³¨å†Œé€»è¾‘+ç¡®è®¤é‚®ä»¶çš„å›è°ƒé€»è¾‘\n\n1. æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼šcheckæ ¡éªŒçš„æ˜¯æ˜¯å¦æœ‰æ•ˆã€‚è¿™é‡Œæ£€æŸ¥æ˜¯å¦åˆ«çš„æ–¹å¼å·²ç»æ³¨å†Œäº†ï¼ˆé€šè¿‡emailå­—æ®µæŸ¥ï¼‰\n2. æ£€æŸ¥å¯†ç å¼ºåº¦\n3. é‚€è¯·ç ï¼ˆæš‚æ—¶ä¸éœ€è¦ï¼‰\n4. ä¿å­˜ç”¨æˆ·ä¿¡æ¯ï¼ˆä¸¤å¼ è¡¨ï¼Œä¸€å¼ å­˜ç”¨æˆ·å®ä½“ï¼Œå¦ä¸€å¼ å­˜è´¦å·å¯†ç å’Œç›ï¼‰\n5. åŸ‹ç‚¹ä¸ŠæŠ¥\n\nè¿™é‡Œæœ€é‡è¦çš„æ˜¯â€œä¿å­˜ç”¨æˆ·ä¿¡æ¯â€ã€‚åœ¨æ³¨å†Œä¹‹åä¼šå…¥åº“è´¦å·å¯†ç ï¼Œä½†æ˜¯æœªæ¿€æ´»ï¼ˆå°±æ˜¯checkæ£€æŸ¥çš„é‚£ä¸ªå­—æ®µï¼Œåªæœ‰ç‚¹å‡»äº†é‚®ä»¶é“¾æ¥æ‰ä¼šæ¥æ”¶åˆ°ï¼‰ã€‚\n\néšåç”Ÿæˆä¸€ä¸ªUUIDä½œä¸ºå‚æ•°ä¼ ç»™é‚®ä»¶ï¼ŒåŒæ—¶ç¼“å­˜åœ¨redisä¸­ã€‚åœ¨é‚®ä»¶é‡Œé¢æ”¾è¿™ä¸ªé“¾æ¥å’Œå‚æ•°ï¼Œç‚¹å‡»çš„æ—¶å€™è‡ªåŠ¨å°±ä¼šå»è¯·æ±‚â€œ/verify/email?cs=â€ã€‚\nè¿™ä¸ªæ–¹æ³•ä¼šè§£æåŠ å¯†å‚æ•°ï¼Œä¸redisä¸­è¿›è¡Œæ¯”è¾ƒã€‚æ ¡éªŒæˆåŠŸåæ¿€æ´»ç”¨æˆ·çŠ¶æ€ï¼Œæœ€åèµ°è·å–tokençš„é€»è¾‘ï¼Œé‚£éƒ¨åˆ†ç­‰è®²ç™»å½•çš„æ—¶å€™å†è¯´ã€‚\n\n### é‚®ç®±ç›¸å…³\n\nå‘é€çš„æ˜¯htmlï¼Œè¿™é‡Œç”¨åˆ°äº†FreeMarkerï¼Œæ¨¡æ¿é‡Œé¢åªæœ‰ä¸¤ä¸ªéœ€è¦åŠ¨æ€æ¢çš„ï¼Œä¸€ä¸ªæ˜¯ç§°å‘¼ä¸€ä¸ªæ˜¯å¯¹åº”çš„é‡å®šå‘é“¾æ¥ã€‚\n\n```java\nMap<String, Object> templateParams = Maps.newHashMap();\ntemplateParams.put(\"accountName\", \"test\");\ntemplateParams.put(\"registerLink\", \"https://www.bilibili.com\");\nResource resource = resourceLoader.getResource(\"classpath:template/\"+registerTemplate);\nbyte[] fileData = FileCopyUtils.copyToByteArray(resource.getInputStream());\nString template = new String(fileData, StandardCharsets.UTF_8);\ntextPart.setContent(template, \"text/html;charset=utf-8\");\ntry (InputStream inputStream = new ByteArrayInputStream(template.getBytes())) {\nString content = FreemarkerUtils.process(inputStream, templateParams);\n    System.out.println(content);\n} catch (Exception e) {\n        throw new RuntimeException(e);\n}\n```\n\nç„¶åå‘é€é‚®ä»¶é…ç½®å°±å®Œäº†ï¼Œè¿™é‡Œæš‚æ—¶ç”¨çš„æ˜¯gmailï¼Œæœ€åå¾—æ­å»ºå…¬å¸é‚®ä»¶æœåŠ¡å™¨ã€‚\n\n### é‚®ç®±ç™»å½•\n\n1. å„ç§å‚æ•°æ ¡éªŒï¼ŒåŒ…æ‹¬ä¸Šé¢ä¸€ç›´åœ¨è®²çš„æ¿€æ´»çŠ¶æ€ã€‚\n2. å¯†ç æ ¡éªŒï¼ˆæ•°æ®åº“ç›æ˜¯Base64ï¼Œå¯ä»¥åŠ å¯†è§£å¯†çš„ï¼‰ï¼š encode(ç”¨æˆ·è¾“å…¥+Base64Decode(æ•°æ®åº“ç›)) == æ•°æ®åº“åŠ å¯†åçš„å¯†ç ã€‚\n3. æ ¡éªŒæˆåŠŸåˆ™ç™»å½•æˆåŠŸï¼Œé¦–å…ˆè§£æipåˆ°å›½å®¶å’Œçœä»½ä¿å­˜ã€‚ç„¶åç”Ÿæˆtokenä½œä¸ºsessionä¿å­˜åœ¨redisé‡Œé¢ï¼Œè®¾å®šè¿‡æœŸæ—¶é—´ä¸º7å¤©ã€‚\n4. å°†tokenè¿”å›ç»™å‰ç«¯ï¼Œæ¯æ¬¡è¯·æ±‚éƒ½è¦æºå¸¦ã€‚\n\n# oauth\n\n## è°·æ­Œcodeè§£æ\n\nç±»ä¼¼å¾®ä¿¡å°ç¨‹åºï¼Œå‰ç«¯å…ˆå»è¯·æ±‚è°·æ­Œç™»å½•ï¼Œè°·æ­Œä¼šè¿”å›ä¸€ä¸ªcodeï¼Œåç«¯æ‹¿åˆ°è¿™ä¸ªcodeå»oauthé‡Œè·å¾—ç”¨æˆ·ç™»å½•ä¿¡æ¯ã€‚æ‹¿è¿™ä¸ªä¿¡æ¯å»ä¸šåŠ¡æ•°æ®åº“é‡ŒæŸ¥è¯¢æ˜¯å¦æœ‰è®°å½•æ¥åˆ¤æ–­æ˜¯æ³¨å†Œè¿˜æ˜¯ç™»å½•ã€‚\n\nå¦‚æœæ²¡æœ‰å®é™…ç”¨æˆ·è¯´æ˜æ˜¯æ³¨å†Œï¼Œå¦‚æœæœ‰è¿˜éœ€è¦åˆ¤æ–­æ³¨å†Œæ–¹å¼æ˜¯å¦æ˜¯oauthï¼Œåˆ†ä¸ºå…¶ä»–æ–¹å¼æ³¨å†Œå’Œç›´æ¥ç™»å½•ã€‚\n\n```java\npublic OAuthLoginUser getAuthUserInfo(OAuthUserInfoReq req) {\n    if (!oAuthRequestFactory.support().contains(req.getOAuthType().toUpperCase())) {\n        log.error(\"getAuthUserInfo, source not supported, req: {}\", req);\n        throw new BizException(\"unsupported oauth type\", BizError.ENUM_PARAM_ERR.getCode());\n    }\n    //æ‹¿ç€oauthå»è§£æï¼Œè·å¾—ç”¨æˆ·æ•°æ®\n    AuthRequest authRequest = oAuthRequestFactory.create(req.getOAuthType());\n    AuthResponse<AuthUser> authResponse = authRequest.login(AuthCallback.builder().code(req.getCode()).build());\n    AuthUser authUserInfo = authResponse.getData();\n    if (Objects.isNull(authUserInfo)) {\n        log.error(\"getAuthUserInfo, authUserInfo is null, req: {}\", req);\n        throw new BizException(BizError.COMMON_ERR.getName(), BizError.COMMON_ERR.getCode());\n    }\n\n    // ç¼“å­˜è·å–çš„ç”¨æˆ·ä¿¡æ¯\n    String accessCode = CodeUtils.generateOAuthSignupCode();\n    redisManager.addOAuthUser(accessCode, authUserInfo);\n\n    // åˆ¤æ–­å½“å‰OAuthçŠ¶æ€\n    OAuthType oAuthType = OAuthType.of(req.getOAuthType());\n    String userIdentify = authUserInfo.getUsername();\n    OAuthStatus oAuthStatus;\n    UserEntity user = userServiceImpl.getUserEntityByLoginUsername(userIdentify);\n    //ç”¨æˆ·å®ä½“è¡¨æ²¡æœ‰å°±æ˜¯æ²¡æ³¨å†Œ\n    if (Objects.nonNull(user)) {\n        //æŸ¥æŒ‡å®šæšä¸¾ä¿¡æ¯çš„\n        UserAuthEntity auth = userAuthServiceImpl.getByIdentifier(userIdentify,\n                IdentityType.convert(oAuthType).getCode());\n        if (Objects.nonNull(auth)) {\n            // åŒç§ç±»å‹é‡å¤æ³¨å†Œ\n            oAuthStatus = OAuthStatus.LOGIN;\n        } else {\n            // å·²ç»å­˜åœ¨å…¶ä»–æ–¹å¼æ³¨å†Œ\n            oAuthStatus = OAuthStatus.ANOTHER_SIGNUP_WAY;\n        }\n    } else {\n        oAuthStatus = OAuthStatus.SIGNUP;\n    }\n\n    return OAuthLoginUser.convert(authUserInfo, accessCode, oAuthStatus);\n}\n```\n\nå‰ç«¯å¯èƒ½ä¼šæ ¹æ®ä¸‰ç§æšä¸¾å€¼æ¥èµ°ç™»å½•ã€æ³¨å†Œå’Œæç¤ºé€»è¾‘ã€‚\n\n### oauthæ³¨å†Œ\n\næ³¨å†Œé€»è¾‘åŸºæœ¬ä¸€è‡´ï¼Œå¤šäº†ä¸€ä¸ªä»redisä¸­æŸ¥è¯¢oauthçš„ç”¨æˆ·ä¿¡æ¯çš„è¿‡ç¨‹ï¼ˆä¾‹å¦‚googleä¿å­˜çš„å¤´åƒé“¾æ¥ï¼‰ï¼Œå¦‚æœæ²¡æŸ¥åˆ°å°±æ˜¯éªŒè¯è¶…æ—¶ï¼Œå¦‚æœæŸ¥åˆ°äº†ä½†æ˜¯ç”¨æˆ·ä¸åŒ¹é…å°±æŠ›å¼‚å¸¸ã€‚æœ€åç»™tokenï¼Œç„¶ååˆ é™¤oauthçš„éªŒè¯ä¿¡æ¯ã€‚\n\n### oauthç™»å½•\n\nåŸºæœ¬ä¸€è‡´ï¼Œä¹Ÿæ˜¯å¤šäº†ä¸€ä¸ªä»redisé‡Œé¢æ‹¿accesscodeçš„è¿‡ç¨‹ã€‚\n\n","tags":["ç½‘æ˜“"]},{"title":"ç½‘æ˜“ç‰›é©¬æ—¥å¿—-week5","url":"/2024/12/25/ç½‘æ˜“ç‰›é©¬æ—¥å¿—-week5/","content":"> å†™åœ¨å‰é¢ï¼šç»è¿‡ä¸€ä¸ªæœˆçš„å®ä¹ ï¼Œæˆ‘é€æ¸è§‰å¾—æ²Ÿé€šèƒ½åŠ›å’Œç†è§£èƒ½åŠ›è¿œæ¯”ä»£ç èƒ½åŠ›é‡è¦ã€‚ä¸è®ºæ˜¯åœ¨ç§‘ç ”ç»„ä¼šä¸Šçš„å“‘å£æ— è¨€ï¼Œè¿˜æ˜¯åœ¨å·¥ä½œä¸Šå¯¹æ¥çš„ä¸ƒå˜´å…«èˆŒï¼Œéƒ½æš´éœ²å‡ºäº†æˆ‘è¯­è¨€èƒ½åŠ›çš„æ¬ ç¼ºã€‚æˆ‘ä»åˆä¸­å¼€å§‹å°±çŸ¥é“è¿™æ˜¯æˆ‘çš„çŸ­æ¿ï¼Œä½†æ²¡æƒ³åˆ°æœ‰è¿™ä¹ˆçŸ­ã€‚è¿™ä¹Ÿå†æ¬¡ç»™æˆ‘æ•²å“äº†è­¦é’Ÿï¼Œä¸ç®¡ä½ æ˜¯ä»€ä¹ˆå­¦æœ¯æˆ–è€…æŠ€æœ¯å¤§å¸ˆï¼Œå­¦è¯´è¯å’Œå¬è¯´è¯æ˜¯æœ€åŸºæœ¬çš„ã€‚\n\n## éœ€æ±‚7ï¼šã€å‡ºæµ·é¡¹ç›®ã€‘ipé™æµ\n\næ³¨è§£+aop+lua+redis+æ»‘åŠ¨çª—å£é™æµç®—æ³•\n\n### æ³¨è§£å’Œaop\n\n#### æ³¨è§£\n\næ ¹æ®å¤šä¸ªæ—¶é—´å•ä½é…ç½®é™æµå™¨ï¼Œå®šä¹‰äº†æ—¶é—´æšä¸¾ç±»ï¼ŒæŒ‰ç…§æ¯«ç§’å­˜å‚¨æŒç»­æ—¶é—´ï¼ˆå› ä¸ºæ³¨è§£åªèƒ½ç”¨æšä¸¾ï¼Œä¸èƒ½ç”¨æ­£å¸¸ç±»ï¼‰ã€‚\n\n\n> æ­£å¸¸æ˜¯è¦ä¼ 3ä¸ªå€¼çš„ï¼šæ¬¡æ•°ï¼Œæ—¶é—´å•ä½ï¼Œè¶…æ—¶æ—¶é—´ï¼ˆä¸»è¦æ˜¯ç»™åé¢å¯¹redisè®¾ç½®expireTimeï¼‰ã€‚è¿™é‡Œä¸ºäº†æ–¹ä¾¿è¶…æ—¶æ—¶é—´ä¸æ—¶é—´å•ä½ä¸€è‡´ã€‚\n\n```java\n//ä½¿ç”¨ç¤ºä¾‹ï¼š1åˆ†é’Ÿé™åˆ¶10æ¬¡ï¼Œ1å°æ—¶é™åˆ¶500æ¬¡\n@IpRateLimit(limit = {10,500}, timeUnit = {TimeUnit.MINUTE,TimeUnit.HOUR})\n\n\n//æ³¨è§£å®šä¹‰\n@Retention(RetentionPolicy.RUNTIME)\n@Target(ElementType.METHOD)\npublic @interface IpRateLimit {\n    int[] limit();  // é™æµå€¼\n    TimeUnit[] timeUnit();  // æ—¶é—´å•ä½\n}\n\n@Getter\n@AllArgsConstructor\npublic enum TimeUnit {\n    YEAR(1, \"YEAR\", 1000L * 60 * 60 * 24 * 30 * 365),\n    MONTH(2, \"MONTH\", 1000L * 60 * 60 * 24 * 30),\n    DAY(3, \"DAY\", 1000 * 60 * 60 * 24),\n    HOUR(4, \"HOUR\", 1000 * 60 * 60),\n    MINUTE(5, \"MINUTE\", 1000 * 60),\n    SECOND(6, \"SECOND\", 1000),\n    ;\n    private final int code;\n    private final String name;\n    //å•ä½æ˜¯æ¯«ç§’\n    private final long periodInMills;\n}\n```\n\n#### aop\n\næ ¡éªŒæ³¨è§£é‡Œä¸¤ä¸ªæ•°ç»„é•¿åº¦å¿…é¡»ç›¸åŒï¼Œå¯¹æ¯ä¸€ä¸ªé…ç½®newä¸€ä¸ªé™æµå™¨æ¥æ‰§è¡Œredisè„šæœ¬ã€‚ï¼ˆæˆ‘åœ¨æƒ³è¿™é‡Œæ¯æ¬¡é™æµå°±newä¸€ä¸ªå¼€é”€ä¼šä¸ä¼šæœ‰ç‚¹å¤§ï¼Œä½†æ˜¯ä¸èƒ½ç”¨@serviceï¼Œå› ä¸ºæœ‰çŠ¶æ€çš„ï¼‰\n\n```java\n@Slf4j\n@Aspect\n@Component\npublic class IpRateLimiterAspect {\n\n    private RedisLuaRateLimiter redisLuaRateLimiter;\n\n    @Pointcut(\"@annotation(com.netease.cowork.sirius.it.data.overseas.server.frame.anno.IpRateLimit)\")\n    public void rateLimiter() {}\n\n    @Before(\"rateLimiter() && @annotation(ipLimiter)\")\n    public void doBefore(JoinPoint joinPoint, IpRateLimit ipLimiter) throws Throwable {\n        int[] limit = ipLimiter.limit();\n        TimeUnit[] timeUnits = ipLimiter.timeUnit();\n        if (limit.length != timeUnits.length){\n            throw new RuntimeException();\n        }\n        // è·å–ç”¨æˆ·ip\n        ServletRequestAttributes attributes = (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();\n        assert attributes != null;\n        HttpServletRequest request = attributes.getRequest();\n        String ip = request.getRemoteAddr();\n        for (int i = 0; i < limit.length; i++) {\n            long periodInMills = timeUnits[i].getPeriodInMills();\n            redisLuaRateLimiter = new RedisLuaRateLimiter(limit[i], periodInMills, periodInMills,timeUnits[i].getName());\n            if (!redisLuaRateLimiter.tryAcquired(ip)){\n                throw new RuntimeException(\"æ“ä½œé¢‘ç¹ï¼Œè¯·ç¨åé‡è¯•\");\n            }\n        }\n    }\n}\n```\n\n### redis+luaå®ç°æ»‘åŠ¨çª—å£é™æµç®—æ³•\n\nluaè„šæœ¬åœ¨è¿™é‡Œæœ€å¤§çš„ä½œç”¨å°±æ˜¯è§£å†³å¹¶å‘é—®é¢˜ï¼Œä¸”ä¿è¯åŸå­æ€§ã€‚åˆ†åˆ«è¯´è¿™ä¸ªå‡ ä¸ªå‚æ•°ï¼š\n\n- KEYS[1]ï¼šString key = prefix + ipã€‚ä¸šåŠ¡åç§°+ipã€‚å› ä¸ºå¯èƒ½æœ‰å¤šä¸ªä¸šåŠ¡éƒ½éœ€è¦é™æµã€‚\n- ARGV[1]ï¼šnow-periodInMillsã€‚æ—¶é—´æ ¡éªŒçš„åˆ†ç•Œçº¿ï¼Œå¾€åä¸ºéœ€è¦è®¡ç®—çš„æµé‡ã€‚\n- ARGV[2]ï¼šnow\n- ARGV[3]ï¼šUUID.randomUUID()çœŸæ­£çš„valueå€¼ï¼Œéšä¾¿å†™ä¸€ä¸ª\n- ARGV[4]ï¼šexpireInMills\n- ARGV[5]ï¼šlimit\n\nåŸºæœ¬åŸç†æ˜¯zsetçš„scoreå­˜æ—¶é—´æˆ³ï¼ŒZREMRANGEBYSCOREè¿™ä¸ªæ–¹æ³•ä¼šå»é™¤0åˆ°now-periodInMillsçš„æ‰€æœ‰å…ƒç´ ï¼Œå‰©ä¸‹çš„å°±æ˜¯è¦ç»Ÿè®¡çš„å…ƒç´ ã€‚ZCARDç”¨æ¥ç»Ÿè®¡å½“å‰å…ƒç´ æ•°é‡ï¼Œå¦‚æœæ¯”countå°å°±æ²¡æœ‰è¾¾åˆ°é™æµï¼ŒZADDè®¾ç½®valueï¼Œscoreå’Œè¶…æ—¶æ—¶é—´ã€‚å¦‚æœé™æµå°±è¿”å›ç‰¹æ®Šæ•°å­—ã€‚\næœ€ååªç”¨åˆ¤æ–­luaè„šæœ¬æ‰§è¡Œæ˜¯å¦æ˜¯1æ¥åˆ¤æ–­é™æµã€‚\n\nå…¶ä»–çš„ä»£ç éƒ½æ˜¯javaæ“ä½œluaçš„æ–¹æ³•ï¼Œæ ¸å¿ƒå¦‚ä¸‹ã€‚\n\n```java\n//é™æµ\nprivate static final String REDIS_LIMIT_SCRIPT = \"local removedCount = redis.call('ZREMRANGEBYSCORE', KEYS[1], 0, ARGV[1])\\n\" +\n        \"local currentCount = redis.call('ZCARD', KEYS[1])\\n\" +\n        \"if currentCount < tonumber(ARGV[5]) then\\n\" +\n        \"    redis.call('ZADD', KEYS[1], ARGV[2], ARGV[3])\\n\" +\n        \"    redis.call('PEXPIRE', KEYS[1], ARGV[4])\\n\" +\n        \"    return 1\\n\" +\n        \"else\\n\" +\n        \"    return 0\\n\" +\n        \"end\";\n//ç»Ÿè®¡rate\nprivate static final String REDIS_LIMIT_COUNT_SCRIPT = \"local removedCount = redis.call('ZREMRANGEBYSCORE', KEYS[1], 0, ARGV[1])\\n\" +\n        \"local currentCount = redis.call('ZCARD', KEYS[1])\\n\" +\n        \"return currentCount\";\n```\n\nç»“è®ºæ˜¯å¯¹æ¯”æµ·å…³æœåŠ¡çš„é™æµï¼Œè¿™ç§å†™luaçš„æ–¹æ³•èƒ½å¿«ä¸‰å€ï¼Œé™æµé€Ÿåº¦50msï¼Œä»–ä»¬çš„150msã€‚è€Œä¸”é…ç½®ä¹Ÿå¾ˆç®€å•ã€‚\n\n## éœ€æ±‚8ï¼šã€å‡ºæµ·é¡¹ç›®ã€‘sitemapä¸seoä¼˜åŒ–\n\n> **ä»€ä¹ˆæ˜¯seoï¼Ÿ**\n>\n> æœç´¢å¼•æ“ä¼˜åŒ–ï¼ŒæŒ‡çš„æ˜¯é€šè¿‡åˆç†æ‰‹æ®µå’Œä¸€äº›å°æŠ€å·§æå‡åœ¨è°·æ­Œä¸Šé¢çš„æ’åã€‚è¿™ä¸ªå‡ºæµ·é¡¹ç›®æœ€ç»ˆè¦è¾¾åˆ°çš„æ•ˆæœæ˜¯ï¼Œåœ¨è°·æ­Œä¸ŠæŸ¥è¯¢ä¸€ä¸ªå…¬å¸ï¼Œæˆ‘ä»¬çš„ç•Œé¢è¦æ¯”è¿™ä¸ªå…¬å¸é å‰ï¼Œä»è€Œè·å–è‡ªç„¶æµé‡ï¼Œæœ‰äº†è‡ªç„¶æµé‡å°±å¯ä»¥å˜ç°äº†ã€‚\n> ç±»ä¼¼å¤©çœ¼æŸ¥ï¼Œæ¯æ¬¡å»æŸ¥è¯¢ä¸€ä¸ªå…¬å¸çš„å®˜ç½‘ï¼Œå¤©çœ¼æŸ¥æ€»èƒ½æ¯”å®˜ç½‘é å‰ï¼ˆå…¶å®ä¹Ÿæœ‰å¯èƒ½æ˜¯ç™¾åº¦è‡ªå®¶ç‰¹æ®Šå…³ç…§ï¼‰ã€‚\n>\n> **ä»€ä¹ˆæ˜¯sitemapï¼Ÿ**\n>\n> sitemap.xmlæ˜¯ä¸€ä¸ªç«™ç‚¹åœ°å›¾ï¼Œç›¸å½“äºç»™è°·æ­Œçš„çˆ¬è™«ä¸€ä¸ªæŒ‡å¼•ï¼Œå‘Šè¯‰ä»–æˆ‘çš„ç½‘ç«™éƒ½æœ‰å“ªäº›è·¯å¾„éœ€è¦ä½ æ¥è®¿é—®çš„ï¼Œè¿™ä¸ªåœ°å›¾ä¸€çº§åªèƒ½æœ‰5wæ¡ï¼Œè€Œæˆ‘ä»¬çš„ä¸šåŠ¡è§„æ¨¡æœ‰6kwï¼Œæ‰€ä»¥é‡‡å–ä¸¤çº§ç´¢å¼•ï¼Œå¹¶é‡‡ç”¨gzè¿›è¡Œå‹ç¼©ã€‚\n> è€Œæˆ‘åšçš„å·¥ä½œæ˜¯å®šæ—¶æ›´æ–°è¿™ä¸ªsitemapå¹¶æ”¾åˆ°å‰ç«¯æœåŠ¡å™¨ä¸Šç»™çˆ¬è™«æ¥çˆ¬ã€‚\n\n### sitemapè‡ªåº•å‘ä¸Šæ„å»º\n\nç»™äº†ä¸¤å¼ è¡¨ï¼Œåº•å±‚å­˜å…¬å¸ï¼Œé¡¶å±‚å­˜ç´¢å¼•ã€‚æˆ‘æœ€åˆçš„æƒ³æ³•æ˜¯è‡ªåº•å‘ä¸Šæ„å»ºï¼Œæ¯æ¬¡æ›´æ–°å»åˆ é™¤é¡¶å±‚ï¼Œç„¶ååº•å±‚åˆ†é¡µè¿›è¡Œå‹ç¼©ï¼Œæœ€åæ„å»ºé¡¶å±‚ã€‚è¿™æ ·ä¼šæœ‰å‡ ä¸ªé—®é¢˜ï¼š\n\n1. æ·±åº¦åˆ†é¡µé—®é¢˜ï¼šå‰é¢è¯´äº†æ•°æ®é‡æœ€ç»ˆå¤§äº6kwï¼Œå¦‚æ­¤å¤§çš„æ•°æ®é‡åˆ°äº†åé¢è‚¯å®šæ›´æ–°ä¸åŠ¨çš„ã€‚æƒ³äº†åŠå¤©ç´¢å¼•ä¼˜åŒ–æœ€åmentorç»™å¦å†³äº†ã€‚\n2. åˆ è¡¨é—®é¢˜ï¼šæ•°æ®åº“ä¸å…è®¸ä¼ ç©ºå‚æ•°ç›´æ¥åˆ è¡¨ï¼Œè€Œä¸”å¼€é”€å¾ˆå¤§ã€‚\n3. seoé—®é¢˜ï¼šè™½ç„¶å¯†é›†åŒ–äº†è¡¨ä½†æ˜¯å¯èƒ½ä¼šé€ æˆæ³¢åŠ¨ï¼Œä¾‹å¦‚æŸä¸ªå…¬å¸çš„å‰å‡ ä¸ªå¤±æ•ˆäº†ï¼Œè¿™ä¸ªå…¬å¸å˜åŠ¨åˆ°åˆ«çš„ç´¢å¼•ä¹‹ä¸‹ï¼Œå¯èƒ½ä¼šå¯¹seoäº§ç”Ÿå½±å“ï¼Œæœ€å¥½è¿˜æ˜¯å›ºå®šä¸å˜ã€‚\n\n### sitemapè‡ªé¡¶å‘ä¸‹æ„å»º\n\nè‡ªé¡¶å‘ä¸‹æ„å»ºå°±æ˜¯ç›´æ¥ç®—å¥½idèŒƒå›´ï¼Œæ•°æ®åº“betweenä¸€ä¸‹å°±å¯ä»¥æ‰¾åˆ°ï¼ŒæŠŠç´¢å¼•å½“ä½œæ§½æ¥ç”¨ï¼Œå¡«æ»¡äº†å°±æ”¾ä¸‹ä¸€ä¸ªã€‚ä¼˜ç‚¹ï¼š\n\n1. æ²¡æœ‰æ·±åº¦åˆ†é¡µé—®é¢˜ï¼Œç›´æ¥æ ¹æ®æœ‰ç´¢å¼•çš„idæŸ¥è¯¢ï¼Œæ•ˆç‡è‚¯å®šæ˜¯æ¯”limité«˜çš„ã€‚\n2. ä¸€çº§ç´¢å¼•æ»¡äº†å°±å¼€è¾Ÿä¸€ä¸ªæ–°çš„ï¼Œæ•ˆç‡ä¹Ÿé«˜ã€‚\n\nç¼ºç‚¹ï¼š\n\n1. ä¾èµ–é¡ºåºæ€§ï¼Œç¨å¾®ä¸­é—´è·¨åº¦å¤§äº†å°±ä¼šæœ‰é—®é¢˜ã€‚ä¾‹å¦‚é¦–å…ˆå­˜äº†1-100ï¼Œå†ä»40000-40100ã€‚æ¯é¡µ100æ¡ï¼Œæ­¤æ—¶æ¥äº†10000-10100å°±ä¸èƒ½ä¿è¯ä¸€çº§ç´¢å¼•çš„é¡ºåºäº†ã€‚\n2. ä¸€çº§ç´¢å¼•çš„èµ·å§‹å’Œç»ˆç‚¹ä¼šæ˜¾å¾—æ²¡æœ‰æ„ä¹‰ï¼Œä¸­é—´æœ‰å¤§é‡å¤±æ•ˆçš„ï¼Œä¸”ä¸ä¸€å®šæœ‰åºã€‚\n\næœ€ç»ˆé‡‡ç”¨äº†è¿™ç§æ–¹å¼ï¼Œesä¸­çš„æ•°æ®æ˜¯ä¸åŒºåˆ†æ–°æ—§çš„ï¼Œæ‰€ä»¥å¾—åšä¸€ä¸ªå”¯ä¸€æ€§æ ¡éªŒã€‚é™¤æ­¤ä¹‹å¤–è¿˜æœ‰ä¸€ä¸ªå½“å‰å¾ªç¯çš„å”¯ä¸€æ€§æ ¡éªŒã€‚\n\n- é¦–å…ˆæŸ¥è¯¢å½“å‰æœ€å¤§å…¬å¸çš„idï¼Œé€šè¿‡AtomicIntegerè§£å†³çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œä»esæ¥çš„æ–°å¢æ•°æ®åŠ å…¥ï¼ŒåŒæ—¶è¦æ ¡éªŒæ˜¯å¦æ˜¯è‹±æ–‡å…¬å¸ï¼Œå¹¶å–å‡ºé¦–å­—æ¯ã€‚ï¼ˆè¿™é‡Œå†™äº†ä¸€å¤§å †å­—ç¬¦ä¸²å·¥å…·ï¼‰\n- è¿™æ ·åšäº†é‡å¤æ€§æ ¡éªŒçš„è¯å³ä½¿æ˜¯å¤±è´¥äº†ä¹Ÿèƒ½ä¿è¯ä¸ä¼šé‡å¤ã€‚\n\n```java\npublic void getOpenCompanyIndex(){\n    try {\n        BoolQueryBuilder boolQuery = QueryBuilders.boolQuery();\n        boolQuery.must(QueryBuilders.existsQuery(\"summary.formatDomains\"));\n        boolQuery.must(QueryBuilders.rangeQuery(\"emailCount\")\n                .gt(1));\n        boolQuery.must(QueryBuilders.existsQuery(\"detail.productList\"));\n        boolQuery.must(QueryBuilders.existsQuery(\"overviewDescription\"));\n        boolQuery.must(QueryBuilders.existsQuery(\"detail.sic\"));\n        boolQuery.must(QueryBuilders.existsQuery(\"detail.naics\"));\n        boolQuery.must(QueryBuilders.existsQuery(\"customsItems\"));\n\n        boolQuery.mustNot(QueryBuilders.termQuery(\"disable\", true));\n        SearchSourceBuilder sourceBuilder = new SearchSourceBuilder()\n                .query(boolQuery) // æŸ¥è¯¢å‚æ•°\n                .fetchSource(new String[]{\"name\",\"companyId\"},\n                        null)\n                .size(1000);\n        if (openCompanyIndex == null) {\n            log.error(\"openCompanyIndex is null\");\n        }\n\n        SiteMapCompanyEntity maxCompany = siteMapCompanyService.getMaxDataId();\n        long maxDataId = maxCompany == null ? 1 : maxCompany.getDataId();\n        Set<String> strings = new HashSet<>();\n        AtomicInteger count = new AtomicInteger();\n        openCompanyIndex.scrollSearch(sourceBuilder, searchHits -> {\n            List<SiteMapCompanyEntity> addList = new ArrayList<>();\n            for (SearchHit searchHit : searchHits) {\n                Map<String, Object> result = searchHit.getSourceAsMap();\n                SiteMapCompanyEntity siteMapCompanyEntity = new SiteMapCompanyEntity();\n                String name = result.get(\"name\").toString();\n                String companyId = result.get(\"companyId\").toString();\n                //æœ¬è½®å»é‡\n                if (strings.contains(companyId)) {\n                    continue;\n                }\n                strings.add(companyId);\n                //å…¨å±€å»é‡\n                LambdaQueryWrapper<SiteMapCompanyEntity> lambdaQueryWrapper = new LambdaQueryWrapper<>();\n                lambdaQueryWrapper.eq(SiteMapCompanyEntity::getCompanyId, companyId);\n                if (siteMapCompanyService.count(lambdaQueryWrapper) > 0){\n                    continue;\n                }\n                siteMapCompanyEntity.setCompanyId(companyId);\n                //ä¿ç•™åŸå§‹åç§°\n                siteMapCompanyEntity.setCompanyName(name);\n                siteMapCompanyEntity.setChangeFreq(ChangeFreqEnum.WEEKLY.getCode());\n                siteMapCompanyEntity.setDataPriority(1f);\n                siteMapCompanyEntity.setCreateTime(new Date());\n                siteMapCompanyEntity.setUpdateTime(new Date());\n                siteMapCompanyEntity.setDataId(maxDataId + count.longValue());\n                //éè‹±è¯­å…¬å¸\n                if (!StringUtil.checkEnglishChar(name)){\n                    siteMapCompanyEntity.setNavLetter(null);\n                }\n                else {\n                    String temp = StringUtil.removeAllPattern(name);\n                    siteMapCompanyEntity.setNavLetter(temp.substring(0, 1).toUpperCase());\n                }\n                count.getAndIncrement();\n                addList.add(siteMapCompanyEntity);\n            }\n            siteMapCompanyService.saveBatch(addList);\n            return false;\n        });\n        log.info(String.valueOf(count));\n    }\n    catch (Throwable e){\n        log.error(String.valueOf(e));\n    }\n}\n```\n\né‚£æ€ä¹ˆåšç”Ÿæˆçš„ï¼Œæ ¹æ®å…¬å¸çš„æœ€å¤§å€¼æœ€å°å€¼/é¡µé¢å¤§å°å¾—åˆ°åç§»é‡ã€‚æ ¹æ®è¿™ä¸ªåç§»é‡å»æ›´æ–°å’ŒæŸ¥è¯¢ï¼Œåªå…³æ³¨æœ€åä¸€ä¸ªç´¢å¼•å—ï¼Œå¦‚æœæ²¡æ»¡å°±ä»è¿™é‡Œå¼€å§‹åŠ ï¼Œæ›´æ–°æœ€å¤§å€¼ã€‚\n\n```java\npublic void generate() {\n    preprocess();\n    SiteMapCompanyEntity maxCompany = siteMapCompanyService.getMaxDataId();\n    SiteMapCompanyEntity minCompany = siteMapCompanyService.getMinDataId();\n    if (maxCompany == null || minCompany == null) {\n        return;\n    }\n    List<CompletableFuture<Void>> futures = new ArrayList<>();\n    Map<Long,String> siteMap = new HashMap<>();\n    long minDataId = minCompany.getDataId();\n    long maxDataId = maxCompany.getDataId();\n    long pageLength = (long) Math.ceil((double) (maxDataId - minDataId + 1) / PAGE_SIZE);\n    for (long i = 1; i <= pageLength; i++) {\n        long startDataId = minDataId +  (i - 1) * PAGE_SIZE;\n        long endDataId = minDataId + i * PAGE_SIZE - 1;\n        long page = i;\n        CompletableFuture<Void> future = CompletableFuture.runAsync(() -> {\n            String gzip = xmlCompanyMapGenerator.generateCompanyMap(startDataId, endDataId,page);\n            if (!StringUtils.isEmpty(gzip)) {\n                siteMap.put(page,gzip);\n            }\n        }, EXECUTOR);\n        futures.add(future);\n    }\n    CompletableFuture.allOf(futures.toArray(new CompletableFuture[0])).join();\n    generateXML(siteMap);\n    long count = siteMapTopService.count();\n    List<SiteMapTopEntity> insertList = new ArrayList<>();\n    for (long i = Math.max(1,count); i <= pageLength; i++) {\n        long startDataId = minDataId +  (i - 1) * PAGE_SIZE;\n        long endDataId = Math.min(minDataId + i * PAGE_SIZE - 1, maxDataId);\n        SiteMapTopEntity siteMapTopEntity = new SiteMapTopEntity();\n        siteMapTopEntity.setStartDataId(startDataId);\n        siteMapTopEntity.setEndDataId(endDataId);\n\n        siteMapTopEntity.setCreateTime(new Date());\n        siteMapTopEntity.setUpdateTime(new Date());\n        if (count != 0 && i == count){\n            LambdaUpdateWrapper<SiteMapTopEntity> updateWrapper = new LambdaUpdateWrapper<>();\n            updateWrapper.eq(SiteMapTopEntity::getName,siteMap.get(i));\n            siteMapTopService.update(siteMapTopEntity,updateWrapper);\n            continue;\n        }\n        siteMapTopEntity.setName(siteMap.get(i));\n        insertList.add(siteMapTopEntity);\n    }\n    siteMapTopService.saveBatch(insertList);\n}\n```\n\nç¬¬ä¸€å‘¨é¦–å…ˆä¸Šäº†3wæ•°æ®ï¼Œæœªæ¥æ•°æ®é‡å¤§äº†è‚¯å®šè¦åˆ†åº“åˆ†è¡¨çš„ï¼Œä»¥åçš„äº‹æƒ…ä»¥åå†è¯´ã€‚\n\n## éœ€æ±‚9ï¼šã€å‡ºæµ·é¡¹ç›®ã€‘ä¸€äº›é›¶ç¢çš„å°éœ€æ±‚\n\n### ã€æ¥å£ã€‘æ ¹æ®é¦–å­—æ¯å’Œé¡µç è¿”å›æ•°æ®\n\nå°±æ˜¯ç®€å•çš„åˆ†é¡µé—®é¢˜ï¼Œä½†æ˜¯æœ‰ä¸€äº›å­—ç¬¦ä¸²å¤„ç†ã€‚æˆ‘å†™äº†ä¸€å¤§å †å­—ç¬¦ä¸²å·¥å…·ã€‚\n\n```java\npublic PageResp<CompanyUrlResp> getCompanyUrl(String navLetter, Integer pageNum) {\n    LambdaQueryWrapper<SiteMapCompanyEntity> queryWrapper = new LambdaQueryWrapper<>();\n    if (StringUtils.isNotEmpty(navLetter)) {\n        //éè‹±æ–‡å›½å®¶\n        if (navLetter.equals(\"Other\")) {\n            queryWrapper.isNull(SiteMapCompanyEntity::getNavLetter);\n        } else if (!navLetter.matches(\"^[a-zA-Z]$\")) {\n            throw new BizException(BizError.PARAM_ERR.getName(), BizError.PARAM_ERR.getCode());\n        } else {\n            queryWrapper.eq(SiteMapCompanyEntity::getNavLetter, navLetter.toUpperCase());\n        }\n    } else {\n        throw new BizException(BizError.PARAM_ERR.getName(), BizError.PARAM_ERR.getCode());\n    }\n    queryWrapper.eq(SiteMapCompanyEntity::getStatus, CompanyStatus.ACTIVE.getCode());\n\n    IPage<SiteMapCompanyEntity> page = new Page<>(pageNum, COMPANY_URL_PAGE_SIZE);\n    IPage<SiteMapCompanyEntity> userPage = siteMapCompanyService.page(page, queryWrapper);\n    List<SiteMapCompanyEntity> userList = userPage.getRecords();\n    //ç»„è£…è¿”å›ç»“æœ\n    PageResp<CompanyUrlResp> pageResp = new PageResp<>();\n    pageResp.setPageNo(pageNum);\n    pageResp.setPageSize(COMPANY_URL_PAGE_SIZE);\n    pageResp.setTotalPage(userPage.getPages());\n    pageResp.setTotalSize(userPage.getTotal());\n    pageResp.setContent(userList.stream().map(item -> {\n        CompanyUrlResp companyUrlResp = new CompanyUrlResp();\n        companyUrlResp.setCompanyId(item.getCompanyId());\n        companyUrlResp.setCompanyName(StringUtil.firstLetterToUpperCaseByBlank(item.getCompanyName()));\n        if (!StringUtil.checkEnglishChar(item.getCompanyName())){\n            companyUrlResp.setCompanyFormatName(\"Non-English-Company\");\n        }\n        else {\n            String temp = StringUtil.formatCompanyNameToUrl(item.getCompanyName());\n            companyUrlResp.setCompanyFormatName(temp);\n        }\n        return companyUrlResp;\n    }).collect(Collectors.toList()));\n    return pageResp;\n}\n```\n\n### ã€æ¥å£ã€‘å…¬å¸è¯¦æƒ…è·å–\n\nä¿®æ”¹äº†mentorçš„ä¸€ç‚¹é€»è¾‘ï¼Œåšäº†ä¸€ç‚¹æ ¡éªŒï¼š\n\n- å› ä¸ºæŸ¥çš„æ˜¯å…¨çƒæœçš„æ•°æ®ï¼Œæœ‰å¯èƒ½æœªå…¬å¼€ï¼Œæ ¡éªŒåªæœ‰å¼€å¯çš„å…¬å¸æ‰èƒ½æŸ¥è¯¢ã€‚\n- å¦‚æœæ²¡æœ‰ç™»å½•ï¼Œdomainéšè”½ï¼Œè¿™é‡Œçœ‹threadlocalæœ‰æ²¡æœ‰ä¸œè¥¿å°±å¥½äº†ã€‚\n\n```java\npublic CompanyBaseVO base(String companyId) {\n    if (!siteMapCompanyService.isOpeningCompany(companyId)) {\n        throw new BizException(BizError.NON_OPENING_COMPANY.getName(), BizError.NON_OPENING_COMPANY.getCode());\n    }\n    try{\n        String url = host+\"/api/auth/global/overseas/base\";\n        Map<String, String> map = new HashMap<>();\n        map.put(\"companyId\", companyId);\n        map.put(\"appKey\", appKey);\n        map.put(\"appSecret\", appSecret);\n        map.put(\"timestamp\", String.valueOf(System.currentTimeMillis()));\n        map = OpenApiUtil.packageSign(map, appKey, appSecret);\n        String resut = OkHttpUtil.get(url, map);\n        if (StringUtils.isNotBlank(resut)) {\n            // å›¾ç‰‡é“¾æ¥è½¬æ¢\n            resut = ImagePathConvert.convert(resut);\n            JSONObject jsonObject = JSON.parseObject(resut);\n            String dataResult = jsonObject.getString(\"data\");\n            return loginAuth(JSON.parseObject(dataResult, CompanyBaseVO.class));\n        }\n        return null;\n    }catch (Exception e){\n        log.info(\"demo error\", e);\n        return null;\n    }\n}\npublic CompanyBaseVO loginAuth(CompanyBaseVO companyBaseVO){\n    UserInfoToken userInfoToken = UserContext.getContent().getUserInfoToken();\n    //æœªç™»å½•\n    if (userInfoToken == null) {\n        companyBaseVO.setDomain(\"*****\");\n    }\n    return companyBaseVO;\n}\n```\n","tags":["ç½‘æ˜“"]},{"title":"ç½‘æ˜“ç‰›é©¬æ—¥å¿—-week4","url":"/2024/12/15/ç½‘æ˜“ç‰›é©¬æ—¥å¿—-week4/","content":"\n## éœ€æ±‚5ï¼šä¼˜åŒ–prompt\n\n### 1.æç¤ºè¯ä¼˜åŒ–\n\n> å­¦ä¹ äº†promptå·¥ç¨‹ï¼Œä¸»è¦çš„ä¼˜åŒ–æ€è·¯æœ‰ï¼ˆ[å‚è€ƒè¿æ¥](https://mp.weixin.qq.com/s/QDzbfUkvSEalLxm3XX9rtA)ï¼‰ï¼š\n>\n> 1. è§’è‰²æç¤ºï¼šâ€œå‡è®¾æˆ‘æ˜¯ä¸€ä¸ªåˆšå…¥è¡Œçš„ç”µå•†ä¹°å®¶â€ï¼Œç±»ä¼¼è¿™ç§å¯ä»¥å°†gptå¸¦å…¥è§’è‰²ï¼Œä»¥è¯¥è§’è‰²çš„è§†è§’è¿›è¡Œè¾“å‡º\n> 2. æ€ç»´é“¾æç¤ºï¼šè®©gptä¸€æ­¥ä¸€æ­¥è¿›è¡Œæ€è€ƒï¼Œä¾‹å¦‚è®¡ç®—1+2+3ï¼Œå…ˆè®©gptç®—å‡º1+2=3ï¼Œç„¶åå†å»ç®—3+3=6ï¼Œæœ‰äº†æ€ç»´é“¾èƒ½å¤Ÿä½¿aiæ¸…æ™°æ€è€ƒè·¯å¾„ï¼ŒçŠ¯é”™çš„å¯èƒ½æ€§é™ä½\n> 3. æ€ç»´æ ‘æç¤ºï¼šè·Ÿä¸Šé¢çš„æ€ç»´é“¾æ¯”èµ·æ¥ï¼Œæ€ç»´æ ‘è¦è€ƒè™‘ä¸åŒçš„åˆ†å‰ï¼Œåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­è¦è€ƒè™‘ä¸åŒçš„æƒ…å†µ\n> 4. è‡ªä¸€è‡´æ€§æç¤ºï¼šå°†æ¨¡å‹çš„æ¸©åº¦å‡é«˜ï¼Œå¤šæ¬¡å»æ‰§è¡Œä¸€ä¸ªé—®é¢˜ï¼Œè¿”å›å…¶ä¸­æœ€é«˜é¢‘ç‡çš„ç­”æ¡ˆã€‚å¯¹äºæ¨èè¯çš„åœºæ™¯ä¸å¤ªé€‚ç”¨ï¼Œå› ä¸ºè°ƒç”¨æ¬¡æ•°æœ‰é™è€Œä¸”æ—¶å»¶è¾ƒå¤§ï¼Œè¢«mentorå¦å†³ã€‚\n> 5. ReActæç¤ºï¼šç”¨pythonçš„apiè¿›è¡Œè°ƒç”¨ï¼ŒåŠŸèƒ½å¼ºå¤§ä½†ç”¨ä¸äº†ã€‚\n     >    ç»¼åˆä»¥ä¸Šçš„æ–¹æ³•ï¼Œåªæœ‰æ€ç»´é“¾å¯ä»¥ä½œä¸ºä¼˜åŒ–ã€‚\n\n1. è¿‘ä¼¼è¯ï¼šä¸­è¯‘è‹±\n\n```text\nString synonymsPrompt = MessageFormat.format(\"ä¸\\\"{0}\\\"æ„æ€ç›¸è¿‘çš„äº§å“æœ‰å“ªäº›ï¼Œ\n        è¯·ç”¨{1}åˆ—ä¸¾10ä¸ªäº§å“åã€‚è¦æ±‚ä¸åŒ…å«\\\"{0}\\\"ï¼Œ\n        è¾“å‡ºæ ¼å¼ä¸ºï¼šjsonArray\", formatValue, language) + \",[]\";\n```\n\n```text\nString synonymsPrompt = MessageFormat.format(\"What are the products with the similar meaning of \\\"{0}\\\",\\n\" +\n        \"Please list 10 product names in {1}. My request is not to include \\\"{0}\\\",\\n\" +\n        \"The output format is jsonArray\", formatValue, language) + \",[]\";\n```\n\n2. ç”µå•†è¯ï¼šè½¬ä¸ºä¸­æ–‡æ€ç»´é“¾\n\n```text\nString platformPrompt = MessageFormat.format(\"å‡è®¾æˆ‘æ˜¯ä¸€ä¸ªæ–°å…¥è¡Œçš„ç”µå•†å–å®¶ï¼Œ\n        ä¸»è¦ç»è¥çš„æ˜¯\\\"{0}\\\"ã€‚æˆ‘å¸Œæœ›èƒ½æœ‰æ›´å¤šçš„ç”¨æˆ·åœ¨amazon.comç­‰åŒç±»ç”µå•†ç½‘ç«™ä¸­æœç´¢åˆ°æˆ‘ï¼Œ\n        æˆ‘å¯ä»¥ä½¿ç”¨æ€æ ·çš„{1}äº§å“åå¯¹è‡ªå·±çš„äº§å“è¿›è¡Œæè¿°ï¼Ÿè¦æ±‚ä¸åŒ…å«\\\"{0}\\\"ï¼Œ\n        è¯·å»æ‰å°½å¯èƒ½å¤šçš„é•¿å°¾è¯ï¼Œæç‚¼å…±åŒçš„äº§å“æè¿°è¯ã€‚å¸®æˆ‘ç”¨{2}åŒä¹‰æ›¿æ¢10ä¸ªä¸åŒçš„äº§å“æè¿°ã€‚ä»…è¾“å‡ºæ›¿æ¢åçš„æ•°æ®ï¼Œ\n        æ ¼å¼ä¸ºï¼šjsonArray\", formatValue, language, language) + \",[]\";   \n```\n\n```text\nString platformPrompt = MessageFormat.format(\"è¯·æŒ‰ç…§å¦‚ä¸‹æç¤ºä¸€æ­¥æ­¥æ¨ç†ï¼š\\n\" +\n        \"ç¬¬ä¸€æ­¥ï¼Œè¯·å°†äº§å“\\\"{0}\\\"ä»å“ç‰Œã€å‹å·ã€ææ–™ã€ç”¨é€”ç­‰æ–¹é¢è¿›è¡Œæ‰©å±•ï¼Œå°½é‡ç»†åˆ†ä¸”å…·ä½“åˆ°æŸä¸ªå“ç‰Œçš„æŸä¸ªäº§å“ã€‚\\n\" +\n        \"ç¬¬äºŒæ­¥ï¼Œæ€è€ƒè¯¥äº§å“åœ¨amazon.comç­‰åŒç±»ç”µå•†ç½‘ç«™ä¸­æ˜¾ç¤ºç»™ç”¨æˆ·çš„å•†å“è¯æ˜¯ä»€ä¹ˆã€‚\\n\" +\n        \"ç¬¬ä¸‰æ­¥ï¼Œæå–å•†å“è¯ä¸­çš„å…³é”®ä¿¡æ¯ï¼Œä¸å…è®¸å‡ºç°å“ç‰Œå’Œå‹å·ï¼Œé•¿åº¦ä¸¥æ ¼é™åˆ¶åœ¨30ä¸ªå­—æ¯ä»¥å†…ã€‚\\n\" +\n        \"ç»¼åˆä»¥ä¸Šä¸‰æ­¥ï¼Œä»…ç”¨{1}è¾“å‡ºåä¸ªè¿™æ ·çš„äº§å“åï¼Œè¦æ±‚ä¸åŒ…å«\\\"{0}\\\"æ ¼å¼ä¸ºï¼šjsonArray,[]\", formatValue, language) + \",[]\";\n```\n\n3. è¡Œä¸šè¯ï¼šä¸­è¯‘è‹±\n\n```text\nprompt = \"æˆ‘æ˜¯ä¸€ä¸ªæ–°å…¥è¡Œçš„å¤–è´¸ä¾›åº”å•†ï¼Œä¸»è¦ç»è¥çš„æ˜¯\"+ formatValue +\"ã€‚æˆ‘çš„äº§å“å¯ä»¥åº”ç”¨äºå“ªäº›è¡Œä¸šçš„å“ªäº›äº§å“ï¼Ÿå¸®æˆ‘åˆ—ä¸¾3ä¸ªè¡Œä¸šï¼Œå¹¶æè¿°æ¨èè¿™äº›è¡Œä¸šçš„ç†ç”±ï¼Œåœ¨æ¯ä¸ªè¡Œä¸šä¸‹åˆ—ä¸¾5ä¸ªä½¿ç”¨è¯¥äº§å“åˆ¶é€ å‡ºæ¥çš„äº§å“åç§°ã€‚\\n\" +\n        \"ç”¨jsonè¾“å‡ºï¼Œæ ¼å¼ä¸ºï¼š\\n\" +\n        \"è¡Œä¸š1\\n\" +\n        \"è¡Œä¸šåï¼šxxx\\n\" +\n        \"æ¨èç†ç”±ï¼šxxx\\n\" +\n        \"ç›¸å…³äº§å“ï¼šxxx\\n\" +\n        \"è¦æ±‚ï¼š\\n\" +\n        \"1ã€è¡Œä¸šåç§°ç”¨{\"+languageVersion+\"}ã€‚\\n\" +\n        \"2ã€æ¨èç†ç”±ç”¨{\"+languageVersion+\"}ã€‚\\n\" +\n        \"3ã€ç›¸å…³äº§å“ç”¨{\"+language+\"}ã€‚\\n\" +\n        \"4ã€äº§å“åç§°ä¸èƒ½é‡å¤ã€‚\\n\" +\n        \"5ã€äº§å“åç§°ä¸éœ€è¦åŒ…å«æè´¨ç­‰é™åˆ¶ã€‚\\n\" +\n        \"6ã€ç›¸å…³äº§å“ç”¨#æ ¼å¼€ã€‚\" +\n        \"7ã€ä¸åŒ…å«\\\"\"+formatValue+\"\\\"ã€‚\";\n```\n\n```text\nprompt = \"I am a new foreign trade supplier, the main business is \\\"\"+formatValue+\"\\\". Which products can my product be used in which industries? Give me a list of 3 industries and describe the reasons why you recommend them, and list 5 names of products made with that product under each industry.\\n\" +\n        \"Output in json format:\\n\" +\n        \" è¡Œä¸š1\\n\" +\n        \" è¡Œä¸šåï¼šxxx\\n\" +\n        \" æ¨èç†ç”±ï¼šxxx\\n\" +\n        \" ç›¸å…³äº§å“ï¼šxxx\\n\" +\n        \"Requirement: \\\"\\n\" +\n        \"1. the industry name with {\"+languageVersion+\"}.\\n\" +\n        \"2. recommended reasons use {\"+languageVersion+\"+}.\\n\" +\n        \"3. Use {\"+language+\"} for related products.\\n\" +\n        \"4. the product name can not be repeated.\\n\" +\n        \"5. the product name does not need to include material and other restrictions.\\n\" +\n        \"6. related products are delimited with #\\n\" +\n        \"7. \\\"\"+formatValue+\"\\\" is not included.\";\n```\n\nä¸‰ä¸ªå°å°çš„ä¼˜åŒ–è€—è´¹äº†æˆ‘ä¸€å‘¨çš„æ—¶é—´ï¼Œå®é™…ä¸Šä¹Ÿæ²¡å¤šå°‘æå‡ã€‚\n\n### 2.ä»£ç é€»è¾‘\n\n#### è¿‘ä¼¼è¯å’Œç”µå•†è¯\n\n- é¦–å…ˆåˆ¤æ–­æ˜¯å¦ä¸ºç©ºï¼Œæˆ–è€…æ˜¯å¦ä¸ºæ•æ„Ÿè¯ï¼ˆè°ƒç”¨ç½‘æ˜“æ˜“ç›¾ï¼‰ï¼Œéšåä¼ å…¥ç”¨æˆ·ä¿¡æ¯ï¼Œè®¿é—®æœåŠ¡ã€‚\n- æœåŠ¡å†…éƒ¨ï¼šä¼ å…¥å‚æ•°ä¸­è¯­è¨€ä¸ºç©ºé»˜è®¤ä¸ºè‹±è¯­ï¼Œç„¶åç”¨CompletableFuture.supplyAsync()æ­é…çº¿ç¨‹æ± å®Œæˆgptçš„ä¸¤æ¬¡è¯·æ±‚ã€‚çº¿ç¨‹æ± å¦‚ä¸‹ï¼š\n\n```java\n//çº¿ç¨‹å·¥å‚ä»…ä»…æ”¹åï¼Œæ‹’ç»ç­–ç•¥æ˜¯å‘èµ·è€…è‡ªå·±æ¶ˆåŒ–\nprivate static final ThreadFactory GPT_THREAD_FACTORY = new ThreadFactoryBuilder().setNameFormat(\"GptGrpcWrapper-gpt-pool-%d\").build();\nprivate static final ExecutorService GPT_REQUEST_EXECUTOR = new ThreadPoolExecutor(20,\n        40, 60 * 5L, TimeUnit.SECONDS, new LinkedBlockingDeque<>(3000), GPT_THREAD_FACTORY, new ThreadPoolExecutor.CallerRunsPolicy());\n```\n\n- è¯·æ±‚æˆåŠŸçš„ç»“æœç¼“å­˜åœ¨redisä¸­100å¤©ï¼Œç¼“å­˜çš„keyæ˜¯\"cacheKeyPreFix + \"v6\" + \":\" + gptRecommendReqVO.getLanguage()+\":\"+gptRecommendReqVO.getValue();\"\n\n```java\nprivate Set<String> getRecommendWordV1(GptRecommendReqVO gptRecommendReqVO, AuthInfo authInfo, String prompt, String cacheKeyPreFix) {\n    String cacheValue = \"\";\n    try {\n        if (StringUtils.isBlank(gptRecommendReqVO.getValue())) {\n            return Collections.emptySet();\n        }\n        String formatValue = FormatUtil.escapeFormat(gptRecommendReqVO.getValue());\n        if(StringUtils.isBlank(formatValue) || formatValue.length()<=1){\n            log.info(\"GptGrpcWrapper value:{},formatValue:{}\",gptRecommendReqVO.getValue(),formatValue);\n            return Collections.emptySet();\n        }\n        if(gptRecommendReqVO.getLanguage()==null){\n            gptRecommendReqVO.setLanguage(\"è‹±è¯­\");\n        }\n\n        String language = gptRecommendReqVO.getLanguage();\n        String cacheKey = cacheKeyPreFix + \"v6\" + \":\" + gptRecommendReqVO.getLanguage()+\":\"+gptRecommendReqVO.getValue();\n        cacheValue = recommendWordCache.get(cacheKey);\n        //å‘½ä¸­\n        if(StringUtils.isNotBlank(cacheValue)){\n            log.info(\"GptGrpcWrapper call success,param:{},result:{}\",JSON.toJSONString(gptRecommendReqVO),cacheValue);\n            //å¤§æ®µæ–‡å­—ä¸­çš„[\"xxx1\",\"xxx2\",\"xxx3\"]\n            if(cacheValue.contains(\"[\") && cacheValue.contains(\"]\")){\n                cacheValue = cacheValue.substring(cacheValue.indexOf(\"[\"), cacheValue.lastIndexOf(\"]\") + 1);\n            }\n            //åªå–å‰6ä¸ªï¼Œè¿™ä¸ªæ•°å€¼æ˜¯å‰ç«¯å®šçš„\n            Set<String> synonyms = getLimitSize(Lists.newArrayList(JSON.parseArray(cacheValue, String.class)), gptRecommendReqVO.getSize());\n            return synonyms;\n        }\n        //æœªå‘½ä¸­\n        log.info(\"GptGrpcWrapper call param:{},prompt:{}\",JSON.toJSONString(gptRecommendReqVO),prompt);\n        CompletableFuture<String> future = CompletableFuture.supplyAsync(\n                () -> gptRequest(authInfo.getOrgId(),authInfo.getAccId(),authInfo.getEmail(),prompt, GPTModelVersionEnum.GPT_4O_MINI.getVersion()), GPT_REQUEST_EXECUTOR);\n        //è¿™é‡Œå®é™…ä¸Šè¿˜æ˜¯åŒæ­¥è¯·æ±‚ï¼Œ\"gpt-recommard-future\"æ˜¯ä¸€ä¸ªæ—¥å¿—çš„åç§°ï¼Œè¶…æ—¶æ—¶é—´120s\n        String res = (String)FutureResultUtil.getResult(\"gpt-recommard-future\",future,120, TimeUnit.SECONDS);\n        if (StringUtils.isBlank(res)) {\n            log.info(\"getRecommend failed.name:{},language:{}\",formatValue, language);\n            return Collections.emptySet();\n        }\n        cacheValue = res;\n        // æ¨èè¯ç¼“å­˜100å¤©\n        recommendWordCache.set(cacheKey,cacheValue,TimeUnit.DAYS.toMillis(100));\n        log.info(\"GptGrpcWrapper call success,param:{},result:{}\",JSON.toJSONString(gptRecommendReqVO),cacheValue);\n        if(cacheValue.contains(\"[\") && cacheValue.contains(\"]\")){\n            cacheValue = cacheValue.substring(cacheValue.indexOf(\"[\"), cacheValue.lastIndexOf(\"]\") + 1);\n        }\n        Set<String> synonyms = getLimitSize(Lists.newArrayList(JSON.parseArray(cacheValue, String.class)), gptRecommendReqVO.getSize());\n        return synonyms;\n    }catch (Exception e) {\n        //gptå‡ºçš„è¯å¦‚æœä¸å¸¸è§„ã€‚ä¾‹å¦‚æ˜¯â€œå¥½çš„ï¼Œæ¥ä¸‹æ¥ä¸ºæ‚¨è¾“å‡º....â€ï¼Œåœ¨JSON.parseArrayå°±ä¼šæŠ¥å¼‚å¸¸ä¸è¿”å›ç»™å‰ç«¯ã€‚\n        log.error(\"getGptRecommend param:{}\",JSON.toJSONString(gptRecommendReqVO), e);\n        return Collections.emptySet();\n    }\n}\n```\n\n> 1. redisåªå­˜gptåŸå§‹å›ç­”ï¼Œå¯ä»¥æ”¹æˆå¤„ç†åçš„å›ç­”\n> 2. çº¿ç¨‹æ± å®é™…ä¸Šåªå°†è¿‘ä¼¼è¯å’Œç”µå•†è¯åšäº†å¼‚æ­¥ï¼Œåœ¨è¿™ä¸¤ä¸ªå•ç‹¬çš„è¯·æ±‚é‡Œé¢ç”¨futureå®é™…è¿˜æ˜¯åŒæ­¥ã€‚\n> 3. gptå¦‚æœè¾“å‡ºä¸ç†æƒ³æœ‰ä¸¤é‡å¤„ç†ï¼Œé¦–å…ˆçœ‹æ˜¯å¦åŒ…å«äº†\"[\"xxx1\",\"xxx2\",\"xxx3\"]\"ï¼Œç”¨subStringæå–å‡ºæ¥ï¼Œå®åœ¨æ˜¯æ²¡æœ‰é‚£åœ¨parseObjectå°±ä¼šæŠ¥é”™ï¼Œç»“æœè¿”å›ä¸ºç©ºã€‚\n\n- æœ€åå¤„ç†è¿‘ä¼¼è¯å’Œç”µå•†è¯çš„ç»“æœï¼Œç”¨ä¸€ä¸ªå¤§çš„hashsetå»é‡ï¼ˆä½†æ˜¯å¤§å°å†™æ•æ„Ÿï¼Œè¿™é‡Œå¯ä»¥ä¼˜åŒ–æˆå…¨éƒ¨å°å†™å†æ¯”è¾ƒï¼‰\n- è°ƒç”¨GRPCï¼ˆæœ‰é“ç¿»è¯‘ï¼‰å…œåº•ï¼Œå…ˆåˆ¤æ–­æ˜¯å¦å‡ºç°ä¸­æ–‡ï¼Œæœ‰ä¸­æ–‡å°±ç¿»è¯‘ã€‚æ‰¹é‡ç¿»è¯‘è¿”å›å€¼æ˜¯mapï¼Œkeyæ˜¯åŸæ–‡ï¼Œvalueæ˜¯ç¿»è¯‘åçš„ã€‚æœ€åè¿›è¡Œç»„è£…è¿”å›ã€‚\n\n**æ€»ç»“ï¼šè°ƒç”¨æ˜“ç›¾è¿›è¡Œæ•æ„Ÿè¯æ£€æµ‹ï¼Œçº¿ç¨‹æ± +CompletableFutureå®Œæˆä¸¤æ¬¡gptæŸ¥è¯¢ï¼ŒgptæŸ¥è¯¢åšäº†ä¸€ç³»åˆ—å¼‚å¸¸å¤„ç†ï¼Œåœ¨redisä¸­ç¼“å­˜100å¤©ï¼Œæœ€åè°ƒç”¨æœ‰é“ç¿»è¯‘çš„grpcè¿›è¡Œå…œåº•ã€‚**\n\n\n#### è¡Œä¸šè¯\n\n- é¦–å…ˆåˆ¤æ–­æ˜¯å¦ä¸ºç©ºï¼Œæˆ–è€…æ˜¯å¦ä¸ºæ•æ„Ÿè¯ï¼ˆè°ƒç”¨ç½‘æ˜“æ˜“ç›¾ï¼‰ï¼Œéšåä¼ å…¥ç”¨æˆ·ä¿¡æ¯ï¼Œè®¿é—®æœåŠ¡ã€‚\n- æœåŠ¡å†…éƒ¨ï¼šå¤„ç†é€»è¾‘è·Ÿä¸Šæ–‡ç±»ä¼¼ï¼Œåœ¨redisä¸­å­˜å‚¨gptåŸå§‹å›ç­”ï¼Œä½†æ˜¯ç”±äºè¾“å‡ºçš„æ˜¯jsonï¼Œç›¸æ¯”äºè¿‘ä¼¼è¯å’Œè¡Œä¸šè¯çš„æ•°ç»„ï¼Œè¿™é‡Œæœ‰æ”¹å˜ã€‚\n- å»é™¤\"\\`\\`\\`json\"å’Œ\"\\`\\`\\`\"è¿™ç±»mdè¯­æ³•ï¼Œå†æ ¹æ®\"è¡Œä¸šä¸€ï¼ŒäºŒï¼Œä¸‰\"jsonå½¢å¼åŒ…è£…ã€‚\n- è¿™é‡Œè¦åšä¸€äº›å¼‚å¸¸å¤„ç†ä»¥å¢åŠ å¯ç”¨æ€§å’Œé²æ£’æ€§ï¼Œè™½ç„¶æç¤ºè¯é‡Œé¢å†™çš„æ˜¯ç”¨\"\\#\"éš”å¼€ï¼Œä½†æ˜¯å®é™…ä¸Šå¯èƒ½è¿”å›çš„è¿˜æ˜¯\",\"æˆ–è€…\"ã€\"ï¼Œç”¨ä¸€ä¸ªå‡½æ•°å¯¹å…¶è¿›è¡Œæ‹†åˆ†ã€‚\n- æœ€åè°ƒç”¨æœ‰é“ç¿»è¯‘å…œåº•ã€‚\n\n## éœ€æ±‚6ï¼šè®¢é˜…æ›´æ–°ä»»åŠ¡\n\nè®¢é˜…æ›´æ–°é“¾è·¯ï¼š\n\n1. ç”¨æˆ·å‰ç«¯ç‚¹å‡»é¡µé¢å°±ä¼šæ›´æ–°è®¢é˜…å…¬å¸çš„watchTimeå­—æ®µï¼Œä¸€å¤©ä¹‹å†…åªæ›´æ–°ä¸€æ¬¡ã€‚\n2. xxljobæ¯å‘¨æ‰«åº“ï¼Œæœç´¢çš„æ˜¯è®¢é˜…å…¬å¸çš„é‚£ä¸ªè¡¨ï¼Œå°†watchTimeåœ¨å‰ä¸€å‘¨çš„å…¬å¸å‘é€kafkaï¼ˆè‡ªå¢idè€Œä¸æ˜¯å…¬å¸idï¼‰\n3. kafkaæ¶ˆè´¹è€…æ‹¿åˆ°è¿™äº›idå»æ•°æ®åº“æ‰¾å¯¹åº”çš„å…¬å¸ï¼Œå°†è®¢é˜…å…¬å¸è¡¨é¡¹å’Œå…¬å¸å®ä½“é¡¹ï¼ˆä»esæ¥çš„ï¼Œå¦‚æœå‰è€…æœ‰companyIdå°±ç›´æ¥æŸ¥è¯¢ï¼Œå¦‚æœæ²¡æœ‰å°±éœ€è¦æ ¹æ®åå­—å’Œåœ°åŒºæ¥æŸ¥è¯¢å¹¶ä¿å­˜ï¼‰ä½œä¸ºå‚æ•°ä¼ åˆ†åˆ«åˆ†æ**facebookä¿¡æ¯ï¼ŒfacebookæåŠä¿¡æ¯ï¼Œæµ·å…³ä¿¡æ¯ï¼Œè”ç³»äººä¿¡æ¯**ï¼Œå¼€äº†ä¸€ä¸ªçº¿ç¨‹æ± å¹¶è¡Œå¤„ç†è¿™äº›ã€‚\n\n### 1.facebookä¿¡æ¯\n\nä»£ç å¤ªé•¿äº†ï¼Œæ¢³ç†ä¸€ä¸‹å°±è¿™å‡ éƒ¨åˆ†ï¼š\n\n1. æ ¹æ®å…¬å¸å®ä½“ä¸­çš„ç›¸å…³facebooké“¾æ¥å»è¯·æ±‚GRPCæ¥å£ï¼Œè¿”å›facebookå®ä½“ï¼Œå…¶ä¸­åŒ…å«ä¸ªäººä¿¡æ¯ï¼Œç‚¹èµæ•°é‡ï¼Œæœ€è¿‘æ¨æ–‡ç­‰ä¿¡æ¯ã€‚\n2. ä»è¿™é‡Œå¼€å§‹è¦æ³¨æ„é€»è¾‘ï¼Œæ¯”å¯¹çš„æ˜¯**GRPCè¯·æ±‚æ¥çš„æ•°æ®**å’Œ**å½“å‰æ•°æ®åº“ä¸­æœ€æ–°çš„log**ã€‚\n3. å»æ•°æ®åº“ä¸­æŸ¥è¯¢7ç§typeçš„logï¼Œå…ˆå…¨éƒ¨æŸ¥å‡ºæ¥ï¼Œç„¶åå†é€šè¿‡streamå’Œsortå¾—åˆ°æœ€è¿‘æ—¶é—´çš„logã€‚\n4. å°†è¿™äº›logåˆ†åˆ«ä¸GRPCè¯·æ±‚æ¥çš„æ•°æ®è¿›è¡Œæ¯”è¾ƒï¼Œä¾‹å¦‚åˆ¤æ–­facebookæ˜¯å¦æ›´æ–°äº†ï¼Œå°†æœ€è¿‘çš„ä¸€æ¡ç›¸å…³logçš„å†…å®¹æ‹‰å‡ºæ¥ä¸GRPCè¯·æ±‚æ¥çš„æ•°æ®è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœä¸ä¸€æ ·å°±éœ€è¦æ›´æ–°ï¼Œåœ¨åº“é‡Œé¢æ–°å¢ä¸€æ¡ã€‚\n\n> 1. facebookåœ°å€åˆå§‹åŒ–/å˜æ›´\n> 2. facebooké‚®ç®±åˆå§‹åŒ–/å˜æ›´\n> 3. facebookç½‘ç«™åœ°å€åˆå§‹åŒ–/å˜æ›´\n> 4. facebookç”µè¯åˆå§‹åŒ–/å˜æ›´\n> 5. facebookç‚¹èµã€å…³æ³¨åˆå§‹åŒ–\n> 6. facebookä¸­å‘å¸ƒäº†æ–°å¸–å­\n> 7. facebookè·å¾—1ä¸ªæ–°è¯„è®º\n\n### 2.facebookæåŠä¿¡æ¯\n\n1. ç±»ä¼¼ä¸Šé¢çš„ï¼ŒæåŠæ¶ˆæ¯ä¹Ÿæ˜¯ä»GRPCæ¥çš„ï¼Œå¦‚æœè¿”å›ä¸ºnullç›´æ¥è¿”å›ï¼Œè¿™é‡Œæ˜¯ä¸€ä¸ªlistï¼Œåªå…³æ³¨æœ€æ–°çš„ï¼Œæ‰€ä»¥ä¹Ÿæœ‰stream+sortã€‚\n2. å»æ•°æ®åº“æŸ¥è¯¢å½“å‰æœ€æ–°çš„logï¼Œä¸»è¦å…³æ³¨çš„æ˜¯è¿™ä¸ªè®°å½•çš„createTimeã€‚\n3. å¦‚æœæ•°æ®åº“æ²¡æœ‰ï¼Œé‚£å°±è¯´æ˜æ˜¯æœ€æ–°æ›´æ–°çš„ï¼Œå‘æ•°æ®åº“æ’å…¥ä¸€æ¡æ–°çš„logè¡¨æ˜æœ‰è¢«æåŠï¼Œç›´æ¥è¿”å›ã€‚\n4. å¦‚æœæ•°æ®åº“æœ‰ä½†logçš„æ—¶é—´æ¯”GRPCæ¥çš„æ—©ï¼Œè¯´æ˜æœ‰æ–°æåŠï¼Œè¿›è¡Œæ›´æ–°ã€‚\n\n### 3.æµ·å…³ä¿¡æ¯\n\n1. å°†å…¬å¸åç§°æ ¼å¼åŒ–ï¼Œéšåå»æµ·å…³æ•°æ®é‡Œé¢æŸ¥æ‰¾æ–°å¢è¿›å‡ºå£æ•°æ®ï¼Œåˆ†åˆ«æ”¾åœ¨ä¸¤ä¸ªlisté‡Œé¢ã€‚\n2. å¦‚æœæœ‰è¿›å‡ºå£å°±åˆ†åˆ«æ–°å¢logã€‚\n\n```java\npublic void customProcess(TbGlobalCollectEntity record, CompanySearchBO companyBO, Date startDate, Date endDate) {\n    //æµ·å…³é‚£è¾¹çš„ç»Ÿä¸€æ ¼å¼\"CompanyName-COMBINE-TANZANIA\"ä¾‹å¦‚\"101 INVESTMENT-COMBINE-TANZANIA\"\n    String nameAndCountry = CompanyFormatUtils.combineCompanyNameAndCountry(companyBO.getName(), companyBO.getCountry());\n    //å»å–å‡ºæ˜¨å¤©çš„æ–°å¢hscodeï¼Œè¿™ä¸ªè¡¨ä¸»è¦æ˜¯æµ·å…³ç³»ç»Ÿåœ¨ç»´æŠ¤\n    Map<String, CustomInfoBO> map = customDataComponent.batchGetCompanyNewTrxHscode(Lists.newArrayList(nameAndCountry), startDate, endDate);\n    List<TbGlobalCollectLogEntity> tbGlobalCollectLogEntities = Lists.newArrayList();\n    if(map.containsKey(nameAndCountry)){\n        CustomInfoBO customInfoBO = map.get(nameAndCountry);\n        //å‡ºå£\n        if(!CollectionUtils.isEmpty(customInfoBO.getExportHsCodeList())){\n            TbGlobalCollectLogEntity t = new TbGlobalCollectLogEntity();\n            t.setCollectId(record.getId());\n            t.setLogDesc(\"æ–°ä¾›åº”äº†hscodeä¸º\" + Strings.join(customInfoBO.getExportHsCodeList(), \",\") + \"ç­‰çš„å•†å“\");\n            t.setContent(JSON.toJSONString(customInfoBO.getExportHsCodeList()));\n            t.setType(CollectLogTypeEnum.CUSTOM_SHN.getType());\n            t.setCreateTime(new Date());\n            t.setUpdateTime(new Date());\n            t.setInit12(0);\n            tbGlobalCollectLogEntities.add(t);\n        }\n        //è¿›å£\n        if(!CollectionUtils.isEmpty(customInfoBO.getImportHsCodeList())){\n            TbGlobalCollectLogEntity t = new TbGlobalCollectLogEntity();\n            t.setCollectId(record.getId());\n            t.setLogDesc(\"æ–°é‡‡è´­äº†hscodeä¸º\" + Strings.join(customInfoBO.getImportHsCodeList(), \",\") + \"ç­‰çš„å•†å“\");\n            t.setContent(JSON.toJSONString(customInfoBO.getImportHsCodeList()));\n            t.setType(CollectLogTypeEnum.CUSTOM_CON.getType());\n            t.setCreateTime(new Date());\n            t.setUpdateTime(new Date());\n            t.setInit12(0);\n            tbGlobalCollectLogEntities.add(t);\n        }\n    }\n    if(!CollectionUtils.isEmpty(tbGlobalCollectLogEntities)){\n        tbGlobalCollectLogEntityService.saveAll(tbGlobalCollectLogEntities);\n    }\n}\n```\n\n### 4.è”ç³»äººä¿¡æ¯\n","tags":["ç½‘æ˜“"]},{"title":"ç½‘æ˜“ç‰›é©¬æ—¥å¿—-week3","url":"/2024/12/05/ç½‘æ˜“ç‰›é©¬æ—¥å¿—-week3/","content":"# éœ€æ±‚3ï¼šä¼˜åŒ–åº”ç”¨ä¾§åˆ†é¡µæŸ¥è¯¢æ”¶è—æ¥å£\n\nåˆ©ç”¨ä¸ŠwatchTimeå­—æ®µï¼Œxxljobåªæ›´æ–°ä¸Šä¸€å‘¨æŸ¥çœ‹è¿‡çš„æ¡ç›®ï¼Œå¯ä»¥å‡å°‘å¸¦å®½ã€‚\n\n## 1.æ”¹é€ åˆ¤æ–­é€»è¾‘\n\nä¿å­˜watchTimeï¼Œé¦–å…ˆéœ€è¦è·å¾—è¯¥ç”¨æˆ·çš„accountIdï¼Œè¿˜è¦è·å–æŸä¸€æ¡æ¨èå¯¹è±¡çš„æ—§watchTimeï¼Œåˆ¤æ–­æ˜¯å¦æ˜¯ä»Šå¤©ï¼Œå¦‚æœæ˜¯ä¸€å¤©é‚£å°±ä¸ç”¨æ›´æ–°ï¼Œå¦‚æœæ˜¯ä¸€å¤©å°±éœ€è¦æ›´æ–°ã€‚\n\n```text\nif (!pageRes.getContent().isEmpty()){\n    Date oldWatchTime = pageRes.getContent().get(0).getWatchTime();\n    watchTimeJudgeAndUpdate(Long.parseLong(AuthInfoUtils.getContext().getAuthInfo().getAccId()),oldWatchTime);\n}\n```\n\n> è¿™ä¸ªæ–¹æ³•æŒ‰é“ç†æ¥è¯´è¦å˜æˆå¼‚æ­¥çš„ï¼Œçœ‹åç»­ç”¨å¤šçº¿ç¨‹æˆ–è€…@Asyncè§£å†³\n\n```java\nprivate void watchTimeJudgeAndUpdate(Long accountId,Date oldWatchTime){\n    try {\n        //ä¸€å¤©åªä¿å­˜ä¸€æ¬¡watchTime\n        if (oldWatchTime == null || !isSameDay(oldWatchTime,new Date())){\n            tbGlobalCollectEntityService.updateWatchTime(accountId);\n        }\n        log.info(\"watchTimeUpdate success , accountId : {}\",accountId);\n    }\n    catch (Throwable e){\n        log.error(\"watchTimeUpdate failed , accountId : {}\",accountId,e);\n    }\n}\n\nprivate boolean isSameDay(Date date1, Date date2) {\n    SimpleDateFormat sdf = new SimpleDateFormat(\"yyyyMMdd\");\n    return sdf.format(date1).equals(sdf.format(date2));\n}\n```\n\nè¿™é‡Œåˆšå¼€å§‹æ˜¯ç”¨äº†jpaçš„æŠ½è±¡ä»“åº“ä¸€ä¸ªä¸€ä¸ªæ›´æ–°ï¼Œä½†æ˜¯mentorè¯´æ•ˆç‡å¤ªä½äº†ï¼Œä¸å¦‚ç›´æ¥å†™sqlï¼Œåœ¨è¿™ä¸ªæ–¹æ³•é‡Œé¢æ”¯æŒè·Ÿmybatisé‚£æ ·ç›´æ¥æ‰§è¡Œsqlã€‚\n\n```java\n@Service\npublic class TbGlobalCollectEntityService extends AbstractEasyEntityService<TbGlobalCollectEntity> {\n\n    @Autowired\n    private TbGlobalCollectRepository repository;\n    public void updateWatchTime(Long accountId){\n        repository.updateWatchTime(accountId);\n    }\n}\n```\n\nsqlæ˜¯æ›´æ–°æ‰€æœ‰å½“å‰accountIdä¸‹ï¼Œæ²¡æœ‰å–æ¶ˆæ‰çš„æ¨èæ¡ç›®ï¼ŒæŠŠä»–ä»¬çš„watchTimeéƒ½æ”¹ä¸ºç°åœ¨ã€‚\n\nè¿™é‡Œä¸éœ€è¦è¿”å›å½“å‰æ—¶é—´ï¼Œå°±æ›´åŠ è¯´æ˜è¿™ä¸ªåˆ¤æ–­é€»è¾‘è·Ÿå‰ç«¯æ²¡ä»€ä¹ˆå…³ç³»äº†ï¼Œæ‰€ä»¥åº”è¯¥ç”¨å¼‚æ­¥ã€‚\n\n```text\n@Modifying\n@Transactional\n@Query(value = \"update TbGlobalCollectEntity p set p.watchTime=NOW() where p.status != -1 and p.accountId = :accountId\")\nint updateWatchTime(@Param(\"accountId\") Long accountId);\n```\n\n## 2.xxljobæ”¹é€ \n\nä¿å­˜äº†watchTimeï¼Œæ¯å‘¨æ‰§è¡Œä¸€æ¬¡çš„å®šæ—¶ä»»åŠ¡éœ€è¦æ”¹æˆæŸ¥è¯¢æ‰€æœ‰watchTimeä¸ºä¸Šå‘¨çš„æ¡ç›®ã€‚\n\nDateUtilè¿™ä¸ªå·¥å…·å¯ä»¥æ‰¾åˆ°ä»Šå¤©0ç‚¹å’Œä¸Šå‘¨0ç‚¹çš„Dateå¯¹è±¡ï¼Œç„¶åå†ç”¨jpaè¿›è¡ŒæŸ¥è¯¢ï¼ŒæŠŠæ‰€æœ‰çš„æ•°æ®æŠ•å…¥kafkaé‡Œã€‚\n\n> ä¼˜åŒ–çš„æœ¬æ„æ˜¯å‡å°‘éƒ¨åˆ†æŒ–æ˜facebookçš„æµé‡ã€‚ä½†æ˜¯å› ä¸ºåœ¨è¿™ä¸ªtopicé‡Œé¢ä¸æ­¢æœ‰è¿™ä¸ªä»»åŠ¡ï¼Œè¿˜æœ‰éƒ¨åˆ†é€šè®¯å½•æŒ–æ˜çš„ä»»åŠ¡ã€‚å‡å°‘äº†è¿™éƒ¨åˆ†æµé‡åŒæ—¶ä¹Ÿä¼šå‡å°‘é€šè®¯å½•æŒ–æ˜çš„æµé‡ï¼Œä½†æ˜¯åè€…æ›´åŠ æœ‰ä»·å€¼ï¼Œå¹¶ä¸åº”è¯¥å‡å°‘ã€‚æ‰€ä»¥æŒ‰ç…§é“ç†æ¥è¯´åº”è¯¥åˆ†ä¸ºä¸¤ä¸ªtopicè¿›è¡Œæ“ä½œã€‚\n\n```java\npublic void collectLogUpdate(int param) {\n    Date endDate = DateUtil.trimAndIncreDate(new Date(),0);\n    Date startDate = DateUtil.trimAndDecreDate(new Date(), param);\n    List<Specification<TbGlobalCollectEntity>> specifications = Lists.newArrayList();\n    specifications.add(of(TbGlobalCollectEntity.class, \"status\", NEQ, GlobalSubscribeStatusEnum.DELETE.getStatus()));\n    specifications.add(of(TbGlobalCollectEntity.class, \"watchTime\", GTE, startDate));\n    specifications.add(of(TbGlobalCollectEntity.class, \"watchTime\", LTE, endDate));\n    List<TbGlobalCollectEntity> records = tbGlobalCollectEntityService.findAll(specifications);\n    if (CollectionUtils.isEmpty(records)) {\n        return;\n    }\n\n    for (TbGlobalCollectEntity record : records) {\n        kafkaProducer.send(KafkaConstants.COWORK_GLOBAL_COLLECT_DETAIL_CHANGE, String.valueOf(record.getId()), String.valueOf(record.getId()));\n    }\n}\n```\n\n## éœ€æ±‚4ï¼šæŸ¥éªŒ500æ¡æ•°æ®\n\nè¿™ä¸ªçš„å·¥ä½œé‡ä¸åœ¨ä»£ç ä¸Šè€Œåœ¨äºexcelä¸Šï¼Œå­¦åˆ°äº†ä¸€äº›æŠ€å·§ã€‚\n\n```text\nGET cowork_global_domain_info/_search\n{\n  \"query\": {\n    \"bool\": {\n      \" must \": [\n        {\n          \"exists\": {\n            \"field\": \"recommendData\"\n          }\n        }\n      ]\n    }\n  }\n    ,\"sort\": {\n    \"_script\": {\n      \"script\": \"Math.random()\",\n      \"type\": \"number\",\n      \"order\": \"asc\"\n    }\n  }\n  ,\"_source\": [\"recommendData\"]\n}\n```\n\néœ€è¦æ³¨æ„çš„ç‚¹ï¼š\n\n1. éšæœºä»917wä¸­æ‰¾ï¼Œè¿™é‡Œsortè¦ç”¨randomè„šæœ¬\n2. æœ€å¥½ä¸è¦ç”¨æ»šåŠ¨æŸ¥è¯¢ï¼Œæœ‰å¤šå°‘æ¡æ˜¯å¤šå°‘æ¡\n3. searchHitå¯¹è±¡æ˜¯ä¸€ä¸ªå¤§çš„å¯¹è±¡DomainIndexBOï¼ŒrecommendDataåªæ˜¯å…¶ä¸­çš„ä¸€ä¸ªå­—æ®µã€‚æ‰€ä»¥getSourceAsStringåŒ…è£…çš„æ˜¯DomainIndexBOï¼Œåˆšå¼€å§‹ç±»å‹è½¬æ¢æ²¡å¼„æ˜ç™½è€½è¯¯å¾ˆä¹…ã€‚\n4. excelå°æŠ€å·§ï¼šåœ¨è¿™ç§éœ€è¦ä¿ç•™å¾ˆå¤šå­—æ®µçš„æ—¶å€™å¯ä»¥ç”¨ï¿¥(dollarç¬¦)åˆ†å¼€ï¼Œå› ä¸ºå¾ˆå°‘æœ‰ä¸šåŠ¡é‡Œé¢ä¼šç”¨ï¼Œé˜²æ­¢è¯¯æ“ä½œã€‚ä¾‹å¦‚åœ¨è¿™ä¸ªåœºæ™¯é‡Œé¢æ—¥å¿—å¯ä»¥æ‰“å°æˆ\"{recommendData.domain}ï¿¥{recomendData.other}\"ï¼Œç„¶ååœ¨excelæŒ‰ç…§ï¿¥åˆ†è¡Œã€‚\n\n```java\npublic void esGet() {\n    Script script = new Script(\"Math.random()\");\n    ScriptSortBuilder sortBuilder = new ScriptSortBuilder(script, ScriptSortBuilder.ScriptSortType.NUMBER)\n            .order(SortOrder.ASC);\n    BoolQueryBuilder boolQuery = QueryBuilders.boolQuery();\n    boolQuery.must(QueryBuilders.existsQuery(\"recommendData\"));\n    SearchSourceBuilder sourceBuilder = new SearchSourceBuilder()\n            .query(boolQuery) // æŸ¥è¯¢å‚æ•°\n            .fetchSource(new String[]{\"recommendData\"}, null)\n            .sort(sortBuilder)\n            .size(500);\n    SearchHit[] searchHits = domainDataIndex.query(sourceBuilder);\n    int i = 1;\n    for (SearchHit searchHit : searchHits) {\n        DomainIndexBO domainIndexBO = JSON.parseObject(searchHit.getSourceAsString(),DomainIndexBO.class);\n        RecommendDataBO recommendData = domainIndexBO.getRecommendData();\n        StringBuilder stringBuilder = new StringBuilder();\n        stringBuilder.append(\"$\");\n        stringBuilder.append(recommendData.getDomain()).append(\"$\");\n        stringBuilder.append(String.join(\",\", recommendData.getProducts())).append(\"$\");\n        if (recommendData.getAliCategories().isEmpty()){\n            stringBuilder.append(\"null\");\n        }\n        else {\n            for (RecommendDataBO.AliCategory aliCategory : recommendData.getAliCategories()) {\n                stringBuilder.append(aliCategory.getName()).append(\":\").append(aliCategory.getScore()).append(\",\");\n            }\n        }\n\n        stringBuilder.append(\"$\").append(recommendData.getIsBizP()).append(\"$\");\n        stringBuilder.append(recommendData.getIsBizVersion()).append(\"$\");\n        stringBuilder.append(recommendData.getProductsVersion()).append(\"$\");\n        if (StringUtils.isBlank(recommendData.getAliCategoryVersion())){\n            stringBuilder.append(\"null\");\n        }\n        else {\n            stringBuilder.append(recommendData.getAliCategoryVersion());\n        }\n\n\n        String result = stringBuilder.toString();\n        log.info(\"ç¬¬\"+i+\"ä¸ª:\"+result);\n        i++;\n    }\n}\n```\n\nã€‚ã€‚ã€‚æœªå®Œå¾…ç»­\n","tags":["ç½‘æ˜“"]},{"title":"ç½‘æ˜“ç‰›é©¬æ—¥å¿—-week1-2","url":"/2024/12/02/ç½‘æ˜“ç‰›é©¬æ—¥å¿—-week1-2/","content":"\n# éœ€æ±‚1ï¼šä¸æ¨èä¾§æ•°æ®åŒæ­¥\n\n## 1.é…ç½®kafka\n\nkafkaæ‰¹é‡æ¶ˆè´¹ï¼Œè®¾ç½®æ¶ˆè´¹è€…ç»„ï¼Œä½¿å¾—æ¯æ¬¡æ¶ˆè´¹çš„æ—¶å€™ä»å¤´æ¶ˆè´¹\n\n> æ¶ˆè´¹è€…ç»„èƒ½ä»å¤´å¼€å§‹æ¶ˆè´¹å¿…é¡»å¾—æœ‰æ¶ˆæ¯ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœæ¶ˆæ¯è¿‡æœŸäº†è¿˜æ˜¯æ¶ˆè´¹ä¸äº†çš„ï¼Œè¿™ä¸ªè¿‡æœŸæ—¶é—´åœ¨delete.retention.msé‡Œé¢é…ç½®ï¼Œå½“å‰topicçš„è¿‡æœŸæ—¶é—´æ˜¯604800000ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªç¤¼æ‹œã€‚\n>\n> è¿˜æœ‰ä¸€ç§åŠæ³•æ˜¯é€šè¿‡kafkaç»™å®šçš„æŸä¸ªè„šæœ¬å‚æ•°æ¥æŒ‡å®šoffsetçš„æ¶ˆè´¹ä½ç½®ã€‚\n\n```java\n@Bean\npublic KafkaListenerContainerFactory<ConcurrentMessageListenerContainer<String, String>>\nrecommendDomainDataListenerContainer(KafkaProperties kafkaProperties) {\n    ConcurrentKafkaListenerContainerFactory<String, String> factory = new ConcurrentKafkaListenerContainerFactory<>();\n    Map<String, Object> map = kafkaProperties.buildConsumerProperties();\n    //æ‰¹é‡æ¶ˆè´¹50ä¸ª\n    map.put(ConsumerConfig.MAX_POLL_RECORDS_CONFIG, 50);\n    map.put(ConsumerConfig.MAX_POLL_INTERVAL_MS_CONFIG, 10 * 60 * 1000);\n    map.put(ConsumerConfig.HEARTBEAT_INTERVAL_MS_CONFIG, 3000); // 3ç§’ä¸ŠæŠ¥ä¸€æ¬¡å¿ƒè·³\n    map.put(ConsumerConfig.SESSION_TIMEOUT_MS_CONFIG, 10 * 60 * 1000);\n    map.put(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG, \"earliest\");//æ¶ˆè´¹è€…ç»„æ¯æ¬¡éƒ½ä»å¤´å¼€å§‹æ¶ˆè´¹\n    ConsumerFactory<String, String> consumerFactory = new DefaultKafkaConsumerFactory<>(map);\n    factory.setConsumerFactory(consumerFactory);\n    factory.setConcurrency(2); // 2ä¸ªçº¿ç¨‹\n    factory.setBatchListener(true);\n    return factory;\n}\n```\n\n## 2.é…ç½®kafkaçš„æ¶ˆè´¹è€…\n\nç”±äºæ˜¯æ‰¹é‡è¯·æ±‚rpcæ¥å£ï¼Œå› æ­¤éœ€è¦è§£å†³è¯·æ±‚å¤±è´¥å¸¦æ¥çš„**æ¶ˆæ¯ä¸¢å¤±**é—®é¢˜ï¼Œæ„æ€æ˜¯å¦‚æœè¯·æ±‚å¤±è´¥äº†ï¼Œè¿™äº›domainè¿˜ä¼šè¢«æ¶ˆè´¹ï¼Œè¿™é‡Œçš„æ€è·¯æ˜¯ç”¨ä¸€ä¸ªsetæ¥ä¿å­˜æ²¡æœ‰æ¶ˆè´¹çš„domainï¼Œå¦‚æœåœ¨æŸå¤„å‡ºé”™äº†ï¼Œå°±ä¼šé‡æ–°å¾€kafkaé‡Œé¢å‘æ¶ˆæ¯ï¼Œå®ç°ä¸æ¼æ¶ˆæ¯ã€‚\n\n> 2024.12.2 åœ¨è¿™ä¸Šé¢æ ½äº†è·Ÿå¤´\n>\n> æƒ³æ³•å¾ˆç¾å¥½ä½†æ˜¯å®é™…ä¸Šçº¿è¿˜æ˜¯å‡ºç°äº†æ¼æ¶ˆæ¯ï¼ŒæˆåŠŸç‡åªæœ‰90%ã€‚\n>\n> é¦–å…ˆè¿™ä¸ªdomainSetä¸èƒ½è®¾ç½®æˆå…¨å±€å˜é‡ï¼Œå› ä¸ºæ‰€æœ‰çš„çº¿ç¨‹éƒ½ä¼šæ›´æ”¹è¿™ä¸ªå˜é‡ï¼Œä¼šæœ‰å¤æ‚çš„å¹¶å‘å®‰å…¨é—®é¢˜ã€‚å…¶æ¬¡æ˜¯å¯èƒ½å‡ºç°å¼‚å¸¸çš„æ—¶é—´ç‚¹ï¼š\n>\n> - æ¶ˆè´¹çš„æ—¶å€™å°±å‡ºç°é—®é¢˜ï¼Œå¯èƒ½æ€§å¾ˆå°\n> - æ‹¿ç€æ‰€æœ‰50æ¡å»è¯·æ±‚rpcæ¥å£çš„æ—¶å€™\n> - rpcæ¥å£å¤±è´¥æˆ–è€…åˆ«çš„çŠ¶æ€ç \n> - esæ›´æ–°å‡ºé”™\n>\n> ç”±æ­¤å¯è§éœ€è¦åœ¨rpcæ¥å£è¯·æ±‚ä¹‹å‰å°±è¦åˆå§‹åŒ–domainSetï¼Œæ‰€ä»¥åœ¨æ¶ˆè´¹æ¶ˆæ¯çš„æ—¶å€™å°±éœ€è¦åŒæ—¶åŠ å…¥domainSetã€‚ä½†å¦‚æœrpcæ¥å£è¯·æ±‚æˆåŠŸäº†ï¼Œéœ€è¦æ¸…ç©ºdomainSetï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸ºæœ‰å¯èƒ½domainæ˜¯50ä¸ªï¼Œé‚£è¾¹åªæœ‰40ä¸ªå¯è¿”å›åŸŸåï¼Œå¦‚æœå†æŒ‰ç…§50ä¸ªå°±ä¼šæœ‰æ¶ˆæ¯è¢«é‡å¤å‘é€ï¼Œä¾‹å¦‚è™½ç„¶æ¶ˆæ¯é‡Œé¢æœ‰www.baidu.comï¼Œä½†æ˜¯rpcæ¥å£é‡Œé¢æ­»æ´»æ²¡æœ‰ï¼Œè¿™ä¸ªæ—¶å€™å†å»é‡æ–°å¾€kafkaé‡Œé¢æŠ•é‡æ–°æ¶ˆè´¹æ˜¯ä¸åˆé€‚çš„ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œéœ€è¦éå†responseï¼Œç„¶åä¿å­˜è¿›æ¸…ç©ºäº†çš„domainSeté‡Œé¢ã€‚\n\n```java\n@KafkaListener(\n        //è¿™é‡Œæ˜¯{}ï¼Œå¯ä»¥é…ç½®å¤šä¸ªtopic\n        topics = {TOPIC},\n        groupId = \"recommendation-ready-group-bugfix-v1\",\n        containerFactory = \"recommendDomainDataListenerContainer\"\n)\npublic void listener(List<ConsumerRecord<String, String>> records) {\n    log.info(\"RecommendDomainDataListener | size:{}\", records.size());\n    Set<String> domains = new HashSet<>();\n    Set<String> domainSet = new HashSet<>();\n    StopWatch sw = new StopWatch();\n    sw.start();\n    try {\n        for(ConsumerRecord<String, String> record :records) {\n            JSONObject kafkaMsg = JSON.parseObject(record.value());\n            String domain = kafkaMsg.getString(\"domain\");\n            domain = DomainUtil.format(domain);\n            if(StringUtils.isBlank(domain)) {\n                continue;\n            }\n            domains.add(domain);\n            domainSet.add(domain);\n        }\n        batchGetRecommendationDetail(domains,domainSet);\n    }\n    catch (Throwable e){\n        for (String domain : domainSet){\n            Map<String,String> map = new HashMap<>();\n            map.put(\"domain\",domain);\n            kafkaProducer.send(TOPIC, domain, JSON.toJSONString(map));\n        }\n        log.error(\"RecommendDomainDataListener | consumer message error. put in queue {}.\", JSON.toJSONString(domains),e);\n    }\n    finally {\n        sw.stop();\n        log.info(\"RecommendDomainDataListener | {}, cost: {}\", domains.size(), sw.getTime());\n    }\n}\n```\n\n## 3.GRPCè¯·æ±‚\n\ngrpcæ˜¯è®©è¿œç¨‹æ–¹æ³•å˜å¾—åƒæœ¬åœ°æ–¹æ³•ä¸€æ ·ç®€å•ï¼Œè¿™é‡Œç”¨äº†æ¨èä¾§çš„ä¸€ä¸ªæ¥å£ï¼Œç¡®å®åªç”¨å¼•ç”¨ä¸€ä¸ªjaråŒ…å°±è¡Œï¼ŒèƒŒåå°±æ˜¯ä¸€äº›å¤æ‚çš„ç½‘ç»œè¯·æ±‚ã€‚è¿™ä¸ªæ¥å£çš„å¯ä»¥ä¸€æ¬¡ä¼ 50ä¸ªdomainï¼ŒçŠ¶æ€ç ä¸»è¦å…³æ³¨429ï¼Œè¿™é‡Œæ˜¯è§¦å‘äº†é™æµï¼Œéœ€è¦æŒ‰ç…§ä¸Šé¢çš„æ–¹æ³•è¿›è¡Œé‡æ–°æ¶ˆè´¹ï¼Œæ¶ˆè´¹å¤šå°‘å‘é€å¤šå°‘ç›¸åŒçš„åŸŸåã€‚\n\n> grpcæ–¹æ³•çš„qpsæ˜¯1ï¼Œè§¦å‘äº†é™æµè¦é™é€Ÿï¼ŒThread.sleep(1000);\n\n```java\npublic void batchGetRecommendationDetail(Set<String> domains,Set<String> domainSet) throws InterruptedException {\n    Recommendation.GetDomainInfosRequest request = Recommendation.GetDomainInfosRequest.newBuilder()\n            .addAllDomains(domains)\n            .setDomainSourceValue(DOMAIN_SOURCE_GRPC_VALUE).build();\n    Recommendation.GetDomainInfosResponse response = recommendationClient.getDomainInfos(request);\n    if (response != null) {\n        if (!response.getSuccess() || response.getCode() != GRPC_SUCCESS_CODE){\n            //è§¦å‘grpcé™æµï¼Œè¯¥æ–¹æ³•é™é€Ÿï¼Œé‡æ–°æ¶ˆè´¹\n            Thread.sleep(1000);\n            throw new RuntimeException(String.valueOf(response.getCode()));\n        }\n        log.info(\"getRecommendationDetail. code:{}\",response.getCode());\n        if(!CollectionUtils.isEmpty(response.getDataList())){\n            List<Recommendation.DomainInfo> domainInfoList = response.getDataList();\n            for (Recommendation.DomainInfo domainInfo : domainInfoList){\n                domainSet.add(domainInfo.getDomain());\n            }\n            for (Recommendation.DomainInfo domainInfo : domainInfoList){\n                convert(domainInfo,domainSet);\n            }\n        }\n    }\n    else {\n        throw new RuntimeException(\"Recommendation.GetDomainInfosResponse returns null\");\n    }\n}\n\n```\n\n## 4.è½¬æ¢å¯¹è±¡\n\nè¿™ä¸ªæ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œå°±æ˜¯æ‹·è´å±æ€§åˆ°å½“å‰é¡¹ç›®çš„bean\n\n## æ€»ç»“\n\nä¸»è¦ç†Ÿæ‚‰äº†æµ‹è¯•ç¯å¢ƒå’Œçº¿ä¸Šç¯å¢ƒï¼Œä»¥åŠkafkaçš„ä¸€äº›é…ç½®å’Œæœºåˆ¶ï¼Œå¯¹äºå¼‚å¸¸å¤„ç†çš„ç†è§£åŠ æ·±äº†ã€‚\n\n\n# éœ€æ±‚2ï¼šå®šæ—¶å‘é€æ–°åŸŸå\n\néœ€è¦æ¯å¤©çš„00:00å»esé‡Œé¢æ£€æŸ¥æ˜¨å¤©æ–°å¢çš„åŸŸåï¼Œé€šè¿‡kafkaå‘é€æ¶ˆæ¯ã€‚\n\n1. è®¡ç®—æ˜¨å¤©00:00åˆ°23ï¼š59çš„æ—¶é—´æˆ³ï¼šç”±äºå­—æ®µé‡Œé¢åªæœ‰updateTimeæ²¡æœ‰createTimeï¼Œè€Œä¸”ä¹Ÿæ˜¯ç”¨æ—¶é—´æˆ³æ¥ä¿å­˜çš„ï¼Œè¦å…ˆè®¡ç®—ä¸€ä¸‹æ—¶é—´ã€‚\n2. æ‹¼esçš„æŸ¥è¯¢è¯­å¥ï¼šrangeæ¥æŸ¥è¯¢æ—¶é—´ï¼ŒsynFlagæ˜¯é˜²æ­¢é‡å¤å‘é€çš„ï¼Œæœ‰è¿™ä¸ªå­—æ®µçš„å¯ä»¥è®¤ä¸ºå·²ç»å‘è¿‡äº†ã€‚\n3. scrollSearchå¾ªç¯æŸ¥æ‰¾ï¼Œä¸äº†è§£ï¼Œä½†æ˜¯å¤§å®¶éƒ½æ˜¯è¿™æ ·ç”¨çš„ã€‚\n\n> esçš„æ“ä½œè·Ÿæ•°æ®åº“å¾ˆåƒï¼Œè€Œä¸”ç½‘æ˜“å°è£…çš„å¾ˆå¥½ï¼Œindexå°±ç›¸å½“äºæ•°æ®åº“è¡¨åï¼ŒDomainDataIndexå¯ä»¥çœ‹ä½œmybatisçš„å®ç°ç±»ï¼ŒAbstractIndexå°±æ˜¯BaseMapperé‚£ç§ç”¨æ¥åŸºç¡€çš„\n\n```java\n@XxlJob(\"newDomainSyncRecommend\")\npublic ReturnT<String> newDomainSyncRecommend (String param) throws ParseException {\n    //æ˜¨å¤©çš„åŒä¸€æ—¶åˆ»\n    long yesterday = System.currentTimeMillis() - 1000 * 3600 * 24;\n    //æ˜¨å¤©é›¶ç‚¹é›¶åˆ†é›¶ç§’çš„æ¯«ç§’æ•°\n    long zero = yesterday / (1000 * 3600 * 24) * (1000 * 3600 * 24) - TimeZone.getDefault().getRawOffset();//ä»Šå¤©é›¶ç‚¹é›¶åˆ†é›¶ç§’çš„æ¯«ç§’æ•°\n    //æ˜¨å¤©23ç‚¹59åˆ†59ç§’çš„æ¯«ç§’æ•°\n    long twelve = zero + 24 * 60 * 60 * 1000 - 1;\n    BoolQueryBuilder boolQuery = QueryBuilders.boolQuery();\n    boolQuery.filter(QueryBuilders.rangeQuery(\"updateTime\")\n            .gte(zero)\n            .lte(twelve));\n    boolQuery.mustNot(QueryBuilders.existsQuery(\"synFlag\"));\n    SearchSourceBuilder sourceBuilder = new SearchSourceBuilder()\n            .query(boolQuery) // æŸ¥è¯¢å‚æ•°\n            .fetchSource(new String[]{\"domain\"},\n                    null)\n            .size(100);\n    if (domainDataIndex == null) {\n        log.error(\"domainDataIndex is null\");\n    }\n    domainDataIndex.scrollSearch(sourceBuilder, searchHits -> {\n        for (SearchHit searchHit : searchHits) {\n            String domain = searchHit.getId();\n            try {\n                //æ›´æ–°åŒæ­¥æ ‡è¯†\n                Map<String,Boolean> updateMap = new HashMap<>();\n                updateMap.put(\"synFlag\",true);\n                domainDataIndex.updateByProcessor(domain,updateMap);\n                log.info(\"domainDataIndex upsert success ,domain : {}\",domain);\n            }\n            catch (Throwable e){\n                log.error(\"domainDataIndex upsert failed ,domain : {}\",domain,e);\n                continue;\n            }\n            //ç»„ç»‡kafkaæ¶ˆæ¯\n            JSONObject jsonObject = new JSONObject();\n            jsonObject.put(\"domain\",domain);\n            kafkaProducer.send(\"new_domain_sync_recommend_topic\",domain,JSON.toJSONString(jsonObject));\n            log.info(\"kafka send success ,domain : {}\",domain);\n        }\n        return false;\n    });\n    return ReturnT.SUCCESS;\n}\n\n```\n","tags":["ç½‘æ˜“"]},{"title":"é¡¹ç›®é¢è¯•","url":"/2024/10/19/é¡¹ç›®é¢è¯•/","content":"## ç™»å½•æµç¨‹å’Œç™»å½•çŠ¶æ€ä¿å­˜\n- ä¹˜å®¢ç™»å½•ï¼šé¦–å…ˆæ ¹æ®å‰ç«¯å¾®ä¿¡å°ç¨‹åºä¼ æ¥çš„codeè¿›è¡Œä¹˜å®¢openidçš„è§£æï¼Œæ ¹æ®è¿™ä¸ªopenidè¿›è¡Œè½åº“ã€‚åœ¨æˆ‘ä»¬çš„é¡¹ç›®ä¸­ä¸ä¼šå¯¹å¤–æš´éœ²è¿™ä¸ªopenidï¼Œä½¿ç”¨çš„æ˜¯è‡ªå·±ç³»ç»Ÿçš„è‡ªå¢idã€‚å¦‚æœæ²¡æœ‰æ³¨å†Œå°±insertä¸€æ¡ã€‚æ¥ç€ç”¨rediså­˜å‚¨ç™»å½•çŠ¶æ€ï¼Œkeyæ˜¯UUIDï¼Œvalueæ˜¯è‡ªå·±æ•°æ®åº“çš„è‡ªå¢idã€‚æˆ‘ä»¬è¿™é‡Œç”¨çš„aop+threadlocal+æ³¨è§£ç±»ä¼¼ç½‘å…³çš„prehandleï¼Œå¤„ç†å‰ç«¯æ¯æ¬¡éƒ½æºå¸¦çš„tokenå­—æ®µï¼Œç„¶ååœ¨redisé‡Œæ ¹æ®è¿™ä¸ªkeyè¿›è¡ŒæŸ¥è¯¢ï¼Œå¦‚æœæ˜¯æ²¡æœ‰è¿™ä¸ªkeyå°±æ˜¯æ²¡æœ‰ç™»å½•è¿‡æœŸäº†ï¼Œå¦‚æœæ˜¯keyä¸ºç©ºå°±æ˜¯æ²¡æœ‰ç™»å½•ã€‚ç„¶åæ ¹æ®redisé‡Œçš„è¿™ä¸ªvalueå­˜å‚¨åˆ°threadlocalä¸­ï¼Œåç»­å°±å¯ä»¥ä»threadlocalä¸­getè¿™ä¸ªå­—æ®µè¿›è¡Œæ“ä½œã€‚\n- å¸æœºç™»å½•ï¼šæµç¨‹ä¸ä¸Šé¢çš„ç±»ä¼¼ï¼Œåªä¸è¿‡å¤šäº†é˜¿é‡Œäº‘çš„èº«ä»½æ ¡éªŒã€‚\n\n**threadLocalçš„åŸç†**\n\nthreadlocalæ˜¯æ ¹æ®çº¿ç¨‹ç‹¬ç«‹çš„å˜é‡ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯ä¸€ä¸ªçº¿ç¨‹å¯ä»¥å­˜å‚¨ä¸åŒçš„threadlocalï¼Œå½¼æ­¤æ˜¯éš”ç¦»çš„ã€‚å…¶åŸç†æ˜¯æ¯ä¸€ä¸ªThreadç±»éƒ½æœ‰ä¸€ä¸ªthreadLocalMapï¼Œè¿™ä¸ªmapç›¸å½“äºä¸€ä¸ªhashmapï¼Œkeyæ˜¯threadLocalå¯¹è±¡ï¼Œvalueæ˜¯å­˜å‚¨çš„å€¼ã€‚threadLocalæŸ¥è¯¢çš„æ—¶å€™å°±ä¼šå…ˆè·å–å½“å‰çº¿ç¨‹ï¼Œæ ¹æ®è¿™ä¸ªçº¿ç¨‹æ‰¾åˆ°threadLocalmapï¼Œå†æ‰¾åˆ°å…¶ä¸­çš„threadLocalå¯¹åº”çš„å€¼ã€‚\n\n**threadLocalçš„å†…å­˜æ³„éœ²é—®é¢˜**\n\nthreadLocalmapçš„keyæ˜¯å¼±å¼•ç”¨ï¼Œvalueæ˜¯å¼ºå¼•ç”¨ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœthreadlocalæ²¡æœ‰å¤–éƒ¨å¼ºå¼•ç”¨å°±ä¼šè¢«å›æ”¶ï¼Œè€Œvalueä¸ä¼šè¢«å›æ”¶ã€‚è¿™ä¸ªæ—¶å€™å°±ä¼šæœ‰å†…å­˜æ³„éœ²é—®é¢˜äº†ã€‚è§£å†³æ–¹æ³•æ˜¯ä¸å†ä½¿ç”¨threadLocalå°±æ‰‹åŠ¨remove\n\n## æœå¯»å‘¨å›´å¸æœºå’Œè®¢å•æ¨é€\nåœ¨å¸æœºå¼€å§‹æ¥å•ä¹‹åä¼šæŠŠè‡ªå·±çš„ä½ç½®ä¸Šä¼ åˆ°redisï¼Œç„¶åè¿›è¡Œç­‰å¾…ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­å¸æœºä¼šä¸æ–­è½®è¯¢è‡ªå·±redisçš„listæ˜¯å¦æœ‰æ•°æ®ã€‚åŒæ—¶ä¹˜å®¢ç«¯ä¸‹å•ä¹‹åä¼šæ–°å¢ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œä½¿ç”¨redisçš„grediuså‘½ä»¤æŸ¥è¯¢æ–¹åœ†5kmå†…çš„ç¬¦åˆè¦æ±‚çš„å¸æœºã€‚å¹¶ä¸”ä¸ºè¿™äº›å¸æœºçš„listéƒ½æ·»åŠ è¯¥è®¢å•å·ã€‚\n\n**ä¸ºä»€ä¹ˆè¦ç”¨å®šæ—¶ä»»åŠ¡**\n\nå› ä¸ºæ‰§è¡Œä¸€æ¬¡å¹¶ä¸ä¸€å®šå°±èƒ½åŠæ—¶å‘ç°å¸æœºï¼Œè½®è¯¢åˆå¤ªæ¶ˆè€—cpuï¼Œæ‰€ä»¥é‡‡ç”¨äº†å®šæ—¶ä»»åŠ¡ã€‚ä½¿ç”¨xxl-jobå¯ä»¥ç®¡ç†è¿™äº›å®šæ—¶ä»»åŠ¡ã€‚\n\n**å¼‚å¸¸æ€ä¹ˆå¤„ç†çš„**\n\næœ‰ä¸€ä¸ªå…œåº•ç­–ç•¥å°±æ˜¯è¶…æ—¶15åˆ†é’Ÿè‡ªåŠ¨å–æ¶ˆï¼Œå¦‚æœåœ¨è¿è¡Œè¿‡ç¨‹ä¸­å‡ºç°å¤±è´¥é¦–å…ˆxxl-jobä¼šæ˜¾ç¤ºæ‰§è¡Œå¤±è´¥ï¼ŒåŒæ—¶è®°å½•æ—¥å¿—ã€‚\n\n**å¦‚æœå‘¨å›´åªæœ‰ä¸€ä¸ªå¸æœºï¼Œä½†æ˜¯ä¸€ç›´ä¸æ¥å•ï¼Œå¦‚ä½•ä¿è¯ä»–çš„listä¸­æ¶ˆæ¯ä¸é‡å¤**\n\nè¿™é‡Œä½¿ç”¨äº†redisçš„seté›†åˆï¼Œkeyæ˜¯è®¢å•çš„idï¼Œæ¯å½“ä»»åŠ¡è°ƒåº¦æœç´¢åˆ°æœ€è¿‘çš„å¸æœºä¹‹åé¦–å…ˆä¼šæ ¡éªŒå¸æœºçš„idæ˜¯å¦åœ¨setä¸­ï¼Œå¦‚æœä¸åœ¨æ‰å¯ä»¥åŠ å…¥è‡ªå·±çš„listã€‚å¦‚æœåœ¨çš„è¯è¯´æ˜æ˜¯é‡å¤æäº¤äº†ã€‚\n\n**ä»»åŠ¡è°ƒåº¦ä½•æ—¶ç»ˆæ­¢**\n\nåœ¨æŸ¥è¯¢å‘¨å›´å¸æœºä¹‹å‰éƒ½ä¼šå…ˆæ£€æŸ¥å½“å‰è®¢å•çš„çŠ¶æ€ï¼Œé€šè¿‡å¦ä¸€ä¸ªå¾®æœåŠ¡çš„è°ƒç”¨ã€‚å¦‚æœè¿™ä¸ªè®¢å•çš„çŠ¶æ€å‘ç”Ÿæ”¹å˜è¯´æ˜å·²ç»æœ‰å¸æœºæ¥å•äº†ï¼Œè¿™ä¸ªä»»åŠ¡å°±ä¼šæå‰ç»ˆæ­¢ã€‚\n\n**ä¸ºä»€ä¹ˆä¸ç”¨mqå®ç°è¿™ä¸€éƒ¨åˆ†é€»è¾‘**\n\nredisçš„é€Ÿåº¦è¾ƒå¿«ï¼Œæ¯•ç«Ÿç”¨æˆ·çš„è§„æ¨¡ä¸ä¼šå¾ˆå¤§ï¼Œlistçš„è§„æ¨¡ä¹Ÿä¸ä¼šå¾ˆå¤§ï¼Œæš‚æ—¶ä¸ä¼šå­˜åœ¨å¤§keyé—®é¢˜ã€‚è€Œä¸”ä¹Ÿéœ€è¦æ‰¹é‡å¤„ç†è¿™äº›æ¶ˆæ¯å’Œé¢‘ç¹çš„åˆ é™¤ï¼Œå¦‚æœä¸ºæ¯ä¸€ä¸ªå¸æœºéƒ½å»ºç«‹ä¸€ä¸ªqueueæœ‰ä¸€ç‚¹å¥¢ä¾ˆï¼Œç»¼åˆä¸‹æ¥è¿˜æ˜¯redisä¸­listèƒ½å¤Ÿç®€åŒ–æ“ä½œã€‚\n\n## å¸æœºæŠ¢å•\næ¯ä¸ªå¸æœºåœ¨æ¥å•çš„è¿‡ç¨‹ä¸­éƒ½ä¼šè½®è¯¢è‡ªå·±åœ¨redisä¸­çš„listæ˜¯å¦æœ‰æ•°æ®ï¼Œå¦‚æœæœ‰å‰ç«¯å°±ä¼šæ˜¾ç¤ºå¹¶ä¸”å¯ä»¥é€‰æ‹©è®¢å•è¿›è¡ŒæŠ¢å•ã€‚ä¸»è¦é€»è¾‘æ˜¯é¦–å…ˆä¼šæ£€æŸ¥æ˜¯å¦è¿˜æœ‰è®¢å•ï¼Œè¿™ä¸ªæ˜¯é€šè¿‡åœ¨redisçš„ä¸€ä¸ªæ ‡è¯†å®ç°çš„ï¼Œå†ä¸‹å•çš„æ—¶å€™ä¼šç»™redisä¸€ä¸ªæ ‡è¯†ã€‚ç›®çš„æ˜¯ä¸ç”¨å»æ•°æ®åº“æŸ¥æ‰¾å½“å‰è®¢å•çš„çŠ¶æ€èŠ‚çº¦æ•°æ®åº“å¼€é”€ã€‚ä¸ºäº†é˜²æ­¢è¶…å–è¦ç”¨åˆ†å¸ƒå¼é”ï¼Œä¸ºå½“å‰è®¢å•idåŠ é”ã€‚åŠ é”ä¹‹åå†æ¬¡æ ¡éªŒæ˜¯å¦æœ‰æ ‡è¯†ï¼Œè¿›è¡Œæ¥å•æ“ä½œååˆ é™¤è¿™ä¸ªæ ‡è¯†å’Œé‡Šæ”¾é”ï¼Œå®ŒæˆæŠ¢å•é€»è¾‘ã€‚\n\n**åˆ†å¸ƒå¼é”ç”¨çš„æ˜¯ä»€ä¹ˆ**\n\nåŸºäºredisionçš„åˆ†å¸ƒå¼é”ï¼Œé”ä½çš„æ˜¯å¸æœºlistä¸­çš„è®¢å•idã€‚æœ¬è´¨è¿˜æ˜¯åŸºäºsetnxçš„ï¼Œåªä¸è¿‡redissionæœ‰çœ‹é—¨ç‹—æœºåˆ¶èƒ½å¤Ÿå»¶é•¿æ‰§è¡Œæ—¶é—´ï¼Œä¿è¯ä»»åŠ¡èƒ½å¤Ÿè¿›è¡Œå®Œæˆè€Œä¸ä¼šå‡ºç°åˆ é™¤åˆ«äººçš„é”çš„æƒ…å†µã€‚è¿™é‡Œå¯ä»¥ä¼˜åŒ–çš„åœ°æ–¹å¯ä»¥åšæˆluaè„šæœ¬ï¼Œåæ­£æ ‡è¯†ä¹Ÿæ˜¯åœ¨redisé‡Œé¢çš„ã€‚é€»è¾‘æ˜¯æŸ¥è¯¢æ ‡è¯†ç„¶åå¼‚æ­¥ä¸‹å•ç»™mqã€‚ä¹Ÿä¼šç¼©çŸ­å¸æœºæŠ¢å•çš„å“åº”æ—¶é—´ï¼Œ\n\n## å¸ä¹˜åŒæ˜¾\nåœ¨å¸æœºæ­£åœ¨å‰å¾€èµ·å§‹ç‚¹å’Œè¿›è¡ŒæœåŠ¡çš„æ—¶å€™ï¼Œä¹˜å®¢ä¹Ÿéœ€è¦çŸ¥é“å¸æœºåœ¨å“ªé‡Œã€‚å¸æœºä¼šå®šæ—¶å°†è‡ªå·±çš„æ•°æ®ä¸Šä¼ åˆ°mongodbä¸­ï¼Œä¹˜å®¢ç«¯ä¼šæ‰¾åˆ°æœ€è¿‘æ—¶é—´çš„å¸æœºç‚¹åæ ‡ï¼Œç„¶åè°ƒç”¨mapå¾®æœåŠ¡æ¸²æŸ“å‡ºè·¯å¾„ã€‚\n\n**ä¸ºä»€ä¹ˆä½¿ç”¨mongodbï¼Œç”¨redisæˆ–è€…mysqlå­˜å‚¨å‘¢**\n\n- è·¯å¾„æ•°æ®æ˜¯éœ€è¦æŒä¹…åŒ–ä¿å­˜çš„ï¼Œç”¨redisæ¯•ç«Ÿä¸æ˜¯è½åº“ï¼Œè€Œä¸”å­˜å‚¨çš„æ•°æ®é‡å¤§ä¸”åªéœ€è¦æ‰¾å‡ºæœ€è¿‘çš„ä¸€ä¸ªç‚¹ï¼Œå¤§éƒ¨åˆ†çš„æ•°æ®æ²¡æœ‰ç”¨ï¼Œä¼šæµªè´¹çè´µçš„ç¼“å­˜ç©ºé—´ï¼Œæ‰€ä»¥æœ€å¥½ä¸ç”¨redisã€‚\n- mysqlä¹Ÿä¸å¤ªé€‚åˆï¼Œå­˜å‚¨çš„ç‚¹æ•°æ®é‡å¾ˆå¤§è€Œmysqlè¶…è¿‡1kwæŸ¥è¯¢æ•ˆç‡å°±ä¼šå¾ˆä½ï¼Œä¹Ÿä¼šå­˜åœ¨æ·±åº¦åˆ†é¡µé—®é¢˜ï¼Œå¦‚æœå¤šä¸ªè®¢å•åŒæ—¶è¿›è¡Œå¹¶å‘ä¹Ÿæ˜¯mysqlçš„é—®é¢˜ã€‚å¤šä¸€ä¸ªå°‘ä¸€ä¸ªåæ ‡ç‚¹ä¸ä¼šæœ‰å¾ˆå¤§çš„é—®é¢˜ï¼Œæ‰€ä»¥ä½¿ç”¨å¦ä¸€ä¸ªæ•°æ®åº“è¿›è¡Œå­˜å‚¨ï¼Œç»è¿‡è°ƒç ”mongoèƒ½å¤Ÿæ»¡è¶³ã€‚\n\n**åŸºäºrocketmqçš„~~å»¶è¿Ÿé˜Ÿåˆ—~~å®Œæˆæ‰¹é‡å†™æ˜¯æ€ä¹ˆå®ç°çš„**\n> è¿™é‡ŒçœŸæ˜¯çŠ¯äº†ä¸€ä¸ªå¤§é”™è¯¯ã€‚\n\nä¸ºäº†å®ç°é«˜æ•ˆç‡å†™å¯ä»¥åˆå¹¶å¤šæ¬¡å†™è¯·æ±‚ï¼Œå®ç°æ‰¹é‡å†™ã€‚å…·ä½“æ˜¯è®¾ç½®rocketmqçš„æ‰¹é‡å¤„ç†åŠŸèƒ½ã€‚ä½†æ˜¯ä¼šå¢åŠ ä»£ç çš„å¤æ‚åº¦ï¼Œæ›´åŠ è½»é‡çº§çš„åšæ³•æ˜¯çº¿ç¨‹æ± å’Œé˜»å¡é˜Ÿåˆ—ã€‚\n\n## å¼‚æ­¥ç¼–æ’\nåœ¨å®Œæˆè®¢å•åä¼šæœ‰ä¸€ç³»åˆ—çš„è®¡ç®—è¿‡ç¨‹ï¼Œä¾‹å¦‚é˜²åˆ·å•æ ¡éªŒï¼Œåˆ†è´¦è®¡ç®—ï¼Œæ¨é€è´¦å•ç­‰ã€‚\n```text\n[Start]\n   |\n   +--> [è·å–è®¢å•ä¿¡æ¯]  ----+\n   |                        |\n   +--> [è·å–å¸æœºä½ç½®] ------+--> [ç­‰å¾…ä¸¤ä¸ªä»»åŠ¡å®Œæˆ]\n                                 |\n                                 v\n                       [è®¡ç®—è·ç¦»]\n                                 |\n               +-----------------+-----------------+\n               |                                   |\n        [è·ç¦» > 2å…¬é‡Œ]                       [è·ç¦» <= 2å…¬é‡Œ]\n               |                                   |\n         [æŠ›å‡ºå¼‚å¸¸]                         +----+----+\n                                               |         |\n                                       [è®¡ç®—å®é™…é‡Œç¨‹]   [è·å–è®¢å•æ•°é‡]\n                                               |         |\n                                       [è®¡ç®—è´¹ç”¨]    [è®¡ç®—å¥–åŠ±]\n                                               \\         /\n                                                \\       /\n                                        [è®¡ç®—åˆ†è´¦ä¿¡æ¯]\n                                               |\n                                      [å°è£…å¹¶æ›´æ–°è´¦å•]\n                                               |\n                                            [End]\n```\n\nè€ƒè™‘å°†è·å–è®¢å•ä¿¡æ¯å’Œè·å–ç›®çš„åœ°è·ç¦»è¿›è¡Œå¹¶è¡Œå¤„ç†ï¼Œä½¿ç”¨supplyAsyncå®ç°ä¸¤ä¸ªçº¿ç¨‹ï¼Œæœ€ååˆå¹¶ä¸€èµ·è¿›è¡Œè®¡ç®—å¾—åˆ°ç»“æœï¼›å†æ ¡éªŒè·ç¦»æ˜¯å¦å†å¯ä»¥æ¥æ”¶çš„èŒƒå›´å†…ï¼Œå¦‚æœæ˜¯ä¸æ˜¯åˆ·å•å°±å¹¶è¡Œè·å–è®¢å•æ•°é‡å’Œè®¡ç®—å®é™…é‡Œç¨‹ï¼Œè¿™ä¸ªæ˜¯æ ¹æ®mongodbä¸­çš„æ•°æ®è®¡ç®—çš„ï¼Œå¾—åˆ°è¿™ä¸¤ä¸ªä¿¡æ¯è¿›è¡Œè´¦å•è®¡ç®—å’Œæ¨é€è´¦å•ã€‚ä¸»è¦æ˜¯å°†å‡ ä¸ªä¸ç›¸å…³çš„å¾®æœåŠ¡é€šè¿‡å¤šçº¿ç¨‹å¹¶è¡Œè·å–äº†ã€‚\n\n**å¦‚ä½•æµ‹è¯•çš„40%æå‡**\n\næµ‹è¯•çš„è¯¥æ–¹æ³•çš„æ‰§è¡Œæ—¶é—´å‘ç°æ¯”åŸæ¥å¿«äº†40%ã€‚\n\n## åˆ†å¸ƒå¼äº‹åŠ¡\n\n**TCCçš„æµç¨‹**\n\ntry-confirm-cancelï¼Œæ˜¯ä¸€ç§ä¸šåŠ¡å…¥ä¾µçš„åˆ†å¸ƒå¼äº‹åŠ¡æ–¹æ³•ã€‚tryé˜¶æ®µä¼šé¢„ç•™èµ„æºï¼Œconfirmé˜¶æ®µç¡®å®šåˆ†å¸ƒå¼äº‹åŠ¡ä¸‹æ‰€æœ‰çš„æ‰§è¡Œå™¨éƒ½å·²ç»æˆåŠŸé¢„ç•™ï¼Œå¦‚æœå…¨éƒ¨æˆåŠŸå°±æ‰§è¡Œconfirmæäº¤äº‹åŠ¡ï¼Œå¦‚æœå¤±è´¥äº†å°±æ‰§è¡Œè¡¥å¿æªæ–½cancelã€‚è¿™ç§æ–¹å¼æ¯”è¾ƒçµæ´»ï¼Œå¯ä»¥è‡ªå·±æ§åˆ¶äº‹åŠ¡ï¼Œä½†æ˜¯ä¹Ÿå…¥ä¾µäº†ä¸šåŠ¡ï¼Œä¼šé€ æˆä¸€äº›åˆ«çš„é—®é¢˜ï¼Œä¾‹å¦‚å¹‚ç­‰æ€§é—®é¢˜ï¼Œç©ºå›æ»šå’Œèµ„æºå€’æŒ‚ã€‚\n\n**è§£é‡Šä¸€ä¸‹è¿™ä¸‰ä¸ªé—®é¢˜**\n\n- å¹‚ç­‰æ€§ï¼šç”±äºç½‘ç»œæŠ–åŠ¨ç­‰é—®é¢˜å¯¼è‡´åœ¨confirmé˜¶æ®µå¯èƒ½å‡ºç°è¶…æ—¶é‡è¯•ï¼Œä½†æ˜¯æœ€ç»ˆä¸¤ä¸ªè¯·æ±‚éƒ½æ”¶åˆ°äº†ã€‚åœ¨seataçš„è§£å†³æ–¹å¼æ˜¯ç”¨ä¸€ä¸ªäº‹åŠ¡çŠ¶æ€è¡¨ï¼Œåœ¨confirm/cancelçš„æ—¶å€™æäº¤ç»™äº‹åŠ¡çŠ¶æ€è¡¨ï¼Œåœ¨å¼€å§‹çš„æ—¶å€™åˆå»æ£€æŸ¥å­—æ®µçŠ¶æ€ï¼Œå¦‚æœæ˜¯å·²ç»confirmäº†çš„ï¼Œç¬¬äºŒä¸ªè¯·æ±‚å°±ä¼šè¢«å¿½ç•¥ï¼Œä»è€Œè¾¾åˆ°äº†å¹‚ç­‰æ€§\n- ç©ºå›æ»šï¼šåœ¨tryé˜¶æ®µæ²¡æœ‰æˆåŠŸçš„å¾®æœåŠ¡ä»ç„¶æ‰§è¡Œäº†å›æ»šï¼Œéœ€è¦å¯¹å¤±è´¥çš„å¾®æœåŠ¡è¿›è¡ŒåŒºåˆ«ã€‚åœ¨seataé‡Œä»ç„¶æ˜¯ç”¨äº‹åŠ¡çŠ¶æ€è¡¨ï¼Œåœ¨tryæˆåŠŸäº†æ‰ä¼šæœ‰statusï¼Œå›æ»šé˜¶æ®µæœ‰statusçš„æ‰èƒ½å›æ»š\n- èµ„æºå€’æŒ‚ï¼šç”±äºç½‘ç»œåŸå› tryé˜»å¡äº†ï¼Œç»“æœå›æ»šäº†ï¼Œä½†æ˜¯åç»­ç½‘ç»œæ¢å¤äº†ä»ç„¶ä¼šé¢„ç•™èµ„æºï¼Œä½¿å¾—èµ„æºè¢«å€’æŒ‚ã€‚è§£å†³æ–¹æ¡ˆä»ç„¶æ˜¯äº‹åŠ¡çŠ¶æ€è¡¨ï¼Œåœ¨å›æ»šçš„æ—¶å€™æ’å…¥ä¸€æ¡suspend=4ï¼Œåœ¨tryçš„æ—¶å€™å…ˆæ ¡éªŒæ˜¯ä¸æ˜¯å€’æŒ‚äº†ï¼Œå¦‚æœ=4å°±ä¸ç”¨é¢„ç•™èµ„æºã€‚\n\n**å…·ä½“åœ¨ä»£ç é‡Œæ˜¯æ€ä¹ˆåšçš„**\n\nä¾‹å¦‚æˆ‘ä»¬çš„æ”¯ä»˜æ¨¡å—ï¼Œéœ€è¦ä¿®æ”¹é‡‘é¢å’Œå•†å“æ•°é‡ï¼Œç„¶åä¸‹å•ã€‚è¿™ä¸ªæ—¶å€™å°±è¦ç”¨åˆ°åˆ†å¸ƒå¼äº‹åŠ¡äº†ã€‚æ¯ä¸€ä¸ªå¾®æœåŠ¡æ¨¡å—éƒ½è¦å®ç°tccä¸‰ä¸ªæ¥å£ï¼Œåœ¨tryçš„æ¥å£ä¸Šä½¿ç”¨@TwoPhaseBusinessActionï¼ŒæŒ‡å®šåœ¨seataæœåŠ¡ä¸­çš„idä»¥åŠå›æ»šå’Œæäº¤çš„æ–¹æ³•åï¼Œæ¥ç€åœ¨ä»£ç å®ç°å“åº”é€»è¾‘ã€‚å¯¹äºæ•°æ®åº“è€Œè¨€å¢åŠ ä¸€ä¸ªfrozenå­—æ®µï¼Œtryé˜¶æ®µé¦–å…ˆå‡å°‘æ•°é‡ï¼Œfrozenå¢åŠ ï¼Œcanceläº†å°±åšç›¸åæ“ä½œï¼Œå¦‚æœconfirmäº†å°±å‡å°‘frozenå®é™…æäº¤ã€‚\n\n## è§„åˆ™å¼•æ“\nç”¨è§„åˆ™å¼•æ“åšäº†ä¸€äº›è®¡ç®—\n- ä¾‹å¦‚æ ¹æ®è·ç¦»å’Œå®é™…é¢„ä¼°å‡ºä»·æ ¼ï¼Œä¾‹å¦‚åœ¨7ç‚¹ä¹‹å‰èµ·æ­¥ä»·æ˜¯å¤šå°‘å¤šå°‘é’±ï¼Œæ¯å…¬é‡Œçš„ä»·æ ¼è®¡ç®—ã€‚ä½¿ç”¨è§„åˆ™å¼•æ“é˜²æ­¢å°†è§„åˆ™å’Œä»·æ ¼ç¡¬ç¼–ç åœ¨ä»£ç é‡Œï¼Œæ–¹ä¾¿å®é™…éƒ¨ç½²åŠ¨æ€å˜æ›´ã€‚\n- è®¡ç®—è´¦å•ä¹Ÿä½¿ç”¨åˆ°äº†è§„åˆ™å¼•æ“ï¼Œä¾‹å¦‚æŒ‰ç…§ä»€ä¹ˆæ¯”ä¾‹åˆ†æˆï¼Œæ ¹æ®è®¢å•å¤šå°‘ç»™äºˆå¥–åŠ±\n\n**ä½†æ˜¯å®é™…å·¥ä½œé‡Œé¢éƒ½ä¸å¤ªä¼šç”¨åˆ°è¿™ä¸ªä½ çŸ¥é“æ˜¯ä¸ºä»€ä¹ˆå—**\n\næˆ‘è§‰å¾—é¦–å…ˆæ˜¯å­¦ä¹ æˆæœ¬çš„é—®é¢˜ï¼Œè¿™ä¸ªä¸œè¥¿è¯­æ³•ç¡®å®ä¹Ÿå¾ˆå†—æ‚ï¼Œè™½ç„¶åœ¨javaä»£ç é‡Œé¢ä¸ç”¨ç¡¬ç¼–ç äº†ï¼Œä½†æ˜¯å‡ ä¸ªifelseå´è¦ç”¨æ›´é•¿çš„ä»£ç è¡¨ç¤ºã€‚æŸäº›æ—¶å€™è¿™ä¸ªæœåŠ¡ä¹Ÿä¼šæˆä¸ºç“¶é¢ˆã€‚\n\n\n## å®ä¹ é¡¹ç›®\n### ä¸šåŠ¡æ˜¯ä»€ä¹ˆ\nå®ç°äººå·¥æ™ºèƒ½æ£€æµ‹å¹³å°å’Œä¸»å¹³å°çš„æ¥å£ï¼Œå…·ä½“æ˜¯å®šæ—¶å‘é€æŒ‡ä»¤åˆ°è§†é¢‘æµå¹³å°ï¼Œæˆªå›¾å…¥åº“åé€šè¿‡è¿™ä¸ªæ¥å£çš„ä¸€ç³»åˆ—å®šæ—¶ä»»åŠ¡æäº¤ç»™äººå·¥æ™ºèƒ½æ£€æµ‹å¹³å°è¿”å›ç»“æœè¿›è¡Œç»Ÿè®¡ã€‚ç»Ÿè®¡å®Œæˆåç”¨kafkaå¼‚æ­¥è½åº“å¹¶è¿”å›ç»™å‰ç«¯ã€‚é™¤æ­¤ä¹‹å¤–è¿˜æœ‰ä¸€äº›æ–‡æ¡£å’Œå¢åˆ æ”¹æŸ¥çš„å·¥ä½œã€‚\n\n\n### xxl-jobæ˜¯æ€ä¹ˆç”¨çš„ï¼Œä½ çš„é¡¹ç›®é‡Œé¢æœ‰å“ªäº›å®šæ—¶ä»»åŠ¡ä¼šéœ€è¦ç”¨åˆ°è¿™ä¸ª\nxxl-jobæ˜¯ä¸€ä¸ªå¼€ç®±å³ç”¨çš„åˆ†å¸ƒå¼è°ƒåº¦å¹³å°ï¼Œä¸ä¼ ç»Ÿçš„quatazç›¸æ¯”å¯ä»¥åŠ¨æ€æ”¹å˜cronè¡¨è¾¾å¼ï¼Œè¿˜å…·æœ‰å¯è§†åŒ–çš„ç•Œé¢ã€‚ç”±äºå®ä¹ å•ä½åç«¯æœ‰å¾ˆå¤šçš„å®šæ—¶ä»»åŠ¡ï¼Œå†™æ­»cronè¡¨è¾¾å¼ä¸åˆ©äºç®¡ç†\n\n1. é¦–å…ˆæ˜¯æˆªå›¾æŒ‡ä»¤ï¼Œä¼šä¼ é€’å‡ ä¸ªå‚æ•°é€šè¿‡httpæ§åˆ¶è§†é¢‘æµå¹³å°ï¼Œå…¶ä¸­å‚æ•°ä¼šåŒ…å«é—´éš”æ—¶é—´ï¼Œè§†é¢‘æµå¹³å°ä¹Ÿä¼šæ ¹æ®è¿™ä¸ªè¿›è¡Œå®šæ—¶è½åº“ã€‚\n2. æ¥ç€æ˜¯å®šæ—¶ç»™äººå·¥æ™ºèƒ½å¹³å°ä¼ è¾“ï¼Œå› ä¸ºå¹³å°æœ‰å¾ˆå¤šçš„æ£€æµ‹ç®—æ³•ï¼Œæ¥å£éƒ½ä¸æ˜¯å¾ˆç»Ÿä¸€ã€‚è¿™é‡Œæœ‰ä¸€äº›å¾ˆé•¿çš„ifåˆ¤å®šè¿‡ç¨‹ã€‚ä¾‹å¦‚æœªä½©æˆ´å®‰å…¨å¸½ æœªä½©æˆ´ç»ç¼˜æ‰‹å¥—  é è¿‘å˜å‹å™¨å‘Šè­¦ã€å·¥ä½œæœï¼Œæˆ–è€…æ˜¯ç”»é¢æ— äººã€‚è¿™é‡Œç”¨äº†ä¸€ä¸ªçº¿ç¨‹æ± æ¥å¹¶å‘å®Œæˆè¿™äº›å›¾ç‰‡çš„æ ¡éªŒå’Œä¼ è¾“ï¼Œè¿˜ç”¨äº†ç­–ç•¥æ¨¡å¼æŠŠè¿™äº›æ ¡éªŒçš„å¾ˆé•¿çš„ifelseç»™ç®€åŒ–äº†ã€‚å…·ä½“æ˜¯ç”¨ä¸€ä¸ªå…¬ç”¨çš„ç­–ç•¥æ¥å£ï¼Œç„¶åä¸Šä¸‹æ–‡ç±»ä¸­æ›¿æ¢è¿™ä¸ªæ¥å£çš„å®ç°ç±»æ¥å®Œæˆç­–ç•¥é€‰æ‹©ã€‚æœ€ååœ¨ç­–ç•¥å·¥å‚é‡Œé¢ç”¨å“ˆå¸Œè¡¨æ¥ä¿å­˜ç±»å‹å’Œå…·ä½“ç­–ç•¥çš„æ˜ å°„å…³ç³»ã€‚\n3. è¿˜æœ‰ä¸€ä¸ªå®šæ—¶ä»»åŠ¡æ˜¯æ¯å¤©æ—©ä¸Š1ç‚¹é’Ÿåˆ é™¤ä¿å­˜äº†3å¤©ä»¥ä¸Šçš„ç…§ç‰‡\n4. äººè„¸æ³¨å†Œæ¯åˆ†é’Ÿä»æ•°æ®åº“æŠ½200å¼ ç»™äººå·¥æ™ºèƒ½å¹³å°ï¼Œäººå·¥æ™ºèƒ½å¹³å°è‡ªå·±ä¹Ÿæœ‰æ•°æ®åº“ï¼Œåœ¨è¿™ä¸ªç³»ç»Ÿé‡Œé¢ä¹Ÿæœ‰ï¼Œè¿™ä¸ªæ—¶å€™è™½ç„¶æ˜¯é€šè¿‡httpä¼ è¾“çš„ï¼Œä½†æ˜¯ä¹Ÿå¯ä»¥çœ‹ä½œä¸€ä¸ªåˆ†å¸ƒå¼çš„äº‹åŠ¡ï¼Œç”±äºè¿™ä¸ªç³»ç»Ÿä¸šåŠ¡èŒƒå›´ä¸æ˜¯æˆ‘ä»¬çš„ï¼Œæ‰€ä»¥ç”¨åˆ†å¸ƒå¼äº‹åŠ¡ä¹Ÿä¸å¤ªåˆç†ã€‚æ‰€ä»¥å°±æƒ³åˆ°ç”¨kafkaä¿è¯æœ€ç»ˆä¸€è‡´æ€§ã€‚\n\n### kafkaæ€ä¹ˆä¿è¯æœ€ç»ˆä¸€è‡´æ€§çš„\nä¸»è¦ä¾èµ–kafkaçš„exactly onceè¯­ä¹‰ã€‚è¦å®ç°åªæäº¤ä¸€æ¬¡ä¸”åªèƒ½æ¶ˆè´¹ä¸€æ¬¡éœ€è¦ä¸‰æ–¹éƒ½åè°ƒã€‚å¯¹äºç”Ÿäº§è€…ä¹Ÿå°±æ˜¯æˆ‘ä»¬è¿™ä¸ªä»£ç é‡Œé¢ï¼Œè¦ä½¿ç”¨kafkaçš„å¹‚ç­‰å’Œäº‹åŠ¡ï¼Œé…ç½®kafkaçš„å¹‚ç­‰æ€§å¯ä»¥ä½¿ç”Ÿäº§è€…çš„æ¶ˆæ¯åªä¼šè¢«kafkaæ¥æ”¶ä¸€æ¬¡ï¼Œé…ç½®äº‹åŠ¡ä½¿å¾—æ¶ˆè´¹è€…åœ¨æ¶ˆè´¹æ¶ˆæ¯çš„æ—¶å€™åªèƒ½çœ‹åˆ°æäº¤äº‹åŠ¡çš„ï¼Œå¯¹äºkafkaè€Œè¨€ï¼Œç”±äºæˆ‘ä»¬å…¬å¸ä¹Ÿæ²¡é…ç½®kafkaé›†ç¾¤ï¼Œæ‰€ä»¥åªè®¾ç½®äº†acks=1ï¼Œä¹Ÿå°±æ˜¯å†™å…¥æˆåŠŸåè¿”å›å›è°ƒå‡½æ•°ï¼Œè¿™æ ·èƒ½ä¿è¯kafkaä¸ä¸¢æ¶ˆæ¯ã€‚æ¶ˆè´¹è€…ä¸ºäº†ä¸é‡å¤æ¶ˆè´¹æ¶ˆæ¯ä¹Ÿéœ€è¦åšåˆ°å¹‚ç­‰ï¼Œè¿™é‡Œçš„å¹‚ç­‰æ ¡éªŒæ˜¯redisè¿›è¡Œå»é‡çš„ï¼Œç„¶åå†æ‰‹åŠ¨æäº¤ackã€‚è¿™æ ·èƒ½ä¿è¯å¦‚æœå‰é¢çš„å¹³å°æ‰§è¡Œå¤±è´¥äº†ï¼Œè¿™é‡Œçš„æ¥å£ä¹Ÿä¸ä¼šè½åº“ï¼›å¦‚æœæ‰§è¡ŒæˆåŠŸï¼Œé€šè¿‡kafkaçš„è¿™ä¸ªexactly onceå°±å¯ä»¥åªè½åº“ä¸€æ¬¡ã€‚\n"},{"title":"ç½‘ç»œå’Œæ“ä½œç³»ç»Ÿé¢è¯•ç¯‡","url":"/2024/10/08/ç½‘ç»œå’Œæ“ä½œç³»ç»Ÿé¢è¯•ç¯‡/","content":"## httpå’Œhttps\nhttpsä¸»è¦æœ‰éå¯¹ç§°åŠ å¯†ï¼Œå¯¹ç§°åŠ å¯†å’Œæ•°å­—ç­¾åä¸‰éƒ¨åˆ†ã€‚å…·ä½“æµç¨‹æ˜¯æœåŠ¡å™¨å…ˆå‘è¯ä¹¦é¢å‘æœºæ„æ³¨å†Œå’ŒéªŒè¯ã€‚å®¢æˆ·ç«¯è¯·æ±‚æœåŠ¡å™¨çš„æ—¶å€™ï¼ŒæœåŠ¡å™¨ä¼šæŠŠè‡ªå·±éå¯¹ç§°åŠ å¯†çš„é’¥åŒ™å‘ç»™å®¢æˆ·ç«¯ï¼Œè¿™ä¸ªé’¥åŒ™æ˜¯éœ€è¦æ•°å­—ç­¾åè¿›è¡Œç›–ç« çš„ï¼Œè¿™æ ·å®¢æˆ·ç«¯å°±çŸ¥é“è¿™ä¸ªç½‘ç«™æ˜¯åˆæ³•çš„è€Œä¸æ˜¯é’“é±¼ç½‘ç«™ã€‚æ¥æ”¶åˆ°äº†æœåŠ¡å™¨éå¯¹ç§°åŠ å¯†çš„é’¥åŒ™ï¼Œå†æŠŠå¯¹ç§°åŠ å¯†çš„é’¥åŒ™é€šè¿‡è¿™ä¸ªå…¬é’¥å‘ç»™æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨ç”¨ç§é’¥è¿›è¡Œè§£å¯†ã€‚åç»­å°±æ ¹æ®å¯¹ç§°åŠ å¯†è¿›è¡Œä¼ è¾“ã€‚\n\n## httpçš„çŠ¶æ€ç \n- 1xxï¼šæ­£åœ¨å¤„ç†çš„çŠ¶æ€ï¼Œä¸€èˆ¬è§ä¸åˆ°\n- 2xxï¼šæˆåŠŸçŠ¶æ€ç \n- 3XXï¼š301æ°¸ä¹…é‡å®šå‘ï¼Œ302ä¸´æ—¶é‡å®šå‘\n- 4XXï¼š401èµ„æºæœªæˆæƒï¼Œ403è¢«å±è”½äº†ï¼Œ404æ‰¾ä¸åˆ°\n- 5XXï¼š500æœåŠ¡å™¨é—®é¢˜ã€‚502ç½‘å…³æ”¶åˆ°äº†ï¼Œä½†æ˜¯æœåŠ¡å™¨è½¬å‘æœ‰é—®é¢˜\n\n## httpç‰ˆæœ¬\n- http1.0ï¼šçŸ­é“¾æ¥ï¼Œä¸€ä¸ªèµ„æºä¸€æ¬¡tcpã€‚\n- http1.1ï¼šé•¿è¿æ¥ï¼Œä½†æ˜¯è¿˜æ˜¯æœ‰holé—®é¢˜ï¼Œå³å¤§æ–‡ä»¶ä¼ è¾“ä¼šæŒ¡ä½å°æ–‡ä»¶ä¼ è¾“ä»è€Œå½±å“ä½“éªŒ\n- http2.0ï¼šé•¿è¿æ¥ï¼Œé€šè¿‡äºŒè¿›åˆ¶å¸§è§£å†³äº†holçš„é—®é¢˜ï¼Œå°†å¤§æ–‡ä»¶åˆ†æˆå°ä»½ä¼ è¾“ã€‚åŒæ—¶é•¿è¿æ¥ä¹Ÿæ”¹è¿›æˆäº†å¤šè·¯å¤ç”¨\n- http3.0ï¼štcp+quicï¼ˆudpï¼‰ä¼˜åŒ–äº†æ¡æ‰‹ï¼Œå®‰å…¨æ€§ä¹Ÿè¿›è¡Œäº†æ›´æ–°\n\n## tcpä¸‰æ¬¡æ¡æ‰‹\n- å®¢æˆ·ç«¯å…ˆå‘é€åŒæ­¥ä¿¡å·SYNï¼Œå†å¸¦ä¸Šè‡ªå·±çš„seqï¼Œè¿›å…¥syn-sendçŠ¶æ€\n- æœåŠ¡å™¨æ¥æ”¶åˆ°äº†å‘é€ackå’Œsysï¼Œè¿›å…¥syn-recv\n- å®¢æˆ·ç«¯æ”¶åˆ°äº†ä¹‹ååœ¨å‘é€ä¸€ä¸ªackï¼Œå»ºç«‹è¿æ¥\n\n**ä¸ºä»€ä¹ˆæ˜¯ä¸‰æ¬¡æ¡æ‰‹**\n\nå› ä¸ºåªæœ‰ä¸‰æ¬¡æ¡æ‰‹æ‰èƒ½ä½¿åŒæ–¹éƒ½çŸ¥é“å„æ–¹é¢æ­£å¸¸ã€‚\n- ç¬¬ä¸€æ¬¡æ¡æ‰‹ï¼Œå®¢æˆ·ç«¯ä»€ä¹ˆéƒ½ä¸èƒ½ç¡®è®¤ï¼ŒæœåŠ¡å™¨å¯ä»¥ç¡®è®¤è‡ªå·±æ¥å—æ­£å¸¸ï¼Œå®¢æˆ·ç«¯å‘é€æ­£å¸¸ã€‚\n- ç¬¬äºŒæ¬¡æ¡æ‰‹ï¼Œå®¢æˆ·ç«¯å¯ä»¥ç¡®è®¤è‡ªå·±å‘é€å’Œæ¥æ”¶æ­£å¸¸ï¼ŒæœåŠ¡å™¨å‘é€å’Œæ¥æ”¶æ­£å¸¸ï¼›æœåŠ¡å™¨å¯ä»¥ç¡®è®¤è‡ªå·±æ¥æ”¶æ­£å¸¸ï¼Œå®¢æˆ·ç«¯å‘é€æ­£å¸¸\n- ç¬¬ä¸‰æ¬¡æ¡æ‰‹ï¼ŒæœåŠ¡å™¨å¯ä»¥ç¡®è®¤è‡ªå·±å‘é€å’Œæ¥æ”¶æ­£å¸¸ï¼Œå®¢æˆ·ç«¯å‘é€å’Œæ¥æ”¶æ­£å¸¸\n\n## tcpå››æ¬¡æ¡æ‰‹\n- å®¢æˆ·ç«¯å‘é€finå’Œseqï¼Œè¿›å…¥fin-wait-1\n- æœåŠ¡å™¨æ¥æ”¶åˆ°å‘é€ackå’Œseqï¼Œè¿›å…¥close-waitï¼Œå®¢æˆ·ç«¯æ¥æ”¶åˆ°äº†å˜ä¸ºfin-wait-2\n- å¯èƒ½æœåŠ¡å™¨è¿˜ä¼šæœ‰è¦å‘é€çš„ï¼Œå‘é€å®Œäº†å‘é€finï¼Œå˜ä¸ºlast-ack\n- å®¢æˆ·ç«¯æ¥æ”¶åˆ°äº†å˜ä¸ºtime-waitï¼Œç­‰åˆ°2ttlæ—¶é—´ï¼Œå¦‚æœæ²¡æœ‰ç­‰åˆ°æœåŠ¡å™¨çš„æ¶ˆæ¯å°±è‡ªå·±å…³é—­ã€‚","tags":["Java"]},{"title":"åˆ†å¸ƒå¼äº‹åŠ¡-seata","url":"/2024/10/05/åˆ†å¸ƒå¼äº‹åŠ¡-seata/","content":"## TCCæ¨¡å¼\nTCCæ¨¡å¼æ˜¯tryï¼Œconfirmï¼Œcancelã€‚ä¸ä¾èµ–æœ¬åœ°äº‹åŠ¡ï¼Œé€šè¿‡ä¸šåŠ¡ä»£ç è§£å†³ã€‚tryå…ˆé¢„ç•™äº‹åŠ¡æ‰€éœ€çš„èµ„æºï¼Œconfirmç¡®ä¿ä»»åŠ¡çš„æ‰§è¡Œå¹¶ä¸”æ¶ˆè€—ç¬¬ä¸€é˜¶æ®µé¢„ç•™çš„èµ„æºï¼Œå¦‚æœåœ¨è¿™ä¸ªé˜¶æ®µå‡ºç°å·®é”™å°±è¿›å…¥cancelã€‚\n\nä¼˜ç‚¹ï¼š\n- ä¸ä¾èµ–æ•°æ®åº“çš„äº‹åŠ¡ï¼Œå¯ä»¥ç”¨åœ¨éäº‹åŠ¡å‹æ•°æ®åº“\n- ä¸ç”¨å…¨å±€é”ï¼Œæ— éœ€ç”Ÿæˆå¿«ç…§ï¼Œæ•ˆç‡è¾ƒé«˜ã€‚\n\nç¼ºç‚¹ï¼š\n- ä»£ç ä¾µå…¥ï¼šéœ€è¦ç¨‹åºå‘˜æ‰‹åŠ¨è®¾è®¡äº‹åŠ¡é€»è¾‘ï¼Œå¢åŠ äº†å¼€å‘çš„å¤æ‚åº¦\n- ä¸­é—´æœ‰è½¯çŠ¶æ€ï¼Œæ˜¯æœ€ç»ˆä¸€è‡´æ€§ï¼Œconfirmå’Œcancelå‡ºç°é—®é¢˜ä¼šæœ‰ä¸€è‡´æ€§é—®é¢˜ã€‚\n- å¹‚ç­‰é—®é¢˜ï¼šå¦‚æœç”±äºåœ¨confirmå’Œcancelé˜¶æ®µå‡ºç°ç½‘ç»œæ³¢åŠ¨ï¼Œå¯èƒ½å¤šæ¬¡é‡Šæ”¾èµ„æºï¼Œå‡ºç°ä¸¥é‡åæœã€‚æ‰€ä»¥ä¸ºäº†ä¿è¯ä¿¡æ¯åªè¢«å›æ»šä¸€æ¬¡éœ€è¦ä¿è¯å¹‚ç­‰æ€§ã€‚å¯ä»¥ç”¨çŠ¶æ€è¡¨æ¥å®ç°ï¼ˆä½†æ˜¯æˆ‘è§‰å¾—è¿˜æ˜¯ä¼šæœ‰å¹¶å‘é—®é¢˜ï¼‰\n- ç©ºå›æ»šï¼štryçš„æœŸé—´é˜»å¡ä¸€æ¡ï¼Œå›æ»šçš„æ—¶å€™ä¹Ÿä¼šå›æ»šè¿™ä¸ªç©ºçš„ã€‚å¯èƒ½é€ æˆèµ„æºæ— æ•…é‡Šæ”¾ã€‚è§£å†³æ–¹æ³•ä¹Ÿæ˜¯çŠ¶æ€è¡¨ï¼Œå¦‚æœç¬¬ä¸€é˜¶æ®µæœ‰è®°å½•æˆåŠŸè¿‡äº†å°±æ‰§è¡Œå›æ»šã€‚å¦‚æœæ²¡æœ‰å°±ä¸ç”¨\n- èµ„æºå€’æŒ‚ï¼šä¹Ÿæ˜¯ç½‘ç»œç¯å¢ƒå˜åŒ–ï¼Œtryé˜¶æ®µæŸä¸ªåˆ†æ”¯äº‹åŠ¡é˜»å¡äº†ç›´åˆ°æœ€åå›æ»šäº†æ‰æ‰§è¡Œï¼Œæ˜¯ç©ºå›æ»šçš„å¦ä¸€ä¸ªç»“æœã€‚è§£å†³æ–¹æ¡ˆæ˜¯ç©ºå›æ»šçš„æ—¶å€™åŠ ä¸€æ¡çŠ¶æ€è®°å½•ã€‚åœ¨tryé˜¶æ®µå¦‚æœæ²¡æœ‰è¿™ä¸ªå°±æ‰§è¡Œï¼Œå¦‚æœæœ‰åˆ†æ”¯äº‹åŠ¡çš„idã€‚è¯´æ˜å·²ç»è¢«ç©ºå›æ»šå‘ç°ï¼Œä¸å†æ‰§è¡Œã€‚\n\n## sagaæ¨¡å¼\n\nSagaæ¨¡å¼æ˜¯ä¸€ç§ç”¨äºå¤„ç†åˆ†å¸ƒå¼äº‹åŠ¡çš„æ¨¡å¼ï¼Œå®ƒé€šè¿‡å°†é•¿æ—¶é—´çš„ã€å¤æ‚çš„äº‹åŠ¡åˆ†è§£ä¸ºå¤šä¸ªå°çš„ã€å¯é€†çš„äº‹åŠ¡ç‰‡æ®µï¼Œä»¥å®ç°äº‹åŠ¡çš„ä¸€è‡´æ€§å’Œå¯é æ€§ã€‚\n\nåœ¨Sagaæ¨¡å¼ä¸­ï¼Œæ¯ä¸ªäº‹åŠ¡ç‰‡æ®µç§°ä¸ºä¸€ä¸ªè¡¥å¿æ“ä½œã€‚æ¯ä¸ªè¡¥å¿æ“ä½œéƒ½ä¸ä¸€ä¸ªæ­£å‘æ“ä½œç›¸å¯¹åº”ï¼Œæ­£å‘æ“ä½œæ˜¯äº‹åŠ¡çš„ä¸€éƒ¨åˆ†ï¼Œè€Œè¡¥å¿æ“ä½œæ˜¯ç”¨äºæ’¤é”€æˆ–ä¿®å¤æ­£å‘æ“ä½œçš„ã€‚Sagaæ¨¡å¼é€šè¿‡æŒ‰ç…§äº‹åŠ¡æ‰§è¡Œçš„é¡ºåºï¼Œä¾æ¬¡æ‰§è¡Œæ­£å‘æ“ä½œå’Œè¡¥å¿æ“ä½œï¼Œæ¥ç¡®ä¿äº‹åŠ¡åœ¨å‘ç”Ÿå¤±è´¥æˆ–å¼‚å¸¸æ—¶èƒ½å¤Ÿè¿›è¡Œå›æ»šæˆ–æ¢å¤ã€‚\n\nSagaæ¨¡å¼çš„æ‰§è¡Œè¿‡ç¨‹å¦‚ä¸‹ï¼š\n\næ‰§è¡Œæ­£å‘æ“ä½œï¼šæŒ‰ç…§äº‹åŠ¡çš„é€»è¾‘é¡ºåºï¼Œä¾æ¬¡æ‰§è¡Œæ­£å‘æ“ä½œã€‚æ¯ä¸ªæ­£å‘æ“ä½œéƒ½ä¼šè®°å½•äº‹åŠ¡çš„æ‰§è¡ŒçŠ¶æ€ã€‚\nå¦‚æœæ‰€æœ‰çš„æ­£å‘æ“ä½œéƒ½æˆåŠŸæ‰§è¡Œï¼Œåˆ™äº‹åŠ¡æäº¤å®Œæˆã€‚\nå¦‚æœæŸä¸ªæ­£å‘æ“ä½œå¤±è´¥ï¼Œå°†ä¼šè§¦å‘ç›¸åº”çš„è¡¥å¿æ“ä½œã€‚è¡¥å¿æ“ä½œä¼šæ’¤é”€æˆ–ä¿®å¤æ­£å‘æ“ä½œçš„å½±å“ã€‚\næ‰§è¡Œè¡¥å¿æ“ä½œï¼šæŒ‰ç…§é€†åºä¾æ¬¡æ‰§è¡Œå·²ç»è§¦å‘çš„è¡¥å¿æ“ä½œã€‚è¡¥å¿æ“ä½œåº”è¯¥å…·å¤‡å¹‚ç­‰æ€§ï¼Œä»¥ä¾¿å¯ä»¥å¤šæ¬¡æ‰§è¡Œè€Œä¸ä¼šé€ æˆå‰¯ä½œç”¨ã€‚\nå¦‚æœæ‰€æœ‰çš„è¡¥å¿æ“ä½œéƒ½æˆåŠŸæ‰§è¡Œï¼Œåˆ™äº‹åŠ¡å›æ»šå®Œæˆã€‚\nå¦‚æœè¡¥å¿æ“ä½œä¹Ÿå¤±è´¥ï¼Œéœ€è¦äººå·¥ä»‹å…¥æˆ–å…¶ä»–æ‰‹æ®µæ¥è§£å†³äº‹åŠ¡çš„ä¸€è‡´æ€§é—®é¢˜ã€‚\n\nSeataçš„Sagaæ¨¡å¼ï¼š\n\nSeataçš„Sagaæ¨¡å¼é€šè¿‡Seataæ¡†æ¶æ¥ç®¡ç†å’Œåè°ƒåˆ†å¸ƒå¼äº‹åŠ¡ï¼Œæä¾›äº†å¯¹äº‹åŠ¡çš„ç¼–æ’å’ŒçŠ¶æ€ç®¡ç†çš„æ”¯æŒã€‚å®ƒä¸Seataçš„å…¶ä»–ç‰¹æ€§ï¼ˆå¦‚ATæ¨¡å¼ã€TCCæ¨¡å¼ï¼‰ç»“åˆåœ¨ä¸€èµ·ï¼Œæ„æˆäº†Seataå…¨é¢çš„åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆã€‚\n\nSeataçš„Sagaæ¨¡å¼ç›¸å¯¹äºä¼ ç»Ÿçš„Sagaæ¨¡å¼ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š\n\n- é›†æˆæ€§ï¼šSeataçš„Sagaæ¨¡å¼ä¸Seataæ¡†æ¶ç´§å¯†é›†æˆï¼Œå¯ä»¥ä¸Seataçš„å…¶ä»–ç‰¹æ€§ä¸€èµ·ä½¿ç”¨ï¼Œå¦‚åˆ†å¸ƒå¼äº‹åŠ¡æ—¥å¿—å’Œåˆ†å¸ƒå¼é”ç­‰ã€‚\n- å¼ºä¸€è‡´æ€§ï¼šSeataçš„Sagaæ¨¡å¼æä¾›äº†å¼ºä¸€è‡´æ€§çš„äº‹åŠ¡æ”¯æŒï¼Œç¡®ä¿äº‹åŠ¡çš„æ‰§è¡Œé¡ºåºå’Œä¸€è‡´æ€§ã€‚\n- å¯é æ€§ï¼šSeataçš„Sagaæ¨¡å¼åœ¨è¡¥å¿æ“ä½œçš„æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œæ”¯æŒé‡è¯•å’Œæ¢å¤æœºåˆ¶ï¼Œæé«˜äº†äº‹åŠ¡çš„å¯é æ€§å’Œæ¢å¤èƒ½åŠ›ã€‚\n\n**é€‚ç”¨åœºæ™¯ï¼š**\n\n- ä¸šåŠ¡æµç¨‹é•¿ã€ä¸šåŠ¡æµç¨‹å¤š\n- å‚ä¸è€…åŒ…å«å…¶å®ƒå…¬å¸æˆ–é—ç•™ç³»ç»ŸæœåŠ¡ï¼Œæ— æ³•æä¾› TCC æ¨¡å¼è¦æ±‚çš„ä¸‰ä¸ªæ¥å£\n\n**ä¼˜ç‚¹ï¼š**\n\n- ä¸€é˜¶æ®µæäº¤æœ¬åœ°äº‹åŠ¡ï¼Œæ— é”ï¼Œé«˜æ€§èƒ½\n- äº‹ä»¶é©±åŠ¨æ¶æ„ï¼Œå‚ä¸è€…å¯å¼‚æ­¥æ‰§è¡Œï¼Œé«˜åå\n- è¡¥å¿æœåŠ¡æ˜“äºå®ç°ï¼Œä¸ç”¨ç¼–å†™TCCä¸­çš„ä¸‰ä¸ªé˜¶æ®µï¼Œå®ç°ç®€å•\n\n**ç¼ºç‚¹ï¼š**\n\n- æ²¡æœ‰é”ï¼Œä¸ä¿è¯éš”ç¦»æ€§ï¼Œä¼šæœ‰è„å†™ï¼›\n- è½¯çŠ¶æ€æŒç»­æ—¶é—´ä¸ç¡®å®šï¼Œæ—¶æ•ˆæ€§å·®ï¼›\n\n## XAæ¨¡å¼\nå°±æ˜¯äºŒé˜¶æ®µæäº¤2pcæ¨¡å¼ã€‚ä¿è¯å¼ºä¸€è‡´æ€§ï¼Œåªèƒ½ä¸€èµ·æäº¤æˆ–è€…å¤±æ•ˆã€‚æ•ˆç‡æœ€ä½ã€‚","tags":["seata"]},{"title":"åœºæ™¯é¢˜","url":"/2024/10/04/åœºæ™¯é¢˜/","content":"## å¦‚ä½•è®¾è®¡ä¸€ä¸ªç§’æ€ç³»ç»Ÿ\n- é«˜æ€§èƒ½ï¼šé«˜æ€§èƒ½æ ¸å¿ƒå°±æ˜¯å“åº”æ—¶é—´å¿«ï¼Œä¸€èˆ¬æ¥è¯´éƒ½ä¼šæŠŠçƒ­ç‚¹æ•°æ®æ”¾åœ¨redisä¸­ï¼Œä½†æ˜¯ç§’æ€é«˜å³°çš„æ—¶å€™æœ‰å¯èƒ½è¿rediséƒ½åº”ä»˜ä¸äº†ã€‚æœ‰å‡ ç§è§£å†³æ–¹æ¡ˆï¼šé¦–å…ˆæ˜¯äºŒçº§ç¼“å­˜ï¼Œredisä¹‹å¤–ç”¨jvmçš„ç¼“å­˜ä¾‹å¦‚caffeineï¼Œä¸€å®šè¦æ§åˆ¶ç©ºé—´å¤§å°ï¼Œæ‰€ä»¥å¿…é¡»ä¸Šæ·˜æ±°ç­–ç•¥ä¾‹å¦‚lruï¼›æˆ–è€…åœ¨ä¸šåŠ¡å±‚é¢è¿›è¡ŒUVç»Ÿè®¡ï¼Œä½†æ˜¯éœ€è¦æ”¹å†™redisçš„jarï¼›æˆ–è€…ç›´æ¥ä½¿ç”¨å¼€æºè§£å†³æ–¹æ¡ˆæ¯”å¦‚äº¬ä¸œçš„hotkeyã€‚æ­¤å¤–ä¸ºäº†æé«˜å“åº”é€Ÿåº¦è¿˜å¯ä»¥å°†é™æ€èµ„æºæ”¾åˆ°cdnä¸Šï¼Œä¾‹å¦‚ä¸ƒç‰›äº‘é˜¿é‡Œäº‘ï¼Œå›¾ç‰‡ä¸ä¼šå†å ç”¨æœåŠ¡å™¨çš„å¸¦å®½ï¼Œä½†æ˜¯è¿™ç§å±äºé’èƒ½åŠ›çš„è§£å†³æ–¹æ¡ˆã€‚\n- é«˜å¯ç”¨ï¼šä¿è¯èŠ‚ç‚¹çš„æ•…éšœæ¢å¤ã€‚éœ€è¦ç”¨é›†ç¾¤ã€‚åŒ…æ‹¬ä½†ä¸é™redis-sentinelï¼Œredis-clusterï¼›æ­¤å¤–è¿˜å¯ä»¥ç”¨åˆ†å¸ƒå¼é™æµæ¡†æ¶sentinelï¼Œå®ç°æœåŠ¡é™æµå’Œé™çº§ï¼›ä¼˜åŒ–å¼‚æ­¥è¯·æ±‚å¯ä»¥ç”¨mqï¼Œmqå¯¹äºé«˜å¯ç”¨çš„è´¡çŒ®æ˜¯æµé‡å‰Šå³°ï¼Œå°†è¯·æ±‚æ‰“å…¥æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¯¹äºé«˜æ€§èƒ½çš„è´¡çŒ®æ˜¯å°†å‡åº“å­˜ç¼“å­˜å’Œå‡æ•°æ®å¼‚æ­¥åŒ–ï¼Œæ›´å¿«è¿”å›è¯·æ±‚ã€‚\n- ä¸€è‡´æ€§ï¼šå¦‚ä½•é˜²æ­¢è¶…å–ï¼Œå¯ä»¥ç”¨luaè„šæœ¬æŸ¥è¯¢redisä¸­çš„ä½™é‡ï¼Œä½†æ˜¯luaçš„åŸå­æ€§ä¿è¯çš„æ˜¯è„šæœ¬å†…éƒ½æ˜¯ä¸€æ¡è¯­å¥ï¼Œè€Œä¸æ˜¯äº‹åŠ¡ä¸Šçš„åŸå­æ€§ï¼Œå‡ºé”™äº†æ˜¯ä¸ä¼šå›æ»šçš„ï¼›rediså‡åº“å­˜åéœ€è¦åŒæ­¥åˆ°mysqlä¸­ï¼Œå¯ä»¥ç”¨mqå®Œæˆã€‚æ‰£å‡ä½™é¢ä¹Ÿè¦è€ƒè™‘å¹¶å‘é—®é¢˜ï¼Œå¯ä»¥ç”¨mysqlçš„æ’ä»–é”ã€‚\n- å¹‚ç­‰æ€§ï¼šä¹Ÿå°±æ˜¯å¸¸è¯´çš„ä¸€äººä¸€å•ï¼Œå¯ä»¥è€ƒè™‘ç”¨åˆ†å¸ƒå¼é”æ¥é”ä½å½“å‰ç”¨æˆ·ã€‚\n\n## å¤§æ–‡ä»¶æ–­ç‚¹ç»­ä¼ é—®é¢˜\n- å‰ç«¯æ–‡ä»¶åˆ†ç‰‡ï¼Œå¹¶ä¸”é€šè¿‡shaç®—æ³•ç”Ÿæˆä¸€ä¸ªæ ¡éªŒå’Œã€‚\n- åç«¯æ ¹æ®è¿™ä¸ªæ ¡éªŒå’Œå…ˆå»æŸ¥minioæ˜¯å¦æœ‰å½“å‰åˆ†ç‰‡ï¼Œå¦‚æœæœ‰å°±ç›´æ¥è·³è¿‡\n- å¦‚æœæ²¡æœ‰å…ˆæ£€éªŒshaæ ¡éªŒå’Œï¼Œå¦‚æœåŒ¹é…è¯´æ˜æœ‰æ•ˆã€‚å¯ä»¥é‡‡ç”¨å¹¶è¡Œçš„æ–¹å¼åŠ å¿«ä¼ è¾“\n- æ‰€æœ‰åˆ†ç‰‡å‘é€å®Œæ¯•åï¼Œå‰ç«¯ä¼šè¿›è¡Œæ ¡éªŒï¼Œå‘é€æ•´ä¸ªçš„shaï¼Œä¸åç«¯åˆå¹¶åçš„æ–‡ä»¶è¿›è¡Œæ ¡éªŒ\n\n## 40äº¿qqå·ï¼Œå¦‚ä½•å»é‡\nå“ˆå¸Œè¡¨å’Œå“ˆå¸Œé›†è‚¯å®šæ˜¯ä¸è¡Œçš„ï¼Œå¯ä»¥è€ƒè™‘ç”¨ä½å›¾ã€‚æˆ–è€…æ•°æ®ç»“æ„é‚£ç§å¤–éƒ¨å½’å¹¶æ’åº\n\n## åŠ¨æ€çº¿ç¨‹æ± \nè¦ç”¨åˆ°nacosåŠ¨æ€é…ç½®æ ¸å¿ƒå‚æ•°","tags":["Java"]},{"title":"JVMé¢è¯•ç¯‡","url":"/2024/09/30/JVMé¢è¯•ç¯‡/","content":"## JVMå¦‚ä½•è§£å†³è·¨ä»£é—®é¢˜\nå¦‚æœåœ¨å¹´è½»ä»£çš„æŸä¸ªå¯¹è±¡å¼•ç”¨äº†è€å¹´ä»£çš„å¯¹è±¡ï¼Œåœ¨è§¦å‘Young GCçš„æ—¶å€™åªä¼šæ£€æŸ¥å¹´è½»ä»£è€Œä¸ä¼šæ£€æŸ¥è€å¹´ä»£ï¼Œæ­¤æ—¶å¦‚æœè€å¹´ä»£å¼•ç”¨äº†ä¸€ä¸ªå¹´è½»ä»£çš„å¯¹è±¡å°±ä¸ä¼šè¢«YGCå‘ç°è€Œå›æ”¶äº†æ­¤å¯¹è±¡ã€‚ä½†æ˜¯è¿™ç§æƒ…å†µå‡ºç°çš„æ¯”è¾ƒå°‘ï¼Œé™¤éæ˜¯è€å¹´ä»£åŠ¨æ€çš„å¼•ç”¨äº†ä¸€ä¸ªåˆšäº§ç”Ÿçš„å¯¹è±¡ã€‚\n\n**è®°å¿†é›†å’Œå¡è¡¨**\nå¦‚æœä¸ºäº†å°æ¦‚ç‡äº‹ä»¶æ¯æ¬¡YGCéƒ½å»æ‰«æä¸€éæ°¸ä¹…ä»£ï¼Œå¼€é”€ä¼šå¾ˆå¤§ã€‚æ­¤æ—¶æˆ‘ä»¬åªéœ€è¦ä¿å­˜ä»éæ‰«æåŒºåŸŸåˆ°æ‰«æåŒºåŸŸçš„æŒ‡é’ˆå°±å¯ä»¥äº†ã€‚è¿™ä¸ªä¿å­˜çš„æ‰«ææŒ‡é’ˆé€»è¾‘ä¸Šå«åšè®°å¿†é›†ï¼Œæ”¾åœ¨æ–°ç”Ÿä»£ä¸­ã€‚\n\nå¡è¡¨æ˜¯hotspotè™šæ‹Ÿæœºå¯¹äºè®°å¿†é›†çš„å…·ä½“å®ç°ï¼Œç±»ä¼¼ä½å›¾ï¼ŒæŠŠéæ‰«æåŒºåŸŸåˆ†å—ï¼Œç„¶åç”¨ä¸€ä¸ªå¡è¡¨æ•°ç»„æ¥è®°å½•å¯¹åº”å—æ˜¯å¦å˜è„ï¼Œå¦‚æœè®°å½•çš„ä¸º1è¯´æ˜å˜è„ï¼Œåœ¨YGCçš„æ—¶å€™æŠŠå¯¹åº”å—åŠ å…¥æ‰«æã€‚æœ¬è´¨ä¸Šæ˜¯ç”¨ç©ºé—´æ¢æ—¶é—´ã€‚\n\n**å†™å±éšœ**\nè¿™é‡Œçš„å†™å±éšœè·Ÿvolatileçš„ä¸ä¸€æ ·ï¼Œè¿™é‡Œä»…ä»…æ˜¯å¯¹å¼•ç”¨æ“ä½œåšäº†ä¸€å±‚aopï¼Œåœ¨å†™åå±éšœåŠ å…¥æ·»åŠ å¡è¡¨çš„æ“ä½œï¼Œåœ¨å†™å‰å±éšœæ·»åŠ è¯¥é¡µæ˜¯å¦è„çš„åˆ¤æ–­ï¼Œå¯ä»¥è§£å†³ä¼ªå…±äº«é—®é¢˜ã€‚\n\n## ä¸‰è‰²æ ‡è®°ç®—æ³•\nä¸‰è‰²æ ‡è®°ç®—æ³•æ˜¯å¯è¾¾æ€§åˆ†æçš„ä¸€ä¸ªæ‰«æè¿‡ç¨‹ï¼Œä¾‹å¦‚CMSï¼Œå…ˆåšåˆå§‹æ ‡è®°æ ‡è®°å‡ºGCrootï¼Œç„¶åå†å¹¶å‘æ ‡è®°ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯é€šè¿‡ä¸‰è‰²æ ‡è®°ç®—æ³•å®ç°çš„ã€‚æœ€åæ‰«æåˆ°çš„ç™½è‰²èŠ‚ç‚¹å°±è¢«è§†ä¸ºæ²¡æœ‰å¼•ç”¨ï¼Œåœ¨ä¸‹ä¸€è½®GCä¼šè¢«å›æ”¶ã€‚\n\n- é»‘è‰²ï¼Œç›´æ¥æˆ–è€…é—´æ¥è¿æ¥åˆ°GCrootå¹¶ä¸”è‡ªèº«æ‰€æœ‰å¼•ç”¨éƒ½è¢«æ‰«æè¿‡äº†\n- ç°è‰²ï¼šä»é»‘è‰²èŠ‚ç‚¹æ‰©æ•£ï¼Œä½†æ˜¯è‡ªå·±çš„å­èŠ‚ç‚¹è¿˜æ²¡æœ‰è¢«å®Œå…¨æ‰«æ\n- ç™½è‰²ï¼šæ²¡æœ‰è¢«æŸ“æŒ‡çš„èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯ä¸å¯è¾¾åŒºåŸŸ\n\n**ä¸‰è‰²æ ‡è®°çš„ç¼ºç‚¹**\n\n1. å¤šæ ‡é—®é¢˜ï¼šåœ¨ä¸€ä¸ªèŠ‚ç‚¹è¢«æ ‡è®°æˆç°è‰²ä¹‹åï¼Œä¸Šä¸€ä¸ªèŠ‚ç‚¹æ–­å¼€è”ç³»ï¼Œæœ€ç»ˆè¿™ä¸ªèŠ‚ç‚¹è¿˜æ˜¯ä¼šè¢«æŸ“é»‘ï¼Œä½†å®é™…ä¸Šæ˜¯åƒåœ¾ã€‚è¿™ä¸ªç°è±¡ç§°ä¸ºæµ®åŠ¨åƒåœ¾ï¼Œåœ¨ä¸‹ä¸€è½®ä¼šè¢«å›æ”¶ã€‚\n2. æ¼æ ‡é—®é¢˜ï¼šå¤šæ ‡è‡³å°‘å¯ä»¥é€šè¿‡ä¸‹ä¸€è½®åƒåœ¾å›æ”¶æ¸…é™¤ï¼Œæ¼æ ‡å°±ä¸¥é‡å¤šäº†ã€‚å½“ä¸€ä¸ªç°è‰²èŠ‚ç‚¹ä¸ä¸€ä¸ªç™½è‰²èŠ‚ç‚¹æ–­æ‰ä¹‹åç«‹åˆ»æœ‰é»‘è‰²èŠ‚ç‚¹ç›¸è¿ã€‚è¿™ä¸ªæ—¶å€™ä¸‰è‰²æ ‡è®°ç®—æ³•è¿˜æ˜¯ä¼šè®¤ä¸ºè¿™ä¸ªèŠ‚ç‚¹æ˜¯ç™½è‰²çš„ï¼Œå°±ä¼šè¢«åƒåœ¾å›æ”¶ï¼Œè€Œæ­¤æ—¶ç¡®å®æœ‰é»‘è‰²èŠ‚ç‚¹çš„å¼•ç”¨ï¼Œä¼šæŠ¥ç©ºæŒ‡é’ˆå¼‚å¸¸ã€‚\n\n\n<div style=\"text-align: center;\">\n  <img src=\"../img/jvm/img_5.png\" alt=\"\" />\n</div>\n\n**å¦‚ä½•è§£å†³**\nä¸¤ä¸ªæ¡ä»¶åŒæ—¶å‘ç”Ÿæ‰ä¼šæœ‰æ¼æ ‡ç°è±¡ï¼šé¦–å…ˆæ˜¯æœ‰ç°è‰²èŠ‚ç‚¹ä¸ç™½è‰²èŠ‚ç‚¹æ–­å¼€è”ç³»ï¼Œåˆæœ‰é»‘è‰²èŠ‚ç‚¹ä¸ç™½è‰²èŠ‚ç‚¹äº§ç”Ÿè”ç³»ã€‚\n\nç ´åä¸€ä¸ªå°±ä¸ä¼šäº§ç”Ÿæ¼æ ‡ï¼š\n\n- å¢é‡æ›´æ–°ï¼šå¢é‡æ›´æ–°ç ´åäº†ç¬¬ä¸€ä¸ªæ¡ä»¶ï¼šã€Œè‡³å°‘æœ‰ä¸€ä¸ªé»‘è‰²å¯¹è±¡æ–°å¢äº†å¯¹ç™½è‰²å¯¹è±¡çš„å¼•ç”¨ã€ï¼Œåœ¨å¹¶å‘æ ‡è®°é˜¶æ®µï¼Œé»‘è‰²å¯¹è±¡DæŒ‡å‘äº†ç™½è‰²å¯¹è±¡Gï¼Œè¿™æ—¶ä¼šæŠŠé»‘è‰²å¯¹è±¡Dè®°å½•ä¸‹æ¥ï¼Œåœ¨é‡æ–°æ ‡è®°é˜¶æ®µï¼Œä¼šæŠŠé»‘è‰²å¯¹è±¡Dæ ‡è®°ä¸ºç°è‰²å¯¹è±¡Dï¼Œç„¶åä»¥ç°è‰²å¯¹è±¡Dä¸ºæ ¹èŠ‚ç‚¹ï¼Œæ‰«ææ•´ä¸ªå¼•ç”¨é“¾ï¼Œç™½è‰²å¯¹è±¡Gå°±ä¼šè¢«ä¾æ¬¡æ ‡è®°ä¸ºç°è‰²ã€é»‘è‰²ï¼Œç™½è‰²å¯¹è±¡Gæ¼æ ‡çš„é—®é¢˜å°±è§£å†³äº†ã€‚ ç¼ºç‚¹æ˜¯ä¼šé‡æ–°æ‰«æä»¥é»‘è‰²å¯¹è±¡ä¸ºæ ¹èŠ‚ç‚¹çš„å­æ ‘ï¼Œæ—¶é—´é•¿ï¼ˆCMSè§£å†³æ–¹æ¡ˆï¼‰\n- åŸå§‹å¿«ç…§ï¼šåŸå§‹å¿«ç…§ç ´åäº†ç¬¬äºŒä¸ªæ¡ä»¶ï¼šã€Œæ‰€æœ‰ç°è‰²å¯¹è±¡æŒ‡å‘è¯¥ç™½è‰²å¯¹è±¡çš„å¼•ç”¨éƒ½æ–­å¼€äº†ã€ï¼Œåœ¨å¹¶å‘æ ‡è®°é˜¶æ®µï¼Œç°è‰²å¯¹è±¡Eæ–­å¼€äº†å¯¹ç™½è‰²å¯¹è±¡Gçš„å¼•ç”¨ï¼Œè¿™æ˜¯ä¼šæŠŠç™½è‰²å¯¹è±¡Gè®°å½•ä¸‹æ¥ï¼Œåœ¨æœ€ç»ˆæ ‡è®°é˜¶æ®µï¼Œä¼šæŠŠç™½è‰²å¯¹è±¡Gæ ‡è®°ä¸ºç°è‰²ï¼Œç„¶åä»¥ç°è‰²å¯¹è±¡Gä¸ºæ ¹èŠ‚ç‚¹ï¼Œæ‰«ææ•´ä¸ªå¼•ç”¨é“¾ï¼Œå¦‚æ­¤ä»¥æ¥åŸæ¥çš„ç™½è‰²å¯¹è±¡Gå°±ä¼šè¢«ä¾æ¬¡æ ‡è®°ä¸ºç°è‰²ã€é»‘è‰²ï¼Œç™½è‰²å¯¹è±¡Gæ¼æ ‡çš„é—®é¢˜å°±è§£å†³äº†ã€‚ç¼ºç‚¹æ˜¯å¦‚æœæ²¡æœ‰é»‘è‰²å¯¹è±¡æ¥å¼•ç”¨å°±ä¼šå˜æˆæµ®åŠ¨åƒåœ¾ï¼ˆG1è§£å†³æ–¹æ¡ˆï¼‰\n\n\n## ç±»çš„å›æ”¶\nç±»çš„å…ƒæ•°æ®åœ¨æ–¹æ³•åŒºä¹Ÿå°±æ˜¯å…ƒç©ºé—´ä¸­ï¼Œåœ¨fullGCæ˜¯æœ‰å¯èƒ½ä¼šè¢«åƒåœ¾å›æ”¶çš„ã€‚ä¸€ä¸ªç±»èƒ½è¢«åƒåœ¾å›æ”¶éœ€è¦æ»¡è¶³ä¸‰ä¸ªè¦æ±‚ï¼š\n1. æ²¡æœ‰å®ä¾‹å¯¹è±¡\n2. æ²¡æœ‰é™æ€æ–¹æ³•çš„å¼•ç”¨\n3. ç±»åŠ è½½å™¨å·²ç»è¢«GC\n\n**private static final int I = 0ï¼Œè¿™ä¸ªiä¼šå›æ”¶å—**\n\nçœ‹æƒ…å†µï¼Œè·Ÿç€ç±»èµ°ï¼Œæœ¬èº«è¿™å°±æ˜¯ä¸€ä¸ªGCrootï¼Œä¸€å…±æœ‰å››ç§GCrootï¼ˆç±»çš„å¸¸é‡å¼•ç”¨ç±»ä¼¼è¿™ç§ï¼Œé™æ€å¼•ç”¨ï¼Œè™šæ‹Ÿæœºæ ˆçš„å¼•ç”¨ï¼Œæœ¬åœ°æ–¹æ³•æ ˆçš„å¼•ç”¨ï¼‰ã€‚å¦‚æœä¸æ˜¯ç±»è¢«å¸è½½çš„è¯æ˜¯ä¸èƒ½è¢«GCçš„ã€‚\n","tags":["Java"]},{"title":"è®¾è®¡æ¨¡å¼é¢è¯•ç¯‡","url":"/2024/09/28/è®¾è®¡æ¨¡å¼é¢è¯•ç¯‡/","content":"\n> è®¾è®¡æ¨¡å¼ä¸€èˆ¬å¯ä»¥åˆ†ä¸ºä¸‰å¤§ç±»\n> - åˆ›å»ºå‹ï¼šå·¥å‚æ¨¡å¼ï¼Œå•ä¾‹æ¨¡å¼\n> - ç»“æ„å‹ï¼šè£…é¥°å™¨æ¨¡å¼ï¼Œé€‚é…å™¨æ¨¡å¼\n> - è¡Œä¸ºå‹ï¼šç­–ç•¥æ¨¡å¼ï¼Œè§‚å¯Ÿè€…æ¨¡å¼\n> è®¾è®¡åŸåˆ™ï¼š\n> - å•ä¸€èŒè´£åŸåˆ™\n> - å¼€æ”¾å°é—­åŸåˆ™\n> - é‡Œå¼æ›¿æ¢åŸåˆ™\n> - æ¥å£éš”ç¦»åŸåˆ™\n> - ä¾èµ–å€’ç½®åŸåˆ™\n> - è¿ªç±³ç‰¹åŸåˆ™\n> - åˆæˆå¤ç”¨åŸåˆ™\n\n\n## ä»£ç†æ¨¡å¼\n\nä»£ç†æ¨¡å¼æ˜¯åœ¨ä¸æ”¹å˜åŸå…ˆå¯¹è±¡çš„å‰æä¸‹ï¼Œé€šè¿‡ç”Ÿæˆä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œæ‰©å±•åŸå…ˆå¯¹è±¡çš„ä¸€äº›åŠŸèƒ½ã€‚æ¯”å¦‚aopï¼Œä¸å…¥ä¾µä¸šåŠ¡ä»£ç å®ç°æ–¹æ³•å‰åé€»è¾‘ã€‚\n\n### é™æ€ä»£ç†\né™æ€ä»£ç†æ˜¯å†™æ­»çš„ï¼Œä¹Ÿå°±æ˜¯è¯´éœ€è¦ç¨‹åºå‘˜æ‰‹åŠ¨å†™ä¸€ä¸ªproxyä»£ç†ç±»ï¼Œä¸åŸå…ˆç±»å…±åŒç»§æ‰¿ä¸€ä¸ªæ¥å£ï¼ˆä¸ªäººç†è§£å…¶å®ä»å®ç°å±‚é¢æ˜¯å¯ä»¥ä¸å…±åŒå®ç°ä¸€ä¸ªæ¥å£çš„ï¼Œä½†æ˜¯è¿™æ ·å°±ä¼šå¯¼è‡´ç®¡ç†æ··ä¹±ï¼Œä»£ç†å¯¹è±¡å¦‚æœèƒ½å¤ç”¨è¿™ä¸ªæ¥å£é‚£å°±ä¼šé€»è¾‘ä¸Šé€šé¡ºå¾ˆå¤šï¼‰\n\né™æ€ä»£ç†å®ç°æ­¥éª¤:\n- å®šä¹‰ä¸€ä¸ªæ¥å£åŠå…¶å®ç°ç±»ï¼›\n- åˆ›å»ºä¸€ä¸ªä»£ç†ç±»åŒæ ·å®ç°è¿™ä¸ªæ¥å£\n- å°†ç›®æ ‡å¯¹è±¡æ³¨å…¥è¿›ä»£ç†ç±»ï¼Œç„¶ååœ¨ä»£ç†ç±»çš„å¯¹åº”æ–¹æ³•è°ƒç”¨ç›®æ ‡ç±»ä¸­çš„å¯¹åº”æ–¹æ³•ã€‚è¿™æ ·çš„è¯ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ä»£ç†ç±»å±è”½å¯¹ç›®æ ‡å¯¹è±¡çš„è®¿é—®ï¼Œå¹¶ä¸”å¯ä»¥åœ¨ç›®æ ‡æ–¹æ³•æ‰§è¡Œå‰ååšä¸€äº›è‡ªå·±æƒ³åšçš„äº‹æƒ…ã€‚\n\nä¸€æ—¦è¦æ–°å¢æ–¹æ³•ï¼Œä»£ç†å¯¹è±¡ä¹Ÿä¼šæ”¹å˜ï¼Œä¸æ»¡è¶³è®¾è®¡æ¨¡å¼ä¸­å¼€æ”¾å°é—­çš„åŸåˆ™ã€‚è¿™äº›ä»£ç†ç±»å®é™…éƒ½æ˜¯åœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­äº§ç”Ÿçš„classæ–‡ä»¶\n\n### åŠ¨æ€ä»£ç†\nåˆ†ä¸ºjdkåŠ¨æ€ä»£ç†å’Œgclibã€‚å‰è€…å¿…é¡»è¦æ±‚ä»£ç†ç±»å®ç°äº†æŸä¸ªæ¥å£ï¼Œåè€…æ²¡æœ‰è¿™ç‚¹é™åˆ¶ã€‚ä½†æ˜¯ç›¸å¯¹äºjkdè€Œè¨€ï¼Œgclibæ•ˆç‡è¾ƒä½é€Ÿåº¦è¾ƒæ…¢ã€‚gclibçš„åŸç†æ˜¯ç”Ÿæˆä¸€ä¸ªå­ç±»æ¥ä»£ç†çˆ¶ç±»ï¼Œç”±äºä¸èƒ½ç»§æ‰¿finalç±»ï¼Œæ‰€ä»¥gclibä¸èƒ½ä»£ç†finalç±»\n\n**jdkåŠ¨æ€ä»£ç†**\n\n1. Proxy.newProxyInstanceæ–¹æ³•ï¼Œå¾—åˆ°åŠ¨æ€ä»£ç†å¯¹è±¡ã€‚ä¼ å…¥å‚æ•°æ˜¯å¯¹è±¡çš„ç±»åŠ è½½å™¨ï¼Œç±»çš„æ¥å£å’Œä¸€ä¸ªInvocationHandlerè‡ªå®šä¹‰çš„å¤„ç†é€»è¾‘\n2. æ–°å»ºä¸€ä¸ªç±»å®ç°InvocationHandlerï¼Œè¿™é‡Œé¢åªæœ‰ä¸€ä¸ªæ–¹æ³•invokeï¼ŒåŒ…è£…äº†åå°„ä¸­çš„method.invokeï¼Œæˆ‘ä»¬éœ€è¦åœ¨è¿™å¥è°ƒç”¨å‰ååŠ ä¸Šè‡ªå·±çš„é€»è¾‘å°±å¯ä»¥ç®€å•å®ç°aopã€‚\n3. æ–°å»ºä¸€ä¸ªå·¥å‚ç±»çš„é™æ€æ–¹æ³•æ¥è·å–è¿™ä¸ªåŠ¨æ€ä»£ç†å¯¹è±¡\n4. ä½¿ç”¨\n\n```java\nimport java.lang.reflect.InvocationHandler;\nimport java.lang.reflect.Method;\nimport java.lang.reflect.Proxy;\n\n// å®šä¹‰ä¸€ä¸ªæ¥å£\npublic interface HelloService {\n    void sayHello(String name);\n}\n\n// æ¥å£çš„å®ç°ç±»\npublic class HelloServiceImpl implements HelloService {\n    @Override\n    public void sayHello(String name) {\n        System.out.println(\"ä½ å¥½ï¼Œ\" + name + \"ï¼\");\n    }\n}\n\n// InvocationHandlerå®ç°ç±»\npublic class HelloInvocationHandler implements InvocationHandler {\n    private Object target;\n\n    public HelloInvocationHandler(Object target) {\n        this.target = target;\n    }\n\n    @Override\n    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {\n        System.out.println(\"æ–¹æ³•è°ƒç”¨å‰çš„å¤„ç†é€»è¾‘\");\n        Object result = method.invoke(target, args);\n        System.out.println(\"æ–¹æ³•è°ƒç”¨åçš„å¤„ç†é€»è¾‘\");\n        return result;\n    }\n}\n\n// ä½¿ç”¨åŠ¨æ€ä»£ç†\npublic class ProxyDemo {\n    public static void main(String[] args) {\n        // è¢«ä»£ç†çš„å¯¹è±¡\n        HelloService helloService = new HelloServiceImpl();\n\n        // åˆ›å»ºInvocationHandler\n        InvocationHandler handler = new HelloInvocationHandler(helloService);\n\n        // åˆ›å»ºä»£ç†å¯¹è±¡\n        HelloService proxyInstance = (HelloService) Proxy.newProxyInstance(\n                helloService.getClass().getClassLoader(),\n                helloService.getClass().getInterfaces(),\n                handler\n        );\n\n        // è°ƒç”¨ä»£ç†å¯¹è±¡çš„æ–¹æ³•\n        proxyInstance.sayHello(\"å¼ ä¸‰\");\n    }\n}\n\n```\n**gclibåŠ¨æ€ä»£ç†**\n\n1. é¦–å…ˆè‡ªå®šä¹‰MethodInterceptorï¼Œè¿™ä¸€ç‚¹ä¸ä¸Šé¢çš„InvocationHandleræ˜¯ä¸€è‡´çš„ã€‚ä½†æ˜¯æ³¨æ„è¿™é‡Œä¸æ˜¯method.invokeæ¥è°ƒç”¨å®é™…é€»è¾‘äº†ã€‚è¿™é‡Œç”¨methodProxyæ¥è°ƒç”¨åŸå§‹æ–¹æ³•ã€‚\n2. ä½¿ç”¨çš„æ—¶å€™é¦–å…ˆåˆ›å»ºå¢å¼ºç±»Enhancer\n3. è®¾ç½®ç±»åŠ è½½å™¨å’Œçˆ¶ç±»ï¼ˆä¹Ÿå°±æ˜¯è¢«ä»£ç†å¯¹è±¡ï¼‰\n4. è®¾ç½®æ‹¦æˆªå™¨ï¼Œå°±æ˜¯ç¬¬ä¸€ç‚¹åˆ›å»ºçš„å¯¹è±¡\n5. æœ€åè·å–è¿™ä¸ªä»£ç†ç±»\n\n```java\nimport net.sf.cglib.proxy.Enhancer;\nimport net.sf.cglib.proxy.MethodInterceptor;\nimport net.sf.cglib.proxy.MethodProxy;\n\nimport java.lang.reflect.Method;\n\n// ç›®æ ‡ç±»\npublic class Person {\n    public void sayHello(String name) {\n        System.out.println(\"ä½ å¥½ï¼Œ\" + name + \"ï¼\");\n    }\n}\n\n// è‡ªå®šä¹‰çš„MethodInterceptor\npublic class PersonMethodInterceptor implements MethodInterceptor {\n    @Override\n    public Object intercept(Object obj, Method method, Object[] args, MethodProxy proxy) throws Throwable {\n        // åœ¨æ–¹æ³•æ‰§è¡Œå‰æ·»åŠ é€»è¾‘\n        System.out.println(\"ä»£ç†ç±»ï¼šæ–¹æ³•è°ƒç”¨å‰çš„å¤„ç†\");\n\n        // è°ƒç”¨ç›®æ ‡æ–¹æ³•\n        Object result = proxy.invokeSuper(obj, args);\n\n        // åœ¨æ–¹æ³•æ‰§è¡Œåæ·»åŠ é€»è¾‘\n        System.out.println(\"ä»£ç†ç±»ï¼šæ–¹æ³•è°ƒç”¨åçš„å¤„ç†\");\n\n        return result;\n    }\n}\n\n// å®¢æˆ·ç«¯ä»£ç \npublic class CglibProxyDemo {\n    public static void main(String[] args) {\n        // åˆ›å»ºEnhancerå¯¹è±¡\n        Enhancer enhancer = new Enhancer();\n        enhancer.setSuperclass(Person.class); // è®¾ç½®è¢«ä»£ç†ç±»çš„çˆ¶ç±»\n        enhancer.setCallback(new PersonMethodInterceptor()); // è®¾ç½®å›è°ƒ\n\n        // åˆ›å»ºä»£ç†å¯¹è±¡\n        Person proxyPerson = (Person) enhancer.create();\n\n        // è°ƒç”¨ä»£ç†å¯¹è±¡çš„æ–¹æ³•\n        proxyPerson.sayHello(\"å¼ ä¸‰\");\n    }\n}\n\n```\nåœ¨spring aopä¸­ï¼Œå¦‚æœæŸä¸ªç±»å®ç°äº†æ¥å£ï¼Œåˆ™é»˜è®¤ä½¿ç”¨jdkåŠ¨æ€ä»£ç†ï¼›å¦åˆ™ä½¿ç”¨cglib\n\n## å•ä¾‹æ¨¡å¼\nä¿è¯åªæœ‰ä¸€ä¸ªå…¨å±€è®¿é—®ç‚¹ï¼Œæ— è®ºæ€ä¹ˆè®¿é—®éƒ½åªæœ‰ä¸€ä¸ªå¯¹è±¡ã€‚\n\n**é¥¿æ±‰å¼å•ä¾‹**\n\n```java\npublic class singleton {\n    private static final singleton INSTANCE = new singleton();\n    private singleton(){}\n    public static singleton getInstance(){\n        return INSTANCE;\n    }\n}\n```\n\nåœ¨ç±»åŠ è½½åˆå§‹åŒ–çš„æ—¶å€™å°±ç›´æ¥åˆ›å»ºå•ä¾‹å¯¹è±¡ï¼Œé€‚åˆäºç¨‹åºè¿è¡ŒæœŸé—´å§‹ç»ˆéƒ½éœ€è¦è¿™ä¸ªå¯¹è±¡çš„åœºæ™¯ã€‚\n\n**æ‡’æ±‰å¼å•ä¾‹**\n\n```java\npublic class singleton {\n    private static singleton INSTANCE;\n    private singleton(){}\n    public static singleton getINSTANCE(){\n        if (INSTANCE == null){\n            INSTANCE = new singleton();\n        }\n        return INSTANCE;\n    }\n}\n```\nä½†æ˜¯å¯èƒ½ä¼šæœ‰å¹¶å‘å®‰å…¨é—®é¢˜ï¼Œå¦‚æœä¸¤ä¸ªéƒ½æ²¡æœ‰è·å–åˆ°å½“å‰å¯¹è±¡å°±ä¼šäº§ç”Ÿè¦†ç›–æˆ–è€…æ•°æ®ä¸ä¸€è‡´ï¼Œå¯ä»¥ä½¿ç”¨synchronizedæ¥é”ä½è¿™ä¸ªæ–¹æ³•ï¼Œä½†æ˜¯ä¼šå½±å“æ€§èƒ½ã€‚\n\n**åŒé‡æ ¡éªŒé”**\n\nä¸Šé¢é‚£ç§æƒ…å†µä¸‹æ— è®ºæ˜¯å¦å·²ç»å®ä¾‹åŒ–äº†éƒ½éœ€è¦è·å–é”ï¼Œä½†å…¶å®å¦‚æœå…¶å®å·²ç»å®ä¾‹åŒ–äº†å°±ä¸éœ€è¦ä¸Šé”ã€‚è¿˜æœ‰ä¸€ä¸ªå…³é”®é—®é¢˜æ˜¯ä¼šæŒ‡ä»¤é‡æ’ã€‚ä¸€ä¸ªå¯¹è±¡åœ¨åˆ›å»º1è¿‡ç¨‹ä¸­ä¼šç»å†ä¸‰æ­¥ï¼š\n1. åˆ†é…å†…å­˜ç©ºé—´\n2. åˆå§‹åŒ–å¯¹è±¡\n3. æŒ‡é’ˆæŒ‡å‘è¯¥å¯¹è±¡\nå¦‚æœ3é‡æ’å°±ä¼šå˜æˆ132ï¼Œæ­¤æ—¶è¿˜æ²¡æœ‰è¿›è¡Œåˆå§‹åŒ–ã€‚ä¸¤ä¸ªçº¿ç¨‹å¹¶å‘å°±ä¼šå¯¼è‡´æŠ¥ç©ºæŒ‡é’ˆå¼‚å¸¸ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜éœ€è¦volatileç¦æ­¢æŒ‡ä»¤é‡æ’ã€‚\n\n```java\npublic class Singleton {\n    // ç§æœ‰æ„é€ å‡½æ•°\n    private Singleton() {}\n\n    // volatile å…³é”®å­—ç¡®ä¿å®ä¾‹çš„å¯è§æ€§\n    private static volatile Singleton instance;\n\n    // æä¾›å…¨å±€è®¿é—®ç‚¹\n    public static Singleton getInstance() {\n        if (instance == null) {\n            synchronized (Singleton.class) {\n                if (instance == null) {\n                    instance = new Singleton();\n                }\n            }\n        }\n        return instance;\n    }\n}\n```\n\n**å†…éƒ¨é™æ€ç±»**\n\n```java\npublic class Singleton {\n    // ç§æœ‰æ„é€ å‡½æ•°\n    private Singleton() {}\n\n    // é™æ€å†…éƒ¨ç±»\n    private static class Holder {\n        private static final Singleton INSTANCE = new Singleton();\n    }\n\n    // æä¾›å…¨å±€è®¿é—®ç‚¹\n    public static Singleton getInstance() {\n        return Holder.INSTANCE;\n    }\n}\n\n```\n\nå†…éƒ¨é™æ€ç±»åœ¨è¢«è°ƒç”¨çš„æ—¶å€™æ‰ä¼šè¢«åŠ è½½ï¼Œè€Œä¸”ç±»åŠ è½½ä¸ä¼šæœ‰çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œå¤©ç„¶è§£å†³å¹¶å‘é—®é¢˜ã€‚\n\n> å•ä¾‹æ¨¡å¼æ˜¯å¯ä»¥è¢«ç ´åçš„ï¼Œåªè¦é€šè¿‡åå°„æ‹¿åˆ°privateçš„æ„é€ å™¨å°±å¯ä»¥äº†\n\n## ç­–ç•¥æ¨¡å¼\nä¸€ç§æ–¹æ³•å¯ä»¥ç”¨å¤šç§ç®—æ³•å®ç°å°±å¯ä»¥ä½¿ç”¨ç­–ç•¥æ¨¡å¼ï¼Œæ ¹æ®ä¸åŒæƒ…å†µä¸‹ç”¨ä¸åŒçš„ç®—æ³•ã€‚ä¹Ÿå¯ä»¥æ¶ˆé™¤\"if-else\"è¿™æ ·çš„æ§åˆ¶è¯­å¥ã€‚\n\n- ä¸Šä¸‹æ–‡ï¼šæŒæœ‰ä¸€ä¸ªç­–ç•¥çš„å¼•ç”¨ï¼Œå¹¶æä¾›ä¸€ä¸ªæ¥å£æ¥è°ƒç”¨ç­–ç•¥\n- ç­–ç•¥æ¥å£ï¼šå®šä¹‰äº†ä¸€ç³»åˆ—ç®—æ³•çš„å…¬å…±æ¥å£\n- å…·ä½“å®ç°ï¼šç­–ç•¥çš„å…·ä½“å®ç°\n\n```java\n/**\n * å›æ‰§å¤„ç†ç­–ç•¥æ¥å£\n **/\npublic interface ReceiptHandleStrategy {\n\n    void handleReceipt(Receipt receipt);\n}\n/**\n * ç­–ç•¥å®ç°ç±»\n **/\npublic class Mt1011ReceiptHandleStrategy implements ReceiptHandleStrategy {\n\n    @Override\n    public void handleReceipt(Receipt receipt) {\n        System.out.println(\"è§£ææŠ¥æ–‡MT1011: \" + receipt.getMessage());\n    }\n}\n\npublic class Mt2101ReceiptHandleStrategy implements ReceiptHandleStrategy {\n\n    @Override\n    public void handleReceipt(Receipt receipt) {\n        System.out.println(\"è§£ææŠ¥æ–‡MT2101: \" + receipt.getMessage());\n    }\n}\n\n/**\n * ä¸Šä¸‹æ–‡ç±»,æŒæœ‰ç­–ç•¥æ¥å£\n **/\npublic class ReceiptStrategyContext {\n\n    private ReceiptHandleStrategy receiptHandleStrategy;\n\n    public void setReceiptHandleStrategy(ReceiptHandleStrategy receiptHandleStrategy) {\n        this.receiptHandleStrategy = receiptHandleStrategy;\n    }\n\n    //è°ƒç”¨ç­–ç•¥ç±»ä¸­çš„æ–¹æ³•\n    public void handleReceipt(Receipt receipt){\n        if(receipt != null){\n            receiptHandleStrategy.handleReceipt(receipt);\n        }\n    }\n}\n/**\n * ç­–ç•¥å·¥å‚ï¼Œç”¨å“ˆå¸Œè¡¨ä¿å­˜ç­–ç•¥ï¼Œæ ¹æ®å‚æ•°é€‰æ‹©ç­–ç•¥\n **/\npublic class ReceiptHandleStrategyFactory {\n\n    public ReceiptHandleStrategyFactory() {\n    }\n\n    //ä½¿ç”¨Mapé›†åˆå­˜å‚¨ç­–ç•¥ä¿¡æ¯,å½»åº•æ¶ˆé™¤if...else\n    private static Map<String,ReceiptHandleStrategy> strategyMap;\n\n    //åˆå§‹åŒ–å…·ä½“ç­–ç•¥,ä¿å­˜åˆ°mapé›†åˆ\n    public static void init(){\n        strategyMap = new HashMap<>();\n        strategyMap.put(\"MT1011\",new Mt1011ReceiptHandleStrategy());\n        strategyMap.put(\"MT2101\",new Mt2101ReceiptHandleStrategy());\n    }\n\n    //æ ¹æ®å›æ‰§ç±»å‹è·å–å¯¹åº”ç­–ç•¥ç±»å¯¹è±¡\n    public static ReceiptHandleStrategy getReceiptHandleStrategy(String receiptType){\n        return strategyMap.get(receiptType);\n    }\n}\n\npublic class Client {\n\n    public static void main(String[] args) {\n\n        //æ¨¡æ‹Ÿå›æ‰§\n        List<Receipt> receiptList = ReceiptBuilder.genReceiptList();\n\n\n        //ç­–ç•¥ä¸Šä¸‹æ–‡\n        ReceiptStrategyContext context = new ReceiptStrategyContext();\n\n        //ç­–ç•¥æ¨¡å¼å°†ç­–ç•¥çš„ å®šä¹‰ã€åˆ›å»ºã€ä½¿ç”¨è¿™ä¸‰éƒ¨åˆ†è¿›è¡Œäº†è§£è€¦\n        for (Receipt receipt : receiptList) {\n            //è·å–ç½®ç­–ç•¥\n            ReceiptHandleStrategyFactory.init();\n            ReceiptHandleStrategy strategy = ReceiptHandleStrategyFactory.getReceiptHandleStrategy(receipt.getType());\n            //è®¾ç½®ç­–ç•¥\n            context.setReceiptHandleStrategy(strategy);\n            //æ‰§è¡Œç­–ç•¥\n            context.handleReceipt(receipt);\n        }\n    }\n}\n\n```\n\n## é€‚é…å™¨æ¨¡å¼\n\nè®©ä¸€ä¸ªå®ç°ç±»æ»¡è¶³ç»Ÿä¸€çš„æ¥å£ï¼Œä½¿ä¸åŒçš„å®ç°ç±»å¯ä»¥ä¸€èµ·å·¥ä½œã€‚æ»¡è¶³å¼€æ”¾å°é—­åŸåˆ™ã€‚\n1. ä¾‹å¦‚åœ¨Spring AOPä¸­ä¸åŒçš„Adviceå®ç°çš„æ–¹å¼ä¸ä¸€æ ·ç±»ä¹Ÿä¸ä¸€æ ·ï¼Œå¯èƒ½å®ç°çš„æ—¶å€™è¿™ä¸ªç±»çš„æŸä¸ªæ–¹æ³•å«runï¼Œå¦ä¸€ä¸ªå«startï¼Œä¸ºäº†æ˜¯è¿™äº›å®ç°ç±»å®Œæˆç»Ÿä¸€ï¼Œå°±éœ€è¦åŠ ä¸€å±‚é€‚é…å™¨ï¼ŒæŠŠåå­—éƒ½å«åšadvicerunï¼Œç»™å®¢æˆ·ç«¯å‘ˆç°çš„å°±æ˜¯è¿™ä¸ªåå­—ã€‚\n2. SpringMVCä¹Ÿæ˜¯ï¼Œä¸åŒçš„æ§åˆ¶å™¨ç§ç±»æœ‰å¾ˆå¤šï¼Œä¾‹å¦‚æœ‰æ³¨è§£çš„æœ‰è‡ªå·±å†™çš„ï¼Œéœ€è¦ç”¨é€‚é…å™¨ç»Ÿä¸€èµ·æ¥\n\n## è£…é¥°å™¨æ¨¡å¼\n\næ‰©å±•ç±»çš„åŠŸèƒ½ï¼Œæ¯”èµ·ç›´æ¥ç»§æ‰¿ï¼Œè£…é¥°å™¨æ¨¡å¼å¯ä»¥å®ç°å•ä¸€è´£ä»»åŸåˆ™ï¼Œä¹Ÿä¾¿äºåŠŸèƒ½çš„ç»„åˆï¼Œé¿å…ç±»çš„å±‚æ¬¡ç»“æ„å¤æ‚ã€‚\n\n```java\n// ç»„ä»¶æ¥å£\npublic interface Notification {\n    void send(String message);\n}\n\n// å…·ä½“ç»„ä»¶\npublic class SimpleNotification implements Notification {\n    @Override\n    public void send(String message) {\n        System.out.println(\"Sending notification: \" + message);\n    }\n}\n\n// è£…é¥°å™¨æŠ½è±¡ç±»\npublic abstract class NotificationDecorator implements Notification {\n    protected Notification decoratedNotification;\n\n    public NotificationDecorator(Notification notification) {\n        this.decoratedNotification = notification;\n    }\n\n    @Override\n    public void send(String message) {\n        decoratedNotification.send(message);\n    }\n}\n\n// å…·ä½“è£…é¥°å™¨ - é‚®ä»¶\npublic class EmailNotificationDecorator extends NotificationDecorator {\n    public EmailNotificationDecorator(Notification notification) {\n        super(notification);\n    }\n\n    @Override\n    public void send(String message) {\n        super.send(message);\n        sendEmail(message);\n    }\n\n    private void sendEmail(String message) {\n        System.out.println(\"Sending email with message: \" + message);\n    }\n}\n\n// å…·ä½“è£…é¥°å™¨ - çŸ­ä¿¡\npublic class SMSNotificationDecorator extends NotificationDecorator {\n    public SMSNotificationDecorator(Notification notification) {\n        super(notification);\n    }\n\n    @Override\n    public void send(String message) {\n        super.send(message);\n        sendSMS(message);\n    }\n\n    private void sendSMS(String message) {\n        System.out.println(\"Sending SMS with message: \" + message);\n    }\n}\n\n// ä½¿ç”¨ç¤ºä¾‹\npublic class Main {\n    public static void main(String[] args) {\n        Notification notification = new SimpleNotification();\n\n        // æ·»åŠ é‚®ä»¶åŠŸèƒ½\n        notification = new EmailNotificationDecorator(notification);\n        notification.send(\"Hello!\");\n\n        System.out.println(\"----\");\n\n        // æ·»åŠ çŸ­ä¿¡åŠŸèƒ½\n        notification = new SMSNotificationDecorator(notification);\n        notification.send(\"Hello!\");\n    }\n}\n\n```\n\n## è§‚å¯Ÿè€…æ¨¡å¼\nè§‚å¯Ÿè€…æ¨¡å¼é€šè¿‡å®šä¹‰ä¸€å¯¹å¤šçš„ä¾èµ–å…³ç³»ï¼Œä½¿å¾—ä¸€ä¸ªå¯¹è±¡çŠ¶æ€çš„æ”¹å˜èƒ½å¤Ÿè‡ªåŠ¨é€šçŸ¥å¹¶æ›´æ–°æ‰€æœ‰ç›¸å…³å¯¹è±¡ã€‚å®ƒåœ¨è½¯ä»¶å¼€å‘ä¸­å…·æœ‰å¹¿æ³›çš„åº”ç”¨ï¼Œå°¤å…¶é€‚ç”¨äºäº‹ä»¶é©±åŠ¨ç³»ç»Ÿå’Œéœ€è¦è§£è€¦ç»„ä»¶çš„åœºæ™¯ã€‚åœ¨Springæ¡†æ¶ä¸­ï¼Œè§‚å¯Ÿè€…æ¨¡å¼é€šè¿‡äº‹ä»¶å‘å¸ƒå’Œç›‘å¬æœºåˆ¶å¾—åˆ°äº†é«˜æ•ˆçš„å®ç°ï¼Œå¢å¼ºäº†åº”ç”¨ç¨‹åºçš„çµæ´»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚\n\nå°½ç®¡è§‚å¯Ÿè€…æ¨¡å¼å¸¦æ¥äº†è®¸å¤šä¼˜ç‚¹ï¼Œä½†åœ¨ä½¿ç”¨æ—¶ä¹Ÿéœ€æ³¨æ„é¿å…è¿‡å¤šçš„è§‚å¯Ÿè€…å¯¼è‡´ç³»ç»Ÿå¤æ‚æ€§å¢åŠ ï¼Œä»¥åŠæ½œåœ¨çš„æ€§èƒ½é—®é¢˜ã€‚åˆç†åœ°è®¾è®¡å’Œç®¡ç†è§‚å¯Ÿè€…åˆ—è¡¨ï¼Œç¡®ä¿äº‹ä»¶é€šçŸ¥çš„æœ‰æ•ˆæ€§å’Œé«˜æ•ˆæ€§ï¼Œæ˜¯æˆåŠŸåº”ç”¨è§‚å¯Ÿè€…æ¨¡å¼çš„å…³é”®ã€‚","tags":["Java"]},{"title":"æ¶ˆæ¯é˜Ÿåˆ—é¢è¯•ç¯‡","url":"/2024/09/25/kafkaé¢è¯•ç¯‡/","content":"## é›¶æ‹·è´\nrocketMqçš„æ¶æ„æ˜¯ç±»ä¼¼äºkafkaçš„ï¼Œå®ç°äº†è®¸å¤škafkaæ²¡æœ‰çš„åŠŸèƒ½ï¼Œä½†æ˜¯ä¾æ—§æ²¡æœ‰åœ¨å¸‚åœºä¸Šæ‰“è´¥kafkaï¼Œkafkaçš„æ€§èƒ½è¿™ä¹ˆé«˜çš„åŸå› å¾—ç›Šäºé›¶æ‹·è´æŠ€æœ¯ã€‚\n\nåœ¨ä¼ ç»Ÿioæ–¹å¼ä¸­æ˜¯éœ€è¦ç»è¿‡cpuçš„ï¼Œç”¨æˆ·è°ƒç”¨read()æ–¹æ³•ï¼Œæ•°æ®é€šè¿‡dmaä¼ è¾“åˆ°å†…å­˜ç¼“å†²åŒºï¼Œç„¶åé€šè¿‡cpuæ‹·è´åˆ°ç”¨æˆ·æ€çš„ç”¨æˆ·ç¼“å†²åŒºï¼Œå¾—åˆ°äº†ç”¨æˆ·èƒ½è§çš„æ•°æ®ã€‚å†é€šè¿‡write()å°†æ•°æ®æ‹·è´åˆ°æ“ä½œç³»ç»Ÿå†…æ ¸æ€çš„socketå†™ç¼“å†²åŒºï¼Œæœ€åé€šè¿‡ç½‘å¡å‘é€æ•°æ®ã€‚è¿™ä¸ªè¿‡ç¨‹ä¸€å…±ç»å†äº†å››æ¬¡ç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„åˆ‡æ¢ï¼š\n1. ç³»ç»Ÿè°ƒç”¨readï¼Œç”¨æˆ·æ€->å†…æ ¸æ€\n2. dmaåï¼Œcpuå°†æ•°æ®ä»å†…æ ¸æ€æ‹·è´å›ç”¨æˆ·æ€\n3. ç³»ç»Ÿè°ƒç”¨writeï¼Œç”¨æˆ·æ€->å†…æ ¸æ€\n4. writeæ–¹æ³•è¿”å›ï¼Œé‡æ–°å›åˆ°ç”¨æˆ·æ€\n\nä»¥åŠå››æ¬¡æ•°æ®çš„æ‹·è´ã€‚\n\n**mmap**\n\nmmapæ˜¯ä¸€ç§å°†å†…å­˜æ˜ å°„åˆ°ç”¨æˆ·æ€ç©ºé—´çš„ç³»ç»Ÿè°ƒç”¨ã€‚ç®€å•æ¥è¯´å°±æ˜¯ç”¨æˆ·æ€å’Œå†…æ ¸æ€ä½¿ç”¨åŒä¸€ç‰‡ç©ºé—´ï¼Œä¸ç”¨è¿›è¡Œä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚å› æ­¤æ•´ä¸ªæµç¨‹å°±ä¼šå˜ä¸ºï¼š\n1. mmapç³»ç»Ÿè°ƒç”¨ï¼Œç”¨æˆ·æ€->å†…æ ¸æ€\n2. dmaå°†ç£ç›˜æ•°æ®å†™åˆ°å†…æ ¸æ€çš„ç¼“å†²åŒºï¼Œè¿”å›ç»™ç”¨æˆ·æ€ï¼ŒåŒæ—¶ç”¨æˆ·æ€ä¹Ÿèƒ½çœ‹åˆ°è¿™ç‰‡ç¼“å†²åŒºï¼Œå¯ä»¥è¿›è¡Œæ“ä½œã€‚éœ€è¦è¿›è¡Œä¸Šä¸‹æ–‡åˆ‡æ¢ä½†ä¸ç”¨æ‹·è´\n3. æ“ä½œå®Œäº†ä¹‹åç³»ç»Ÿè°ƒç”¨writeå†™åˆ°ç½‘å¡å‘é€ï¼Œç”¨æˆ·æ€->å†…æ ¸æ€\n4. æ‹·è´ä¸¤æ¬¡ï¼Œä»å†…æ ¸æ€ç¼“å†²åŒºæ‹·è´åˆ°socketç¼“å†²åŒºï¼Œå†ç”¨dmaæ–¹å¼å†™å›ç£ç›˜æˆ–è€…ç½‘å¡ï¼Œæœ€åå›åˆ°ç”¨æˆ·æ€\n\nç»¼ä¸Šæ‰€è¿°ï¼Œæ€»å…±ç»å†äº†3æ¬¡ioå’Œå››æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚å‡å°‘çš„è¿™ä¸€æ¬¡å«åšé›¶æ‹·è´ã€‚\n\n**sendfile**\n\nsendfileä¸ä¼šç»™ç”¨æˆ·æ€è¿”å›å…·ä½“çš„æ•°æ®ï¼Œç›´æ¥ä»å†…æ ¸æ€èµ°socketä¼ è¾“èµ°äº†ã€‚\n1. sendfileç³»ç»Ÿè°ƒç”¨ï¼Œç”¨æˆ·æ€->å†…æ ¸æ€\n2. dmaæ‹·è´åˆ°å†…æ ¸æ€çš„ç¼“å†²åŒºï¼Œè¿™é‡Œä¸ä¼šè¿”å›ç»™ç”¨æˆ·æ€å…·ä½“çš„ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯è¯´ç”¨æˆ·æ€æ“ä½œä¸äº†ï¼Œç›´æ¥æ‹·è´ç»™socket\n3. å†ä»socketæ‹·è´åˆ°ç½‘å¡ï¼Œè¿”å›ç”¨æˆ·æ€\n\nç»¼ä¸Šæ‰€è¿°ï¼Œä¸€å…±ä¸¤æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œä¸‰æ¬¡ioï¼Œå¯¹æ¯” mmap+writeï¼Œä¸»è¦æ˜¯æ²¡æœ‰å†ç”¨æˆ·æ€è¿›è¡Œæ‹·è´ã€‚\n\nè¯´äº†è¿™ä¹ˆå¤šï¼Œåˆ°åº•è·Ÿkafkaå’Œrocketmqæœ‰ä»€ä¹ˆå…³ç³»å‘¢ï¼Ÿkafkaæ˜¯åŸºäºsendfileçš„ï¼Œè€Œrocketmqæ˜¯åŸºäºmmapçš„ï¼Œéƒ½ä½¿ç”¨äº†é›¶æ‹·è´æŠ€æœ¯ï¼Œä½†æ˜¯ç”±äºrocketmqæ–°å¢äº†ä¸€äº›é«˜çº§åŠŸèƒ½ï¼Œéœ€è¦ç›´åˆ°å…·ä½“çš„æ•°æ®ä¿¡æ¯è€Œä¸æ˜¯ç›´æ¥å‘é€ï¼Œå°±ç”¨äº†èƒ½çœ‹è§æ•°æ®çš„mmapæ–¹å¼ã€‚kafkaä¸ºäº†è¿½æ±‚æè‡´æ€§èƒ½å°±æ²¡æœ‰è¿™äº›èŠ±é‡Œèƒ¡å“¨çš„åŠŸèƒ½ï¼Œä½¿ç”¨äº†æ•ˆç‡æ›´é«˜çš„sendfile\n\n## æ¶ˆæ¯é˜Ÿåˆ—çš„ä½œç”¨\n- å¼‚æ­¥ï¼šä¸ç”¨ç­‰å¾…åŒæ­¥æ“ä½œï¼ŒæŠŠæ¶ˆæ¯æ‰”ç»™mqç„¶åå°±ç›´æ¥è¿”å›ï¼Œmqè¿æ¥çš„å¦ä¸€ç«¯ä¼šå¼‚æ­¥è¿›è¡Œæ“ä½œ\n- è§£è€¦ï¼šå¯ä»¥å°†ä¸šåŠ¡è¿›è¡Œæ‹†åˆ†ï¼Œä¹Ÿæ˜¯ä¸Šé¢å¼‚æ­¥çš„æ€æƒ³\n- å‰Šå³°ï¼šåˆ°æ¥çš„é«˜å¹¶å‘è¯·æ±‚å…ˆè¿›å…¥mqï¼Œç±»ä¼¼æ¼æ¡¶é™æµç®—æ³•ï¼Œé¿å…æ‰“å€’æœåŠ¡å™¨å’Œæ•°æ®åº“\n\n## Kafkaçš„æ¶æ„\nkafkaæ˜¯åŸºäºå‘å¸ƒè€…-è®¢é˜…è€…æ¨¡å‹çš„ï¼Œåœ¨è¿™ä¸ªæ¨¡å‹ä¸­æœ‰å‘å¸ƒè€…ï¼Œè®¢é˜…è€…ï¼Œbrokerå’ŒæœåŠ¡å‘ç°ä¸­å¿ƒã€‚å…·ä½“åˆ°kafkaå°±æ˜¯producerï¼Œconsumerï¼Œbrokerï¼Œtopicï¼Œpartitionï¼Œé…ç½®ä¸­å¿ƒæ˜¯zookeeperï¼š\n- brokerï¼šå°±æ˜¯ä¸€ä¸ªç‰©ç†ä¸Šçš„kafkaæœåŠ¡å®ä½“\n- topicï¼šæ¶ˆæ¯æ˜¯æŒ‰ç…§ä¸»é¢˜åˆ’åˆ†çš„ï¼Œä¾‹å¦‚ä¸šåŠ¡æ¶ˆæ¯å’Œæ—¥å¿—æ¶ˆæ¯å°±å¯ä»¥ç”¨ä¸¤ä¸ªtopicåˆ’åˆ†\n- partitionï¼šä¸€ä¸ªtopicå†…ä¹Ÿä¸åªæœ‰ä¸€ä¸ªé˜Ÿåˆ—ï¼Œè¿™ä¸ªåˆ†åŒºå°±æ˜¯é˜Ÿåˆ—çš„æ„æ€ã€‚éœ€è¦æ³¨æ„çš„æ˜¯kafkaåœ¨é€»è¾‘ä¸Šæ˜¯ä¸€ä¸ªæ•´ä½“ï¼Œä½†æ˜¯ç‰©ç†ä¸Šä¸€ä¸ªtopicå†…æ‰€æœ‰åˆ†åŒºä¸ä¸€å®šåœ¨åŒä¸€ä¸ªbrokerä¸Šã€‚\n\n<div style=\"text-align: center;\">\n  <img src=\"../img/kafka/img.png\" alt=\"\" />\n</div>\n\n- ç”Ÿäº§è€…ç»„ï¼šç”Ÿæˆæ¶ˆæ¯æ”¾å…¥æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ˜¯å¤šå¯¹å¤šçš„å…³ç³»ï¼Œä¸€ä¸ªç”Ÿäº§è€…å¯ä»¥ç”Ÿæˆå¾ˆå¤šä¸ªtopicçš„æ¶ˆæ¯ï¼Œä¹Ÿå¯ä»¥ç”Ÿæˆä¸€ä¸ªtopicå†…å¤šä¸ªpartitionçš„æ¶ˆæ¯\n- æ¶ˆè´¹è€…ç»„ï¼šæ¶ˆè´¹çš„è¿›åº¦ç”¨offsetè¡¨ç¤ºï¼Œæ¶ˆè´¹è€…ç»„å¹¶ä¸ä¼šçœŸçš„æŠŠæ¶ˆæ¯é˜Ÿåˆ—çš„ä¿¡æ¯åˆ é™¤ï¼Œè€Œæ˜¯ç”¨ä¸€ä¸ªåç§»é‡æ¥è¡¨ç¤ºæ¶ˆè´¹åˆ°äº†å“ªé‡Œã€‚æ¯ä¸€ä¸ªæ¶ˆè´¹è€…ç»„çš„åç§»é‡å¯ä»¥æ˜¯ä¸åŒçš„ï¼Œä¸€èˆ¬æ¥è¯´ä¸€ä¸ªpartitionæœ€å¥½åªæœ‰ä¸€ä¸ªæ¶ˆè´¹è€…ï¼Œå¦‚æœå¤šäº†çš„è¯å¹¶å‘æ§åˆ¶ä¹Ÿä¼šæˆä¸ºæ€§èƒ½å½±å“å› ç´ \n- zookeeperï¼šå¯¹äºå¦‚æ­¤åºå¤§è§„æ¨¡çš„kafkaé›†ç¾¤ï¼Œå®ä½“ä¹‹é—´æ˜¯æ€ä¹ˆäº’ç›¸å‘ç°å¯¹æ–¹çš„ï¼Ÿè¿™é‡Œä½¿ç”¨äº†zookeeperä½œä¸ºæœåŠ¡å‘ç°æ¡†æ¶ã€‚kafkaé«˜åº¦ä¾èµ–zookeeper\n\nkafkaä¸ºäº†ä¿è¯é«˜å¯ç”¨ï¼Œè¿˜æœ‰ç±»ä¼¼ä¸»ä»æ¶æ„çš„å‰¯æœ¬æœºåˆ¶ï¼Œä½¿å¾—æŸä¸ªbrokeræŒ‚äº†ä¹‹åï¼Œéƒ¨ç½²åœ¨å…¶ä»–åœ°æ–¹çš„partitionèƒ½å¤Ÿç»§ç»­å·¥ä½œã€‚æ€»è€Œè¨€ä¹‹ï¼Œä¸€ä¸ªtopicå¤šä¸ªpartitionçš„æœºåˆ¶èƒ½å¤Ÿä½¿æ¶ˆæ¯åˆ†æ•£åœ¨å¤šä¸ªbrokerä¸Šï¼Œå®ç°è´Ÿè½½å‡è¡¡ã€‚partitionçš„å‰¯æœ¬ä¹Ÿä¼šä¿å­˜åœ¨ä¸åŒçš„æœºå™¨ä¸Šã€‚ä»é€»è¾‘ä¸Šçœ‹æ˜¯æ•´ä½“çš„ï¼Œç‰©ç†ä¸Šçœ‹éƒ½ä¸ä¼šé›†ä¸­åœ¨ä¸€å—åŒºåŸŸã€‚\n\n## Kafkaçš„å­˜å‚¨æœºåˆ¶\nå‰æƒ…æè¦ï¼šä¸€ä¸ªtopicå¯èƒ½æ¨ªè·¨å¤šä¸ªbrokerï¼Œæ¯ä¸€ä¸ªbrokerçš„æ–‡ä»¶ç³»ç»Ÿåªä¼šä¿å­˜è‡ªå·±å®é™…ç‰©ç†å­˜å‚¨çš„æ—¥å¿—ã€‚åªæœ‰é€šè¿‡zookeeperæ‰èƒ½çœ‹åˆ°ä¸€ä¸ªtopicçš„å…¨éƒ¨åˆ†åŒºä¿¡æ¯ã€‚\n\nåœ¨ä¸€ä¸ªbrokerä¸‹ï¼Œæ–‡ä»¶ä¿¡æ¯æ˜¯è¿™ä¹ˆå­˜å‚¨çš„ï¼š\n```text\n<kafka-log-dir>/\n    â””â”€â”€ <topic-name>/\n        â””â”€â”€ <partition-number>/\n            â”œâ”€â”€ 00000000000000000000.log        # æ—¥å¿—æ–‡ä»¶\n            â”œâ”€â”€ 00000000000000000000.index      # åç§»é‡ç´¢å¼•æ–‡ä»¶\n            â”œâ”€â”€ 00000000000000000000.timeindex  # æ—¶é—´ç´¢å¼•æ–‡ä»¶\n            â”œâ”€â”€ 00000000000000000001.log        # ä¸‹ä¸€æ—¥å¿—æ®µ\n            â”œâ”€â”€ 00000000000000000001.index      # ä¸‹ä¸€æ—¥å¿—æ®µçš„åç§»é‡ç´¢å¼•æ–‡ä»¶\n            â”œâ”€â”€ 00000000000000000001.timeindex  # ä¸‹ä¸€æ—¥å¿—æ®µçš„æ—¶é—´ç´¢å¼•æ–‡ä»¶\n```\n- æ—¥å¿—æ®µï¼ˆsegmentï¼‰ï¼šä¸€ä¸ªåˆ†åŒºä¸‹æœ‰å¤šä¸ªsegmentï¼Œsegmentä¸­ä¿å­˜äº†å®é™…çš„æ•°æ®ï¼Œè¿™äº›æ•°æ®çš„keyæ˜¯offsetï¼Œæ¯ä¸€ä¸ªsegmentä»¥å½“å‰æœ€å°çš„offsetå‘½åã€‚æŸ¥è¯¢çš„æ—¶å€™é€šè¿‡äºŒåˆ†æŸ¥æ‰¾æ‰¾åˆ°å¯¹åº”çš„offset\n- ç´¢å¼•ï¼ˆindexï¼‰ï¼šåŒæ—¶ä¼šç”Ÿæˆä¸€ä¸ªä¸segmentåŒåçš„ç´¢å¼•ã€‚ä¿å­˜å½“å‰segmentä¸‹offsetçš„ç´¢å¼•ä¿¡æ¯ï¼ˆç±»ä¼¼äºŒçº§ç´¢å¼•ï¼‰ï¼ŒåŠ å¿«æ—¥å¿—å†…çš„æŸ¥æ‰¾é€Ÿåº¦\n- æ—¶é—´ç´¢å¼•æ–‡ä»¶ï¼šå­˜å‚¨offsetå¯¹åº”çš„æ—¶é—´æˆ³ï¼Œä¾¿äºæ ¹æ®æ—¶é—´æŸ¥æ‰¾ä¿¡æ¯ã€‚\n\n**ç”Ÿäº§è€…**\n\nå½“æ”¶åˆ°ç”Ÿäº§è€…æ•°æ®çš„æ—¶å€™ï¼Œç”¨æˆ·æ€å†…å­˜æ¥æ”¶åˆ°ä¹‹åï¼Œä¼šç»™æ“ä½œç³»ç»Ÿå†…æ ¸æ€çš„page cacheï¼Œoså†æ‹©æœºåˆ·ç›˜ã€‚è¿™ä¸ªå†™è¿‡ç¨‹æ˜¯é¡ºåºå†™ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨å¯¹åº”çš„åˆ†åŒºçš„æœ€åä¸€ä¸ªlogåé¢å†™åˆšåˆšçš„æ¶ˆæ¯ã€‚\n\n**æ¶ˆè´¹è€…**\n\næ¶ˆè´¹è€…æ¶ˆè´¹æ•°æ®çš„æ—¶å€™ï¼Œæ ¹æ®offsetå…ˆåœ¨æ–‡ä»¶åä¸­äºŒåˆ†æŸ¥æ‰¾åˆ°segmentï¼Œå†ç”¨å¯¹åº”çš„ç´¢å¼•æ¥åŠ é€Ÿæœç´¢ã€‚\n\n**æ—¥å¿—æ»šåŠ¨**\n\nå¦‚æœä¸€ä¸ªsegmentè¾¾åˆ°äº†é»˜è®¤çš„1GBæˆ–è€…è¶…è¿‡äº†7å¤©æ²¡æœ‰æ–°å¢ï¼Œé‚£å°±ä¼šæœ‰ä¸€ä¸ªæ–°çš„segment\n\n**æ—¥å¿—åˆ é™¤**\n\nå¯ä»¥é…ç½®kafkaçš„æ¶ˆæ¯åˆ é™¤æ—¶é—´ï¼Œè¿™ä¸ªæ—¶å€™ä¸Šé¢çš„æ—¥å¿—ç´¢å¼•æ–‡ä»¶å°±æœ‰ç”¨äº†ï¼Œé€šè¿‡åˆ¤æ–­æ—¶é—´æˆ³æ¥åˆ é™¤ã€‚åœ¨åˆ é™¤è¿‡ç¨‹ä¸­ä¼šä½¿ç”¨copyonwriteä»¥é¿å…æœ‰æ¶ˆè´¹è€…è¿™ä¸ªæ—¶å€™æ¶ˆè´¹æ¶ˆæ¯ã€‚\n\n## Kafkaå¦‚ä½•ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±\næ¶ˆæ¯ä¸¢å¤±ä¸æ˜¯Kafkaä¸€ä¸ªç®¡é“èƒ½è¯´äº†ç®—çš„ï¼Œå¯èƒ½åœ¨ç”Ÿäº§è€…ä¼ è¾“çš„è¿‡ç¨‹ä¸­ä¸¢å¤±ï¼Œä¹Ÿæœ‰å¯èƒ½æ¶ˆè´¹è€…offsetæ›´æ–°å®Œäº†ä¹‹åå°±æ‰äº†å¯¼è‡´æ²¡æœ‰çœŸæ­£æ¶ˆè´¹ä¿¡æ¯ã€‚\n- ç”Ÿäº§è€…çš„ä¿¡æ¯ä¸¢å¤±ï¼šç±»ä¼¼tcpçš„å„ç§æ¡æ‰‹ï¼Œå¯ä»¥ä½¿ç”¨ä¸€ä¸ªå›è°ƒå‡½æ•°è¿”å›kafkaæ˜¯å¦æ¥æ”¶åˆ°äº†ä¿¡æ¯ï¼Œè¿™é‡Œæœ€å¥½ä¸è¦ç”¨åŒæ­¥æ“ä½œgetï¼Œç”¨å¼‚æ­¥ListenableFuture<SendResult<String, Object>>å¼€ä¸€ä¸ªçº¿ç¨‹ç›‘å¬ï¼›å¦‚æœå¤±è´¥äº†å°±é‡ä¼ ï¼Œå¯ä»¥è®¾ç½®é‡ä¼ æ¬¡æ•°ã€‚\n- æ¶ˆè´¹è€…çš„ä¿¡æ¯ä¸¢å¤±ï¼šoffseté»˜è®¤æ˜¯æ¶ˆè´¹è€…æ¥å—äº†è¿™ä¸ªæ¶ˆæ¯å°±æ›´æ–°ï¼Œä½†æ˜¯å¯èƒ½ä¼šå‘ç”Ÿæ‹¿åˆ°æ¶ˆæ¯å°±æ‰ç”µå¯¼è‡´æ¶ˆæ¯æ²¡æœ‰å®é™…è¢«æ¶ˆè€—ã€‚å¯ä»¥é‡‡ç”¨offsetæ‰‹åŠ¨æ›´æ–°ï¼Œåœ¨æ¶ˆè´¹è€…é€»è¾‘çš„æœ€åæ‰‹åŠ¨æäº¤offsetï¼Œè¿™æ ·å°±èƒ½ä¿è¯æ¶ˆè´¹å®Œäº†æ‰æ›´æ–°offset\n- kafkaçš„ä¿¡æ¯ä¸¢å¤±ï¼šæ¶æ„ä¸­éƒ½æœ‰è¿™ä¹ˆå¤šå‰¯æœ¬åœ¨å…œåº•äº†ï¼Œä½†æ˜¯å‰¯æœ¬ä¹‹é—´ä¸ä¸€å®šæ—¶æ—¶åˆ»åˆ»éƒ½ä¿æŒåŒæ­¥ã€‚è®¾ç½®å‡ ä¸ªå‚æ•°å°±èƒ½ä¿è¯kafkaçš„é«˜å¯ç”¨\n\n> - acks=allï¼Œè¡¨ç¤ºæ‰€æœ‰å‰¯æœ¬éƒ½æ›´æ–°å®Œå†™æ“ä½œæ‰è¿”å›ï¼Œé»˜è®¤å€¼æ˜¯1ï¼Œä¹Ÿå°±æ˜¯ä¸»èŠ‚ç‚¹æ›´æ–°äº†å°±è¿”å›ï¼Œä½†æ˜¯è¿™æ ·ä¾æ—§å¯èƒ½é€ æˆä¸¢æ•°æ®é—®é¢˜ã€‚å› æ­¤ä¸ºäº†ç»å¯¹å®‰å…¨å¯ä»¥è®¾ç½®acks=allï¼Œä½†æ˜¯ä¼šæå¤§çš„å½±å“æ€§èƒ½ã€‚\n> - è®¾ç½®å‰¯æœ¬æ•°é‡>=3ï¼Œè™½ç„¶é€ æˆäº†æ•°æ®å†—ä½™ï¼Œä½†æ˜¯å¯ä»¥ä¿è¯é«˜å¯ç”¨\n> - è®¾ç½®æ›´æ–°çš„å‰¯æœ¬æ•°é‡>1ï¼Œè¿™æ ·é…ç½®ä»£è¡¨æ¶ˆæ¯è‡³å°‘è¦è¢«å†™å…¥åˆ° 2 ä¸ªå‰¯æœ¬æ‰ç®—æ˜¯è¢«æˆåŠŸå‘é€ã€‚min.insync.replicas çš„é»˜è®¤å€¼ä¸º 1 ï¼Œåœ¨å®é™…ç”Ÿäº§ä¸­åº”å°½é‡é¿å…é»˜è®¤å€¼ 1ï¼Œæ˜¯acks=allçš„ä¸€ç§æŠ˜ä¸­\n> - è®¾ç½® unclean.leader.election.enable = falseï¼Œå½“å‘ç”Ÿä¸»ä»æ•°æ®ä¸ä¸€è‡´çš„æ—¶å€™ï¼Œåªæœ‰å®Œå…¨åŒæ­¥çš„æ•°æ®å‰¯æœ¬æ‰èƒ½è¢«é€‰ä¸¾ä¸ºleader\n\nkafkaæ˜¯apæ¶æ„è¿˜cpæ¶æ„ï¼Ÿä»ä¸Šé¢çš„å„ç§é»˜è®¤å‚æ•°æ¥çœ‹ï¼Œæ¯”å¦‚acks=1ï¼Œé»˜è®¤çš„æ—¶å€™è¿˜æ˜¯å€¾å‘äºå¯ç”¨æ€§çš„ï¼Œä¹Ÿå°±æ˜¯ä¼šç‰ºç‰²ä¸€éƒ¨åˆ†ä¸€è‡´æ€§ã€‚ä½†æ˜¯ç»è¿‡ä¸Šé¢çš„ç§ç§é…ç½®ä¹‹åï¼Œå°±å¯ä»¥ä½¿kafkaé›†ç¾¤æ˜¯å¼ºä¸€è‡´æ€§çš„ï¼Œåœ¨æŸäº›åœºåˆä¸‹å¯ä»¥çµæ´»æ”¹å˜é…ç½®ã€‚\n\n## ç”Ÿäº§è€…å‘Kafkaå‘é€æ¶ˆæ¯çš„æ‰§è¡Œæµç¨‹\n1. é…ç½®ç”Ÿäº§è€…ï¼Œä¸€èˆ¬æ¶ˆæ¯æœ‰ä¸‰ä¸ªå€¼ï¼Œtopicï¼Œkeyå’Œvalueï¼ˆä¿è¯é¡ºåºçš„è¯å°±è¦æŒ‡å®špartitionï¼‰ã€‚è¿˜å¯ä»¥é…ç½®acksçš„å‚æ•°ï¼Œretiesçš„æ¬¡æ•°ï¼Œé…ç½®å®Œè¿™äº›ä¹‹åäº§ç”Ÿä¸€ä¸ªç”Ÿäº§è€…å¯¹è±¡ã€‚\n2. åºåˆ—åŒ–æ¶ˆæ¯ï¼Œå°†keyå’Œvalueåºåˆ—åŒ–ï¼Œä¾‹å¦‚StringSerializer\n3. æ¶ˆæ¯éœ€è¦é€‰æ‹©è¿›å…¥å“ªä¸ªåˆ†åŒºï¼Œå¦‚æœkeyæ²¡æœ‰é…ç½®çš„è¯å°±è½®è¯¢ï¼ˆRRï¼‰ï¼Œå¦‚æœæœ‰çš„è¯å°±hashç„¶åå–æ¨¡\n4. å¦‚æœé…ç½®äº†æ‰¹å¤„ç†ï¼Œå…ˆæŠŠæ¶ˆæ¯æ”¾åœ¨ç¼“å†²åŒºï¼Œç­‰è¾¾åˆ°äº†batchsizeå†ä¼ é€\n5. è¯·æ±‚å‹ç¼©ï¼škafkaé›†ç¾¤ä¸»è¦çš„ç“¶é¢ˆåœ¨ç½‘ç»œioè€Œä¸æ˜¯cpuï¼Œåœ¨è¿›å…¥çš„æ—¶å€™å‹ç¼©ï¼Œåœ¨å‡ºå»çš„æ—¶å€™è§£å‹ï¼Œèƒ½å¤Ÿå‡å°‘ç½‘ç»œå»¶è¿Ÿ\n6. å½“è¾¾åˆ°äº†batchsizeï¼Œæ ¹æ®é€‰æ‹©çš„åˆ†åŒºå‘å¾€brokerã€‚æ ¹æ®acksé…ç½®çš„å‚æ•°è¿”å›æ¶ˆæ¯\n7. è¶…æ—¶é‡è¯•\n8. å¦‚æœæœ‰å›è°ƒå‡½æ•°å°±ä¼šæ‰§è¡Œ\n\n> kafkaå¯ä»¥åœ¨åˆ†åŒºå†…ä¿è¯é¡ºåºï¼Œä½†æ˜¯æ¶ˆè´¹çš„æ•´ä½“é¡ºåºæ˜¯æ— æ³•ä¿è¯çš„ï¼Œå¦‚æœéœ€è¦ä¸¥æ ¼çš„é¡ºåºæ¶ˆè´¹ï¼Œä»¥ä¸‹æœ‰ä¸¤ç§æ–¹æ³•è§£å†³ï¼š\n> - æŒ‡å®škeyæ˜¯ç›¸åŒçš„ï¼Œåœ¨åºåˆ—åŒ–çš„æ—¶å€™æ— æ³•ä¿è¯ä¸åŒçš„keyæ•£åˆ—å–ä½™ä»¥åæ˜¯åœ¨åŒä¸€ä¸ªåˆ†åŒºï¼Œå¦‚æœkeyæ˜¯ç›¸åŒçš„å°±å¯ä»¥ä¿è¯åœ¨ä¸€ä¸ªåˆ†åŒº\n> - keyå¯ä»¥ä¸åŒï¼ŒæŒ‡å®špartitionç›¸åŒå°±å¯ä»¥äº†ï¼Œä»æ ¹æºä¸Šè§£å†³é—®é¢˜\n\n## æ¶ˆè´¹è€…æ¶ˆè´¹å¤±è´¥ä¼šæ€æ ·\næ¶ˆè´¹è€…ä¼šæœ‰ä¸€ä¸ªé‡è¯•æ¬¡æ•°ï¼Œå¦‚æœç”±äºç½‘ç»œå¯¼è‡´æ¶ˆè´¹å¤±è´¥ï¼Œä¿¡æ¯ä¸ä¼šé˜»å¡ï¼Œä¼šè¿›å…¥ä¸€ä¸ªæ­»ä¿¡é˜Ÿåˆ—ã€‚å¯ä»¥åœ¨è¿™ä¸ªé˜Ÿåˆ—é‡Œé¢è¿›ä¸€æ­¥åˆ†æåŸå› ï¼Œä¹Ÿå¯ä»¥ç»§ç»­æ¶ˆè´¹è¿™ä¸ªé˜Ÿåˆ—çš„ä¿¡æ¯ã€‚\n\né‡è¯•æ¬¡æ•°é»˜è®¤æ˜¯10æ¬¡ï¼Œå¹¶ä¸”é—´éš”æ˜¯0sï¼Œä¹Ÿå°±æ˜¯ç«‹å³é‡è¯•10æ¬¡ï¼Œæ²¡æœ‰æ¶ˆè´¹æˆåŠŸå°±è¿›å…¥æ­»ä¿¡é˜Ÿåˆ—ï¼Œä¸ä¼šé˜»å¡ä¸‹ä¸€æ¡ä¿¡æ¯ã€‚\n\n\n\n\n## Kafkaå¦‚ä½•ä¿è¯ä¸é‡å¤æ¶ˆè´¹ä¿¡æ¯\nå¦‚ä¸Šé¢æ‰€è¿°ï¼Œå³ä¾¿æ˜¯æ‰‹åŠ¨æäº¤offsetè¿˜æ˜¯å¯èƒ½å‡ºç°é‡å¤æ¶ˆè´¹ï¼Œè¿™ä¸ªæ—¶å€™åªèƒ½é€šè¿‡æ¶ˆè´¹è€…çš„å¹‚ç­‰è¿›è¡Œæ ¡éªŒäº†\n\n**ä¸‰ç§æ¶ˆæ¯æŠ•é€’ä¿è¯**\n- At most onceï¼šè‡³å¤šä¸€æ¬¡ï¼Œå¯¹åº”ä¸Šé¢çš„æ¶ˆè´¹è€…è‡ªåŠ¨æäº¤offsetï¼Œè¿™ä¸ªæ—¶å€™æ‰ç”µäº†è¿™æ¡æ¶ˆæ¯å°±æ²¡æœ‰äº†\n- At least onceï¼šå¯¹åº”æ‰‹åŠ¨æäº¤offsetï¼Œå¯èƒ½ä¼šé‡å¤å¤šæ¬¡ã€‚éœ€è¦æ¶ˆè´¹è€…è‡ªå·±åšå¹‚ç­‰\n- Exactly onceï¼šæ¶ˆæ¯ç²¾ç¡®ä¼ è¾“ä¸€æ¬¡ã€‚è¿™ä¸ä»…ä»…ä¾èµ–äºkafkaï¼ŒåŒæ—¶ä¹Ÿè¦æ¶ˆè´¹è€…çš„é…åˆã€‚\n\nkafkaçš„ç”Ÿäº§è€…åœ¨å‘é€çš„æ—¶å€™ä¼šç”¨å…¨å±€å”¯ä¸€id+offsetæ¥è¿›è¡Œå¹‚ç­‰å‘é€ï¼Œé¿å…å› ä¸ºå‘é€ç«¯è¶…æ—¶é‡è¯•è€Œå¯¼è‡´é‡å¤æ¶ˆè´¹ã€‚åŒæ—¶å¼€å¯äº‹åŠ¡ï¼Œç¡®ä¿æ¶ˆæ¯æ˜¯åŸå­æ€§çš„ã€‚\n\næ¶ˆè´¹è€…åªä¼šæ¶ˆè´¹å·²ç»æäº¤è¿‡äº‹åŠ¡çš„æ¶ˆæ¯ï¼ˆç±»ä¼¼MVCCï¼Œæœªæäº¤äº‹åŠ¡çš„ä¿¡æ¯æ˜¯æœ‰å¯èƒ½å›æ»šçš„ï¼Œæ¶ˆè´¹ä»–ä»¬æœ‰é£é™©ï¼‰ã€‚åŒæ—¶ç±»ä¼¼At Least onceï¼Œæ¶ˆè´¹è€…ä¹Ÿéœ€è¦é…åˆåšå¹‚ç­‰ã€‚\n\n\n### Exactly Once çš„å®ç°æœºåˆ¶\n\n1. **ç”Ÿäº§è€…çš„è§’è‰²**ï¼š\n    - **å¹‚ç­‰æ€§**ï¼šç”Ÿäº§è€…é€šè¿‡å¯ç”¨å¹‚ç­‰æ€§åŠŸèƒ½ï¼ˆ`enable.idempotence=true`ï¼‰æ¥ç¡®ä¿åœ¨å‘é€è¿‡ç¨‹ä¸­ï¼Œæ¯æ¡æ¶ˆæ¯åªæœ‰ä¸€ä¸ªå”¯ä¸€çš„ IDã€‚å³ä½¿å‘ç”Ÿç½‘ç»œé”™è¯¯æˆ–é‡è¯•ï¼Œç”Ÿäº§è€…ä¹Ÿä¸ä¼šé‡å¤å‘é€ç›¸åŒçš„æ¶ˆæ¯ã€‚\n    - **äº‹åŠ¡æ”¯æŒ**ï¼šç”Ÿäº§è€…ä½¿ç”¨äº‹åŠ¡æ¥å‘é€æ¶ˆæ¯ã€‚åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œç”Ÿäº§è€…å¯ä»¥å‘é€å¤šæ¡æ¶ˆæ¯ï¼Œè¿™äº›æ¶ˆæ¯åœ¨è°ƒç”¨ `commitTransaction()` ä¹‹å‰å¯¹æ¶ˆè´¹è€…æ˜¯ä¸å¯è§çš„ã€‚å¦‚æœåœ¨å‘é€è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œç”Ÿäº§è€…å¯ä»¥è°ƒç”¨ `abortTransaction()`ï¼Œæ­¤æ—¶æ‰€æœ‰æ¶ˆæ¯éƒ½å°†è¢«ä¸¢å¼ƒï¼Œç¡®ä¿æ²¡æœ‰æœªæäº¤çš„æ¶ˆæ¯è¢«æ¶ˆè´¹ã€‚\n\n2. **æ¶ˆè´¹è€…çš„è§’è‰²**ï¼š\n    - **é…ç½®ä¸º `read_committed`**ï¼šæ¶ˆè´¹è€…é…ç½®ä¸º `isolation.level=read_committed`ï¼Œç¡®ä¿åªè¯»å–é‚£äº›å·²æˆåŠŸæäº¤çš„äº‹åŠ¡æ¶ˆæ¯ã€‚è¿™æ„å‘³ç€æ¶ˆè´¹è€…åªä¼šå¤„ç†ç”Ÿäº§è€…é€šè¿‡ `commitTransaction()` æäº¤çš„æ¶ˆæ¯ã€‚\n    - **æ‰‹åŠ¨æäº¤åç§»é‡**ï¼šæ¶ˆè´¹è€…åœ¨å¤„ç†æ¯æ¡æ¶ˆæ¯åæ‰‹åŠ¨æäº¤åç§»é‡ï¼ˆ`commitSync()`ï¼‰ï¼Œä»¥æ ‡è®°è¿™äº›æ¶ˆæ¯å·²è¢«æˆåŠŸå¤„ç†ã€‚åªæœ‰åœ¨ç¡®è®¤æ¶ˆæ¯å¤„ç†æˆåŠŸåï¼Œæ‰æäº¤åç§»é‡ï¼Œä»¥é¿å…å¤„ç†å¤±è´¥å¯¼è‡´çš„é‡å¤æ¶ˆè´¹ã€‚\n    - **å®ç°å¹‚ç­‰æ€§å¤„ç†**ï¼šæ¶ˆè´¹è€…åœ¨ä¸šåŠ¡é€»è¾‘ä¸­éœ€è¦å®ç°å¹‚ç­‰æ€§ï¼Œä»¥ç¡®ä¿å³ä½¿åŒä¸€æ¡æ¶ˆæ¯è¢«å¤šæ¬¡æ¶ˆè´¹ï¼Œæœ€ç»ˆçš„ä¸šåŠ¡æ•ˆæœä¹Ÿåº”è¯¥ä¸€è‡´ã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨æ•°æ®åº“çš„å”¯ä¸€çº¦æŸæ¥é¿å…é‡å¤æ’å…¥ã€‚\n\n### æ€»ç»“\n\n- **å”¯ä¸€æ€§ä¿è¯**ï¼šé€šè¿‡ç”Ÿäº§è€…çš„å”¯ä¸€ ID å’Œäº‹åŠ¡ç®¡ç†ï¼Œç¡®ä¿åœ¨ Kafka ä¸­å‘é€çš„æ¶ˆæ¯æ˜¯å”¯ä¸€çš„ï¼Œå¹¶ä¸”ä¸ä¼šå› é‡è¯•è€Œé‡å¤ã€‚\n- **æ¶ˆè´¹çš„ä¸€è‡´æ€§**ï¼šæ¶ˆè´¹è€…é€šè¿‡æ‰‹åŠ¨æäº¤åç§»é‡å’Œå®ç°å¹‚ç­‰æ€§æ¥ç¡®ä¿æ¶ˆæ¯çš„æ¶ˆè´¹æ˜¯å”¯ä¸€çš„ï¼Œå¹¶ä¸”åªå¤„ç†é‚£äº›å·²ç»æäº¤çš„æ¶ˆæ¯ï¼Œé¿å…äº†æœªæäº¤æ¶ˆæ¯å¯èƒ½å¼•èµ·çš„å›æ»šå’Œä¸ä¸€è‡´ã€‚\n- **æ¶ˆæ¯å¯è§æ€§**ï¼šæœªæäº¤çš„äº‹åŠ¡æ¶ˆæ¯å¯¹æ¶ˆè´¹è€…æ˜¯ä¸å¯è§çš„ï¼Œç¡®ä¿äº†åªæœ‰ç»è¿‡ç¡®è®¤çš„æ¶ˆæ¯æ‰èƒ½è¢«æ¶ˆè´¹ã€‚\n\nè¿™ç§æœºåˆ¶ç»“åˆèµ·æ¥ï¼Œä½¿å¾—åœ¨ Kafka ä¸­èƒ½å¤Ÿå®ç° **Exactly Once** çš„æ¶ˆæ¯å¤„ç†è¯­ä¹‰ï¼Œä»è€Œåœ¨å…³é”®ä»»åŠ¡å’Œéœ€è¦é«˜ä¸€è‡´æ€§çš„æ•°æ®æµåŠ¨åœºæ™¯ä¸­å¾—ä»¥åº”ç”¨ã€‚\n\n\n> ä¹±å…¥ä¸€ä¸‹rocketmq\n\n## RocketMQ\né˜¿é‡Œçš„rocketmqå‚è€ƒäº†kafkaçš„æ¶æ„ï¼Œåœ¨æ¶æ„ä¸Šåšå‡æ³•ï¼Œåœ¨åŠŸèƒ½ä¸ŠåšåŠ æ³•ã€‚ä¸»è¦åŒºåˆ«æœ‰ï¼š\n- å­˜å‚¨æ¨¡å¼ï¼škafkaçš„æ•°æ®å­˜å‚¨æ˜¯æŒ‰ç…§segmentï¼Œä¸€ä¸ªpartitionæœ‰å¾ˆå¤šsegmentï¼Œåšçš„æ˜¯è¿½åŠ å†™ï¼Œä½†æ˜¯ä¸€ä¸ªbrokerä¸‹é¢æœ‰å¾ˆå¤šçš„topicï¼Œè®¿é—®é‡å¤§èµ·æ¥å°±ä¸æ˜¯è¿½åŠ å†™ä¼šé€€åŒ–ä¸ºéšæœºå†™ã€‚rocketmqå‘ç°äº†è¿™ä¸€ç‚¹ï¼Œä»–å°†æ‰€æœ‰çš„queueéƒ½æ”¾åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸Šcommitlogï¼Œè€Œqueueåªæ”¾offsetå’Œå¯¹åº”ç´¢å¼•ã€‚è¿™æ ·å°±èƒ½ä¸€ç›´æ˜¯è¿½åŠ å†™äº†\n- åŒæ­¥æ¨¡å¼ï¼šæŒ‰ç…§ä¸Šé¢çš„é€»è¾‘ï¼Œkafkaé‚£ç§replicaå°±ä¸è¡Œäº†ï¼Œå› ä¸ºkafkaæ˜¯æŒ‰ç…§partitionè¿›è¡ŒåŒæ­¥å’Œå†—ä½™çš„ï¼Œpartitionå¯ä»¥åˆ†å¸ƒåœ¨ä¸åŒçš„brokerä¸Šçš„ä¸€ä¸ªåŸå› å°±æ˜¯segmentæ˜¯åˆ†å¼€æ¥çš„ã€‚rocketmqæŠŠè¿™ä¸€ç‚¹ä¼˜åŒ–äº†ï¼Œæ‰€ä»¥rocketmqæ˜¯ç±»ä¼¼rediså’Œmysqlé‚£æ ·ï¼Œä»¥brokerä¸ºå•ä½è¿›è¡Œä¸»ä»åŒæ­¥\n- ç®€åŒ–åè°ƒèŠ‚ç‚¹ï¼škafkaé«˜åº¦ä¾é zookeeperï¼Œå¤ªé‡äº†ã€‚rocketmqç›´æ¥ç”¨nacoså°±å¯ä»¥äº†ï¼Œä½œä¸ºå¾®æœåŠ¡çš„ä¸€ä¸ªæ¨¡å—\n- é›¶æ‹·è´ï¼škafkaæ˜¯sendfileè€Œrocketmqæ˜¯mmap+write\n- åŠŸèƒ½å¢å¼ºï¼šå»¶è¿Ÿé˜Ÿåˆ—ï¼Œæ­»ä¿¡é˜Ÿåˆ—ï¼ŒæŒ‰ç…§tagè¿‡æ»¤æ¶ˆæ¯ï¼Œäº‹åŠ¡\n\n> ä¹±å…¥ä¸€ä¸‹elasticsearchï¼Œä¼°è®¡é—®çš„ä¹Ÿä¸å¤šï¼Œç®€å•äº†è§£ä¸€ä¸‹\n\n## elasticsearch\nå¾®è§‚åˆ°å®è§‚ï¼Œæœ€å°å•å…ƒsegment->shard->node->é›†ç¾¤ã€‚\n```text\næœåŠ¡å™¨å®ä½“ (Node 1)                æœåŠ¡å™¨å®ä½“ (Node 2)\n+---------------------+            +---------------------+\n|  Primary Shard 1    |            |  Primary Shard 2    |\n|  (Lucene Instance 1)|            |  (Lucene Instance 2)|\n|     +-------------+ |            |     +-------------+ |\n|     | Segment 1   | |            |     | Segment 3   | |\n|     | Segment 2   | |            |     | Segment 4   | |\n|     +-------------+ |            |     +-------------+ |\n|                     |            |                     |\n|  Replica Shard 2    |            |  Replica Shard 1    |\n|  (Lucene Instance 3)|            |  (Lucene Instance 4)|\n|     +-------------+ |            |     +-------------+ |\n|     | Segment 5   | |            |     | Segment 6   | |\n|     | Segment 6   | |            |     | Segment 7   | |\n|     +-------------+ |            |     +-------------+ |\n+---------------------+            +---------------------+\n```\n### segment\n1. å€’æ’ç´¢å¼•ï¼šç”¨åˆ†è¯å™¨å°†æ¯ä¸ªå•è¯ä½œä¸ºé”®ï¼Œå€¼ä¸ºå¯¹åº”çš„å¥å­idå°±å¯ä»¥æ–¹ä¾¿å…³é”®è¯æŸ¥æ‰¾äº†\n2. å‰ç¼€ç´¢å¼•ï¼šå•é ä¸Šé¢çš„å€’æ’ç´¢å¼•æŸ¥è¯¢èµ·æ¥è¿˜æ˜¯å¾ˆè´¹åŠ²ã€‚å¯ä»¥ä½¿ç”¨å‰ç¼€æ ‘trieå®Œæˆã€‚æ”¾åœ¨å†…å­˜é‡Œæ–¹ä¾¿æŸ¥è¯¢\n3. å¥å­å®é™…çš„å­˜å‚¨ä½ç½®ï¼šå€’æ’ç´¢å¼•åªæ˜¯æ”¾äº†å¥å­çš„idï¼ŒçœŸæ­£çš„å¥å­å­˜å‚¨åœ¨è¿™é‡Œ\n4. ä¸€ç§æ–¹ä¾¿æ’åºå’Œèšåˆçš„æ•°æ®ç»“æ„ï¼šæŸäº›æ—¶å€™ç”¨æˆ·å¯èƒ½æƒ³è¦æŒ‰ç…§æ—¶é—´æ’åºï¼Œä½†æ˜¯è¿™äº›å­—æ®µæ”¾åœ¨3ä¸­æ˜¯å¾ˆä¸å¥½çš„ï¼Œéœ€è¦å›è¡¨å†å»æ’åºã€‚ä¸å¦‚ç›´æ¥ç”¨ç©ºé—´æ¢æ—¶é—´ï¼Œå°†æ—¶é—´ä¿¡æ¯æå–å‡ºæ¥å•ç‹¬åšä¸€ä¸ªè¡¨\n\nä»¥ä¸Šçš„å››ä¸ªéƒ¨åˆ†å…±åŒæ„æˆäº†ä¸€ä¸ªsegmentï¼Œè¿™æ˜¯æœç´¢å¼•æ“çš„æœ€å°å•å…ƒã€‚ä½†æ˜¯ç”±äºå‰ç¼€ç´¢å¼•ä¸å¥½è¿›è¡Œæ‰©å®¹ï¼Œå¯ä»¥çº¦å®šæ–°å¢å‡ æ¡å¥å­å°±å¼€è¾Ÿä¸€ä¸ªæ–°çš„segmentï¼ŒåŒæ—¶ä¹Ÿè§£å†³äº†è¯»å†™é—®é¢˜ã€‚é—®é¢˜æ˜¯æ–‡ä»¶ä¼šå˜å¤šï¼Œå¯ä»¥é‡‡ç”¨å®šæ—¶åˆå¹¶çš„æ–¹æ³•ã€‚è¿™æ ·å¤šä¸ªsegmentå°±æ„æˆäº†luceneï¼ˆshardï¼‰ã€‚å¦‚æœæœ‰æœç´¢è¯·æ±‚å°±ä¼šå¹¶å‘åœ¨æ‰€æœ‰segmenté‡Œé¢è¿›è¡Œæœç´¢ã€‚\n\n### shard\nå…¶å®ä¸Šé¢çš„å¤šä¸ªsegmentåŠ èµ·æ¥å°±æ˜¯ä¸€ä¸ªluceneï¼Œåœ¨esä¸­å¦‚æœåªæœ‰ä¸€ä¸ªluceneé‚£ä¹ˆè¯»å†™æ•ˆç‡ä¼šå˜å¾—å¾ˆæ…¢ï¼š\n- åœ¨å‚ç›´ä¸Šå¯ä»¥å‚è€ƒkafkaçš„topicè®¾ç½®å¤šä¸ªindex_nameï¼Œä¾‹å¦‚åˆ†ä½“è‚²æ–°é—»å’Œå¨±ä¹æ–°é—»ã€‚ä¸€ä¸ªindexå¯¹åº”ä¸€ä¸ªluceneã€‚\n- åœ¨æ°´å¹³ä¸Šå¯ä»¥å°†luceneå†åˆ†å°ä¸€ç‚¹ï¼Œæ¯ä¸ªæ®µå°‘åˆ†ä¸€ç‚¹segmentï¼Œè¿™å°±å˜æˆäº†æ ‡é¢˜æ‰€è¯´çš„shardï¼Œæœ¬è´¨ä¸Šshardå°±æ˜¯luceneçš„ä¸€ä¸ªå®ä¾‹ã€‚è¿™æ ·è¯»å†™æ“ä½œæœ‰å¯èƒ½ä¼šè¢«åˆ†å¼€ï¼Œæé«˜æ•ˆç‡\n\nåŒæ—¶ä¸ºäº†é«˜å¯ç”¨è¿˜æœªæ¯ä¸ªshardæä¾›äº†å‰¯æœ¬æœºåˆ¶ï¼Œåˆ†æ•£åœ¨ä¸åŒçš„nodeä¸­\n### node\nä¸€ä¸ªnodeå°±æ˜¯ä¸€ä¸ªæœåŠ¡å™¨èŠ‚ç‚¹ï¼Œç±»ä¼¼kafkaçš„brokerï¼Œå¯ä»¥æ”¾å¾ˆå¤šä¸åŒtopicçš„ä¸åŒpartitionï¼ŒåŒ…æ‹¬å‰¯æœ¬å•¥çš„ã€‚è¿™é‡Œå°±ä¼šè¦ä¸€ä¸ªç±»ä¼¼zookeeperçš„æœåŠ¡å‘ç°ä¸­å¿ƒï¼Œä½†åœ¨esé‡Œæ˜¯å»ä¸­å¿ƒåŒ–çš„ï¼Œé€šè¿‡raftåè®®é€‰ä¸¾ã€‚\n\nnodeæœ‰å¾ˆå¤šèŒè´£ï¼Œæœ‰è´Ÿè´£ç®¡ç†é›†ç¾¤çš„ï¼ˆç±»ä¼¼å“¨å…µè´Ÿè´£æ•…éšœè½¬ç§»å’Œé€‰ä¸»ï¼‰ï¼Œæœ‰å­˜å‚¨æ•°æ®çš„ã€‚æœ‰å®ç°restfulæ¥å£çš„ï¼Œåœ¨é›†ç¾¤ç¯å¢ƒä¸‹å¯ä»¥åˆ†å¼€ã€‚æ¯ä¸€ä¸ªnodeè´Ÿè´£ä¸åŒçš„èŒè´£ã€‚\n\n**æ•°æ®å¦‚ä½•æŸ¥æ‰¾**\n\n1. å®¢æˆ·ç«¯å‘é€restçš„httpè¯·æ±‚ç»™é›†ç¾¤ä¸­è´Ÿè´£æ¥æ”¶çš„node\n2. åœ¨æŒ‡å®šindex_nameä¸‹hashåˆ†ç‰‡æ‰¾åˆ°å¯¹åº”çš„shard\n3. åœ¨shardä¸­å¹¶è¡ŒæŸ¥æ‰¾segment\n4. segmentæ ¹æ®å€’æ’ç´¢å¼•æ‰¾åˆ°å¯¹åº”å¥å­çš„idè¿”å›\n5. å†å»æ ¹æ®idè¿›è¡Œå›è¡¨ï¼Œæ‰¾åˆ°å¥å­è¿”å›\n\n\n\n\n\n\n\n\n\n\n\n","tags":["Kafka"]},{"title":"Mysqlé¢è¯•ç¯‡","url":"/2024/09/22/Mysqlé¢è¯•ç¯‡/","content":"## Mysqlçš„æ•°æ®ç»“æ„\n- æ•°å­—å‹ï¼šæ•´å‹ï¼ˆtinyint,smallint,int,bigintï¼‰ï¼Œæµ®ç‚¹å‹ï¼ˆfloat,doubleï¼‰ï¼Œå®šç‚¹å‹ï¼ˆdecimalï¼‰\n- å­—ç¬¦ä¸²ï¼šcharï¼Œvarcharï¼Œtinytextï¼Œtextï¼Œmediumtextï¼Œlongtextï¼Œtinyblobï¼Œblobï¼Œmediumblobï¼Œlongblob\n- æ—¥æœŸï¼šdateï¼Œtimestamp\n\n> å®šç‚¹å‹æ˜¯æŒ‡å®šå°æ•°ç‚¹åå‡ ä½çš„ã€‚charæ˜¯å®šé•¿çš„ï¼Œvarcharæ˜¯å¯å˜çš„ï¼Œä¸€èˆ¬è®¾è®¡çš„æ˜¯æœ€å¤§é•¿åº¦ã€‚å¦‚æœè¶…è¿‡é•¿åº¦charæ˜¯éœ€è¦ä¿®æ”¹è¡¨ç»“æ„çš„ã€‚è€Œä¸”ç›¸åŒå­—ç¬¦ä¸²åœ¨å­˜å‚¨å±‚é¢ä¸¤è€…æ˜¯ç›¸åŒçš„ã€‚ä½†æ˜¯varcharå†…å­˜å ç”¨ç¨é«˜ï¼ŒæŸäº›é«˜çº§æ“ä½œæ˜¯éœ€è¦éå†ã€‚\n\n## MysqlæŸ¥è¯¢æµç¨‹\n1. è¿æ¥å™¨ï¼šè¿æ¥å®¢æˆ·ç«¯çš„httpè¯·æ±‚ï¼Œæ ¡éªŒç”¨æˆ·åå¯†ç \n2. æŸ¥è¯¢ç¼“å­˜ï¼Œå¦‚æœç¼“å­˜é‡Œé¢æœ‰å°±ç›´æ¥è¿”å›ï¼ˆè¿™é‡Œåœ¨8ç‰ˆæœ¬å°±åºŸå¼ƒäº†ï¼Œå› ä¸ºå‘½ä¸­ç‡å®åœ¨å¤ªä½äº†ï¼‰\n3. è¯æ³•åˆ†æè¯­æ³•åˆ†æ\n4. æ‰§è¡Œå™¨ï¼šåŒ…æ‹¬é¢„å¤„ç†ï¼Œä¾‹å¦‚å°†*æ¢æˆè¡¨çš„å­—æ®µï¼›ä¼˜åŒ–å™¨ï¼Œé€‰æ‹©æ•ˆç‡è¾ƒé«˜çš„æ‰§è¡Œè®¡åˆ’æ‰§è¡Œï¼Œèƒ½ç”¨ç´¢å¼•å°±ä¸ç”¨å…¨è¡¨æ‰«æï¼›æ‰§è¡Œå™¨ï¼Œæ‰§è¡Œsqlç„¶åè¿”å›ç»“æœç»™å®¢æˆ·ç«¯\n\n## InnoDBå’ŒMyISAM\n1. äº‹åŠ¡\n2. è¡Œçº§é”\n3. ç´¢å¼•\n4. æ”¯æŒå¤–é”®\n5. å´©æºƒæ¢å¤redolog\n\n\n\n## InnoDBçš„å­˜å‚¨å½¢å¼\nä¼—æ‰€å‘¨çŸ¥InnoDBå­˜å‚¨æ•°æ®çš„æ•°æ®ç»“æ„æ˜¯B+æ ‘ï¼Œå…¶ä¸­æ ‘çš„èŠ‚ç‚¹å°±æ˜¯æ•°æ®é¡µã€‚\n\næ•°æ®é¡µå†…éƒ¨ï¼š\n\nä¸€ä¸ªæ•°æ®é¡µä¸Šä¼šæœ‰å¤šæ¡è®°å½•ï¼Œå¯¹åº”ç€å®é™…çš„è®°å½•ã€‚åœ¨æ•°æ®é¡µå†…éƒ¨æ˜¯æŒ‰ç…§ä¸»é”®idé¡ºåºæ’åˆ—çš„ã€‚é™¤æ­¤ä¹‹å¤–è¿˜æœ‰ä¸€ä¸ªé¡µç›®å½•ï¼Œå°†é¡ºåºæ’åˆ—çš„æŸäº›è®°å½•å½’ä¸ºä¸€ä¸ªæ§½ã€‚ä¾‹å¦‚ä¸€ä¸ªæ•°æ®é¡µæœ‰12345ï¼Œå¯èƒ½12æ˜¯ä¸€ä¸ªæ§½ï¼Œ345æ˜¯å¦ä¸€ä¸ªï¼Œæ§½åªä¿å­˜æœ€å¤§çš„é‚£ä¸ªèŠ‚ç‚¹ã€‚å½“æœç´¢çš„æ—¶å€™ï¼Œæ¯”å¦‚æˆ‘è¦æœç´¢4ï¼Œç”±äº4å¤§äº12è¿™ä¸ªé¡µçš„æœ€å¤§å€¼2ï¼Œæ‰€ä»¥ä¼šåœ¨345é‡Œé¢æœç´¢ã€‚è¿™ä¸ªæ—¶å€™éœ€è¦éå†çš„æˆæœ¬å°±ä½å¾ˆå¤šäº†ã€‚ä¸€èˆ¬æ¥è¯´æ§½åªä¼šåŒ…å«ä¸è¶…è¿‡8æ¡è®°å½•ã€‚ä½¿ç”¨äºŒåˆ†æ³•æ‰¾åˆ°è¿™ä¸ªæ§½ï¼Œç„¶ååœ¨åœ¨è¿™ä¸ªæ§½è¿›è¡Œéå†ã€‚é¡µç›®å½•åªæ˜¯ä¸ºäº†åŠ å¿«åœ¨é¡µå†…çš„æŸ¥æ‰¾é€Ÿåº¦ã€‚å®é™…ä¸Šæ¯ä¸€ä¸ªé¡µé‡Œé¢è®°å½•ä¹Ÿæ˜¯é€šè¿‡é“¾è¡¨ä¸²èµ·æ¥çš„ã€‚å¯¹å¤–åªä¼šæš´éœ²å½“å‰é¡µä¸»é”®æœ€å¤§å€¼å’Œæœ€å°å€¼ã€‚æ–¹ä¾¿b+æ ‘çš„æŸ¥æ‰¾ã€‚\n\nB+æ ‘ï¼š\n\nb+æ ‘ä¸bæ ‘çš„ä¸åŒç‚¹åœ¨äºï¼Œb+åªæœ‰åº•å±‚çœŸæ­£å­˜å‚¨æ•°æ®ï¼Œbæ ‘åœ¨éå¶å­èŠ‚ç‚¹ä¹Ÿä¼šå­˜å‚¨æ•°æ®ã€‚è€Œä¸”b+åº•å±‚æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œå¯ä»¥æ–¹ä¾¿è¿›è¡ŒèŒƒå›´æŸ¥è¯¢ã€‚å¯¹äºinnoDBè€Œè¨€ï¼Œä¸ºç´¢å¼•èŠ‚ç‚¹è¿˜æ˜¯æ•°æ®èŠ‚ç‚¹æ ¹æ®é¡µå¤´çš„æŸä¸ªå­—æ®µå†³å®šã€‚ç´¢å¼•èŠ‚ç‚¹ä¸­å­˜å‚¨ç€ä¸‹ä¸€ä¸ªè¡¨å¯¹åº”çš„æœ€å°ä¸»é”®ã€‚æˆ‘ä»¬å¯ä»¥æŠŠæŸ¥æ‰¾ä¸€æ¬¡å½“ä½œä¸€æ¬¡ioï¼Œç”±äºç´¢å¼•èŠ‚ç‚¹èƒ½å­˜å‚¨çš„æ•°æ®æ˜¯å¾ˆå¤šçš„ï¼Œåƒä¸‡çº§åˆ«çš„æ•°æ®æœ€å¤šä¹Ÿä¸è¿‡ä¸‰å››å±‚ï¼Œä¹Ÿå°±æ˜¯è¯´ioæ¬¡æ•°ä¼šå¾ˆå°ã€‚b+æ ‘çš„ç¼ºç‚¹æ˜¯ä¼šç”±äºæ·»åŠ æ•°æ®å¯¼è‡´åˆ†è£‚ï¼Œå½±å“æ€§èƒ½ã€‚\n\n> InnoDBé»˜è®¤å¾—è¦ä¸€ä¸ªç´¢å¼•ï¼Œå¯ä»¥ä¸æ˜¾å¼çš„ç»™å‡ºï¼Œä½†æ˜¯èƒŒåéšè—åˆ—ä¼šé»˜è®¤å‡ºä¸€ä¸ªç´¢å¼•ä½œä¸ºæ•°æ®é¡µçš„æ’åºå‚ç…§\n\n## ä¸ºä»€ä¹ˆç”¨B+æ ‘è€Œä¸æ˜¯Bæ ‘ï¼Œçº¢é»‘æ ‘æˆ–è€…è·³è¡¨\n- bæ ‘ï¼šç”±äºéå¶å­èŠ‚ç‚¹ä¹Ÿä¼šå­˜å‚¨æ•°æ®ï¼Œé‚£ä¹ˆå°±æ²¡æœ‰b+æ ‘å­˜å‚¨æ•°æ®å¤šã€‚æŸ¥è¯¢çš„æ•ˆç‡ä¹Ÿä¸ç¨³å®šï¼Œå¯èƒ½åœ¨éåº•å±‚å°±æŸ¥è¯¢åˆ°æ•°æ®äº†ã€‚è€Œä¸”ä¸æ˜¯åŒå‘é“¾è¡¨ï¼ŒèŒƒå›´æŸ¥è¯¢åšä¸åˆ°\n- çº¢é»‘æ ‘ï¼šä¹Ÿæ˜¯äºŒå‰æ ‘ï¼Œioæ¬¡æ•°è‚¯å®šæ¯”b+æ ‘å¤šï¼Œè·³è¡¨åŒç†\n- å“ˆå¸Œè¡¨ï¼šä¸æ”¯æŒèŒƒå›´æŸ¥è¯¢ï¼Œè¿™åŒæ ·æ˜¯redisä¸ºä»€ä¹ˆç”¨è·³è¡¨è€Œä¸æ˜¯å“ˆå¸Œè¡¨çš„ç†ç”±\n\n## ç´¢å¼•\nç´¢å¼•æ˜¯ä¸ºäº†åŠ å¿«æœç´¢è€Œå»ºç«‹çš„æ•°æ®ç»“æ„\n\n- æŒ‰ç…§æ•°æ®ç»“æ„åˆ’åˆ†ï¼šB+æ ‘ç´¢å¼•ï¼ŒHashç´¢å¼•\n- ç‰©ç†å­˜å‚¨åˆ’åˆ†ï¼šèšç°‡ç´¢å¼•ï¼ˆå¶å­èŠ‚ç‚¹æ˜¯æ•°æ®ï¼‰ï¼Œéèšç°‡ç´¢å¼•ï¼ˆå¶å­èŠ‚ç‚¹å­˜çš„æ˜¯ä¸»é”®idï¼Œåç»­è¿˜è¦å›è¡¨å»èšç°‡ç´¢å¼•æ‰¾ï¼‰\n- å­—æ®µç‰¹æ€§ï¼šä¸»é”®ç´¢å¼•ï¼Œå”¯ä¸€ç´¢å¼•ï¼ˆå»ºç«‹åœ¨å”¯ä¸€å­—æ®µä¸Šçš„ç´¢å¼•ï¼‰ï¼Œæ™®é€šç´¢å¼•ï¼Œå‰ç¼€ç´¢å¼•ï¼ˆæŸ¥ç”µè¯å·ç ï¼‰\n\n\n> å”¯ä¸€ç´¢å¼•ï¼šcreate unique index index_name on table(index_column_1)\n> \n> æ™®é€šç´¢å¼•ï¼šcreate index index_name on table(index_column_1)\n> \n> å‰ç¼€ç´¢å¼•ï¼šcreate index index_name on table(length(index_column_1))\n\n- å­—æ®µä¸ªæ•°ï¼šå•åˆ—ç´¢å¼•ï¼Œè”åˆç´¢å¼•\n\n> è”åˆç´¢å¼•ï¼šcreate index index_name on table(index_column_1,index_column_2)\n\n## è”åˆç´¢å¼•èŒƒå›´æŸ¥è¯¢\n**select * from t_table where a > 1 and b = 1**\n\nè¿™é‡Œåªä¼šç”¨åˆ°aä¸€ä¸ªç´¢å¼•ï¼Œå› ä¸ºåªæœ‰aèƒ½ç¼©å°èŒƒå›´ï¼Œbæ˜¯æ— åºçš„ï¼Œæ— æ³•ç¼©å°èŒƒå›´ã€‚å¦‚æœæ²¡æœ‰ç´¢å¼•ä¸‹æ¨åªèƒ½ä¸€ä¸ªä¸ªå›è¡¨é€šè¿‡bè¿›è¡Œç­›é€‰\n\n**select * from t_table where a >= 1 and b = 1**\n\nè¿™é‡Œä¼šç”¨åˆ°ä¸¤ä¸ªç´¢å¼•ï¼Œå› ä¸ºa=1çš„æ—¶å€™bæ˜¯æœ‰åºçš„ï¼Œbèƒ½å¤Ÿç¼©å°èŒƒå›´\n\n**select * from t_table where a between 1 and 2 and b = 1**\n\nmysqlä¸­betweenæ˜¯å·¦é—­å³é—­åŒºé—´ï¼Œæ‰€ä»¥ä¸¤ä¸ªéƒ½èƒ½ç”¨\n\n**select * from t_table where a like 'm%' and b = 1**\n\nmysqlä¸­betweenæ˜¯å·¦é—­åŒºé—´ï¼Œæ‰€ä»¥bä¹Ÿèƒ½ç”¨\n\n\n## ç´¢å¼•å¤±æ•ˆåœºæ™¯\n> ä»€ä¹ˆæ—¶å€™æ— æ³•ä½¿ç”¨ç´¢å¼•ï¼Ÿå°±æ˜¯é€šè¿‡æŸäº›æ‰‹æ®µæ‰¾ä¸åˆ°åŸå…ˆçš„é¡ºåºäº†\n- å·¦æˆ–å·¦å³æ¨¡ç³ŠåŒ¹é…ï¼šä¾‹å¦‚%likeå’Œ%like%ï¼Œç´¢å¼•åœ¨è¿™ä¸ªå­—æ®µä¸Šæ˜¯æ ¹æ®æœ€å·¦åŒ¹é…çš„ï¼Œå¦‚æœç¬¬ä¸€ä¸ªå­—ç¬¦éƒ½ä¸çŸ¥é“ï¼Œé‚£åç»­çš„å°±æ˜¯æ— åºçš„äº†\n- å¯¹ç´¢å¼•ä½¿ç”¨å‡½æ•°ï¼šä¾‹å¦‚count()æŸä¸ªç´¢å¼•ï¼Œè¿™ä¸ªæ—¶å€™ä¹Ÿæ˜¯èµ°ä¸äº†çš„ï¼Œå› ä¸ºcountä¸æ˜¯ä¸€ä¸ªç´¢å¼•\n- å¯¹ç´¢å¼•è¿›è¡Œè¡¨è¾¾å¼è®¡ç®—ï¼šåªè¦æ˜¯åœ¨ç­‰å·å·¦è¾¹çš„ä¹Ÿç”¨ä¸äº†ï¼Œmysqlæ²¡åšè¿™éƒ¨åˆ†ä¼˜åŒ–\n- å¯¹ç´¢å¼•éšå¼ç±»å‹è½¬æ¢ï¼šåœ¨mysqlä¸­å­—ç¬¦ä¸²ä¼šè‡ªåŠ¨å˜æˆæ•°å­—è¿›è¡Œæ¯”è¾ƒï¼Œç´¢å¼•å½“ç´¢å¼•ä¸ºå­—ç¬¦ä¸²ï¼Œè€ŒæŸ¥è¯¢çš„æ—¶å€™ç”¨id=1æ¥æ¯”è¾ƒï¼Œä¼šè‡ªåŠ¨ç±»å‹è½¬æ¢ï¼Œç›¸å½“äºç´¢å¼•ä½¿ç”¨äº†éšå¼å‡½æ•°å˜æˆæ•°å­—äºæŸ¥è¯¢æ¡ä»¶è¿›è¡Œæ¯”è¾ƒ\n- è”åˆç´¢å¼•éæœ€å·¦åŒ¹é…ï¼šè”åˆç´¢å¼•ï¼ˆa,b,cï¼‰å¦‚æœæŸ¥è¯¢æ¡ä»¶åªæœ‰bï¼Œcï¼Œå°±ä¸ä¼šèµ°ç´¢å¼•ã€‚ä½†æ˜¯å¦‚æœæ˜¯acè¿˜æ˜¯å¯ä»¥èµ°açš„ç´¢å¼•ï¼Œå¦‚æœæœ‰ç´¢å¼•ä¸‹æ¨çš„è¯åœ¨äºŒçº§ç´¢å¼•å¯ä»¥é€šè¿‡åˆ¤æ–­cå‡å°‘å›è¡¨æ¬¡æ•°ï¼›å¦‚æœæ²¡æœ‰å°±åªèƒ½ç”¨aå‡å°‘åˆ¤æ–­ï¼Œæœ€åå›åˆ°serverä¹Ÿå°±æ˜¯ç´¢å¼•æ˜¯idçš„é‚£ä¸ªè¡¨ä¸­ä¸€ä¸ªä¸ªåˆ¤æ–­cï¼Œè¿™æ ·ä¼šæœ‰å¾ˆå¤šå›è¡¨\n- whereå­å¥ä¸­çš„orï¼šå¦‚æœåªæœ‰ä¸€ä¸ªæ¡ä»¶æ˜¯æœ‰ç´¢å¼•ï¼Œé‚£å°±ä¼šå¤±æ•ˆï¼Œå› ä¸ºåœ¨oræ¡ä»¶ä¸‹åªç”¨æ»¡è¶³ä¸€ä¸ªå°±å¯ä»¥äº†\n\n## Mysqläº‹åŠ¡\né¦–å…ˆæ˜¯äº‹åŠ¡çš„ACIDå››ä¸ªç‰¹æ€§ï¼š\n- åŸå­æ€§ï¼šäº‹åŠ¡å†…çš„ä¸œè¥¿æ˜¯åŒæ—¶å®Œæˆæˆ–è€…åŒæ—¶å–æ¶ˆçš„ã€‚innodbçš„äº‹åŠ¡å¯ä»¥åšåˆ°ï¼Œredisçš„äº‹åŠ¡å°±æ²¡æœ‰åŸå­æ€§ã€‚\n- ä¸€è‡´æ€§ï¼šäº‹åŠ¡å®Œæˆå‰åï¼Œç”±ä¸€ä¸ªä¸€è‡´çš„çŠ¶æ€è½¬ç§»åˆ°å¦ä¸€ä¸ªä¸€è‡´çš„çŠ¶æ€ã€‚ä¾‹å¦‚é“¶è¡Œè½¬è´¦ä¸¤ä¸ªè´¦æˆ·600+800ï¼Œè½¬è´¦åæ€»æ•°æ˜¯ä¸èƒ½å˜çš„\n- éš”ç¦»æ€§ï¼šå¹¶å‘å¯¼è‡´çš„äº‹åŠ¡ä¹‹é—´åº”è¯¥éš”ç¦»ï¼Œä¸€ä¸ªäººè´­ä¹°å•†å“çš„äº‹åŠ¡ä¸åº”è¯¥å½±å“å¦ä¸€ä¸ªäººçš„è´­ä¹°\n- æŒä¹…æ€§ï¼šæŒä¹…åŒ–ä¸‹æ¥ï¼Œæ‰ç”µä¹Ÿä¸ä¼šä¸¢å¤±\n\n\nInnoDBçš„æŒä¹…æ€§æ˜¯é€šè¿‡redologå®Œæˆçš„ï¼ŒåŸå­æ€§æ˜¯undologï¼Œéš”ç¦»æ€§æ˜¯MVCCå®Œæˆçš„ï¼Œä¸€è‡´æ€§æ˜¯ä¸Šé¢ä¸‰è€…éƒ½å®Œæˆåå°±ä¼šä¿è¯ä¸€è‡´æ€§ã€‚\n\n## äº‹åŠ¡éš”ç¦»çº§åˆ«\n- è„è¯»ï¼šä¸€ä¸ªäº‹åŠ¡è¿˜æ²¡æœ‰æäº¤ï¼Œåˆ«çš„äº‹åŠ¡å°±èƒ½çœ‹åˆ°å®ƒçš„ä¿®æ”¹äº†ã€‚ä¾‹å¦‚äº‹åŠ¡1ä¿®æ”¹äº†ä½™é¢ï¼Œäº‹åŠ¡2è¯»å–äº†è¿™éƒ¨åˆ†ï¼Œä½†æ˜¯äº‹åŠ¡1è§¦å‘å›æ»šï¼Œè¿™å°±å¯¼è‡´äº‹åŠ¡2è¯»åˆ°äº†è„æ•°æ®ã€‚\n- ä¸å¯é‡å¤è¯»ï¼šåœ¨ä¸€ä¸ªäº‹åŠ¡å†…è¯»å–ä¸¤æ¬¡æ•°æ®ï¼Œä¸¤æ¬¡æ•°æ®è¯»å–çš„ä¸ä¸€æ ·ã€‚è¿™é€šå¸¸æ˜¯ç”±äºå¦ä¸€ä¸ªäº‹åŠ¡çš„æäº¤ï¼Œè¿™ä¸ªæ•°æ®å¯¹äºå…¶ä»–äº‹åŠ¡éƒ½æ˜¯å¯è§çš„ï¼ˆæœ‰ç‚¹åƒvolatileï¼‰\n- å¹»è¯»ï¼š æŸ¥è¯¢æ•°é‡ï¼Œäº‹åŠ¡å†…å‰åæŸ¥è¯¢ä¸¤æ¬¡ä¸ä¸€è‡´ï¼Œåƒå‘ç”Ÿäº†å¹»è§‰\n\näº‹åŠ¡éš”ç¦»çº§åˆ«ï¼š\n- è¯»æœªæäº¤ï¼š\n- è¯»æäº¤ï¼šè§£å†³è„è¯»\n- å¯é‡å¤è¯»ï¼šè§£å†³è„è¯»+ä¸å¯é‡å¤è¯»\n- ä¸²è¡ŒåŒ–ï¼šè§£å†³å¹»è¯»+ä¸å¯é‡å¤è¯»+å¹»è¯»\n\n## MVCCï¼ˆå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼‰\nåœ¨å‰é¢è®²çš„è®°å½•ä¸­æœ‰ä¸¤ä¸ªéšè—å­—æ®µï¼šæ·»åŠ è¯¥æ¡è®°å½•çš„äº‹åŠ¡idå’ŒæŒ‡å‘ä¸Šä¸€ä¸ªç‰ˆæœ¬undologæŒ‡é’ˆã€‚MVCCæ˜¯ä¾é è¿™ä¸¤ä¸ªå­—æ®µå®Œæˆçš„ï¼Œæ›´æ–°æ•°æ®æ—¶ä¼šåœ¨æ•°æ®é¡µä¸­æ›¿æ¢æ–°çš„è®°å½•ï¼Œç„¶åå°†æ—§çš„è®°å½•ä½œä¸ºæŒ‡é’ˆä¿å­˜ä¸‹æ¥ï¼Œè¿™æ—¶æ‰€æœ‰çš„ç‰ˆæœ¬éƒ½è¿æˆä¸€æ¡é“¾ï¼ŒåŒ…å«äº†å½“æ—¶è¿›è¡Œæ›´æ–°çš„äº‹åŠ¡idã€‚\n\nMVCCæä¾›äº†ReadViewè¿™ä¸ªæ•°æ®ç»“æ„ï¼Œç”±äºäº‹åŠ¡idæ˜¯é¡ºåºé€’å¢çš„ï¼ŒReadViewå°†äº‹åŠ¡idåˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼Œå·²ç»æäº¤çš„äº‹åŠ¡ï¼Œæ­£åœ¨è¿›è¡Œçš„äº‹åŠ¡å’Œæ²¡æœ‰å‘ç”Ÿçš„äº‹åŠ¡ã€‚å·²ç»æäº¤çš„äº‹åŠ¡æ˜¯æœ‰è®¿é—®æƒçš„ï¼Œæ­£åœ¨è¿è¡Œçš„äº‹åŠ¡æ˜¯ä¸å…è®¸æŸ¥çœ‹çš„ï¼Œæ­¤æ—¶å¦‚æœå‘ç”Ÿå¹¶å‘ç°è±¡ï¼ŒæŸ¥è¯¢æ•°æ®çš„æ—¶å€™ä¼šæ ¹æ®è¿™ä¸‰ä¸ªèŒƒå›´å’Œå½“å‰å…¨éƒ¨çš„äº‹åŠ¡idè¿›è¡Œè¿‡æ»¤ï¼Œè¿™æ ·å°±èƒ½é¿å…è¯»åˆ°è¿˜æ²¡æœ‰æäº¤äº‹åŠ¡çš„æ•°æ®ã€‚ä»è€Œè§£å†³äº†è„è¯»é—®é¢˜\n\n**MVCCæ˜¯å¦‚ä½•è§£å†³ä¸å¯é‡å¤è¯»çš„**\n\nä¸»è¦æ˜¯ReadViewç”Ÿæˆçš„æ—¶æœºé—®é¢˜ï¼Œå¦‚æœæ¯ä¸€æ¬¡å¿«ç…§è¯»éƒ½ç”Ÿæˆä¸€ä¸ªReadViewï¼Œæœ‰å¯èƒ½åœ¨ä¸¤æ¬¡å¿«ç…§è¯»æœŸé—´æœ‰åˆ«çš„äº‹åŠ¡æäº¤äº†ï¼Œè¿™ä¸¤æ¬¡çš„ReadViewèŒƒå›´å°±ä¼šä¸ä¸€æ ·ï¼Œè¿˜æ˜¯ä¼šå‘ç”Ÿä¸å¯é‡å¤è¯»ã€‚ä½†æ˜¯å¦‚æœåœ¨äº‹åŠ¡åˆšå¼€å§‹çš„æ—¶å€™å°±ç”ŸæˆReadViewï¼Œå°±èƒ½ä¿è¯æ‰§è¡Œä¸‹æ¥çš„å¯è§æ€§ï¼Œå³ä½¿åœ¨ç¬¬äºŒæ¬¡è¯»ä¹‹å‰ï¼Œåœ¨readviewä¸­çš„é‚£ä¸ªäº‹åŠ¡æäº¤äº†ï¼Œè¿˜èƒ½ä¿è¯æ¥ä¸‹æ¥çš„è¯»æ“ä½œä¸å¯è§è¿™ä¸ªæ•°æ®ã€‚\n\n**MVCCè§£å†³äº†å¹»è¯»å—**\n\nåœ¨é»˜è®¤éš”ç¦»çº§åˆ«ä¸‹çš„innoDBå¾ˆå¤§ç¨‹åº¦èƒ½å¤Ÿé¿å…å¹»è¯»ï¼ŒèŒƒå›´æŸ¥è¯¢ä¹Ÿéœ€è¦çœ‹ç‰ˆæœ¬å·ã€‚åœ¨æŸäº›æƒ…å†µä¸‹è¿˜æ˜¯èƒ½å‡ºç°å¹»è¯»ï¼Œä¾‹å¦‚å½“å‰æ²¡æœ‰s=5çš„æ•°æ®ï¼Œæ­¤æ—¶è¿›è¡ŒæŸ¥è¯¢æ˜¯æ²¡æœ‰çš„ï¼Œå¦ä¸€ä¸ªäº‹åŠ¡æ·»åŠ äº†è¿™æ¡æ•°æ®ï¼Œæ­¤æ—¶äº‹åŠ¡idåœ¨readviewé‡Œé¢ï¼Œæ˜¯ä¸å…è®¸è®¿é—®çš„ã€‚ä½†æ˜¯åŸæ¥äº‹åŠ¡åˆæ›´æ–°äº†è¿™æ¡æ•°æ®ï¼Œç°åœ¨äº‹åŠ¡idæ˜¯è‡ªå·±çš„äº†ã€‚ä¸‹æ¬¡æŸ¥è¯¢çš„æ—¶å€™å°±ä¼šæŸ¥è¯¢å‡ºæ¥ã€‚ï¼ˆè™½ç„¶æ›´æ–°ä¸€æ¡ä¸å­˜åœ¨çš„æ•°æ®é€»è¾‘ä¸Šå¾ˆè¯¡å¼‚ï¼‰\n\néœ€è¦é€šè¿‡é—´éš™é”æ‰èƒ½è§£å†³å¹»è¯»ï¼Œä¹Ÿå°±æ˜¯é”ä½ä¸€æ®µèŒƒå›´å†…çš„ï¼Œå…¶ä»–äº‹åŠ¡æ·»åŠ è¿™æ®µèŒƒå›´å†…çš„æ•°æ®å°±ä¼šè¢«é˜»å¡ã€‚\n\n## redolog\nå‰é¢æ‰€è®²çš„æ•°æ®åº“äº‹åŠ¡çš„ACIDä¸­ï¼ŒæŒä¹…æ€§å°±æ˜¯ç”±redologä¿è¯çš„ã€‚mysqlåœ¨æ›´æ–°çš„æ—¶å€™å…ˆå†™redologï¼Œç„¶åå†åœ¨åˆé€‚çš„å®é™…å°†redologçœŸæ­£å†™åœ¨æ•°æ®é¡µä¸Šã€‚é¦–å…ˆè¯»å–æ“ä½œçš„æ—¶å€™ä¸ä¼šæ¯æ¬¡éƒ½ä»ç£ç›˜ioï¼Œä¼šç¼“å­˜åœ¨buffer poolä¸­ï¼Œé‚£ä¹ˆå†™æ“ä½œä¹Ÿä¼šåœ¨buffer poolä¸­æ“ä½œï¼Œæ­¤æ—¶å°±å˜æˆäº†ä¸€ä¸ªè„é¡µã€‚redologçš„å·¦å³å°±æ˜¯æŠŠè¿™ä¸ªè„é¡µçš„æ“ä½œè®°å½•å¹¶æŒä¹…åŒ–ä¸‹æ¥ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯æ¯”åˆ·æ•°æ®é¡µè¦å¿«çš„ï¼Œå¾ˆå¤šæ—¶å€™æŸ¥è¯¢çš„å¹¶ä¸æ˜¯é¡ºåºè¯»ï¼Œæœ‰å¯èƒ½åœ¨å¾ˆå¤šæ•°æ®é¡µä¸Šã€‚\n\n**åˆ·ç›˜æ—¶æœº:**\n\nredologä¹Ÿæ˜¯æœ‰ç¼“å†²åŒºçš„ï¼ŒæŠŠbuffer poolä¸­çš„ä¿®æ”¹ä¿å­˜åœ¨redologç¼“å­˜åŒºä¸­ï¼Œç„¶åå†åœ¨åˆé€‚çš„æ—¶æœºåˆ·ç›˜ï¼Œä¸€èˆ¬æœ‰ä»¥ä¸‹å‡ ä¸ªæ—¶æœºï¼š\n- mysqlæ­£å¸¸å…³é—­\n- åå°çº¿ç¨‹ä¼šæ¯éš”1såˆ·ç›˜\n- å½“ç¼“å†²åŒºæ»¡äº†ä¸€åŠå°±è§¦å‘\n- æ ¹æ®åˆ·ç›˜ç­–ç•¥\n\nåˆ·ç›˜ç­–ç•¥æœ‰ä»¥ä¸‹ä¸‰ç§ï¼š\n- æ¯æ¬¡äº‹åŠ¡æäº¤åªå†™åœ¨ç¼“å†²åŒºä¸­ï¼Œä½†æ˜¯å¦‚æœåœ¨1så†…æ‰ç”µï¼Œredolog bufferå°±ä¼šæ²¡æœ‰äº†ï¼Œè¿™ç§ç­–ç•¥å¯èƒ½ä¼šæ‰æœ€å¤š1sçš„æ•°æ®\n- æ¯æ¬¡äº‹åŠ¡æäº¤ç›´æ¥å†™ç£ç›˜ï¼Œæ•ˆç‡è¾ƒä½ï¼Œä½†æ˜¯å®‰å…¨\n- æ¯æ¬¡äº‹åŠ¡æäº¤ç»™æ“ä½œç³»ç»Ÿçš„page cacheï¼Œäº¤ç»™æ“ä½œç³»ç»Ÿå†™ã€‚è¿™ç§æƒ…å†µå¦‚æœmysqlåœæœºäº†è¿˜æ˜¯èƒ½å†™ï¼Œå› ä¸ºæ“ä½œç³»ç»Ÿæ²¡æœ‰åœæ­¢ï¼Œä½†æ˜¯å¦‚æœæ‰ç‚¹äº†è¿˜æ˜¯ä¼šä¸¢1sçš„æ•°æ®ï¼Œç®—æ˜¯ä¸Šé¢ä¸¤ç§çš„ä¸€ä¸ªæŠ˜ä¸­ã€‚\n\n<div style=\"text-align: center;\">\n  <img src=\"../img/Mysql/img_16.png\" alt=\"\" />\n</div>\n\n**æ—¥å¿—æ–‡ä»¶ç»„ï¼š**\n\nredologä¸æ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œè€Œæ˜¯å¤šä¸ªæ–‡ä»¶ï¼Œè¿™äº›æ–‡ä»¶æŒ‰ç…§ç¯å½¢å­˜å‚¨ï¼Œä¼šè¦†ç›–ã€‚å¤´æŒ‡é’ˆæ˜¯checkpointï¼Œå°¾æŒ‡é’ˆæ˜¯write posã€‚æ¯æ¬¡æœ‰ç¼“å†²åŒºæ¥çš„æ•°æ®å°±ç§»åŠ¨posã€‚å¦‚æœmysqlè¿›è¡Œäº†redologåˆ°æ•°æ®å—çš„æŒä¹…åŒ–ï¼Œcheckpointå°±å¾€åç§»åŠ¨ã€‚\n\nå¦‚æœè¿™ä¸ªç¯å½¢æ–‡ä»¶æ»¡äº†ï¼Œå°±éœ€è¦é˜»å¡mysqlï¼Œè¿›è¡Œéƒ¨åˆ†redologåˆ°æ•°æ®é¡µçš„æ“ä½œã€‚\n\n**æ€»ç»“ï¼š**\n\nredologä¿è¯äº†mysqlçš„æŒä¹…æ€§ï¼Œè¿™ç§æ“ä½œæ¯”ç›´æ¥ä¿®æ”¹æ•°æ®é¡µè¦é«˜æ•ˆï¼Œç”±äºç›´æ¥ä¿®æ”¹æ•°æ®é¡µå¯èƒ½ä¼šå­˜åœ¨éšæœºå†™çš„æƒ…å†µï¼Œè€Œredologæ˜¯è¿½åŠ å†™ï¼Œå°±å¥½åƒæ¯æ¬¡æ‰¾ä¸œè¥¿éšæœºå†™å°±æ˜¯çœ‹ç›®å½•æ‰¾ä¹¦é¡µï¼Œè€Œè¿½åŠ å°±æ˜¯å¾€åç¿»ä¸€é¡µã€‚\n\nç„¶è€Œredologåœ¨æŸäº›ç­–ç•¥ä¸‹ä¹Ÿä¸æ˜¯ä¸‡æ— ä¸€å¤±çš„ï¼Œå› ä¸ºredologä¹Ÿæ˜¯æœ‰ç¼“å­˜çš„ï¼Œå¦‚æœæ²¡æœ‰åŠæ—¶å†™åœ¨ç£ç›˜é‡Œå°±ä¼šä¸¢å¤±1sçš„æ•°æ®ã€‚\n\n> ç”±æ­¤å¯è§redologå’ŒçœŸæ­£å­˜åœ¨æ•°æ®é¡µä¸­è¿˜æœ‰ä¸€æ®µæ—¶é—´å·®ï¼Œé‚£è¿™ä¸ªæ—¶å€™æ¥äº†ä¸€ä¸ªè¯»è¯·æ±‚ï¼Œæ€ä¹ˆä¿è¯ä¸€è‡´æ€§ï¼Ÿ\n> ä¼šåœ¨buffer poolæ‰¾ï¼Œè€Œä¸æ˜¯ç›´æ¥å»ç£ç›˜æ‰¾ï¼Œæœ¬æ¥redologå°±æ˜¯ä¸ºäº†å­˜buffer poolçš„è„é¡µçš„ï¼Œæ˜¯å†…å­˜åŒæ­¥åˆ°å¤–å­˜ï¼Œ\n\n## binlog\nbinlogæ˜¯è§£å†³ä¸»ä»åŒæ­¥çš„ä¸€ç§æ—¥å¿—å½¢å¼ï¼Œåªè®°å½•å†™æ“ä½œï¼Œselectå’Œshowæ˜¯ä¸è®°å½•çš„ã€‚æœ‰ä¸‰ç§æ ¼å¼å½¢å¼ï¼š\n- statementï¼šåªè®°å½•æ›´æ–°çš„è¯­å¥ï¼Œä¸ç®¡å‰åçŠ¶æ€ï¼Œä¸€èˆ¬å­˜å‚¨çš„æ•°æ®é‡è¾ƒå°\n- rowï¼šä¸å…‰è®°å½•æ›´æ–°çš„å…·ä½“è¯­å¥ï¼Œæ›´æ–°å‰åçš„çŠ¶æ€ä¹Ÿä¿å­˜ï¼Œä¸€èˆ¬ç”¨åœ¨éœ€è¦è®¡ç®—çš„sqlè¯­å¥ï¼Œä¾‹å¦‚now()ï¼Œç”¨ç¬¬ä¸€ç§æ–¹å¼å°±ä¼šé€ æˆæ•°æ®ä¸ä¸€è‡´ï¼Œç¬¬äºŒç§ä¼šä¿å­˜åœ¨ä¸»æœºä¸Šé¢çš„ç»“æœã€‚å½“ç„¶å­˜å‚¨çš„æ•°æ®é‡ä¼šæ›´å¤§\n- mixï¼šæ ¹æ®å…·ä½“sqlçš„å½¢å¼é€‰å–ç­–ç•¥ï¼Œä¾‹å¦‚æ­£å¸¸sqlå°±ç”¨statementï¼Œæ¶‰åŠåˆ°è®¡ç®—çš„å°±ç”¨row\n\n**åˆ·ç›˜æ–¹å¼ï¼š**\n\nä¸redologç±»ä¼¼ï¼Œä¹Ÿæœ‰ä¸€ä¸ªç¼“å†²åŒºï¼Œä½†æ˜¯binlogçš„ç¼“å†²åŒºçº¿ç¨‹ä¹‹é—´æ˜¯ç‹¬ç«‹çš„ï¼Œæœ€ç»ˆéƒ½è¦å†™è¿›ç£ç›˜ã€‚\n- 0ï¼šä¸åŒçº¿ç¨‹çš„binlog bufferå†™åˆ°page cacheé‡Œé¢ï¼Œç”±æ“ä½œç³»ç»Ÿå†™å›\n- 1ï¼šç›´æ¥å†™åˆ°ç£ç›˜\n- nï¼šnä¸ªçº¿ç¨‹çš„binlog bufferå†™åˆ°page cacheåè§¦å‘ä¸€æ¬¡å†™åˆ°ç£ç›˜ã€‚æ‰ç”µå°±ä¸¢å¤±nä¸ªçº¿ç¨‹çš„æ•°æ®\n\n## binlogå°±å¤Ÿäº†ä¸ºä»€ä¹ˆè¿˜éœ€è¦redolog\nbinlogä¸»è¦è´Ÿè´£ä¸»ä»åŒæ­¥ï¼Œredologè´Ÿè´£æ¢å¤æ•°æ®åº“ã€‚ä¸€ä¸ªæ˜¯å¤–éƒ¨æœºåˆ¶ï¼Œä¸€ä¸ªæ˜¯å†…éƒ¨æœºåˆ¶ï¼Œä¸¤è€…ç‹¬ç«‹ä½†æ˜¯äº’è¡¥ï¼ŒæœåŠ¡äºä¸åŒçš„éœ€æ±‚ã€‚\n\n## ä¸¤é˜¶æ®µæäº¤\nå¦‚æœåœ¨binlogå’Œredologä¹‹é—´å‡ºç°é—®é¢˜å°±ä¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´ã€‚æ‰€ä»¥éœ€è¦ä¸¤é˜¶æ®µæäº¤\n\n<div style=\"text-align: center;\">\n  <img src=\"../img/Mysql/img_17.png\" alt=\"\" />\n</div>\n\nå†™redoçš„æ—¶å€™è®¾ç½®ä¸ºprepareï¼Œç­‰åˆ°binlogå†™å®Œäº†æ‰è®¾ç½®ä¸ºcommitçŠ¶æ€ã€‚mysqlè®¤ä¸ºbinlogå†™å®Œäº†å°±æ˜¯ä¸€ä¸ªäº‹åŠ¡ç»“æŸï¼Œå³ä¾¿æ²¡æœ‰å†è®¾ç½®redologçš„çŠ¶æ€ã€‚\n\nä¾‹å¦‚åœ¨å†™å®Œredologæ—¶å®•æœºï¼Œbinlogæ²¡æœ‰å†™ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¼šè§¦å‘å›æ»šï¼›ä½†æ˜¯å†™å®Œäº†binlogå®•æœºäº†ï¼Œredologæ²¡æœ‰è¢«æ”¹å˜ä¸ºcommitï¼Œè¿˜æ˜¯ä¼šè¢«è®¤ä¸ºäº‹åŠ¡æäº¤äº†\n\n**å­˜åœ¨ä»€ä¹ˆé—®é¢˜ï¼š**\n- å¤šçº¿ç¨‹ä¸‹éœ€è¦åŸå­æ€§\n- å¦‚æœæ˜¯â€œåŒ1é…ç½®â€ï¼Œä¸€ä¸ªäº‹åŠ¡ioä¸¤æ¬¡\n\n## Mysqlçš„é”\n1. æ•°æ®åº“é”ï¼šåªæœ‰åœ¨è¿›è¡Œæ•°æ®åº“å¤‡ä»½æˆ–è€…è¿ç§»çš„æ—¶å€™æ‰ä¼šç”¨\n2. è¡¨çº§é”ï¼šè¡¨çº§è¯»é”å†™é”ï¼Œè¯»å†™æ„å‘é”ï¼Œè‡ªå¢é”ï¼Œå…ƒæ•°æ®é”\n\n|    | X   | IX  | S   | IS  |\n|----|-----|-----|-----|-----|\n| X  | ä¸å…¼å®¹ | ä¸å…¼å®¹ | ä¸å…¼å®¹ | ä¸å…¼å®¹ |\n| IX | ä¸å…¼å®¹ | å…¼å®¹  | ä¸å…¼å®¹ | å…¼å®¹  |\n| S  | ä¸å…¼å®¹ | ä¸å…¼å®¹ | å…¼å®¹  | å…¼å®¹  |\n| IS | ä¸å…¼å®¹ | å…¼å®¹  | å…¼å®¹  | å…¼å®¹  |\n> è§£é‡Šä¸€ä¸‹ï¼šIXè¡¨ç¤ºè¡¨å†…å·²ç»æœ‰è¡Œåœ¨è¿›è¡ŒXæ“ä½œäº†ï¼Œæ­¤æ—¶ä¸å…è®¸å…¨å±€ä¸Šé”ï¼Œæ‰€ä»¥å…¨å±€Xå’ŒSéƒ½ä¸å…è®¸ï¼›å…¨å±€Xçš„æ¡ä»¶æ˜¯é‡Œé¢æ²¡æœ‰ä»»ä½•ä¸€ä¸ªåœ¨è¿›è¡Œè¯»å†™æ“ä½œï¼Œæ‰€ä»¥ä¸æ‰€æœ‰éƒ½ä¸å…¼å®¹ï¼›ISå’ŒIXèƒ½å…¼å®¹æ˜¯å› ä¸ºéƒ½åªæ˜¯ä½œä¸ºæŒ‡ç¤ºä½œç”¨ï¼ŒISå’ŒIXå¯èƒ½é”ä½çš„åˆ—ä¸ä¸€æ ·ï¼Œä»–ä»¬çš„å­˜åœ¨åªèƒ½å½±å“å…¨å±€é”ã€‚\n3. è¡Œçº§é”ï¼šè®°å½•é”ï¼ˆé”ä½id=1è¿™æ¡è®°å½•ï¼‰ï¼Œé—´éš”é”ï¼ˆé”ä½ï¼ˆ2ï¼Œ5ï¼‰åŒºé—´çš„ï¼‰ï¼Œä¸´é”®é”ï¼ˆé”ä½ï¼ˆ2,5]ï¼‰\n\n## Mysqlä»€ä¹ˆæ—¶å€™ä¸Šé”\næ‰§è¡Œselect for updateæˆ–è€…updateçš„æ—¶å€™ï¼Œåœ¨äº‹åŠ¡æ‰§è¡ŒèŒƒå›´å†…ä¼šä¸Šä¸€ä¸ªå¯¹å½“å‰äº‹åŠ¡æœ‰æ•ˆçš„é”ï¼Œä¸€èˆ¬é”çš„å•ä½æ˜¯**ä¸´é”®é”**ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ä¼šé€€åŒ–æˆè®°å½•é”æˆ–è€…é—´éš”é”ã€‚è¿™ä¸€éƒ¨åˆ†çš„æå‡ºæ­£æ˜¯ä¸ºäº†è§£å†³ã€‚\n\n**å”¯ä¸€ç´¢å¼•ç­‰å€¼æŸ¥è¯¢**\n\n1. select * from user where id = 1 for update;å¦‚æœæœ‰id=1è¿™æ¡è®°å½•ï¼Œä¸´é”®é”å°±ä¼šé€€åŒ–ä¸ºè®°å½•é”ï¼Œåªé”ä½å½“å‰è¿™ä¸ªid=1ï¼Œå› ä¸ºè¿™æ ·å°±ä¸ä¼šæœ‰åˆ«çš„äº‹åŠ¡æ¥è¿›è¡Œæ›´æ”¹é¿å…ä¸å¯é‡å¤è¯»\n2. select * from user where id = 1 for updateï¼›å¦‚æœæ²¡æœ‰id=1è¿™æ¡è®°å½•ï¼Œå°±ä¼šé€€åŒ–ä¸ºé—´éš”é”ï¼Œæ‰¾åˆ°æœ€è¿‘çš„ä¸¤ä¸ªåŒºé—´ä¾‹å¦‚ï¼ˆ0ï¼Œ3ï¼‰é”ä½è¿™æ®µï¼Œä¸å…è®¸æ·»åŠ æ•°æ®é¿å…å¹»è¯»\n\n**å”¯ä¸€ç´¢å¼•èŒƒå›´æŸ¥è¯¢**\n\n1. select * from user where id > 15 for update;å¦‚æœæœ‰id=20çš„è®°å½•ï¼Œé‚£å°±ä¼šåŠ é”(15,20]ï¼Œ(20,INf]\n2. select * from user where id >= 15 for update;å¦‚æœæœ‰id=15ï¼ŒåŠ é”15ï¼Œ(15,20]ï¼Œ(20,INf]\n3. select * from user where id < 6 for update;å¦‚æœæœ‰id=1,5,10çš„è®°å½•ï¼ŒåŠ é”(-INF,1],(1,5],(5,10)\n4. select * from user where id <= 5 for update;(-INF,1],(1,5]\n\n**éå”¯ä¸€ç´¢å¼•ç­‰å€¼æŸ¥æ‰¾**\n\nåªç”¨è®°ä½ä¸€ç‚¹ï¼Œéå”¯ä¸€ç´¢å¼•æ˜¯æŒ‰ç…§å¤§å°æ’åºçš„ï¼Œç´¢å¼•å€¼ç›¸åŒå†æŒ‰ç…§idå‡åºæ’åºã€‚{(15,14),(25,20)}ï¼Œé”ä½éå”¯ä¸€ç´¢å¼•ï¼ˆ15ï¼Œ25ï¼‰ï¼Œå¦‚æœæ–°å¢çš„å€¼åœ¨å…¶ä¸­å°±ä¸å…è®¸æ’å…¥ï¼Œå¦‚æœ=15ä¸”id>14ä¹Ÿæ˜¯ä¸å…è®¸çš„ï¼Œå³è¾¹åŒç†ã€‚\n\n\n## Mysqlæ­»é”\n\n<div style=\"text-align: center;\">\n  <img src=\"../img/Mysql/img_18.png\" alt=\"\" />\n</div>\n\nç”±äºé—´éš™é”æ˜¯å¯ä»¥é‡å¤çš„ï¼Œä¸¤è¾¹éƒ½é”ä½äº†ä¸å…è®¸æ·»åŠ ã€‚\n\n## æ…¢sql\n**äº§ç”Ÿæ…¢sqlçš„åŸå› **\n\n1. ç´¢å¼•æœªç”Ÿæ•ˆæˆ–è€…æ ¹æœ¬æ²¡æœ‰ç´¢å¼•ï¼Œå¯¼è‡´å…¨è¡¨æ‰«æ\n2. æ•°æ®é‡å¤ªå¤§äº†ï¼ŒåŠ ç´¢å¼•éƒ½ä¸è¡Œã€‚è¿™ä¸ªæ—¶å€™å°±è¦è€ƒè™‘åˆ†åº“åˆ†è¡¨äº†\n3. sqlä¹¦å†™ä¸å½“ï¼Œè¿‡å¤šçš„joinæ“ä½œæˆ–è€…å­æŸ¥è¯¢è¿‡å¤šï¼Œå­æŸ¥è¯¢ä¼šäº§ç”Ÿä¸€å¼ æ–°è¡¨ï¼›æˆ–è€…æ˜¯æ·±åº¦åˆ†é¡µï¼›ç”¨äº†æ¯”è¾ƒé•¿çš„æ’åº\n4. æ•°æ®é‡æ¯”è¾ƒå¤§çš„æ—¶å€™ï¼Œredologæ»¡äº†ï¼Œåœ¨æ›´æ–°checkpointçš„æ—¶å€™ä¼šé˜»å¡\n5. ç­‰å¾…è¡Œçº§é”\n\n**å¦‚ä½•å‘ç°æ…¢sql**\n\n1. mysqlè‡ªå·±å¯ä»¥å¼€å¯æ…¢sqlæŸ¥è¯¢æ—¥å¿—ï¼Œå°†æŸ¥è¯¢æ—¶é—´å¤§äº1sçš„è®°å½•ä¸‹æ¥\n2. é¢„é˜²æ…¢sqlï¼Œåšå…¨å±€sqlæ‰«æã€‚é˜¿é‡Œçš„[è¿™ç¯‡æ–‡ç« ](https://mp.weixin.qq.com/s/LZRSQJufGRpRw6u4h_Uyww)æåˆ°äº†å¯ä»¥ä½¿ç”¨JVMçš„æ²™ç®±æ¨¡å‹ã€‚ç›¸å½“äºä¸€ä¸ªå¤§çš„aopæ¨¡å‹ï¼ˆå€¼å¾—ä¸€æçš„æ˜¯gclibä¹Ÿæ˜¯è·Ÿè¿™ä¸ªåŸç†ç±»ä¼¼ï¼‰ï¼Œé€šè¿‡åœ¨å®ä¾‹å‰åè¿›è¡Œç›‘å¬å°±å¯ä»¥æ— ä¾µå…¥å¼åœ°å½•åˆ¶HTTP/Java/Dubboå…¥å‚/è¿”å›å€¼ï¼Œä¸šåŠ¡ç³»ç»Ÿæ— æ„ŸçŸ¥ã€‚åŸºäºè¿™ä¸ªèƒ½åŠ›ï¼Œæˆ‘ä»¬å¯ä»¥æ–¹ä¾¿çš„é‡‡é›†å’ŒSQLæ‰§è¡Œç›¸å…³çš„Javaæ–¹æ³•å‚æ•°ä»¥åŠè¿”å›å€¼ã€‚é€šè¿‡é…ç½®é‡‡é›†ç‚¹ï¼Œæ¥é‡‡é›†æ‰§è¡Œsqlçš„javaä»£ç çš„ç›¸å…³æ–¹æ³•ã€å‚æ•°å’Œè¿”å›å€¼ï¼Œè¾…åŠ©å®ç°sqlé‡‡é›†åŠŸèƒ½ã€‚\n\n**å¦‚ä½•è¯†åˆ«é«˜å±sql**\n\n- ä¸ç¬¦åˆè§„èŒƒçš„sqlï¼šä¸å…è®¸ä½¿ç”¨å¤–é”®ï¼Œæ·±åº¦åˆ†é¡µä¼˜åŒ–ï¼Œå­æŸ¥æ‰¾è¿‡å¤šï¼Œæœ‰*\n- ç”¨explainè§‚å¯Ÿï¼Œrowå­—æ®µè¿‡å¤šéœ€è¦ä¼˜åŒ–ï¼Œtypeå­—æ®µæ˜¯å¦ä½¿ç”¨ç´¢å¼•ï¼Œextraæ˜¯å¦æœ‰æ’åºæ“ä½œï¼Œä»¥åŠæ˜¯å¦ç´¢å¼•ä¸‹æ¨ï¼Œç´¢å¼•è¦†ç›–ã€‚\n\n## å¸¸è§çš„sqlä¼˜åŒ–æ‰‹æ®µ\n1. é¿å…ä½¿ç”¨*ï¼šå› ä¸ºåœ¨æŸ¥è¯¢çš„è¿‡ç¨‹ä¸­è¿˜æœ‰ä¸€ä¸ªé¢„å¤„ç†è¿‡ç¨‹ï¼Œå¯ä»¥è‡ªå·±å†™çš„å°±ä¸è¦äº¤ç»™sqlå»æŸ¥è¯¢ï¼Œè€Œä¸”æ— æ³•ä½¿ç”¨è¦†ç›–ç´¢å¼•ï¼Œä¹Ÿå°±æ˜¯ä¸ç”¨å›è¡¨\n2. æ·±åº¦åˆ†é¡µä¼˜åŒ–ï¼šæ¯”å¦‚æœ‰1000000é¡µï¼ŒæŸ¥è¯¢è¿™ä¸ªé¡µçš„æ—¶å€™å°±æ˜¯æ·±åº¦åˆ†é¡µäº†ã€‚å¯ä»¥ç”¨å­è¡¨æŸ¥è¯¢è¿™ä¸ªé¡µçš„ç¬¬ä¸€æ¡è®°å½•ï¼Œç„¶åå†å»æŸ¥æ¯”è¿™ä¸ªå¤§çš„10æ¡è®°å½•ä½œä¸ºèŒƒå›´ã€‚æœ‰ä¸¤ä¸ªç¼ºç‚¹ï¼Œé¦–å…ˆæ˜¯idå¿…é¡»è‡ªå¢ï¼Œå…¶æ¬¡æ˜¯å­è¡¨æŸ¥è¯¢ä¸æ¨è\n3. é¿å…å¤šjoinï¼Œé¿å…ä½¿ç”¨å¤–é”®\n4. ä¼˜åŒ–æ…¢sql\n5. æ­£ç¡®ä½¿ç”¨ç´¢å¼•ï¼šé€‰æ‹©åˆé€‚çš„å­—æ®µåˆ›å»ºç´¢å¼•ï¼ˆä¸ä¸ºNULLçš„å­—æ®µï¼Œé¢‘ç¹æŸ¥æ‰¾ä½†æ˜¯ä¸æ˜¯é¢‘ç¹å¢åˆ çš„å­—æ®µï¼‰ï¼›é¿å…ç´¢å¼•å¤±æ•ˆï¼›è€ƒè™‘åœ¨å­—ç¬¦ä¸²ä¸Šå»ºç«‹å‰ç¼€ç´¢å¼•ï¼›é¿å…å†—ä½™ç´¢å¼•","tags":["Mysql"]},{"title":"ä¸€å¥è¯åˆ·é¢˜","url":"/2024/09/19/ä¸€å¥è¯åˆ·é¢˜/","content":"- **æ— é‡å¤å­—ç¬¦çš„æœ€é•¿å­—ä¸²**ï¼šæ»‘åŠ¨çª—å£+heshsetï¼Œå³çª—å£éœ€è¦åœ¨forå¤–ï¼Œæ¯è½®å¾ªç¯ç§»åŠ¨å³çª—å£\n- LRUç¼“å­˜æœºåˆ¶ï¼šå·æ‡’ç›´æ¥linkedHashMapï¼Œhashmapé•¿åº¦å¹¶ä¸ä¸ºcachesizeï¼Œé‡å†™æ›¿æ¢æ¡ä»¶ä¸ºsize>cachesizeï¼Œæ„é€ å‡½æ•°è¦ä¼ ä¸€ä¸ªå…è®¸getåé‡æ’åºçš„boolean\n- åè½¬é“¾è¡¨ï¼špre,p,qä¸‰æŒ‡é’ˆ\n- æ•°ç»„ç¬¬kä¸ªæœ€å¤§å…ƒç´ ï¼šå¿«æ’æ€æƒ³ï¼Œæ ¹æ®æ¯æ¬¡åˆ’åˆ†çš„ç»“æœäºŒåˆ†æŸ¥æ‰¾\n- æœ€å¤§å­æ•°ç»„å’Œï¼šåŠ¨æ€è§„åˆ’ï¼Œçœ‹å‰é¢çš„æ˜¯å¦ä¸ºè´Ÿæ•°ï¼Œä¸ºè´Ÿæ•°å°±æŠ›å¼ƒè‡ªå·±ä½œä¸ºå¼€å¤´ï¼Œä¸ºæ­£æ•°å°±è‡ªå·±åŠ ä¸Š\n- åˆå¹¶ä¸¤ä¸ªæœ‰åºé“¾è¡¨ï¼šæ¨¡æ‹Ÿé¢˜\n- **æœ€é•¿å›æ–‡å­—ä¸²**ï¼šäºŒç»´åŠ¨æ€è§„åˆ’ï¼Œæ’‡å»å‰åå‰©ä¸‹çš„ä¹Ÿæ˜¯å›æ–‡å­ä¸²\n- ä¸¤æ•°ä¹‹å’Œï¼šhashmapå­˜ä½™æ•°\n- äºŒå‰æ ‘å±‚æ¬¡éå†ï¼šqueueç§’æ€ï¼Œè®°å¾—æœ€ç‰¢çš„ä¸€é›†\n- æœç´¢æ—‹è½¬æ’åºæ•°ç»„ï¼šéšä¾¿åˆ’åˆ†æ€»æœ‰ä¸€æ®µæ˜¯é¡ºåºçš„\n- å²›å±¿æ•°é‡ï¼šdfsä¸Šä¸‹å·¦å³\n- å…¨æ’åˆ—ï¼šdfså›æº¯ï¼Œvisitedæ•°ç»„\n- æœ‰æ•ˆçš„æ‹¬å·ï¼šstackç§’äº†\n- äºŒå‰æ ‘çš„æœ€è¿‘å…¬å…±ç¥–å…ˆï¼šå›æº¯ï¼Œæ‰¾ä¸¤ä¸ªåˆ—è¡¨çš„æœ€æœ«å°¾ç›¸åŒå…ƒç´ \n- ç¯å½¢é“¾è¡¨ï¼šhashmapçœ‹æ˜¯å¦åŒ…æ‹¬\n- åè½¬é“¾è¡¨2ï¼šæ¨¡æ‹Ÿ\n- **æœ€é•¿é€’å¢å­åºåˆ—**ï¼šåŠ¨æ€è§„åˆ’ï¼Œæ‰¾å‰é¢æ¯ä¸€ä¸ªæ¯”è‡ªå·±å°çš„ï¼Œå–æœ€å¤§å€¼+1\n- å­—ç¬¦ä¸²ç›¸åŠ ï¼šå¤ªç®€å•ä¸è¯´\n- **æ¥é›¨æ°´**ï¼šå•è°ƒæ ˆï¼Œå·¦->å³å’Œå³->å·¦ï¼Œå–æœ€å°å€¼\n- **ç¼–è¾‘è·ç¦»**ï¼šäºŒç»´åŠ¨æ€è§„åˆ’ï¼Œéœ€è¦è€ƒè™‘å·¦å³å¯¹è§’çº¿ä¸‰ä¸ªï¼Œå¯¹è§’çº¿ï¼ˆç›¸åŒï¼‰ï¼Œå·¦å³å¯¹è§’çº¿å–æœ€å¤§+1ï¼ˆä¸ç›¸åŒï¼‰\n- **æœ€é•¿å…¬å…±å­åºåˆ—**ï¼šäºŒç»´åŠ¨æ€è§„åˆ’ã€‚æ¯”ä¸Šé¢çš„å¥½ç†è§£ï¼Œå¯¹è§’çº¿çš„+1ï¼ˆç›¸åŒï¼‰ï¼Œå·¦å³å–æœ€å¤§ï¼ˆä¸ç›¸åŒï¼‰\n- æ ˆå®ç°é˜Ÿåˆ—ï¼šä¸¤ä¸ªæ ˆæ¥å›å€’ï¼Œä¸€ä¸ªå…¥ä¸€ä¸ªå‡ºï¼Œåœ¨å…¥ä¹‹å‰æ£€æŸ¥å‡ºæ˜¯å¦ä¸ºç©ºï¼Œåä¹‹äº¦ç„¶\n- æ‹¬å·ç”Ÿæˆï¼šå·¦å³æ‹¬å·å‰©ä½™æ•°é‡åˆ¤åˆ«ï¼Œå³è¾¹çš„æ•°é‡ä¸€å®šå¾—å¤§äºç­‰äºå·¦è¾¹å‰©ä½™\n- åè½¬å­—ç¬¦ä¸²ä¸­çš„å•è¯ï¼šsplitå’Œstringbuilder\n- äºŒå‰æ ‘çš„é”¯é½¿çŠ¶å±‚æ¬¡éå†ï¼š åŸºæœ¬ä¸Šå°±æ˜¯æ™®é€šçš„å±‚æ¬¡éå†ï¼Œç”¨reversedå°±å¯ä»¥å€’è½¬ã€‚\n- ç¯å½¢é“¾è¡¨2ï¼šå“ˆå¸Œè¡¨å­˜èŠ‚ç‚¹ï¼Œéå†çš„æ—¶å€™åŒæ—¶æ£€è½¦å“ˆå¸Œè¡¨æ˜¯å¦å«æœ‰\n- äºŒå‰æ ‘å³è§†å›¾ï¼šå±‚æ¬¡éå†\n- å­é›†ï¼šå›æº¯ï¼Œä»¥1234ä¸ºä¾‹ï¼Œä¾æ¬¡å¢åŠ å­é›†çš„å…ƒç´ ä¸ªæ•°\n- ç»„åˆæ€»å’Œï¼šå›æº¯ï¼Œæ¯æ¬¡dfséƒ½æ˜¯ä¼ å‰©ä½™ï¼Œé€’å½’ç»ˆæ­¢æ¡ä»¶æ˜¯å‰©ä½™<0ï¼Œ=0å°±æ·»åŠ ä¸€æ¡ï¼Œæœ€åä¼šæœ‰é‡å¤ï¼Œéœ€è¦ä¸€ä¸ªæ’åº+hashsetå»é‡\n- **åˆ†å‰²å›æ–‡ä¸²ï¼š** ä¸¤æ­¥èµ°ï¼šé¦–å…ˆäºŒç»´åŠ¨æ€è§„åˆ™æ‰¾åˆ°æ‰€æœ‰çš„å›æ–‡å­—ä¸²ï¼›å†ç±»ä¼¼primç®—æ³•éå†dpæ•°ç»„å›æº¯\n- å•è¯æœç´¢ï¼šå›æº¯ï¼Œä¸Šä¸‹å·¦å³ä¾æ¬¡dfsï¼Œæ¡ä»¶å…¨ä¸ºæˆ–ï¼Œæœ‰ä¸€ä¸ªä¸ºçœŸå°±ä¼šæ˜¯çœŸ\n- æ‰¾åˆ°å­—ç¬¦ä¸²ä¸­æ‰€æœ‰å­—æ¯å¼‚ä½è¯ï¼šå“ˆå¸Œè¡¨ï¼ˆå·æ‡’æ–¹æ³•ï¼Œæ»‘åŠ¨çª—å£æ¯ä¸€ä¸ªä¸ç›®æ ‡å­—ç¬¦ä¸²æ•°ç»„è¿›è¡Œæ¯”è¾ƒï¼Œç”¨toCharArrayå’ŒArrays.sortå’Œequalsï¼‰\n- ç”µè¯å·ç çš„å­—æ¯ç»„åˆï¼šå“ˆå¸Œè¡¨å†™ä¸€ä¸ªé”®ç›˜é›†åˆï¼Œç„¶åå›æº¯\n- é‡æ’é“¾è¡¨ï¼šå¿«æ…¢æŒ‡é’ˆæ‰¾ä¸­ç‚¹ï¼ˆå¥‡æ•°å¾—åœ¨æ­£å¸¸ä¸­ç‚¹çš„åé¢ä¸€ä¸ªï¼‰+ååŠéƒ¨åˆ†å€’è½¬é“¾è¡¨+åŒæŒ‡é’ˆè¿æ¥\n- æ—‹è½¬å›¾åƒï¼šæ²¿ç€å·¦ä¸‹å³ä¸Šå¯¹è§’çº¿å¯¹è°ƒï¼Œç„¶åæŒ‰è¡ŒæŒ‰ç…§ä¸­çº¿å¯¹è°ƒ\n- æœç´¢äºŒç»´çŸ©é˜µ2ï¼šå››ä¸ªæŒ‡é’ˆä¸Šä¸‹å·¦å³ï¼Œé€æ­¥ç¼©å°èŒƒå›´ï¼Œå½“å¾ªç¯å†…ä¸å†å‘ç”Ÿæ”¹å˜å°±ä¸ºçœŸ\n- è…çƒ‚çš„æ©˜å­ï¼šå¤šæºbfsï¼Œè·ŸäºŒå‰æ ‘çš„å±‚æ¬¡éå†å·®ä¸å¤š\n- è¯¾ç¨‹è¡¨ï¼šæ‹“æ‰‘æ’åºï¼Œå…ˆè®°å½•æ‰€æœ‰ç‚¹çš„å…¥åº¦ï¼Œæ¯æ¬¡éƒ½æ‰¾åˆ°å…¥åº¦ä¸º0çš„ç‚¹ï¼Œå¦‚æœæœ€åè¿˜æœ‰å…¥åº¦ä¸ä¸º0çš„è¯´æ˜æœ‰ç¯\n- ä»å‰åºä¸ä¸­åºéå†åºåˆ—æ„é€ äºŒå‰æ ‘ï¼šç»å…¸é¢˜ç›®ï¼Œè¦æ—¶ä¸æ—¶å†™ä¸€ä¸‹\n- å®ç°å‰ç¼€æ ‘ï¼šTrim[26]æ•°ç»„ï¼Œè¦ç”¨ä¸€ä¸ªisendåŒºåˆ†æ˜¯å‰ç¼€è¿˜æ˜¯å•è¯\n- æœ‰åºæ•°ç»„è½¬åŒ–ä¸ºäºŒå‰æœç´¢æ ‘ï¼šäºŒåˆ†+é€’å½’\n- **å•è¯æ‹†åˆ†ï¼š** åŠ¨æ€è§„åˆ’ï¼Œå½“dp[j] == 1 && hashset.contains(s.subString(i,j))æ—¶dp[i]=1ï¼Œå­—ç¬¦ä¸²åœ¨å­—å…¸é‡Œå½“ä¸”ä»…å½“åˆ’åˆ†çš„ä¸¤éƒ¨åˆ†åº”è¯¥ä¹Ÿåœ¨å­—å…¸é‡Œ\n- æ‰“å®¶åŠ«èˆï¼šç»å…¸dpé¢˜ç›®ï¼Œæœ‰ä¸¤ç§ç­–ç•¥ï¼Œä¸æŠ¢çš„æ—¶å€™é€‰æ‹©ä¸Šä¸€ä¸ªä¸¤ç§æƒ…å†µä¸­æœ€å¤§çš„ï¼ŒæŠ¢çš„æ—¶å€™å‰ä¸€ä¸ªåªèƒ½ä¸æŠ¢ã€‚\n- **æœ€å¤§æ­£æ–¹å½¢ï¼š** äºŒç»´dpï¼Œdp[i][j]è¡¨ç¤ºä»¥ijä¸ºå·¦ä¸‹è§’çš„æœ€å¤§æ­£æ–¹å½¢ï¼Œå–å·¦ï¼Œä¸Šï¼Œå¯¹è§’çº¿ä¸‰ä¸ªé‡Œé¢æœ€å°çš„ã€‚\n- æœ€å°è·¯å¾„å’Œï¼šäºŒç»´dpå…¥é—¨é¢˜ç›®ï¼Œçœ‹ä¸€çœ¼è‚¯å®šä¼š\n- **é›¶é’±å…‘æ¢ï¼š** dpæ•°ç»„é•¿åº¦ä¸ºé’±çš„å¤šå°‘ï¼Œdpè¡¨ç¤ºå½“å‰é’±å…‘æ¢çš„æœ€å°‘æ¬¡æ•°ã€‚æ¯æ¬¡å¾€åç§»åŠ¨éƒ½éœ€è¦é¦–å°¾æŒ‡é’ˆä¸€èµ·åŠ¨\n- **æ’åºé“¾è¡¨ï¼š** èœå°±å¤šç»ƒ\n- ä¸¤æ•°ç›¸åŠ ï¼šä¸¤ä¸ªé“¾è¡¨åšåŠ æ³•ï¼Œå¤ªç®€å•äº†ä¸è¯´ï¼Œè¿˜æœ‰ä¸ª2ï¼Œå°±æ˜¯åè½¬ä¹‹åç›¸åŠ \n- kä¸ªä¸€ç»„ç¿»è½¬é“¾è¡¨ï¼šè™½ç„¶æ˜¯hardä½†æ˜¯å¾ˆç®€å•ï¼Œæ€è·¯ä¸€å®šè¦æ¸…æ™°\n- **äºŒå‰æ ‘çš„æœ€å¤§è·¯å¾„å’Œ**ï¼šæ ‘å½¢dpï¼Œç”¨ä¸€ä¸ªå…¨å±€å˜é‡ä¿å­˜å…¨å±€æœ€å¤§è·¯å¾„å’Œï¼Œè¿”å›çš„æ—¶å€™éœ€è¦åˆ¤æ–­å­æ ‘æ˜¯å¦ä¸ºè´Ÿæ•°ï¼Œå¦‚æœéƒ½ä¸ºè´Ÿæ•°å°±è¿”å›è‡ªå·±ï¼Œåªè¦æœ‰ä¸€ä¸ªæ˜¯æ­£æ•°å°±è¿”å›è‡ªå·±+æ­£æ•°\n- äºŒå‰æ ‘çš„ç›´å¾„ï¼šè·Ÿä¸Šé¢æ€è·¯æ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯dpè¿”å›çš„æ˜¯å½“å‰æ ‘çš„é«˜åº¦ï¼Œä¹Ÿæ˜¯ç”¨å…¨å±€å˜é‡ä¿å­˜æœ€å¤§å€¼\n- æ‰“å®¶åŠ«èˆ3ï¼šæ ‘å½¢dpï¼Œæ ¹èŠ‚ç‚¹æŠ¢äº†å­èŠ‚ç‚¹éƒ½ä¸èƒ½æŠ¢äº†ï¼Œå–å…¶ä¸­dp[0]çš„å’Œå†åŠ è‡ªå·±çš„ï¼Œä¸æŠ¢å°±æ‰¾dp[0]å’Œdp[1]ä¸­è¾ƒå¤§çš„é‚£ä¸ª\n- æ±‚æ ¹åˆ°å¶å­èŠ‚ç‚¹æ•°å­—ä¹‹å’Œï¼šæ·±åº¦å’Œå¹¿åº¦+å›æº¯\n- è·¯å¾„æ€»å’Œï¼šå›æº¯\n- **å­—ç¬¦ä¸²è§£ç ï¼š** åŒæ ˆï¼Œå­˜æ•°å’Œå­—ç¬¦ä¸²ï¼Œé‡åˆ°]åè¿›è¡Œå¾ªç¯æ‹¼æ¥ï¼Œå†å°†å‰é¢çš„ä¾æ¬¡å‡ºæ ˆç›´åˆ°[\n- æœ€é•¿è¿ç»­åºåˆ—ï¼šé¦–å…ˆsetå»é‡ï¼Œç„¶åéå†ï¼Œå¦‚æœæœ‰æ¯”å½“å‰å…ƒç´ å°çš„å°±è·³è¿‡ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯æ¬¡éƒ½æ‰¾ä¸€æ®µé‡Œé¢æœ€å°çš„å…ƒç´ ã€‚ç„¶åç”¨ä¸€ä¸ªå…¨å±€å˜é‡ä¿å­˜æœ€å¤§çš„ã€‚\n- æœ€é•¿å…¬å…±å‰ç¼€ï¼šæŒ‰åˆ—éå†ï¼Œæ³¨æ„é•¿åº¦æ˜¯å¦è¶…å‡º\n- èºæ—‹çŸ©é˜µï¼šä¸Šä¸‹å·¦å³å››ä¸ªæŒ‡é’ˆï¼Œéœ€è¦æ³¨æ„åªæœ‰ä¸€åˆ—æˆ–è€…ä¸€è¡Œçš„æƒ…å†µï¼Œåœ¨å¾ªç¯çš„è¿‡ç¨‹ä¸­è¦ä¿æŒä¸Šä¸‹ç•Œå·¦å³ç•Œä¸è¶Šç•Œ\n- åˆå¹¶Kä¸ªå‡åºé“¾è¡¨ï¼šä¸¤ä¸¤åˆå¹¶å³å¯ï¼Œæˆ–è€…æ¯æ¬¡éƒ½æ‰¾æœ€å°èŠ‚ç‚¹\n- åˆ é™¤é“¾è¡¨çš„å€’æ•°ç¬¬Nä¸ªèŠ‚ç‚¹ï¼šæ ˆå…ˆè¿›åå‡º\n- å¤åˆ¶ipåœ°å€ï¼šå›æº¯ï¼Œä½†æ˜¯è¿˜æœ‰ä¸€ç‚¹è¾¹ç•Œæ²¡ææ˜ç™½\n- **äºŒå‰æ ‘çš„æœ€å¤§å®½åº¦**ï¼šæ–°å»ºä¸€ä¸ªå†…éƒ¨ç±»ï¼Œä¿å­˜ç¼–å·ï¼Œå·¦èŠ‚ç‚¹æ˜¯*2ï¼Œå³èŠ‚ç‚¹æ˜¯*2+1ï¼ŒæŒ‰å±‚æ¬¡éå†ï¼Œæ‰¾å‡ºä¸€å±‚å†…ç¼–å·å·®æœ€å¤§çš„ã€‚\n- å¯¹ç§°äºŒå‰æ ‘ï¼šé€’å½’æ¯”è¾ƒå·¦å­æ ‘å’Œå³å­—æ•°\n- **æ¯ç§å­—ç¬¦è‡³å°‘å–kä¸ª**ï¼šåå‘æ€ç»´ï¼Œæ»‘åŠ¨çª—å£ã€‚å…ˆå“ˆå¸Œè¡¨å­˜æ‰€æœ‰å…ƒç´ çš„ä¸ªæ•°ï¼Œç„¶åå†-kï¼Œréšç€å¾ªç¯ç§»åŠ¨ï¼Œç§»åŠ¨ä¸€æ¬¡å¯¹åº”å…ƒç´ ä¸ªæ•°-1ï¼Œå½“å“ˆå¸Œè¡¨å†…å‡ºç°è´Ÿæ•°å…ƒç´ ï¼Œå·¦è¾¹æŒ‡é’ˆç§»åŠ¨å¹¶ä¸”é‡Šæ”¾å…ƒç´ ç›´åˆ°å“ˆå¸Œè¡¨å†…éƒ½ä¸ä¸ºè´Ÿæ•°ã€‚æœ€åå–å‡ºæœ€å¤§çš„é‚£æ¬¡\n- **æœ€å°è¦†ç›–å­—ä¸²**ï¼šæ»‘åŠ¨çª—å£ï¼Œé¦–å…ˆå“ˆå¸Œè¡¨ä¿å­˜ç›®æ ‡å­—ç¬¦çš„ä¸ªæ•°ã€‚réšç€å¾ªç¯ç§»åŠ¨ï¼Œæ¯æ¬¡éƒ½ä»å“ˆå¸Œè¡¨å‡å»å¯¹åº”å­—ç¬¦çš„ä¸ªæ•°ï¼Œå¦‚æœä¸åœ¨å“ˆå¸Œè¡¨å°±è·³è¿‡ã€‚å¦‚æœå“ˆå¸Œè¡¨æ‰€æœ‰å…ƒç´ éƒ½å°äºç­‰äº0ï¼ˆä¹Ÿå°±æ˜¯è¯´é›†é½äº†æ‰€æœ‰ï¼Œè¿™é‡Œæœ‰å¯èƒ½æ¯”åŸæ¥å¤šï¼‰ï¼Œé‚£ä¹ˆå°±è®°å½•è¿™ä¸ªé•¿åº¦ï¼Œå·¦è¾¹æŒ‡é’ˆå¼€å§‹åŠ¨ç›´åˆ°å†ä¸€æ¬¡æ²¡æœ‰é›†é½å…ƒç´ \n- äºŒå‰æ ‘çš„æœ€å¤§æ·±åº¦ï¼šå·¦å³å­æ ‘æ±‚æœ€å¤§ï¼Œdp\n- å¹³è¡¡äºŒå‰æ ‘åˆ¤æ–­ï¼Œè¿”å›ä¸€ä¸ªæ•°ç»„ï¼Œ[0]æ˜¯é«˜åº¦ï¼Œ[1]æ˜¯æ˜¯å¦å¹³è¡¡\n- å²›å±¿çš„æœ€å¤§é¢ç§¯ï¼šdfsæ²¡ä»€ä¹ˆå¥½è¯´çš„\n- **Nçš‡å**ï¼šç»ˆæå›æº¯é¢˜ï¼Œä¸Šä¸‹å’Œä¸¤ä¾§çš„å¯¹è§’çº¿éƒ½ä¸èƒ½æœ‰å…ƒç´ é‡å¤ã€‚è®¾ç½®å››ä¸ªvisitedæ•°ç»„ï¼Œç„¶åæ¯ä¸€è¡Œå¼€å§‹å°è¯•æ”¾qï¼Œå¦‚æœèƒ½è¿›è¡Œåˆ°æœ€åä¸€è¡Œé‚£å°±ä¿å­˜ï¼Œå…¶ä½™å°±æ˜¯å›æº¯æ“ä½œ","tags":["åˆ·é¢˜ç¬”è®°"]},{"title":"hot100å¤©å¤©åˆ·-ç¬¬ä¸€æœŸ","url":"/2024/09/19/hot100å¤©å¤©åˆ·-ç¬¬ä¸€æœŸ/","content":"> è®°ä½å¤§æ¦‚çš„æ–¹æ³•å°±è¡Œäº†\n\n## 1.æ— é‡å¤å­—ç¬¦çš„æœ€çŸ­å­—ä¸²ï¼ˆæ»‘åŠ¨çª—å£ï¼‰\n\n[åŸé¢˜ï¼š](https://leetcode.cn/problems/longest-substring-without-repeating-characters/description/)ç»™å®šä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œæ‰¾å‡ºä¸å«æœ‰é‡å¤å­—ç¬¦çš„æœ€é•¿**å­—ä¸²**ï¼ˆå­—ä¸²æ˜¯è¿ç»­çš„ï¼‰ã€‚\n\næ»‘åŠ¨çª—å£ï¼šä¸»è¦æ€æƒ³æ˜¯éšç€å·¦è¾¹çª—å£çš„ç§»åŠ¨ï¼Œå³è¾¹çª—å£ä¹Ÿä¸€å®šä¼šå‘å³è¾¹ç§»åŠ¨ã€‚æ¯ä¸€æ¬¡å¾ªç¯æ‰¾çš„éƒ½æ˜¯ä»¥charAt(i)å¼€å¤´çš„æœ€é•¿å­—ä¸²ã€‚ç”±äºiåœ¨å¢åŠ ï¼Œåœ¨æ¯æ¬¡ç§»åŠ¨çš„åŒæ—¶ä¿å­˜æœ€é•¿å­—ä¸²çš„é•¿åº¦å°±æ˜¯ç»“æœã€‚\n\nåˆ¤æ–­æ˜¯å¦é‡å¤ï¼šå½“å³æŒ‡é’ˆéå†åˆ°hashsetå«æœ‰çš„å…ƒç´ å°±åœæ­¢å³ç§»ã€‚ä¸ºäº†ä¿è¯iç§»åŠ¨çš„åŒæ—¶ï¼Œåç»­å­—ç¬¦éƒ½æ˜¯ä»¥iè¿™ä¸ªå…ƒç´ å¼€å¤´çš„ï¼Œå½“å‰å¾ªç¯ç»“æŸä»¥åéœ€è¦æŠŠcharAt(i)ä»hashsetå‰”é™¤ã€‚\n\n```java\npublic static int lengthOfLongestSubstring(String s) {\n    //æ£€æŸ¥é‡å¤æ€§\n    HashSet<Character> hashSet = new HashSet<>();\n    int max = 0;\n    //pæ˜¯æœ€å³è¾¹çš„æŒ‡é’ˆ\n    int p = 0;\n    for (int i = 0; i < s.length(); i++) {\n        //pä¸€ç›´å‘å³è¾¹ç§»åŠ¨ï¼Œç›´åˆ°ç¢°åˆ°seté‡Œé¢æœ‰çš„å…ƒç´ ï¼Œå°±è¿›è¡Œä¸‹ä¸€æ¬¡å¤§å¾ªç¯\n        while (p < s.length()){\n            if (!hashSet.contains(s.charAt(p))){\n                hashSet.add(s.charAt(p));\n                p++;\n            }\n            else {\n                break;\n            }\n        }\n        //ç•™ä¸€ä¸ªmaxæ¥è¿”å›æœ€å¤§å€¼\n        max = Math.max(max,hashSet.size());\n        //åœ¨ä¸‹ä¸€æ¬¡å¤§å¾ªç¯å‰ä¿è¯setåªæœ‰å½“å‰å…ƒç´ ä»¥åçš„ï¼Œæ‰€ä»¥è¦æŠŠä¸Šä¸€ä¸ªå…ƒç´ ä»setåˆ é™¤\n        hashSet.remove(s.charAt(i));\n    }\n    return max;\n}\n```\n## 2.æœ€é•¿å›æ–‡å­—ä¸²ï¼ˆäºŒç»´åŠ¨æ€è§„åˆ’ï¼‰\n[åŸé¢˜ï¼š](https://leetcode.cn/problems/longest-palindromic-substring/description/)ç»™ä½ ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œæ‰¾åˆ°æœ€é•¿çš„å›æ–‡å­—ä¸²ã€‚\n\nåŠ¨æ€è§„åˆ’ï¼šå›æ–‡å­ä¸²çš„æ€§è´¨æ˜¯ï¼ŒæŠŠæœ€å¼€å§‹å’Œæœ€æœ«å°¾çš„å…ƒç´ åˆ é™¤è¿˜æ˜¯ä¸€ä¸ªå›æ–‡å­—ä¸²ã€‚çŠ¶æ€è½¬ç§»æ–¹ç¨‹ä¸º\n$$\ndp[i][i] = 1\n$$\n$$\ndp[i][j] = dp[i+1][j-1] \\land (S_{i} == S_{j})\n$$\n\n\n```java\npublic String longestPalindrome(String s) {\n    boolean[][] dp = new boolean[s.length()][s.length()];\n    int length = 1;\n    int head = 0,tail=0;\n    //å¯¹è§’çº¿ä¸Šçš„å…ƒç´ éƒ½ä¸º1\n    for (int i = 0; i < s.length(); i++) {\n        dp[i][i] = true;\n    }\n    //æ²¿ç€å¯¹è§’çº¿é€æ¸å¢å¤§ï¼Œè€Œä¸æ˜¯æ ¹æ®è¡¨æ ¼è¡Œåˆ—éå†\n    for (int k = 1; k < s.length(); k++) {\n        for (int i = 0; i < s.length() - 1; i++) {\n            //å­—ä¸²é•¿åº¦ä¸º2çš„æ—¶å€™å•ç‹¬è€ƒè™‘\n            if (k == 1){\n                //aaï¼Œbbè¿™ç§å­—ä¸²\n                if (s.charAt(i) == s.charAt(i+k)){\n                    dp[i][i+k] = true;\n                    //å¾ªç¯å¤–éƒ¨å˜é‡ä¿å­˜æœ€å¤§å€¼å’Œèµ·å§‹ç‚¹å’Œé‡ç‚¹ï¼Œå› ä¸ºè¿”å›çš„æ˜¯å…·ä½“çš„å­—ä¸²ï¼Œéœ€è¦è°ƒç”¨substring\n                    if (length < k+1){\n                        length = k+1;\n                        head = i;tail = i+k;\n                    }\n                }\n            }\n            //å…¶ä½™é•¿åº¦\n            //åªæœ‰dp[i+1][i+k-1]ä¸ºå›æ–‡å­—ä¸²ä¸”[i]å’Œ[i+k]ç›¸åŒçš„æ—¶å€™æ‰æ˜¯ä¸€ä¸ªå›æ–‡å­—ä¸²\n            if (i+k < s.length() && s.charAt(i) == s.charAt(i+k) && dp[i+1][i+k-1]){\n                dp[i][i+k] = true;\n                if (k+1 > length){\n                    length = k+1;\n                    head = i;tail = i+k;\n                }\n            }\n\n        }\n    }\n    //System.out.println(Arrays.deepToString(dp));\n    return s.substring(head,tail+1);\n}\n```\n\n## 3.æœ€å¤§å­æ•°ç»„å’Œï¼ˆåŠ¨æ€è§„åˆ’ï¼‰\n\n[åŸé¢˜ï¼š](https://leetcode.cn/problems/maximum-subarray/description/)ç»™ä½ ä¸€ä¸ªæ•´æ•°æ•°ç»„ nums ï¼Œè¯·ä½ æ‰¾å‡ºä¸€ä¸ªå…·æœ‰æœ€å¤§å’Œçš„è¿ç»­å­æ•°ç»„ï¼ˆå­æ•°ç»„æœ€å°‘åŒ…å«ä¸€ä¸ªå…ƒç´ ï¼‰ï¼Œè¿”å›å…¶æœ€å¤§å’Œã€‚\n\nåŠ¨æ€è§„åˆ’ï¼špreè¡¨ç¤ºçš„æ˜¯iä¹‹å‰çš„æœ€å¤§å­æ•°ç»„å’Œçš„æœ€å¤§å€¼.å¦‚æœpreæ˜¯è´Ÿæ•°ï¼Œé‚£å°±ç›¸å½“äºæ‹–nums[i]åè…¿äº†ï¼Œä¸å…¶åŠ ä¸Šå‰é¢çš„ä¸å¦‚è‡ªå·±ä½œä¸ºå¼€å¤´ã€‚çŠ¶æ€è½¬ç§»æ–¹ç¨‹ï¼š\n\n$$f(i) = max ( f(i-1)+nums[i],nums[i] ) $$\n\n```java\npublic int maxSubArray(int[] nums) {\n    int pre = 0;\n    int max = Integer.MIN_VALUE;\n    for (int i = 0; i < nums.length; i++) {\n        pre = Math.max(pre+nums[i],nums[i]);\n        max = Math.max(max,pre);\n    }\n    return max;\n}\n```\n\n## 4.æœ€é•¿å…¬å…±å­åºåˆ—ï¼ˆäºŒç»´åŠ¨æ€è§„åˆ’ï¼Œä¸dp[i-1][j-1],dp[i-1][j],dp[i][j-1]æœ‰å…³ï¼‰\n> è¿™é“é¢˜å’Œç¼–è¾‘é•¿åº¦æ˜¯ä¸€ä¸ªç±»å‹çš„\n\n[åŸé¢˜ï¼š](https://leetcode.cn/problems/longest-common-subsequence/description/)ç»™å®šä¸¤ä¸ªå­—ç¬¦ä¸² text1 å’Œ text2ï¼Œè¿”å›è¿™ä¸¤ä¸ªå­—ç¬¦ä¸²çš„æœ€é•¿ å…¬å…±å­åºåˆ— çš„é•¿åº¦ã€‚å¦‚æœä¸å­˜åœ¨ å…¬å…±å­åºåˆ— ï¼Œè¿”å› 0 ã€‚\n\néœ€è¦è€ƒè™‘dp[i-1][j-1],dp[i-1][j],dp[i][j-1]ï¼Œæ‰€ä»¥dp[][]è¦å¤šä¸€è¡Œä¸€åˆ—ï¼ŒçŠ¶æ€è½¬ç§»æ–¹ç¨‹ï¼š\n- text1.charAt(i) == text2.charAt(j):$dp[i][j] = dp[i-1][j-1]+1$\n- text1.charAt(i) != text2.charAt(j):$dp[i][j] = max(dp[i-1][j],dp[i][j-1])$\n\n```java\npublic int longestCommonSubsequence(String text1, String text2) {\n    //äºŒç»´åŠ¨æ€è§„åˆ’\n    int[][] dp = new int[text1.length()+1][text2.length()+1];\n    for (int i = 1; i < dp.length; i++) {\n        for (int j = 1; j < dp[0].length; j++) {\n            if (text1.charAt(i-1) == text2.charAt(j-1)){\n                dp[i][j] = dp[i-1][j-1]+1;\n            }\n            else {\n                dp[i][j] = Math.max(dp[i-1][j],dp[i][j-1]);\n            }\n        }\n    }\n    return dp[dp.length-1][dp[0].length-1];\n}\n```\n## 5.ç¼–è¾‘è·ç¦»ï¼ˆäºŒç»´åŠ¨æ€è§„åˆ’ï¼Œä¸dp[i-1][j-1],dp[i-1][j],dp[i][j-1]æœ‰å…³ï¼‰\n\n[åŸé¢˜ï¼š](https://leetcode.cn/problems/edit-distance/)ç»™ä½ ä¸¤ä¸ªå•è¯ word1 å’Œ word2ï¼Œ è¯·è¿”å›å°† word1 è½¬æ¢æˆ word2 æ‰€ä½¿ç”¨çš„æœ€å°‘æ“ä½œæ•°  ã€‚\n\nä¸ä¸Šé¢é‚£ä¸ªå¾ˆç›¸ä¼¼ï¼Œå¦‚æœä¸¤ä¸ªå­—ç¬¦æ˜¯ç›¸åŒçš„è¯å°±çœ‹dp[i-1][j-1]ï¼Œä½†æ˜¯ä¸åŒçš„è¯ä¹Ÿéœ€è¦çœ‹dp[i-1][j-1]ï¼Œå› ä¸ºå³ä¾¿å­—ç¬¦ä¸åŒä¹Ÿå¯ä»¥é€šè¿‡æ›¿æ¢è§£å†³ã€‚çŠ¶æ€è½¬ç§»æ–¹ç¨‹ä¸ºï¼š\n- text1.charAt(i) == text2.charAt(j):$dp[i][j] = dp[i-1][j-1]$\n- text1.charAt(i) != text2.charAt(j):$dp[i][j] = min(dp[i-1][j],dp[i][j-1],dp[i-1][j-1])+1$\n\nè¿˜æœ‰ä¸åŒçš„å°±æ˜¯åˆå§‹åŒ–è¾¹ç¼˜ä¸å†éƒ½æ˜¯0äº†ï¼Œæ ¹æ®æ’å…¥å­—ç¬¦çš„æ•°é‡å†³å®šã€‚\n\n```java\npublic int minDistance(String word1, String word2) {\n    int[][] dp = new int[word1.length()+1][word2.length()+1];\n    for (int i = 0; i < dp.length; i++) {\n        dp[i][0] = i;\n    }\n    for (int i = 0; i < dp[0].length; i++) {\n        dp[0][i] = i;\n    }\n    for (int i = 1; i < dp.length; i++) {\n        for (int j = 1; j < dp[0].length; j++) {\n            if (word1.charAt(i-1) == word2.charAt(j-1)){\n                dp[i][j] = dp[i-1][j-1];\n            }\n            else {\n                dp[i][j] = Math.min(dp[i-1][j-1],Math.min(dp[i-1][j],dp[i][j-1]))+1;\n            }\n        }\n    }\n    //System.out.println(Arrays.deepToString(dp));\n    return dp[dp.length-1][dp[0].length-1];\n}\n```","tags":["åˆ·é¢˜ç¬”è®°"]},{"title":"Redisé¢è¯•ç¯‡","url":"/2024/09/17/Redisé¢è¯•ç¯‡/","content":"## redisçš„æ•°æ®ç»“æ„\n- åŸºæœ¬æ•°æ®ç»“æ„ï¼šstringï¼Œhashï¼Œlistï¼Œsetï¼Œsorted set\n- é«˜çº§æ•°æ®ç»“æ„ï¼šgeoï¼Œhyperloglogï¼Œbitmap\n\n## Stringçš„SDS\nredisæ˜¯åŸºäºcçš„ï¼Œä½†æ˜¯å…¶å¹¶æ²¡æœ‰é‡‡ç”¨cè¯­è¨€çš„å­—ç¬¦ä¸²å½¢å¼ã€‚cè¯­è¨€çš„å­—ç¬¦ä¸²æ˜¯ç»™é¦–æ•°æ®çš„æŒ‡é’ˆï¼Œéå†å­—ç¬¦ä¸²çš„æ—¶å€™ä¸€ç›´å¾€åæ‰¾ç›´åˆ°å‡ºç°\"\\0\"ï¼Œè¿™å¯¹äºéœ€è¦å¿«é€Ÿå¤„ç†å­—ç¬¦ä¸²çš„redisæ˜¯ä¸å¯æ¥å—çš„ã€‚\n\näºæ˜¯rediså‘æ˜äº†ä¸€ä¸ªSDSï¼ˆç®€å•åŠ¨æ€å­—ç¬¦ä¸²ï¼‰ï¼Œç›¸å¯¹äºåŸå…ˆçš„cè¯­è¨€å­—ç¬¦ä¸²ï¼Œè¿™é‡Œæœ€å¤§çš„ä¸åŒæ˜¯ä½¿ç”¨ä¸€ä¸ªæ•°æ®ç»“æ„é‡Œé¢ä¿å­˜å­—ç¬¦ä¸²çš„æ•°ç»„å’Œé•¿åº¦ã€‚ä¼˜ç‚¹å¦‚ä¸‹ï¼š\n1. ç»Ÿè®¡å­—ç¬¦ä¸²çš„æ—¶é—´å¤æ‚åº¦ä¸ºo(1)ï¼šç”±äºcè¯­è¨€çš„å­—ç¬¦ä¸²æ˜¯éœ€è¦éå†çš„ï¼Œç±»ä¼¼é“¾è¡¨çš„ç»“æ„ï¼Œä½†æ˜¯sdsç›´æ¥å°±æœ‰ä¸€ä¸ªå­—æ®µä¿å­˜é•¿åº¦\n2. å¯ä»¥ä¿å­˜äºŒè¿›åˆ¶ä¿¡æ¯ï¼šç”±äºcè¯­è¨€æ˜¯è¦æ‰¾åˆ°\"\\0\"ä¸ºæœ«å°¾ä¿¡æ¯ï¼Œä¸å…è®¸æœ‰ç©ºæ ¼ï¼Œä½¿å¾—cè¯­è¨€å­—ç¬¦ä¸²çš„å­˜å‚¨å½¢å¼å—é™ï¼›è€Œsdsæ²¡æœ‰è¿™æ–¹é¢çš„ç‰¹æ€§ï¼Œç›´æ¥ä¿å­˜åœ¨ä¸€ä¸ªæ•°ç»„é‡Œé¢ï¼Œå› æ­¤rediså¯ä»¥ç”¨å­—ç¬¦ä¸²å­˜å‚¨å›¾ç‰‡ç­‰äºŒè¿›åˆ¶ä¿¡æ¯ã€‚\n3. ä¸ä¼šå‘ç”Ÿæº¢å‡ºï¼šç”±äºä¿å­˜äº†æ•°ç»„çš„é•¿åº¦å’Œæ•°ç»„å‰©ä½™é•¿åº¦ï¼Œå½“è¿›è¡Œå­—ç¬¦ä¸²æ‹¼æ¥çš„æ—¶å€™ä¼šæ ¡éªŒæ–°çš„é•¿åº¦æ˜¯å¦ä¼šå¯¼è‡´æ•°ç»„æº¢å‡ºï¼Œcè¯­è¨€æ˜¯æ²¡æœ‰è¿™ä¸ªç‰¹æ€§çš„ã€‚\n\n## å‹ç¼©é˜Ÿåˆ—ziplist\nåœ¨è®²å…¶ä»–æ•°æ®ç»“æ„ä¹‹å‰ï¼Œéœ€è¦è®²ä¸€ä¸‹å‹ç¼©ã€‚åœ¨redisä¸­listï¼Œsetå’Œzsetéƒ½æœ‰ä¸¤ç§æ•°æ®ç»“æ„ï¼Œå…¶ä¸­ä¸€ç§å°±æ˜¯ziplistï¼Œåˆå§‹ä¸ºziplistè€Œå½“å…ƒç´ æ•°é‡è¾¾åˆ°ä¸€å®šé˜ˆå€¼å°±ä¼šè¿›åŒ–ä¸ºå…¶ä»–çš„ã€‚\n\nä¸€èˆ¬æ¥è¯´å­˜å‚¨æ•°æ®æ¯ä¸€ä¸ªæ ¼å­é•¿åº¦éƒ½æ˜¯å›ºå®šçš„ï¼Œä½†redisä¸ºäº†èŠ‚çº¦è¿™éƒ¨åˆ†ç©ºç™½æ•°æ®å°±ä½¿ç”¨äº†åŠ¨æ€é•¿åº¦ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯ä¸€ä¸ªæ ¼å­åªä¼šæ­£å¥½åŒ…æ‹¬æ•°æ®è€Œä¸ä¼šæœ‰ç©ºç™½ã€‚ä½†æ˜¯è¿™æ ·ä¸æ˜¯å›ºå®šé•¿åº¦ä¹Ÿç»™éå†å¸¦æ¥çš„é—®é¢˜ï¼Œä¸èƒ½å¤ŸæŒ‰ç…§æ•°ç»„é‚£ç§é•¿åº¦*ä¸ªæ•°æ¥æ‰¾åœ°å€ï¼Œäºæ˜¯redisä¹Ÿåšäº†ä¸€äº›æ–¹ä¾¿æœç´¢çš„æ•°æ®ç»“æ„ã€‚\n\n**è¿é”æ›´æ–°é—®é¢˜**\n\né™¤äº†æœç´¢æœ‰ç¼ºç‚¹ï¼Œè¿˜å­˜åœ¨ç€æ›´æ–°é—®é¢˜ï¼Œä¹Ÿèƒ½æƒ³åˆ°ï¼Œå¦‚æœåœ¨ä¸­é—´çš„æŸä¸ªæ•°æ®éœ€è¦æ›´æ–°ï¼Œé‚£ä¹ˆåé¢æ‰€æœ‰çš„æ•°æ®éƒ½éœ€è¦å‘åç§»åŠ¨ï¼Œé€ æˆå¾ˆå¤§çš„å¼€é”€ï¼Œæ‰€ä»¥redisåªåœ¨æ•°æ®é‡å¾ˆå°çš„æƒ…å†µä¸‹ä½¿ç”¨è¿™ä¸ªæ•°æ®ç»“æ„ã€‚\n\n## hash\nç±»ä¼¼jdk1.7å®ç°çš„hashmapï¼Œå°±æ˜¯æ‹‰é“¾æ³•è§£å†³å“ˆå¸Œå†²çªã€‚ç›¸è¾ƒäºjdkçš„hashmapï¼Œè¿™é‡Œçš„æ‰©å®¹æœºåˆ¶æœ‰å¾ˆå¤§ä¸åŒã€‚\n\n**æ¸è¿›å¼æ‰©å®¹**\nå¯¹äºredisæ¥è¯´ï¼Œç”±äºæ˜¯å•çº¿ç¨‹ï¼Œhashmapæ‰©å®¹ä¼šå¯¼è‡´çº¿ç¨‹é˜»å¡ï¼Œå½±å“æ€§èƒ½ï¼Œæ‰€ä»¥é‡‡ç”¨äº†æ¸è¿›å¼hashã€‚æ¯å½“éœ€è¦è¿›è¡Œæ‰©å®¹çš„æ—¶å€™ä¸ä¼šç«‹åˆ»ä¸€æ¬¡æ€§å…¨éƒ¨æ‰©å®¹ï¼Œè€Œæ˜¯åŒæ—¶åˆ›å»ºä¸€ä¸ªä¸¤å€å¤§å°çš„hashmapï¼Œåœ¨ä»¥åçš„æ¯ä¸€æ¬¡è¯·æ±‚ä¸­ï¼Œéƒ½ä¼šç§»åŠ¨ä¸€éƒ¨åˆ†æ•°æ®ä»æ—§çš„hashmapåˆ°æ–°çš„hashmapä¸­ï¼Œæ–°å¢çš„æ•°æ®å°±ç›´æ¥å†™åœ¨æ–°è¡¨ä¸Šã€‚\n\nè¿™æ ·å°†ä¸€æ¬¡æ‰©å®¹å¹³å¦åˆ°æ¯æ¬¡è¯·æ±‚ä¸­ï¼Œå®Œæˆæ‰©å®¹çš„åŒæ—¶ä¹Ÿæ²¡æœ‰ä¸¥é‡å½±å“æ€§èƒ½ã€‚ä½†æ˜¯æ­¤æ—¶getä¸€ä¸ªæ•°æ®å°±éœ€è¦åœ¨ä¸¤ä¸ªè¡¨ä¸Šéƒ½è¦æ‰¾ã€‚\n\n## sorted setå’Œè·³è¡¨\nzsetæ˜¯æŒ‰ç…§åˆ†æ•°scoreæœ‰åºæ’åˆ—çš„é›†åˆï¼Œåº•å±‚ä½¿ç”¨äº†ziplist+skiplistï¼Œå½“å…ƒç´ æ•°é‡å¤§äº128ä¸”å…ƒç´ é•¿åº¦å¤§äº64å­—èŠ‚çš„æ—¶å€™è‡ªåŠ¨æ‰©å±•ä¸ºè·³è¡¨ã€‚\n\n**è·³è¡¨**\n\nå•å‘é“¾è¡¨æŸ¥æ‰¾çš„æ—¶é—´å¤æ‚åº¦å¹³å‡ä¸ºo(n)ï¼Œè·³è¡¨ç”¨å¤šå±‚é“¾è¡¨å®ç°åœ¨å•å‘é“¾è¡¨ä¸ŠæŸ¥è¯¢çš„æ—¶é—´å¤æ‚åº¦é™ä½ä¸ºlogn\n\n<div style=\"text-align: center;\">\n  <img src=\"../img/Java/img_10.png\" alt=\"\" />\n</div>\n\næŸ¥è¯¢å°±åƒåäº†å¿«è½¦ï¼Œåªæœ‰å¤§ç«™åˆ°è¾¾ï¼ŒèŠ‚çº¦äº†ä¸å°‘éå†çš„æ—¶é—´ï¼Œä¸€èˆ¬æ¥è¯´ä¸Šä¸€å±‚çš„èŠ‚ç‚¹æ•°é‡æ˜¯ä¸‹ä¸€å±‚çš„ä¸€åŠï¼Œå½“éœ€è¦æ·»åŠ æ•°æ®çš„æ—¶å€™å¦‚ä½•ç¡®å®šè¿™ä¸ªèŠ‚ç‚¹çš„å±‚çº§å‘¢ã€‚å¦‚æœè¯´åŠ å…¥ä¸€ä¸ªèŠ‚ç‚¹é‚£ä¹ˆå®ƒåœ¨æœ€åº•å±‚çš„æ¦‚ç‡ä¸º100%ï¼Œç”±äºä¸Šé¢ä¸€å±‚çš„æ•°é‡æ˜¯ä¸€åŠï¼Œé‚£ä¹ˆä»–æ˜¯2å±‚èŠ‚ç‚¹çš„æ¦‚ç‡å°±ä¸º50%ï¼Œ3å±‚çš„å°±ä¸º25%ã€‚\n```java\n// éšæœºç”ŸæˆèŠ‚ç‚¹çš„å±‚æ•°\nprivate int randomLevel() {\n    int lvl = 0;\n    while (random.nextFloat() < P && lvl < MAX_LEVEL) {\n        lvl++;\n    }\n    return lvl;\n}\n```\n**ä¸ºä»€ä¹ˆç”¨è·³è¡¨è€Œä¸æ˜¯çº¢é»‘æ ‘æˆ–è€…bæ ‘**\n- hashmapçš„çº¢é»‘æ ‘ç»“æ„ä¸é€‚åˆèŒƒå›´æŸ¥æ‰¾ï¼Œzsetæœ‰ä¸ªå‘½ä»¤å°±æ˜¯æŸ¥è¯¢scoreåœ¨æŸä¸ªèŒƒå›´ä¹‹å†…çš„ï¼Œè€Œä¸”æŒ‡é’ˆæ•°é‡ä¹Ÿè¾ƒå°‘ï¼Œå®ç°éš¾åº¦è¾ƒä½\n- bæ ‘æ•°æ®ç»“æ„è¾ƒå¤§ï¼Œå†…å­˜ä¸å‹å¥½ã€‚èŠ‚ç‚¹åˆ†è£‚ç­‰å®ç°èµ·æ¥è¾ƒä¸ºå¤æ‚ã€‚\n\n## redisä¸ºä»€ä¹ˆè¿™ä¹ˆå¿«\n1. åŸºäºå•çº¿ç¨‹çš„ioé˜»å¡æ¨¡å‹ï¼Œèƒ½å¤Ÿé«˜æ•ˆçš„è¿›è¡Œç½‘ç»œio\n2. åŸºäºå†…å­˜ï¼Œä¸”æœ‰è‡ªå·±çš„vmï¼Œä¸ä¼šå¯¼è‡´è™šæ‹Ÿå†…å­˜é¢‘ç¹æ¢å…¥æ¢å‡º\n3. é«˜æ•ˆçš„æ•°æ®ç»“æ„\n\n## redisçš„å•çº¿ç¨‹ioå¤šè·¯å¤ç”¨æ¨¡å‹\n> select/poll/epollï¼š\n> è¿™ä¸‰ç§æ˜¯æ“ä½œç³»ç»Ÿæä¾›ç»™ç¨‹åºå‘˜çš„ç³»ç»Ÿè°ƒç”¨apiï¼Œepollåªæœ‰linuxå†…æ ¸å¯ä»¥ç”¨ï¼Œè¿™ä¸‰ä¸ªç³»ç»Ÿè°ƒç”¨å°è£…äº†ioå¤šè·¯å¤ç”¨æœºåˆ¶ï¼š\n> - selectï¼šå¯¹äºåˆ°æ¥çš„socketé“¾æ¥ï¼Œæ“ä½œç³»ç»Ÿä¼šæŠŠå®ƒæŒ‰ç…§ç‰¹å®šçš„æ•°æ®ç»“æ„ç»„ç»‡æˆä¸€ä¸ªæ–‡ä»¶ï¼ˆè¿™ä¸ªæ–‡ä»¶ä¸­å…ƒç´ çš„æ•°é‡æ˜¯æœ‰ä¸Šé™çš„ï¼Œä¸º1024ï¼‰ï¼Œselectæ“ä½œå°†è¿™ä¸ªæ–‡ä»¶ç»™å†…æ ¸æ€è¿›è¡Œéå†ï¼Œæ ¹æ®è¿™äº›æ•°æ®ç»“æ„çš„çŠ¶æ€æ‰¾åˆ°éœ€è¦è¿›è¡Œå¤„ç†çš„socketç„¶åæ ‡è®°ï¼Œå†è¿”å›ç»™ç”¨æˆ·æ€ã€‚è¿™æ ·çš„ä¼˜ç‚¹æ˜¯ç®€å•ç›´æ¥ï¼Œç¼ºç‚¹æ˜¯æ‰¾åˆ°éœ€è¦å¤„ç†çš„socketæ—¶é—´å¤æ‚åº¦å¤§ï¼Œè€Œä¸”èƒ½å¤Ÿå¤„ç†çš„socketæœ‰é™ï¼Œæ‰€ä»¥ä»…ä»…æ”¯æŒå°è§„æ¨¡çš„ioå¤šè·¯å¤ç”¨\n> - pollï¼šæ˜¯selectçš„å‡çº§ç‰ˆï¼Œä¸»è¦æ˜¯å°†1024è¿™ä¸ªä¸Šçº¿å–æ¶ˆäº†ï¼Œä½¿ç”¨äº†é“¾è¡¨å°±æ²¡æœ‰ä¸Šé™äº†ï¼Œå…¶ä½™ä»ç”¨æˆ·æ€åˆ°å†…æ ¸æ€å¤„ç†ï¼Œä»å†…æ ¸æ€åˆ°ç”¨æˆ·æ€éƒ½æ˜¯ä¸€æ ·çš„ï¼Œéƒ½éœ€è¦éå†ä¸¤æ¬¡ï¼Œæ•ˆç‡è¾ƒä½ã€‚\n> - epollï¼šé¦–å…ˆæ˜¯å¯¹äºæ•°æ®ç»“æ„çš„å¤„ç†ï¼Œepollåœ¨å†…æ ¸æ€ç»´æŠ¤äº†ä¸€ä¸ªçº¢é»‘æ ‘ï¼Œä½¿å¾—å¤„ç†socketä¸ç”¨æ¯æ¬¡éƒ½åœ¨ä¸¤ä¸ªæ€ä¹‹é—´æ¯æ¬¡éƒ½å¤åˆ¶ï¼Œä»…ä»…æ˜¯å°†æ–°å¢çš„åŠ å…¥çº¢é»‘æ ‘ï¼Œè€Œä¸”æŸ¥è¯¢æ•ˆç‡ä¹Ÿå¾ˆé«˜ï¼›å…¶æ¬¡æ˜¯é‡‡ç”¨äº†äº‹ä»¶é©±åŠ¨çš„æ–¹æ³•ï¼Œå¹¶ä¸ä¼šåƒselect/pollé‚£æ ·è½®è¯¢ï¼Œè¿™é‡Œæ˜¯ç›´æ¥é˜»å¡ï¼Œç­‰æœ‰æ¶ˆæ¯å†é€šçŸ¥ï¼Œæ˜¯ä¸€ç§é˜»å¡çš„æ–¹å¼ã€‚\n> - æ°´å¹³è§¦å‘å’Œè¾¹ç¼˜è§¦å‘ï¼šæ°´å¹³è§¦å‘æ˜¯æœ‰äº‹ä»¶æ¥äº†å°±ä¸€ç›´é€šçŸ¥ï¼Œç›´åˆ°äº‹ä»¶è¢«å¤„ç†ï¼›è¾¹ç¼˜è§¦å‘æ˜¯åªé€šçŸ¥ä¸€æ¬¡ï¼Œä½†æ˜¯æ¶ˆæ¯å¯èƒ½ä¼šä¸¢å¤±ã€‚\n\nredisåŸºäºreactoræ¨¡å¼å»ºç«‹äº†ä¸€å¥—é«˜æ•ˆçš„å•çº¿ç¨‹ioæ¨¡å‹ï¼ˆè¿™é‡Œçš„å•çº¿ç¨‹æŒ‡çš„æ˜¯ä»socketåˆ°epollå‘ç°åˆ°æ‰§è¡Œå™¨å¤„ç†çš„æµç¨‹æ˜¯å•çº¿ç¨‹ï¼‰ï¼Œä¸»è¦ç»„ä»¶æœ‰ï¼š\n- å¤šä¸ªsocketï¼ˆå¤šä¸ªå®¢æˆ·ç«¯è¯·æ±‚ï¼Œå››å…ƒç»„å³ä¸ºä¸€ä¸ªsocketï¼‰\n- ioå¤šè·¯å¤ç”¨ï¼šredisæ˜¯åŸºäºepollçš„ï¼Œå®ç°äº‹ä»¶é©±åŠ¨çš„ç›‘å¬æœºåˆ¶\n- äº‹ä»¶åˆ†æ´¾å™¨ï¼šæ ¹æ®epoll_waitç›‘å¬åˆ°çš„socketäº‹ä»¶æ¥å†³å®šæ¥ä¸‹æ¥çš„æ‰§è¡Œé€»è¾‘\n- äº‹ä»¶æ‰§è¡Œé€»è¾‘ï¼šæœ‰acceptï¼Œreadï¼Œwriteã€‚accepté€»è¾‘æ˜¯æ ¹æ®æ–°æ¥çš„socketåŠ å…¥çº¢é»‘æ ‘ç»´æŠ¤å¹¶ç›‘å¬\n\n<div style=\"text-align: center;\">\n  <img src=\"../img/Java/img_11.png\" alt=\"\" />\n</div>\n\n## redisæŒä¹…åŒ–\n- rdbï¼šå°†å½“å‰çš„redisæ•°æ®å‹ç¼©æˆä¸€ä¸ªrdbæ–‡ä»¶ï¼Œåœ¨æ–‡ä»¶å‹ç¼©çš„è¿‡ç¨‹ä¸­ï¼ˆsaveï¼‰ä¼šé˜»å¡ä¸»çº¿ç¨‹ï¼Œä½†æ˜¯å¯ä»¥é‡‡ç”¨bgsaveçš„æ–¹å¼ï¼Œå¼€è¾Ÿä¸€ä¸ªæ–°çš„çº¿ç¨‹æ‰§è¡Œã€‚ä¼˜ç‚¹æ˜¯æ•°æ®å½¢æˆçš„æ–‡ä»¶dumpæ ¼å¼ç´§å‡‘ï¼Œredisæ¢å¤é€Ÿåº¦å¿«ï¼›ç¼ºç‚¹æ˜¯åœ¨ä¸¤æ¬¡saveä¸­é—´å¯èƒ½ä¼šå¯¼è‡´ä¸¢æ•°æ®ï¼Œéœ€è¦forkä¸€ä¸ªçº¿ç¨‹æ¥è¿›è¡Œsaveæ“ä½œ\n- aofï¼šç±»ä¼¼è®°å½•æ—¥å¿—ï¼Œæ¯æ¬¡æ“ä½œéƒ½éœ€è¦ä¿å­˜ã€‚ä¼˜ç‚¹æ˜¯å®æ—¶æ€§æ¯”rdbè¦å¥½ï¼Œä¸å®¹æ˜“ä¸¢æ•°æ®ï¼›ç¼ºç‚¹æ˜¯æ–‡ä»¶å çš„åœ°æ–¹å¾ˆå¤§ï¼Œå¯èƒ½å¶å°”è¿˜éœ€è¦ä¸€ä¸ªå‹ç¼©çº¿ç¨‹æ¥å‹ç¼©ï¼Œæ¢å¤é€Ÿåº¦ä¹Ÿæ¯”dump.rdbæ…¢\n\n**aofçš„åˆ·ç›˜æ–¹å¼**ï¼š\n- alwaysï¼šæ¯æ¬¡æ“ä½œå®Œå°±åˆ·ç›˜ä¸€æ¡aof\n- everysecï¼šæ¯ä¸€ç§’é’Ÿåˆ·ç›˜ä¸€æ¬¡\n- noï¼šä¸ä¸»åŠ¨åˆ·ç›˜ï¼Œé æ“ä½œç³»ç»Ÿæ¥åˆ·ç›˜\n\n**aofä¸ºä»€ä¹ˆæ˜¯ä¸€æ¡å‘½ä»¤æ‰§è¡Œå®Œäº†æ‰è§¦å‘**ï¼š\n1. æœ‰å¯èƒ½å‘½ä»¤æ˜¯é”™è¯¯çš„ï¼Œåªæœ‰æ­£ç¡®çš„å‘½ä»¤ä¼šaof\n2. ä¸ä¼šé˜»å¡å½“å‰çš„ä»»åŠ¡\n3. ç¼ºç‚¹æ˜¯åç€æ¥çš„ï¼Œä¸é˜»å¡å½“å‰ä»»åŠ¡ä½†æ˜¯ä¼šé˜»å¡ä¸‹æ¡ä»»åŠ¡ï¼Œæœ‰å¯èƒ½æ‰§è¡Œæ ¡éªŒå®Œäº†æ‰§è¡Œå®Œäº†ï¼Œä½†æ˜¯å‡ºç°å¼‚å¸¸ä½¿å¾—æ•°æ®ä¸¢å¤±æ²¡æœ‰å­˜å‚¨\n\n**rdbçš„æœºåˆ¶**ï¼š\nbgsaveï¼šcopyonwirte\nsaveï¼šsave 50 1000ï¼Œ50sæœ‰1000æ¡å˜åŒ–å°±è§¦å‘\n\n## è¿‡æœŸåˆ é™¤\n- å®šæ—¶æ¸…é™¤ï¼šåœ¨è®¾ç½®keyçš„è¿‡æœŸæ—¶é—´çš„åŒæ—¶ç»™ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œè¿‡æœŸäº†å®šæ—¶ä»»åŠ¡åˆ é™¤ã€‚è¿™ç§ç­–ç•¥å¯¹äºcpuä¸å‹å¥½ï¼Œè¿˜éœ€è¦ç›‘æ§æ¯ä¸€ä¸ªkeyçš„å‰©ä½™æ—¶é—´\n- æƒ°æ€§åˆ é™¤ï¼šè¿‡æœŸäº†ä¸ä¼šç«‹å³åˆ é™¤ï¼Œç›´åˆ°æœ‰è®¿é—®çš„æ—¶å€™æŸ¥è¯¢è¿‡æœŸæ—¶é—´è¡¨ï¼Œè¿‡æœŸäº†å°±åˆ é™¤ï¼Œè¿”å›ç©ºå€¼ã€‚ç¼ºç‚¹æ˜¯å¯¹äºå†…å­˜ä¸å‹å¥½\n- å®šæœŸåˆ é™¤ï¼šæ ¹æ®æŸä¸ªæ—¶é—´è¿›è¡Œå®šæœŸåˆ é™¤ï¼Œç®—æ˜¯ä¸Šé¢ä¸¤ç§çš„æŠ˜ä¸­æ–¹æ¡ˆ\n\nredisæ˜¯æƒ°æ€§åˆ é™¤å’Œå®šæœŸåˆ é™¤ç›¸ç»“åˆçš„è¿‡æœŸåˆ é™¤ç­–ç•¥ï¼Œæ ¹æ®cpuè¿è½½æƒ…å†µé€‰æ‹©ç­–ç•¥ï¼Œå¯¹äºå®šæœŸåˆ é™¤æ˜¯éšæœºæŒ‘é€‰ä¸€äº›keyæ£€æŸ¥è¿‡æœŸæƒ…å†µï¼Œå…¶ä¸­è¿‡æœŸçš„åˆ é™¤ï¼Œä½†æ˜¯å½“è¿™ä¸ªæ¯”ä¾‹å¤§äºæŸä¸ªé˜ˆå€¼çš„æ—¶å€™rediså°±è®¤ä¸ºæœ‰å¤§é‡è¿‡æœŸkeyéœ€è¦å¤„ç†ï¼Œå› æ­¤ä¼šç«‹å³åšä¸€æ¬¡åˆ é™¤ï¼Œä»¥æ­¤ç±»æ¨ã€‚\n\n## å†…å­˜æ·˜æ±°ç­–ç•¥\n1. volatile-lru\n2. volatile-lfu\n3. volatile-random\n4. volatile-ttl\n5. all-lru\n6. all-lfu\n7. all-random\n8. no-evictionï¼šé»˜è®¤çš„ç­–ç•¥ï¼Œæ»¡äº†ä¼šæŠ¥é”™ï¼Œé©±é€æ–°è¯·æ±‚\n\n## ä¸»ä»å¤åˆ¶\n### å…¨é‡å¤åˆ¶\n1. ä»æœåŠ¡å™¨å‘ä¸»æœåŠ¡å™¨å‘é€replicaofå‘½ä»¤ï¼Œå‚æ•°æ˜¯è‡ªå·±çš„ipåœ°å€ï¼Œè¯·æ±‚ä¸»æœºçš„å”¯ä¸€id\n2. ä¸»æœºæ”¶åˆ°äº†ä¹‹åè¿”å›è‡ªå·±çš„runidå’Œå½“å‰å¤åˆ¶çš„offset\n3. æ¥ç€ä¸»æœºå¼€å§‹bgsaveè‡ªå·±çš„rdbæ–‡ä»¶ï¼Œä¸ä»æœºåŒæ­¥ï¼Œæ¯æ¬¡å¤åˆ¶éƒ½ä¼šæœ‰ä¸€ä¸ªoffset\n4. åœ¨å¤åˆ¶çš„è¿‡ç¨‹ä¸­å¯èƒ½ä¹Ÿä¼šæœ‰æ–°çš„æ•°æ®ï¼Œæ­¤æ—¶ä¸»æœºä¼šç”¨ä¸€ä¸ªç¼“å†²åŒºç¼“å­˜è¿™éƒ¨åˆ†æ•°æ®\n5. ä»æœºæ¥å—å®Œæˆåï¼Œä¸»æœºå†æŠŠåˆšåˆšç¼“å†²åŒºçš„ä¼ ç»™ä»æœºå™¨\n\n### å¢é‡å¤åˆ¶\nä¸»æœºä¼šç»´æŠ¤ä¸€ä¸ªç¯å½¢ç¼“å†²åŒºï¼Œå‚¨å­˜æœ€è¿‘çš„æ“ä½œã€‚å¦‚æœè¿™ä¸ªç¯å½¢ç¼“å†²åŒºæ»¡äº†å°±è¯´æ˜æœ‰çš„è¯·æ±‚æ¢å¤ä¸äº†äº†ï¼Œéœ€è¦é‡æ–°è¿›è¡Œå¢é‡å¤åˆ¶ã€‚å¦‚æœæ²¡æœ‰æ»¡ï¼Œå°±ä¼šç”¨åˆ°ä¸Šé¢è¯´çš„é‚£ä¸ªoffsetè¿›è¡Œå¢é‡å¤åˆ¶ã€‚å¢é‡å¤åˆ¶çš„æ—¶é—´å¾ˆçŸ­ï¼Œæ¯•ç«Ÿåªç”¨ä¼ æ‰çº¿æ—¶é—´ä¸¢å¤±çš„ä¸€éƒ¨åˆ†æ•°æ®ã€‚\n\nè¿™ä¸ªç¼“å†²åŒºçš„å¤§å°åº”è¯¥è®¾ç½®ä¸ºæ¯”æ‰çº¿æ¢å¤æ—¶é—´*å¹³å‡è¾“å…¥æ•°æ®ç¨å¤§ï¼Œè¿™æ ·å°±å¯ä»¥é¿å…ä¸¢å¤±æ•°æ®è€Œå…¨é‡å¤åˆ¶\n\n## å“¨å…µæœºåˆ¶\n> å“¨å…µä¹Ÿæ˜¯é›†ç¾¤ï¼Œé›†ç¾¤ç®¡ç†é›†ç¾¤\n\n**ä¸»å®˜ä¸‹çº¿å’Œå®¢è§‚ä¸‹çº¿**\n\nredisé›†ç¾¤é€šè¿‡å¿ƒè·³æœºåˆ¶ï¼ˆping-pongï¼‰æ¥æ£€æµ‹æœåŠ¡å™¨æ˜¯å¦å­˜æ´»ï¼Œå“¨å…µå®šæœŸä¸æœåŠ¡å™¨å®ä¾‹è¿›è¡Œæ£€æµ‹ï¼Œå½“æŸä¸€ä¸ªå“¨å…µå‘ç°ä¸»æœåŠ¡å™¨æ²¡æœ‰åœ¨è§„å®šæ—¶é—´å†…è¿”å›pongï¼Œå°±ä¼šè®¤ä¸ºè¿™ä¸ªæœåŠ¡å™¨ä¸‹çº¿äº†ï¼Œè¿™å°±æ˜¯ä¸»è§‚ä¸‹çº¿ï¼š\n\nä½†æ˜¯è¿™ä¹Ÿæœ‰å¯èƒ½æ˜¯ç”±äºç½‘ç»œä¿¡é“ä¸¢å¤±æ¶ˆæ¯ï¼Œæœªå¿…æ˜¯ä¸»æœåŠ¡å™¨çœŸçš„å®•æœºäº†ï¼Œæ‰€ä»¥è¿˜éœ€è¦å…¶ä»–å“¨å…µå¯¹å…¶è¿›è¡Œåˆ¤æ–­ï¼Œå½“è¶…è¿‡å‚æ•°quorumçš„å“¨å…µè®¤ä¸ºæ˜¯ä¸‹çº¿äº†ï¼Œé‚£ä¹ˆå°±ä¼šè¢«è®¤ä¸ºæ˜¯å®¢è§‚ä¸‹çº¿ï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦è¿›è¡Œæ•…éšœè½¬ç§»ã€‚\n\n**é€‰ä¸¾å’Œæ•…éšœè½¬ç§»**\n\næ—¢ç„¶ä¸»èŠ‚ç‚¹å‘ç”Ÿäº†æ•…éšœï¼Œé‚£ä¹ˆç”±è°æ¥è¿›è¡Œæ•…éšœè½¬ç§»å‘¢ã€‚é‚£å½“ç„¶æ˜¯æœ€å…ˆå‘ç°æ•…éšœçš„å“¨å…µï¼Œä½†ä¹Ÿå¯ä»¥æ˜¯ä¸¤ä¸ªå“¨å…µåŒæ—¶å‘ç°äº†æ•…éšœï¼Œè¿™ä¸ªæ—¶å€™å°±è¦é€‰ä¸¾äº†ï¼Œæ¯ä¸ªå“¨å…µåªæœ‰ä¸€ä¸ªé€‰ç¥¨ï¼Œè‡ªå·±å‘ç°çš„éœ€è¦æˆ‘é€‰æˆ‘ï¼Œå½“å“¨å…µè·å¾—çš„é€‰ç¥¨å¤§äºåŠæ•°ä¸”ä¹Ÿè¦å¤§äºquorumçš„æ—¶å€™å°±è¢«é€‰ä¸¾ä¸ºæ•…éšœè½¬ç§»çš„èŠ‚ç‚¹ã€‚\n\næ¥ä¸‹æ¥å°±ç”±è¿™ä¸ªèŠ‚ç‚¹è¿›è¡Œæ•…éšœè½¬ç§»ï¼š\n1. ä¸»èŠ‚ç‚¹å‘¨å›´çš„ä»èŠ‚ç‚¹é€‰ä¸€ä¸ªä½œä¸ºä¸‹ä¸ªä¸»èŠ‚ç‚¹ï¼Œè¿›è¡Œè½¬ç§»ï¼šé¦–å…ˆè¿‡æ»¤ç½‘ç»œçŠ¶æ€ä¸å¥½çš„ï¼›å†æŒ‰ç…§ä¼˜å…ˆçº§ï¼Œå¤åˆ¶è¿›åº¦ï¼Œidå·è¿›è¡Œæ‹©ä¼˜ã€‚ï¼ˆç½‘ç»œçŠ¶æ€æœ‰ä¸€ä¸ªä¸»ä»å¤åˆ¶çš„æ–­è¿æ¬¡æ•°ï¼Œæ ¹æ®è¿™ä¸ªå¯ä»¥æ’é™¤ç½‘ç»œçŠ¶æ€ï¼‰\n2. å…¶ä»–çš„ä»èŠ‚ç‚¹å…¨éƒ¨ä¿®æ”¹ä¸ºreplicaofè¿™ä¸ªèŠ‚ç‚¹\n3. è®¢é˜…è€…é€šçŸ¥é¢‘é“å‘Šè¯‰å®¢æˆ·ç«¯è¿›è¡Œäº†æ”¹å˜\n4. ç»§ç»­ç›‘è§†è¢«æ›¿æ¢çš„è¿™ä¸ªä¸»æœºï¼Œå¦‚æœä¸Šçº¿äº†å°±è®©ä»–å˜æˆä»æœº\n\n## å¤§keyé—®é¢˜\nä»€ä¹ˆæ˜¯å¤§keyï¼Œä¸€èˆ¬æ¥è¯´Stringå ç”¨å¤§äº1MBï¼Œæˆ–è€…listï¼ŒHashï¼Œzsetï¼Œseté•¿åº¦å¤§äº5000ä¸ªä¼šè¢«è®¤ä¸ºæ˜¯å¤§keyã€‚Stringè¿™ç§æƒ…å†µå¾ˆå¯èƒ½æ˜¯å› ä¸ºå­˜å‚¨äº†äºŒè¿›åˆ¶æ–‡ä»¶æ•°æ®ï¼Œå…¶ä»–é¡ºåºç»“æ„æœ‰å¯èƒ½æ˜¯æ²¡æœ‰è®¾è®¡å¥½è¡¨å¯¼è‡´å­˜å‚¨äº†è¿‡å¤šæ•°æ®ã€‚\n\nåŸå› ï¼š\n- ç¨‹åºè®¾è®¡ä¸å½“ï¼Œä½¿ç”¨Stringå­˜å‚¨äº†äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆSDSæ˜¯å¯ä»¥å­˜Base64çš„ï¼‰\n- ä¸šåŠ¡è§„æ¨¡çªç„¶å˜å¤§ï¼šå¯¼è‡´listç¼“å­˜äº†è¾ƒå¤šæ•°æ®\n- æ²¡æœ‰æ¸…é™¤ï¼Œä¾‹å¦‚å“ˆå¸Œè¡¨ç¼“å­˜äº†å¤§é‡æ²¡æœ‰ç”¨çš„æ•°æ®\n\nå±å®³ï¼š\n- å¤ªå¤§äº†è¯ä¼šé˜»å¡redisçº¿ç¨‹ï¼Œredisè„†å¼±çš„å•çº¿ç¨‹\n- ç½‘ç»œæ‹¥å¡ï¼Œä¸€ä¸ªå¤§keyå°±æ˜¯1MBï¼Œ1000ä¸ªç”¨æˆ·è¯·æ±‚å°±æ˜¯1GB\n\nå¦‚ä½•å‘ç°ï¼š\n- redisè‡ªå¸¦çš„--bigkeyså‚æ•°\n- scanå‘½ä»¤è‡ªå·±æ‰‹åŠ¨çœ‹ï¼Œæœ‰ç‚¹åƒredisè‡ªå¸¦çš„ä»»åŠ¡ç®¡ç†å™¨ï¼Œç»“åˆåˆ«çš„ä¸€äº›æŒ‡ä»¤å¯ä»¥æŸ¥çœ‹å„ç§valueçš„å¤§å°ã€‚è¿™ä¸ªå‘½ä»¤æ•ˆç‡æ¯”è¾ƒä½\n- ç¬¬ä¸‰æ–¹å¼€æºå·¥å…·\n- é˜¿é‡Œäº‘å†…åµŒçš„redisæœ‰å·¥å…·èƒ½ç®¡ç†å¤§key\n\nå¦‚ä½•è§£å†³ï¼š\n- å¤§çš„hashè¡¨å¯ä»¥æ‹†åˆ†ä¸ºå¤šä¸ªkeyï¼Œä½¿ç”¨äºŒæ¬¡å“ˆå¸Œæ‹†åˆ†ä¸ºå¤šä¸ªhash\n- æ‰‹åŠ¨æ¸…ç†å¤§çš„stringï¼ˆå…¶å®åœ¨redisæ¡Œé¢å®¢æˆ·ç«¯å°±å¯ä»¥æ‰‹åŠ¨æ¸…ç†äº†ï¼Œä¼°è®¡èƒŒåä¹Ÿæ˜¯è¿™ä¸€æ¡å‘½ä»¤ï¼‰\n- é‡‡ç”¨åˆé€‚çš„æ•°æ®ç»“æ„ï¼šä¸è¦æ‹¿stringæ¥å­˜ç…§ç‰‡æˆ–è€…æ–‡æœ¬\n\n\n> redisé‡Œæœ‰ä¸€ä¸ªéå¸¸å¤§çš„keyï¼Œæ¯”å¦‚ä¸€ä¸ªsetï¼Œseté‡Œé¢å¯èƒ½æœ‰å‡ äº¿æ¡æ•°æ®ï¼Œæˆ‘ç°åœ¨éœ€è¦æŠŠè¿™ä¸ªkeyåˆ æ‰ï¼Œä½ ä¼šæ€ä¹ˆåšï¼Ÿ\n> ä¸€èˆ¬æƒ…å†µä¸‹delæ˜¯åŒæ­¥åˆ é™¤ï¼Œæ‰‹åŠ¨æ¸…ç†ä¼šé˜»å¡ã€‚åœ¨4.0ç‰ˆæœ¬ä»¥ä¸Šæä¾›äº†ä¸€ä¸ªunlinkå‘½ä»¤ï¼Œå¯ä»¥å¼‚æ­¥åˆ é™¤ã€‚éå¾—ç”¨delçš„è¯å¯ä»¥å…ˆæŠŠå…¶äºŒæ¬¡å“ˆå¸Œåˆ°ä¸åŒsetï¼Œå¤§äº‹åŒ–å°ã€‚\n\n\n## redisçš„é˜»å¡åŸå› \n1. ä½¿ç”¨äº†o(n)çš„å‘½ä»¤ï¼Œä¾‹å¦‚keysï¼Œè¿™ä¸ªä¼šåœ¨å…¨è¡¨æ‰¾keyåŒ¹é…ï¼Œè¿˜æœ‰ä¸€äº›æŸ¥è¯¢èŒƒå›´çš„æ•°æ®ï¼ˆzseté‚£äº›ï¼Œè¿™ä¸ªæ—¶å€™åˆè¦åŸå”±è·³è¡¨çš„å¥½å¤„äº†ï¼‰\n2. å¤§key\n3. æŒä¹…åŒ–ï¼šrdbçš„saveä¼šé˜»å¡ï¼Œbgsaveä¸ä¼šï¼›aofä¼šé˜»å¡ä¸‹ä¸€æ¡ï¼Œé‡å†™ä¹Ÿä¼šé˜»å¡ï¼ˆå°±æ˜¯å‹ç¼©aofå¤§å°çš„é‚£ä¸ªæ“ä½œï¼‰\n4. é›†ç¾¤åº“å®¹ç­‰å„ç§ç¡¬ä»¶é—®é¢˜\n5. swapï¼šå°±æ˜¯è™šæ‹Ÿå†…å­˜é‚£ä¸€å¥—ï¼Œç£ç›˜æ¢å†…å­˜ï¼Œè¿™å¯¹äºredisä¹Ÿæ˜¯å¾ˆè‡´å‘½çš„ã€‚rediså¿«çš„å…¶ä¸­ä¸€æ¡åŸå› å°±æ˜¯åœ¨å†…å­˜ä¸­ã€‚å› æ­¤éœ€è¦ç¦æ­¢å¤§é‡swapã€‚\n\n## çƒ­keyé—®é¢˜\nçªå¦‚å…¶æ¥çš„é›†ä¸­è®¿é—®æŸå‡ ä¸ªkeyï¼Œå¤„ç†ä¸å¥½ä¼šå¯¼è‡´ç¼“å­˜å‡»ç©¿ã€‚\n\nå¦‚ä½•å‘ç°ï¼š\n- redisè‡ªå¸¦çš„å‚æ•°--hotkeysï¼Œä½†æ˜¯ç”¨è¿™ä¸ªçš„å‰ææ˜¯å†…å­˜æ›¿æ¢ç­–ç•¥è¦é€‰lfuç›¸å…³çš„ï¼ˆå¯èƒ½æ˜¯å› ä¸ºæœ‰äº†lfuæ‰å¼€å¯äº†é¢‘ç‡è®¡ç®—å§ï¼‰\n- å¼€æºå·¥å…·\n- monitorå‘½ä»¤ï¼Œå¯ä»¥ç›‘æ§rediså½“å‰çš„ä¸€äº›å‘½ä»¤ï¼Œè‡ªå·±è§‚å¯ŸæŸäº›keyçš„é¢‘ç‡æ‰‹åŠ¨è§£å†³ã€‚\n\nå¦‚ä½•è§£å†³ï¼š\n- è¯»å†™åˆ†ç¦»ä¸»ä»æ¶æ„\n- redis clusterï¼šå“ˆå¸Œæ§½ï¼Œå¤šä¸ªçƒ­ç‚¹æ•°æ®åˆ†æ•£åœ¨å¤šä¸ªåº“\n- äºŒçº§ç¼“å­˜\n\n","tags":["Redis"]},{"title":"åˆ†å¸ƒå¼é¢è¯•ç¯‡","url":"/2024/09/14/åˆ†å¸ƒå¼é¢è¯•ç¯‡/","content":"## ä¸€è‡´æ€§å“ˆå¸Œ\nä¼ ç»Ÿçš„å“ˆå¸Œå–æ¨¡æ“ä½œæ˜¯åŸºäºå½“å‰æœåŠ¡å™¨æ•°é‡çš„ï¼Œä¾‹å¦‚æœ‰ä¸‰å°æœåŠ¡å™¨ï¼Œæ¯æ¬¡ç®—å“ˆå¸Œå€¼å°±å¯¹è¿™ä¸‰ä¸ªå–æ¨¡ï¼Œç”±äºæ¨¡åªå¯èƒ½æ˜¯0ï¼Œ1ï¼Œ2ã€‚\n\nä¸Šè¿°HASHç®—æ³•æ—¶ï¼Œä¼šå‡ºç°ä¸€äº›ç¼ºé™·ï¼šå¦‚æœæœåŠ¡å™¨å·²ç»ä¸èƒ½æ»¡è¶³ç¼“å­˜éœ€æ±‚ï¼Œå°±éœ€è¦å¢åŠ æœåŠ¡å™¨æ•°é‡ï¼Œå‡è®¾æˆ‘ä»¬å¢åŠ äº†ä¸€å°ç¼“å­˜æœåŠ¡å™¨ï¼Œæ­¤æ—¶å¦‚æœä»ç„¶ä½¿ç”¨ä¸Šè¿°æ–¹æ³•å¯¹åŒä¸€å¼ å›¾ç‰‡è¿›è¡Œç¼“å­˜ï¼Œé‚£ä¹ˆè¿™å¼ å›¾ç‰‡æ‰€åœ¨çš„æœåŠ¡å™¨ç¼–å·å¿…å®šä¸åŸæ¥3å°æœåŠ¡å™¨æ—¶æ‰€åœ¨çš„æœåŠ¡å™¨ç¼–å·ä¸åŒï¼Œå› ä¸ºé™¤æ•°ç”±3å˜ä¸ºäº†4ï¼Œæœ€ç»ˆå¯¼è‡´æ‰€æœ‰ç¼“å­˜çš„ä½ç½®éƒ½è¦å‘ç”Ÿæ”¹å˜ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå½“æœåŠ¡å™¨æ•°é‡å‘ç”Ÿæ”¹å˜æ—¶ï¼Œæ‰€æœ‰ç¼“å­˜åœ¨ä¸€å®šæ—¶é—´å†…æ˜¯å¤±æ•ˆçš„ï¼Œå½“åº”ç”¨æ— æ³•ä»ç¼“å­˜ä¸­è·å–æ•°æ®æ—¶ï¼Œåˆ™ä¼šå‘åç«¯æœåŠ¡å™¨è¯·æ±‚æ•°æ®ï¼›åŒç†ï¼Œå‡è®¾çªç„¶æœ‰ä¸€å°ç¼“å­˜æœåŠ¡å™¨å‡ºç°äº†æ•…éšœï¼Œé‚£ä¹ˆæˆ‘ä»¬åˆ™éœ€è¦å°†æ•…éšœæœºå™¨ç§»é™¤ï¼Œé‚£ä¹ˆç¼“å­˜æœåŠ¡å™¨æ•°é‡ä»3å°å˜ä¸º2å°ï¼ŒåŒæ ·ä¼šå¯¼è‡´å¤§é‡ç¼“å­˜åœ¨åŒä¸€æ—¶é—´å¤±æ•ˆï¼Œé€ æˆäº†ç¼“å­˜çš„é›ªå´©ï¼Œåç«¯æœåŠ¡å™¨å°†ä¼šæ‰¿å—å·¨å¤§çš„å‹åŠ›ï¼Œæ•´ä¸ªç³»ç»Ÿå¾ˆæœ‰å¯èƒ½è¢«å‹å®ã€‚ä¸ºäº†è§£å†³è¿™ç§æƒ…å†µï¼Œå°±æœ‰äº†ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•ã€‚\n\nä¸€è‡´æ€§å“ˆå¸Œç®—æ³•ä¹Ÿæ˜¯ä½¿ç”¨å–æ¨¡çš„æ–¹æ³•ï¼Œä½†æ˜¯å–æ¨¡ç®—æ³•æ˜¯å¯¹æœåŠ¡å™¨çš„æ•°é‡è¿›è¡Œå–æ¨¡ï¼Œè€Œä¸€è‡´æ€§å“ˆå¸Œç®—æ³•æ˜¯å¯¹ 2^32 å–æ¨¡ï¼Œå…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š\n\næ­¥éª¤ä¸€ï¼šä¸€è‡´æ€§å“ˆå¸Œç®—æ³•å°†æ•´ä¸ªå“ˆå¸Œå€¼ç©ºé—´æŒ‰ç…§é¡ºæ—¶é’ˆæ–¹å‘ç»„ç»‡æˆä¸€ä¸ªè™šæ‹Ÿçš„åœ†ç¯ï¼Œç§°ä¸º Hash ç¯ï¼›\næ­¥éª¤äºŒï¼šæ¥ç€å°†å„ä¸ªæœåŠ¡å™¨ä½¿ç”¨ Hash å‡½æ•°è¿›è¡Œå“ˆå¸Œï¼Œå…·ä½“å¯ä»¥é€‰æ‹©æœåŠ¡å™¨çš„IPæˆ–ä¸»æœºåä½œä¸ºå…³é”®å­—è¿›è¡Œå“ˆå¸Œï¼Œä»è€Œç¡®å®šæ¯å°æœºå™¨åœ¨å“ˆå¸Œç¯ä¸Šçš„ä½ç½®\næ­¥éª¤ä¸‰ï¼šæœ€åä½¿ç”¨ç®—æ³•å®šä½æ•°æ®è®¿é—®åˆ°ç›¸åº”æœåŠ¡å™¨ï¼šå°†æ•°æ®keyä½¿ç”¨ç›¸åŒçš„å‡½æ•°Hashè®¡ç®—å‡ºå“ˆå¸Œå€¼ï¼Œå¹¶ç¡®å®šæ­¤æ•°æ®åœ¨ç¯ä¸Šçš„ä½ç½®ï¼Œä»æ­¤ä½ç½®æ²¿ç¯é¡ºæ—¶é’ˆå¯»æ‰¾ï¼Œç¬¬ä¸€å°é‡åˆ°çš„æœåŠ¡å™¨å°±æ˜¯å…¶åº”è¯¥å®šä½åˆ°çš„æœåŠ¡å™¨\nä¸‹é¢æˆ‘ä»¬ä½¿ç”¨å…·ä½“æ¡ˆä¾‹è¯´æ˜ä¸€ä¸‹ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•çš„å…·ä½“æµç¨‹ï¼š\n\nï¼ˆ1ï¼‰æ­¥éª¤ä¸€ï¼šå“ˆå¸Œç¯çš„ç»„ç»‡ï¼š\n\n<div style=\"text-align: center;\">\n  <img src=\"../img/Distributio/img.png\" alt=\"\" />\n</div>\n\nåœ†ç¯çš„æ­£ä¸Šæ–¹çš„ç‚¹ä»£è¡¨0ï¼Œ0ç‚¹å³ä¾§çš„ç¬¬ä¸€ä¸ªç‚¹ä»£è¡¨1ï¼Œä»¥æ­¤ç±»æ¨ï¼Œ2ã€3ã€4ã€5ã€6â€¦â€¦ç›´åˆ°2^32-1,ä¹Ÿå°±æ˜¯è¯´0ç‚¹å·¦ä¾§çš„ç¬¬ä¸€ä¸ªç‚¹ä»£è¡¨2^32-1ï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ªç”± 2^32 ä¸ªç‚¹ç»„æˆçš„åœ†ç¯ç§°ä¸ºhashç¯ã€‚\n\nï¼ˆ2ï¼‰æ­¥éª¤äºŒï¼šç¡®å®šæœåŠ¡å™¨åœ¨å“ˆå¸Œç¯çš„ä½ç½®ï¼š\n\nå“ˆå¸Œç®—æ³•ï¼šhashï¼ˆæœåŠ¡å™¨çš„IPï¼‰ % 2^32\n\nä¸Šè¿°å…¬å¼çš„è®¡ç®—ç»“æœä¸€å®šæ˜¯ 0 åˆ° 2^32-1 ä¹‹é—´çš„æ•´æ•°ï¼Œé‚£ä¹ˆä¸Šå›¾ä¸­çš„ hash ç¯ä¸Šå¿…å®šæœ‰ä¸€ä¸ªç‚¹ä¸è¿™ä¸ªæ•´æ•°å¯¹åº”ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿™ä¸ªæ•´æ•°ä»£è¡¨æœåŠ¡å™¨ï¼Œä¹Ÿå°±æ˜¯æœåŠ¡å™¨å°±å¯ä»¥æ˜ å°„åˆ°è¿™ä¸ªç¯ä¸Šï¼Œå‡è®¾æˆ‘ä»¬æœ‰ ABC ä¸‰å°æœåŠ¡å™¨ï¼Œé‚£ä¹ˆå®ƒä»¬åœ¨å“ˆå¸Œç¯ä¸Šçš„ç¤ºæ„å›¾å¦‚ä¸‹ï¼š\n\n<div style=\"text-align: center;\">\n  <img src=\"../img/Distributio/img_1.png\" alt=\"\" />\n</div>\n\n3ï¼‰æ­¥éª¤ä¸‰ï¼šå°†æ•°æ®æ˜ å°„åˆ°å“ˆå¸Œç¯ä¸Šï¼š\n\næˆ‘ä»¬è¿˜æ˜¯ä½¿ç”¨å›¾ç‰‡çš„åç§°ä½œä¸º keyï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨ä¸‹é¢ç®—æ³•å°†å›¾ç‰‡æ˜ å°„åœ¨å“ˆå¸Œç¯ä¸Šï¼šhashï¼ˆå›¾ç‰‡åç§°ï¼‰ % 2^32ï¼Œå‡è®¾æˆ‘ä»¬æœ‰4å¼ å›¾ç‰‡ï¼Œæ˜ å°„åçš„ç¤ºæ„å›¾å¦‚ä¸‹ï¼Œå…¶ä¸­æ©˜é»„è‰²çš„ç‚¹è¡¨ç¤ºå›¾ç‰‡ï¼š\n\n<div style=\"text-align: center;\">\n  <img src=\"../img/Distributio/img_2.png\" alt=\"\" />\n</div>\n\né‚£ä¹ˆï¼Œæ€ä¹ˆç®—å‡ºä¸Šå›¾ä¸­çš„å›¾ç‰‡åº”è¯¥è¢«ç¼“å­˜åˆ°å“ªä¸€å°æœåŠ¡ä¸Šé¢å‘¢ï¼Ÿæˆ‘ä»¬åªè¦ä»å›¾ç‰‡çš„ä½ç½®å¼€å§‹ï¼Œæ²¿é¡ºæ—¶é’ˆæ–¹å‘é‡åˆ°çš„ç¬¬ä¸€ä¸ªæœåŠ¡å™¨å°±æ˜¯å›¾ç‰‡å­˜æ”¾çš„æœåŠ¡å™¨äº†ã€‚æœ€ç»ˆï¼Œ1å·ã€2å·å›¾ç‰‡å°†ä¼šè¢«ç¼“å­˜åˆ°æœåŠ¡å™¨Aä¸Šï¼Œ3å·å›¾ç‰‡å°†ä¼šè¢«ç¼“å­˜åˆ°æœåŠ¡å™¨Bä¸Šï¼Œ4å·å›¾ç‰‡å°†ä¼šè¢«ç¼“å­˜åˆ°æœåŠ¡å™¨Cä¸Šã€‚\n\n**ä¸€è‡´æ€§ hash ç®—æ³•çš„ä¼˜ç‚¹**\n\nå‰é¢æåˆ°ï¼Œå¦‚æœç®€å•å¯¹æœåŠ¡å™¨æ•°é‡è¿›è¡Œå–æ¨¡ï¼Œé‚£ä¹ˆå½“æœåŠ¡å™¨æ•°é‡å‘ç”Ÿå˜åŒ–æ—¶ï¼Œä¼šäº§ç”Ÿç¼“å­˜çš„é›ªå´©ï¼Œä»è€Œå¾ˆæœ‰å¯èƒ½å¯¼è‡´ç³»ç»Ÿå´©æºƒï¼Œè€Œä½¿ç”¨ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•å°±å¯ä»¥å¾ˆå¥½çš„è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå› ä¸ºä¸€è‡´æ€§Hashç®—æ³•å¯¹äºèŠ‚ç‚¹çš„å¢å‡éƒ½åªéœ€é‡å®šä½ç¯ç©ºé—´ä¸­çš„ä¸€å°éƒ¨åˆ†æ•°æ®ï¼Œåªæœ‰éƒ¨åˆ†ç¼“å­˜ä¼šå¤±æ•ˆï¼Œä¸è‡³äºå°†æ‰€æœ‰å‹åŠ›éƒ½åœ¨åŒä¸€æ—¶é—´é›†ä¸­åˆ°åç«¯æœåŠ¡å™¨ä¸Šï¼Œå…·æœ‰è¾ƒå¥½çš„å®¹é”™æ€§å’Œå¯æ‰©å±•æ€§ã€‚\n\nå‡è®¾æœåŠ¡å™¨Bå‡ºç°äº†æ•…éšœï¼Œéœ€è¦å°†æœåŠ¡å™¨Bç§»é™¤ï¼Œé‚£ä¹ˆç§»é™¤å‰åçš„ç¤ºæ„å›¾å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\n\n<div style=\"text-align: center;\">\n  <img src=\"../img/Distributio/img_3.png\" alt=\"\" />\n</div>\n\n**ä¸€è‡´æ€§ hash ç®—æ³•çš„ç¼ºç‚¹**\n\nå¯èƒ½ä¼šå‡ºç°å€¾æ–œï¼Œå½“æœåŠ¡å™¨çš„å“ˆå¸Œå€¼éƒ½å¾ˆæ¥è¿‘å°±ä¼šå‡ºç°åœ¨ä¸€æ®µåŒºé—´é‡Œåˆ†å¸ƒç€å¤§é‡çš„æœåŠ¡å™¨ï¼Œåˆ†å¸ƒä¸å¤Ÿå‡åŒ€ã€‚å› æ­¤ä¹Ÿæœ‰äº†è™šæ‹ŸèŠ‚ç‚¹è¿™ä¸ªæ¦‚å¿µã€‚ä¹Ÿå°±æ˜¯å¯¹æœåŠ¡å™¨ç”¨å¤šä¸ªå“ˆå¸Œå‡½æ•°è¿›è¡Œå¤šæ¬¡è¿ç®—ï¼Œä½¿å…¶åˆ†å¸ƒæ›´åŠ å‡åŒ€ã€‚ã€\n\n> æ‰©å±•ï¼šå¦‚æœæœåŠ¡å™¨ä¹‹é—´æœ‰æƒé‡ï¼Œå¦‚ä½•è®¾è®¡è´Ÿè½½å‡è¡¡ç®—æ³•ï¼š\n> 1. è½®ç›˜èµŒï¼šå¤šä¸ªæœåŠ¡å™¨çš„æƒé‡æŒ‰ç™¾åˆ†æ¯”è¿›è¡Œåˆ†é…ï¼Œæ¯æ¬¡æœ‰è®¿é—®è¯·æ±‚å°±ç”Ÿæˆéšæœºæ•°ï¼Œè¿™æ ·æƒé‡å¤§çš„å°±æœ‰æ›´å¤§çš„æ¦‚ç‡è¢«é€‰ä¸­ã€‚ç¼ºç‚¹æ˜¯å¦‚æœæœåŠ¡å™¨è¿›è¡Œæ‰©å±•ï¼Œè¿™ä¸ªè§„åˆ™éœ€è¦æ›´æ”¹\n> 2. ä¸€è‡´æ€§å“ˆå¸Œçš„è™šæ‹ŸèŠ‚ç‚¹ï¼šå¯ä»¥æ ¹æ®æƒé‡åˆ†é…æ›´å¤šçš„è™šæ‹ŸèŠ‚ç‚¹ï¼Œä½†æ˜¯æ•ˆæœæœ‰å¾…éªŒè¯ï¼Œå› ä¸ºæ¯•ç«Ÿä¹Ÿæ˜¯éšæœºçš„ï¼Œå¢åŠ èŠ‚ç‚¹å¹¶ä¸ä¸€å®šå°±èƒ½è·å¾—æ›´å¤§çš„è®¿é—®èŒƒå›´ã€‚\n\n## åˆ†å¸ƒå¼é™æµç®—æ³•\n- å›ºå®šçª—å£è®¡æ•°å™¨ç®—æ³•ï¼šåœ¨ä¸€åˆ†é’Ÿå†…è®¾å®šnæ¬¡è®¿é—®é‡ï¼Œå¦‚æœè¶…è¿‡äº†næ¬¡å°±æ‹’ç»è®¿é—®ã€‚ç¼ºç‚¹æ˜¯é™æµä¸å¤Ÿå¹³æ»‘ï¼Œå¦‚æœåœ¨1åˆ†é’Ÿå†…å‰30ç§’å°±å¤„ç†äº†nä¸ªï¼Œåé¢åŠåˆ†é’Ÿå°±ç­‰äºç©ºè½¬ï¼›ä¹Ÿæ— æ³•ä¿è¯é™æµé€Ÿç‡å’Œæ”»å‡»ï¼Œå¦‚æœæœåŠ¡å™¨çš„æ‰¿è½½åŠ›å°±æ˜¯1åˆ†é’Ÿnä¸ªè¯·æ±‚ï¼Œåœ¨è¿™åˆ†é’Ÿçš„å30sç»™å‡ºnä¸ªè¯·æ±‚ï¼Œåé¢ä¸€åˆ†é’Ÿçš„å‰åŠéƒ¨åˆ†ç»™å‡ºnä¸ªï¼Œä¹Ÿèƒ½å°†æœåŠ¡å™¨å‡»å®\n- æ»‘åŠ¨çª—å£è®¡æ•°å™¨ç®—æ³•ï¼šåˆ’åˆ†çš„æ›´ç»†äº†ï¼Œä¾‹å¦‚åˆ’åˆ†ä¸€ç§’å¤šå°‘ä¸ªè¯·æ±‚ï¼Œè¿™æ ·å¯ä»¥åº”å¯¹çªå‘çš„è¯·æ±‚å¢å¤§ï¼Œä½†æ˜¯ä¹Ÿæœ‰ä¸å¹³æ»‘çš„é—®é¢˜ï¼Œä¹Ÿä¸å¥½æ§åˆ¶é€Ÿç‡\n- æ¼æ¡¶ç®—æ³•ï¼šè¯·æ±‚è¿›å…¥æ¡¶ï¼Œæ…¢æ…¢æ¼ä¸‹æ¥ï¼Œæ»¡äº†å°±ä¸¢å¼ƒè¯·æ±‚ã€‚è¿™æ ·ä¼˜ç‚¹æ˜¯å¯ä»¥æ§åˆ¶é€Ÿç‡ï¼Œä½†æ˜¯åŒæ—¶ä¹Ÿä¼šå¯¼è‡´æ¼è¯·æ±‚\n- ä»¤ç‰Œæ¡¶ç®—æ³•ï¼šæ¡¶é‡Œé¢æ˜¯ä»¤ç‰Œï¼Œå¯ä»¥é€šè¿‡æ§åˆ¶ä»¤ç‰Œçš„æµé€Ÿæ”¹å˜å¤„ç†é€Ÿåº¦\n\n<div style=\"text-align: center;\">\n  <img src=\"../img/Distributio/img_4.png\" alt=\"\" />\n</div>\n\n## åˆ†å¸ƒå¼IDç”Ÿæˆç®—æ³•\n- UUIDï¼šjdkè‡ªå¸¦å°±æœ‰è¿™ä¸ªç®—æ³•ï¼Œæœ‰äº”ä¸ªç‰ˆæœ¬ã€‚ä¼˜ç‚¹æ˜¯ç”Ÿæˆå¾ˆç®€å•ï¼Œæœ¬åœ°å°±å¯ä»¥ç”Ÿæˆï¼›ç¼ºç‚¹æ˜¯è¦ç”¨åˆ°macåœ°å€ï¼Œå®‰å…¨æ€§ä¸å¥½ï¼Œè€Œä¸”ä¸æ˜¯è¿ç»­çš„ï¼Œå¯¹äºInnoDBéé¡ºåºçš„idæ’å…¥å¯èƒ½é€ æˆé¡µåˆ†è£‚çš„é—®é¢˜ï¼Œå½±å“æ€§èƒ½ï¼Œè€Œä¸”é•¿åº¦ä¹Ÿå¾ˆé•¿ï¼Œmysqlä¸å»ºè®®è¿™ä¹ˆé•¿çš„id\n- é›ªèŠ±ç®—æ³•ï¼šæ—¶é—´æˆ³+æœºæˆ¿id+æœºå™¨id+åºåˆ—å·ã€‚æ­£å¸¸æƒ…å†µä¸‹ä¸€æ¯«ç§’ä¸€ä¸ªæœºå™¨å¯ä»¥ç”Ÿæˆ4096ä¸ªã€‚å¤§è‡´æ˜¯æœ‰åºçš„ï¼Œåªä¸è¿‡æ—¶é—´æˆ³æ˜¯åœ¨é«˜ä½ï¼›ç¼ºç‚¹æ˜¯é«˜åº¦ä¾èµ–æ—¶é—´ç³»ç»Ÿï¼Œå¦‚æœæœåŠ¡å™¨å‡ºç°æ—¶é—´å›é€€å°±ä¼šå¯¼è‡´å‡ºé”™\n- æ•°æ®åº“è‡ªå¢ï¼šç”¨ä¸€ä¸ªä¸“é—¨çš„è¡¨æ¥æ’å…¥è‡ªå¢ï¼Œç„¶åéœ€è¦idçš„æ—¶å€™æ‰¾è¿™ä¸ªè¡¨æ’å…¥ä¸€æ¡ï¼Œè¿”å›çš„idå³ä¸ºè‡ªå·±çš„idã€‚ä¼˜ç‚¹æ˜¯ç®€å•ï¼›ç¼ºç‚¹æ˜¯è‡ªå¢çš„å¤ªæ˜æ˜¾äº†ï¼Œè€Œä¸”ä¸é€‚åˆåˆ†å¸ƒå¼\n- ç¾å›¢å¼€æºç”Ÿæˆç®—æ³•leaf\n\n## åˆ†å¸ƒå¼äº‹åŠ¡\n- 2pcï¼šä¸¤é˜¶æ®µæäº¤ã€‚åˆ†å¸ƒå¼äº‹åŠ¡æœ‰ä¸¤ä¸ªè§’è‰²ï¼Œä¸€ä¸ªæ˜¯äº‹åŠ¡ç®¡ç†è€…ï¼Œä¸€ä¸ªæ˜¯äº‹åŠ¡æ‰§è¡Œè€…ï¼ˆæ¯”å¦‚mysqlæˆ–è€…redisï¼‰ã€‚ä¸¤ä¸ªé˜¶æ®µæŒ‡çš„æ˜¯å‡†å¤‡é˜¶æ®µå’Œæäº¤é˜¶æ®µã€‚äº‹åŠ¡ç®¡ç†è€…ä¼šè¯¢é—®å½“å‰äº‹åŠ¡ä¸‹æ‰€æœ‰çš„æ‰§è¡Œå™¨æ˜¯å¦å·²ç»å‡†å¤‡å°±ç»ªï¼Œæ‰§è¡Œå™¨æ¥åˆ°è¿™ä¸ªè¯¢é—®åå¼€å§‹æ‰§è¡Œè‡ªå·±çš„é€»è¾‘ï¼Œå¦‚æœæ²¡æœ‰å‡ºé”™å°±è¿”å›yesï¼Œå‡ºé”™äº†è¿”å›noï¼›ç¬¬äºŒé˜¶æ®µæ˜¯æäº¤ï¼Œå¦‚æœæ‰€æœ‰éƒ½è¿”å›yesï¼Œç®¡ç†è€…å°±ä¼šè®©å…¶æäº¤äº‹åŠ¡ï¼Œå¦‚æœæœ‰ä¸€ä¸ªæ˜¯noå°±ä¼šå›æ»šã€‚ç¼ºç‚¹æ˜¯ä¼šæœ‰å•ç‚¹é—®é¢˜ï¼Œæåº¦ä¾èµ–äº‹åŠ¡ç®¡ç†è€…ï¼Œå¦‚æœå®•æœºå°±ä¼šä¸€ç›´å¡ä½ï¼Œå…¶æ¬¡æ˜¯ä¼šæœ‰é˜»å¡ï¼Œåœ¨äº‹åŠ¡æ‰§è¡ŒæœŸé—´ä¼šé˜»å¡å…¶ä»–äº‹åŠ¡\n- 3pcï¼šä¸‰é˜¶æ®µæäº¤ï¼Œæ¯”ä¸Šé¢çš„å¤šäº†ä¸€ä¸ªå¼€å§‹çš„è¯¢é—®é˜¶æ®µï¼Œé¦–å…ˆæ˜¯å‡†å¤‡é˜¶æ®µï¼Œäº‹åŠ¡ç®¡ç†è€…åªä¼šé—®ä»–ä»¬å‡†å¤‡å¥½äº†å—ï¼Œè€Œä¸ä¼šå®é™…çš„æ‰§è¡Œè‡ªå·±çš„ä»»åŠ¡ï¼›å¦‚æœæ­¤æ—¶æœ‰äººè¿”å›noå°±ä¼šå›æ»šï¼Œä½†æ˜¯ç”±äºæ²¡æœ‰æ‰§è¡Œä»»åŠ¡æ‰€ä»¥å›æ»šçš„ä»£ä»·å°å¾ˆå¤šï¼›äºŒé˜¶æ®µæ˜¯é¢„æäº¤é˜¶æ®µï¼Œå½“æ‰€æœ‰äººéƒ½å‡†å¤‡å¥½äº†å°±ä¼šæ‰§è¡Œè‡ªå·±çš„ä»»åŠ¡ï¼Œæ­¤æ—¶è·Ÿä¸Šé¢çš„ä¸€æ ·ï¼Œå¦‚æœæœ‰noå°±å›æ»šï¼Œè¿™æ˜¯æœ€åçš„å›æ»šæœºä¼šäº†ï¼›ä¸‰é˜¶æ®µæ˜¯æäº¤ï¼Œå¦‚æœæ‰€æœ‰éƒ½è¿”å›ä¸ºyesï¼Œäº‹åŠ¡ç®¡ç†å™¨å°±ä¼šè®©ä»–ä»¬æäº¤äº‹åŠ¡ã€‚ä¼˜ç‚¹æ˜¯è¿™é‡Œéƒ½æœ‰è¶…æ—¶æœºåˆ¶ï¼Œé¿å…äº†é˜»å¡ï¼›ä½†æ˜¯è¿˜æ˜¯æœ‰ä¸ä¸€è‡´çš„ç°è±¡ï¼Œ3pcç”¨çš„æ¯”è¾ƒå°‘\n- TCCï¼šéœ€è¦ä»£ç å®ç°çš„ä¸¤é˜¶æ®µæäº¤ï¼Œåˆ†ä¸ºtryï¼Œconfirmï¼Œcancelã€‚é¦–å…ˆtryæ˜¯é¢„ç•™ä¸šåŠ¡èµ„æºï¼›confirmç¡®è®¤æ‰§è¡Œä¸šåŠ¡é€»è¾‘ï¼Œå¹¶ä¸”æ¶ˆè€—tryçš„ä¸šåŠ¡èµ„æºï¼Œå¦‚æœå‡ºç°é”™è¯¯å°±ä¼šcancelï¼Œå–æ¶ˆè¿™ä¸ªæ“ä½œå¹¶ä¸”é‡Šæ”¾tryçš„èµ„æº\n- ATï¼šseataçš„ä¸€ç§æ¨¡å¼ï¼Œå¯ä»¥è§†ä¸º2pcçš„ä¸€ç§å®ç°æ¨¡å¼ã€‚åŸç†ä¸€é˜¶æ®µæ˜¯é€šè¿‡ä»£ç†sqlï¼Œå…ˆè§£æsqlä¿å­˜æ‰§è¡Œå‰åçš„æ•°æ®å¿«ç…§å’Œundologï¼›äºŒé˜¶æ®µå¦‚æœæœ‰å‡ºé”™å°±æŒ‰ç…§è¿™ä¸ªundologè¿›è¡Œå›æ»šã€‚\n- sagaï¼šå°†äº‹åŠ¡å˜æˆçº¿æ€§é“¾è¡¨ï¼Œç„¶åä¸€ä¸ªä¸€ä¸ªåšï¼Œä¸­é—´æŸä¸ªäº‹åŠ¡å‡ºç°äº†é—®é¢˜å°±ä¼šç»™å‰é¢å·²ç»æäº¤çš„äº‹åŠ¡ä¸€ä¸ªè¡¥å¿æªæ–½ã€‚","tags":["Java"]},{"title":"Springé¢è¯•ç¯‡","url":"/2024/09/14/Springé¢è¯•ç¯‡/","content":"## Springçš„å¾ªç¯ä¾èµ–é—®é¢˜æ€ä¹ˆè§£å†³\nå¾ªç¯ä¾èµ–é—®é¢˜æŒ‡çš„æ˜¯åœ¨ä¾èµ–æ³¨å…¥è¿‡ç¨‹ä¸­ä¸¤ä¸ªç±»äº’ç›¸ä¾èµ–ï¼Œè¿™ä¼šå¯¼è‡´å®ä¾‹åŒ–çš„è¿‡ç¨‹æ··ä¹±ï¼Œå› ä¸ºä¸€ä¸ªç±»å®ä¾‹åŒ–éœ€è¦å¦ä¸€ä¸ªç±»å·²ç»å®ä¾‹åŒ–äº†ï¼Œä¸€èˆ¬æœ‰ä¸‰ç§å¾ªç¯ä¾èµ–é—®é¢˜ï¼š\n1. æ„é€ å‡½æ•°ä¾èµ–å¾ªç¯ï¼Œè¿™ä¸ªè§£å†³ä¸äº†\n2. setterçš„ä¾èµ–å¾ªç¯ï¼Œå…¶ä¸­beanæ˜¯å¤šä¾‹ï¼ˆprototypeï¼‰\n3. setterçš„ä¾èµ–å¾ªç¯ï¼Œå…¶ä¸­beanæ˜¯å•ä¾‹ã€‚\n\nSpringä»…ä»…å¯¹ç¬¬ä¸‰ç§è¿›è¡Œäº†è§£å†³ã€‚ç¬¬ä¸€ç§åœ¨newçš„æ—¶å€™å°±è¿›è¡Œä¸ä¸‹å»äº†ï¼Œæ— æ³•ç”Ÿæˆå¯¹è±¡ï¼›ç¬¬äºŒç§ç”±äºæ— ç©·æ— å°½çš„å¾ªç¯ä¼šç”Ÿæˆå¾ˆå¤šçš„beanï¼Œæœ€åå¯¼è‡´oomã€‚\n\n**å¦‚ä½•è§£å†³**\n\nspringç”¨ä¸€ä¸ªä¸‰çº§ç¼“å­˜è§£å†³äº†ï¼Œæ€»çš„æ¥è¯´å°±æ˜¯åœ¨ä¸€ä¸ªç±»æ²¡æœ‰åˆå§‹åŒ–çš„æ—¶å€™æå‰æš´éœ²beanå­˜åˆ°ä¸‰çº§ç¼“å­˜ä¸­ï¼Œç„¶åè¿›è¡Œè¿™ä¸ªç±»åˆå§‹åŒ–å®Œæˆä¹‹åå°±æ”¾å›ç¬¬ä¸€å±‚ç¼“å­˜ä¸­ã€‚\n\nåˆ›å»º BeanAï¼š Spring é¦–å…ˆå°† BeanA çš„å®ä¾‹å­˜å‚¨åœ¨ä¸‰çº§ç¼“å­˜ä¸­ã€‚ åœ¨åˆ›å»º BeanA çš„è¿‡ç¨‹ä¸­ï¼Œå‘ç°éœ€è¦æ³¨å…¥ BeanBã€‚\n\nåˆ›å»º BeanBï¼š Spring å°† BeanB çš„å®ä¾‹å­˜å‚¨åœ¨ä¸‰çº§ç¼“å­˜ä¸­ï¼ˆå› ä¸º BeanB ä¹Ÿéœ€è¦ BeanAï¼‰ã€‚ åœ¨åˆ›å»º BeanB çš„è¿‡ç¨‹ä¸­ï¼ŒSpring å‘ç° BeanA è¿˜æœªå®Œå…¨åˆå§‹åŒ–ï¼Œæ‰€ä»¥ä»ä¸‰çº§ç¼“å­˜ä¸­è·å– BeanA çš„ä»£ç†å¯¹è±¡ã€‚\n\næ³¨å…¥ä¾èµ–ï¼š å½“ BeanA åˆ›å»ºå®Œæˆåï¼ŒSpring ä¼šå°† BeanB æ³¨å…¥åˆ° BeanA çš„å­—æ®µä¸­ã€‚ åŒæ ·åœ°ï¼ŒBeanA ä¼šæ³¨å…¥åˆ° BeanB çš„å­—æ®µä¸­ï¼Œå®Œæˆä¾èµ–æ³¨å…¥ã€‚\n\n>åœ¨ä¸‰çº§ç¼“å­˜è¿™ä¸€å—ï¼Œä¸»è¦è®°ä¸€ä¸‹ Spring æ˜¯å¦‚ä½•æ”¯æŒå¾ªç¯ä¾èµ–çš„å³å¯ï¼Œä¹Ÿå°±æ˜¯å¦‚æœå‘ç”Ÿå¾ªç¯ä¾èµ–çš„è¯ï¼Œå°±å» ä¸‰çº§ç¼“å­˜ singletonFactories ä¸­æ‹¿åˆ°ä¸‰çº§ç¼“å­˜ä¸­å­˜å‚¨çš„ ObjectFactory å¹¶è°ƒç”¨å®ƒçš„ getObject() æ–¹æ³•æ¥è·å–è¿™ä¸ªå¾ªç¯ä¾èµ–å¯¹è±¡çš„å‰æœŸæš´éœ²å¯¹è±¡ï¼ˆè™½ç„¶è¿˜æ²¡åˆå§‹åŒ–å®Œæˆï¼Œä½†æ˜¯å¯ä»¥æ‹¿åˆ°è¯¥å¯¹è±¡åœ¨å †ä¸­çš„å­˜å‚¨åœ°å€äº†ï¼‰ï¼Œå¹¶ä¸”å°†è¿™ä¸ªå‰æœŸæš´éœ²å¯¹è±¡æ”¾åˆ°äºŒçº§ç¼“å­˜ä¸­ï¼Œè¿™æ ·åœ¨å¾ªç¯ä¾èµ–æ—¶ï¼Œå°±ä¸ä¼šé‡å¤åˆå§‹åŒ–äº†ï¼\n\n## Beançš„ç”Ÿå‘½å‘¨æœŸ\n\nå¤§çš„å¯ä»¥åˆ†ä¸ºå››ä¸ªéƒ¨åˆ†ï¼š\n1. beanåˆ›å»ºé˜¶æ®µï¼šé€šè¿‡è°ƒç”¨åå°„apiå®Œæˆbeançš„å®ä¾‹åŒ–\n2. ä¾èµ–æ³¨å…¥ï¼šä¸ºbeanè®¾ç½®ç›¸å…³å±æ€§å’Œä¾èµ–\n3. åˆå§‹åŒ–beanï¼šé¦–å…ˆæ£€æŸ¥æ˜¯å¦å®ç°äº†AwareåŒ…ä¸‹é¢çš„å„ç§awareæ¥å£ï¼Œä¾‹å¦‚beannameï¼Œbeanclassloaderï¼Œbeanfactoryï¼Œå…¶æ¬¡å†æ£€æŸ¥æ˜¯å¦å®ç°äº†Postbeanprocessæ¥å£ï¼Œæ‰§è¡Œpostbeanbeforeinitializationï¼Œå†çœ‹æœ‰æ²¡æœ‰å®ç°beanåˆå§‹åŒ–æ–¹æ³•InitializationBeanå’Œxmlçš„init-methodï¼Œæœ€åå†ç”¨postBeanAfterInitialization\n4. é”€æ¯ï¼ŒdisposableBeanå’Œdestory-bean\n\n\n<div style=\"text-align: center;\">\n  <img src=\"../img/Spring/img.png\" alt=\"\" />\n</div>\n\n## ä¾èµ–æ³¨å…¥çš„ä¸‰ç§æ–¹å¼\n- å­—æ®µæ³¨å…¥ï¼šä¸Šé¢åŠ @Autowired\n- æ„é€ å™¨æ³¨å…¥ï¼šå®˜æ–¹æ¨è\n- setteræ³¨å…¥ï¼šé€šè¿‡setteræ–¹æ³•æ³¨å…¥\n\n## Beanä¼šæœ‰çº¿ç¨‹å®‰å…¨é—®é¢˜å—\né¦–å…ˆæ¥çœ‹çœ‹beançš„ä½œç”¨åŸŸï¼Œå¸¸è§çš„æœ‰ï¼š\n- singletonï¼šé»˜è®¤çš„beanæ˜¯å•ä¾‹çš„\n- prototypeï¼šæ¯æ¬¡è·å–éƒ½æ˜¯ä¸ä¸€æ ·çš„bean\n- requestï¼šä¸€æ¬¡httpè¯·æ±‚å°±ä¸€ä¸ªbean\n\nå¦‚æœä½œç”¨èŒƒå›´æ˜¯prototypeï¼Œé‚£ä¸ä¼šæœ‰çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œä¸€æ¬¡è·å–å°±æœ‰ä¸€ä¸ªbeanã€‚ä½†æ˜¯å¦‚æœæ˜¯å•ä¾‹çš„beanä¼šæœ‰çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹å‡ ä¸ªæ–¹å¼è§£å†³ï¼š\n- å°½é‡ä½¿ç”¨æ— çŠ¶æ€bean\n- ä½¿ç”¨ThreadLocal\n- åŠ é”synchronized\n\n## SpringMVCæ‰§è¡Œæµç¨‹\n1. å®¢æˆ·ç«¯å‘é€httpè¯·æ±‚ï¼Œé¦–å…ˆç”±DispatcherServletæ¥æ”¶\n2. DispatcherServletå»HandlerMappingé‡Œé¢æ‰¾ï¼ˆè¿™æ˜¯ä¸€ä¸ªå“ˆå¸Œè¡¨ï¼Œå­˜å‚¨äº†è¯·æ±‚è·¯å¾„å’Œcontrollerçš„æ˜ å°„å…³ç³»ï¼‰\n3. æ‰¾åˆ°äº†å¯¹åº”çš„Controllerï¼Œå…ˆå»é€šè¿‡é€‚é…å™¨HandlerAdapterï¼Œå†å»è¯·æ±‚Controller\n4. è°ƒç”¨å®Œæˆåè¿”å›ä¸€ä¸ªè§†å›¾å’Œæ¨¡å‹ModelAndViewã€‚\n5. DispatcherServletæ‰¾è§†å›¾è§£æå™¨ViewResolverè¿›è¡Œè§£æã€‚\n6. è§£æå¾—åˆ°çš„Modelç»“åˆViewè¿›è¡Œæ¸²æŸ“è¿”å›è¯·æ±‚è€…\n\n<div style=\"text-align: center;\">\n  <img src=\"../img/Spring/img_1.png\" alt=\"\" />\n</div>\n\n## springçš„äº‹åŠ¡ä¼ æ’­é€»è¾‘\n> [è¯¦æƒ…çœ‹è¿™ç¯‡æ–‡ç« ](https://mp.weixin.qq.com/s?__biz=Mzg2OTA0Njk0OA==&mid=2247486668&idx=2&sn=0381e8c836442f46bdc5367170234abb&chksm=cea24307f9d5ca11c96943b3ccfa1fc70dc97dd87d9c540388581f8fe6d805ff548dff5f6b5b&token=1776990505&lang=zh_CN#rd)\n1. TransactionDefinition.PROPAGATION_REQUIREDï¼šå¤–éƒ¨æ–¹æ³•æ²¡æœ‰å¼€å¯äº‹åŠ¡ï¼Œé‚£å°±è‡ªå·±å¼€å¯äº‹åŠ¡ï¼Œä¸”å¼€å¯çš„äº‹åŠ¡ä¹‹é—´ç›¸äº’ç‹¬ç«‹ä¸æ‰“æ‰°ï¼›å¦‚æœå¤–éƒ¨æ–¹æ³•æœ‰äº‹åŠ¡ï¼Œé‚£å°±ä¸å¤–éƒ¨åŒç”Ÿå…±æ­»ï¼Œå¦‚æœå¤–éƒ¨äº‹åŠ¡å›æ»šè‡ªå·±ä¹Ÿå›æ»šã€‚å¤–éƒ¨äº‹åŠ¡ä¸­çš„ä¸€ä¸ªå­äº‹åŠ¡å›æ»šé‚£æ‰€æœ‰éƒ½å›æ»šã€‚ä¸”å¦‚æœå†…éƒ¨äº‹åŠ¡å¼‚å¸¸è¢«æ•è·ï¼Œå¤–éƒ¨äº‹ç‰©è¿˜æ˜¯ä¼šå›æ»š\n2. TransactionDefinition.PROPAGATION_REQUIRES_NEWï¼šå¤–éƒ¨äº‹åŠ¡å›æ»šï¼Œå†…éƒ¨çš„newä¸å›æ»šã€‚å†…éƒ¨äº‹åŠ¡å›æ»šï¼Œå¦‚æœè¢«catchäº†å°±ä¸ä¼šé€ æˆå¤–éƒ¨äº‹åŠ¡å›æ»šï¼Œå¦‚æœæ²¡æœ‰catchå°±ä¼šå›æ»šã€‚ï¼ˆä¸Šä¸€ä¸ªæ˜¯æœ‰æ— catchéƒ½ä¼šé€ æˆå¤–éƒ¨äº‹ç‰©å›æ»šï¼‰\n3. TransactionDefinition.PROPAGATION_NESTEDï¼šä¸ä¸Šä¸€ä¸ªæ˜¯åçš„ï¼Œå¤–éƒ¨äº‹åŠ¡å›æ»šä¼šé€ æˆå†…éƒ¨å›æ»šï¼Œè‡ªèº«å›æ»šä¹Ÿæ˜¯çœ‹catchï¼Œå¦‚æœcatchäº†å¤–éƒ¨äº‹ç‰©å°±ä¸ä¼šæ»š\n\n\n## @Transactionalæ³¨è§£ä½¿ç”¨\nå¯ä»¥ä½¿ç”¨åœ¨æ–¹æ³•å’Œç±»ä¸Šï¼Œä½¿ç”¨åœ¨ç±»ä¸Šå°±æ˜¯ç»™æ‰€æœ‰æ–¹æ³•éƒ½åŠ ä¸Šäº‹åŠ¡ã€‚å¸¸ç”¨å‚æ•°æœ‰5ä¸ªï¼Œäº‹åŠ¡éš”ç¦»çº§åˆ«ï¼ˆè¯»æœªæäº¤ï¼Œè¯»æäº¤ï¼Œå¯é‡å¤è¯»ï¼Œä¸²è¡ŒåŒ–ï¼‰ï¼Œä¼ æ’­è¡Œä¸ºï¼Œè¶…æ—¶æ—¶é—´ï¼ˆåœ¨æŒ‡å®šçš„æ—¶é—´å†…æœªå®Œæˆå›æ»šï¼‰ï¼Œæ˜¯å¦åªè¯»ï¼Œè§¦å‘å›æ»šçš„å¼‚å¸¸ç±»å‹\n\n\n## springè‡ªè°ƒç”¨å¯¼è‡´å¤±æ•ˆé—®é¢˜\nç”±äºTransactionè¿™ä¸ªæ³¨é‡Šç”¨åˆ°äº†aopï¼Œè¿›è¡Œäº‹åŠ¡çš„å¯¹è±¡éƒ½æ˜¯ä»£ç†å¯¹è±¡ã€‚å¦‚æœæ˜¯è‡ªå·±è°ƒç”¨å°±æ— æ³•æ‹¦æˆªåˆ°è¿™ä¸ªå†…éƒ¨è°ƒç”¨ï¼Œæ‰€ä»¥äº‹åŠ¡ä¼šå¤±æ•ˆã€‚è¿™ä¸ªæ—¶å€™å¯ä»¥è·å–å…¶ä»£ç†å¯¹è±¡ã€‚\n```java\n@Service\npublic class MyService {\n\nprivate void method1() {\n     ((MyService)AopContext.currentProxy()).method2(); // å…ˆè·å–è¯¥ç±»çš„ä»£ç†å¯¹è±¡ï¼Œç„¶åé€šè¿‡ä»£ç†å¯¹è±¡è°ƒç”¨method2ã€‚\n     //......\n}\n@Transactional\n public void method2() {\n     //......\n  }\n}\n\n```","tags":["Java"]},{"title":"JavaåŸºç¡€ç¯‡","url":"/2024/09/14/JavaåŸºç¡€ç¯‡/","content":"## Javaçš„å¼‚å¸¸ä½“ç³»\nåˆ†ä¸ºå¼‚å¸¸Exceptionå’Œé”™è¯¯Errorï¼Œå¼‚å¸¸æ˜¯å¯ä»¥ç”¨try/catchæ¥è§£å†³çš„ï¼Œä½†æ˜¯errorå°±å¾ˆä¸¥é‡äº†ï¼Œä¼šç›´æ¥å¯¼è‡´çº¿ç¨‹ç»ˆæ­¢ã€‚ä»–ä»¬éƒ½ç»§æ‰¿è‡ªThrowAbleæ¥å£ã€‚\n\nå…¶ä¸­exceptionåˆ†ä¸ºå¯ä»¥æ£€æŸ¥åˆ°çš„å¼‚å¸¸ï¼ˆchecked exceptionï¼‰ï¼Œè¡¨ç¤ºèƒ½å¤Ÿåœ¨ç¼–è¯‘é˜¶æ®µå°±å‘ç°å¹¶ä¸”æŠ›å‡ºé”™è¯¯çš„å¼‚å¸¸ï¼Œæ¯”å¦‚sqlexceptionæˆ–è€…ioexceptionï¼›ç¼–è¯‘æ—¶æ— æ³•æ£€æµ‹å‡ºçš„å¼‚å¸¸ï¼ˆunchecked exceptionï¼‰ï¼ŒæŒ‡çš„å°±æ˜¯è¿è¡Œæ—¶å¼‚å¸¸ï¼ˆruntimeExceptionï¼‰ä¾‹å¦‚æ•°ç»„è¶Šç•Œï¼Œç©ºæŒ‡é’ˆè¿™ç§ã€‚ runtimeExceptionéƒ½æ˜¯æ— æ³•æ£€æµ‹å‡ºçš„å¼‚å¸¸ï¼Œå…¶ä½™çš„éƒ½æ˜¯å¯ä»¥åœ¨ç¼–è¯‘é˜¶æ®µæ£€æµ‹å‡ºæ¥çš„ã€‚\n\nerroræ˜¯æ¯”è¾ƒä¸¥é‡çš„é”™è¯¯ï¼Œä¾‹å¦‚oomæˆ–è€…stackoverflowï¼Œè¿˜æœ‰è™šæ‹Ÿæœºå†…éƒ¨çš„ä¸€äº›é—®é¢˜ï¼Œè¿™äº›errorä¼šå¯¼è‡´çº¿ç¨‹ç›´æ¥ç»ˆæ­¢ï¼Œ~~å¹¶ä¸èƒ½ç”¨try/catch~~\n\n> gptäº†ä¸€ä¸‹ï¼Œå…¶å®errorä¹Ÿå¯ä»¥ç”¨catchï¼Œå› ä¸ºéƒ½æ˜¯ç»§æ‰¿è‡ªthrowableæ¥å£ï¼Œthrowableæ»¡è¶³è¿™ä¸ªè¯­æ³•ç³–ã€‚ä½†æ˜¯å‡ºç°äº†errorå°±ç®—catchäº†ç¨‹åºè¿˜æ˜¯å‡ºç°äº†ä¸¥é‡é”™è¯¯ï¼Œæ•è·è¿™äº›é—®é¢˜å¹¶ä¸èƒ½ä¿®å¤ï¼Œç»§ç»­è¿è¡Œå¯èƒ½å¯¼è‡´æ›´åŠ ä¸¥é‡çš„é—®é¢˜ã€‚\n\n## finallyæ–¹æ³•å—\n- finallyå¹¶ä¸ä¸€å®šä¼šæ‰§è¡Œï¼šå¦‚æœå‡ºç°äº†ç”µæºæ‰ç”µæˆ–è€…cpuå¡æ­»å°±ä¸ä¼šï¼ˆ~~è¿™æœ‰ç‚¹å¹½é»˜äº†~~ï¼‰\n- ä¸å»ºè®®åœ¨finallyé‡Œé¢å†™è¿”å›ï¼štry/catch/finallyæ–¹æ³•å—çš„é€»è¾‘æ˜¯ï¼Œå³ä½¿åœ¨tryä¸­å·²ç»è¿”å›äº†ï¼Œä¹Ÿä¼šæ‰§è¡Œfinallyé‡Œé¢çš„è¯­å¥ï¼Œtryçš„è¿”å›å€¼ä¿å­˜èµ·æ¥ï¼ŒåŒæ—¶å¦‚æœfinallyé‡Œé¢ä¹Ÿæœ‰returnï¼Œå°±ä¼šè¦†ç›–tryçš„è¿”å›å€¼ã€‚\n\n## åºåˆ—åŒ–å’Œååºåˆ—åŒ–\nJavaæ•°æ®çš„ä¼ è¾“æ˜¯é€šè¿‡å­—èŠ‚æµçš„ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªbyte[]æ•°ç»„ï¼Œå¦‚ä½•å°†Javaè½¬åŒ–ä¸ºè¿™ä¸ªæ•°ç»„å°±æ˜¯åºåˆ—åŒ–è¦å¹²çš„äº‹æƒ…ï¼ŒåŸç”Ÿæä¾›çš„åºåˆ—åŒ–å¯ä»¥æä¾›å®ç°serializationæ¥å£å¹¶ä¸”æŒ‡å®šserialVersionUIDå®Œæˆåºåˆ—åŒ–ï¼Œè¿™ä¸ªserialVersionUIDä¼šä¸ºååºåˆ—åŒ–æä¾›ä¸€ä¸ªæ ¡éªŒï¼Œå¦‚æœidä¸å½“å‰è¦å¼ºåˆ¶ç±»å‹è½¬æ¢çš„ç±»æ˜¯ä¸€æ ·çš„ï¼Œé‚£å°±å¯ä»¥è½¬æ¢ï¼Œå¦åˆ™å°±ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚\n\næ¯”å¦‚ä¸‹é¢è¿™ä¸ªä»£ç ï¼Œæ–‡ä»¶æ¨¡æ‹Ÿçš„æ˜¯ä¼ è¾“çš„æ•°æ®æµã€‚\n\n```java\nimport java.io.*;\n\nclass Person implements Serializable {\n    private static final long serialVersionUID = 1L; // æ˜¾å¼å®šä¹‰ç‰ˆæœ¬å·\n    String name;\n    int age;\n\n    public Person(String name, int age) {\n        this.name = name;\n        this.age = age;\n    }\n}\n\npublic class Main {\n    public static void main(String[] args) {\n        try {\n            // åºåˆ—åŒ–\n            ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\"person.ser\"));\n            Person person = new Person(\"Alice\", 30);\n            out.writeObject(person);\n            out.close();\n            \n            // æ¨¡æ‹Ÿååºåˆ—åŒ–åç±»å‘ç”Ÿå˜åŒ–\n            // ä¿®æ”¹ serialVersionUID ä¸º 2Lï¼Œæ¨¡æ‹Ÿç‰ˆæœ¬ä¸åŒ¹é…\n            // private static final long serialVersionUID = 2L;\n\n            // ååºåˆ—åŒ–\n            ObjectInputStream in = new ObjectInputStream(new FileInputStream(\"person.ser\"));\n            Person deserializedPerson = (Person) in.readObject();  // è¯»å–å¯¹è±¡\n            in.close();\n\n            System.out.println(\"Deserialized Person: \" + deserializedPerson.name + \", \" + deserializedPerson.age);\n        } catch (Exception e) {\n            e.printStackTrace();  // å¦‚æœ serialVersionUID ä¸åŒ¹é…ï¼Œè¿™é‡Œä¼šæŠ›å‡º InvalidClassException\n        }\n    }\n}\n\n```\n> æ³¨æ„å‡ ç‚¹ï¼š\n> 1. åºåˆ—åŒ–è½¬åŒ–çš„æ˜¯å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯è¯´staticä¿®é¥°çš„å­—æ®µæ˜¯ä¸ä¼šè¢«åºåˆ—åŒ–çš„ï¼Œåæ­£æœ€ç»ˆååºåˆ—åŒ–å˜æˆäº†ä¸€ä¸ªå¯¹è±¡ä¹‹åç±»çš„é™æ€å±æ€§åˆä¸ä¼šæœ‰å˜åŒ–ï¼Œ\n> 2. ä¸æƒ³åºåˆ—åŒ–çš„å˜é‡ç”¨transientä¿®é¥°ï¼Œä¾‹å¦‚ä¸‹é¢è¿™ä¸ªä»£ç \n\n```java\nimport java.io.*;\n\nclass Example implements Serializable {\n    private static final long serialVersionUID = 1L;\n    \n    static int staticField = 10; // static å­—æ®µ\n    transient int transientField = 20; // transient å­—æ®µ\n    int instanceField = 30; // å®ä¾‹å­—æ®µ\n    \n    public static void main(String[] args) {\n        Example example = new Example();\n        \n        try {\n            // åºåˆ—åŒ–å¯¹è±¡\n            ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\"example.ser\"));\n            out.writeObject(example);\n            out.close();\n            \n            // ä¿®æ”¹ staticField å€¼ä»¥æŸ¥çœ‹åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„å½±å“\n            Example.staticField = 100;\n            \n            // ååºåˆ—åŒ–å¯¹è±¡\n            ObjectInputStream in = new ObjectInputStream(new FileInputStream(\"example.ser\"));\n            Example deserializedExample = (Example) in.readObject();\n            in.close();\n            \n            // æ‰“å°ç»“æœ\n            System.out.println(\"Deserialized Example:\");\n            System.out.println(\"Static Field: \" + Example.staticField); // staticField ä»ç„¶æ˜¯ 100\n            System.out.println(\"Instance Field: \" + deserializedExample.instanceField); // instanceField æ˜¯ 30\n            System.out.println(\"Transient Field: \" + deserializedExample.transientField); // transientField æ˜¯ 0\n        } catch (Exception e) {\n            e.printStackTrace();\n        }\n    }\n}\n\n```\n\n\nä½†æ˜¯Javaé»˜è®¤çš„è¿™ä¸ªåºåˆ—åŒ–å¹¶ä¸å¥½ï¼Œè‡³å°‘æˆ‘åœ¨å¼€å‘çš„æ—¶å€™éƒ½ç”¨çš„æ˜¯Jsonï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿ\n1. ä¸æ”¯æŒè·¨å¹³å°ï¼Œjavaåºåˆ—åŒ–å¾—åˆ°çš„å­—èŠ‚æµåªèƒ½javaååºåˆ—åŒ–å‡ºæ¥ï¼Œjsonä¸ä¸€æ ·ï¼Œjavaè½¬åŒ–ä¸ºçš„jsonå¯ä»¥ç”¨pythonå†ååºåˆ—åŒ–å›æ¥\n2. æ€§èƒ½è¾ƒå·®ï¼Œè½¬åŒ–åçš„å­—èŠ‚æ•°ç»„å¤§\n3. å®‰å…¨æ€§\n\n## String,StringBuffer,StringBuilder\n- stringæ˜¯è¢«finalä¿®é¥°çš„ï¼ŒåŒæ—¶å†…éƒ¨çš„å®ç°æ•°ç»„ï¼ˆchar[]æˆ–è€…byte[]ï¼‰æ˜¯privateï¼Œæ— æ³•é€šè¿‡å¤–ç•Œä¿®æ”¹ã€‚å› æ­¤å­—ç¬¦ä¸²çš„æ‹¼æ¥æ˜¯éœ€è¦æ–°ç”Ÿæˆå¯¹è±¡çš„ã€‚\n- stringbufferï¼šæ–¹æ³•ç”±synchronizedä¿®é¥°ï¼Œæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå…¶æ‹¼æ¥å­—ç¬¦ä¸²ä¸ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„stringbufferç±»ï¼Œæ•ˆç‡æ¯”stringä¸çŸ¥é“é«˜åˆ°å“ªé‡Œå»äº†\n- stringbuilderï¼šåœ¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹stringçš„æ“ä½œéƒ½ä¸å¤ªéœ€è¦çº¿ç¨‹åŒæ­¥ï¼Œè¿™ä¸ªç±»å°±å–æ¶ˆäº†åŒæ­¥æ“ä½œï¼Œæ•ˆç‡æ¯”ä¸Šä¸€ä¸ªé«˜ã€‚\n\n**å­—ç¬¦ä¸²çš„æ‹¼æ¥**\n\njavaæ˜¯æ²¡æœ‰è¿ç®—ç¬¦é‡è½½çš„ï¼Œä½†æ˜¯å”¯ä¸€ä¸ºäº†stringçš„æ‹¼æ¥ä¿®æ”¹äº†+å’Œ+=ï¼Œä½¿å¾—stringå¯ä»¥é€šè¿‡+å’Œ+=æ“ä½œ\n\næŸ¥çœ‹å­—èŠ‚ç æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œå…¶å®stringçš„+å’Œ+=æ˜¯åŸºäºstringbuilderè°ƒç”¨appendæ–¹æ³•ï¼Œæœ€åå†ä½¿ç”¨tostringèµ‹å€¼ç»™Stringï¼Œä½†æ˜¯æ¯æ¬¡è¿›è¡Œè¿™æ ·ä¸€ä¸ªæ‹¼æ¥æ“ä½œå°±éœ€è¦newä¸€ä¸ªstringbuilderï¼Œå¯¹äºå¾ªç¯æ¥è¯´ï¼Œè¿™æ ·çš„å¼€é”€å°±éå¸¸å¤§äº†ã€‚\n\n```java\nString[] arr = {\"he\", \"llo\", \"world\"};\nString s = \"\";\nfor (int i = 0; i < arr.length; i++) {\n    s += arr[i];\n}\nSystem.out.println(s);\n```\n\nå¦‚æœç›´æ¥ä½¿ç”¨appendæ¥æ‹¼æ¥ï¼Œå°±ä¸ä¼šæœ‰è¿™ä¸ªé—®é¢˜äº†ã€‚æ‰€ä»¥åœ¨å¤§é‡å­—ç¬¦ä¸²æ“ä½œçš„æ—¶å€™ç”¨bufferæˆ–è€…builderæ¯”è¾ƒå¥½ã€‚\n\n## å­—ç¬¦ä¸²å¸¸é‡æ± å’ŒStringå¯¹è±¡\n**å­—ç¬¦ä¸²å¸¸é‡æ± **\né¦–å…ˆåšä¸ªåŒºåˆ†ï¼Œjavaç¨‹åºåœ¨ç¼–è¯‘æˆäº†classæ–‡ä»¶ä¹‹åä¼šæœ‰ä¸€ä¸ªå¸¸é‡æ± ï¼Œä¹Ÿå«åšé™æ€å¸¸é‡æ± ã€‚å½“åœ¨è¢«ç±»åŠ è½½å™¨åŠ è½½è¿›å†…å­˜æ—¶ä¼šå°†å…¶åˆ†ä¸ºå­—ç¬¦ä¸²å¸¸é‡æ± å’Œè¿è¡Œæ—¶å¸¸é‡æ± ã€‚\n- è¿è¡Œæ—¶å¸¸é‡æ± æ˜¯ä¸€ç›´è·Ÿç€æ–¹æ³•åŒºçš„ï¼Œæ–¹æ³•åŒºåœ¨å“ªé‡Œå®ƒåœ¨å“ªé‡Œã€‚åœ¨jdk1.7çš„æ—¶å€™æ–¹æ³•åŒºå«åšæ°¸ä¹…ä»£ï¼Œæ”¾åœ¨è¿è¡Œæ—¶æ•°æ®åŒºï¼Œä¹Ÿå°±æ˜¯å’Œå †æ ˆåœ¨ä¸€èµ·çš„åŒºåŸŸï¼Œä¸ºäº†å‡å°‘oomçš„å¯èƒ½å’Œå†…å­˜çš„å‹åŠ›ï¼Œåœ¨jdk1.8ä»¥åè¢«æ¬åˆ°äº†ç›´æ¥å†…å­˜ä¸­ï¼Œç”±æ“ä½œç³»ç»Ÿç®¡ç†ä¸ç”±jvmè™šæ‹Ÿæœºç®¡ç†ï¼Œä»è€Œå‡å°‘äº†jvmçš„å†…å­˜å‹åŠ›ã€‚ä½†æ˜¯è™šæ‹Ÿæœºå‚æ•°å¯ä»¥é…ç½®å…ƒç©ºé—´çš„å¤§å°ï¼Œå¹¶ä¸æ˜¯å¯ä»¥æ— é™æ‰©å¤§çš„ï¼Œä¹Ÿä¼šæœ‰oomï¼šmetaspaceçš„æŠ¥é”™ã€‚è¯´å›è¿è¡Œæ—¶å¸¸é‡æ± ï¼ŒåŒ…å«äº†classæ–‡ä»¶é‡Œé™æ€å¸¸é‡æ± é‡Œçš„å­—é¢é‡å’Œç¬¦å·å¼•ç”¨ï¼Œä½†å”¯ç‹¬æ²¡æœ‰å­—ç¬¦ä¸²ã€‚**ä¹Ÿå°±æ˜¯è¯´é™¤å­—ç¬¦ä¸²ä»¥å¤–çš„å­—é¢é‡æ¯”å¦‚æ•´å½¢å’Œæµ®ç‚¹ï¼Œç¬¦å·å¼•ç”¨çš„ç±»ä¸æ¥å£å…¨é™å®šåï¼Œæ–¹æ³•å’Œå­—æ®µçš„åç§°å’Œæè¿°ç¬¦ï¼Œéƒ½è¿˜åœ¨è¿è¡Œæ—¶å¸¸é‡æ± ï¼›ç»´åº¦å­—ç¬¦ä¸²æ’é™¤å‡ºå»äº†**\n- å­—ç¬¦ä¸²å¸¸é‡æ± ï¼šåœ¨jdk1.6çš„æ—¶å€™æ˜¯æ²¡æœ‰ä¸è¿è¡Œæ—¶å¸¸é‡æ± åˆ†å¼€æ¥çš„ï¼Œä¹Ÿæ˜¯è·Ÿç€æ–¹æ³•åŒºçš„ï¼Œåˆ°äº†1.7è¢«åˆ†åˆ°å †å†…å­˜å»äº†ã€‚åŸå› æ˜¯æœ¬æ¥æ–¹æ³•åŒºè¿›è¡Œåƒåœ¾å›æ”¶çš„æœºä¼šå°±å¾ˆå°‘ï¼Œé™¤äº†fullgcåŸºæœ¬åˆ°ä¸äº†è¿™é‡Œï¼Œå­—ç¬¦ä¸²åˆæ˜¯ä¸€ä¸ªå¾ˆå®¹æ˜“äº§ç”Ÿå¤§é‡å¯¹è±¡çš„åœ°æ–¹ã€‚æ‰€ä»¥å°±æ”¾åˆ°heapä¸­äº†ï¼Œå¯ä»¥è¿›è¡Œåƒåœ¾å›æ”¶ï¼Œè¿™é‡Œåˆ›å»ºå‡ºçš„ä¹Ÿè¢«ç§°ä¹‹ä¸ºå­—ç¬¦ä¸²å¯¹è±¡ã€‚å®é™…ä¸ŠStringçš„å¼•ç”¨éƒ½æ˜¯åœ¨å­—ç¬¦ä¸²å¸¸é‡æ± é‡Œçš„åœ°å€ã€‚\n\n**new String(\"abc\")çš„é—®é¢˜**\n\n```java\nString s1 = new String(\"abc\");\n```\næˆ‘ä»¬å‡è®¾å‰é¢éƒ½æ²¡æœ‰å…³äºabcè¿™ä¸ªå­—ç¬¦ä¸²çš„åˆ›å»ºï¼Œè¿™ä¸ªæ“ä½œä¼šåˆ›å»ºä¸¤ä¸ªå¯¹è±¡ï¼š\n- é¦–å…ˆä¼šåœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸Šåˆ›å»ºabcè¿™ä¸ªå¯¹è±¡\n- ç”±äºnewäº†ä¸€ä¸ªStringå¯¹è±¡ï¼Œä¼šåœ¨å †ä¸Šåˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è±¡\n\nä½†æ˜¯å¦‚æœå‰é¢æœ‰String s2=\"abc\"ï¼Œä¹Ÿå°±æ˜¯å‰é¢å·²ç»æœ‰åœ¨å­—ç¬¦ä¸²å¸¸é‡æ± é‡Œé¢åˆ›å»ºå¯¹è±¡äº†ï¼Œå‰é¢è¿™ä¸ªnewçš„ä»£ç åªä¼šåˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼Œå³å †å†…å­˜ä¸Šçš„ã€‚\n\n```java\nString s1 = \"abc\";\nString s2 = \"abc\";\n\nSystem.out.println(s1 == s2);  // trueï¼Œå› ä¸º s1 å’Œ s2 éƒ½å¼•ç”¨å¸¸é‡æ± ä¸­çš„åŒä¸€ä¸ªå¯¹è±¡\n```\n\n\n```java\nString s1 = \"abc\";              // å¸¸é‡æ± ä¸­çš„ \"abc\" å¯¹è±¡\nString s2 = new String(\"abc\");  // å †ä¸­çš„æ–°å¯¹è±¡\n\nSystem.out.println(s1 == s2);   // falseï¼Œs1 å’Œ s2 æ˜¯ä¸åŒçš„å¯¹è±¡ï¼Œs1 æ˜¯å¸¸é‡æ± ä¸­çš„ï¼Œs2 æ˜¯å †ä¸­çš„\n\n```\n> é‚£æˆ‘åœ¨newäº†ä¸€ä¸ªStringä»¥åï¼Œæˆ‘æ€ä¹ˆæ‰¾åˆ°å­—ç¬¦ä¸²å¸¸é‡æ± é‡Œé¢çš„å¯¹è±¡ï¼Ÿ\n> internå¯ä»¥ç›´æ¥æ‰¾ï¼Œè¿”å›çš„æ˜¯åœ¨å­—ç¬¦ä¸²å¸¸é‡æ± é‡Œçš„åœ°å€ï¼Œè¿™æ ·å°±ä¿è¯äº†å­—ç¬¦ä¸²å†…å®¹æ˜¯ä¸€è‡´çš„æƒ…å†µä¸‹ï¼Œåœ°å€ä¹Ÿå®Œå…¨ä¸€æ ·ï¼Œåœ¨æŸäº›è¦ç”¨é”çš„åœºåˆä¸‹ï¼Œä½¿ç”¨internå¯ä»¥ä¿è¯é”çš„å¯¹è±¡æ˜¯å”¯ä¸€çš„ã€‚\n> ä¾‹å¦‚åœ¨é»‘é©¬ç‚¹è¯„è¿™ä¸ªé”ä»£ç å—é‡Œé¢ï¼š\n```java\n@Transactional\npublic  Result createVoucherOrder(Long voucherId) {\n\tLong userId = UserHolder.getUser().getId();\n\tsynchronized(userId.toString().intern()){\n        ...\n    }\n}\n```\n> è¿™é‡Œé¢æ¯ä¸€ä¸ªidçš„toStringéƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œä¸ºäº†ä¿è¯é”å¯¹è±¡çš„å”¯ä¸€æ€§ï¼Œéœ€è¦ç”¨internç›´æ¥å–å‡ºå¸¸é‡æ± çš„åœ°å€\n\nä¸ºä»€ä¹ˆè¦æœ‰è¿™ç§è®¾è®¡ï¼Ÿå­—ç¬¦ä¸²å¸¸é‡æ± æœ¬èº«å°±æ˜¯ä¸ºäº†å¯é‡å¤æ‰æ‰©å±•çš„ï¼Œæœ‰çš„æ—¶å€™ä¸æƒ³è¦ä¸å­—ç¬¦ä¸²çš„å¸¸é‡æ± å…±äº«ï¼Œå°±éœ€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„å­—ç¬¦ä¸²ã€‚\n\n## Doubleå’ŒBigDecimalçš„åŒºåˆ«\n- doubleæ˜¯åŸºæœ¬æ•°æ®ç±»å‹ï¼ŒbigDecimalæ˜¯ç±»\n- doubleåŒç²¾åº¦æµ®ç‚¹å‹å¯èƒ½ä¼šæœ‰æ•°æ®æº¢å‡ºçš„æƒ…å†µï¼Œbigdecimalæ˜¯ç”¨å­—ç¬¦ä¸²åšè¿ç®—çš„ï¼Œç²¾åº¦æœ‰ä¿éšœï¼Œç”±äºæ˜¯å­—ç¬¦ä¸²ï¼Œä¼šé¢‘ç¹åˆ›å»ºå¯¹è±¡ï¼Œå¼€é”€è¾ƒå¤§\n- ç²¾åº¦è¦æ±‚ç‰¹åˆ«é«˜æ¯”å¦‚åœ¨é‡‘èé¢†åŸŸéœ€è¦ç”¨big\n\n## åå°„\n\nç±»åŠ è½½å™¨åŠ è½½å­—èŠ‚ç æ–‡ä»¶åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼šé€šè¿‡ç±»çš„å…¨é™å®šåè·å–å­—èŠ‚ç æ–‡ä»¶ï¼Œå°†å­—èŠ‚ç æ–‡ä»¶ç”Ÿæˆä¸€ä¸ªInstanceKlassæ–‡ä»¶åœ¨æ–¹æ³•åŒºï¼Œä¿å­˜äº†ç±»çš„å…ƒæ•°æ®åŒ…æ‹¬å­—æ®µï¼Œæ–¹æ³•ï¼Œè™šæ–¹æ³•è¡¨ç™»ï¼›åŒæ—¶ä¼šåœ¨å †ä¸­ç”Ÿæˆä¸€ä¸ªClasså¯¹è±¡ï¼Œä½œä¸ºè®¿é—®è¿™ä¸ªInstanceKlasså¯¹è±¡çš„æ¥å£ã€‚ æ­£æ˜¯è¿™ä¸ªClasså¯¹è±¡ä¸ºJavaåå°„æä¾›äº†åŸºç¡€ã€‚\n\nè·å–Classå¯¹è±¡æœ‰ä»¥ä¸‹å››ç§æ–¹å¼ï¼š\n1. Class.forNameä¼ å…¥è·¯å¾„\n2. é€šè¿‡å¯¹è±¡è·å–classï¼ˆinstance.getClass()ï¼‰\n3. é€šè¿‡ç±»åŠ è½½å™¨ä¼ å…¥loadClassè·¯å¾„è·å–ï¼ˆèµ°çš„å°±æ˜¯åŒäº²å§”æ´¾æœºåˆ¶é‚£ä¸€å¥—äº†ï¼Œä¼°è®¡findClassæ˜¯æ ¹æ®è·¯å¾„æ”¹é€ æˆå…¨é™å®šåç„¶åæ‰¾ï¼Œä½†æ˜¯è¿™é‡Œä»…ä»…æ˜¯åŠ è½½ç±»ï¼Œæ²¡æœ‰è¿æ¥è¿‡ç¨‹ï¼Œæ‰€æœ‰é™æ€ä»£ç å—ä¸ä¼šæ‰§è¡Œï¼‰\n4. å¯ä»¥ç›´æ¥.classè·å–\n\n```java\nimport java.lang.reflect.Constructor;\nimport java.lang.reflect.Field;\nimport java.lang.reflect.Method;\n\npublic class ReflectionExample {\n    public static void main(String[] args) {\n        try {\n            // 1. è·å–Classå¯¹è±¡\n            Class<?> clazz = Class.forName(\"com.example.Person\");\n            \n            // 2. è·å–æ„é€ å™¨å¹¶åˆ›å»ºå¯¹è±¡\n            Constructor<?> constructor = clazz.getConstructor(String.class, int.class);\n            Object person = constructor.newInstance(\"å¼ ä¸‰\", 25);\n            \n            // 3. è·å–å¹¶è°ƒç”¨æ–¹æ³•\n            Method sayHello = clazz.getMethod(\"sayHello\");\n            sayHello.invoke(person);\n            \n            // 4. è·å–å¹¶ä¿®æ”¹å­—æ®µ\n            Field ageField = clazz.getDeclaredField(\"age\");\n            ageField.setAccessible(true); // å¦‚æœå­—æ®µæ˜¯privateçš„ï¼Œéœ€è¦è®¾ç½®å¯è®¿é—®\n            int age = (int) ageField.get(person);\n            System.out.println(\"å¹´é¾„: \" + age);\n            ageField.set(person, 30);\n            System.out.println(\"ä¿®æ”¹åçš„å¹´é¾„: \" + ageField.get(person));\n            \n        } catch (Exception e) {\n            e.printStackTrace();\n        }\n    }\n}\n\n// å‡è®¾å­˜åœ¨å¦‚ä¸‹Personç±»\npackage com.example;\n\npublic class Person {\n    private String name;\n    private int age;\n    \n    public Person(String name, int age) {\n        this.name = name;\n        this.age = age;\n    }\n    \n    public void sayHello() {\n        System.out.println(\"ä½ å¥½ï¼Œæˆ‘æ˜¯\" + name + \"ï¼Œä»Šå¹´\" + age + \"å²ã€‚\");\n    }\n}\n\n```\n> å¦‚ä½•è·å¾—ç§æœ‰å˜é‡/æ–¹æ³•ï¼šsetAccessible\n\n**åå°„çš„ä¼˜ç¼ºç‚¹**\n\n- ä¼˜ç‚¹ï¼šçµæ´»åº¦é«˜ï¼Œå¤šç§æ¡†æ¶éƒ½æ˜¯åŸºäºåå°„çš„ï¼Œèƒ½å¤Ÿåœ¨è¿è¡Œæ—¶åŠ¨æ€æ“ä½œç±»å’Œå¯¹è±¡\n- ç¼ºç‚¹ï¼šå®‰å…¨æ€§ï¼Œprivateå­—æ®µå¯ä»¥è®¿é—®ï¼Œæ€§èƒ½å¼€é”€\n\n> æ€»ç»“ï¼šä¸ºä»€ä¹ˆåå°„çš„æ•ˆç‡ä½ï¼Ÿ \n> åå°„æ•ˆç‡ä½çš„åŸå› å¯ä»¥å½’ç»“ä¸ºä»¥ä¸‹å‡ ç‚¹ï¼š\n> - éœ€è¦è¿›è¡ŒåŠ¨æ€çš„ç±»å‹è§£æï¼Œè€—è´¹é¢å¤–æ—¶é—´ã€‚ \n> - åå°„çš„è°ƒç”¨ç»•è¿‡äº†ç¼–è¯‘æ—¶çš„ä¼˜åŒ–ã€‚ \n> - åå°„éœ€è¦æ‰§è¡Œé¢å¤–çš„å®‰å…¨æ€§æ£€æŸ¥ã€‚ \n> - æ–¹æ³•è°ƒç”¨çš„é—´æ¥æ€§å¯¼è‡´äº†é¢å¤–çš„æ­¥éª¤å’Œå¼€é”€ã€‚ \n> - ç¼ºä¹JITå¯¹åå°„çš„ä¼˜åŒ–æ”¯æŒã€‚ \n> - é¢‘ç¹ä½¿ç”¨æ—¶ï¼Œå¼€é”€ä¼šæ˜æ˜¾ç´¯ç§¯ã€‚ \n> - åå°„å¯èƒ½ä¼šå¼•å‘å¯¹è±¡åŒ…è£…å’Œæ‹†ç®±æ“ä½œï¼Œè¿›ä¸€æ­¥é™ä½æ•ˆç‡ã€‚\n\n## switchèƒ½å¦ç”¨Stringå½“ä½œcase\nåœ¨jdk1.7ä»¥åæœ‰äº†è¿™ä¸ªè¯­æ³•ç³–ã€‚åœ¨åº•å±‚åŸç†ä¸­switchä»…æ”¯æŒintï¼Œcharç­‰åŸºæœ¬æ•°æ®ç±»å‹ã€‚switchä¸­stringæ˜¯é€šè¿‡caseå“ˆå¸Œå€¼ï¼Œç„¶ååœ¨equalså†…å®¹å¾—åˆ°çš„ã€‚å“ˆå¸Œå€¼æ˜¯ä¸€ä¸ªintç±»å‹çš„ï¼Œç”±äºä¹Ÿå¯èƒ½äº§ç”Ÿå“ˆå¸Œç¢°æ’ï¼Œæ‰€ä»¥è¿˜å¾—å†æ£€æŸ¥å­—ç¬¦ä¸²å†…å®¹æ˜¯å¦ç›¸åŒã€‚\n\n## æ³›å‹\nè™šæ‹Ÿæœºä¸­æ²¡æœ‰æ³›å‹ï¼Œåªæœ‰æ™®é€šç±»å’Œæ™®é€šæ–¹æ³•ï¼Œæ‰€æœ‰æ³›å‹ç±»çš„ç±»å‹å‚æ•°åœ¨ç¼–è¯‘æ—¶éƒ½ä¼šè¢«æ“¦é™¤ï¼Œæ³›å‹ç±»å¹¶æ²¡æœ‰è‡ªå·±ç‹¬æœ‰çš„Classç±»å¯¹è±¡ã€‚æ¯”å¦‚å¹¶ä¸å­˜åœ¨List<String>.classæˆ–æ˜¯List<Integer>.classï¼Œè€Œåªæœ‰List.classã€‚\n\nä¹Ÿå°±æ˜¯è¯´æ³›å‹ä»…ä»…æ˜¯åœ¨ç¼–è¯‘çš„æ—¶å€™åšæ£€æŸ¥ï¼Œè€Œä¸ä¼šçœŸæ­£è½åˆ°jvmé‡Œ\n\n## Objectæœ‰å“ªäº›æ–¹æ³•\n- waitå’Œnotifyä»¥åŠnotifyAllï¼šwaitæ–¹æ³•æ˜¯æ”¾å¼ƒå½“å‰ç›‘è§†å™¨é”ï¼Œè¿›å…¥waitSetï¼ŒçŠ¶æ€å˜ä¸ºWAITã€‚notifyå’ŒnotifyAllæ˜¯å”¤é†’å½“å‰ç›‘è§†å™¨é”ä¸‹é¢waitçš„çº¿ç¨‹ï¼Œåœ¨hotspotä¸­æ˜¯åˆ†åˆ«æ˜¯éšæœºå”¤é†’ä¸€ä¸ªå’Œå…¨éƒ¨å”¤é†’ã€‚è¿™ä¸ªæ–¹æ³•ä»…èƒ½åœ¨synchronizedæ–¹æ³•å—ä¸­ä½¿ç”¨\n- hashCodeå’Œequalsï¼šä¸‹é¢è®²\n- getClassï¼šè·å–Classå¯¹è±¡ï¼Œä¸ç±».classæ–¹æ³•æ˜¯ä¸€æ ·çš„ï¼Œä¸€å…±æœ‰å››ç§æ–¹æ³•è·å–Classå¯¹è±¡ï¼ˆgetClassï¼Œ.classï¼Œç±»åŠ è½½å™¨loadClass,Class.forNameï¼‰\n\n## hashCodeå’Œequals\nè¯´è¿™ä¸¤ä¸ªå°±ç¦»ä¸å¼€é›†åˆï¼Œä¾‹å¦‚hashMapå­˜å‚¨æ˜¯æŒ‰ç…§hashCodeæ•£åˆ—æ‰¾Entryï¼Œå¦‚æœhashCodeç›¸åŒåˆ™åœ¨ä¸€ä¸ªEntryä¸‹ï¼Œä½†æ˜¯æœ‰å¯èƒ½æ˜¯å“ˆå¸Œç¢°æ’ï¼Œæ‰€ä»¥è¿˜è¦æ¯”è¾ƒequalsï¼Œå½“ä¸”ä»…å½“hashCodeç›¸ç­‰å¹¶ä¸”equalsè¿”å›ä¸ºçœŸçš„æ—¶å€™æ‰ä¼šè¢«è®¤ä¸ºæ˜¯ä¸€ä¸ªã€‚åœ¨Objectä¸­é»˜è®¤hashCodeæ˜¯ä¸¤ä¸ªå¯¹è±¡çš„å†…å­˜æ•£åˆ—ï¼Œequalsæ˜¯æ¯”è¾ƒå†…å­˜åœ°å€æ˜¯å¦ç›¸åŒã€‚\n\n**Stringé‡å†™çš„hashCodeå’Œequals**\n\n```java\nString s = \"abc\";\nString s1 = new String(\"abc\");\nSystem.out.println(s.hashCode()+\"  \"+s1.hashCode());\nSystem.out.println(s.equals(s1));\n```\n\næŒ‰é“ç†æ¥è¯´så’Œs1æ˜¯ä¸¤ä¸ªä¸åŒçš„å¯¹è±¡ï¼Œç”±äºä¹‹å‰è¯´çš„såº”è¯¥æ˜¯åœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ï¼Œè€Œs1æ˜¯åœ¨å †ä¸­ï¼ŒhashCodeæŒ‰ç…§Objecté»˜è®¤çš„æ¯”è¾ƒåœ°å€è‚¯å®šæ˜¯ä¸ç›¸åŒçš„ã€‚ä½†æ˜¯Stringé‡å†™äº†hashCodeï¼Œé€šè¿‡å­—ç¬¦ç´¯åŠ çš„æ–¹å¼è®¡ç®—å“ˆå¸Œç ï¼Œåœ¨ä¿è¯äº†åˆ†æ•£çš„åŒæ—¶ä½¿å¾—ç›¸åŒå­—ç¬¦ä¸²çš„å“ˆå¸Œç ç›¸ç­‰ã€‚ä¹Ÿé‡å†™äº†equalsï¼Œæ¯”è¾ƒå­—ç¬¦ä¸²å†…å®¹è€Œä¸æ˜¯æ¯”è¾ƒåœ°å€ã€‚\n\n**ä¸ºä»€ä¹ˆé‡å†™äº†equalså°±å¿…é¡»é‡å†™hashCode**\n\nå¦‚æœä¸¤ä¸ªå¯¹è±¡å†…å®¹ç›¸åŒå°±æ˜¯ä¸€ä¸ªå¯¹è±¡çš„è¯ï¼Œåœ¨seté‡Œé¢ä¸èƒ½é‡å¤ã€‚éœ€è¦é‡å†™equalsï¼Œä½†æ˜¯ä¸é‡å†™hashCodeå¯èƒ½ä¼šåˆ†é…åˆ°ä¸åŒçš„Entryï¼Œè¿™æ ·ä¸¤ä¸ªå¯¹è±¡åŒæ—¶ä¼šè¢«å­˜å‚¨ã€‚æ‰€ä»¥ä¿è¯equalsä¸ºçœŸçš„åŒæ—¶hashCodeä¹Ÿè¦ç›¸åŒã€‚\n\n","tags":["Java"]},{"title":"å¤šçº¿ç¨‹æ€»ç»“","url":"/2024/09/10/å¤šçº¿ç¨‹æ€»ç»“/","content":"## è¿›ç¨‹å’Œçº¿ç¨‹çš„åŒºåˆ«\n1. èµ„æºåˆ†é…çš„è§’åº¦æ¥çœ‹ï¼šè¿›ç¨‹æ˜¯èµ„æºåˆ†é…çš„æœ€å°å•ä½ï¼Œçº¿ç¨‹çš„åˆ‡æ¢ä»…ä»…ä¿å­˜äº†è¾ƒå°‘çš„å¯„å­˜å™¨ï¼Œçº¿ç¨‹ä¸æ˜¯èµ„æºåˆ†é…çš„æœ€å°å•ä½\n2. è°ƒåº¦çš„è§’åº¦ï¼šæ²¡æœ‰å¼•å…¥çº¿ç¨‹çš„æ—¶å€™ï¼Œè¿›ç¨‹æ˜¯è°ƒåº¦çš„æœ€å°å•ä½ï¼Œæœ‰äº†çº¿ç¨‹ä¹‹åæ“ä½œç³»ç»Ÿè°ƒåº¦çš„å°±æ˜¯çº¿ç¨‹äº†ã€‚\n3. åˆ‡æ¢å¼€é”€æ¥çœ‹ï¼šçº¿ç¨‹çš„åˆ‡æ¢å¼€é”€è¾ƒå°ï¼Œåªç”¨ä¿å­˜è¾ƒå°‘çš„å¯„å­˜å™¨ï¼Œè¿›ç¨‹åˆ‡æ¢çš„å¼€é”€è¾ƒå¤§\n4. å¹¶å‘çš„è§’åº¦æ¥çœ‹ï¼šåŒä¸€ä¸ªè¿›ç¨‹çš„çº¿ç¨‹å¯ä»¥å¹¶å‘ï¼Œä¸åŒè¿›ç¨‹çš„çº¿ç¨‹ä¹‹é—´ä¹Ÿå¯ä»¥å¹¶å‘\n\n## Javaçš„çº¿ç¨‹å’Œæ“ä½œç³»ç»Ÿçš„çº¿ç¨‹æœ‰ä»€ä¹ˆåŒºåˆ«\nåœ¨jdk1.2ä»¥å‰ï¼Œjavaçš„çº¿ç¨‹æ˜¯ç”¨æˆ·çº§çº¿ç¨‹ï¼Œä¹Ÿå°±æ˜¯ä¸€å¯¹å¤šæ¨¡å‹ï¼Œå‘ä¸‹æ“ä½œç³»ç»Ÿç”³è¯·ä¸€ä¸ªçº¿ç¨‹ï¼Œè¿™ä¸ªçº¿ç¨‹æ¥è½®è¯¢javaçš„æ“ä½œï¼Œåœ¨ç”¨æˆ·å±‚é¢çœ‹ä¸Šå»æ˜¯æœ‰å¤šçº¿ç¨‹ï¼Œä½†è¿™æ ·æ•ˆç‡å¹¶æ²¡æœ‰æå‡\n\nåœ¨æ­¤ä¹‹åjavaçš„çº¿ç¨‹å¯ä»¥ç›´æ¥ç”¨å†…æ ¸çº§çº¿ç¨‹ï¼Œä¹Ÿå°±æ˜¯javaåˆ›å»ºçš„çº¿ç¨‹å°±æ˜¯æ“ä½œç³»ç»Ÿè®¤å¯çš„ä¸€ä¸ªçº¿ç¨‹ã€‚\n\n## åˆ›å»ºçº¿ç¨‹çš„æ–¹æ³•\nç½‘ä¸Šéƒ½è¯´æœ‰å››äº”ç§æ–¹æ³•ï¼Œä½†æ˜¯å…¶å®åªç”¨ä¸€ç§å°±æ˜¯thread.start()æ–¹æ³•ï¼Œä½†æ˜¯ä¸ºäº†å®Œæ•´æ€§è¿˜æ˜¯è¯´ä¸€ä¸‹è¿™å››ç§æ–¹æ³•ï¼š\n1. ç»§æ‰¿Thread\n2. å®ç°Runnableæ¥å£:runæ–¹æ³•ä¸å…è®¸æœ‰è¿”å›å€¼ï¼Œä¹Ÿä¸èƒ½æŠ›å‡ºå¼‚å¸¸\n3. å®ç°Callableæ¥å£ï¼šcallå¯ä»¥æœ‰è¿”å›å€¼ï¼Œå¯ä»¥æŠ›å‡ºå¼‚å¸¸\n4. çº¿ç¨‹æ± \n\n> ä»€ä¹ˆæ—¶å€™å®ç°runnableæ¥å£ä»€ä¹ˆæ—¶å€™ç»§æ‰¿threadï¼šç”±äºjavaæ˜¯å•ç»§æ‰¿çš„ï¼Œå¦‚æœæœ‰ç»§æ‰¿åˆ«çš„ç±»å°±ä¸èƒ½ç»§æ‰¿Threadäº†ï¼Œæ­¤æ—¶å°±è¦ä½¿ç”¨Runnableæ¥å£\n> runnableå’Œcallableåªæ˜¯ä¸¤ä¸ªæ¥å£è€Œå·²ï¼Œç›´æ¥è¿è¡Œå¯¹åº”çš„runå’Œcallæ˜¯ä¸èƒ½æˆä¸ºä¸€ä¸ªçº¿ç¨‹çš„ï¼Œstartæ˜¯Threadç±»æ‰æœ‰çš„æ–¹æ³•ï¼Œæ‰€ä»¥è¦çœŸæ­£è¿è¡Œèµ·æ¥çº¿ç¨‹éœ€è¦new Thread(),è¿™é‡Œé¢ä¼ å…¥çš„æ˜¯ä¸€ä¸ªRunnableå‚æ•°ï¼ŒCallableä¸è¡Œï¼Œéœ€è¦ç”¨futureTaskåŒ…è£…\n \n\n> callableæ€ä¹ˆç”¨ï¼Ÿ\n> 1. callableå’ŒfutureTask:ç”±äºnew Threadè¦ä¼ ä¸€ä¸ªRunnableå‚æ•°ï¼ŒCallableä¸æ˜¯ï¼›æ‰€ä»¥è¦ç”¨futureTaskåŒ…è£…\n> 2. callableå’Œçº¿ç¨‹æ± ï¼šsubmitç»™çº¿ç¨‹æ± è¿”å›ä¸€ä¸ªfutureå¯¹è±¡\n\n## Futureå’ŒFutureTask\nfutureæ˜¯å¼‚æ­¥ç¼–ç¨‹çš„ä¸€ä¸ªä½“ç°ï¼Œå½“å‰çº¿ç¨‹æ­£åœ¨æ‰§è¡Œï¼Œæˆ‘éœ€è¦å–åˆ°ç¨‹åºè¿è¡Œç»“æŸçš„ç»“æœï¼Œä¹Ÿå°±æ˜¯æœªæ¥çš„ç»“æœã€‚å…·æœ‰å–æ¶ˆä»»åŠ¡ï¼ŒæŸ¥çœ‹ä»»åŠ¡æ‰§è¡Œæƒ…å†µï¼Œè·å–ä»»åŠ¡æ‰§è¡Œç»“æœç­‰åŠŸèƒ½ã€‚è€ŒfutureTaskæ˜¯å…¶çš„ä¸€ä¸ªå®ç°ç±»ï¼ŒåŒæ—¶å®ç°äº†futureå’Œrunnableæ¥å£ï¼Œç”±äºnew Threadåªèƒ½ä¼ Runnableæ¥å£ï¼ŒfutureTaskæ­£å¼ä¸ºäº†æ­é…Callableæ¥å£ï¼Œä½¿ç”¨çš„æ—¶å€™new Thread(new FutureTask(new Callable))\n\n## çº¿ç¨‹æ± çš„submitå’Œexecuteä»€ä¹ˆåŒºåˆ«\n1. submitè¿”å›å€¼ä¸ºFutureï¼Œå¯ä»¥æ‰§è¡ŒCallableå’ŒRunnableä»»åŠ¡ï¼Œä½†æ˜¯å¦‚æœæ˜¯runnableé‚£future.getè¿”å›å°±æ˜¯nullï¼Œä¹Ÿå¯ä»¥æŠ›å‡ºå¼‚å¸¸\n2. executeè¿”å›å€¼ä¸ºç©ºï¼Œåªèƒ½æ‰§è¡ŒRunnableä»»åŠ¡\n\n## çº¿ç¨‹çš„çŠ¶æ€\nç±»ä¼¼åŸæ¥408å­¦çš„çº¿ç¨‹çŠ¶æ€ï¼Œä½†æ˜¯åœ¨javaä¸­è¿™äº›çŠ¶æ€ç•¥æœ‰ä¸åŒï¼Œç›¸æ¯”äºåº•å±‚æ“ä½œç³»ç»Ÿï¼Œè¿™äº›çŠ¶æ€æ›´åŠ é«˜å±‚æ¬¡ï¼Œå› ä¸ºä¸æ¶‰åŠåˆ°ioæ“ä½œé˜»å¡è¿›ç¨‹ï¼š\n- NEW:åˆå§‹çŠ¶æ€ï¼Œä¸€èˆ¬æ˜¯new Thread()ï¼Œåˆ›å»ºå‡ºæ¥ä½†æ˜¯è¿˜æ²¡æœ‰æ‰§è¡Œstartæ–¹æ³•\n- RUNNABLE:è¿è¡ŒçŠ¶æ€ï¼Œæ‰§è¡Œäº†startæ–¹æ³•\n- BLOCKED:è¢«synchronizedæ–¹æ³•é˜»å¡äº†ï¼Œæ²¡æœ‰æŠ¢åˆ°é”å°±è¿›å…¥è¿™ä¸ªçŠ¶æ€ï¼Œç­‰åˆ°é”é‡Šæ”¾å°±å˜ä¸ºRUNNABLE\n- WAITING:ä¸€èˆ¬æ˜¯çº¿ç¨‹ä¹‹é—´é€šè®¯ï¼Œè°ƒç”¨äº†waitæ–¹æ³•å˜æˆwaitingçŠ¶æ€ï¼Œè€Œç­‰åˆ°notifyæˆ–è€…notifyAllå˜ä¸ºè¿è¡Œæ€\n- TIME_WAITING:å…·æœ‰å…·ä½“æ—¶é—´çš„ç­‰å¾…çŠ¶æ€\n- TERMINATED:çº¿ç¨‹ç»ˆæ­¢\n\n**BLOCKEDå’ŒWAITINGçš„åŒºåˆ«**\n- è§¦å‘æ¡ä»¶ï¼šçº¿ç¨‹æ²¡æœ‰è·å–åˆ°ç›‘è§†å™¨é”ï¼ˆsynchronizedï¼‰å°±BLOCKINGï¼ŒWAITINGæ˜¯è·å–åˆ°äº†synchronizedé”ä½†æ˜¯é”å¯¹è±¡waitäº†ï¼Œä¹Ÿå°±æ˜¯é‡Šæ”¾äº†é”ï¼Œä¸»è¦ç”¨äºçº¿ç¨‹é€šè®¯\n- å”¤é†’æ¡ä»¶ï¼šè·å–åˆ°é”äº†ä¹‹åä¼šè§£é™¤BLOCKINGï¼Œè€Œåˆ«çš„çº¿ç¨‹å¯¹é”å¯¹è±¡.notifyæˆ–è€…notifyAllä¹‹åä¼šå”¤é†’waitingçº¿ç¨‹ï¼Œä½†æ˜¯è¦ç»§ç»­æ‰§è¡Œè¿˜æ˜¯è¦è·å–é”\n\n**notifyå’ŒnotifyAllçš„åŒºåˆ«**\n- notifyéšæœºå”¤é†’ä¸€ä¸ªï¼ˆè¿™ä¸ªæ˜¯hotspotçš„æœºåˆ¶ï¼Œå¯èƒ½åˆ«çš„è™šæ‹Ÿæœºæ˜¯æŒ‡å®šçš„ï¼‰\n- notifyAllï¼Œå½“å‰é”å¯¹è±¡ä¸‹æ‰€æœ‰çš„WAITINGçº¿ç¨‹ï¼Œå…±åŒäº‰æŠ¢ã€‚å”¤é†’çš„çº¿ç¨‹åœ¨è¢« notify() æˆ– notifyAll() å”¤é†’åï¼Œä»ç„¶éœ€è¦é‡æ–°äº‰æŠ¢å¯¹è±¡çš„é”ã€‚å®ƒä¼šä» WAITING çŠ¶æ€è½¬æ¢åˆ° BLOCKED çŠ¶æ€ï¼Œç­‰å¾…å¯¹è±¡çš„é”é‡Šæ”¾ã€‚\n\n**waitå’Œsleepæ–¹æ³•çš„åŒºåˆ«**\n- waitæ˜¯Objectçš„æ–¹æ³•ï¼Œsleepæ˜¯Threadçš„æ–¹æ³•\n- waité‡Šæ”¾é”ï¼Œsleepä¸é‡Šæ”¾é”\n- waitéœ€è¦notifyå”¤é†’è€Œsleepåˆ°æ—¶é—´å°±å”¤é†’äº†\n- waitä¸»è¦ç”¨äºè¿›ç¨‹åŒæ­¥ï¼Œsleepå»¶æ—¶\n\n> ä¸ºä»€ä¹ˆwaitå®šä¹‰åœ¨objecté‡Œé¢è€Œsleepå®šä¹‰åœ¨Threadé‡Œé¢ï¼š\n> ä¸ä»–ä»¬ä½¿ç”¨çš„åœºåˆæœ‰å…³ï¼Œwaitéœ€è¦åœ¨synchronizedæ–¹æ³•ä¸­è¿ç”¨ï¼Œè€Œä»£ç å—çš„é”æ­£æ˜¯objectï¼Œæ“ä½œçš„å¹¶ä¸æ˜¯çº¿ç¨‹\n> è€Œsleepçš„ä½œç”¨æ˜¯è®©çº¿ç¨‹ç¡çœ ä¸€æ®µæ—¶é—´ï¼Œè¿™æ˜¾ç„¶è·Ÿé”æ²¡ä»€ä¹ˆå…³ç³»ï¼Œå°±å®šä¹‰åœ¨çº¿ç¨‹ä¸­\n\n## æ­»é”çš„å››ä¸ªæ¡ä»¶ï¼Œé€šè¿‡ä»€ä¹ˆæ–¹æ³•è§£å†³\n- äº’æ–¥æ¡ä»¶ï¼šä¸€ä¸ªèµ„æºåŒæ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è®¿é—®\n- ä¸å‰¥å¤ºæ¡ä»¶ï¼šä¸€ä¸ªçº¿ç¨‹çš„èµ„æºä¸å¯ä»¥è¢«åˆ«çš„çº¿ç¨‹å‰¥å¤º\n- å æœ‰ä¸”ç­‰å¾…æ¡ä»¶ï¼šä¸€ä¸ªçº¿ç¨‹è·å–ä¸åˆ°æ›´å¤šçš„èµ„æºï¼ŒåŸæ¥æŒæœ‰çš„èµ„æºä¹Ÿä¸ä¼šé‡Šæ”¾\n- å¾ªç¯ç­‰å¾…æ¡ä»¶ï¼šèµ„æºçš„è¯·æ±‚å˜æˆäº†ä¸€ä¸ªç¯ï¼Œå¤§å®¶éƒ½æ‹¿ä¸åˆ°å¯¹åº”çš„èµ„æº\n\n> ç ´åè¿™å››ä¸ªæ¡ä»¶æ˜¯**æ­»é”é¢„é˜²**è¦åšçš„äº‹æƒ…ã€‚æ­¤å¤–è¿˜æœ‰æ­»é”é¿å…ï¼ˆé“¶è¡Œå®¶ç®—æ³•ï¼‰ï¼Œæ­»é”æ£€æµ‹å’Œæ¢å¤ï¼ˆæœ‰å‘å›¾æ£€æµ‹æ–¹æ³•ï¼‰ã€‚è¿™ä¸‰ä¸ªå¤§çš„æ–¹æ³•æ€§èƒ½ç”±ä½åˆ°é«˜ï¼Œå¯¹æ­»é”çš„æ§åˆ¶ç”±ä¸¥æ ¼åˆ°æ¾ã€‚\n\n- ç ´åäº’æ–¥æ¡ä»¶ï¼šå¤šå¢åŠ ä¸´ç•Œèµ„æºçš„æ•°é‡ï¼ˆè™šæ‹ŸåŒ–ï¼‰\n- ç ´åä¸å‰¥å¤ºæ¡ä»¶ï¼šæŠ¢å å¼è°ƒåº¦ï¼ˆè¿˜æœ‰ä¸€ç§æ˜¯ååŒå¼è°ƒåº¦ï¼Œæ˜¯ç­‰åˆ°å½“å‰çº¿ç¨‹ç»“æŸæ‰è¿›è¡Œçº¿ç¨‹è°ƒåº¦ï¼‰ï¼Œå¾—ä¸åˆ°èµ„æºå°±é‡Šæ”¾\n- ç ´åå æœ‰ç­‰å¾…æ¡ä»¶ï¼šå¯ä»¥å…ˆç”³è¯·ï¼Œæ£€æŸ¥å½“å‰ç³»ç»Ÿå‰©ä½™èµ„æºæ˜¯å¦èƒ½å¤Ÿè®©çº¿ç¨‹è¿è¡Œï¼Œä¸€æ¬¡æ€§å…¨æ‹¿è€Œä¸æ˜¯ä¸€æ¬¡æ‹¿ä¸€ç‚¹\n- å¾ªç¯ç­‰å¾…æ¡ä»¶ï¼šç¼–å·ï¼Œç±»ä¼¼TCPçš„åŒæ­¥å·\n\n## volatileå…³é”®å­—\n1. åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„ CPU ç¼“å­˜ï¼Œçº¿ç¨‹åœ¨è¯»å†™å˜é‡æ—¶å¯èƒ½ä¼šå…ˆå°†å˜é‡çš„å€¼ç¼“å­˜åœ¨è‡ªå·±çš„å·¥ä½œå†…å­˜ä¸­ï¼Œè€Œä¸æ˜¯ç›´æ¥ä»ä¸»å†…å­˜ä¸­è¯»å–æˆ–å†™å…¥ã€‚ä½¿ç”¨volatileå…³é”®å­—å°±å‘Šè¯‰ç¨‹åºè¿™ä¸ªå˜é‡æ˜¯ä¸ç¨³å®šçš„ï¼Œç¦ç”¨cpuç¼“å­˜ï¼Œæ¯æ¬¡æ‰¾è¿™ä¸ªå˜é‡éƒ½éœ€è¦å»ä¸»å­˜å–ï¼Œ\n2. åœ¨jvmçš„æ‰§è¡Œä¼˜åŒ–ä¸­å¯èƒ½å‡ºç°æŒ‡ä»¤é‡æ’åºï¼Œä¹Ÿå°±æ˜¯123æ¡æŒ‡ä»¤ï¼Œå¯èƒ½å®é™…å˜æˆ132ï¼Œvolatileå…³é”®å­—èƒ½å¤Ÿåœ¨å…¶ä¸­åŠ ä¸Šå†…å­˜å±éšœï¼Œç¦æ­¢æŒ‡ä»¤é‡æ’åºï¼ˆä¸»è¦ç”¨åœ¨åŒæ ¡éªŒå•ä¾‹æ¨¡å¼ï¼‰\n```java\npublic class Singleton{\n    private static volatile Singleton singleton;\n    public Singleton(){}\n    public Singleton getSingleton(){\n        if (singleton == null){\n            synchronized (this){\n                if (singleton == null){\n                    singleton = new Singleton();\n                }\n            }\n        }\n        return singleton;\n    }\n}\n```\n3. èƒ½ä¿è¯å¯è§æ€§ï¼Œä½†ä¸èƒ½ä¿è¯åŸå­æ€§ï¼Œä¾‹å¦‚å†å‡ºç°i++è¿™ç§æ“ä½œçš„æ—¶å€™ï¼Œå³ä½¿volatile iï¼Œè¿˜æ˜¯ä¼šæœ‰çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚å› ä¸ºi++å…¶å®æ˜¯ä¸‰ä¸ªæ“ä½œï¼Œä»å†…å­˜å–å‡ºiï¼Œå¯¹è¿™ä¸ªå‰¯æœ¬+1ï¼Œå†æŠŠå…¶å†™å›å†…å­˜ã€‚æ­¤æ—¶ä¸¤ä¸ªçº¿ç¨‹æ¥æ“ä½œå°±ä¼šå°‘ä¸€æ¬¡+1ã€‚ï¼ˆå¯ä»¥åŠ é”synchronized,reentrantlockæˆ–è€…ç”¨AtomicIntegerçš„casæ“ä½œï¼‰\n\n> å†…å­˜å±éšœï¼š\n> - å†™ volatile å˜é‡æ—¶ï¼š å½“ä¸€ä¸ªçº¿ç¨‹å†™å…¥ volatile å˜é‡æ—¶ï¼ŒJVM ä¼šåœ¨å†™æ“ä½œåæ’å…¥ä¸€ä¸ªå†™å†…å­˜å±éšœï¼ˆStore Memory Barrierï¼‰ï¼Œç¡®ä¿æ‰€æœ‰åœ¨ volatile å˜é‡å†™æ“ä½œä¹‹å‰çš„å†…å­˜æ“ä½œéƒ½å·²ç»å®Œæˆï¼Œå¹¶ä¸”è¿™äº›æ“ä½œçš„ç»“æœå¯¹å…¶ä»–çº¿ç¨‹å¯è§ã€‚ åœ¨ Java å†…å­˜æ¨¡å‹ä¸­ï¼Œå†™ volatile å˜é‡æ—¶ä¼šç¡®ä¿è¯¥å†™å…¥æ“ä½œä¹‹å‰çš„æ‰€æœ‰å˜é‡ä¿®æ”¹éƒ½è¢«åˆ·æ–°åˆ°ä¸»å†…å­˜ä¸­ï¼Œç„¶åå°† volatile å˜é‡çš„å€¼å†™å…¥ä¸»å†…å­˜ã€‚ \n> - è¯» volatile å˜é‡æ—¶ï¼šå½“ä¸€ä¸ªçº¿ç¨‹è¯»å– volatile å˜é‡æ—¶ï¼ŒJVM ä¼šåœ¨è¯»æ“ä½œå‰æ’å…¥ä¸€ä¸ªè¯»å†…å­˜å±éšœï¼ˆLoad Memory Barrierï¼‰ï¼Œç¡®ä¿æ‰€æœ‰åœ¨ volatile å˜é‡è¯»æ“ä½œä¹‹åçš„å†…å­˜æ“ä½œéƒ½ä¸ä¼šè¢«é‡æ’åºåˆ°å®ƒä¹‹å‰ã€‚ åœ¨ Java å†…å­˜æ¨¡å‹ä¸­ï¼Œè¯» volatile å˜é‡æ—¶ï¼Œä¼šç¡®ä¿åœ¨è¯»å–è¿™ä¸ª volatile å˜é‡ä¹‹åï¼Œçº¿ç¨‹èƒ½å¤Ÿçœ‹åˆ°æ‰€æœ‰å…¶ä»–çº¿ç¨‹åœ¨å†™å…¥è¯¥ volatile å˜é‡ä¹‹å‰å¯¹å…¶ä»–å˜é‡çš„ä¿®æ”¹ã€‚\n\n## synchronized\n1. å¯ä»¥ä¿®é¥°å®ä¾‹æ–¹æ³•ï¼Œé”ä½å½“å‰å¯¹è±¡\n2. ä¿®é¥°é™æ€æ–¹æ³•ï¼Œé”ä½å½“å‰ç±»ã€‚è¿™é‡Œå°±ä¼šæœ‰ä¸ªæœ‰æ„æ€çš„äº‹æƒ…ï¼Œä¿®é¥°åœ¨é™æ€æ–¹æ³•ä¸Šçš„synchronizedå’Œå®ä¾‹æ–¹æ³•ä¸Šçš„**ä¸äº’æ–¥**ï¼Œå› ä¸ºé™æ€æ–¹æ³•é”ä½çš„æ˜¯å½“å‰ç±»ï¼Œå®ä¾‹æ–¹æ³•é”ä½çš„æ˜¯å¯¹è±¡\n3. ä¿®é¥°ä»£ç å—ï¼Œè¿™ä¸ªæ¯”è¾ƒçµæ´»\n> æ³¨æ„è¿™é‡Œä¸èƒ½ä¿®é¥°æ„é€ å‡½æ•°ï¼Œæ„é€ å‡½æ•°æœ¬èº«å°±æ˜¯çº¿ç¨‹å®‰å…¨çš„\n\n**åŸç†**\nåŸºäºjvmçš„monitorï¼Œåœ¨ä»£ç å—è¿›å…¥å‰åŠ ä¸Šmonitorenterï¼Œé€€å‡ºçš„æ—¶å€™åŠ ä¸Šmonitorexitï¼Œä¹Ÿæ˜¯å¯é‡å…¥çš„ï¼Œåº•å±‚æ˜¯ç›‘è§†å™¨ç»´æŠ¤äº†ä¸€ä¸ªstateå­—æ®µï¼Œæœ‰é”è¿›æ¥å°±+1ï¼Œé‡å…¥å¤šæ¬¡å°±+nï¼Œé€€å‡º-1ï¼ŒåŒæ—¶ä¹Ÿä¼šæœ‰ç»´æŠ¤ä¸€ä¸ªé˜Ÿåˆ—å­˜æ”¾æœªè·å–é”çš„å¯¹è±¡ï¼Œç­‰åˆ°é‡Šæ”¾äº†å°±ä¼šå”¤é†’ï¼ˆBLOCKEDï¼‰\n\nä¸¤ä¸ªé˜Ÿåˆ—entryListå’ŒwaitList:\n- entryListæ˜¯è¿›å…¥é”ä»£ç å—çš„æ‰€æœ‰çº¿ç¨‹ï¼Œå½“é”é‡Šæ”¾äº†ä¹‹åå…¶ä¸­çš„ä¸€ä¸ªçº¿ç¨‹ä¼šç»™monitorä¸Šé”ï¼ŒåŒæ—¶+1ï¼ˆé˜Ÿåˆ—é‡Œçš„çŠ¶æ€ä¸ºBLOCKEDï¼‰ï¼Œæ³¨æ„è¿™é‡Œæ˜¯é˜Ÿåˆ—é‡Œæ‰€æœ‰çº¿ç¨‹éƒ½è¿›è¡Œç«äº‰ï¼Œæ‰€ä»¥synchronizedæ˜¯éå…¬å¹³é”\n- waitListæ˜¯è°ƒç”¨äº†waitæ–¹æ³•çš„çº¿ç¨‹ï¼Œç­‰å¾…notifyæˆ–è€…notifyAllè¿›è¡Œå”¤é†’ï¼Œå”¤é†’ä¹‹åè¿˜éœ€è¦é‡æ–°è·å¾—é”ï¼Œä¹Ÿå°±æ˜¯è¦è¿›å…¥entryListé‡Œï¼ˆçŠ¶æ€ä¸ºWAITINGï¼‰\n\n![](../img/Java/img_9.png)\n\n**é”å‡çº§**\n- ä¸åŠ é”ï¼š\n- åå‘é”ï¼šå½“ç¬¬ä¸€ä¸ªçº¿ç¨‹è¿›å…¥ä¹‹åä¼šç»™å…¶åŠ ä¸Šåå‘é”ï¼Œä½¿å¾—è¿™ä¸ªèµ„æºåå‘ã€‚\n- è½»åº¦é”ï¼šä½¿ç”¨casæ“ä½œ\n- é‡åº¦é”ï¼š\n\n> ä¸ºä»€ä¹ˆä¼šæœ‰åå‘é”è¿™ä¸ªè¿‡ç¨‹ï¼š\n> å¯¹äºç«äº‰ä¸æ¿€çƒˆä½†æ˜¯è¿˜æœ‰åŠ äº†synchronizedå…³é”®å­—çš„ï¼Œå¦‚æœæ˜¯å•çº¿ç¨‹å°±æ²¡æœ‰å¿…è¦è¿›è¡Œé”å’Œä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œåå‘é”çš„åˆè¡·æ­£æ˜¯ä¸ºäº†å‡å°ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å¼€é”€ã€‚å¦‚æœä¸€ä¸ªçº¿ç¨‹åå¤è¿›å…¥å’Œé€€å‡ºåŒæ­¥å—ï¼Œè€Œæ²¡æœ‰å…¶ä»–çº¿ç¨‹äº‰ç”¨è¿™æŠŠé”ï¼Œé‚£ä¹ˆè¿™äº›åŠ é”è§£é”çš„å¼€é”€æ˜¯å®Œå…¨å¤šä½™çš„ã€‚\n\n## AQS\næŠ½è±¡é˜Ÿåˆ—åŒæ­¥å™¨ï¼ˆAbstractQueuedSynchronizerï¼‰æä¾›äº†ä¸€ç§åŒæ­¥æœºåˆ¶ï¼Œè¢«åº”ç”¨äºReentrantlockï¼Œsemaphoreï¼ŒcyclicBarrierç­‰æ’ä»–å’Œå…±äº«é”ç»“æ„ä¸­ã€‚\n\nåœ¨è¯´AQSä¹‹å‰å…ˆè¦è®¨è®ºä¸€ä¸‹CHLé”ï¼Œå› ä¸ºAQSæ˜¯åŸºäºCHLçš„ã€‚CHLé”æ˜¯ä¸€ä¸ªé˜Ÿåˆ—ç»“æ„ï¼Œå¤´èŠ‚ç‚¹æ˜¯ä¸€ä¸ªç©ºèŠ‚ç‚¹ï¼Œå½“çº¿ç¨‹è¿›å…¥åä¼šå¯¹å‰é©±èŠ‚ç‚¹çš„èµ„æºé‡Šæ”¾çŠ¶æ€åšcasï¼Œä¾‹å¦‚ç¬¬ä¸€ä¸ªçº¿ç¨‹è¿›å…¥ä¹‹åå°±å¯¹è¡¨å¤´èŠ‚ç‚¹çš„é”èµ„æºcasï¼Œè·å–åˆ°äº†å°±æ”¹å˜è‡ªå·±çš„å€¼ä¸ºfalseï¼Œåç»­å¦å¤–ä¸€ä¸ªçº¿ç¨‹è¿›å…¥ä¹‹åå°±ä¼šè½®è¯¢ä¸Šä¸€ä¸ªèŠ‚ç‚¹çš„çŠ¶æ€ï¼Œæ‹‰æˆä¸€ä¸ªé˜Ÿåˆ—ã€‚\n\nè¿™ç§ç»“æ„çš„å¥½å¤„æ˜¯èµ„æºçŠ¶æ€åˆ†å¸ƒåœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šï¼Œä½†åŒæ—¶ä¹Ÿå¢å¤§äº†cpuçš„å¼€é”€ï¼Œå› ä¸ºæ¯ä¸€ä¸ªèŠ‚ç‚¹éƒ½éœ€è¦è½®è¯¢ã€‚\n\nAQSæ­£å¼åŸºäºè¿™ç§æ€æƒ³ï¼Œé¦–å…ˆä»–æŠŠCHLçš„è™šæ‹Ÿé˜Ÿåˆ—æ”¹é€ æˆäº†æ˜¾å¼é˜Ÿåˆ—ï¼Œä¿å­˜äº†å‰é©±å’Œåç»§ï¼ˆä¸ºäº†æ»¡è¶³ä¸€äº›å¯¹äºå…¬å¹³é”å’Œéå…¬å¹³é”çš„è¦æ±‚ï¼Œä½¿ç”¨äº†åŒå‘é“¾è¡¨ï¼‰ï¼Œå…¨å±€ç»´æŠ¤ä¸€ä¸ªstateï¼Œå½“è·å–åˆ°é”ä¹‹åstate+1ï¼Œå¯ä»¥å®ç°é”é‡å…¥ã€‚\n\n## reentrantLock\n\nreentrantLockåŸºäºaqsï¼Œå®ç°å¯é‡å…¥ï¼Œå¯ä¸­æ–­ï¼Œå¯ä»¥è®¾ç½®å…¬å¹³é”ï¼Œå¯ä»¥æœ‰å¤šä¸ªæ¡ä»¶è®¾ç½®ï¼Œå¯ä»¥è®¾ç½®è¶…æ—¶æ—¶é—´ã€‚\n\n","tags":["Java"]},{"title":"é›†åˆæ€»ç»“","url":"/2024/09/10/é›†åˆæ€»ç»“/","content":"## æ•°ç»„ä¸é›†åˆåŒºåˆ«ï¼Œç”¨è¿‡å“ªäº›ï¼Ÿ\n1. æ•°ç»„æ˜¯å®šé•¿çš„ï¼Œé›†åˆä¸æ˜¯å®šé•¿çš„ï¼Œä¾‹å¦‚ArrayListæ˜¯åŠ¨æ€æ•°ç»„\n2. æ•°ç»„å­˜å‚¨çš„æ˜¯åŸºæœ¬æ•°æ®ç±»å‹å’Œå¯¹è±¡ï¼Œè€Œé›†åˆåªèƒ½å­˜å‚¨å¯¹è±¡ï¼ˆè¿™é‡Œä¹Ÿå¯ä»¥å¼•ç”³å‡ºä¸ºä»€ä¹ˆè¦æœ‰åŒ…è£…ç±»ï¼Œä¸ºäº†ç»Ÿä¸€é›†åˆçš„æ“ä½œéœ€è¦æŠŠåŸºæœ¬æ•°æ®ç±»å‹åŒ…è£…æˆå¯¹è±¡ï¼Œintå˜æˆIntegerï¼Œä½†æ˜¯è¿™æ ·ä¹Ÿä¼šæœ‰è‡ªåŠ¨æ‹†ç®±å¯¼è‡´çš„æ€§èƒ½é—®é¢˜ï¼‰\n3. æ•°ç»„å¯ä»¥éšæœºè®¿é—®ï¼Œé›†åˆéœ€è¦é€šè¿‡è¿­ä»£å™¨æˆ–è€…å…¶ä»–æ–¹æ³•è®¿é—®ï¼ˆå…¶å®è¿˜æ˜¯ç”±äºåŒ…è£…äº†ï¼‰\n\nç”¨è¿‡å“ªäº›ï¼šArrayList,LinkedList,Vector,HashSet,TreeSet,BlockingQueue,HashMap.TreeMap,LinkedHashMap\n## è¯´è¯´Javaä¸­çš„é›†åˆï¼Ÿ\nJavaçš„é›†åˆç±»åˆ†ä¸ºä¸¤ä¸ªå¤§ç±»ï¼ŒCollectionæ¥å£å®ç°çš„Listï¼ŒSetå’ŒQueueï¼Œä»¥åŠMapæ¥å£ã€‚Collectionå­˜å‚¨çš„æ˜¯**å•ä¸€å…ƒç´ **ï¼Œè€ŒMapå­˜å‚¨çš„æ˜¯**é”®å€¼å¯¹**ã€‚\n\nåœ¨Collectionæ¥å£ä¸‹ï¼š\n1. Listæ˜¯é¡ºåºçš„ï¼Œä¸»è¦å®ç°ç±»æ˜¯ArrayListï¼Œåº•å±‚åŸºäºåŠ¨æ€æ•°ç»„ï¼ŒLinkedListï¼Œåº•å±‚åŸºäºåŒå‘é“¾è¡¨ï¼ŒVectorï¼Œæ˜¯åŠ äº†é‡åº¦é”çš„æœ‰çº¿ç¨‹å®‰å…¨çš„é¡ºåºæ•°æ®ç»“æ„ï¼Œç”±äºæ€§èƒ½ä¸€èˆ¬å·²ç»å¾ˆå°‘ç”¨äº†\n2. Setæ˜¯é›†åˆï¼Œå­˜å‚¨çš„å…ƒç´ ä¸èƒ½é‡å¤ï¼šHashSetåŸºäºHashMapï¼ˆæœ‰å¾…è€ƒç©¶ï¼‰ï¼ŒTreeSetæ˜¯åŸºäºçº¢é»‘æ ‘ï¼ŒæŒ‰ç…§æŸç§é¡ºåºæœ‰åºçš„é›†åˆã€‚\n3. QUeueæ˜¯é˜Ÿåˆ—ï¼Œäº†è§£è¾ƒå°‘\n\nåœ¨Mapæ¥å£ä¸‹ï¼š\n1. HashMapï¼šjkd1.7åŸºäºEntry+é“¾è¡¨çš„å½¢å¼ï¼Œåœ¨1.8ä¹‹åæ”¹æˆNode+é“¾è¡¨+çº¢é»‘æ ‘ã€‚çº¿ç¨‹ä¸å®‰å…¨\n2. TreeMapï¼šåŸºäºçº¢é»‘æ ‘ï¼Œå¯ä»¥æ ¹æ®keyçš„å¤§å°æ’åº\n3. LinkedHashMapï¼šåŸºäºHashMapï¼Œä½†æ˜¯å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªåŒå‘é“¾è¡¨æ¥æŒ‡å®šé¡ºåºï¼Œ1.7ä¹‹å‰æ˜¯å¾ªç¯é“¾è¡¨ï¼Œ1.8ä»¥åæ˜¯åŒå‘é“¾è¡¨\n## Javaä¸­çš„çº¿ç¨‹å®‰å…¨çš„é›†åˆæ˜¯ä»€ä¹ˆï¼Ÿ\nåœ¨java.utilåŒ…ä¸‹çš„æ•°æ®ç»“æ„ï¼Œä¹Ÿå°±æ˜¯æœ¬èº«è®¾è®¡å°±æ˜¯ä¸ºäº†çº¿ç¨‹å®‰å…¨çš„ï¼š\n1. Vectorï¼šæ“ä½œéƒ½ç”¨äº†synchronizedæ–¹æ³•ï¼Œç”¨copyOnWriteArrayListæ›¿ä»£\n2. HashTableï¼šä¹Ÿæ˜¯åŠ äº†é‡åº¦é”çš„å“ˆå¸Œè¡¨ï¼Œæ€§èƒ½ä¸å¦‚concurrentHashMap\n\nåœ¨1.8ä»¥åæœ‰Concurrentçš„åŒ…å‡ºç°ï¼Œå¸¦æ¥äº†å¾ˆå¤šæ–°çš„çº¿ç¨‹å®‰å…¨çš„é›†åˆ\n1. ConcurrentHashMapï¼š1.7ä¹‹å‰æ˜¯åˆ†æ®µé”ï¼ŒæŠŠæ¯ä¸ªSegmentéƒ½é”ä¸Šï¼Œé»˜è®¤å¯ä»¥å®ç°16ä¸ªçº¿ç¨‹å¹¶å‘ï¼ˆå‰ææ˜¯ä»–ä»¬è®¿é—®çš„è¿™äº›æ•°æ®éƒ½åˆ†å¸ƒåœ¨16ä¸ªä¸åŒçš„Segmentä¸Šï¼‰ã€‚1.8ä»¥åæ˜¯ç”¨äº†Node+é“¾è¡¨+çº¢é»‘æ ‘ï¼Œé”çš„ç²’åº¦å˜å°äº†ï¼Œåªç”¨synchronizedé”ä½å¤´èŠ‚ç‚¹ï¼Œç„¶åå¦‚æœè¦æ·»åŠ åˆ°è¯ç”¨casæ“ä½œï¼Œå¤§å¤§å‡è½»äº†é”çš„ç²’åº¦ï¼Œæ€§èƒ½è¾ƒå¥½\n2. CopyONWriteArrayListï¼šå†™æ—¶å¤åˆ¶COWï¼ŒæŒ‡çš„æ˜¯åœ¨å†™æ“ä½œçš„æ—¶å€™èµ‹å€¼ä¸€ä»½å‰¯æœ¬åœ¨å‰¯æœ¬ä¸Šè¿›è¡Œæ“ä½œï¼Œæœ€åå†ç”¨æ–°æ•°ç»„æ›¿æ¢æ—§çš„æ•°ç»„ï¼Œå¦‚æœæœŸé—´åŸæ•°ç»„æœ‰æ“ä½œï¼Œå°±è®°å½•ä¸‹æ¥æœ€åè¿›è¡Œå˜æ›´\n## Collectionså’ŒCollectionçš„åŒºåˆ«\nCollectionæ˜¯ä¸€ä¸ªæ¥å£ï¼Œå¦‚ä¸Šé¢æ‰€è¿°ï¼›Collectionsæ˜¯ä¸€ä¸ªå·¥å…·ç±»ï¼Œæä¾›äº†ä¸€ç³»åˆ—é™æ€æ–¹æ³•æ¥å¸®åŠ©å®Œæˆé›†åˆçš„æ“ä½œï¼Œæ¯”å¦‚sort\n\n> Collectionsè¿˜æœ‰ä¸€ä¸ªæ–¹æ³•å¯ä»¥è®©HashMapå˜æˆçº¿ç¨‹å®‰å…¨çš„é›†åˆï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯ç»™æ‰€æœ‰HashMapçš„æ–¹æ³•åŠ ä¸Šsynchronizedå…³é”®å­—ï¼Œè¿™æ ·æ•ˆç‡æ˜¯å¾ˆä½çš„ï¼Œæ‰€ä»¥èƒ½ç”¨è¿˜æ˜¯ç”¨ConcurrentHashMapå§\n\n## ArrayListå’ŒLinkedListçš„åŒºåˆ«\n1. åº•å±‚æ•°æ®ç»“æ„ä¸åŒï¼šArrayListåŸºäºçš„æ˜¯åŠ¨æ€æ•°ç»„è‡ªåŠ¨æ‰©å®¹ï¼ŒLinkedListåŸºäºçš„æ˜¯åŒå‘é“¾è¡¨ï¼Œéƒ½ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„\n2. å¢åˆ æ”¹æŸ¥çš„æ—¶é—´å¤æ‚åº¦ä¸ä¸€æ ·ï¼ŒArrayListå¯ä»¥æ”¯æŒéšæœºæŸ¥è¯¢ï¼Œä½†æ˜¯å¢åˆ éƒ½éœ€è¦å¹³å‡ä¸€åŠçš„æ—¶é—´o(n/2)ï¼ŒåŒå‘é“¾è¡¨åœ¨å¤´å°¾å¢åˆ æœ‰æ¯”è¾ƒé«˜çš„æ•ˆç‡ï¼Œä½†æ˜¯åœ¨ä¸­é—´æ·»åŠ ä¹Ÿæ˜¯æœ‰æŸ¥è¯¢çš„æ—¶é—´å¤æ‚åº¦ï¼ˆæ³¨æ„ï¼Œè¿™é‡ŒArrayListå®ç°äº†RandomAccessæ¥å£ï¼Œè¡¨ç¤ºå¯ä»¥æ”¯æŒéšæœºè®¿é—®ï¼Œä½†æ˜¯è¿™ä¸ªæ¥å£æ˜¯ç©ºçš„ï¼Œä»…ä»…ä½œä¸ºä¸€ä¸ªæ ‡è®°ï¼‰\n3. ç©ºé—´å ç”¨ï¼ŒArrayListæ˜¯è¿ç»­çš„æ•°æ®ç»“æ„ï¼Œæ•°æ®å¯†åº¦å¤§ï¼Œè€ŒLinkedListå¯ä»¥æ˜¯ç¦»æ•£çš„ï¼Œç”±äºè¦å­˜å‚¨ä¸‹ä¸€ä¸ªæ•°æ®çš„æŒ‡é’ˆï¼Œéœ€è¦é¢å¤–çš„ç©ºé—´ï¼Œæ•°æ®å¯†åº¦ä¸å¤§\n\n## ArrayListçš„åˆå§‹åŒ–\nArrayListæœ‰ä¸¤ç§åˆå§‹åŒ–æ–¹å¼ï¼ˆè¿˜æœ‰ä¸€ç§æ˜¯è¾“å…¥é›†åˆçš„ï¼Œè€ƒå¯Ÿçš„æ¯”è¾ƒå°‘ï¼‰ï¼š\n1. æ— å‚æ„é€ æ–¹æ³•ï¼Œåˆå§‹åŒ–ä¸ºä¸€ä¸ªé»˜è®¤çš„DEFAULTCAPACITY_EMPTY_ELEMENTDATAçš„ç©ºæ•°ç»„ï¼Œå¹¶æ²¡æœ‰åˆ†é…å…·ä½“å¯¹è±¡ï¼Œåˆ°åé¢growæ“ä½œæ‰ä¼šæœ‰å¯¹è±¡\n2. æœ‰å‚æ„é€ æ–¹æ³•ï¼Œå¦‚æœè¾“å…¥çš„é•¿åº¦ä¸ä¸º0ï¼Œç›´æ¥å°±newä¸€ä¸ªObjectæ•°ç»„ï¼Œå¦‚æœè¾“å…¥çš„é•¿åº¦ä¸º0ï¼Œåˆå§‹åŒ–ä¸ºå¦å¤–ä¸€ä¸ªEMPTY_ELEMENTDATAçš„ç©ºæ•°ç»„\n\n> ä¸ºä»€ä¹ˆè¦æœ‰ä¸¤ä¸ªè¿™ä¸ªç©ºæ•°ç»„å‘¢ï¼Œæ˜¯å› ä¸ºéœ€è¦åŒºåˆ†æ˜¯å¦ä¸ºæœ‰å‚æ„é€ å‡½æ•°ï¼Œåœ¨åç»­çš„æ‰©å®¹æ“ä½œä¸­åªæœ‰DEFAULTCAPACITY_EMPTY_ELEMENTDATAæ‰ä¼šåˆ†é…é»˜è®¤å€¼ã€‚è¿™ä¸ªåœ¨åç»­æ‰©å®¹æ“ä½œæœ‰ç”¨å¤„\n\n## ArrayListçš„æ‰©å®¹æœºåˆ¶\n> æ³¨æ„åŒºåˆ†æ•°ç»„é•¿åº¦elementData.lengthå’Œæ•°æ®é‡size\n\n1. å†æ·»åŠ ä¸€ä¸ªå…ƒç´ ä¹‹å‰ï¼Œå…ˆæ£€æŸ¥ä¸‹ä¸€ä¸ªä½ç½®æ˜¯å¦å­˜åœ¨ï¼Œè¿›è¡Œæ£€æŸ¥ï¼Œä¼ å…¥å‚æ•°æ˜¯å½“å‰æ•°æ®é‡+1ï¼›æ£€æŸ¥çš„ç›®çš„æ˜¯ä¸ºäº†ç¡®å®šæ•°ç»„é•¿åº¦èƒ½å¦æ”¯æŒä¸‹ä¸€ä¸ªæ•°æ®çš„æ·»åŠ \n2. åœ¨æ£€æŸ¥å‰é’ˆå¯¹æ— å‚æ„é€ æ–¹æ³•æœ‰ä¸€ä¸ªå½“å‰éœ€è¦çš„æœ€å°é•¿åº¦çš„è®¡ç®—ï¼Œç”±äºåˆå§‹åŒ–çš„æ—¶å€™é•¿åº¦æ²¡æœ‰ç¡®å®šï¼Œè¿™ä¸ªæ—¶å€™éœ€è¦çš„æœ€çŸ­é•¿åº¦å°±æ˜¯é»˜è®¤çš„10ï¼›å…¶ä½™çš„æ–¹æ³•å®¹é‡è®¡ç®—çš„ç»“æœå°±æ˜¯ä¼ å…¥å‚æ•°ç›´æ¥è¾“å‡ºï¼ˆå³æ•°æ®é‡+1ï¼‰\n3. è¿›è¡Œæ£€æŸ¥ï¼Œå¦‚æœè¿™ä¸ªéœ€è¦çš„æœ€çŸ­é•¿åº¦å¤§äºäº†æ•°ç»„é•¿åº¦ï¼Œå°±éœ€è¦æ‰©å®¹äº†\n4. æ‰©å®¹ï¼šé0æƒ…å†µä¸‹æ˜¯1.5å€çš„åŸé•¿åº¦ï¼Œå¦‚æœåŸé•¿åº¦ä¸º0ï¼Œåˆ™æ–°é•¿åº¦ä¸ºåˆšåˆšè®¡ç®—å¾—åˆ°çš„æœ€å°é•¿åº¦ã€‚\n\n> å¼•ç”³é—®é¢˜1:new ArrayList()å’Œnew ArrayList(0)ç¬¬ä¸€æ¬¡æ‰©å®¹çš„é•¿åº¦æ˜¯å¤šå°‘ï¼Œç”±åˆšåˆšçš„åˆ†æå¯çŸ¥ï¼Œæœ‰å‚åœ¨æœ€å°é•¿åº¦è®¡ç®—å¾—åˆ°çš„é•¿åº¦ä¸º0+1=1ï¼Œæ— å‚ä¸º10ï¼Œæ‰€ä»¥è¯´ç¬¬ä¸€æ¬¡æ‰©å®¹åˆ†åˆ«ä¸º10å’Œ1\n> å¼•ç”³é—®é¢˜2:new ArrayList(10)åœ¨æ·»åŠ ä¸€ä¸ªå…ƒç´ çš„æ—¶å€™æ‰©å®¹äº†å‡ æ¬¡ï¼Œæ²¡æœ‰æ‰©å®¹ï¼Œå› ä¸ºåœ¨æ„é€ å‡½æ•°é‡Œé¢å·²ç»æœ‰åˆ†é…ç©ºé—´ï¼Œè€Œä¸”1<10ï¼Œä¸ä¼šè§¦å‘grow\n\n## ArrayListæ˜¯çº¿ç¨‹å®‰å…¨çš„å—ï¼Ÿå¦‚æœæƒ³ç”¨çº¿ç¨‹å®‰å…¨çš„Listæ€ä¹ˆæ“ä½œ\nArrayListä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä¸»è¦æ˜¯å› ä¸ºåœ¨åŠ å…¥æ•°æ®çš„æ—¶å€™++æ“ä½œä¸æ˜¯åŸå­æ€§çš„ï¼Œé¦–å…ˆå…ˆè¯´æ˜åŠ å…¥æ•°æ®çš„é€»è¾‘ï¼Œæ€»ç»“ä¸ºå¦‚ä¸‹ï¼š\n1. å…ˆè¿›è¡Œä¸Šé¢æ‰€è¿°çš„æ ¡éªŒå’Œæ‰©å®¹\n2. å†åœ¨å½“å‰sizeçš„ä½ç½®æ·»åŠ å…ƒç´ ï¼ˆå¼•å‘çº¿ç¨‹å®‰å…¨ï¼‰\n3. æœ€åå°†å½“å‰çš„size+1\n\næœ‰ä»¥ä¸‹ä¸‰ç§æƒ…å†µä¼šå¼•å‘çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼š\n1. å‡ºç°nullå€¼ï¼Œçº¿ç¨‹aæ·»åŠ 2ä½ç½®çš„å…ƒç´ ï¼Œæ­¤æ—¶çº¿ç¨‹bä¹ŸåŒæ—¶è¿›æ¥æƒ³è¦æ·»åŠ 2ä½ç½®çš„å…ƒç´ ï¼Œçº¿ç¨‹aæ·»åŠ å®Œæˆåæ²¡æœ‰ç«‹åˆ»size++ï¼Œçº¿ç¨‹bä¹Ÿå­˜åˆ°å½“å‰ä½ç½®ï¼Œæœ€åä¸¤ä¸ªéƒ½size++ï¼Œæ­¤æ—¶sizeä¸º4ï¼Œ2çš„ä½ç½®ç”±äºé‡å¤å†²æ‰äº†ä¸€ä¸ªæ•°æ®ï¼Œ3çš„ä½ç½®ç›´æ¥å°±æ˜¯nullã€‚\n2. å‡ºç°æº¢å‡ºï¼šå½“å‰é•¿åº¦ä¸º9ï¼Œå®¹é‡æ˜¯10ï¼Œä¸¤ä¸ªçº¿ç¨‹åŒæ—¶åœ¨9çš„æ—¶å€™æ·»åŠ ï¼Œå°±ä¼šå‡ºç°æº¢å‡º\n3. sizeå’Œputçš„æ¬¡æ•°ä¸ä¸€æ ·ï¼šè¿™ä¸ªå‡ºç°çš„æœ€å¤šï¼Œä¹Ÿæ˜¯å› ä¸ºsize++\n\nå¦‚ä½•ä½¿ç”¨çº¿ç¨‹å®‰å…¨çš„listï¼š\n1. Collections.synchronizedList(arrayList)ï¼Œç›¸å½“äºåœ¨æ–¹æ³•ä¸Šå…¨éƒ¨åŠ ä¸Šsynchronizedï¼Œæ•ˆç‡ä½\n2. CopyOnWriteArrayListï¼šå†™æ“ä½œç”¨reentrantlockæ¥ä¿è¯ä¸ä¼šå‡ºç°**ä¸Šè¿°1å’Œ3**çš„çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œä¸´ç•ŒåŒºå†…æ‰§è¡Œå¤åˆ¶ï¼Œä¸ä¼šå½±å“è¯»æ“ä½œï¼Œå­˜å…¥å®Œæˆåè¿›è¡Œåœ°å€æ›¿æ¢ã€‚è™½ç„¶è¿™ç§æ–¹æ³•ç¡®å®æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä½†æ˜¯æ¯æ¬¡å†™æ“ä½œéƒ½è¦è¿›è¡Œä¸Šé”å’Œå¤åˆ¶æ•°ç»„ï¼Œåœ¨å†™å¤šè¯»å°‘çš„æƒ…å†µä¸‹è‚¯å®šæ˜¯ä¸å¥½çš„ã€‚åªé€‚ç”¨äºè¯»å¤šå†™å°‘\n3. Vectorï¼šæ•ˆç‡æ›´ä½ï¼Œå·²ç»æ·˜æ±°\n\n## LinkedListçš„æœºåˆ¶\nåŒå‘é“¾è¡¨ï¼ŒæŸ¥è¯¢æ•°æ®çš„å¤æ‚åº¦ä¸ºo(n)ï¼Œåœ¨é¦–å°¾æ·»åŠ æ•°æ®çš„å¤æ‚åº¦ä¸ºo(1)\n\n## HashMapçš„æ•°æ®ç»“æ„\nHashMapçš„ç»“æ„ç»å†äº†å¤§çš„æ”¹ç‰ˆï¼Œåœ¨jkd1.7HashMapæ˜¯åŸºäºEntryæ•°ç»„çš„ï¼Œå“ˆå¸Œå†²çªç”¨æ‹‰é“¾æ³•è§£å†³ï¼Œå°±å½¢æˆäº†Entryæ•°ç»„+é“¾è¡¨çš„ç»“æ„ï¼›åœ¨jkd1.8ä»¥åï¼Œæ‹‰é“¾è¶…è¿‡ä¸€å®šçš„æ•°é‡è½¬åŒ–æˆæŸ¥è¯¢æ•ˆç‡æ›´é«˜çš„çº¢é»‘æ ‘ï¼Œå½¢æˆäº†Entryæ•°ç»„+é“¾è¡¨+çº¢é»‘æ ‘çš„ç»“æ„\n\nè§£å†³å“ˆå¸Œå†²çªçš„æ–¹æ³•ï¼ˆå¤ä¹ ï¼‰ï¼š\n1. æ‹‰é“¾æ³•ï¼šæŠŠå†²çªçš„éƒ½è¿˜æ˜¯æ”¾åœ¨åŸæ¥çš„ä½ç½®\n2. å¼€æ”¾é€‰å€æ³•ï¼šçº¿æ€§æ¢æµ‹æ³•ï¼ˆé¡ºåºå¾€åé¢æ‰¾ï¼‰ï¼ŒäºŒæ¬¡æ¢æµ‹ï¼ˆ1ï¼Œ4ï¼Œ9è¿™æ ·æ‰¾ï¼‰\n3. å†æ•£åˆ—æ³•ï¼šæŠŠå†²çªçš„å†è¿›è¡Œæ•£åˆ—\n4. å“ˆå¸Œæ¡¶æ‰©å®¹ï¼šå‡å°ç¢°æ’çš„å¯èƒ½æ€§\n\n## HashMapçš„putè¿‡ç¨‹\n1. é¦–å…ˆä¼šåˆ¤æ–­æ˜¯å¦åˆå§‹åŒ–ï¼Œå¦‚æœæ²¡æœ‰åˆå§‹åŒ–ï¼ˆæ¯”å¦‚ç©ºå‚æ„é€ æ–¹æ³•ï¼‰å°±resize\n2. æŒ‰ç…§hashæ–¹æ³•è®¡ç®—å“ˆå¸Œå€¼ï¼Œè¿™ä¸ªå“ˆå¸Œå€¼çš„è®¡ç®—æ˜¯é€šè¿‡hashcodeå’Œé«˜ä½çš„å¼‚æˆ–è¿ç®—å¾—å‡ºï¼Œèåˆäº†é«˜ä½å’Œä½ä½ä¿¡æ¯çš„hashå‡½æ•°ï¼Œæ•ˆæœä¼šæ›´å¥½\n3. ä¸å½“å‰Entryæ•°ç»„è¿›è¡Œå–ä½™æ“ä½œï¼Œè¿™é‡Œçš„å–ä½™æ˜¯ä½è¿ç®—ï¼Œhash&(n-1)ï¼Œhashmapè§„å®šnå¿…é¡»æ˜¯2çš„æ•´æ•°å€ï¼Œä¹Ÿå°±æ˜¯è¯´n-1ä¸ºæœ€é«˜ä½ä¸º0ï¼Œå…¶ä½™éƒ½æ˜¯1çš„äºŒè¿›åˆ¶æ•°ï¼Œä¸hashè¿›è¡Œä¸è¿ç®—å°±èƒ½å¾—åˆ°ä½™æ•°ï¼Œä½è¿ç®—æ¯”%çš„æ•ˆç‡é«˜\n4. å¾—åˆ°äº†åº”è¯¥å­˜å‚¨çš„Entryå·ï¼Œåˆ¤æ–­è¿™ä¸ªEntryä¸Šæœ‰æ²¡æœ‰åˆ«çš„å…ƒç´ ï¼Œå¦‚æœæ²¡æœ‰å°±ç›´æ¥å†™ä¸Šå»ï¼ˆè¿™é‡Œè¿˜è¦åˆ¤æ–­æ˜¯ä¸æ˜¯ä¸€ä¸ªkeyï¼Œå¦‚æœæ˜¯ä¸€ä¸ªkeyçš„è¯éœ€è¦æ›¿æ¢å€¼ï¼‰\n5. å¦‚æœæœ‰åˆ«çš„å…ƒç´ ï¼Œé¦–å…ˆåˆ¤æ–­æ˜¯ä¸æ˜¯çº¢é»‘æ ‘çš„èŠ‚ç‚¹ï¼Œå¦‚æœæ˜¯çº¢é»‘æ ‘çš„èŠ‚ç‚¹å°±èµ°çº¢é»‘æ ‘çš„æ·»åŠ é€»è¾‘\n6. å¦‚æœä¸æ˜¯çº¢é»‘æ ‘ï¼Œæ˜¯é“¾è¡¨ï¼Œåœ¨æŸ¥æ‰¾çš„è¿‡ç¨‹ä¸­è¿˜éœ€è¦çœ‹keyæ˜¯å¦é‡å¤ï¼Œå¦‚æœæ˜¯é‡å¤çš„è¿˜éœ€è¦è¦†ç›–vï¼Œå¦‚æœæ²¡æœ‰é‡å¤çš„keyå°±æ·»åŠ åˆ°è¡¨å°¾ï¼ˆå°¾æ’æ³•ï¼Œè¿™ä¹Ÿæ˜¯1.8ä¸1.7çš„ä¸€ä¸ªåŒºåˆ«ï¼Œ1.7çš„å°¾æ’ä¼šå‡ºç°ä¸€äº›å¹¶å‘å®‰å…¨é—®é¢˜ï¼‰\n7. å¦‚æœåŠ å…¥ä¹‹åå¤§äºçº¢é»‘æ ‘çš„é˜ˆå€¼ï¼Œè¿˜éœ€è¦è½¬æ¢æˆçº¢é»‘æ ‘\n8. æœ€åæ£€æŸ¥sizeï¼Œå¦‚æœå¤§äº†å°±éœ€è¦resize\n\n![](../img/Java/img_6.png)\n\n## HashMapå¦‚ä½•æ£€æŸ¥é‡å¤\nä¸»è¦æ˜¯é è¿™ä¸€æ®µä»£ç ï¼š\n```\np.hash == hash && ((k = p.key) == key || (key != null && key.equals(k)))\n```\n1. é¦–å…ˆåˆ¤æ–­ä¸¤ä¸ªçš„hashå€¼ï¼Œhashå€¼ç›¸åŒè¯´æ˜ç¢°æ’äº†\n2. å†åˆ¤æ–­keyçš„åœ°å€æ˜¯ä¸æ˜¯ä¸€ä¸ªï¼Œå¦‚æœæ˜¯åŸºæœ¬æ•°æ®ç±»å‹é‚£å°±æ˜¯æ¯”è¾ƒæœ¬èº«ï¼Œå¦‚æœæ˜¯å­—ç¬¦ä¸²æˆ–è€…æ˜¯å¯¹è±¡å°±æ¯”è¾ƒåœ°å€\n3. å†æ¯”è¾ƒå†…å®¹ï¼Œå¦‚æœå†…å®¹æ˜¯ä¸€ä¸ªé‚£å°±æ˜¯ç›¸åŒçš„ï¼Œæ¯”å¦‚ä¸¤ä¸ªä¸åŒåœ°å€çš„å­—ç¬¦ä¸²ä½†æ˜¯å†…å®¹éƒ½æ˜¯â€œabcâ€ï¼Œå†mapè¿™é‡Œä¹Ÿæ˜¯ä¸€ä¸ª\n\n## HashMapçš„resizeæœºåˆ¶\n1. é¦–å…ˆè¿›è¡Œæ–°æ•°ç»„çš„é•¿åº¦å’Œé˜ˆå€¼çš„è®¡ç®—ï¼Œå¦‚æœå½“å‰æ•°ç»„æœ‰é•¿åº¦å’Œé˜ˆå€¼ï¼Œé‚£å°±éƒ½ä¹˜2ï¼Œå¦‚æœæœ‰é˜ˆå€¼ä½†æ˜¯æ²¡æœ‰é•¿åº¦ï¼ˆæˆ–é•¿åº¦ä¸º0ï¼Œè¿™ç§æƒ…å†µå¯èƒ½æ˜¯æœ‰å‚æ„é€ å‡½æ•°é€ æˆçš„ï¼Œåœ¨æ„é€ å‡½æ•°ä¸­åªæœ‰è¿™ä¸ªé˜ˆå€¼çš„åˆå§‹åŒ–ï¼‰å°±æŠŠè¦æœ€å°æ•°ç»„é•¿åº¦è®¾ç½®ä¸ºé˜ˆå€¼ï¼ˆæ­¤é˜ˆå€¼ä¸æ˜¯é‚£ä¸ªä¹˜è´Ÿè½½å› å­çš„é˜ˆå€¼ï¼‰ï¼Œæœ€åå°±æ˜¯æ— å‚æ„é€ å‡½æ•°çš„ï¼Œç›´æ¥è®¾ç½®æœ€å°æ•°ç»„é•¿åº¦ä¸ºé»˜è®¤çš„16\n\n```java\npublic HashMap(int initialCapacity, float loadFactor) {\n     if (initialCapacity < 0)\n         throw new IllegalArgumentException(\"Illegal initial capacity: \" + initialCapacity);\n     if (initialCapacity > MAXIMUM_CAPACITY)\n         initialCapacity = MAXIMUM_CAPACITY;\n     if (loadFactor <= 0 || Float.isNaN(loadFactor))\n         throw new IllegalArgumentException(\"Illegal load factor: \" + loadFactor);\n     this.loadFactor = loadFactor;\n     // åˆå§‹å®¹é‡æš‚æ—¶å­˜æ”¾åˆ° threshold ï¼Œåœ¨resizeä¸­å†èµ‹å€¼ç»™ newCap è¿›è¡Œtableåˆå§‹åŒ–\n     this.threshold = tableSizeFor(initialCapacity);\n }\n```\n\n2. æ ¹æ®æœ€å°æ•°ç»„é•¿åº¦å’Œé˜ˆå€¼è¿›è¡Œæ‰©å®¹ï¼Œè¿›è¡Œæ–°çš„å“ˆå¸Œå€¼è®¡ç®—\n3. é“¾è¡¨ä¸Šçš„å…ƒç´ æ ¹æ®e.hash&oldCapï¼Œå¾—åˆ°é«˜ä½æ˜¯0æˆ–è€…1ï¼Œå¦‚æœæ˜¯1å°±æ”¾åœ¨æ–°åŠ çš„æ•°ç»„åé¢ï¼š\n\n![](../img/Java/img_7.png)\n\n![](../img/Java/img_8.png)\n\n4. çº¢é»‘æ ‘ä¹Ÿæ ¹æ®å“ˆå¸Œå€¼æŒ‰ç…§ä¸Šè¿°æ–¹æ³•è¿›è¡Œåˆ†è£‚ï¼Œå°äº6ä¸ªç‚¹çš„é€€åŒ–ä¸ºé“¾è¡¨â€™\n\n## ä¸ºä»€ä¹ˆHashMapè¦ç”¨2çš„æ•´æ•°å€\n1. ä½è¿ç®—çš„å–ä½™æ“ä½œ\n2. æ‰©å®¹æœºåˆ¶å·§å¦™å°†0ï¼Œ1åˆ†å¼€\n\n## HashMapæ€ä¹ˆæ ·æ‰èƒ½ä¸æ‰©å®¹\nåªè¦æ»¡è¶³å¤§äºæ‰©å®¹é˜ˆå€¼å°±è¡Œäº†ï¼Œå¦‚æœé¢„è®¡æœ‰100ä¸ªæ•°æ®è¦è¿›å…¥hashmapï¼Œé‚£å°±åšä¸€ä¸ªï¼ˆ100/è´Ÿè½½å› å­ï¼‰+1è¿™ä¹ˆå¤§çš„æ•°ç»„ï¼Œè¿™æ ·å¯ä»¥ä¿è¯ä¸ä¼šè§¦å‘æ‰©å®¹ï¼Œå½“ç„¶åˆå§‹åŒ–çš„resizeè¿˜æ˜¯æœ‰çš„\n\n## HashMapçš„çº¿ç¨‹å®‰å…¨é—®é¢˜\nå¹¶ä¸æ˜¯å®‰å…¨çš„ï¼Œä¸»è¦ä¼šæœ‰ä»¥ä¸‹å‡ ä¸ªé—®é¢˜ï¼š\n1. åœ¨jkd1.7ï¼Œç”±äºæ˜¯å¤´æ’æ³•ï¼Œåœ¨æ•°æ®è¿ç§»çš„è¿‡ç¨‹ä¸­å¯èƒ½ä¼šå‡ºç°æ­»å¾ªç¯çš„é—®é¢˜ï¼Œæœ‰ä¸¤ä¸ªæ•°æ®A->Bï¼Œçº¿ç¨‹1å’Œ2åŒæ—¶æ“ä½œå½“å‰å¿«ç…§ï¼Œçº¿ç¨‹1å·²ç»æ“ä½œäº†è¿™ä¸¤ä¸ªèŠ‚ç‚¹å˜ä¸ºB->Aï¼Œçº¿ç¨‹2çš„å½“å‰èŠ‚ç‚¹ä¸ºAï¼Œnextä¸ºBï¼Œæ­¤æ—¶çº¿ç¨‹2è¿›è¡Œæ“ä½œï¼Œæ’å…¥AèŠ‚ç‚¹ï¼ŒæŠŠå½“å‰èŠ‚ç‚¹æ¢ä¸ºBï¼ŒBçš„nextä¹Ÿæ˜¯Aï¼Œè¿™æ ·å°±å¾ªç¯äº†\n2. æ­¤å¤–è¿˜æ˜¯ä¼šæœ‰è·ŸArrayListé‚£ç§å‡ºç°ç´¢å¼•ä½ç½®é‡å¤ï¼Œæ¯”å¦‚å½“å‰æŸä¸ªEntryä¸Šæ²¡æœ‰å…ƒç´ ï¼Œä¸¤ä¸ªhashå†²çªçš„å°±å¯èƒ½ä¼šè¦†ç›–\n3. è¿˜æœ‰sizeä¸putæ“ä½œæ¬¡æ•°ä¸ä¸€è‡´çš„é—®é¢˜\n\nä»€ä¹ˆæ–¹æ³•è§£å†³ï¼Ÿ\n1. concurrentHashMapï¼šä¸€ç§åŸºäºå¤šæ®µé”çš„Map\n2. HashTableï¼šç›´æ¥é”æ•´ä¸ªè¡¨\n\n## concurrentHashMapå’ŒHashTableçš„åŒºåˆ«\nconcurrentHashMapåœ¨jdk1.7ä»¥å‰æ˜¯segment+hashEntry+é“¾è¡¨æ„æˆï¼Œç»™æ¯ä¸ªsegmentä¸Šé”ï¼Œé»˜è®¤æ”¯æŒ16çš„å¹¶å‘ï¼ˆå‰ææ˜¯æ¯ä¸€ä¸ªçº¿ç¨‹è®¿é—®çš„æ•°æ®éƒ½ä¸åœ¨ä¸€ä¸ªsegmentä¸Šï¼‰ï¼›åœ¨jdk1.8ä»¥åé€šè¿‡synchronized+cas+nodeå®Œæˆäº†å¹¶å‘æ§åˆ¶ï¼Œç›´æ¥åœ¨hashmapè¿›è¡Œé”æ“ä½œï¼Œç”¨synchronizedé”ä½å¤´èŠ‚ç‚¹ï¼Œcasé”ä½æ·»åŠ æ“ä½œã€‚HashTableæ˜¯æ–¹æ³•å…¨åŠ synchronizedçš„å“ˆå¸Œè¡¨ï¼Œæ•ˆæœè‚¯å®šæ˜¯ä¸å¦‚casçš„\n\n> concurrentHashMapä»€ä¹ˆæ—¶å€™ç”¨synchronizedä»€ä¹ˆæ—¶å€™ç”¨casï¼Œå½“Entryæ˜¯ç©ºèŠ‚ç‚¹çš„æ—¶å€™å°±ç”¨è‡ªæ—‹é”ï¼Œå½“ä¸ä¸ºç©ºå°±ä¸ç”¨\n## HashSet\nHashSetæ˜¯åŸºäºHashMapçš„ï¼Œç”±äºHashMapçš„ç‰¹æ€§ä¼šæ›¿æ¢é‡å¤çš„keyï¼ŒHashSetç›´æ¥æŠŠå½“å‰å…ƒç´ ä½œä¸ºkeyï¼Œè¿™æ ·å°±å¯ä»¥è¾¾åˆ°å»é‡çš„ç›®çš„\n\n# æœªå®Œå¾…ç»­ã€‚ã€‚ã€‚ã€‚ã€‚","tags":["Java"]},{"title":"jvm-ç±»åŠ è½½å™¨å’ŒåŒäº²å§”æ´¾æœºåˆ¶","url":"/2024/08/16/jvm-ç±»åŠ è½½å™¨å’ŒåŒäº²å§”æ´¾æœºåˆ¶/","content":"\n# ç±»åŠ è½½å™¨\n\n## ç±»åŠ è½½è¿‡ç¨‹\né¦–å…ˆå›é¡¾ä¸€ä¸‹ç±»åŠ è½½çš„è¿‡ç¨‹ã€‚ç±»çš„ç”Ÿå‘½å‘¨æœŸåˆ†ä¸ºä»¥ä¸‹ä¸ƒä¸ªé˜¶æ®µï¼šåŠ è½½->éªŒè¯->å‡†å¤‡->è§£æ->åˆå§‹åŒ–->ä½¿ç”¨->å¸è½½ã€‚å…¶ä¸­åŠ è½½æ˜¯ç”Ÿå‘½å‘¨æœŸçš„ç¬¬ä¸€ä¸ªé˜¶æ®µï¼Œç±»åŠ è½½å™¨ç”¨ä¸åŒçš„æ–¹å¼åŠ è½½jaråŒ…ï¼Œå¯ä»¥ä»classpathï¼ŒåŠ¨æ€ä»£ç†å’Œç½‘ç»œè·å–è¦åŠ è½½çš„ç±»ã€‚\n\nç±»åŠ è½½ä¸»è¦åšäº†ä»¥ä¸‹ä¸‰ä»¶äº‹ï¼š\n1. ç”¨ç±»çš„å…¨é™å®šåæ‰¾åˆ°ç±»çš„classæ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯å­—èŠ‚æµ\n2. å°†å­—èŠ‚æµæ–‡ä»¶è½¬åŒ–ä¸ºæ–¹æ³•åŒºä¸­è¿è¡Œæ—¶æ•°æ®ç»“æ„InstanceKlassï¼Œä¿å­˜å¸¸é‡æ± ï¼Œå­—æ®µï¼Œæ–¹æ³•ç­‰å†…å®¹\n3. åœ¨å †ä¸­åˆ›å»ºç›¸åº”Classå¯¹è±¡ï¼Œæ˜ å°„åˆ°æ–¹æ³•åŒºçš„æ•°æ®ç»“æ„ï¼Œè¿™éƒ¨åˆ†æ˜¯å…è®¸ç¨‹åºå‘˜æ“çºµçš„\n\n> åœ¨ Java çš„ç±»åŠ è½½é˜¶æ®µï¼Œ`InstanceKlass` å’Œ `Class` å¯¹è±¡å„è‡ªæ‰®æ¼”äº†ä¸åŒçš„è§’è‰²ã€‚ç†è§£å®ƒä»¬çš„ä½œç”¨æœ‰åŠ©äºæ›´å¥½åœ°ç†è§£ Java ç±»åŠ è½½å’Œè¿è¡Œæ—¶çš„å†…éƒ¨æœºåˆ¶ã€‚\n\n### 1. **`InstanceKlass`**\n\n`InstanceKlass` æ˜¯åœ¨æŸäº› Java è™šæ‹Ÿæœºï¼ˆJVMï¼‰å®ç°ä¸­ç”¨äºè¡¨ç¤ºç±»çš„å†…éƒ¨æ•°æ®ç»“æ„çš„ä¸€ä¸ªæœ¯è¯­ï¼ˆä¾‹å¦‚åœ¨ HotSpot JVM ä¸­ï¼‰ã€‚å®ƒæ˜¯ JVM å†…éƒ¨çš„ä¸€ä¸ªæ¦‚å¿µï¼Œä¸»è¦ç”¨äºå­˜å‚¨å’Œç®¡ç†ç±»çš„å„ç§å…ƒæ•°æ®ã€‚`InstanceKlass` åŒ…å«äº†ç±»çš„å®ä¾‹å­—æ®µã€æ–¹æ³•ã€å¸¸é‡æ± ç­‰ä¿¡æ¯ï¼Œä¸»è¦ç”¨äºï¼š\n\n- **è¡¨ç¤ºå’Œç®¡ç†ç±»çš„å…ƒæ•°æ®**ï¼šåŒ…æ‹¬ç±»çš„å­—æ®µã€æ–¹æ³•ã€å¸¸é‡æ± ç­‰ã€‚\n- **æ”¯æŒç±»çš„å®ä¾‹åŒ–å’ŒåŠ¨æ€æ“ä½œ**ï¼šåœ¨ JVM å†…éƒ¨ç”¨äºå®ç°ç±»å®ä¾‹åŒ–ã€åå°„ç­‰æ“ä½œã€‚\n- **ç®¡ç†ç±»çš„åŠ è½½å’Œåˆå§‹åŒ–**ï¼šç¡®ä¿ç±»åœ¨åŠ è½½ã€é“¾æ¥å’Œåˆå§‹åŒ–è¿‡ç¨‹ä¸­èƒ½å¤Ÿæ­£ç¡®åœ°ç®¡ç†å…¶ç»“æ„å’ŒçŠ¶æ€ã€‚\n\n`InstanceKlass` æ˜¯ JVM å†…éƒ¨å¯¹ç±»çš„è¡¨ç¤ºï¼Œä¸»è¦ç”¨äºå®ç° JVM çš„å„ç§å†…éƒ¨æ“ä½œï¼Œé€šå¸¸ä¸ä¼šè¢«åº”ç”¨ç¨‹åºç›´æ¥è®¿é—®æˆ–æ“ä½œã€‚\n\n### 2. **`Class` å¯¹è±¡**\n\n`Class` å¯¹è±¡æ˜¯ Java è¯­è¨€å±‚é¢æä¾›çš„ï¼Œç”¨äºè¡¨ç¤ºå’Œæ“ä½œ Java ç±»çš„ä¸€ä¸ªå…¬å…± APIã€‚æ¯ä¸ª Java ç±»åœ¨è¿è¡Œæ—¶éƒ½æœ‰ä¸€ä¸ª `Class` å¯¹è±¡ï¼Œç”¨äºæä¾›å¯¹è¯¥ç±»çš„å…ƒæ•°æ®çš„è®¿é—®ã€‚`Class` å¯¹è±¡çš„ä½œç”¨åŒ…æ‹¬ï¼š\n\n- **åå°„**ï¼šæä¾›äº†ç”¨äºè®¿é—®ç±»çš„ä¿¡æ¯å’Œæ“ä½œç±»çš„æ–¹æ³•ï¼ˆå¦‚è·å–ç±»çš„å­—æ®µã€æ–¹æ³•ã€æ„é€ å‡½æ•°ç­‰ï¼‰ã€‚\n- **ç±»å‹æ£€æŸ¥**ï¼šåœ¨è¿è¡Œæ—¶è¿›è¡Œç±»å‹æ£€æŸ¥å’Œç±»å‹è½¬æ¢ã€‚\n- **åŠ¨æ€å®ä¾‹åŒ–**ï¼šå…è®¸åœ¨è¿è¡Œæ—¶åˆ›å»ºç±»çš„å®ä¾‹ï¼ˆå¦‚ `Class.forName` å’Œ `newInstance`ï¼‰ã€‚\n\n### ç±»çš„åŠ è½½é˜¶æ®µçš„è§’è‰²å’Œä½œç”¨\n\n1. **åŠ è½½ï¼ˆLoadingï¼‰**ï¼š\n    - åœ¨è¿™ä¸ªé˜¶æ®µï¼ŒJVM ä¼šæ ¹æ®ç±»çš„å…¨é™å®šåæ‰¾åˆ°ç±»æ–‡ä»¶ï¼ˆ`.class` æ–‡ä»¶ï¼‰ï¼Œå¹¶å°†å…¶å­—èŠ‚ç è¯»å…¥å†…å­˜ã€‚æ­¤æ—¶ï¼Œ`InstanceKlass` å¯¹è±¡å¯èƒ½åœ¨å†…éƒ¨è¢«åˆ›å»ºæ¥ç®¡ç†è¿™ä¸ªç±»çš„å­—èŠ‚ç å’Œå…ƒæ•°æ®ã€‚\n\n2. **é“¾æ¥ï¼ˆLinkingï¼‰**ï¼š\n    - **éªŒè¯ï¼ˆVerificationï¼‰**ï¼šç¡®ä¿ç±»æ–‡ä»¶çš„å­—èŠ‚ç ç¬¦åˆ Java è™šæ‹Ÿæœºè§„èŒƒã€‚\n    - **å‡†å¤‡ï¼ˆPreparationï¼‰**ï¼šä¸ºç±»çš„é™æ€å˜é‡åˆ†é…å†…å­˜å¹¶åˆå§‹åŒ–ã€‚\n    - **è§£æï¼ˆResolutionï¼‰**ï¼šå°†ç±»ä¸­çš„ç¬¦å·å¼•ç”¨è§£æä¸ºç›´æ¥å¼•ç”¨ã€‚\n\n3. **åˆå§‹åŒ–ï¼ˆInitializationï¼‰**ï¼š\n    - æ‰§è¡Œç±»çš„é™æ€åˆå§‹åŒ–ä»£ç ï¼ˆå¦‚é™æ€å—ï¼‰ã€‚\n\n### `InstanceKlass` å’Œ `Class` å¯¹è±¡çš„å…³ç³»\n\n- åœ¨å†…éƒ¨ï¼Œ`InstanceKlass` æ˜¯ JVM å®ç°ä¸­çš„ä¸€ä¸ªç»“æ„ï¼Œç”¨äºå­˜å‚¨å’Œç®¡ç†ç±»çš„å†…éƒ¨æ•°æ®å’ŒçŠ¶æ€ã€‚\n- `Class` å¯¹è±¡æ˜¯ Java è¯­è¨€å±‚é¢çš„ä¸€ä¸ªå…¬å…± APIï¼Œæä¾›äº†å¯¹ç±»ä¿¡æ¯çš„è®¿é—®ã€‚\n\n**åœ¨ç±»åŠ è½½é˜¶æ®µï¼Œ`InstanceKlass` è´Ÿè´£ JVM å†…éƒ¨çš„ç±»æ•°æ®ç»“æ„ç®¡ç†å’Œç»´æŠ¤**ï¼Œè€Œ `Class` å¯¹è±¡åˆ™æä¾›äº†ç»™åº”ç”¨ç¨‹åºä½¿ç”¨çš„æ¥å£æ¥è®¿é—®å’Œæ“ä½œè¿™äº›æ•°æ®ã€‚å®ƒä»¬å„è‡ªä½œç”¨äºä¸åŒçš„å±‚é¢ï¼Œä½†åœ¨ç±»åŠ è½½å’Œè¿è¡Œæ—¶çš„æ“ä½œä¸­æ˜¯ç›¸è¾…ç›¸æˆçš„ã€‚\n\n### å…³ç³»æ€»ç»“\n\n- **`InstanceKlass`**ï¼šJVM å†…éƒ¨ç”¨äºè¡¨ç¤ºå’Œç®¡ç†ç±»çš„å…ƒæ•°æ®ï¼Œæ˜¯å®ç°ç»†èŠ‚ã€‚\n- **`Class` å¯¹è±¡**ï¼šJava API æä¾›çš„ç±»å…ƒæ•°æ®çš„å…¬å…±æ¥å£ï¼Œè®©åº”ç”¨ç¨‹åºèƒ½å¤Ÿé€šè¿‡åå°„ç­‰æœºåˆ¶ä¸ç±»è¿›è¡Œäº¤äº’ã€‚\n\n**`InstanceKlass` å’Œ `Class` å¯¹è±¡** åœ¨ç±»åŠ è½½è¿‡ç¨‹ä¸­ç›¸äº’åä½œï¼Œä½¿å¾—ç±»çš„å†…éƒ¨ç®¡ç†ä¸å¤–éƒ¨è®¿é—®å¾—ä»¥å®ç°ã€‚\n\n> è¡¥å……çŸ¥è¯†ç‚¹ï¼šåå°„\n> \n> åå°„æ˜¯é€šè¿‡æ“ä½œClassæ–‡ä»¶ï¼Œåœ¨ç±»çš„è¿è¡Œè¿‡ç¨‹ä¸­åŠ¨æ€çš„è·å–ä¸€äº›ä¿¡æ¯ï¼Œæ¯”å¦‚å½“å‰æ—¶åˆ»çš„å­—æ®µå’Œæ–¹æ³•ã€‚é¦–å…ˆåœ¨æŸä¸ªç±»çš„åŠ è½½é˜¶æ®µï¼Œä¼šåœ¨jvmçš„æ–¹æ³•åŒºç”Ÿæˆä¸€ä¸ªInstanceKlassæ–‡ä»¶ï¼Œè¿™æ˜¯ç”±c++å®ç°çš„ï¼ŒåŒæ—¶ä¹Ÿä¼šåœ¨å †ä¸­ç”Ÿæˆä¸€ä¸ªClasså¯¹è±¡ï¼Œè¯¥å¯¹è±¡æœ‰åå°„çš„åŠŸèƒ½ã€‚\n> åœ¨éœ€è¦ä½¿ç”¨åå°„çš„æ—¶å€™ï¼Œåˆ©ç”¨Class.forName(å…¨é™å®šå)ï¼Œå¯ä»¥åœ¨å †ä¸­å–å‡ºè¯¥Classå¯¹è±¡ï¼Œå®Œæˆåå°„è°ƒç”¨ã€‚\n\n## ç±»åŠ è½½å™¨åˆ†ç±»\n\nä¸€èˆ¬æ¥è¯´ï¼Œè‡ªä¸Šè€Œä¸‹å¯ä»¥åˆ†ä¸ºå››ä¸ªç±»åŠ è½½å™¨ï¼š\n### å¯åŠ¨ç±»åŠ è½½å™¨(BootStrapClassLoader)\nç”±jvmæä¾›c++ç¼–å†™ï¼Œå¯¹äºjavaç¨‹åºå‘˜ä¸å¯è§ï¼Œå½“æ‰“å°ç±»åŠ è½½å™¨åä¸ºnullçš„æ—¶å€™å³ä¸ºå¯åŠ¨ç±»åŠ è½½å™¨ã€‚ä¸€èˆ¬ç”¨äºåŠ è½½javaæ ¸å¿ƒç±»ï¼ˆrtï¼‰\n### æ‰©å±•ç±»åŠ è½½å™¨(ExtensionClassLoader)\nåŠ è½½ä¸€äº›æ‹“å±•jaråŒ…ï¼Œæ¯”å¦‚appletç­‰ä¸€ç³»åˆ—éjavaæ ¸å¿ƒåŠŸèƒ½ï¼Œä½†æ˜¯æœ‰æ—¶å€™æœ‰éœ€è¦ç”¨åˆ°çš„å®˜æ–¹åŒ…\n### åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨(ApplicationClassLoader)\nåŠ è½½åœ¨classpathä¸‹ç”¨æˆ·ç¼–å†™çš„æ‰€æœ‰javaç±»å’ŒjaråŒ…\n### è‡ªå®šä¹‰ç±»åŠ è½½å™¨\nç”¨æˆ·ä¸ºäº†å®ç°æŸäº›ç‰¹å®šåŠŸèƒ½ç¼–å†™çš„ï¼Œé¦–å…ˆè¯´æ˜åœ¨javaä¸­çš„ClassLoaderç»§æ‰¿ç»“æ„ï¼ŒClassLoaderæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼ŒURLClassLoaderå®ç°äº†åœ¨å¯¹åº”è·¯å¾„ä¸‹çš„äºŒè¿›åˆ¶æ–‡ä»¶å†™å…¥å†…å­˜çš„æ“ä½œã€‚å…¶ä¸­ç”±å‡ ä¸ªé‡è¦æ–¹æ³•ï¼š\n- `protected Class<?> findClass(String name)`ï¼šä¼ å…¥çš„å‚æ•°ä¸ºå…¨é™å®šåã€‚é»˜è®¤å®ç°æ˜¯ç©ºæ–¹æ³•ï¼Œåœ¨URLClassLoaderä¸­å°†å…¨é™å®šåè½¬æ¢æˆäº†è·¯å¾„ï¼ˆ.æ”¹æˆäº†/ï¼Œåç¼€æ·»ä¸Šäº†.classï¼‰ï¼Œè‡ªå®šä¹‰ç±»åŠ è½½å™¨éœ€è¦é‡å†™è¯¥æ–¹æ³•ï¼Œè‡ªå®šä¹‰é€»è¾‘å»å®é™…æŸ¥æ‰¾å¹¶åŠ è½½ç±»çš„å­—èŠ‚ç ã€‚ä¾‹å¦‚ï¼Œä»ç½‘ç»œã€æ•°æ®åº“æˆ–éæ ‡å‡†è·¯å¾„åŠ è½½ç±»ã€‚\n- `public Class<?> loadClass(String name)`ï¼šå…¥å£æ–¹æ³•ï¼Œéµå¾ªåŒäº²å§”æ´¾æœºåˆ¶ã€‚**åŒäº²å§”æ´¾æœºåˆ¶**ï¼šå½“è¦åŠ è½½ä¸€ä¸ªç±»çš„æ—¶å€™ï¼Œå¦‚æœå½“å‰ç±»åŠ è½½å™¨å‘ç°å·²ç»åŠ è½½è¿‡è¯¥ç±»ï¼ˆè°ƒç”¨findLoadedClassï¼Œè¿™ä¸ªæ–¹æ³•ä¼šä½¿ç”¨nativeæ–¹æ³•å®Œæˆåˆ¤æ–­æ˜¯å¦åŠ è½½ï¼‰ï¼Œå°±ç›´æ¥è¿”å›è¯¥Classå¯¹è±¡ï¼Œå¦‚æœæ²¡æœ‰åŠ è½½å°±å§”æ´¾çˆ¶åŠ è½½å™¨è¿›è¡ŒåŠ è½½ï¼Œç›´åˆ°å¯åŠ¨ç±»åŠ è½½å™¨ã€‚å¯åŠ¨ç±»åŠ è½½å™¨ä¼šè‡ªé¡¶å‘ä¸‹åˆ¤æ–­æ˜¯å¦èƒ½å¤ŸåŠ è½½å½“å‰ç±»ï¼Œæ¯”å¦‚å¯åŠ¨ç±»åŠ è½½å™¨åŠ è½½ä¸äº†çš„å°±ç»™æ‰©å±•ç±»åŠ è½½å™¨ï¼Œå¦‚æœå…¨éƒ¨éƒ½åŠ è½½ä¸äº†ï¼Œåˆ™æŠ¥é”™ClassNotFoundException\n```java\nprotected Class<?> loadClass(String name, boolean resolve) throws ClassNotFoundException {\n    synchronized (getClassLoadingLock(name)) {\n        // æ£€æŸ¥ç±»æ˜¯å¦å·²ç»è¢«åŠ è½½\n        Class<?> c = findLoadedClass(name);\n        if (c == null) {\n            try {\n                if (parent != null) {\n                    // å§”æ´¾ç»™çˆ¶ç±»åŠ è½½å™¨\n                    c = parent.loadClass(name, false);\n                } else {\n                    // ä½¿ç”¨å¼•å¯¼ç±»åŠ è½½å™¨åŠ è½½\n                    c = findBootstrapClassOrNull(name);\n                }\n            } catch (ClassNotFoundException e) {\n                // çˆ¶åŠ è½½å™¨æ‰¾ä¸åˆ°ç±»\n            }\n\n            if (c == null) {\n                // å¦‚æœçˆ¶åŠ è½½å™¨ä¹Ÿæ‰¾ä¸åˆ°ç±»ï¼Œåˆ™è°ƒç”¨ findClass æ–¹æ³•åŠ è½½\n                c = findClass(name);\n            }\n        }\n\n        if (resolve) {\n            resolveClass(c);\n        }\n\n        return c;\n    }\n}\n```\n- `protected final Class<?> defineClass()`ï¼šåšä¸€äº›ç±»åçš„æ ¡éªŒï¼Œç„¶åè°ƒç”¨è™šæ‹Ÿæœºçš„nativeæ–¹æ³•å°†å­—èŠ‚ç ä¿¡æ¯åŠ è½½åˆ°è™šæ‹Ÿæœºç¼“å­˜ä¸­\n\n> defineClass() ä¸ loadClass() å’Œ findClass() çš„å…³ç³»:\n> \n> - loadClass()ï¼šloadClass() æ˜¯ç±»åŠ è½½çš„å…¥å£æ–¹æ³•ï¼Œè´Ÿè´£æŒ‰ç…§åŒäº²å§”æ´¾æ¨¡å‹åŠ è½½ç±»ã€‚å¦‚æœçˆ¶ç±»åŠ è½½å™¨æ— æ³•åŠ è½½è¯¥ç±»ï¼ŒloadClass() æœ€åä¼šè°ƒç”¨å½“å‰ç±»åŠ è½½å™¨çš„ findClass()ã€‚ \n> - findClass()ï¼šfindClass() æ˜¯è‡ªå®šä¹‰ç±»åŠ è½½å™¨ç”¨äºæŸ¥æ‰¾ç±»å­—èŠ‚ç çš„åœ°æ–¹ã€‚ä¸€èˆ¬è‡ªå®šä¹‰ç±»åŠ è½½å™¨ä¼šé‡å†™ findClass()ï¼Œåœ¨æ‰¾åˆ°ç±»çš„å­—èŠ‚ç åï¼Œé€šè¿‡è°ƒç”¨ defineClass() å°†å…¶å®šä¹‰ä¸º Class å¯¹è±¡ã€‚ \n> - defineClass()ï¼šdefineClass() æ˜¯ç±»åŠ è½½è¿‡ç¨‹ä¸­çš„æ ¸å¿ƒæ­¥éª¤ï¼Œè´Ÿè´£å°†å­—èŠ‚ç è½¬åŒ–ä¸º JVM è¯†åˆ«çš„ Class å¯¹è±¡ã€‚é€šå¸¸æ˜¯ findClass() æ–¹æ³•ä¸­çš„æœ€åä¸€æ­¥ã€‚\n> - è°ƒç”¨å…³ç³»ï¼šloadClassåŒäº²å§”æ´¾æœºåˆ¶ï¼Œç”¨findClasså®ç°æ–‡ä»¶åˆ°å­—èŠ‚æ•°ç»„çš„è½¬æ¢ï¼ŒdefineCLasså®Œæˆå­—èŠ‚æ•°ç»„åˆ°å†…å­˜çš„è½¬åŒ–\n\n**è¿˜æœ‰ä¸€ä¸ªè¦æ³¨æ„çš„ç‚¹ï¼š**\n\nloadClass()æœ‰ä¸€ä¸ªresolveå‚æ•°ï¼Œè¿™ä¸ªå‚æ•°é»˜è®¤ä¸ºfalseï¼Œä»£è¡¨åªè¿›è¡ŒåŠ è½½é˜¶æ®µï¼Œä¸è¿›è¡Œè¿æ¥é˜¶æ®µã€‚æ¯”å¦‚è¦åŠ è½½çš„ç±»ä¸­æœ‰é™æ€ä»£ç å—ï¼Œåªè°ƒç”¨loadclassæ˜¯ä¸ä¼šåˆå§‹åŒ–è¿™ä¸ªä»£ç å—çš„ï¼ŒåŸå› æ˜¯åªæœ‰åŠ è½½é˜¶æ®µï¼Œä¸ä¼šè¿›è¡Œè¿æ¥æ›´ä¸ä¼šåˆå§‹åŒ–äº†ã€‚\n\n# åŒäº²å§”æ´¾æœºåˆ¶\n1. è‡ªåº•å‘ä¸Šå§”æ‰˜çˆ¶ç±»åŠ è½½å™¨å®ŒæˆåŠ è½½\n2. è‡ªé¡¶å‘ä¸‹åŠ è½½ç±»\n3. å¥½å¤„ï¼šå¯ä»¥é¿å…é‡å¤åŠ è½½ç±»ï¼›ä¿è¯å®‰å…¨æ€§\n\n## æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶â€”â€”Tomcat\n\nåœ¨Tomcatä¸­ï¼Œå¾€å¾€åŒ…å«äº†å¾ˆå¤šçš„webåº”ç”¨ï¼Œè¿™äº›åº”ç”¨çš„å…¨é™å®šåå¾ˆå¯èƒ½ç›¸åŒï¼ˆä¾‹å¦‚å¯åŠ¨äº†ä¸¤ä¸ªç›¸åŒçš„æœåŠ¡ï¼‰ã€‚å¯¹äºåŒäº²å§”æ´¾æœºåˆ¶è€Œè¨€ï¼Œæ¯ä¸€ä¸ªwebåº”ç”¨éƒ½ä¼šå§”æ´¾çˆ¶ç±»åŠ è½½å™¨è¿›è¡ŒåŠ è½½æ¥ä¿è¯å½“å‰classpathä¸‹çš„å…¨é™å®šåå”¯ä¸€æ€§ï¼Œæ¯”å¦‚demo1åŠ è½½äº†com/yyf/service.classè€Œdemo2ä¹Ÿæœ‰è¿™ä¸ªç±»ï¼Œæ­¤æ—¶æ ¹æ®æœºåˆ¶ç”±äºå­˜åœ¨ä¸€ä¸ªå…¨é™å®šåç›¸åŒçš„ç±»ï¼Œdemo2ä¸‹çš„æ–°ç±»ä¸ä¼šè¢«åŠ è½½ï¼Œè¿™æ ·å°±ä¼šå‡ºç°é—®é¢˜ï¼Œå› æ­¤æˆ‘ä»¬è¦æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶ã€‚\n\n### Tomcatçš„ç±»åŠ è½½å™¨\n\nTomcatå®šä¹‰äº†ä¸€ç³»åˆ—ç±»åŠ è½½å™¨ï¼š\n![](../img/jvm/img_2.png)\n\n- commonï¼šé€šç”¨ç±»ï¼ŒTomcatå’Œwebåº”ç”¨éƒ½è¦ä½¿ç”¨çš„ç±»\n- catalina:Tomcatè¦ä½¿ç”¨çš„ç±»ï¼ˆæ³¨æ„ï¼šåœ¨tomcatä¸­é»˜è®¤æ²¡æœ‰é…ç½®è¿™ä¸ªçš„è·¯å¾„ï¼Œæ­¤æ—¶catalinaç±»åŠ è½½å™¨å³ä¸ºcommonåŠ è½½å™¨ï¼Œå¦‚æœéœ€è¦ä½¿ç”¨catalinaåŠ è½½å™¨ï¼Œéœ€è¦åœ¨catalina.propertiesä¸­è¿›è¡Œè·¯å¾„çš„é…ç½®ï¼‰\n- sharedï¼šwebåº”ç”¨è¦ä½¿ç”¨çš„å¯ä»¥å…±äº«çš„ç±»ï¼Œæ¯”å¦‚springå’Œmybatisï¼ˆæ³¨æ„ï¼šä¸ä¸Šé¢çš„ç±»ä¼¼ï¼Œtomcaté»˜è®¤æ²¡æœ‰é…ç½®ï¼Œæ­¤æ—¶ä¹Ÿä¸ºcommonç±»åŠ è½½å™¨ï¼‰\n- å¹¶è¡Œwebåº”ç”¨ç±»åŠ è½½å™¨ï¼šæ¯ä¸ªåº”ç”¨ä¸€ä¸ª\n\n> æ³¨ï¼šå…±äº«ç±»åŠ è½½å™¨\n> å¦‚æœæ‰€æœ‰çš„webåº”ç”¨éƒ½æ˜¯åŸºäºSSMçš„ï¼Œå¯ä»¥é…ç½®å…±äº«ç±»åŠ è½½å™¨å®ç°åªåŠ è½½ä¸€æ¬¡Springå®¹å™¨ï¼Œä½†æ˜¯å¯èƒ½ç”±äºç‰ˆæœ¬ä¸åŒå¯èƒ½å¯¼è‡´å…¼å®¹é—®é¢˜ï¼Œä»¥åŠç”±äºå­˜åœ¨çš„å¤§é‡åå°„ä¼šå¯¼è‡´ç±»æ±¡æŸ“ï¼Œæ‰€ä»¥éœ€è¦è°¨æ…é€‰æ‹©sharedåŠ è½½çš„ç±»\n\n### å¦‚ä½•æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶\næœ‰äº†å‰é¢webåº”ç”¨éš”ç¦»çš„éœ€æ±‚ï¼Œtomcaté€šè¿‡ä¸ºæ¯ä¸€ä¸ªwebåº”ç”¨åˆ›å»ºä¸€ä¸ªå¹¶è¡Œwebç±»åŠ è½½å™¨ï¼Œåªæœ‰å½“å…¨é™å®šåå’ŒåŠ è½½å™¨éƒ½æ˜¯åŒä¸€ä¸ªæ—¶ï¼Œæ‰ä¼šè¢«è®¤ä¸ºæ˜¯é‡å¤åŠ è½½ï¼Œ\n![](../img/jvm/img_3.png)\n\n- å·¦è¾¹æ˜¯åŒäº²å§”æ´¾æœºåˆ¶ï¼šå½“éœ€è¦åŠ è½½ä¸€äº›å†…éƒ¨ç±»çš„æ—¶å€™è¿˜æ˜¯è¦èµ°åŒäº²å§”æ´¾æœºåˆ¶åˆ°å¯åŠ¨ç±»åŠ è½½å™¨\n- å³è¾¹æ˜¯æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶ï¼šæ¯”å¦‚com/yyf/myclass.classè¿™ä¸ªç±»ï¼Œå¹¶è¡Œwebåº”ç”¨ç±»åŠ è½½å™¨å°±ä¼šç›´æ¥è‡ªå·±åŠ è½½ï¼Œä½†æ˜¯å¦‚æœæ²¡æœ‰åŠ è½½æˆåŠŸè¿˜æ˜¯ä¼šå§”æ´¾çˆ¶ç±»åŠ è½½å™¨è¿›è¡ŒåŠ è½½\n\n## æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶ï¼Ÿâ€”â€”spiæœºåˆ¶\n\nspiæœºåˆ¶æ˜¯ä¸€ç§æœåŠ¡å‘ç°æœºåˆ¶ï¼Œåˆ†ä¸ºæœåŠ¡æä¾›è€…å’Œè°ƒç”¨è€…ï¼Œspiæœºåˆ¶è§„å®šäº†éœ€è¦åœ¨classpathä¸‹çš„META-INF/serviceä¸‹ä»¥æœåŠ¡è°ƒç”¨è€…çš„å…¨é™å®šåä¸ºæ–‡ä»¶ååˆ›å»ºä¸€ä¸ªæ–‡ä»¶ï¼Œå†…å®¹ä¸ºæœåŠ¡æä¾›è€…çš„å…¨é™å®šåã€‚å†ä½¿ç”¨ServiceLoaderåŠ è½½æœåŠ¡è°ƒç”¨è€…ï¼Œå°±å¯ä»¥è°ƒç”¨å¤šä¸ªæœåŠ¡æä¾›è€…ã€‚\n\nåœ¨jdbcä¸­ï¼Œå¯èƒ½æœ‰å¤šä¸ªæ•°æ®åº“æºã€‚java.sql.Driveréœ€è¦èƒ½å¤Ÿè°ƒç”¨å¤šä¸ªæ•°æ®åº“çš„é©±åŠ¨æ¯”å¦‚mysqlå’ŒOracleï¼ŒDriverä½äºrtä¸­éœ€è¦ç”¨å¯åŠ¨ç±»åŠ è½½å™¨è¿›è¡ŒåŠ è½½ï¼Œè€Œmysqlé©±åŠ¨æ˜¯ç¬¬ä¸‰æ–¹jaråŒ…ï¼Œéœ€è¦ç”¨åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨ã€‚**ä½†æ˜¯åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸€ä¸ªç±»åŠå…¶ä¾èµ–ç±»ç”±åŒä¸€ä¸ªç±»åŠ è½½å™¨åŠ è½½ã€‚**ç”±äºspiçš„å­˜åœ¨ï¼Œmysqlçš„å®ç°ç±»ä¹Ÿä¼šåœ¨DriveråŠ è½½çš„æ—¶å€™é€šè¿‡å¯åŠ¨ç±»åŠ è½½å™¨è¿›è¡ŒåŠ è½½ï¼Œè¿™æ˜¾ç„¶æ˜¯é”™è¯¯çš„ã€‚\n\n### çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨\né—®é¢˜é‡è¿°ï¼Œå¯¹äºDriverè¿™ä¸ªç±»ï¼Œæ˜¯éœ€è¦ç”¨å¯åŠ¨ç±»åŠ è½½å™¨è¿›è¡ŒåŠ è½½ï¼Œä½†ç”±äºspiè®©å…¶å‘ç°äº†mysqlçš„å®ç°ç±»ï¼Œéœ€è¦å¯¹å…¶è¿›è¡ŒåŠ è½½ï¼Œæ­¤æ—¶éœ€è¦æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶ï¼Œ**å¯åŠ¨ç±»åŠ è½½å™¨å§”æ´¾åº”ç”¨ç¨‹åºåŠ è½½å™¨åŠ è½½mysqlé©±åŠ¨**ã€‚\n\nå…¶å®åœ¨æ¯ä¸ªçº¿ç¨‹éƒ½ä¼šé»˜è®¤ä¿å­˜ä¸€ä¸ªåº”ç”¨ç¨‹åºç±»åŠ è½½å™¨ï¼Œä¸€èˆ¬æ¥è¯´å­çº¿ç¨‹ä¼šç»§æ‰¿çˆ¶çº¿ç¨‹çš„åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨ã€‚åœ¨spié—®é¢˜ä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦å–å‡ºçº¿ç¨‹ä¿å­˜çš„åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨å®ç°mysqlé©±åŠ¨çš„åŠ è½½å³å¯ã€‚\n\nåŒæ ·çš„ï¼Œåœ¨å‰æ–‡æ‰€è¿°çš„tomcatçš„springåŠ è½½ä¸­ï¼Œæˆ‘ä»¬çš„ä»£ç ä¼šä½¿ç”¨åˆ°springçš„ä¸€ç³»åˆ—æ³¨è§£ï¼Œåœ¨springå®¹å™¨åˆå§‹åŒ–çš„è¿‡ç¨‹ä¸­ä¹Ÿä¼šäº§ç”Ÿä¾èµ–ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæœ¬æ¥æ˜¯sharedï¼ˆä¹Ÿæœ‰å¯èƒ½æ˜¯commonï¼‰ç±»åŠ è½½å™¨åŠ è½½çš„springç±»ï¼Œä½†éœ€è¦ç”¨åˆ°classpathä¸‹çš„è‡ªå·±å†™çš„åº”è¯¥ç”±å¹¶è¡Œwebåº”ç”¨å¤„ç†çš„ç±»ã€‚è¿™ä¸spiæœºåˆ¶æ‰€äº§ç”Ÿçš„é—®é¢˜æ˜¯ä¸€è‡´çš„ã€‚\n\næ­¤æ—¶ä¹Ÿæ˜¯é€šè¿‡çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨è¿›è¡Œè§£å†³ï¼Œåªä¸è¿‡è¿™é‡Œåœ¨å¼€è¾Ÿä¸€ä¸ªçº¿ç¨‹çš„æ—¶å€™é‡æ–°setè¿™ä¸ªå˜é‡ä¸ºå½“å‰çš„å¹¶è¡Œwebåº”ç”¨ç±»åŠ è½½å™¨ï¼ŒåŸç†ä¸ä¸Šé¢çš„ç±»ä¼¼ã€‚\n![](../img/jvm/img_4.png)\n\n### çœŸçš„æ‰“ç ´äº†åŒäº²å§”æ´¾æœºåˆ¶å—ï¼Ÿ\n\nå…¶å®æ²¡æœ‰ï¼Œä»å®è§‚ä¸Šçœ‹ï¼Œè¿™é‡Œçš„Driverè¿˜æ˜¯å¯åŠ¨ç±»åŠ è½½å™¨è¿›è¡ŒåŠ è½½ï¼Œmysqlè¿˜æ˜¯åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨è¿›è¡ŒåŠ è½½ï¼Œä¹Ÿæ²¡æœ‰é‡æ–°å†™loadclassæ–¹æ³•ã€‚ä½†ä¹Ÿç¡®å®æ˜¯ç”±å¯åŠ¨ç±»åŠ è½½å™¨å§”æ´¾åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨è¿›è¡Œäº†åŠ è½½ã€‚åªä¸è¿‡æ˜¯è§’åº¦ä¸åŒçš„é—®é¢˜ï¼Œä»å®è§‚ä¸Šæ²¡æœ‰æ‰“ç ´ï¼Œå¾®è§‚ä¸Šæ‰“ç ´äº†ã€‚","tags":["Java"]},{"title":"jvm-classæ–‡ä»¶å’Œç±»çš„åŠ è½½è¿‡ç¨‹","url":"/2024/08/14/jvm-classæ–‡ä»¶å’Œç±»çš„åŠ è½½è¿‡ç¨‹/","content":"\n# classæ–‡ä»¶\n\njavaæ‰€æ¨å‡ºçš„å£å·æ˜¯ï¼šä¸€æ¬¡ç¼–è¯‘ï¼Œå¤„å¤„æ‰§è¡Œã€‚è¿™ç§è·¨å¹³å°æ€§ä¸»è¦å°±æ˜¯ç”±å±è”½æ“ä½œç³»ç»Ÿåº•å±‚çš„jvmæ‰€å®ç°çš„ï¼Œjavaç¨‹åºä»ç¼–è¯‘åˆ°æ‰§è¡Œæœ‰å‡ ä¸ªé˜¶æ®µï¼Œé¦–å…ˆæ˜¯javaç¨‹åºè¢«javacç¼–è¯‘å™¨ç¼–è¯‘æˆ.classçš„å­—èŠ‚ç æ–‡ä»¶ï¼ŒjvmåŠ è½½å¹¶è¿è¡Œè¿™ä¸€ä¸ªä¸­é—´æ–‡ä»¶ï¼Œå†é€šè¿‡jvmè‡ªèº«çš„æ¥è¿‘åº•å±‚çš„æ–¹æ³•ï¼Œå®ç°åœ¨windowï¼Œmacoså’Œlinuxä¸Šçš„è·¨å¹³å°ã€‚\n\næˆ‘çš„ä¸ªäººç†è§£æ˜¯ï¼Œjavaä¸ºäº†ä¿è¯è·¨å¹³å°æ€§ç‰ºç‰²äº†ä¸€éƒ¨åˆ†æ•ˆç‡ï¼Œè¿™éƒ¨åˆ†ç‰ºç‰²ä¸»è¦ä½“ç°åœ¨è¦å¤šä¸€ä¸ªé€šç”¨çš„å­—èŠ‚ç æ–‡ä»¶çš„ç¼–è¯‘ï¼Œè€Œä¸æ˜¯ç›´æ¥å°±ä»javaå˜æˆæœºå™¨èƒ½å¤Ÿæ‰§è¡Œçš„æ±‡ç¼–äº†ã€‚\n\n## classæ–‡ä»¶çš„ç»“æ„\n\nå­—èŠ‚ç æ–‡ä»¶ä¸»è¦æœ‰å‡ ä¸ªéƒ¨åˆ†æ„æˆï¼š\n1. é­”æ•°å’Œå¤§å°ç‰ˆæœ¬å·ï¼šâ€œcafebabeâ€ï¼Œå¤§ç‰ˆæœ¬å·ç å°±æ˜¯-44ï¼Œæ¯”å¦‚jdk8çš„ç‰ˆæœ¬å·æ˜¯52\n2. å¸¸é‡æ± ï¼šæœ€æ ¸å¿ƒçš„éƒ¨åˆ†ï¼Œä¸»è¦æ˜¯å­—é¢é‡å’Œç¬¦å·å¼•ç”¨ï¼Œæ³¨æ„ï¼šåœ¨classæ–‡ä»¶ä¸­çš„éƒ½æ˜¯ç¬¦å·å¼•ç”¨ï¼Œå¯ä»¥æƒ³è±¡æˆé€»è¾‘åœ°å€ï¼Œè€Œåœ¨ç±»åŠ è½½çš„**è§£æ**è¿‡ç¨‹ä¸­ï¼Œæ‰ä¼šå˜ä¸ºç‰©ç†åœ°å€çš„å¼•ç”¨ã€‚\n3. å­—æ®µè¡¨ï¼šå½“å‰ç±»çš„å˜é‡\n4. æ–¹æ³•è¡¨ï¼šå½“å‰ç±»çš„æ–¹æ³•\n5. å±æ€§ï¼šå¾ˆå¤æ‚çš„ä¸€ä¸ªè¡¨ç¤º\n\næ¡ˆä¾‹ï¼š\n````java\npublic class ClassFile {\n    public static final String J = \"2222222\";\n\n    private int k;\n\n    public int getK() {\n        return k;\n    }\n\n    public void setK(int k) throws Exception {\n\n        try {\n            this.k = k;\n        } catch (IllegalStateException e) {\n            e.printStackTrace();\n        } finally {\n        }\n    }\n\n    public static void main(String[] args) {\n\n    }\n}\n\n````\n\n### é­”æ•°å’Œå¤§å°ç‰ˆæœ¬å·\né¦–å…ˆï¼Œæ”¹å˜ä¸€ä¸ªæ–‡ä»¶çš„åç¼€åæ˜¯ä¸ä¼šæ”¹å˜å…¶æ–‡ä»¶æœ¬èº«çš„ç¼–ç ç»“æ„çš„ï¼Œjvmä¸èƒ½ä»…ä»…æ˜¯æ ¡éªŒåç¼€æ˜¯ä¸æ˜¯.classæ¥åˆ¤æ–­æ˜¯å¦ä¸ºä¸€ä¸ªå­—èŠ‚ç æ–‡ä»¶ï¼Œæ‰€ä»¥åœ¨æ–‡ä»¶å†…å®¹çš„å¼€å¤´æœ‰ä¸€ä¸ªcafebabeçš„æ ¡éªŒï¼Œåªæœ‰ä»¥è¿™ä¸ªä¸ºå¼€å¤´çš„æ‰æ˜¯jvmæ‰€éœ€è¦çš„å­—èŠ‚ç æ–‡ä»¶ï¼Œå½“ç„¶ä¹Ÿä¸ä»…ä»…æ˜¯è¦æ»¡è¶³è¿™ä¸€ç‚¹ï¼Œåœ¨åç»­ç±»åŠ è½½è¿‡ç¨‹çš„**æ ¡éªŒè¿‡ç¨‹**ä¸­ä¼šè¯¦ç»†è¯´æ˜ã€‚\nå…¶æ¬¡å¤§ç‰ˆæœ¬å·ç å°±æ˜¯å½“å‰jdkç‰ˆæœ¬+44ï¼Œè¿˜æœ‰å°ç‰ˆæœ¬ï¼Œè¿™ä¸€éƒ¨åˆ†æ˜¯ä¸ºäº†jvmåœ¨æ ¡éªŒçš„è¿‡ç¨‹ä¸­åˆ¤æ–­å½“å‰çš„classæ˜¯å¦èƒ½å¤Ÿå…¼å®¹ç‰ˆæœ¬ï¼Œä¸€èˆ¬å½“ç„¶æ˜¯åªèƒ½å‘ä¸‹å…¼å®¹ã€‚ã€\n\n### å¸¸é‡æ± \n> åœ¨å¸¸é‡æ± ä¹‹å‰ï¼Œéœ€è¦è¡¥å……ä¸€ä¸‹å„ç§åä»¥åŠæè¿°ç¬¦\n> - å…¨é™å®šåå’Œéé™å®šåï¼š**Classæ–‡ä»¶ä¸­çš„ç±»å’Œæ¥å£ï¼Œéƒ½æ˜¯ä½¿ç”¨å…¨é™å®šåï¼Œåˆè¢«ç§°ä½œClassçš„äºŒè¿›åˆ¶åç§°**ã€‚ä¾‹å¦‚â€œcom/ikang/JVM/classfileâ€æ˜¯è¿™ä¸ªç±»çš„å…¨é™å®šåï¼Œä»…ä»…æ˜¯æŠŠç±»å…¨åä¸­çš„â€œ.â€æ›¿æ¢æˆäº†â€œ/â€è€Œå·²ï¼Œä¸ºäº†ä½¿è¿ç»­çš„å¤šä¸ªå…¨é™å®šåä¹‹é—´ä¸äº§ç”Ÿæ··æ·†ï¼Œåœ¨ä½¿ç”¨æ—¶æœ€åä¸€èˆ¬ä¼šåŠ å…¥ä¸€ä¸ªâ€œ;â€è¡¨ç¤ºå…¨é™å®šåç»“æŸã€‚ \n**éé™å®šååˆè¢«ç§°ä½œç®€å•åç§°**ï¼ŒClassæ–‡ä»¶ä¸­çš„æ–¹æ³•ã€å­—æ®µã€å±€éƒ¨å˜é‡ã€å½¢å‚åç§°ï¼Œéƒ½æ˜¯ä½¿ç”¨ç®€å•åç§°ï¼Œæ²¡æœ‰ç±»å‹å’Œå‚æ•°ä¿®é¥°ï¼Œä¾‹å¦‚è¿™ä¸ªç±»ä¸­çš„getK()æ–¹æ³•å’Œkå­—æ®µçš„ç®€å•åç§°åˆ†åˆ«æ˜¯â€œgetKâ€å’Œâ€œmâ€ã€‚\néé™å®šåä¸å¾—åŒ…å«ASCIIå­—ç¬¦. ; [ / ï¼Œæ­¤å¤–æ–¹æ³•åç§°é™¤äº†ç‰¹æ®Šæ–¹æ³•åç§°< init >å’Œ< clinit >æ–¹æ³•ä¹‹å¤–ï¼Œå®ƒä»¬ä¸èƒ½åŒ…å«ASCIIå­—ç¬¦<æˆ–>ï¼Œå­—æ®µåç§°æˆ–æ¥å£æ–¹æ³•åç§°å¯ä»¥æ˜¯< init >æˆ–< clinit >ï¼Œä½†æ˜¯æ²¡æœ‰æ–¹æ³•è°ƒç”¨æŒ‡ä»¤å¯ä»¥å¼•ç”¨< clinit >ï¼Œåªæœ‰invokespecialæŒ‡ä»¤å¯ä»¥å¼•ç”¨< init >ã€‚\n> - æè¿°ç¬¦ï¼šåœ¨classæ–‡ä»¶é‡Œçš„æ–¹æ³•å’ŒåŸºæœ¬æ•°æ®ç±»å‹ä¹Ÿæœ‰ç‰¹å®šçš„å†™æ³•ï¼Œä¸€èˆ¬æ¥è¯´åŸºæœ¬æ•°æ®ç±»å‹éƒ½æ˜¯é¦–å­—æ¯å¤§å†™ä½œä¸ºæè¿°ï¼Œæ¯”å¦‚intå°±ä¸ºIï¼Œ**å…¶ä¸­longç‰¹æ®Šï¼Œæè¿°ä¸ºJ**ï¼Œvoidä¸ºVï¼Œå¼•ç”¨ç±»å‹ä¸ºL+ç±»çš„å…¨é™å®šåï¼Œå¯¹äºæ•°ç»„ç±»å‹ï¼Œæ¯ä¸€ç»´åº¦å°†ä½¿ç”¨ä¸€ä¸ªå‰ç½®çš„â€œ[â€å­—ç¬¦æ¥æè¿°ï¼Œå¦‚ä¸€ä¸ªå®šä¹‰ä¸ºâ€œjava.lang.String[][]â€ç±»å‹çš„äºŒç»´æ•°ç»„ï¼Œå°†è¢«è®°å½•ä¸ºï¼šâ€œ[[Ljava/lang/Stringï¼›â€ï¼Œä¸€ä¸ªæ•´å‹æ•°ç»„â€œint[]â€å°†è¢«è®°å½•ä¸ºâ€œ[Iâ€\næ–¹æ³•æè¿°ç¬¦çš„å†™æ³•çœ‹ä¸€çœ¼å°±ä¼šï¼Œæ¯”å¦‚Object m(int i, double d, Thread t) {â€¦ }åˆ™æè¿°ç¬¦ä¸º(IDLjava/lang/Thread;)Ljava/lang/Object;\n\nè¨€å½’æ­£ä¼ ï¼Œå¸¸é‡æ± æœ‰ä¸¤éƒ¨åˆ†å†…å®¹ï¼šå­—é¢é‡å’Œç¬¦å·å¼•ç”¨ã€‚å­—é¢é‡å°±æ˜¯ä¸€ä¸ªå˜é‡çš„å¯¹åº”å€¼ï¼Œç¬¦å·å¼•ç”¨å°±æ˜¯åç§°ï¼Œä¸»è¦æœ‰ä¸‰éƒ¨åˆ†åç§°ï¼šç±»ä¸æ¥å£çš„å…¨é™å®šåï¼Œå­—æ®µçš„åç§°å’Œæè¿°ç¬¦ï¼ˆNameAndTypeï¼‰ï¼Œæ–¹æ³•çš„åç§°å’Œæè¿°ç¬¦ï¼ˆNameAndTypeï¼‰ã€‚\næ¯ä¸€ä¸ªå­—æ®µéƒ½æœ‰è‡ªå·±çš„ç»“æ„ï¼Œå…·ä½“è§[è¿™ç¯‡åšå®¢](https://blog.csdn.net/weixin_43767015/article/details/105310047?ops_request_misc=&request_id=&biz_id=102&utm_term=class%E6%96%87%E4%BB%B6&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduweb~default-0-105310047.142^v100^pc_search_result_base4&spm=1018.2226.3001.4187)ã€‚\nè¯´å‡ ä¸ªæ¯”è¾ƒé‡è¦çš„ï¼š\n1. CONSTANT_Utf8_infoå’ŒCONSTANT_String_infoï¼šå‰è€…æ˜¯çœŸæ­£å­˜å‚¨å­—ç¬¦ä¸²æœ¬ä½“çš„ï¼Œè€Œåè€…çš„ç»“æ„åªåŒ…å«å¼•ç”¨utf8çš„ç´¢å¼•ä½ç½®ï¼Œä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿå½“å¤šä¸ªStringåå­—ä¸åŒä½†æ˜¯å€¼ç›¸åŒçš„æ—¶å€™ï¼Œå°±å¯ä»¥åªåˆ›å»ºä¸€æ¡CONSTANT_Utf8_infoå¸¸é‡ï¼Œå¤šä¸ªStringå¯ä»¥å¼•ç”¨ï¼Œä»è€ŒèŠ‚çœç©ºé—´ï¼›å…¶æ¬¡æ˜¯æœ‰å¯èƒ½ç¬¦å·å¼•ç”¨ä¹Ÿæ˜¯å½“å‰å€¼ï¼Œä¾‹å¦‚å£°æ˜äº†String a = \"a\"ï¼Œè¿™æ ·å¤šå°‘ä¹Ÿèƒ½èŠ‚çº¦ç©ºé—´ã€‚\n2. CONSTANT_NameAndType_infoï¼šnameå°±æ˜¯å­—æ®µæˆ–è€…æ–¹æ³•çš„éé™å®šåï¼Œtypeæ˜¯å…¶æè¿°ç¬¦ï¼Œè¿™ä¸ªåŒæ ·æ˜¯å¼•ç”¨ç±»å‹ï¼Œæ”¾çš„æ˜¯CONSTANT_Utf8_infoçš„ç´¢å¼•ã€‚ä¾‹å¦‚println:(Ljava/lang/String;)V\n3. CONSTANT_Fieldref_infoå’ŒCONSTANT_Methodref_infoï¼šä¸¤ä¸ªå­—æ®µï¼Œå‰è€…æ˜¯è¿™ä¸ªå­—æ®µæˆ–è€…æ–¹æ³•çš„åå­—å¼•ç”¨ï¼Œåè€…æ˜¯CONSTANT_Methodref_infoçš„å¼•ç”¨\n    <div style=\"text-align: center;\">\n      <img src=\"../img/jvm/img.png\" alt=\"\" />\n    </div>\n4. CONSTANT_Class_infoï¼šç±»çš„å…¨é™å®šåï¼Œæ³¨æ„æ‰€æœ‰çš„ç±»éƒ½ä¼šæœ‰java/lang/Objectè¿™ä¸ªç±»çš„classå¸¸é‡ï¼Œå› ä¸ºé™¤äº†Objectæœ¬èº«ï¼Œå…¶ä½™éƒ½æ˜¯ç»§æ‰¿è‡ªå®ƒã€‚\n### è®¿é—®æ ‡å¿—\nç”¨2å­—èŠ‚ä½œä¸ºè®¿é—®æ ‡å¿—ï¼Œå…¶ä¸­16ä½çš„æŸäº›ä½ç½®å¯èƒ½ä»£è¡¨äº†æŸäº›ä¿®é¥°è¯ï¼Œä¾‹å¦‚publicï¼Œfinalï¼Œinterfaceç­‰\n### å½“å‰ç±»ï¼Œçˆ¶ç±»å’Œæ¥å£ç´¢å¼•\nç±»ç´¢å¼•ç”¨äºç¡®å®šè¿™ä¸ªç±»çš„å…¨é™å®šåï¼Œçˆ¶ç±»ç´¢å¼•ç”¨äºç¡®å®šè¿™ä¸ªç±»çš„çˆ¶ç±»çš„å…¨é™å®šåï¼Œç”±äº Java è¯­è¨€çš„å•ç»§æ‰¿ï¼Œæ‰€ä»¥çˆ¶ç±»ç´¢å¼•åªæœ‰ä¸€ä¸ªï¼Œé™¤äº† java.lang.Object ä¹‹å¤–ï¼Œæ‰€æœ‰çš„ Java ç±»éƒ½æœ‰çˆ¶ç±»ï¼Œå› æ­¤é™¤äº† java.lang.Object å¤–ï¼Œæ‰€æœ‰ Java ç±»çš„çˆ¶ç±»ç´¢å¼•éƒ½ä¸ä¸º 0ã€‚æ¥å£ç´¢å¼•é›†åˆç”¨æ¥æè¿°è¿™ä¸ªç±»å®ç°äº†é‚£äº›æ¥å£ï¼Œè¿™äº›è¢«å®ç°çš„æ¥å£å°†æŒ‰ implements (å¦‚æœè¿™ä¸ªç±»æœ¬èº«æ˜¯æ¥å£çš„è¯åˆ™æ˜¯extends) åçš„æ¥å£é¡ºåºä»å·¦åˆ°å³æ’åˆ—åœ¨æ¥å£ç´¢å¼•é›†åˆä¸­ã€‚\n### å­—æ®µè¡¨\n- access_flags: å­—æ®µçš„ä½œç”¨åŸŸï¼ˆpublic ,private,protectedä¿®é¥°ç¬¦ï¼‰ï¼Œæ˜¯å®ä¾‹å˜é‡è¿˜æ˜¯ç±»å˜é‡ï¼ˆstaticä¿®é¥°ç¬¦ï¼‰,å¯å¦è¢«åºåˆ—åŒ–ï¼ˆtransient ä¿®é¥°ç¬¦ï¼‰,å¯å˜æ€§ï¼ˆfinalï¼‰,å¯è§æ€§ï¼ˆvolatile ä¿®é¥°ç¬¦ï¼Œæ˜¯å¦å¼ºåˆ¶ä»ä¸»å†…å­˜è¯»å†™ï¼‰ã€‚\n- name_index: å¯¹å¸¸é‡æ± çš„å¼•ç”¨ï¼Œè¡¨ç¤ºçš„å­—æ®µçš„åç§°ï¼›\n- descriptor_index: å¯¹å¸¸é‡æ± çš„å¼•ç”¨ï¼Œè¡¨ç¤ºå­—æ®µå’Œæ–¹æ³•çš„æè¿°ç¬¦ï¼›\n- attributes_count: ä¸€ä¸ªå­—æ®µè¿˜ä¼šæ‹¥æœ‰ä¸€äº›é¢å¤–çš„å±æ€§ï¼Œattributes_count å­˜æ”¾å±æ€§çš„ä¸ªæ•°ï¼›\n- attributes[attributes_count]: å­˜æ”¾å…·ä½“å±æ€§å…·ä½“å†…å®¹ã€‚\n\n> è¿™é‡Œè¯´ä¸€ä¸‹å­—æ®µé‡Œé¢å¸¸è§çš„å±æ€§ï¼š\n> ConstantValueï¼šä¸€ä¸ªå­—æ®µæœ‰äº†è¿™ä¸ªè¯´æ˜æ˜¯è¢«staticä¿®é¥°äº†çš„ã€‚ç›®å‰Sun Javacç¼–è¯‘å™¨çš„é€‰æ‹©æ˜¯ï¼šå¦‚æœåŒæ—¶ä½¿ç”¨finalå’Œstaticæ¥ä¿®é¥°ä¸€ä¸ªå˜é‡ï¼ˆæŒ‰ç…§ä¹ æƒ¯ï¼Œè¿™é‡Œç§°â€œå¸¸é‡â€æ›´è´´åˆ‡ï¼‰ï¼Œå¹¶ä¸”è¿™ä¸ªå˜é‡çš„æ•°æ®ç±»å‹æ˜¯åŸºæœ¬ç±»å‹æˆ–è€…java.lang.Stringçš„è¯ï¼Œå°±ç”ŸæˆConstantValueå±æ€§æ¥è¿›è¡Œåˆå§‹åŒ–ï¼Œå³ç¼–è¯‘çš„æ—¶å€™ï¼›å¦‚æœè¿™ä¸ªå˜é‡æ²¡æœ‰è¢«finalä¿®é¥°ï¼Œæˆ–è€…å¹¶éåŸºæœ¬ç±»å‹åŠå­—ç¬¦ä¸²ï¼Œåˆ™å°†ä¼šé€‰æ‹©åœ¨ï¼œclinitï¼æ–¹æ³•ä¸­è¿›è¡Œåˆå§‹åŒ–ï¼Œå³ç±»åŠ è½½çš„æ—¶å€™ã€‚\n\n### æ–¹æ³•è¡¨\nå†…å®¹åŸºæœ¬ä¸Šä¸ä¸Šé¢ä¸€è‡´ï¼Œä¹Ÿæ˜¯æœ‰è®¿é—®æ ‡å¿—ï¼Œnameï¼Œdescriptorå’Œå±æ€§ï¼Œè¿™é‡Œçš„å±æ€§åªè¦æ–¹æ³•å†…ä¸ä¸ºç©ºéƒ½ä¼šæœ‰codeè¿™ä¸ªå±æ€§\n\næ–¹æ³•é‡Œå¸¸è§çš„å±æ€§ï¼š\n- Codeï¼šJavaæ–¹æ³•ä½“é‡Œé¢çš„ä»£ç ç»è¿‡Javacç¼–è¯‘ä¹‹åï¼Œæœ€ç»ˆå˜ä¸ºå­—èŠ‚ç æŒ‡ä»¤å­˜å‚¨åœ¨Codeå±æ€§å†…ï¼ŒCodeå±æ€§å‡ºç°åœ¨åœ¨method_infoç»“æ„çš„attributesè¡¨ä¸­ï¼Œä½†åœ¨æ¥å£æˆ–æŠ½è±¡ç±»ä¸­å°±ä¸å­˜åœ¨Codeå±æ€§ï¼ˆJDK1.8å¯ä»¥å‡ºç°äº†ï¼‰ã€‚ä¸€ä¸ªæ–¹æ³•ä¸­çš„Codeå±æ€§å€¼æœ‰ä¸€ä¸ªã€‚åœ¨æ•´ä¸ªClassæ–‡ä»¶ä¸­ï¼ŒCodeå±æ€§ç”¨äºæè¿°ä»£ç ï¼Œæ‰€æœ‰çš„å…¶ä»–æ•°æ®é¡¹ç›®éƒ½ç”¨äºæè¿°å…ƒæ•°æ®ã€‚åœ¨å­—èŠ‚ç æŒ‡ä»¤ä¹‹åçš„æ˜¯è¿™ä¸ªæ–¹æ³•çš„æ˜¾å¼å¼‚å¸¸å¤„ç†è¡¨ï¼ˆä¸‹æ–‡ç®€ç§°å¼‚å¸¸è¡¨ï¼‰é›†åˆï¼Œå¼‚å¸¸è¡¨å¯¹äºCodeå±æ€§æ¥è¯´å¹¶ä¸æ˜¯å¿…é¡»å­˜åœ¨çš„ã€‚\n- LineNumberTableï¼šä½äºCodeå±æ€§ä¸­ï¼Œæè¿°Javaæºç è¡Œå·ä¸å­—èŠ‚ç è¡Œå·ï¼ˆå­—èŠ‚ç çš„åç§»é‡ï¼‰ä¹‹é—´çš„å¯¹åº”å…³ç³»ã€‚ä¸»è¦æ˜¯å¦‚æœæŠ›å‡ºå¼‚å¸¸æ—¶ï¼Œç¼–è¯‘å™¨ä¼šæ˜¾ç¤ºè¡Œå·ï¼Œæ¯”å¦‚è°ƒè¯•ç¨‹åºæ—¶å±•ç¤ºçš„è¡Œå·ï¼Œå°±æ˜¯è¿™ä¸ªå±æ€§çš„ä½œç”¨ã€‚Codeå±æ€§è¡¨ä¸­ï¼ŒLineNumberTableå¯ä»¥å±æ€§å¯ä»¥æŒ‰ç…§ä»»æ„é¡ºåºå‡ºç°ã€‚åœ¨Codeå±æ€§ attributesè¡¨ä¸­ï¼Œå¯ä»¥æœ‰ä¸æ­¢ä¸€ä¸ªLineNumberTableå±æ€§å¯¹åº”äºæºæ–‡ä»¶ä¸­çš„åŒä¸€è¡Œã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¤šä¸ªLineNumberTableå±æ€§å¯ä»¥åˆèµ·æ¥è¡¨ç¤ºæºæ–‡ä»¶ä¸­çš„æŸè¡Œä»£ç ï¼Œå±æ€§ä¸æºæ–‡ä»¶çš„ä»£ç è¡Œä¹‹é—´ä¸å¿…æœ‰ä¸€ä¸€å¯¹åº”çš„å…³ç³»ã€‚\n- exception_tableï¼š **åœ¨Javaè™šæ‹Ÿæœºä¸­ï¼Œå¤„ç†å¼‚å¸¸ï¼ˆcatchè¯­å¥ï¼‰ä¸æ˜¯ç”±å­—èŠ‚ç æŒ‡ä»¤æ¥å®ç°çš„ï¼Œè€Œæ˜¯é‡‡ç”¨å¼‚å¸¸è¡¨æ¥å®Œæˆçš„ã€‚** å¼‚å¸¸è¡¨ä¸­æ¯ä¸€ä¸ªæ•°æ®ç”±4éƒ¨åˆ†ç»„æˆï¼Œåˆ†åˆ«æ˜¯start_pcã€end_pcã€handler_pcå’Œcatch_typeã€‚è¿™4é¡¹è¡¨ç¤ºä»æ–¹æ³•å­—èŠ‚ç çš„start_pcåç§»é‡å¼€å§‹ï¼ˆåŒ…æ‹¬ï¼‰åˆ°end_pc åç§»é‡ä¸ºæ­¢ï¼ˆä¸åŒ…æ‹¬ï¼‰çš„è¿™æ®µä»£ç ä¸­ï¼Œå¦‚æœé‡åˆ°äº†catch_typeæ‰€æŒ‡å®šçš„å¼‚å¸¸ï¼Œ é‚£ä¹ˆä»£ç å°±è·³è½¬åˆ°handler_pcçš„ä½ç½®æ‰§è¡Œï¼Œhandler_pcå³ä¸€ä¸ªå¼‚å¸¸å¤„ç†å™¨çš„èµ·ç‚¹ã€‚åœ¨è¿™4é¡¹ä¸­ï¼Œ start_pcã€end_pcå’Œhandlerpc éƒ½æ˜¯å­—èŠ‚ç çš„ç¼–è¯‘é‡ï¼Œ ä¹Ÿå°±æ˜¯åœ¨code[code_length]ä¸­çš„ä½ç½®ï¼Œ è€Œcatch_typeä¸ºæŒ‡å‘å¸¸é‡æ± çš„ç´¢å¼•ï¼Œå®ƒæŒ‡å‘ä¸€ä¸ªCONSTANT_Class_info ç±»ï¼Œè¡¨ç¤ºéœ€è¦å¤„ç†çš„å¼‚å¸¸ç±»å‹ã€‚å¦‚æœcatch_typeå€¼ä¸º0,é‚£ä¹ˆå°†ä¼šåœ¨æ‰€æœ‰å¼‚å¸¸æŠ›å‡ºæ—¶éƒ½è°ƒç”¨è¿™ä¸ªå¼‚å¸¸å¤„ç†å™¨ï¼Œè¿™è¢«ç”¨äºå®ç°finallyè¯­å¥\n","tags":["Java"]},{"title":"ä»£é©¾å¾®æœåŠ¡é¡¹ç›®-ä¹˜å®¢ä¸‹å•","url":"/2024/07/21/ä»£é©¾å¾®æœåŠ¡é¡¹ç›®-ä¹˜å®¢ä¸‹å•/","content":"# ä¹˜å®¢ä¸‹å•\nä¸»è¦ä¸šåŠ¡æ˜¯ä»ä¹˜å®¢é€‰æ‹©èµ·å§‹åœ°ç‚¹å’Œç»ˆæ­¢åœ°ç‚¹ä¹‹åï¼Œä¹Ÿå°±æ˜¯åˆæ­¥è®¡ç®—äº†ä¼°è®¡ä»·æ ¼ç„¶åç‚¹å‡»å‘¼å«å¸æœºä¹‹åçš„è¿‡ç¨‹ã€‚ç­‰åˆ°é™„è¿‘çš„å¸æœºæŠ¢å•æˆåŠŸï¼Œè¯¥ä¸šåŠ¡æ‰§è¡Œå®Œæ¯•ã€‚\n\næµç¨‹å¤§è‡´æ˜¯ï¼š\n1. åœ¨ä¹˜å®¢ç‚¹å‡»ä¸‹å•ä¹‹åï¼Œå‘æ•°æ®åº“å¢åŠ äº†ä¸€ä¸ªorderï¼Œå‰ç«¯æ¯5sè¯¢é—®ä¸€æ¬¡orderçš„å½“å‰çŠ¶æ€æ˜¯å¦ä¸ºæ¥å•ï¼Œåœ¨è¿™æœŸé—´å°±æ²¡æœ‰å®¢æˆ·ç«¯çš„äº‹æƒ…äº†ã€‚\n2. è¿™ä¸ªä¸‹å•çš„åŠ¨ä½œä¼šæ¿€æ´»xxl-jobçš„ä¸€ä¸ªä»»åŠ¡è°ƒåº¦ï¼Œç»™é™„è¿‘å·²ç»å¼€å¯æ¥å•çš„å¸æœºçš„é˜Ÿåˆ—ä¸­åŠ ä¸Šè¿™ä¸ªorderçš„id\n3. ç­‰åˆ°å¸æœºç«¯å‰ç«¯æ£€æŸ¥é˜Ÿåˆ—å‘ç°äº†è¿™ä¸ªè®¢å•ï¼Œå°±ä¼šå¼¹çª—é—®æ˜¯å¦éœ€è¦æ¥å–ï¼Œéšåå°±æ˜¯ä¸€ä¸ªåŠ é”ç„¶åæŠ¢ç¥¨çš„é€»è¾‘äº†ï¼Œéœ€è¦æœ‰é«˜å¹¶å‘çš„æ”¯æŒã€‚\n4. è¿™ä¸ªå¸æœºæŠ¢åˆ°äº†ä¹‹åå°±ä¼šupdateè¿™ä¸ªè®¢å•ï¼ŒæŠŠå¸æœºçš„idå˜ä¸ºè‡ªå·±çš„ï¼ŒçŠ¶æ€æ”¹å˜ã€‚\n5. ç­‰åˆ°ä¹˜å®¢5sè½®è¯¢å‘ç°æ”¹å˜äº†çŠ¶æ€ï¼Œæ­¤æ—¶æ¥å•æˆåŠŸã€‚\n\nå…¶ä¸­ï¼Œæœ€é‡è¦çš„è¿‡ç¨‹æ˜¯xxl-jobçš„è¿™ä¸ªä»»åŠ¡å¦‚ä½•æ‰¾åˆ°å‘¨å›´çš„å¸æœºã€‚å¹³æ—¶ä½¿ç”¨xxl-jobéƒ½æ˜¯åœ¨webæ–°å»ºçš„ï¼Œè¿™é‡Œè¦æ±‚æ¯ä¸€ä¸ªè®¢å•è‡ªåŠ¨ç»™xxl-jobï¼Œä¹Ÿå°±æ˜¯è¦å¯¹xxl-jobçš„æ¥å£åšè°ƒæ•´ï¼Œä½¿å…¶èƒ½å¤Ÿç»§æ‰¿springbootæ–°å»ºä»»åŠ¡ã€‚\né‚£ä¹ˆå‘¨å›´çš„å¸æœºå¦‚ä½•æ‰¾ï¼Œæ¯ä¸€ä¸ªå¸æœºåœ¨æ¥å•çš„æ—¶å€™éƒ½ä¼šæŠŠè‡ªå·±çš„åœ°ç†çº¬åº¦ä¸Šä¼ åˆ°redisï¼Œç”¨redisçš„æ•°æ®ç»“æ„geoå¿«é€Ÿå®Œæˆè®¡ç®—ã€‚\n\n## æ–°å»ºè®¢å•\n\n### POST\"/order/submitOrder\"\n\nç”±å‰ç«¯è°ƒç”¨ç™¾åº¦çš„apiå¾—åˆ°çš„åˆå§‹ä½ç½®å’Œç»“æŸä½ç½®ï¼Œä»¥åŠä¹˜å®¢çš„idæ¥åœ¨orderæ•°æ®åº“ä¸­æ–°å»ºä¸€ä¸ªè®¢å•ã€‚\n\n**å¯¹å¤–æ¥å£**\n```java\n@Operation(summary = \"ä¹˜å®¢ä¸‹å•\")\n@GuiguLogin\n@PostMapping(\"/submitOrder\")\npublic Result<Long> submitOrder(@RequestBody SubmitOrderForm submitOrderForm) {\n   submitOrderForm.setCustomerId(AuthContextHolder.getUserId());\n   return Result.ok(orderService.submitOrder(submitOrderForm));\n}\n```\n\nä½†æ˜¯åœ¨æ•°æ®åº“ä¸­è¿™ä¸ªè¡¨æ˜¯éœ€è¦æœ‰ä¼°è®¡é‡Œç¨‹å’Œä¼°è®¡ä»·æ ¼çš„ï¼Œä¹Ÿå°±æ˜¯è¯´è¿˜è¦å†å»è°ƒç”¨ä¸€æ¬¡mapå¾®æœåŠ¡å’Œruleå¾®æœåŠ¡ã€‚\n```java\n@Autowired\nprivate OrderInfoFeignClient orderInfoFeignClient;\n\n@Override\npublic Long submitOrder(SubmitOrderForm submitOrderForm) {\n    //1.é‡æ–°è®¡ç®—é©¾é©¶çº¿è·¯\n    CalculateDrivingLineForm calculateDrivingLineForm = new CalculateDrivingLineForm();\n    BeanUtils.copyProperties(submitOrderForm, calculateDrivingLineForm);\n    DrivingLineVo drivingLineVo = mapFeignClient.calculateDrivingLine(calculateDrivingLineForm).getData();\n\n    //2.é‡æ–°è®¡ç®—è®¢å•è´¹ç”¨\n    FeeRuleRequestForm calculateOrderFeeForm = new FeeRuleRequestForm();\n    calculateOrderFeeForm.setDistance(drivingLineVo.getDistance());\n    calculateOrderFeeForm.setStartTime(new Date());\n    calculateOrderFeeForm.setWaitMinute(0);\n    FeeRuleResponseVo feeRuleResponseVo = feeRuleFeignClient.calculateOrderFee(calculateOrderFeeForm).getData();\n\n    //3.å°è£…è®¢å•ä¿¡æ¯å¯¹è±¡\n    OrderInfoForm orderInfoForm = new OrderInfoForm();\n    //è®¢å•ä½ç½®ä¿¡æ¯\n    BeanUtils.copyProperties(submitOrderForm, orderInfoForm);\n    //é¢„ä¼°é‡Œç¨‹\n    orderInfoForm.setExpectDistance(drivingLineVo.getDistance());\n    orderInfoForm.setExpectAmount(feeRuleResponseVo.getTotalAmount());\n\n    //4.ä¿å­˜è®¢å•ä¿¡æ¯\n    Long orderId = orderInfoFeignClient.saveOrderInfo(orderInfoForm).getData();\n    \n    //TODOå¯åŠ¨ä»»åŠ¡è°ƒåº¦\n    \n    return orderId;\n}\n```\n**è®¢å•å¾®æœåŠ¡**\n\n```java\n@Autowired\nprivate OrderInfoService orderInfoService;\n\n@Operation(summary = \"ä¿å­˜è®¢å•ä¿¡æ¯\")\n@PostMapping(\"/saveOrderInfo\")\npublic Result<Long> saveOrderInfo(@RequestBody OrderInfoForm orderInfoForm) {\n   return Result.ok(orderInfoService.saveOrderInfo(orderInfoForm));\n}\n```\nè®¾ç½®è®¢å•çš„ä¿¡æ¯ï¼ŒçŠ¶æ€ä¸ºæ­£åœ¨ç­‰å¾…æ¥å•ï¼Œç»™redisè®¾ç½®ä¸€ä¸ªæ ‡è¯†ï¼Œè¯´æ˜æ­£åœ¨æ¥å•ã€‚\n```java\n@Autowired\nprivate OrderInfoMapper orderInfoMapper;\n\n@Autowired\nprivate OrderStatusLogMapper orderStatusLogMapper;\n\n@Autowired\nprivate RedisTemplate redisTemplate;\n\n@Transactional(rollbackFor = {Exception.class})\n@Override\npublic Long saveOrderInfo(OrderInfoForm orderInfoForm) {\n   OrderInfo orderInfo = new OrderInfo();\n   BeanUtils.copyProperties(orderInfoForm, orderInfo);\n   String orderNo = UUID.randomUUID().toString().replaceAll(\"-\",\"\");\n   orderInfo.setStatus(OrderStatus.WAITING_ACCEPT.getStatus());\n   orderInfo.setOrderNo(orderNo);\n   orderInfoMapper.insert(orderInfo);\n\n   //è®°å½•æ—¥å¿—\n   this.log(orderInfo.getId(), orderInfo.getStatus());\n\n   //æ¥å•æ ‡è¯†ï¼Œæ ‡è¯†ä¸å­˜åœ¨äº†è¯´æ˜ä¸åœ¨ç­‰å¾…æ¥å•çŠ¶æ€äº†\n   redisTemplate.opsForValue().set(RedisConstant.ORDER_ACCEPT_MARK, \"0\", RedisConstant.ORDER_ACCEPT_MARK_EXPIRES_TIME, TimeUnit.MINUTES);\n   return orderInfo.getId();\n}\n\npublic void log(Long orderId, Integer status) {\n   OrderStatusLog orderStatusLog = new OrderStatusLog();\n   orderStatusLog.setOrderId(orderId);\n   orderStatusLog.setOrderStatus(status);\n   orderStatusLog.setOperateTime(new Date());\n   orderStatusLogMapper.insert(orderStatusLog);\n}\n```\n### å¸æœºå’Œä¹˜å®¢æŸ¥è¯¢è®¢å•çŠ¶æ€GET\"/getOrderStatus/{orderId}\"\n\nä¹˜å®¢ä¸‹å®Œå•åï¼Œè®¢å•çŠ¶æ€ä¸º1ï¼Œä¹˜å®¢ç«¯å°ç¨‹åºä¼šè½®è¯¢è®¢å•çŠ¶æ€ï¼Œå½“è®¢å•çŠ¶æ€ä¸º2æ—¶ï¼Œè¯´æ˜å·²ç»æœ‰å¸æœºæ¥å•äº†ï¼Œé‚£ä¹ˆé¡µé¢è¿›è¡Œè·³è½¬ï¼Œè¿›è¡Œä¸‹ä¸€æ­¥æ“ä½œ\n\n```java\n@Override\npublic Integer getOrderStatus(Long orderId) {\n   LambdaQueryWrapper<OrderInfo> queryWrapper = new LambdaQueryWrapper<>();\n   queryWrapper.eq(OrderInfo::getId, orderId);\n   queryWrapper.select(OrderInfo::getStatus);\n   OrderInfo orderInfo = orderInfoMapper.selectOne(queryWrapper);\n   if(null == orderInfo) {\n      //è¿”å›nullï¼Œfeignè§£æä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œç»™é»˜è®¤å€¼ï¼Œåç»­ä¼šç”¨\n      return OrderStatus.NULL_ORDER.getStatus();\n   }\n   return orderInfo.getStatus();\n}\n```\n> ä¹˜å®¢ç«¯æ˜¯ä¸€ä¸‹å•å°±ä¸€ç›´è¯¢é—®è¿™ä¸ªæ¥å£æœ‰æ²¡æœ‰æ”¹å˜ï¼›å¸æœºç«¯å¾—æ˜¯æŠ¢åˆ°å•äº†ç„¶åæ‰èƒ½æœ‰è®¢å•çš„idï¼Œå†å»ç”¨è¿™ä¸ªidè¯·æ±‚æ–¹æ³•\n\n## xxl-jobå’Œrediså®Œæˆå¸æœºæœç´¢è°ƒåº¦\n\nxxl-jobå®šæ—¶ä»»åŠ¡æŸ¥è¯¢é™„è¿‘å¸æœºï¼Œå¼€å¯æ¥å•çš„å¸æœºä¼šæŠŠåœ°ç†åæ ‡ä¼ åˆ°redis\n\n```java\n@Autowired\nprivate RedisTemplate redisTemplate;\n\n@Override\npublic Boolean updateDriverLocation(UpdateDriverLocationForm updateDriverLocationForm) {\n    /**\n     *  Redis GEO ä¸»è¦ç”¨äºå­˜å‚¨åœ°ç†ä½ç½®ä¿¡æ¯ï¼Œå¹¶å¯¹å­˜å‚¨çš„ä¿¡æ¯è¿›è¡Œç›¸å…³æ“ä½œï¼Œè¯¥åŠŸèƒ½åœ¨ Redis 3.2 ç‰ˆæœ¬æ–°å¢ã€‚\n     *  åç»­ç”¨åœ¨ï¼Œä¹˜å®¢ä¸‹å•åå¯»æ‰¾5å…¬é‡ŒèŒƒå›´å†…å¼€å¯æ¥å•æœåŠ¡çš„å¸æœºï¼Œé€šè¿‡Redis GEOè¿›è¡Œè®¡ç®—\n     */\n    Point point = new Point(updateDriverLocationForm.getLongitude().doubleValue(), updateDriverLocationForm.getLatitude().doubleValue());\n    redisTemplate.opsForGeo().add(RedisConstant.DRIVER_GEO_LOCATION, point, updateDriverLocationForm.getDriverId().toString());\n    return true;\n}\n\n @Override\npublic Boolean removeDriverLocation(Long driverId) {\n    redisTemplate.opsForGeo().remove(RedisConstant.DRIVER_GEO_LOCATION, driverId.toString());\n    return true;\n}\n```\n### POST\"/searchNearByDriver\"\n\nå¸æœºç«¯çš„å°ç¨‹åºå¼€å¯æ¥å•æœåŠ¡åï¼Œå¼€å§‹å®æ—¶ä¸Šä¼ å¸æœºçš„å®šä½ä¿¡æ¯åˆ°redisçš„GEOç¼“å­˜ï¼Œå‰é¢ä¹˜å®¢å·²ç»ä¸‹å•ï¼Œç°åœ¨æˆ‘ä»¬å°±è¦æŸ¥æ‰¾é™„è¿‘é€‚åˆæ¥å•çš„å¸æœºï¼Œå¦‚æœæœ‰å¯¹åº”çš„å¸æœºï¼Œé‚£å°±ç»™å¸æœºå‘é€æ–°è®¢å•æ¶ˆæ¯ã€‚\n\né¦–å…ˆæ˜¯é…ç½®ç»çº¬åº¦ç‚¹å’Œè·ç¦»ï¼Œä½œä¸ºä¸­å¿ƒå’ŒåŠå¾„ä¼ å…¥redisçš„argï¼Œå¾—åˆ°äº†ä¸€ä¸ªå‡åºæ’åºçš„ä½ç½®è¡¨ï¼Œç„¶åæ ¹æ®è¿™äº›å¾…é€‰å¸æœºçš„ä¸€äº›é…ç½®ï¼ˆæ¯”å¦‚è¶…è¿‡å¤šå°‘è·ç¦»ä¸äºˆé…é€ï¼‰ç­›é€‰å‡ºç¬¦åˆçš„ä¸€é˜Ÿå¸æœºï¼Œä½œä¸ºç»“æœè¿”å›ã€‚\n```java\n@Autowired\nprivate DriverInfoFeignClient driverInfoFeignClient;\n\n@Override\npublic List<NearByDriverVo> searchNearByDriver(SearchNearByDriverForm searchNearByDriverForm) {\n    // æœç´¢ç»çº¬åº¦ä½ç½®5å…¬é‡Œä»¥å†…çš„å¸æœº\n    //å®šä¹‰ç»çº¬åº¦ç‚¹\n    Point point = new Point(searchNearByDriverForm.getLongitude().doubleValue(), searchNearByDriverForm.getLatitude().doubleValue());\n    //å®šä¹‰è·ç¦»ï¼š5å…¬é‡Œ(ç³»ç»Ÿé…ç½®)\n    Distance distance = new Distance(SystemConstant.NEARBY_DRIVER_RADIUS, RedisGeoCommands.DistanceUnit.KILOMETERS);\n    //å®šä¹‰ä»¥pointç‚¹ä¸ºä¸­å¿ƒï¼Œdistanceä¸ºè·ç¦»è¿™ä¹ˆä¸€ä¸ªèŒƒå›´\n    Circle circle = new Circle(point, distance);\n\n    //å®šä¹‰GEOå‚æ•°\n    RedisGeoCommands.GeoRadiusCommandArgs args = RedisGeoCommands.GeoRadiusCommandArgs.newGeoRadiusArgs()\n            .includeDistance() //åŒ…å«è·ç¦»\n            .includeCoordinates() //åŒ…å«åæ ‡\n            .sortAscending(); //æ’åºï¼šå‡åº\n\n    // 1.GEORADIUSè·å–é™„è¿‘èŒƒå›´å†…çš„ä¿¡æ¯\n    GeoResults<RedisGeoCommands.GeoLocation<String>> result = this.redisTemplate.opsForGeo().radius(RedisConstant.DRIVER_GEO_LOCATION, circle, args);\n\n    //2.æ”¶é›†ä¿¡æ¯ï¼Œå­˜å…¥list\n    List<GeoResult<RedisGeoCommands.GeoLocation<String>>> content = result.getContent();\n\n    //3.è¿”å›è®¡ç®—åçš„ä¿¡æ¯\n    List<NearByDriverVo> list = new ArrayList();\n    if(!CollectionUtils.isEmpty(content)) {\n        Iterator<GeoResult<RedisGeoCommands.GeoLocation<String>>> iterator = content.iterator();\n        while (iterator.hasNext()) {\n            GeoResult<RedisGeoCommands.GeoLocation<String>> item = iterator.next();\n\n            //å¸æœºid\n            Long driverId = Long.parseLong(item.getContent().getName());\n            //å½“å‰è·ç¦»\n            BigDecimal currentDistance = new BigDecimal(item.getDistance().getValue()).setScale(2, RoundingMode.HALF_UP);\n            log.info(\"å¸æœºï¼š{}ï¼Œè·ç¦»ï¼š{}\",driverId, item.getDistance().getValue());\n\n            //è·å–å¸æœºæ¥å•è®¾ç½®å‚æ•°\n            DriverSet driverSet = driverInfoFeignClient.getDriverSet(driverId).getData();\n            //æ¥å•é‡Œç¨‹åˆ¤æ–­ï¼ŒacceptDistance==0ï¼šä¸é™åˆ¶ï¼Œ\n            if(driverSet.getAcceptDistance().doubleValue() != 0 && driverSet.getAcceptDistance().subtract(currentDistance).doubleValue() < 0) {\n                continue;\n            }\n            //è®¢å•é‡Œç¨‹åˆ¤æ–­ï¼ŒorderDistance==0ï¼šä¸é™åˆ¶\n            if(driverSet.getOrderDistance().doubleValue() != 0 && driverSet.getOrderDistance().subtract(searchNearByDriverForm.getMileageDistance()).doubleValue() < 0) {\n                continue;\n            }\n\n            //æ»¡è¶³æ¡ä»¶çš„é™„è¿‘å¸æœºä¿¡æ¯\n            NearByDriverVo nearByDriverVo = new NearByDriverVo();\n            nearByDriverVo.setDriverId(driverId);\n            nearByDriverVo.setDistance(currentDistance);\n            list.add(nearByDriverVo);\n        }\n    }\n    return list;\n}\n```\n\n> xxl-jobè¿™é‡Œé…ç½®å°±ä¸åšä»‹ç»äº†ï¼Œä¸»è¦æ¢³ç†ä¸šåŠ¡\n\nå‡†å¤‡ä¸€ä¸ªæ·»åŠ ä»»åŠ¡è°ƒåº¦çš„ä¸šåŠ¡ï¼Œä¸€åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡\n```java\n@Transactional(rollbackFor = Exception.class)\n@Override\npublic Long addAndStartTask(NewOrderTaskVo newOrderTaskVo) {\n    OrderJob orderJob = orderJobMapper.selectOne(new LambdaQueryWrapper<OrderJob>().eq(OrderJob::getOrderId, newOrderTaskVo.getOrderId()));\n    if(null == orderJob) {\n        //æ–°å¢ä¸€ä¸ªåä¸ºnewOrderTaskHandlerçš„ä»»åŠ¡è°ƒåº¦ï¼Œä¸€åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡\n        Long jobId = xxlJobClient.addAndStart(\"newOrderTaskHandler\", \"\", \"0 0/1 * * * ?\", \"æ–°è®¢å•ä»»åŠ¡,è®¢å•idï¼š\"+newOrderTaskVo.getOrderId());\n\n        //è®°å½•è®¢å•ä¸ä»»åŠ¡çš„å…³è”ä¿¡æ¯\n        orderJob = new OrderJob();\n        orderJob.setOrderId(newOrderTaskVo.getOrderId());\n        orderJob.setJobId(jobId);\n        orderJob.setParameter(JSONObject.toJSONString(newOrderTaskVo));\n        orderJobMapper.insert(orderJob);\n    }\n    return orderJob.getJobId();\n}\n```\n**newOrderTaskHandler**\n```java\n@XxlJob(\"newOrderTaskHandler\")\npublic void newOrderTaskHandler() {\n    log.info(\"æ–°è®¢å•è°ƒåº¦ä»»åŠ¡ï¼š{}\", XxlJobHelper.getJobId());\n\n    //è®°å½•å®šæ—¶ä»»åŠ¡ç›¸å…³çš„æ—¥å¿—ä¿¡æ¯\n    //å°è£…æ—¥å¿—å¯¹è±¡\n    XxlJobLog xxlJobLog = new XxlJobLog();\n    xxlJobLog.setJobId(XxlJobHelper.getJobId());\n    long startTime = System.currentTimeMillis();\n    try {\n        //æ‰§è¡Œä»»åŠ¡\n        newOrderService.executeTask(XxlJobHelper.getJobId());\n\n        xxlJobLog.setStatus(1);//æˆåŠŸ\n    } catch (Exception e) {\n        xxlJobLog.setStatus(0);//å¤±è´¥\n        xxlJobLog.setError(ExceptionUtil.getAllExceptionMsg(e));\n        log.error(\"å®šæ—¶ä»»åŠ¡æ‰§è¡Œå¤±è´¥ï¼Œä»»åŠ¡idä¸ºï¼š{}\", XxlJobHelper.getJobId());\n        e.printStackTrace();\n    } finally {\n        //è€—æ—¶\n        int times = (int) (System.currentTimeMillis() - startTime);\n        xxlJobLog.setTimes(times);\n        xxlJobLogMapper.insert(xxlJobLog);\n    }\n}\n\n@Override\npublic Boolean executeTask(Long jobId) {\n    //è·å–ä»»åŠ¡å‚æ•°\n    OrderJob orderJob = orderJobMapper.selectOne(new LambdaQueryWrapper<OrderJob>().eq(OrderJob::getJobId, jobId));\n    if(null == orderJob) {\n        return true;\n    }\n    NewOrderTaskVo newOrderTaskVo = JSONObject.parseObject(orderJob.getParameter(), NewOrderTaskVo.class);\n\n    //æŸ¥è¯¢è®¢å•çŠ¶æ€ï¼Œå¦‚æœè¯¥è®¢å•è¿˜åœ¨æ¥å•çŠ¶æ€ï¼Œç»§ç»­æ‰§è¡Œï¼›å¦‚æœä¸åœ¨æ¥å•çŠ¶æ€ï¼Œåˆ™åœæ­¢å®šæ—¶è°ƒåº¦\n    Integer orderStatus = orderInfoFeignClient.getOrderStatus(newOrderTaskVo.getOrderId()).getData();\n    if(orderStatus.intValue() != OrderStatus.WAITING_ACCEPT.getStatus().intValue()) {\n        xxlJobClient.stopJob(jobId);\n        log.info(\"åœæ­¢ä»»åŠ¡è°ƒåº¦: {}\", JSON.toJSONString(newOrderTaskVo));\n        return true;\n    }\n\n    //æœç´¢é™„è¿‘æ»¡è¶³æ¡ä»¶çš„å¸æœº\n    SearchNearByDriverForm searchNearByDriverForm = new SearchNearByDriverForm();\n    searchNearByDriverForm.setLongitude(newOrderTaskVo.getStartPointLongitude());\n    searchNearByDriverForm.setLatitude(newOrderTaskVo.getStartPointLatitude());\n    searchNearByDriverForm.setMileageDistance(newOrderTaskVo.getExpectDistance());\n    List<NearByDriverVo> nearByDriverVoList = locationFeignClient.searchNearByDriver(searchNearByDriverForm).getData();\n    //ç»™å¸æœºæ´¾å‘è®¢å•ä¿¡æ¯\n    nearByDriverVoList.forEach(driver -> {\n        //è®°å½•å¸æœºidï¼Œé˜²æ­¢é‡å¤æ¨é€è®¢å•ä¿¡æ¯\n        String repeatKey = RedisConstant.DRIVER_ORDER_REPEAT_LIST+newOrderTaskVo.getOrderId();\n        boolean isMember = redisTemplate.opsForSet().isMember(repeatKey, driver.getDriverId());\n        if(!isMember) {\n            //è®°å½•è¯¥è®¢å•å·²æ”¾å…¥å¸æœºä¸´æ—¶å®¹å™¨\n            redisTemplate.opsForSet().add(repeatKey, driver.getDriverId());\n            //è¿‡æœŸæ—¶é—´ï¼š15åˆ†é’Ÿï¼Œæ–°è®¢å•15åˆ†é’Ÿæ²¡äººæ¥å•è‡ªåŠ¨å–æ¶ˆ\n            redisTemplate.expire(repeatKey, RedisConstant.DRIVER_ORDER_REPEAT_LIST_EXPIRES_TIME, TimeUnit.MINUTES);\n\n            NewOrderDataVo newOrderDataVo = new NewOrderDataVo();\n            newOrderDataVo.setOrderId(newOrderTaskVo.getOrderId());\n            newOrderDataVo.setStartLocation(newOrderTaskVo.getStartLocation());\n            newOrderDataVo.setEndLocation(newOrderTaskVo.getEndLocation());\n            newOrderDataVo.setExpectAmount(newOrderTaskVo.getExpectAmount());\n            newOrderDataVo.setExpectDistance(newOrderTaskVo.getExpectDistance());\n            newOrderDataVo.setExpectTime(newOrderTaskVo.getExpectTime());\n            newOrderDataVo.setFavourFee(newOrderTaskVo.getFavourFee());\n            newOrderDataVo.setDistance(driver.getDistance());\n            newOrderDataVo.setCreateTime(newOrderTaskVo.getCreateTime());\n\n            //å°†æ¶ˆæ¯ä¿å­˜åˆ°å¸æœºçš„ä¸´æ—¶é˜Ÿåˆ—é‡Œé¢ï¼Œå¸æœºæ¥å•äº†ä¼šå®šæ—¶è½®è¯¢åˆ°ä»–çš„ä¸´æ—¶é˜Ÿåˆ—è·å–è®¢å•æ¶ˆæ¯\n            String key = RedisConstant.DRIVER_ORDER_TEMP_LIST+driver.getDriverId();\n            redisTemplate.opsForList().leftPush(key, JSONObject.toJSONString(newOrderDataVo));\n            //è¿‡æœŸæ—¶é—´ï¼š1åˆ†é’Ÿï¼Œ1åˆ†é’Ÿæœªæ¶ˆè´¹ï¼Œè‡ªåŠ¨è¿‡æœŸ\n            //æ³¨ï¼šå¸æœºç«¯å¼€å¯æ¥å•ï¼Œå‰ç«¯æ¯5ç§’ï¼ˆè¿œå°äº1åˆ†é’Ÿï¼‰æ‹‰å–1æ¬¡â€œå¸æœºä¸´æ—¶é˜Ÿåˆ—â€é‡Œé¢çš„æ–°è®¢å•æ¶ˆæ¯\n            redisTemplate.expire(key, RedisConstant.DRIVER_ORDER_TEMP_LIST_EXPIRES_TIME, TimeUnit.MINUTES);\n            log.info(\"è¯¥æ–°è®¢å•ä¿¡æ¯å·²æ”¾å…¥å¸æœºä¸´æ—¶é˜Ÿåˆ—: {}\", JSON.toJSONString(newOrderDataVo));\n        }\n    });\n    return true;\n}\n```\næœ€åå†åœ¨ä¸‹å•çš„é‚£ä¸ªä»»åŠ¡ä¸­æ‰§è¡Œæ·»åŠ xxl-jobä»»åŠ¡è°ƒåº¦ã€‚","tags":["Redis"]},{"title":"ä»£é©¾å¾®æœåŠ¡é¡¹ç›®-ä¹˜å®¢ç«¯æ ¸å¿ƒä¸šåŠ¡é€»è¾‘","url":"/2024/07/19/ä»£é©¾å¾®æœåŠ¡é¡¹ç›®-ä¹˜å®¢ç«¯æ ¸å¿ƒä¸šåŠ¡é€»è¾‘/","content":"# ç™»å½•\n## å¾®ä¿¡çš„ç™»å½•é€»è¾‘\n<div style=\"text-align: center;\">\n  <img src=\"../img/daijia/img.png\" alt=\"\" />\n</div>\nè¯´æ˜ï¼š\n\n1. è°ƒç”¨ [wx.login()](https://developers.weixin.qq.com/miniprogram/dev/api/open-api/login/wx.login.html) è·å– **ä¸´æ—¶ç™»å½•å‡­è¯code** ï¼Œå¹¶å›ä¼ åˆ°å¼€å‘è€…æœåŠ¡å™¨ã€‚\n2. è°ƒç”¨ [auth.code2Session](https://developers.weixin.qq.com/miniprogram/dev/OpenApiDoc/user-login/code2Session.html) æ¥å£ï¼Œæ¢å– **ç”¨æˆ·å”¯ä¸€æ ‡è¯† OpenID** ã€ ç”¨æˆ·åœ¨å¾®ä¿¡å¼€æ”¾å¹³å°è´¦å·ä¸‹çš„**å”¯ä¸€æ ‡è¯†UnionID**ï¼ˆè‹¥å½“å‰å°ç¨‹åºå·²ç»‘å®šåˆ°å¾®ä¿¡å¼€æ”¾å¹³å°è´¦å·ï¼‰ å’Œ **ä¼šè¯å¯†é’¥ session_key**ã€‚\n\nä¹‹åå¼€å‘è€…æœåŠ¡å™¨å¯ä»¥æ ¹æ®ç”¨æˆ·æ ‡è¯†æ¥ç”Ÿæˆè‡ªå®šä¹‰ç™»å½•æ€ï¼Œç”¨äºåç»­ä¸šåŠ¡é€»è¾‘ä¸­å‰åç«¯äº¤äº’æ—¶è¯†åˆ«ç”¨æˆ·èº«ä»½\n\nå¯¹äºä¸šåŠ¡è€Œè¨€ï¼Œæœ€é¦–å…ˆè¿”å›çš„å°±æ˜¯è¿™ä¸ªcodeï¼Œåç«¯è¦åšçš„å°±æ˜¯æŠŠè¿™ä¸ªcodeç»“åˆè‡ªå·±å°ç¨‹åºçš„appidå’Œappsecretå»è¯·æ±‚å¾®ä¿¡åå°ï¼Œç»™å‡ºå½“å‰ç”¨æˆ·çš„openidã€‚\n\n### æ¥å£1ï¼šGET\"/customer/login/{code}\"\n\næ•´ä½“çš„æµç¨‹æ˜¯ï¼š\n1. å¯¹å¤–serviceæ‹¿ç€è¿™ä¸ªå‰ç«¯å‘æ¥çš„codeå»è¿œç¨‹è°ƒç”¨ä¹˜å®¢å¾®æœåŠ¡\n2. ä¹˜å®¢å¾®æœåŠ¡è¯·æ±‚å¾®ä¿¡çš„åå°å¾—åˆ°openidï¼Œç„¶åå»æ•°æ®åº“æŸ¥æ˜¯å¦å­˜åœ¨è¿™ä¸ªopenidï¼Œä¹Ÿå°±æ˜¯æ˜¯å¦æ³¨å†Œè¿‡äº†\n3. å¦‚æœæ²¡æœ‰æ³¨å†Œå°±è¿›è¡Œæ³¨å†Œï¼Œæœ€åå†™å…¥æ“ä½œæ—¥å¿—ï¼Œè¿”å›è¿™ä¸ªopenidå¯¹åº”çš„æ•°æ®åº“idï¼Œæˆ‘ä»¬çš„ä¸šåŠ¡æ˜¯åŸºäºè‡ªå®¶æ•°æ®åº“çš„ã€‚\n4. å¯¹å¤–serviceæ‹¿åˆ°äº†è¿™ä¸ªidï¼Œå°†å…¶ç¼“å­˜è¿›redisä¸­ï¼Œkeyæ˜¯UUIDï¼Œvalueæ˜¯åœ¨**è‡ªå®¶æ•°æ®åº“**ä¸­çš„idï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨redisä¸­æœ‰è¿™ä¸ªé”®å€¼å¯¹é‚£å°±è¯´æ˜æ˜¯ç™»å½•çŠ¶æ€ã€‚\n5. æœ€åredisä¸­çš„è¿™ä¸ªUUIDä½œä¸ºtokenç»™å‰ç«¯ï¼Œå‰ç«¯æ¯æ¬¡å‘è¯·æ±‚éƒ½æºå¸¦è¿™ä¸ªtokenã€‚**ä¼˜åŒ–ï¼š** å¯ä»¥ä½¿ç”¨jwtï¼Ÿ\n\n**å¯¹å¤–æ¥å£ï¼š**\n```java\n@Operation(summary = \"å°ç¨‹åºæˆæƒç™»å½•\")\n@GetMapping(\"/login/{code}\")\npublic Result<String> wxLogin(@PathVariable String code) {\n   return Result.ok(customerInfoService.login(code));\n}\n```\n\n```java\n@Autowired\nprivate CustomerInfoFeignClient customerInfoFeignClient;\n\n@Autowired\nprivate RedisTemplate redisTemplate;\n\n@Override\npublic String login(String code) {\n   //è·å–openId\n   Result<Long> result = customerInfoFeignClient.login(code);\n   if(result.getCode().intValue() != 200) {\n      throw new GuiguException(result.getCode(), result.getMessage());\n   }\n   Long customerId = result.getData();\n   if(null == customerId) {\n      throw new GuiguException(ResultCodeEnum.DATA_ERROR);\n   }\n\n   String token = UUID.randomUUID().toString().replaceAll(\"-\", \"\");\n   redisTemplate.opsForValue().set(RedisConstant.USER_LOGIN_KEY_PREFIX+token, customerId.toString(), RedisConstant.USER_LOGIN_KEY_TIMEOUT, TimeUnit.SECONDS);\n   return token;\n}\n```\n**ä¹˜å®¢å¾®æœåŠ¡æ¥å£ï¼š**\n```java\n@Operation(summary = \"å°ç¨‹åºæˆæƒç™»å½•\")\n@GetMapping(\"/login/{code}\")\npublic Result<Long> login(@PathVariable String code) {\n   return Result.ok(customerInfoService.login(code));\n}\n```\n\n```java\n@Autowired\nprivate WxMaService wxMaService;\n\n@Autowired\nprivate CustomerLoginLogMapper customerLoginLogMapper;\n\n/**\n * æ¡ä»¶ï¼š\n *      1ã€å‰ç«¯å¼€å‘è€…appidä¸æœåŠ¡å™¨ç«¯appidä¸€è‡´\n *      2ã€å‰ç«¯å¼€å‘è€…å¿…é¡»åŠ å…¥å¼€å‘è€…\n * @param code\n * @return\n */\n@Transactional(rollbackFor = {Exception.class})\n@Override\npublic Long login(String code) {\n   String openId = null;\n   try {\n      //è·å–openId\n      WxMaJscode2SessionResult sessionInfo = wxMaService.getUserService().getSessionInfo(code);\n      openId = sessionInfo.getOpenid();\n      log.info(\"ã€å°ç¨‹åºæˆæƒã€‘openId={}\", openId);\n   } catch (Exception e) {\n       e.printStackTrace();\n      throw new GuiguException(ResultCodeEnum.WX_CODE_ERROR);\n   }\n   //æŸ¥æœ¬åœ°æ•°æ®åº“æ˜¯å¦æœ‰è¿™æ¡\n   CustomerInfo customerInfo = this.getOne(new LambdaQueryWrapper<CustomerInfo>().eq(CustomerInfo::getWxOpenId, openId));\n   if(null == customerInfo) {\n      customerInfo = new CustomerInfo();\n      customerInfo.setNickname(String.valueOf(System.currentTimeMillis()));\n      customerInfo.setAvatarUrl(\"https://oss.aliyuncs.com/aliyun_id_photo_bucket/default_handsome.jpg\");\n      customerInfo.setWxOpenId(openId);\n      this.save(customerInfo);\n   }\n    \n   //ç™»å½•æ—¥å¿—\n   CustomerLoginLog customerLoginLog = new CustomerLoginLog();\n   customerLoginLog.setCustomerId(customerInfo.getId());\n   customerLoginLog.setMsg(\"å°ç¨‹åºç™»å½•\");\n   customerLoginLogMapper.insert(customerLoginLog);\n   return customerInfo.getId();\n}\n```\n### æ¥å£2ï¼šGET\"/customer/getCustomerLoginInfo\"\n\nå½“å‰ä¸€ä¸ªæ–¹æ³•æ‰§è¡ŒæˆåŠŸåï¼Œè¿”å›äº†ä¸€ä¸ªtokenï¼Œæ¯æ¬¡è¯·æ±‚éƒ½ä¼šæºå¸¦è¿™ä¸ªtokenã€‚æœ‰äº†è¿™ä¸ªtokenåå‰ç«¯ä¼šå‘è¿™ä¸ªè¯·æ±‚è·å¾—è¯¥ç”¨æˆ·çš„è¯¦ç»†ä¿¡æ¯ã€‚é‚£æ—¢ç„¶æŠŠUUIDå’Œvalueéƒ½æ”¾åœ¨redisé‡Œäº†ï¼Œé‚£æ¯ä¸€æ¬¡éƒ½ä»rediså–å°±å¥½äº†ã€‚\n\n**AOP+æ³¨è§£+ThreadLocal**\nè¿™ä¸ªæ³¨è§£çš„ä¸»è¦æ€è·¯æ˜¯ï¼Œåœ¨æ¯ä¸ªcontrolleræ–¹æ³•è°ƒç”¨ä¹‹å‰ï¼Œå…ˆå»è§£ærequestè¯·æ±‚çš„tokenï¼Œtokené‡Œé¢æ˜¯ç™»å½•æ—¶æ‰€ç»™çš„UUIDï¼Œç„¶åå†å»è®¿é—®rediså¾—åˆ°å½“å‰ç™»å½•ç”¨æˆ·çš„æœ¬åœ°æ•°æ®åº“idï¼ŒæŠŠå®ƒæ”¾åœ¨ä¸€ä¸ªThreadLocalä¿å­˜ï¼Œè¿™æ ·è¯¥æ–¹æ³•æ‰§è¡Œçš„è¿‡ç¨‹ä¸­åªç”¨åœ¨ThreadLocalä¸­å–è¿™ä¸ªå°±å¯ä»¥ç”¨äº†ã€‚\n\n***ä¸»è¦æ˜¯ç”¨äºå–ä»£ç½‘å…³çš„prehandleï¼Œå…¶å®æœ¬è´¨æ˜¯ä¸€æ ·çš„ï¼Œç½‘å…³æ˜¯ç›´æ¥æ‹¦æˆªrequestå¾—åˆ°tokenï¼Œè¿›è¡Œå¤„ç†åå†æ”¾åˆ°ThreadLocalä¸­***\n```java\n@Documented\n@Retention(RetentionPolicy.RUNTIME)\n@Target(ElementType.METHOD)\npublic @interface GuiguLogin {\n\n}\n```\n\n```java\n@Slf4j\n@Component\n@Aspect\n@Order(100)\npublic class GuiguLoginAspect {\n\n    @Autowired\n    private RedisTemplate redisTemplate;\n\n    /**\n     *\n     * @param joinPoint\n     * @param guiguLogin\n     * @return\n     * @throws Throwable\n     */\n    @Around(\"execution(* com.atguigu.daijia.*.controller.*.*(..)) && @annotation(guiguLogin)\")\n    public Object process(ProceedingJoinPoint joinPoint, GuiguLogin guiguLogin) throws Throwable {\n        RequestAttributes ra = RequestContextHolder.getRequestAttributes();\n        ServletRequestAttributes sra = (ServletRequestAttributes) ra;\n        HttpServletRequest request = sra.getRequest();\n        String token = request.getHeader(\"token\");\n\n        if(!StringUtils.hasText(token)) {\n            throw new GuiguException(ResultCodeEnum.LOGIN_AUTH);\n        }\n        String userId = (String)redisTemplate.opsForValue().get(RedisConstant.USER_LOGIN_KEY_PREFIX+token);\n        if(StringUtils.hasText(userId)) {\n            AuthContextHolder.setUserId(Long.parseLong(userId));\n        }\n        return joinPoint.proceed();\n    }\n\n}\n```\n\næœ‰äº†è¿™ä¸ªæ³¨è§£å†è¿›è¡Œä¸ªäººèµ„æ–™çš„è·å–ï¼Œç°åœ¨ç›´æ¥å°±åœ¨æ¥å£ä¸Šç”¨åˆ™ä¸ªæ³¨è§£ï¼Œç„¶åå†åœ¨æ–¹æ³•é‡Œé¢å–å‡ºidå°±å¯ä»¥äº†ï¼Œå¤§è‡´æµç¨‹æ˜¯ï¼š\n1. ç”¨æ³¨è§£å¾—åˆ°çš„idè¯·æ±‚å®¢æˆ·å¾®æœåŠ¡\n2. å®¢æˆ·å¾®æœåŠ¡ç”¨idæŸ¥æ•°æ®åº“\n\n**å¯¹å¤–æ¥å£ï¼š**\n```java\n@Operation(summary = \"è·å–å®¢æˆ·ç™»å½•ä¿¡æ¯\")\n@GuiguLogin\n@GetMapping(\"/getCustomerLoginInfo\")\npublic Result<CustomerLoginVo> getCustomerLoginInfo() {\n   Long customerId = AuthContextHolder.getUserId();\n   return Result.ok(customerInfoService.getCustomerLoginInfo(customerId));\n}\n```\n\n```java\n@Override\npublic CustomerLoginVo getCustomerLoginInfo(Long customerId) {\n   Result<CustomerLoginVo> result = customerInfoFeignClient.getCustomerLoginInfo(customerId);\n   if(result.getCode().intValue() != 200) {\n      throw new GuiguException(result.getCode(), result.getMessage());\n   }\n   CustomerLoginVo customerLoginVo = result.getData();\n   if(null == customerLoginVo) {\n      throw new GuiguException(ResultCodeEnum.DATA_ERROR);\n   }\n   return customerLoginVo;\n}\n```\n**å®¢æˆ·å¾®æœåŠ¡ï¼š**\nè¿™é‡Œåªå†™å®ç°ç±»ï¼Œæ¥å£åªæ˜¯ä¼ å¯¼æ²¡æœ‰å®é™…é€»è¾‘ã€‚\n```java\n@Override\npublic CustomerLoginVo getCustomerLoginInfo(Long customerId) {\n   CustomerInfo customerInfo = this.getById(customerId);\n   CustomerLoginVo customerInfoVo = new CustomerLoginVo();\n   BeanUtils.copyProperties(customerInfo, customerInfoVo);\n   //åˆ¤æ–­æ˜¯å¦ç»‘å®šæ‰‹æœºå·ç ï¼Œå¦‚æœæœªç»‘å®šï¼Œå°ç¨‹åºç«¯å‘èµ·ç»‘å®šäº‹ä»¶\n   Boolean isBindPhone = StringUtils.hasText(customerInfo.getPhone());\n   customerInfoVo.setIsBindPhone(isBindPhone);\n   return customerInfoVo;\n}\n```\n\n## è‡ªå®šä¹‰feignå…¨å±€å¤„ç†\nåœ¨Feignè°ƒç”¨çš„è¿‡ç¨‹ä¸­ï¼Œç”±äºå…¨å±€å¼‚å¸¸çš„å¤„ç†ï¼Œæ‰€æœ‰çš„Feignè°ƒç”¨éƒ½ä¼šè¿”å›Result<T>å¯¹è±¡ï¼Œæˆ‘ä»¬è¿˜å¿…é¡»åˆ¤æ–­å®ƒçš„codeæ˜¯å¦ç­‰äº200ï¼Œå¦‚æœä¸ç­‰äº200ï¼Œé‚£ä¹ˆè¯´æ˜è°ƒç”¨ç»“æœæŠ›å‡ºå¼‚å¸¸äº†ï¼Œæˆ‘ä»¬å¿…é¡»è¿”å›å¼‚å¸¸ä¿¡æ¯æç¤ºç»™æ¥å£ï¼Œå¦‚æœè¿”å›codeç­‰äº200ï¼Œæˆ‘ä»¬åˆå¿…é¡»åˆ¤æ–­dataæ˜¯å¦ç­‰äºnullï¼Œå¤„ç†æ–¹å¼éƒ½ä¸€è‡´ï¼Œå¤„ç†èµ·æ¥å¾ˆç¹çï¼Œæœ‰æ²¡æœ‰å¥½çš„ç»Ÿä¸€å¤„ç†æ–¹å¼å‘¢ï¼Ÿ\n\nç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å…¨å±€è‡ªå®šä¹‰Feignç»“æœè§£ææ¥å¤„ç†å°±å¯ä»¥äº†ã€‚\n\nè¯´æ˜ï¼šä»»ä½•Feignè°ƒç”¨Result<T>å¯¹è±¡çš„dataæˆ‘ä»¬éƒ½å¿…é¡»é»˜è®¤ç»™ä¸€ä¸ªè¿”å›å€¼ï¼Œå¦åˆ™ä»»åŠ¡æ•°æ®å¼‚å¸¸ã€‚\n\n**è‡ªå®šä¹‰è§£ç å™¨:**\n\n```java\n/**\n * OpenFeign è‡ªå®šä¹‰ç»“æœè§£ç å™¨\n */\npublic class FeignCustomDataDecoder implements Decoder {\n    private final SpringDecoder decoder;\n\n    public FeignCustomDataDecoder(SpringDecoder decoder) {\n        this.decoder = decoder;\n    }\n\n    @Override\n    public Object decode(Response response, Type type) throws IOException {\n        Object object = this.decoder.decode(response, type);\n        if (null == object) {\n            throw new DecodeException(ResultCodeEnum.FEIGN_FAIL.getCode(), ResultCodeEnum.FEIGN_FAIL.getMessage(), response.request());//\"æ•°æ®è§£æå¤±è´¥\"\n        }\n        if(object instanceof Result<?>) {\n            Result<?> result = ( Result<?>)object;\n            //è¿”å›çŠ¶æ€!=200ï¼Œç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œå…¨å±€å¼‚å¸¸æ•è·å¼‚å¸¸ï¼Œæ¥å£æç¤º\n            if (result.getCode().intValue() != ResultCodeEnum.SUCCESS.getCode().intValue()) {\n                throw new DecodeException(result.getCode(), result.getMessage(), response.request());//\"æ•°æ®è§£æå¤±è´¥\"\n            }\n            //è¿œç¨‹è°ƒç”¨å¿…é¡»æœ‰è¿”å›å€¼ï¼Œå…·ä½“è°ƒç”¨ä¸­ä¸ç”¨åˆ¤æ–­result.getData() == nullï¼Œè¿™é‡Œç»Ÿä¸€å¤„ç†\n            if (null == result.getData()) {\n                throw new DecodeException(ResultCodeEnum.FEIGN_FAIL.getCode(), ResultCodeEnum.FEIGN_FAIL.getMessage(), response.request());//\"æ•°æ®è§£æå¤±è´¥\"\n            }\n            return result;\n        }\n        return object;\n    }\n}\n```\n\n```java\n@Configuration\npublic class FeignConfig {\n\n    /**\n     * è‡ªå®šä¹‰è§£æå™¨\n     *\n     * @param msgConverters ä¿¡æ¯è½¬æ¢\n     * @param customizers   è‡ªå®šä¹‰å‚æ•°\n     * @return è§£æå™¨\n     */\n    @Bean\n    public Decoder decoder(ObjectFactory<HttpMessageConverters> msgConverters, ObjectProvider<HttpMessageConverterCustomizer> customizers) {\n        return new OptionalDecoder((new ResponseEntityDecoder(new FeignCustomDataDecoder(new SpringDecoder(msgConverters, customizers)))));\n    }\n\n}\n```\n//TODO: è¿™ä¸€å—éœ€è¦å¯¹äº†è§£openfeignçš„ç»“æ„æœ‰ä¸€å®šçš„äº†è§£ï¼Œåç»­å°†å¯¹è¿™ä¸€å—è¿›è¡Œè¡¥å……","tags":["Redis"]},{"title":"æ–°å‘-ä»£é©¾å¾®æœåŠ¡é¡¹ç›®","url":"/2024/07/19/æ–°å‘-ä»£é©¾å¾®æœåŠ¡é¡¹ç›®/","content":"> å‰è¨€ï¼šä¸€ç›´éƒ½æƒ³åšä¸€ä¸ªæœ‰ç‚¹é«˜çº§ä½†æ˜¯åˆé‡å¤åº¦ä½çš„é¡¹ç›®ï¼Œæ­£å¥½è®©æˆ‘é‡ä¸Šäº†è¿™ä¸ªå°šç¡…è°·åˆšå‘çš„ã€Šä¹å°šä»£é©¾ã€‹ï¼Œåšäº†ä¸€ä¸‹æ„Ÿè§‰è¿˜æ˜¯æœ‰å­¦åˆ°å¾ˆå¤šä¸œè¥¿çš„ï¼Œä¸ç®¡ä»¥åæ”¾ä¸æ”¾åœ¨ç®€å†é‡Œé¢ï¼Œç®—æ˜¯å…ˆå¼€äº†ä¸€ä¸ªå°å¤´ï¼Œå¼„æ‡‚å†è¯´ã€‚\n\n# é¡¹ç›®ä»‹ç»\nè¯¥é¡¹ç›®æ˜¯æ¨¡ä»¿æ»´æ»´çš„ä¸€ä¸ªä»£é©¾ç³»ç»Ÿï¼Œå‰ç«¯æ˜¯åŸºäºuniappçš„å¾®ä¿¡å°ç¨‹åºï¼Œåˆ†ä¸ºä¸‰ä¸ªç«¯å£ï¼šå®¢æˆ·ç«¯ï¼Œå¸æœºç«¯å’Œç®¡ç†ç³»ç»Ÿã€‚ä¸šåŠ¡å¾ˆçº¯ç²¹ï¼Œå°±æ˜¯ä¹˜å®¢åŸºäºå½“å‰ä½ç½®å‘¼å«å‘¨å›´æ­£åœ¨æ¥å•çš„å¸æœºï¼Œå¸æœºæ¥å•åå¯¹è½¦è¾†çš„åŸºæœ¬æƒ…å†µè¿›è¡Œä¸Šä¼ ï¼Œç„¶åå°±å¯ä»¥å¼€å§‹ä»£é©¾äº†ï¼Œåˆ°è¾¾ç»ˆç‚¹åè®¡ç®—é‡‘é¢å¹¶ç”¨å¾®ä¿¡æ”¯ä»˜ï¼›æ­¤å¤–è¿˜æ¶‰åŠåˆ°ä¼˜æƒ åˆ¸ä¸šåŠ¡ï¼Œä¹Ÿå°±æ˜¯ä¼ ç»Ÿçš„é‚£å¥—ç§’æ€é€»è¾‘ï¼Œåˆ†å¸ƒå¼é”+luaè„šæœ¬é‚£äº›ã€‚\n## æŠ€æœ¯æ ˆ\n- SpringCloudAlibabaï¼šåŒ…æ‹¬nacosï¼Œopenfeignï¼Œgatewayè¿™äº›ï¼Œå…¶å®åç»­è¿˜å¯ä»¥åšä¸€äº›ç†”æ–­å’Œé™æµæ“ä½œã€‚\n- redisï¼šé¡¹ç›®ä¸­ä¸»è¦æ˜¯ç”¨åˆ°äº†geoæ•°æ®ç»“æ„ï¼Œåœ¨å¸æœºå¼€å¯æŠ¢å•çš„æ—¶å€™å°†åœ°ç†åæ ‡ä¸Šä¼ åˆ°redisï¼›æ­¤å¤–ä¹Ÿç”¨åˆ°äº†redissonå®ç°åˆ†å¸ƒå¼é”å’Œå»¶è¿Ÿé˜Ÿåˆ—ï¼ˆè¿™é‡Œçš„å»¶è¿Ÿé˜Ÿåˆ—å°±æ˜¯è¶…æ—¶15åˆ†é’Ÿè‡ªåŠ¨å–æ¶ˆï¼Œå…¶å®ä¹Ÿå¯ä»¥ç”¨rabbitmqå®ç°ï¼‰\n- xxl-jobï¼šé¡¹ç›®æœ€æ ¸å¿ƒçš„ä¸šåŠ¡æ˜¯é€šè¿‡xxl-jobå®ç°çš„ï¼Œæ¯æ¬¡ä¸‹å•å®¢æˆ·ç«¯éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ä»»åŠ¡è°ƒåº¦ï¼Œè¿™ä¸ªä»»åŠ¡å¯ä»¥å®šæ—¶å¯»æ‰¾å‘¨å›´å¸æœºã€‚\n- mongodbï¼šåœ¨ä»£é©¾è®¢å•è¿›è¡Œè¿‡ç¨‹ä¸­çš„åœ°ç†åæ ‡ä¸å¥½æ”¾åœ¨mysqlé‡Œé¢ï¼Œç”¨mongodbå­˜å‚¨åœ°ç†åæ ‡ï¼Œè€ƒè™‘äº†å…¶åœ¨å®æ—¶æ€§æ–¹é¢çš„ä¼˜åŒ–\n- rabbitmqï¼šå»¶è¿Ÿé˜Ÿåˆ—ï¼Œä¸šåŠ¡è§£è€¦å’Œæµé‡å‰Šå³°\n- Droolsï¼šç¬¬ä¸€æ¬¡å¬è¯´ï¼Œè§„åˆ™å¼•æ“ï¼Œå°±æ˜¯æŠŠä¸€äº›ä¸šåŠ¡è®¡ç®—é€»è¾‘æŠ½å–å‡ºæ¥ï¼Œä¸ç¡¬ç¼–ç åœ¨ç¨‹åºä¸­ï¼Œé¡¹ç›®ä¸­ç”¨è§„åˆ™å¼•æ“å®šä¹‰äº†è·¯ç¨‹å’Œè´¹ç”¨çš„è®¡ç®—ï¼Œè¿˜æœ‰æœ€åç®—é‡‘é¢ä¹Ÿç”¨åˆ°äº†è§„åˆ™å¼•æ“ï¼Œå®ƒæœ‰è‡ªå·±çš„ä¸€å¥—è¯­æ³•ã€‚\n- seataï¼šåˆ†å¸ƒå¼äº‹åŠ¡ï¼Œåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ä¸€ä¸ªäº‹åŠ¡çš„å›è°ƒæ˜¯æ— æ³•ç”¨@Transactionalè¿›è¡Œå›è°ƒçš„ï¼Œè¿™é‡Œå°±ç”¨äº†é˜¿é‡Œçš„è¿™ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡ä¸­é—´ä»¶å®Œæˆï¼Œç›®å‰è¿˜æ²¡æœ‰å¤ªäº†è§£è¿™ä¸ªï¼ŒåªçŸ¥é“å¯¼å…¥åŒ…åªä¼šåŠ ä¸€ä¸ªæ³¨é‡Šå°±èƒ½å®ŒæˆåŠŸèƒ½ã€‚\n- minioï¼šå­˜å‚¨ä¸Šä¼ ç…§ç‰‡å’ŒéŸ³é¢‘æ–‡ä»¶\n## é¡¹ç›®äº®ç‚¹\n- ä½¿ç”¨**aop+æ³¨è§£+threadlocal**çš„æ–¹å¼å®Œæˆç™»å½•çŠ¶æ€ä¿å­˜ï¼Œå¾®ä¿¡å°ç¨‹åºç™»å½•ï¼Œåšåˆ°äº†å¯¹ä¸šåŠ¡ä»£ç çš„é›¶å…¥ä¾µã€‚\n- åœ¨ä¸‹å•åç”¨**xxl-job**è¿›è¡Œä»»åŠ¡è°ƒåº¦ï¼Œå®šæ—¶æœç´¢å‘¨å›´å¸æœºï¼Œå¹¶åŸºäº**redisçš„geo**æ•°æ®ç»“æ„ï¼Œæé«˜é™„è¿‘å¸æœºçš„æœç´¢é€Ÿåº¦ï¼Œå®Œæˆå¸ä¹˜å¯¹æ¥ã€‚\n- ä¸ºäº†å‡å°mysqlè®¿é—®å‹åŠ›ä½¿ç”¨**mongodb**è®°å½•æ²¿é€”åœ°ç†åæ ‡ï¼Œå¹¶ä½¿ç”¨åŸºäº**rabbitmq**çš„å»¶è¿Ÿé˜Ÿåˆ—å°†å¤šæ¬¡å†™è¯·æ±‚åˆå¹¶ä¸ºä¸€æ¬¡å†™å…¥ï¼Œå†æ¬¡å‡å°äº†æ•°æ®åº“æ“ä½œã€‚\n- ä½¿ç”¨**ç­–ç•¥æ¨¡å¼å’Œè§„åˆ™å¼•æ“Drools**ï¼Œå®šä¹‰äº†ä¸šåŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­çš„å¤šç§æµç¨‹ï¼Œä¾‹å¦‚ä»£é©¾è´¹ç”¨è®¡ç®—ï¼Œå¸æœºç§¯åˆ†è®¡ç®—ä»¥åŠä¼˜æƒ å·æœ€å¤§ä¼˜æƒ ç­–ç•¥è®¡ç®—ã€‚\n- ä½¿ç”¨**Redissonåˆ†å¸ƒå¼é”**è§£å†³äº†é«˜å¹¶å‘åœºæ™¯ä¸‹çš„å¸æœºæŠ¢å•å’Œä¼˜æƒ å·è¶…å‘é—®é¢˜ï¼Œä½¿ç”¨Redissonæä¾›çš„**å»¶æ—¶é˜Ÿåˆ—**å®Œæˆäº†è®¢å•è¶…å‡ºæ—¶é—´é™åˆ¶åè‡ªåŠ¨å–æ¶ˆã€‚\n- ä½¿ç”¨**CompletableFuture**å®Œæˆäº†è®¢å•ç»“æŸæäº¤è¿‡ç¨‹çš„å¼‚æ­¥ç¼–æ’ï¼Œæé«˜äº†å“åº”æ•ˆç‡ï¼Œå¹¶ä½¿ç”¨**seata**æ¥ä¿è¯åˆ†å¸ƒå¼äº‹åŠ¡çš„æ‰§è¡Œã€‚\n## å¯ä»¥æœ‰å¢é‡çš„åœ°æ–¹\n- æ•°æ®åº“åˆ†åº“åˆ†è¡¨ï¼ŒShardingSphereå¯ä»¥å°è¯•ä¸€ä¸‹\n- äºŒçº§ç¼“å­˜ï¼Œæœ¬åœ°caffeineå’ŒredisäºŒçº§ç¼“å­˜\n- åšé™æµå’Œç†”æ–­ï¼Œä»¥åŠredisé›†ç¾¤å’Œå“¨å…µ\n- ç‚¹èµï¼ˆsetï¼‰ï¼Œè¯„è®ºï¼Œæ’è¡Œæ¦œï¼ˆzsetï¼‰ï¼Œç­¾åˆ°ï¼ˆbitmapï¼‰å’ŒUVç»Ÿè®¡ï¼ˆhyperloglogï¼‰éƒ½æ˜¯å¯ä»¥ç”¨redisè§£å†³çš„\n- kafka-streamè¿˜æ˜¯æ²¡èƒ½æ‰¾åˆ°åº”ç”¨çš„åœºæ™¯ï¼Œ\n- binlogå®ç°ä¸mysqlçš„æŒä¹…åŒ–\n- ä¼˜æƒ å·å…‘æ¢ç®—æ³•å’Œä¼˜æƒ å·çš„æœ€å¤§ä¼˜æƒ è®¡ç®—\n\n## ä¸šåŠ¡æµç¨‹\n\n### ä¹˜å®¢ç«¯ï¼š\n> ç™»å½•--é€‰æ‹©ä»£é©¾åœ°å€--å‘¼å«ä»£é©¾--ç­‰å¾…æ¥å•--15åˆ†é’Ÿæ²¡æœ‰å¸æœºæ¥å•è‡ªåŠ¨å–æ¶ˆ--15å†…æœ‰å¸æœºæ¥å•ï¼Œå¸ä¹˜åŒæ˜¾--è´¦å•æ”¯ä»˜\n1. ç™»å½•ï¼šå‰ç«¯é¦–å…ˆè°ƒç”¨wx.login()ï¼Œè¿”å›ä¸€ä¸²å­—ç¬¦ä¸²ï¼Œç„¶ååç«¯æ‹¿åˆ°è¿™ä¸ªå»è¯·æ±‚å¾®ä¿¡æœåŠ¡å™¨å¾—åˆ°å½“å‰ç™»å½•çš„openidï¼Œä¹Ÿå°±æ˜¯å¾®ä¿¡çš„å”¯ä¸€idï¼ˆå¯ä»¥ç†è§£ä¸ºwx.login()è¯·æ±‚å‘å‡ºä¹‹åï¼Œwxçš„ç¼“å­˜ä¸­å°±ä¿å­˜äº†è¿™ä¸ªé”®å€¼å¯¹ï¼Œé”®æ˜¯è¿™ä¸ªå­—ç¬¦ä¸²ï¼Œå€¼æ˜¯å½“å‰ç”¨æˆ·çš„ç»“æ„ï¼Œå¿…é¡»æ˜¯è¿è´¯çš„åŠ¨ä½œï¼Œå¯èƒ½è®¾ç½®äº†å¤±æ•ˆæ—¶é—´ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘åé¢æ‹¿postmanåŒæ ·è¯·æ±‚å¾—ä¸åˆ°çš„åŸå› ï¼‰\n2. é€‰æ‹©ä»£é©¾åœ°å€ï¼šç™¾åº¦åœ°å›¾çš„apiè¿”å›è·ç¦»å’Œæ—¶é—´ï¼Œè¿™ä¸ªå‚æ•°ç»™åç«¯è§„åˆ™å¼•æ“è®¡ç®—å‡ºè´¹ç”¨\n3. ç­‰å¾…æ¥å•ï¼šxxl-jobæ–°å¢ä¸€ä¸ªè®¢å•ä»»åŠ¡ï¼Œæ¯éš”ä¸€åˆ†é’Ÿæ ¹æ®redisçš„geoæœç´¢å‘¨å›´çš„æ±½è½¦ï¼Œç„¶ååœ¨é™„è¿‘å¼€å¯æ¥å•çš„æ±½è½¦çš„é˜Ÿåˆ—é‡Œé¢ï¼ˆé€šè¿‡redisçš„listå®ç°ï¼‰æ·»åŠ è¿™ä¸ªè®¢å•ã€‚\n4. 15åˆ†é’Ÿæ²¡æœ‰å¸æœºæ¥å•è‡ªåŠ¨å–æ¶ˆï¼šé€šè¿‡redissonå®ç°æˆ–è€…rabbitmqçš„å»¶è¿Ÿé˜Ÿåˆ—å®ç°\n5. 15å†…æœ‰å¸æœºæ¥å•ï¼Œå¸ä¹˜åŒæ˜¾ï¼šå½“å¸æœºæŠ¢åˆ°äº†è¯¥è®¢å•åï¼Œè®¢å•çŠ¶æ€æ”¹å˜ï¼Œè¿›å…¥å¸ä¹˜åŒæ˜¾æ¨¡å¼ï¼Œæ­¤ååŸºæœ¬ä¸Šæ²¡æœ‰ä¹˜å®¢ç«¯ä»€ä¹ˆäº‹æƒ…äº†ï¼Œå‰ç«¯ä¼šä¸€ç›´è½®è¯¢è®¢å•å½“å‰çŠ¶æ€ï¼Œå¹¶æ ¹æ®å¸æœºç«¯å­˜åœ¨mongodbä¸­çš„æ•°æ®è·å–è½¦çš„ä½ç½®ã€‚\n6. è´¦å•æ”¯ä»˜ï¼šå¾®ä¿¡æ”¯ä»˜\n### å¸æœºç«¯ï¼š\n> ç™»å½•--è®¤è¯--å¼€å§‹æ¥å•--æŠ¢å•--å¼€å§‹ä»£é©¾--ç”Ÿæˆè´¦å•ï¼Œå‘é€ä¹˜å®¢\n1. ç™»å½•ï¼šé€»è¾‘ç±»ä¼¼\n2. è®¤è¯ï¼šå¸æœºéœ€è¦ä¸Šä¼ èº«ä»½è¯é©¾é©¶è¯äººè„¸ç­‰ï¼Œé€šè¿‡è…¾è®¯äº‘ï¼Œæˆ‘æ‡’å¾—æ³¨å†Œè¿™éƒ¨åˆ†å°±è·³è¿‡äº†\n3. å¼€å§‹æ¥å•ï¼šå¼€å§‹æ¥å•åä¼šæŠŠå½“å‰çš„åæ ‡ä¸Šä¼ åˆ°redisï¼Œç„¶åæ¯éš”5sè¯¢é—®ä¸€æ¬¡å½“å‰é˜Ÿåˆ—çŠ¶æ€ï¼Œå½“xxl-jobæŠŠè®¢å•æ”¾åœ¨äº†è¯¥å¸æœºçš„é˜Ÿåˆ—é‡Œé¢ï¼Œå‰ç«¯å°±ä¼šæœ‰æ˜¾ç¤ºå¯ä»¥æŠ¢å•\n4. æŠ¢å•ï¼šåˆ†å¸ƒå¼é”ï¼Œæ— éœ€å¤šè¨€ï¼ŒæŠ¢å•ä¹‹åå°†è®¢å•çŠ¶æ€æ”¹å˜ï¼Œè¿™æ ·ä¹˜å®¢ç«¯è½®è¯¢è¿™ä¸ªè®¢å•çš„æ—¶å€™å°±ä¼šå‘ç°æœ‰å¸æœºå·²ç»æ¥å•äº†ã€‚\n5. åˆ°è¾¾ä¹˜å®¢æŒ‡å®šåœ°ç‚¹ï¼Œè¿™é‡Œä¼šæœ‰ä¸€ä¸ªåˆ·å•çš„æ ¡éªŒï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨è·ç¦»åœ°ç‚¹1kmä¹‹å†…æ‰èƒ½æœ‰æ•ˆ\n6. ä¸Šä¼ è½¦è¾†çŠ¶å†µå’Œè½¦ç‰Œå·ï¼šæ‹ç…§ä¸Šä¼ minio\n7. å¼€å§‹ä»£é©¾ï¼šæ¯éš”å‡ ç§’é’Ÿå°†å½“å‰çš„åæ ‡ä¸Šä¼ åˆ°mongodbä¸­ï¼Œå®ç°ä¸ä¹˜å®¢ç«¯åŒæ­¥æ˜¾ç¤ºã€‚\n8. ç”Ÿæˆè´¦å•ï¼šæ ¹æ®è§„åˆ™å¼•æ“åˆ†è´¦ï¼Œç„¶åæ¨é€å¾®ä¿¡æ”¯ä»˜ç»™ä¹˜å®¢ã€‚\n","tags":["Redis"]},{"title":"è®ºæ–‡ç²¾è¯»-DOMINANT","url":"/2024/07/11/è®ºæ–‡ç²¾è¯»-DOMINANT/","content":"<!-- TOC -->\n* [Deep Anomaly Detection on Attributed Networks](#deep-anomaly-detection-on-attributed-networks)\n  * [å›¾å·ç§¯ç¥ç»ç½‘ç»œ](#å›¾å·ç§¯ç¥ç»ç½‘ç»œ)\n  * [æ¨¡å‹æ¶æ„](#æ¨¡å‹æ¶æ„)\n  * [å¸¦å¸¦é”è¯„](#å¸¦å¸¦é”è¯„)\n<!-- TOC -->\n> å¼€å‘é¡¹ç›®è™½å¥½ï¼Œä½†æ˜¯è¿˜æ˜¯è¦æ¯•ä¸šçš„å˜›ï¼Œæ­£å¥½ä»Šå¤©åšå®Œäº†ç»„ä¼šæ±‡æŠ¥pptï¼Œè¶çƒ­æ‰“é“å†™ä¸€ç¯‡è¯»åæ„Ÿã€‚\n> \n> **2024-7-11ï¼Œæˆ‘ç ”ç©¶ç”Ÿç”Ÿæ¶¯çš„ç¬¬ä¸€ç¯‡è®ºæ–‡ï¼Œæˆ‘ä¼šè®°ä½ä½ çš„ã€‚**\n\n# Deep Anomaly Detection on Attributed Networks\n\n> åœ¨è¯´æ˜è¿™ç¯‡æ–‡ç« ä¹‹å‰ï¼Œé¦–å…ˆè¯´ä¸€ä¸‹å›¾å·ç§¯ç¥ç»ç½‘ç»œï¼ˆGSNï¼‰\n\n## å›¾å·ç§¯ç¥ç»ç½‘ç»œ\n\n&nbsp;&nbsp;å›¾æ˜¯ä¸€ç§æ•°æ®ç»“æ„ï¼Œç›¸æ¯”äºç¦»æ•£çš„ç‚¹ï¼Œæ›´å…·æœ‰ç‰¹å¾çš„æ˜¯è¾¹å¸¦æ¥çš„ç»“æ„ä¸Šçš„å…³ç³»ã€‚æ™®é€šçš„å·ç§¯ç¥ç»ç½‘ç»œå¤„ç†çš„ä¸»è¦æ˜¯ç»“æ„æ€§æ•°æ®ï¼Œç±»ä¼¼å›¾ç‰‡æˆ–è€…nlpä»»åŠ¡ï¼Œè¿™ä¸€ç±»ä»»åŠ¡çš„è¾“å…¥æ•°æ®æ˜¯æœ‰è¿¹å¯å¾ªçš„ï¼Œç»“æ„ä¸ä¼šå‘ç”Ÿå˜åŒ–ï¼Œå›¾ç‰‡å¯ä»¥æ‹†ä¸ºåƒç´ è¿›è¡Œå·ç§¯æ ¸æ“ä½œï¼Œnlpå¯ä»¥å°†è¯è¿›è¡Œè¯åµŒå…¥ã€‚\n\n&nbsp;&nbsp;è€Œå›¾ä¸ä¸€æ ·ï¼Œå›¾çš„æ‹“æ‰‘ç»“æ„æ˜¯æ— è¿¹å¯å¯»çš„ï¼Œè¿™ä¹Ÿæ„å‘³ç€æ™®é€šçš„cnnæ— æ³•æ»¡è¶³åœ¨å›¾ä¸Šçš„æœç´¢ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥å‚è€ƒcnnçš„å…¬å¼$Y=XW+B$ï¼Œç»“åˆå›¾çš„è§„å¾‹æ¢ç´¢å‡ºå›¾çš„å·ç§¯ç¥ç»ç½‘ç»œã€‚\n\n&nbsp;&nbsp;é¦–å…ˆæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªå›¾ï¼Œ$\\mathcal{G}=(\\mathcal{V},\\epsilon,X)$ï¼Œï¼ˆ1ï¼‰èŠ‚ç‚¹é›†åˆ$\\mathcal{V} = \\mathcal{v_1},\\mathcal{v_2},\\ldots,\\mathcal{v_n}$ï¼Œå…¶ä¸­$\\left|\\mathcal{V}\\right|=\\mathcal{n}$ ï¼ˆ2ï¼‰è¾¹é›†$\\epsilon$ï¼Œå…¶ä¸­$\\left|\\epsilon\\right|=\\mathcal{m}$ï¼ˆ3ï¼‰èŠ‚ç‚¹å±æ€§$\\mathrm{X}\\in\\Bbb{R}^{n \\times d}$,å…¶ä¸­ç¬¬iè¡Œå‘é‡$\\mathrm{x_i}\\in\\\\Bbb{R}^{d}\\(i=1,\\ldots,n\\)$è¡¨ç¤ºçš„æ˜¯ç¬¬iä¸ªèŠ‚ç‚¹çš„å±æ€§è¡¨ç¤ºï¼Œdæ˜¯å±æ€§çš„æ•°é‡ã€‚ä¸¾ä¾‹å¦‚ä¸‹ï¼š\n\n<div style=\"text-align: center;\">\n  <img src=\"../img/oodPaper/img_1.png\" alt=\"\" />\n</div>\n\n&nbsp;&nbsp;è¿™é‡Œä¸¾ä¾‹æ˜¯æœ‰æƒå›¾ï¼Œå¦‚æœæ˜¯æ— æƒå›¾é‚£å°±éƒ½ä¸º0æˆ–è€…1ï¼Œè¿™å¼ å›¾çš„é‚»æ¥çŸ©é˜µAä¸ºï¼š\n\n|    | v1 | v2 | v3 | v4 |\n|----|----|----|----|----|\n| v1 | 0  | 2  | 5  | 6  |\n| v2 | 2  | 0  | 0  | 0  |\n| v3 | 5  | 0  | 0  | 3  |\n| v4 | 6  | 0  | 3  | 0  |\n\n&nbsp;&nbsp;èŠ‚ç‚¹å±æ€§Hï¼Œæ¯”å¦‚è¿™å››ä¸ªç‚¹ä»£è¡¨ä¸€ä¸ªäººï¼Œå±æ€§å°±å¯èƒ½æ˜¯èº«é«˜ä½“é‡è¿™ç±»ï¼Œä¸¾ä¾‹å¦‚ä¸‹ï¼š\n\n|    | å§“å  | æ€§åˆ« | èº«é«˜  | ä½“é‡  |\n|----|-----|----|-----|-----|\n| H1 | 239 | 2  | 175 | 120 |\n| H2 | 542 | 1  | 168 | 100 |\n| H3 | 937 | 2  | 188 | 150 |\n| H4 | 365 | 1  | 163 | 90  |\n\n&nbsp;&nbsp;å¦‚æœæˆ‘ä»¬å–çŸ©é˜µä¸­çš„ä¸€è¡ŒA1ç‚¹ä¹˜Hï¼Œå³æœ‰ï¼š\n$$\nA_1 \\cdot H=\\(0 \\times H_1 +2 \\times H_2 +5 \\times H_3 + 6 \\times H_4\\)\n$$\n\n&nbsp;&nbsp;å¯ä»¥çœ‹å‡ºï¼Œè¿™ä¸ªç»“æœæ˜¯V1çš„é‚»å±…èŠ‚ç‚¹ä¿¡å·çš„åŠ æƒæ±‚å’Œï¼Œå…¶ä¸­æƒé‡ä¸ºå…³ç³»å¼ºå¼±æ•°å€¼ï¼Œç”±Aæä¾›ï¼Œä½†æ˜¯è¿™ä¸ªæƒé‡å¹¶æ²¡æœ‰è¿›è¡Œå½’ä¸€åŒ–ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæŸä¸ªèŠ‚ç‚¹çš„é‚»å±…é¡¶ç‚¹è¶Šå¤šï¼Œå…³ç³»æ•°å€¼è¶Šå¼ºï¼Œè¿™ä¸ªç»“æœå°±è¶Šå¤§ï¼Œä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬è¿›è¡Œäº†å½’ä¸€åŒ–æ“ä½œï¼Œå³ï¼Œè®©æƒé‡é™¤ä»¥è¯¥èŠ‚ç‚¹æ‰€æœ‰è¾¹çš„å…³ç³»æ•°å€¼çš„å’Œï¼Œä¸Šè¿™äº›è¾¹çš„å…³ç³»æ•°å€¼æˆä¸ºçœŸæ­£æ„ä¹‰ä¸Šå’Œä¸º1çš„â€œæƒå€¼â€ã€‚é‚£ä¹ˆæˆ‘ä»¬æ‰€éœ€è¦çš„æ•°å­¦è¿‡ç¨‹å³è®©Açš„æ¯ä¸€è¡Œéƒ½é™¤ä»¥è¯¥è¡Œçš„å’Œã€‚è¿™æ˜¯æˆ‘ä»¬å¼•å…¥ä¸€ä¸ªæ–°çš„çŸ©é˜µDï¼Œè¿™ä¸ªçŸ©é˜µä¸ºå¯¹è§’çŸ©é˜µï¼Œæ¯è¡Œå¯¹è§’çº¿ä¸Šçš„å…ƒç´ ä¸ºAçš„è¿™è¡Œçš„å…ƒç´ å’Œï¼Œä¹Ÿå°±æ˜¯è¯¥é¡¶ç‚¹çš„åº¦ã€‚\n\n&nbsp;&nbsp;DçŸ©é˜µï¼š\n\n| <!-- --> | <!-- --> | <!-- --> | <!-- --> |\n|----------|----------|----------|----------|\n| 13       | 0        | 0        | 0        |\n| 0        | 2        | 0        | 0        |\n| 0        | 0        | 8        | 0        |\n| 0        | 0        | 0        | 9        |\n\n&nbsp;&nbsp;æ¥ç€æ‰§è¡Œ$D^{-1}A$æ“ä½œï¼Œå³æŠŠAçš„æ¯ä¸ªå…³ç³»æ•°å€¼éƒ½å½’ä¸€åŒ–äº†ï¼Œå˜ä¸ºæƒé‡ï¼Œæœ€åä¸Hç›¸ä¹˜ï¼Œå½’ä¸€åŒ–åçš„è¡¨è¾¾å¼ä¸ºï¼š\n\n$$\nD_{1}^{-1}A_1 \\cdot H=\\(1/13\\) \\times \\(0 \\times H_1 +2 \\times H_2 +5 \\times H_3 + 6 \\times H_4\\)\n$$\n\n&nbsp;&nbsp;æ‰€æœ‰è¡Œéƒ½è¿›è¡ŒåŒæ ·çš„æ“ä½œï¼Œ$D^{-1}A \\times\\ H$ï¼Œåˆ™æ¯ä¸€è¡Œçš„é‡çº²éƒ½ä¸€æ ·äº†ï¼Œä¸ä¼šå‡ºç°æŸä¸€è¡Œè®¡ç®—ç»“æœç‰¹åˆ«å¤¸å¼ ã€‚æ­¤æ—¶æˆ‘ä»¬æ¥è€ƒè™‘è¿™ä¸ªç»“æœæ˜¯ä»€ä¹ˆï¼Œå®ƒç›¸å½“äºæ˜¯æŸä¸€ä¸ªé¡¶ç‚¹å‘¨å›´æ‰€æœ‰é¡¶ç‚¹çš„ä¿¡å·æŒ‰å…³ç³»ï¼ˆæƒé‡ï¼‰ç›¸åŠ ï¼ˆèšåˆï¼‰ï¼Œé‚£ä¹ˆè¿™ä¸ªç»“æœå°±èƒ½è¡¨å¾å‡ºå‘¨å›´èŠ‚ç‚¹å¯¹è‡ªå·±çš„å½±å“äº†ï¼ŒåŒæ—¶ç”±äºæ˜¯é€šè¿‡çŸ©é˜µè¿›è¡Œè¿ç®—ï¼Œæ•°æ®ç»“æ„å˜å¾—å¾ˆè§„æ•´ï¼Œå¯ä»¥ä½¿ç”¨è®¡ç®—æœºæ¥è¿ç®—ã€‚\n\n> åˆ°è¿™é‡Œä¸ºæ­¢æœ‰ä¸¤ä¸ªé—®é¢˜ï¼š\n> - é¦–å…ˆæ˜¯è‡ªèº«çš„å› ç´ æ²¡æœ‰è€ƒè™‘ï¼Œå°±å¦‚ä¸Šé¢çš„ä¾‹å­ï¼Œæ²¡æœ‰è€ƒè™‘åˆ°$H_1$çš„å½±å“ï¼Œä¹Ÿå°±æ˜¯è‡ªå·±ï¼Œè¿™æ˜¯å¾ˆä¸åˆç†çš„ï¼Œåœ¨ä¼ æ’­è¿‡ç¨‹ä¸­éœ€è¦æœ‰â€œæˆ‘â€çš„å‚ä¸ï¼Œè€Œä¸æ˜¯éƒ½æ˜¯å®¢ä½“ã€‚\n> - å…¶æ¬¡æ˜¯æ²¡æœ‰è€ƒè™‘åˆ°é‚»å±…çš„å½±å“ï¼Œå‡å¦‚æˆ‘çš„æœ‹å‹åªæœ‰ä¸€ä¸ªå¤§ä½¬ï¼Œé‚£ä¹ˆæˆ‘å’Œå¤§ä½¬çš„å…³ç³»ç½‘ç»œå¦‚æœç”¨å¹³å‡ç®—æ³•çš„è¯å°±ç­‰åŒäº†ï¼Œæ‰€ä»¥ç›´æ¥æŠŠBçš„ç‰¹å¾èµ‹ç»™Aè‚¯å®šæ˜¯ä¸åˆé€‚çš„ã€‚\n\n<div style=\"text-align: center;\">\n  <img src=\"../img/oodPaper/img_2.png\" alt=\"\" />\n</div>\n\n**é’ˆå¯¹ç¬¬ä¸€ä¸ªé—®é¢˜ï¼š**\næŠŠâ€œæˆ‘â€çš„ä¿¡æ¯åŠ è¿›å»\n$$\\tilde{A}=A+a \\cdot I$$\nè¿™æ ·Aå°±ä¸å†æ˜¯ä¸€ä¸ªå•ä½é˜µï¼Œåœ¨è¿›è¡ŒçŸ©é˜µè¿ç®—çš„æ—¶å€™å°±èƒ½è€ƒè™‘åˆ°è‡ªå·±çš„å› ç´ ï¼Œå› æ­¤Dä¹Ÿè¦éšä¹‹æ”¹å˜ï¼ŒDåŸæœ¬æ˜¯è¡¨ç¤ºå‡ºåº¦ï¼Œæ­¤æ—¶è¦å˜ä¸ºå‡ºåº¦+a\n$$\\tilde{D}=D+a \\cdot I$$\n\n**é’ˆå¯¹ç¬¬äºŒä¸ªé—®é¢˜ï¼š**\nå…³ç³»æ•°å€¼æˆ‘ä»¬ä¸€èˆ¬æ˜¯é€šè¿‡ä¸¤é¡¶ç‚¹ä¿¡å·ä¹‹é—´çš„æ¬§æ°è·ç¦»å¾—åˆ°çš„ï¼Œè¿™åªè·Ÿè¿™ä¸¤ä¸ªé¡¶ç‚¹æœ‰å…³ç³»ï¼Œä¸å…¶äºŒé˜¶é‚»å±…çš„ä¿¡å·æ˜¯æ— å…³çš„ï¼Œä½†æ˜¯æ˜¾ç„¶ï¼Œé‚»å±…çš„é‚»å±…å¯¹æˆ‘å½±å“åº”è¯¥ä¹Ÿæ˜¯æœ‰çš„ï¼Œæˆ‘ä»¬æ€æ ·æ‰èƒ½æŠŠäºŒé˜¶é‚»å±…çš„å½±å“è€ƒè™‘è¿›æ¥å‘¢ï¼Ÿ\n\næ¯”å¦‚ï¼Œæˆ‘å«V2ï¼Œæ˜¯ä¸ªè‡ªé—­ç—‡æ‚£è€…ï¼Œç­é‡Œä¸€å…±å››ä¸ªäººï¼Œæˆ‘ä»¬è‡ªå·±çš„ä¿¡å·ä¸ºç¤¾äº¤èƒ½åŠ›å€¼ï¼Œæˆ‘åªè®¤è¯†V1ï¼Œè®¤è¯†V1ä¹Ÿä¸æ˜¯å› ä¸ºæˆ‘å’Œä»–èŠå¾—æ¥ï¼Œçº¯çº¯æ˜¯å› ä¸ºV1æ˜¯ä¸ªç¤¾ç‰›ï¼Œ V1è°éƒ½è®¤è¯†ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå¦‚æœè€ƒè™‘V2ç»è¿‡ä¸€æ¬¡ä¼ æ’­åå½¢æˆçš„æ–°V2ï¼Œæ˜¯é€šè¿‡$\\tilde{D_2^{-1}}\\tilde{A_2}H$è®¡ç®—çš„ï¼Œç»“æœä¸º$\\tilde{D_2^{-1}}\\tilde{A_2}H$=(1/3)Ã—(2Ã—H1 + 1Ã—H2 + 0Ã—H3 + 0Ã—H4) =2/3 H1 + 1/3H2 ,å¯ä»¥çœ‹å‡ºï¼Œæ­¤æ—¶æ–°çš„V2çš„ä¿¡å·ç»å¤§éƒ¨åˆ†æ¥æºäºåŸæ¥V1çš„ä¿¡å·ï¼Œè¿™å½“ç„¶ä¸è¡Œï¼Œæ€ä¹ˆç»è¿‡ä¸€æ¬¡ä¼ æ’­åï¼ŒæŠŠæˆ‘ä¸€ä¸ªç¤¾æå˜æˆäº†ç¤¾ç‰›ï¼Œè¿™æ˜¾ç„¶ä¼ æ’­ä»ç„¶å­˜åœ¨é—®é¢˜ï¼Œæˆ‘å¸Œæœ›èƒ½æŠŠäºŒé˜¶é‚»å±…å’Œä¸€é˜¶é‚»å±…éƒ½è€ƒè™‘è¿›å»ï¼ŒäºŒé˜¶é‚»å±…å’Œä¸€é˜¶é‚»å±…æ•°é‡å·®åˆ«è¾ƒå¤§çš„æ—¶å€™ï¼Œæˆ‘å¸Œæœ›èƒ½è¡°å‡è¿™ç§å½±å“ï¼Œå°½å¯èƒ½è®©è‡ªå·±çš„ä¿¡å·å’Œåˆ«äººçš„ä¿¡å·å°½å¯èƒ½çš„åˆ†å¼€æ¥ï¼Œé‚£ä¹ˆå°±å®¹æ˜“å¾—åˆ°ä¸¤ç§æ€è·¯äº†ï¼Œä¸€æ˜¯ä¼ æ’­ä¸­æˆ‘å°½å¯èƒ½ä¿ç•™è‡ªå·±çš„æƒé‡ï¼Œå‰Šå‡åˆ«äººçš„æƒé‡ï¼Œå³$\\tilde{A}$å¯¹åšå¤„ç†ï¼Œç¬¬äºŒæ˜¯è®©â€œæˆ‘â€çš„ä¿¡å·æ ¹æ®ä¼ æ’­äº§ç”ŸæŸç§çº¿æ€§å˜åŒ–ï¼Œå³éšç€äºŒé˜¶é‚»å±…å’Œä¸€é˜¶é‚»å±…æ•°é‡å·®åˆ«è¶Šå¤§æˆ‘ä¿¡å·è¶Šå°ï¼Œè¿™æ ·ä¹Ÿå¯ä»¥æŠŠæˆ‘å’Œåˆ«äººåŒºåˆ†å‡ºæ¥ï¼Œä¹Ÿå¯ä»¥æœ‰æˆ‘è‡ªå·±å•ç‹¬çš„ç‰¹å¾ï¼Œå°±æ˜¯ä¿¡å·ç‰¹åˆ«å°å˜›ã€‚GCNä¸­æ˜¯æŒ‰ç…§ç¬¬äºŒä¸ªæ€è·¯æ¥çš„ï¼Œåœ¨æ•°å­¦ä¸Šæ–°çš„ä¼ æ’­è¿‡ç¨‹è¡¨ç¤ºä¸ºï¼š\n\n$$\n\\tilde{D^{-\\frac{1}{2}}}\\tilde{A}\\tilde{D^{-\\frac{1}{2}}}H\n$$\nä¸ºä»€ä¹ˆæ˜¯å¼€æ ¹å·ï¼Œå› ä¸ºåœ¨è¡°å‡çš„æ—¶å€™è¿˜æ˜¯è¦å°½é‡æ»¡è¶³å½’ä¸€åŒ–ã€‚å¯ä»¥çœ‹ä½œå¯¹$\\tilde{A_{i,j}}$åšäº†å¦‚ä¸‹æ“ä½œï¼š\n\n$$\n\\tilde{A_{ij}} = \\frac{A_{ij}}{\\sqrt{D_{ii}} \\sqrt{D_{jj}}}\n$$\n\nè¿™æ ·ï¼Œå½“ä¸€é˜¶é‚»å±…é¡¶ç‚¹jçš„åº¦ï¼ˆè¾¹æ•°é‡ï¼Œä¹Ÿå°±æ˜¯å®ƒçš„ä¸€é˜¶é‚»å±…æ•°é‡ï¼‰å¾ˆå¤§ï¼Œé‚£ä¹ˆä¼ æ’­ä¸€æ¬¡åä¿¡å·å°±ä¼šå˜å¾—å¾ˆå°ï¼Œæ¯”å¦‚å¯¹V2æ¥è®²ï¼š\n\n$$\n\\tilde{D_{22}^{-\\frac{1}{2}}}\\tilde{A_2}\\tilde{D_{11}^{-\\frac{1}{2}}}H=\\frac{1}{\\sqrt{3} \\sqrt{14}}\\(2H_1+H_2\\)\n$$\n\næœ€åå†é€šè¿‡ä¸€ä¸ªæ¿€æ´»å‡½æ•°ï¼Œä»¥åŠä¸€ä¸ªé˜ˆå€¼bï¼Œå°±å¯ä»¥ç±»ä¼¼cnnå¾—åˆ°ä¸€ä¸ªå‰å‘ä¼ æ’­å…¬å¼ï¼š\n\n$$\nH^{l+1}=\\sigma \\(\\tilde{D^{-\\frac{1}{2}}}\\tilde{A}\\tilde{D^{-\\frac{1}{2}}}H^{l}W^{l}+b^{l}\\)\n$$\n\nå…¶ä¸­$\\tilde{D^{-\\frac{1}{2}}}\\tilde{A}\\tilde{D^{-\\frac{1}{2}}}$æ˜¯å›ºå®šä¸å˜çš„ï¼Œå…¶ä½™çš„å·¥ä½œå°±æ˜¯æ„å»ºå…¨è¿æ¥å±‚ï¼ŒæŸå¤±å‡½æ•°ï¼Œåå‘ä¼ æ’­ï¼Œæ›´æ–°å‚æ•°ã€‚\n\n## æ¨¡å‹æ¶æ„\n\nå‰é¢é“ºå«äº†è¿™ä¹ˆå¤šï¼Œé‚£ä¹ˆè¿™ä¸ªæ¨¡å‹æ˜¯ä»€ä¹ˆå‘¢ï¼Œè¯´ç™½äº†å°±æ˜¯ç±»ä¼¼transformerçš„ç¼–ç å™¨è§£ç å™¨ï¼ŒåŸºäºé‡æ„çš„æ–¹æ³•ã€‚\n\n<div style=\"text-align: center;\">\n  <img src=\"../img/oodPaper/img_3.png\" alt=\"\" />\n</div>\n\n- ç¼–ç å™¨ï¼šå°†è¾“å…¥çš„å±æ€§çŸ©é˜µé€šè¿‡å‰é¢æ‰€è¿°çš„å›¾å·ç§¯ç¥ç»ç½‘ç»œæå–ç‰¹å¾ï¼Œå¾—åˆ°äº†ä¸€ä¸ªæ‚ç³…å±æ€§å’Œç»“æ„å…³ç³»çš„ä½ç»´å‘é‡è¡¨ç¤ºã€‚\n- è§£ç å™¨ï¼šæ ¹æ®è¿™ä¸ªå¾—åˆ°çš„ä¸­é—´è¡¨ç¤º**é‡æ„**ï¼Œç»“æ„é€šè¿‡ç»“æ„è§£ç å™¨è¿›è¡Œé‡æ„ï¼Œå±æ€§é€šè¿‡å±æ€§ç¼–ç å™¨è¿›è¡Œé‡æ„ã€‚ç„¶åè®¡ç®—é‡æ„ç»“æœä¸å®é™…ç»“æœï¼Œå®ŒæˆæŸå¤±å‡½æ•°æœ€å°åŒ–ã€‚åŸæ–‡è¿™é‡Œçš„ç»“æ„è§£ç å™¨éå¸¸ç®€å•æš´åŠ›ï¼Œå°±ç”¨ä¸­é—´ä½ç»´ç‰¹å¾æå–çš„å†…ç§¯å®Œæˆï¼Œ$\\sigma\\(Z\\*Z^{T}\\)$ï¼Œå±æ€§ç”¨å¦ä¸€å±‚GSNè¿›è¡Œæ˜ å°„ã€‚\n\n**é‚£ä¹ˆæ˜¯æ€ä¹ˆåˆ¤æ–­å‡ºå¼‚å¸¸çš„ï¼Ÿ**\n\né€šè¿‡ä»¥ä¸Šæ­¥éª¤é‡å»ºæ‹“æ‰‘ç½‘ç»œç»“æ„ï¼Œå°†ç»“æ„å’Œå±æ€§çš„é‡æ„è¯¯å·®å…±åŒå­¦ä¹ ï¼Œå¯ä»¥è¡¨ç¤ºä¸ºï¼š\n$$\n\\mathcal{L}=(1-\\alpha)R_S+\\alpha R_A=(1-\\alpha){\\Vert A-\\hat{A} \\Vert}_F^2+\\alpha {\\Vert X-\\hat{X} \\Vert}_F^2\n$$\nå¼ä¸­ï¼Œæ˜¯ç”¨æ¥å¹³è¡¡ç»“æ„é‡å»ºå’Œå±æ€§é‡å»ºå½±å“çš„ä¸€ä¸ªé‡è¦å‚æ•°ã€‚\n\né€šè¿‡æœ€å°åŒ–ç›®æ ‡å‡½æ•°ï¼Œè‡ªç¼–ç å™¨å¯ä»¥åŸºäºç¼–ç çš„æ½œåœ¨è¡¨ç¤ºè¿­ä»£åœ°è¿‘ä¼¼è¾“å…¥çš„å±æ€§ç½‘ç»œï¼Œç›´è‡³æ”¶æ•›ã€‚æœ€åï¼Œä½¿ç”¨ä¸¤é¡¹é‡æ„è¯¯å·®ä¹‹å’Œæ¥è¯„ä¼°èŠ‚ç‚¹çš„å¼‚å¸¸æ€§ã€‚ ä¹Ÿå°±æ˜¯ï¼Œå¾—åˆ†è¶Šé«˜çš„å®ä¾‹è¶Šæ˜¯è¢«è®¤ä¸ºå¼‚å¸¸ã€‚å†ç”±è¯¥åˆ†æ•°æ¥è®¡ç®—å±æ€§ç½‘ç»œçš„å¼‚å¸¸æ’å\n\n## å¸¦å¸¦é”è¯„\n\n- ä¼˜ç‚¹ï¼šç»“æ„æ–°é¢–ï¼ŒåŸºäºå›¾å·ç§¯ç¥ç»ç½‘ç»œï¼Œç‰¹å¾æå–è€ƒè™‘äº†ç»“æ„å’Œç‚¹å±æ€§ä¸¤æ–¹é¢ç‰¹å¾ï¼Œæ›´èƒ½æ£€æµ‹å‡ºå¼‚å¸¸ï¼Œå¯¹ç¨€ç–å›¾æ•°æ®çš„å¤„ç†æœ‰ä¼˜åŠ¿ã€‚\n- ç¼ºç‚¹ï¼šé‡æ„æœ¬èº«å…·æœ‰ä¸€å®šçš„å±€é™æ€§ï¼Œåªé€‚ç”¨äºå¼‚å¸¸æ•°æ®å æ¯”æ¯”è¾ƒå°çš„æ•°æ®é›†è¿›è¡Œè®­ç»ƒï¼Œå¦åˆ™é€šè¿‡é‡æ„æ–¹æ³•åçš„è¯¯å·®è¾ƒå¤§ï¼Œè¿˜æœ‰å‰æ–‡æ‰€è¯´çš„è§£ç å™¨æ„é€ æœ‰ä¸€ç‚¹æš´åŠ›äº†ï¼Œå› ä¸ºZä¸æ­¢æœ‰ç»“æ„è¿˜æœ‰å±æ€§ï¼Œç›´æ¥å†…ç§¯ä¼šæœ‰å¹²æ‰°ï¼Œæ”¹è¿›æªæ–½åº”è¯¥å¯ä»¥å‰”é™¤è¿™éƒ¨åˆ†å› ç´ è¿›è¡Œå•çº¯çš„ç»“æ„é‡æ„ã€‚\n","tags":["ç§‘ç ”è®ºæ–‡"]},{"title":"redisé¡¹ç›®-elasticsearchä¸mongodb","url":"/2024/06/11/redisé¡¹ç›®-elasticsearchä¸mongodb/","content":"\n> å…¶å®è¿™ä¸ªæœç´¢çš„åŠŸèƒ½åå€’è·Ÿredisæ²¡å•¥å…³ç³»äº†ï¼Œæ‰€ä»¥æˆ‘ä¹Ÿæ²¡å½’ç±»åœ¨redisé‡Œã€‚åŸºäºesçš„æœç´¢ä¹Ÿä¸æ— éæ˜¯å¢åˆ æ”¹æŸ¥ï¼Œå…ˆç®€å•è¯´ä¸€ä¸‹é¡¹ç›®é‡Œç”¨åˆ°çš„è¿™ä¸¤ä¸ªåŠŸèƒ½å’Œapiã€‚åç»­æˆ‘ä¼šè¯¦ç»†å­¦ä¹ \n\n## elasticsearch\n\nesæ˜¯ä¸€ä¸ªæœç´¢å™¨ï¼Œå…·ä½“æ€ä¹ˆæœçš„æˆ‘ä¸çŸ¥é“ï¼ˆç¬‘ï¼‰ã€‚ç›®å‰çš„ç†è§£æ˜¯åœ¨æ–°å¢blogçš„æ—¶å€™åŒæ—¶æŠŠè¿™ä¸ªå¯¹è±¡ç»™esæœåŠ¡å™¨ï¼Œå®ƒé€šè¿‡ç´¢å¼•çš„æ–¹å¼è¿›è¡Œç¼“å­˜ã€‚åç»­æŸ¥æ‰¾çš„æ—¶å€™å°±å¯ä»¥æ ¹æ®fieldï¼Œä¹Ÿå°±æ˜¯å­—æ®µåæ¥æŒ‡å®šåŒ¹é…ä½ç½®ã€‚\n\næ¯”å¦‚è¿™é‡Œè¦æœç´¢æ–‡ç« æ ‡é¢˜çš„å…³é”®å­—ï¼Œå°±ç”¨titleï¼›å¦‚æœæ˜¯å†…å®¹çš„ï¼Œå°±ç”¨contentã€‚ç»è¿‡æˆ‘çš„å®éªŒå‘ç°é»‘é©¬ç»™çš„åˆ†è¯å™¨åªèƒ½æ£€ç´¢ä¸­æ–‡ï¼Œæˆ‘æƒ³è¦æœç´ å­—æ¯â€œsâ€ï¼Œéƒ½æœä¸åˆ°ã€‚\n\né¡¹ç›®é‡Œçš„åº”ç”¨ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯ä¸Šè¿°çš„å…³é”®å­—æœç´¢ï¼Œç„¶åè¿”å›å‰ç«¯çš„æ—¶å€™è¦æ ‡çº¢ï¼Œè¿™ä¸ªæ­¥éª¤æ˜¯é€šè¿‡åœ¨å‰ååŠ fontæ ‡ç­¾å®Œæˆçš„ã€‚\n\né¦–å…ˆæ˜¯é…ç½®ï¼š\n\nè¿™é‡Œç”¨åˆ°çš„å¯¹è±¡æ˜¯RestHighLevelClientï¼Œæˆ‘ä»¬åªéœ€è¦é…ç½®ç«¯å£å·å’Œipå°±å¯ä»¥äº†ï¼Œè¿™ä¸ªå®¢æˆ·ç«¯ä¼šä½¿ç”¨esçš„restfulç«¯å£è¿›è¡Œå¢åˆ æ”¹æŸ¥ã€‚\n\næˆ‘ä»¬å¯¹å…¶çš„å¢åˆ æ”¹æŸ¥æ“ä½œå°±è·Ÿredistemplateä¸€æ ·çš„ã€‚\n\n```java\n@Configuration\npublic class ElasticSearchConfig {\n    @Value(\"${elasticsearch.host}\")\n    private String host;\n    @Value(\"${elasticsearch.port}\")\n    private Integer port;\n    /**\n     * é…ç½®RestHighLevelClientå¯¹è±¡\n     * å°†è¯¥å¯¹è±¡äº¤ç»™Springå®¹å™¨å»ç®¡ç†\n     *\n     * @return RestHighLevelClientå¯¹è±¡\n     */\n    @Bean\n    public RestHighLevelClient restHighLevelClient() {\n        return new RestHighLevelClient(\n                RestClient.builder(\n                        //è‹¥æœ‰å¤šä¸ªï¼Œå¯ä»¥ä¼ ä¸€ä¸ªæ•°ç»„\n                        new HttpHost(host, port, \"http\")));\n    }\n}\n```\n\nç”¨è¿™ä¸ªRestHighLevelClientï¼Œä¼ è¾“çš„æ˜¯ä¸€ä¸ªhttprequestï¼Œè¿”å›çš„æ˜¯responseã€‚æ€è·¯æ˜¯åˆ›å»ºä¸€ä¸ªrequestï¼ŒæŸ¥è¯¢æ ‡é¢˜å’Œå†…å®¹ä¸¤ä¸ªæ–¹é¢çš„å…³é”®è¯ã€‚\nè¿”å›ä»¥åè¿›è¡Œä¸€ä¸ªè½¬æ¢ï¼Œè¿”å›çš„åŠ ä¸Šé¢œè‰²æ ‡ç­¾çš„hitsæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œéœ€è¦è½¬æ¢æˆå­—ç¬¦ä¸²ã€‚æœ€åå‘å‰ç«¯è¿”å›è¿™ä¸ªå­—ç¬¦ä¸²ã€‚\n\n```java\n@Override\npublic Result searchBlog(QueryBlogDto dto) throws IOException {\n    //1.è¾“å…¥æ ¡éªŒ\n    if (dto == null){\n        return Result.fail(\"è¾“å…¥ä¸ºç©º\");\n    }\n    if (dto.getKeyWord() == null || dto.getKeyWord().isEmpty()){\n        return Result.fail(\"è¾“å…¥å…³é”®è¯ä¸ºç©º\");\n    }\n    //å¼‚æ­¥ç»™mongo\n    insertSearchHistory(dto.getKeyWord());\n\n    //2.æŸ¥è¯¢æ¡ä»¶\n    SearchRequest searchRequest = new SearchRequest(\"hmdp_blogs\");\n    SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder();\n\n    //2.1å¸ƒå°”ç±»å‹çš„æŸ¥è¯¢\n    BoolQueryBuilder builder = QueryBuilders.boolQuery();\n\n    //2.2 æŸ¥è¯¢æ ‡é¢˜å’Œå†…å®¹ä¸¤æ–¹é¢çš„å…³é”®è¯\n    QueryStringQueryBuilder queryStringQueryBuilder = QueryBuilders.queryStringQuery(dto.getKeyWord()).field(\"content\").field(\"title\").defaultOperator(Operator.OR);\n    builder.must(queryStringQueryBuilder);\n\n    //2.3 æ–‡æœ¬é«˜äº®è¿™ä¸ªæŸ¥æ‰¾åˆ°çš„å…³é”®å­—\n    HighlightBuilder highlightBuilder = new HighlightBuilder();\n    highlightBuilder.field(\"title\");\n    highlightBuilder.field(\"content\");\n    //2.3.1 æ ‡çº¢\n    highlightBuilder.preTags(\"<font style='color: red; font-size: inherit;'>\");\n    highlightBuilder.postTags(\"</font>\");\n    searchSourceBuilder.highlighter(highlightBuilder);\n\n    //2.4 ä¼ ç»™searchRequest\n    searchSourceBuilder.query(builder);\n    searchRequest.source(searchSourceBuilder);\n\n    //2.5 åŒ…è£…å¥½äº†çš„requestç»™å®¢æˆ·ç«¯è¿”å›\n    SearchResponse response = restHighLevelClient.search(searchRequest, RequestOptions.DEFAULT);\n\n    //3 å¤„ç†æ¶ˆæ¯å›åº”ï¼Œä¸€ä¸ªgethitsæ˜¯ä¸€ä¸ªç±»ï¼Œè¦è·å–è¿™ä¸ªæ•°ç»„éœ€è¦åœ¨è¿™ä¸ªåŒ…è£…ç±»é‡Œé¢å†è·å–ã€‚\n    SearchHit[] hits = response.getHits().getHits();\n    List<Map> list = new ArrayList<>();\n    for (SearchHit hit : hits){\n        String json = hit.getSourceAsString();\n        Map map = JSONUtil.toBean(json, Map.class);\n        Map<String, HighlightField> highlightFields = hit.getHighlightFields();\n        if (highlightFields != null){\n            HighlightField title = highlightFields.get(\"title\");\n            HighlightField content = highlightFields.get(\"content\");\n            if (title != null){\n                //titleé«˜äº®\n                Text[] titleFragments = title.getFragments();\n                String collect = Arrays.stream(titleFragments).map((value) -> value.toString()).collect(Collectors.joining());\n                map.put(\"title\",collect);\n            }\n            if (content != null){\n                //contenté«˜äº®\n                Text[] contentFragments = content.getFragments();\n                String collect = Arrays.stream(contentFragments).map((value) -> value.toString()).collect(Collectors.joining());\n                map.put(\"content\",collect);\n            }\n        }\n\n        list.add(map);\n    }\n    return Result.ok(list);\n}\n```\n\n## mongodb\n\nç™»å½•ç”¨æˆ·çš„æŸ¥è¯¢è®°å½•å¾ˆå¤šè€Œä¸”å˜åŒ–é¢‘ç¹ã€‚éœ€è¦ç”¨éå…³ç³»å‹æ•°æ®åº“æ¥å­˜å‚¨ã€‚ï¼ˆå…¶å®æˆ‘ä¸ªäººè§‰å¾—æ²¡å¿…è¦å­˜åœ¨æœåŠ¡å™¨ä¸Šï¼Œè¿™äº›ç¼“å­˜åº”è¯¥éƒ½æ˜¯åœ¨å®¢æˆ·ç«¯ä¸Šä¿ç•™çš„ï¼‰\n\nmongodbçš„é…ç½®æ¯”è¾ƒç®€å•ï¼Œç”šè‡³ä¸ç”¨å†™é…ç½®ç±»ã€‚ç›´æ¥çœ‹ä½¿ç”¨\n\n```java\n/**\n * ä¿å­˜æœç´¢è®°å½•\n * @param keyWord\n */\n@Async\npublic void insertSearchHistory(String keyWord){\n\n    Long userID = UserHolder.getUser().getId();\n    //1 å…ˆä»dbæ‰¾è¿™ä¸ªæ•°æ®\n    Query query = Query.query(Criteria.where(\"userId\").is(userID).and(\"keyWord\").is(keyWord));\n    QueryBlogDto searchHistory = mongoTemplate.findOne(query, QueryBlogDto.class);\n    //2 å¦‚æœåˆå°±æ›´æ–°åˆ›å»ºæ—¶é—´\n    if (searchHistory != null){\n        searchHistory.setCreateTime(new Date());\n    }\n    //3 æ²¡æœ‰å°±å­˜è¿›db\n    QueryBlogDto dto = new QueryBlogDto();\n    dto.setCreateTime(new Date());\n    dto.setUserId(userID);\n    dto.setKeyWord(keyWord);\n\n    Query query1 = Query.query(Criteria.where(\"userId\").is(userID))\n            .with(Sort.by(Sort.Direction.DESC,\"createTime\"));\n    List<QueryBlogDto> dtos = mongoTemplate.find(query1, QueryBlogDto.class);\n    //3.1 å¦‚æœæ•°é‡å°‘äº10æ¡å°±ç›´æ¥å­˜\n    if (dtos.size() < 10){\n        mongoTemplate.save(dto);\n    }\n    //3.2 å¦‚æœå¤šä½™10å°±è¦æ›¿æ¢äº†\n    else {\n        QueryBlogDto last = dtos.get(dtos.size() - 1);\n        mongoTemplate.findAndReplace(Query.query(Criteria.where(\"keyWord\").is(last.getKeyWord())),dto);\n    }\n\n}\n\n```\n\nå€¼å¾—æ³¨æ„çš„æ˜¯è¿™é‡Œä½¿ç”¨äº†@Asyncï¼Œgptç»™æˆ‘çš„ç­”æ¡ˆæ˜¯è¿™ä¸ªè·Ÿä½ æ–°å¼€ä¸€ä¸ªçº¿ç¨‹æ²¡æœ‰åŒºåˆ«ï¼Œä½†æ˜¯æ³¨æ„è¦åœ¨å¯åŠ¨ç±»ä¸Šenableã€‚è¿™é‡Œqueryæ›´åƒlambdaQueryWrapperé‚£ç§ã€‚å…·ä½“çš„å¢åˆ æ”¹æŸ¥è¯­æ³•ä»¥åå†å­¦ã€‚\n","tags":["Java"]},{"title":"redisé¡¹ç›®-kafkaStreamæ”¹é€ ","url":"/2024/06/07/redisé¡¹ç›®-kafkaStreamæ”¹é€ /","content":"> æƒ³åˆ°ä¹‹å‰åœ¨é»‘é©¬å¤´æ¡çœ‹åˆ°çš„æµå¼å®æ—¶æ›´æ–°æ’è¡Œï¼Œé‚æƒ³ç”¨åœ¨è¿™ä¸ªé¡¹ç›®é‡Œã€‚\n\nç›®æ ‡æ˜¯å®æ—¶è®¡ç®—æ¯ä¸€æ¡åšå®¢çš„è¯„è®ºæ•°ï¼Œç‚¹èµæ•°ï¼Œè¿˜æœ‰æµè§ˆæ•°æ”¶è—æ•°æ¥è®¡ç®—åˆ†æ•°ï¼Œæ›´æ–°åœ¨redisä¸Šï¼Œredisä½¿ç”¨zsetå®Œæˆæ’åºã€‚\n\nTodoï¼šå…¶å®å¯ä»¥åˆ†ç¦»ï¼Œç‚¹èµè¯„è®ºè¿™ä¸€ç³»åˆ—æ•°æ®å¯ä»¥æ”¾åœ¨mongodbé‡Œé¢ï¼Œä¸ç”¨å†™åœ¨sqlä¸­ï¼Œåç»­æ”¹é€ è¿™éƒ¨åˆ†å†…å®¹ã€‚\n\n## HyperLogLog\n\næµè§ˆé‡æƒ³ç”¨redisçš„è¿™ä¸ªhyperloglogå®ç°ï¼Œç›®å‰å­¦çš„æ¯”è¾ƒè‚¤æµ…ï¼Œè¿™é‡Œåªæ˜¯æŠŠå®ƒå½“ä½œä¸€ä¸ªæœ‰æ¦‚ç‡ä¸¢å¤±ä½†å®¹é‡å¾ˆå¤§å¹¶ä¸”å¾ˆé«˜æ•ˆçš„setã€‚ä¸»è¦ç”¨stringRedisTemplate.opsForHyperLogLog()ä¸­çš„sizeå’Œaddï¼Œå¾ˆç®€å•å‰è€…æ˜¯æœ‰å¤šå°‘ä¸ªï¼Œåè€…æ˜¯æ·»åŠ \n\n## KafkaStreamå®ç°å•è¯ç»Ÿè®¡\n\nå…ˆä»é…ç½®è¯´èµ·ï¼Œhostsä¸kafkaæœ¬èº«æ˜¯ä¸€è‡´çš„ï¼ŒAPPLICATION_ID_CONFIGè¡¨ç¤ºçš„æ˜¯streamçš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼ŒKafka Streamsåˆ©ç”¨è¿™ä¸ªIDæ¥åˆ›å»ºä¸€ä¸ªå†…éƒ¨çš„æ¶ˆè´¹ç»„ï¼Œè·Ÿè¸ªå¤„ç†çš„åç§»é‡ï¼Œå¹¶ç”Ÿæˆåº”ç”¨çš„çŠ¶æ€å­˜å‚¨ã€‚\n\nCLIENT_ID_CONFIGæ˜¯è·Ÿè¸ªæ¶ˆè´¹è€…çš„ç½‘ç»œçŠ¶æ€çš„å®¢æˆ·ç«¯ç»„\n\nå¤šä¸ª CLIENT_ID_CONFIG å¯ä»¥å¯¹åº”ä¸€ä¸ª APPLICATION_ID_CONFIGï¼Œè¿™ç§é…ç½®å…è®¸åœ¨ä¸€ä¸ªKafka Streamsåº”ç”¨ä¸­ï¼Œç»†ç²’åº¦åœ°æ§åˆ¶å’Œç›‘æ§ä¸åŒçš„å®¢æˆ·ç«¯å®ä¾‹æˆ–ä»»åŠ¡ã€‚è¿™å¯¹äºå¤§å‹ã€å¤æ‚çš„åº”ç”¨å°¤å…¶æœ‰ç”¨ï¼Œä½¿å¾—åœ¨ç›‘æ§å’Œè°ƒè¯•ä¸­å¯ä»¥ç²¾ç¡®å®šä½é—®é¢˜å’Œåˆ†ææ€§èƒ½ã€‚\n- APPLICATION_ID_CONFIG å®šä¹‰äº†Kafka Streamsåº”ç”¨çš„å…¨å±€æ ‡è¯†ï¼Œå½±å“æ•´ä¸ªåº”ç”¨çš„è¡Œä¸ºã€çŠ¶æ€ç®¡ç†å’Œæ•°æ®åˆ†åŒºå¤„ç†ã€‚\n- CLIENT_ID_CONFIG åˆ™ç”¨äºæ ‡è¯†å…·ä½“çš„å®¢æˆ·ç«¯å®ä¾‹æˆ–ä»»åŠ¡ï¼Œä¾¿äºç›‘æ§ã€æ—¥å¿—å’Œè°ƒè¯•ã€‚\nè¿™ç§é…ç½®æ–¹å¼å¢å¼ºäº†åº”ç”¨çš„çµæ´»æ€§å’Œå¯ç®¡ç†æ€§ï¼Œä½¿å¾—åœ¨å¤æ‚çš„æµå¤„ç†åœºæ™¯ä¸­ï¼Œèƒ½å¤Ÿæ›´æœ‰æ•ˆåœ°è·Ÿè¸ªå’Œä¼˜åŒ–æ¯ä¸ªç»„ä»¶çš„è¡¨ç°ã€‚\n\n\nè¿™é‡Œæˆ‘ä»¬åªæœ‰å¾ˆç®€å•çš„åº”ç”¨ï¼Œç›´æ¥å°±æ˜¯ä¸€å¯¹ä¸€\n```java\n@ConfigurationProperties(prefix = \"kafka\")\n@Configuration\n@EnableKafkaStreams\n@Data\npublic class KafkaStreamConfig {\n    private static final int MAX_MESSAGE_SIZE = 16*1024*1024;\n    private String hosts;\n    private String group;\n\n    @Bean(name = KafkaStreamsDefaultConfiguration.DEFAULT_STREAMS_CONFIG_BEAN_NAME)\n    public KafkaStreamsConfiguration defaultKafkaStreamsConfig(){\n        Map<String, Object> props = new HashMap<>();\n        //ipåœ°å€å’Œç«¯å£å·\n        props.put(StreamsConfig.BOOTSTRAP_SERVERS_CONFIG, hosts);\n        //å…¨å±€æ ‡è¯†\n        props.put(StreamsConfig.APPLICATION_ID_CONFIG, this.getGroup()+\"_stream_aid\");\n        //å®¢æˆ·ç«¯æ ‡è¯†\n        props.put(StreamsConfig.CLIENT_ID_CONFIG, this.getGroup()+\"_stream_cid\");\n        props.put(StreamsConfig.RETRIES_CONFIG, 10);\n        //keyçš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–éƒ½ä¸ºstring\n        props.put(StreamsConfig.DEFAULT_KEY_SERDE_CLASS_CONFIG, Serdes.String().getClass());\n        //valueï¼Œä¹Ÿå°±æ˜¯è¯´é”®å€¼å¯¹éƒ½å¾—æ˜¯Stringçš„ï¼Œåé¢æœ‰å‘ç‚¹\n        props.put(StreamsConfig.DEFAULT_VALUE_SERDE_CLASS_CONFIG, Serdes.String().getClass());\n        return new KafkaStreamsConfiguration(props);\n    }\n}\n```\n\næµ‹è¯•ç”¨ä¾‹ï¼š\n\néšæœºåœ¨è¿™å‡ ç§é¢œè‰²é‡Œå‘é€ç»™kafkaä¸€ä¸ªæ¶ˆæ¯\n\n```java\n@Autowired\nprivate KafkaTemplate<String,String> kafkaTemplate;\n@Test\npublic void KafkaTest() throws InterruptedException {\n    String[] field = new String[]{\"red\",\"blue\",\"yellow\",\"green\",\"black\",\"white\"};\n    Random random = new Random();\n    while (true){\n        try {\n            Thread.sleep(1000);\n            String s = field[random.nextInt(5)];\n            System.out.println(s);\n            kafkaTemplate.send(\"itcast-topic-input\",s);\n        }\n        catch (Exception e){\n            e.printStackTrace();\n        }\n    }\n\n}\n```\n\næµå¼åº”ç”¨ï¼š\n\nç”±äºæµå¼æ˜¯ä¸å…·æœ‰ç¼“å­˜åŠŸèƒ½çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€æ®µæ—¶é—´å†…å¾—åˆ°çš„ç»“æœåªèƒ½ä»£è¡¨è¿™ä¸€æ®µæ—¶é—´ã€‚ä¸èƒ½ä¸å†å²è®°å½•ç´¯åŠ ï¼Œè¿™ä¸ªæ—¶å€™å°±è¦å­˜redisäº†ï¼ŒæŠŠæ¯ä¸€æ®µæ—¶é—´çš„æ•°æ®éƒ½ç´¯åŠ ã€‚\n\næ•°æ®æµå‘ï¼šæµ‹è¯•çº¿ç¨‹ä¸€ç›´å‘ç»™itcast-topic-inputä¸»é¢˜ï¼Œæµå¼åº”ç”¨ç›‘å¬itcast-topic-inputï¼Œé€šè¿‡å¤„ç†å¾—åˆ°é”®ä¸ºå•è¯ï¼Œå€¼ä¸ºæ•°é‡çš„é”®å€¼å¯¹ï¼Œä¼ ç»™itcast-topic-outputä¸»é¢˜ã€‚æœ€åå†æœ‰ä¸€ä¸ªç›‘å¬å™¨æŠŠè¿™äº›æ•°æ®ä¸redisè¿›è¡Œå¤„ç†å’ŒæŒä¹…åŒ–ã€‚\n\n\n> è¾“å…¥çš„æ•°æ®æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä¾‹å¦‚â€œapple apple tea teaâ€ï¼Œå¯¹äºè¿™ä¸ªæ„å»ºçš„æµæ¥è¯´ï¼Œkeyä¸ºç©ºï¼Œvalueä¸ºè¿™ä¸ªå­—ç¬¦ä¸²ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦å°†è¿™ä¸ªå­—ç¬¦ä¸²åˆ’åˆ†ä¸ºå››ä¸ªé”®å€¼å¯¹ï¼Œè¦ä¿ç•™keyçš„åŒæ—¶valueå˜æˆå„ä¸ªå•è¯ï¼ˆè¿™é‡Œä¸èƒ½ç”¨mapï¼Œmapæ˜¯ä¸€å¯¹ä¸€çš„ï¼Œè¿™é‡Œæ¶‰åŠæ‹†åˆ†ï¼Œéœ€è¦ä¸€å¯¹å¤šï¼‰ï¼Œå¾—åˆ°äº†keyä¸ºnullï¼Œå€¼ä¸ºå•è¯çš„å¾ˆå¤šé”®å€¼å¯¹ï¼Œ\n> å¯¹è¿™äº›é”®å€¼å¯¹åˆ†ç»„ï¼Œkeyä¸ºå®ƒçš„å€¼ï¼Œä¹Ÿå°±æ˜¯è¯´æ‰€æœ‰æ˜¯ä¸€ä¸ªå•è¯çš„åˆ†åœ¨ä¸€ä¸ªç»„é‡Œé¢ï¼Œæ–¹ä¾¿åç»­ç»Ÿè®¡ã€‚\n> \n> éšåå¯ä»¥ç”¨countç›´æ¥å¾—å‡ºæ¯ä¸ªç»„çš„æ•°é‡ï¼Œä½†æ˜¯æˆ‘å«Œå¤ªç®€å•äº†ï¼Œç”¨aggregateï¼Œè¿™ä¸ªæ–¹æ³•æœ‰ä¸‰ä¸ªå‚æ•°ã€‚ä½œä¸ºèšåˆï¼Œä½ éœ€è¦ç»™è¿™ä¸ªèšåˆå™¨ä¸€ä¸ªåˆå§‹çš„æ•°æ®ç±»å‹å’Œæ•°æ®ï¼Œåç»­å†å¯¹å…¶è¿›è¡Œå åŠ ï¼Œç¬¬ä¸€ä¸ªå‡½æ•°æ˜¯è¿™ä¸ªåˆå§‹åŒ–çš„åŠ¨ä½œï¼Œç¬¬äºŒä¸ªå‡½æ•°æœ‰ä¸‰ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯kï¼Œvå’Œè¿™ä¸ªå åŠ å™¨çš„ä¼ é€’å€¼ã€‚ç¬¬ä¸‰ä¸ªå‡½æ•°æŒ‡å®šåºåˆ—åŒ–ç±»å‹ï¼Œè¿™ä¸ªæˆ‘ä¹Ÿæ²¡å¤ªææ‡‚\n>\n> åœ¨è¿™ä¸ªåº”ç”¨ä¸­ï¼Œè¿­ä»£å™¨çš„åˆå§‹ä¸º0ï¼Œç”±äºaggregateæ˜¯å¯¹æ¯ä¸ªç»„è¿›è¡Œèšåˆï¼Œå› æ­¤è¿­ä»£å™¨åªç”¨æ¯æ¬¡å°†åˆå§‹çš„å€¼+1å³å¯ã€‚\n> \n> æœ€åæ”¶é›†è¿™ä¸ªæ•°æ®è¿›è¡Œè½¬æ¢ï¼Œå‘é€åˆ°å¯¹åº”ä¸»é¢˜ç»™redisç›‘å¬ã€‚\n```java\n@Bean\npublic KStream<String,String> kStream(StreamsBuilder streamsBuilder){\n    KStream<String, String> stream = streamsBuilder.stream(\"itcast-topic-input\");\n    stream.flatMapValues(((value)->Arrays.asList(value.split(\" \"))))\n            .groupBy((key,value)->value)\n            .windowedBy(TimeWindows.of(Duration.ofSeconds(10)))\n            .aggregate(()->\"0\",(key,value,aggValue)->{\n                Long i = Long.parseLong(aggValue)+1;\n                return i+\"\";\n            })\n            .toStream()\n            .map(new KeyValueMapper<Windowed<String>, String, KeyValue<?, ?>>() {\n                @Override\n                public KeyValue<String, String> apply(Windowed<String> key, String value) {\n                    return new KeyValue<>(key.key(),value);\n                }\n            })\n            .to(\"itcast-topic-output\");\n    return stream;\n}\n```\n\nç›‘å¬å™¨ï¼š\n\nå…ˆæŸ¥æ‰¾redisæœ‰æ²¡æœ‰è¿™ä¸ªkeyï¼Œåç»­å°±æ˜¯ç®€å•çš„åŠ ä¸Š\n\n```java\n@KafkaListener(topics = \"itcast-topic-out\")\npublic void handleMessage(ConsumerRecord<String,String> message){\n    //å…ˆåœ¨redisé‡Œæ‰¾æœ‰æ²¡æœ‰è¿™ä¸ªå•è¯\n    Double score = stringRedisTemplate.opsForZSet().score(REDIS_WORD, message.key());\n    if (score == null){\n        stringRedisTemplate.opsForZSet().add(REDIS_WORD,message.key(), Double.parseDouble(message.value()));\n    }\n    else {\n        stringRedisTemplate.opsForZSet().add(REDIS_WORD,message.key(), score+Double.parseDouble(message.value()));\n    }\n    System.out.println(\"æ€»è®¡ï¼š\"+message.key()+\":\"\n            +stringRedisTemplate.opsForZSet().score(REDIS_WORD, message.key()));\n}\n```\n\n\n## KafkaStreamæ”¹é€ é¡¹ç›®\n\nå®šä¹‰ä¸¤ä¸ªå®ä½“ç±»ï¼š\n- ä¸€ä¸ªæ˜¯ä¼ ç»™kafkastreamçš„æ¶ˆæ¯å®ä½“ï¼Œä¹Ÿå°±æ˜¯è¦å‘Šè¯‰streamé‚£ä¸€ç¯‡æ–‡ç« ï¼Œæœ‰äº†ä»€ä¹ˆåŠ¨ä½œï¼Œç‚¹èµäº†è¿˜æ˜¯è¯„è®ºäº†ã€‚\n\n```java\n@Data\npublic class UpdateBlogMess {\n    /**\n     * æ–‡ç« id\n     */\n    private Long id;\n\n    /**\n     * æ›´æ–°ç±»å‹\n     */\n    private UpdateType updateType;\n\n    /**\n     * æ›´æ–°æ•°å€¼ï¼Œç‚¹èµæ˜¯1ï¼Œå–æ¶ˆç‚¹èµæ˜¯-1\n     */\n    private int add;\n    public enum UpdateType{\n        VIEW,LIKED,COMMENT\n    }\n}\n```\n\n- å¦ä¸€ä¸ªæ˜¯ä¼ å‡ºkafkastreamçš„æ¶ˆæ¯å®ä½“ï¼Œè¾“å‡ºå¤„ç†åçš„å½“å‰ç‰‡æ®µå†…blogçš„ä¸€äº›ç»Ÿè®¡ç»“æœ\n\n```java\n@Data\npublic class BlogVisitedStreamMess {\n    /**\n     * æ–‡ç« id\n     */\n    private Long id;\n    /**\n     * UVç»Ÿè®¡é‡\n     */\n    private Long view;\n    /**\n     * ç‚¹èµçš„\n     */\n    private Long liked;\n    /**\n     * è¯„è®ºæ•°\n     */\n    private Long comment;\n}\n\n```\n\næµå¼åº”ç”¨ï¼š\n\nå¦‚ä¸Šæ‰€è¿°ï¼Œè¿™é‡Œçš„è¾“å…¥æ˜¯keyä¸ºç©ºï¼Œå€¼ä¸ºUpdateBlogMessçš„jsonå­—ç¬¦ä¸²ï¼Œ\n1. é¦–å…ˆè¦æŠŠjsonååºåˆ—åŒ–ï¼Œæ˜ å°„åˆ°keyä¸ºidï¼Œå€¼ä¸ºç±»å‹å’Œæ•°é‡ï¼Œä¾‹å¦‚liked:1ï¼Œ\n2. å†å¯¹keyè¿›è¡Œåˆ†ç»„ï¼Œå¾ˆå¤šæ“ä½œçš„éƒ½æ˜¯åŒä¸€ç¯‡æ–‡ç« ã€‚\n3. èšåˆï¼šæ ¹æ®å¯¹è±¡çš„æ“ä½œç±»å‹åœ¨å¯¹åº”çš„æœªçŸ¥+1ï¼Œåˆå§‹åŒ–æ˜¯ä¸€ä¸ª\"VIEW:0;COMMENT:0;LIKED:0\"ï¼Œåç»­çš„èšåˆéƒ½åœ¨è¿™ä¸Šé¢åˆ†å‰²å’Œæ ¡éªŒã€‚è¿™é‡Œåªæµ‹è¯•äº†ç‚¹èµçš„ï¼Œå¯¹äºviewè¿™ä¸ªå­—æ®µæˆ‘æ‰“ç®—æ˜¯ç›´æ¥ä½¿ç”¨HyperLogLogæ¥ç»Ÿè®¡ã€‚è¯„è®ºè¿™ä¸ªåŠŸèƒ½æš‚æ—¶æ²¡åšã€‚\n4. UVç»Ÿè®¡è¿‘ä¸€ä¸ªç¤¼æ‹œçš„æ–‡ç« è®¿é—®é‡ã€‚\n5. æœ€åè¿”å›ä¸€ä¸ªkeyä¸ºæ–‡ç« idï¼Œå€¼ä¸ºBlogVisitedStreamMessçš„Jsonå­—ç¬¦ä¸²\n\n```java\nprivate static final String KAFKA_STREAM_HOT_BLOG = \"hotBlog-produce\";\nprivate static final String KAFKA_STREAM_HOT_BLOG_CONSUMER = \"hotBlog-consumer\";\n@Resource\nprivate StringRedisTemplate stringRedisTemplate;\n\n@Bean\npublic KStream<String,String> kStream(StreamsBuilder streamsBuilder){\n    KStream<String, String> stream = streamsBuilder.stream(KAFKA_STREAM_HOT_BLOG);\n    stream.map(new KeyValueMapper<String, String, KeyValue<String , String>>() {\n        /**\n         *\n         * @param key ç©º\n         * @param value UpdateBlogMessçš„Jsonå­—ç¬¦ä¸²\n         * @return keyä¸ºæ–‡ç« idï¼Œvalueä¸ºç±»å‹å’Œæ•°é‡\n         */\n        @Override\n        public KeyValue<String, String> apply(String key, String value) {\n            UpdateBlogMess blogMess = JSONUtil.toBean(value, UpdateBlogMess.class);\n            //key:120312391 value:LIKED:-1\n\n            return new KeyValue<>(blogMess.getId()+\"\",blogMess.getUpdateType().name()+\":\"+blogMess.getAdd());\n        }\n    })\n            .groupBy((key,value)->key)\n            .windowedBy(TimeWindows.of(Duration.ofSeconds(10)))\n            .aggregate(new Initializer<String>() {\n                @Override\n                public String apply() {\n                    return \"VIEW:0;COMMENT:0;LIKED:0\";\n                }\n            }, new Aggregator<String, String, String>() {\n                @Override\n                public String apply(String key, String value, String aggValue) {\n                    if(StringUtils.isBlank(value)){\n                        return aggValue;\n                    }\n                    long viewNum = 0L, commentNum = 0L, likedNum = 0L;\n                    //å¤„ç†aggValue\n                    String[] splits = aggValue.split(\";\");\n                    for (String split : splits) {\n                        String[] type = split.split(\":\");\n                        switch (UpdateBlogMess.UpdateType.valueOf(type[0])) {\n                            case VIEW:\n                                viewNum = Long.parseLong(type[1]);\n                                break;\n                            case LIKED:\n                                likedNum = Long.parseLong(type[1]);\n                                break;\n                            case COMMENT:\n                                commentNum = Long.parseLong(type[1]);\n                                break;\n                        }\n                    }\n                    //å¤„ç†value\n                    String[] splitVal = value.split(\":\");\n                    switch (UpdateBlogMess.UpdateType.valueOf(splitVal[0])) {\n                        case VIEW:\n                            //æŸ¥è¯¢ä¸€å‘¨ä»¥å†…çš„UVè®¿é—®é‡\n                            viewNum = calculateUV(key);\n                            break;\n                        case LIKED:\n                            //å¦‚æœæ˜¯liked:-1å°±è¦-1\n                            likedNum += Long.parseLong(splitVal[1]);\n                            break;\n                        case COMMENT:\n                            commentNum += 1;\n                            break;\n                    }\n                    //æœ€åè¿”å›agg\n                    return \"VIEW:\" + viewNum + \";COMMENT:\" + commentNum + \";LIKED:\" + likedNum;\n                }\n            })\n            .toStream().map((key,value)->{\n                BlogVisitedStreamMess blogVisitedStreamMess = new BlogVisitedStreamMess();\n                blogVisitedStreamMess.setId(Long.valueOf(key.key()));\n                String[] splits = value.split(\";\");\n                for (String split:splits){\n                    String[] strings = split.split(\":\");\n                    switch (UpdateBlogMess.UpdateType.valueOf(strings[0])){\n                        case LIKED:\n                            blogVisitedStreamMess.setLiked(Long.valueOf(strings[1]));\n                            break;\n                        case COMMENT:\n                            blogVisitedStreamMess.setComment(Long.parseLong(strings[1]));\n                            break;\n                        case VIEW:\n                            blogVisitedStreamMess.setView(Long.parseLong(strings[1]));\n                            break;\n                    }\n                }\n                return new KeyValue<>(key.key(),JSONUtil.toJsonStr(blogVisitedStreamMess));\n            })\n            .to(KAFKA_STREAM_HOT_BLOG_CONSUMER);\n\n    return stream;\n}\nprivate static final String HyperLogLogPrefix = \"HLL:blog:\";\n/**\n * ç»Ÿè®¡ä¸€å‘¨ä»¥å†…çš„UVè®¿é—®é‡\n * @return\n */\npublic Long calculateUV(String key){\n    long UV4Week = 0L;\n    LocalDate now = LocalDate.now();\n    //ä¸å¤Ÿä¼˜é›…\n    /*String yesterday = now.minusDays(1).format(DateTimeFormatter.ofPattern(\"yyyy:MM:dd\"));\n    String theDayBeforeYesterday = now.minusDays(2).format(DateTimeFormatter.ofPattern(\"yyyy:MM:dd\"));*/\n    List<LocalDate> lastWeekDates = IntStream.rangeClosed(1, 7)\n            .mapToObj(now::minusDays)\n            .collect(Collectors.toList());\n\n    //blogçš„id\n    long id = Long.parseLong(key);\n    for (LocalDate localDate:lastWeekDates){\n        String date = localDate.format(DateTimeFormatter.ofPattern(\"yyyy:MM:dd\"));\n        UV4Week += stringRedisTemplate.opsForHyperLogLog().size(HyperLogLogPrefix + \":\" + id + date);\n    }\n    return UV4Week;\n}\n```\nåç»­ç›‘å¬å™¨æ ¹æ®è¿™ä¸ªæ¶ˆæ¯æ“ä½œredisï¼Œä½†æ˜¯ç”±äºé»‘é©¬ç‚¹è¯„è¿™ä¸ªé¡¹ç›®é‡ŒæŸ¥è¯¢çƒ­ç‚¹æ–‡ç« æ˜¯ç›´æ¥èµ°æ•°æ®åº“ï¼Œæ ¹æ®likesçš„å‡åºæŸ¥è¯¢ï¼Œæ‰€æœ‰è¦æ”¹å¾ˆå¤šéƒ¨åˆ†ã€‚ä»Šå¤©å…ˆä»‹ç»åˆ°è¿™é‡Œã€‚\n\n> 2026.6.11æ›´æ–°\n\nå®ç°äº†ç”¨xxl-jobå®šæœŸç»Ÿè®¡UVç„¶åå‘é€ç»™ç®¡é“.\n\nè¿™é‡Œè¿˜å¯ä»¥ä¼˜åŒ–ä¸ºscanå‘½ä»¤ï¼Œå¦‚æœç”¨keyçš„è¯ä¼šåœ¨redisé‡Œå…¨å±€æ‰¾ï¼Œå¼€é”€å¾ˆå¤§ã€‚ç°åœ¨æ•°æ®é‡å°ç‚¹è¿˜æ²¡å…³ç³»ï¼Œä¸€æ—¦å¤§èµ·æ¥å°±æ•ˆç‡å¾ˆä½äº†ã€‚\n\n```java\n/**\n * ä½¿ç”¨ SCAN å‘½ä»¤è·å–ä¸ç»™å®šæ¨¡å¼åŒ¹é…çš„é”®\n *\n * @param pattern æ¨¡å¼ï¼Œä¾‹å¦‚ \"*HLL_PREFIX*\"\n * @return åŒ¹é…çš„é”®é›†åˆ\n */\npublic Set<String> scanKeys(String pattern) {\n    return stringRedisTemplate.keys(\"*\" + pattern + \"*\");\n}\n/**\n * å®šæ—¶ç»™kafkaç®¡é“å‘viewçš„æ¶ˆæ¯ï¼Œä»HyperLogLogé‡Œæ‰¾\n */\n@XxlJob(\"demoJobHandler\")\npublic void viewSchedule(){\n    //æŸ¥æ‰¾æ‰€æœ‰æ–‡ç« \n    Set<String> keys = scanKeys(HLL_PREFIX);\n    for (String key :keys){\n        Long size = stringRedisTemplate.opsForHyperLogLog().size(key);\n        UpdateBlogMess mess = new UpdateBlogMess();\n        mess.setUpdateType(UpdateBlogMess.UpdateType.VIEW);\n        mess.setAdd(Math.toIntExact(size));\n        mess.setId(Long.valueOf(key.split(\":\")[2]));\n        log.debug(mess.toString());\n        kafkaTemplate.send(KAFKA_STREAM_HOT_BLOG, JSONUtil.toJsonStr(mess));\n    }\n}\n\n```\n","tags":["Redis"]},{"title":"java-å¤šçº¿ç¨‹-CompletableFuture","url":"/2024/06/04/java-å¤šçº¿ç¨‹-CompletableFuture/","content":"> å¹³æ—¶å¤šçº¿ç¨‹éƒ½æ˜¯ç”¨runnableï¼Œcallableï¼ŒFutureTaskï¼Œçº¿ç¨‹æ± è¿™ç±»å®Œæˆä»»åŠ¡ã€‚è€ŒcompletableFutureå¯ä»¥å®Œæˆå¼‚æ­¥ä»»åŠ¡çš„ç¼–æ’ï¼Œæ›´å…·æœ‰çµæ´»æ€§ã€‚\n\n## åˆ›å»ºå¼‚æ­¥ä»»åŠ¡\n\n### supplyAsync\n\nä¸¤ç§æ–¹æ³•ï¼Œä¸€ç§æ˜¯ç”¨é»˜è®¤çš„çº¿ç¨‹æ± ForkJoinPool.commonPool()ï¼Œå¦ä¸€ç§éœ€è¦è‡ªå·±å®šä¹‰ï¼Œæ¨èåè€…\n\n```java\n// å¸¦è¿”å›å€¼å¼‚æ­¥è¯·æ±‚ï¼Œé»˜è®¤çº¿ç¨‹æ± \npublic static <U> CompletableFuture<U> supplyAsync(Supplier<U> supplier);\n \n// å¸¦è¿”å›å€¼çš„å¼‚æ­¥è¯·æ±‚ï¼Œå¯ä»¥è‡ªå®šä¹‰çº¿ç¨‹æ± \npublic static <U> CompletableFuture<U> supplyAsync(Supplier<U> supplier, Executor executor);\n\n```\n\nä½¿ç”¨æ–¹æ³•ï¼š\n\n```java\npublic static void main(String[] args) throws ExecutionException, InterruptedException, TimeoutException {\n    ExecutorService myThreadPool = Executors.newFixedThreadPool(4);\n    //è¿™æ˜¯æœ‰çº¿ç¨‹æ± çš„ï¼Œè¿™é‡Œlambdaè¡¨è¾¾å¼ä¹Ÿå¯ä»¥æºç¨‹()->1ï¼Œå¦‚æœæ²¡æœ‰åˆ«çš„é€»è¾‘çš„è¯\n    CompletableFuture<Integer> test1 = CompletableFuture.supplyAsync(()->{\n        System.out.println(Thread.currentThread().toString());\n        return 1;\n    },myThreadPool);\n    //é»˜è®¤æ–¹æ³•\n    CompletableFuture<Integer> test2 = CompletableFuture.supplyAsync(()->{\n        System.out.println(Thread.currentThread().toString());\n        return 1;\n    });\n    System.out.println(test1.get(10, TimeUnit.SECONDS));\n    myThreadPool.shutdown();\n}\n```\n\nç»“æœï¼š\n\n```text\nThread[ForkJoinPool.commonPool-worker-25,5,main]\n1\n```\n\n### runAsync\n\nä¸å‰é¢çš„supplyAsyncç›¸æ¯”ï¼ŒrunAsyncæ²¡æœ‰è¿”å›å€¼ï¼Œå°±ç›¸å½“äºæ˜¯runnableï¼Œå‰é¢é‚£ä¸ªæ˜¯callableã€‚åŒæ ·ä¹Ÿæœ‰ä¸¤ä¸ªæ–¹æ³•ï¼Œä¸€ä¸ªæ˜¯ç”¨é»˜è®¤çº¿ç¨‹æ± ï¼Œå¦ä¸€ä¸ªè‡ªå·±å®šä¹‰\n\n```java\npublic static void main(String[] args) throws ExecutionException, InterruptedException, TimeoutException {\n        ExecutorService myThreadPool = Executors.newFixedThreadPool(4);\n        CompletableFuture<Void> test1 = CompletableFuture.runAsync(()->{\n            System.out.println(Thread.currentThread());\n        });\n        System.out.println(test1.get());\n        myThreadPool.shutdown();\n    }\n```\nç»“æœ(è¿™æ˜¯é»˜è®¤çº¿ç¨‹)ï¼š\n\n```text\nThread[ForkJoinPool.commonPool-worker-25,5,main]\nnull\n\n```\n\n### è·å–ç»“æœçš„æ–¹æ³•\n\n```java\n// å¦‚æœå®Œæˆåˆ™è¿”å›ç»“æœï¼Œå¦åˆ™å°±æŠ›å‡ºå…·ä½“çš„å¼‚å¸¸\npublic T get() throws InterruptedException, ExecutionException \n \n// æœ€å¤§æ—¶é—´ç­‰å¾…è¿”å›ç»“æœï¼Œå¦åˆ™å°±æŠ›å‡ºå…·ä½“å¼‚å¸¸\npublic T get(long timeout, TimeUnit unit) throws InterruptedException, ExecutionException, TimeoutException\n \n// å®Œæˆæ—¶è¿”å›ç»“æœå€¼ï¼Œå¦åˆ™æŠ›å‡ºuncheckedå¼‚å¸¸ã€‚ä¸ºäº†æ›´å¥½åœ°ç¬¦åˆé€šç”¨å‡½æ•°å½¢å¼çš„ä½¿ç”¨ï¼Œå¦‚æœå®Œæˆæ­¤ CompletableFutureæ‰€æ¶‰åŠçš„è®¡ç®—å¼•å‘å¼‚å¸¸ï¼Œåˆ™æ­¤æ–¹æ³•å°†å¼•å‘uncheckedå¼‚å¸¸å¹¶å°†åº•å±‚å¼‚å¸¸ä½œä¸ºå…¶åŸå› \npublic T join()\n \n// å¦‚æœå®Œæˆåˆ™è¿”å›ç»“æœå€¼ï¼ˆæˆ–æŠ›å‡ºä»»ä½•é‡åˆ°çš„å¼‚å¸¸ï¼‰ï¼Œå¦åˆ™è¿”å›ç»™å®šçš„ valueIfAbsentã€‚\npublic T getNow(T valueIfAbsent)\n \n// å¦‚æœä»»åŠ¡æ²¡æœ‰å®Œæˆï¼Œè¿”å›çš„å€¼è®¾ç½®ä¸ºç»™å®šå€¼\npublic boolean complete(T value)\n \n// å¦‚æœä»»åŠ¡æ²¡æœ‰å®Œæˆï¼Œå°±æŠ›å‡ºç»™å®šå¼‚å¸¸\npublic boolean completeExceptionally(Throwable ex) \n  \n\n```\n\n## å¼‚æ­¥å›è°ƒå¤„ç†\n\n> applyå°±æ˜¯æœ‰å‚æ•°æœ‰è¿”å›å€¼ï¼Œacceptå°±æ˜¯æœ‰å‚æ•°æ²¡æœ‰è¿”å›å€¼ï¼Œrunå°±æ˜¯æ²¡æœ‰å‚æ•°æ²¡æœ‰è¿”å›å€¼ã€‚asyncéƒ½æ˜¯å¯ä»¥æœ‰å¼‚æ­¥çº¿ç¨‹æ± çš„\n\n### thenApplyå’ŒthenApplyAsync\n\n```java\npublic static void main(String[] args) throws ExecutionException, InterruptedException, TimeoutException {\n    ExecutorService myThreadPool = Executors.newFixedThreadPool(4);\n\n    CompletableFuture<Integer> task1 = CompletableFuture.supplyAsync(()->{\n        System.out.println(\"task1\"+Thread.currentThread()+\"->\"+1);\n        return 1;\n    },myThreadPool);\n\n    CompletableFuture<Integer> task2 = task1.thenApply((result) -> {\n        System.out.println(\"task2\"+Thread.currentThread() + \"->\" + (1 + result));\n        return 1 + result;\n    });\n\n    CompletableFuture<Integer> task3 = task1.thenApplyAsync((result) -> {\n        System.out.println(\"task3\"+Thread.currentThread() + \"->\" + (1 + result));\n        return 1 + result;\n    },myThreadPool);\n\n    System.out.println(task2.get());\n\n    System.out.println(task3.get());\n\n    myThreadPool.shutdown();\n}\n```\n\nç»“æœï¼š\n```text\ntask1Thread[pool-1-thread-1,5,main]->1\ntask2Thread[pool-1-thread-1,5,main]->2\ntask3Thread[pool-1-thread-2,5,main]->2\n2\n2\n```\n\nè¿™ä¸ªç»“æœæŒºæœ‰æ„æ€çš„ï¼Œéœ€è¦åˆ†æä¸€ä¸‹ã€‚é¦–å…ˆæ˜¯çº¿ç¨‹æ± é‡Œé¢æäº¤çš„çº¿ç¨‹éƒ½æ˜¯å¹¶å‘çš„ï¼Œè¿™é‡Œå°±ä½“ç°äº†å¹¶å‘ï¼Œtask2å’Œ3å…ˆè¿›è¡Œäº†æ ‡å‡†è¾“å‡ºå†å®Œæˆå€¼çš„è¾“å‡ºã€‚è¯´æ˜å¹¶å‘ä¹±åºäº†ã€‚\n\nè¿˜æœ‰å°±æ˜¯thenApplyç”¨çš„æ˜¯è·Ÿå‰ä¸€ä¸ªä»»åŠ¡ç›¸åŒçš„çº¿ç¨‹ï¼Œè€Œå¸¦å‚æ•°çš„thenApplyAsyncç”¨çš„æ˜¯ä¸ä¸€æ ·çš„ã€‚\n\n**é»˜è®¤å‚æ•°çš„supplyAsyncå’ŒthenApply/é»˜è®¤thenApplyAsync**\n```java\nCompletableFuture<Integer> task1 = CompletableFuture.supplyAsync(()->{\n    System.out.println(\"task1\"+Thread.currentThread()+\"->\"+1);\n    return 1;\n});\n//è¿™é‡Œç”¨ä¸åŠ å‚æ•°çš„thenApplyAsyncä¹Ÿæ˜¯ä¸€æ ·çš„\nCompletableFuture<Integer> task2 = task1.thenApply((result) -> {\n    System.out.println(\"task2\"+Thread.currentThread() + \"->\" + (1 + result));\n    return 1 + result;\n});\n```\n\n```text\ntask1Thread[ForkJoinPool.commonPool-worker-25,5,main]->1\ntask2Thread[ForkJoinPool.commonPool-worker-25,5,main]->2\n2\n```\n\n**é»˜è®¤å‚æ•°çš„supplyAsyncå’Œçº¿ç¨‹æ± thenApplyAsync**\n\n```java\nCompletableFuture<Integer> task1 = CompletableFuture.supplyAsync(()->{\n    System.out.println(\"task1\"+Thread.currentThread()+\"->\"+1);\n    return 1;\n});\n\nCompletableFuture<Integer> task2 = task1.thenApplyAsync((result) -> {\n    System.out.println(\"task2\"+Thread.currentThread() + \"->\" + (1 + result));\n    return 1 + result;\n},myThreadPool);\n```\n\n```text\ntask1Thread[ForkJoinPool.commonPool-worker-25,5,main]->1\ntask2Thread[pool-1-thread-1,5,main]->2\n2\n```\n\n**çº¿ç¨‹æ± çš„supplyAsyncå’ŒthenApply**\n\n```java\nCompletableFuture<Integer> task1 = CompletableFuture.supplyAsync(()->{\n    System.out.println(\"task1\"+Thread.currentThread()+\"->\"+1);\n    return 1;\n},myThreadPool);\n\nCompletableFuture<Integer> task2 = task1.thenApply((result) -> {\n    System.out.println(\"task2\"+Thread.currentThread() + \"->\" + (1 + result));\n    return 1 + result;\n});\n```\n\n```text\ntask1Thread[pool-1-thread-1,5,main]->1\ntask2Thread[pool-1-thread-1,5,main]->2\n2\n```\n\n**çº¿ç¨‹æ± çš„supplyAsyncå’Œçº¿ç¨‹æ± thenApplyAsync**\n\n```java\nCompletableFuture<Integer> task1 = CompletableFuture.supplyAsync(()->{\n    System.out.println(\"task1\"+Thread.currentThread()+\"->\"+1);\n    return 1;\n},myThreadPool);\n\nCompletableFuture<Integer> task2 = task1.thenApplyAsync((result) -> {\n    System.out.println(\"task2\"+Thread.currentThread() + \"->\" + (1 + result));\n    return 1 + result;\n},myThreadPool);\n```\n\n```text\ntask1Thread[pool-1-thread-1,5,main]->1\ntask2Thread[pool-1-thread-2,5,main]->2\n2\n```\n\n**çº¿ç¨‹æ± supplyAsyncå’Œé»˜è®¤thenApplyAsync**\n\n```java\nCompletableFuture<Integer> task1 = CompletableFuture.supplyAsync(()->{\n    System.out.println(\"task1\"+Thread.currentThread()+\"->\"+1);\n    return 1;\n},myThreadPool);\n\nCompletableFuture<Integer> task2 = task1.thenApplyAsync((result) -> {\n    System.out.println(\"task2\"+Thread.currentThread() + \"->\" + (1 + result));\n    return 1 + result;\n});\n```\n\n```text\ntask1Thread[pool-1-thread-1,5,main]->1\ntask2Thread[ForkJoinPool.commonPool-worker-25,5,main]->2\n2\n```\n\n> **æ€»ç»“ï¼š**\n> \n> thenApplyæ— è®ºå¦‚ä½•éƒ½ä¼šä¸å‰ä¸€ä¸ªä»»åŠ¡ç”¨ç›¸åŒçš„çº¿ç¨‹ï¼Œè€ŒthenApplyAsyncæ˜¯é‡æ–°èµ·ä¸€ä¸ªçº¿ç¨‹å®Œæˆï¼Œå¦‚æœæ²¡æœ‰å‚æ•°ï¼Œé‚£ä¹ˆå°±ä¼šä½¿ç”¨é»˜è®¤çš„ForkJoinPool.commonPool()\n> \n> åœ¨åé¢çš„æœ‰asyncéƒ½æ˜¯è¿™ä¸ªé€»è¾‘\n\n### thenAcceptå’ŒthenAcceptAsync\n\n```java\nCompletableFuture<Integer> task1 = CompletableFuture.supplyAsync(()->{\n    System.out.println(\"task1\"+Thread.currentThread()+\"->\"+1);\n    return 1;\n},myThreadPool);\n\nCompletableFuture<Void> task2 = task1.thenAccept((result) -> {\n    System.out.println(\"task2\" + Thread.currentThread() + \"->\" + (1 + result));\n});\n\nCompletableFuture<Void> task3 = task1.thenAcceptAsync((result) -> {\n    System.out.println(\"task3\" + Thread.currentThread() + \"->\" + (1 + result));\n},myThreadPool);\nSystem.out.println(task2.get());\n```\n\n```text\ntask1Thread[pool-1-thread-1,5,main]->1\ntask2Thread[pool-1-thread-1,5,main]->2\ntask3Thread[pool-1-thread-2,5,main]->2\nnull\n```\nè¿™ä¸ªç»“æœä¹Ÿæ˜¯ä¹±åºäº†ï¼Œè€Œä¸”asyncçš„ä¸ä¹‹å‰ä¸€è‡´ã€‚ä¸å†èµ˜è¿°ã€‚\n\n### thenRunå’ŒthenRunAsync\n\næ— å…¥å‚æ•°æ— è¿”å›å€¼ï¼Œå…¶ä»–éƒ½ä¸€æ ·\n\n## å¤šä»»åŠ¡\n\n### thenCombineã€thenAcceptBoth å’ŒrunAfterBoth\n\ncombineå°±æ˜¯æœ‰å‚æ•°æœ‰è¿”å›å€¼ï¼Œacceptå°±æ˜¯æœ‰å‚æ•°æ²¡è¿”å›å€¼ï¼Œrunå°±æ˜¯æ— å‚æ•°æ— è¿”å›å€¼\n\n```java\nCompletableFuture<Integer> task1 = CompletableFuture.supplyAsync(()->{\n    System.out.println(\"task1\"+Thread.currentThread()+\"->\"+1);\n    return 1;\n});\n\nCompletableFuture<Integer> task2 = CompletableFuture.supplyAsync(() -> {\n    System.out.println(\"task2\" + Thread.currentThread() + \"->\" + 2);\n    return 2;\n});\nCompletableFuture<Integer> task3 = task1.thenCombine(task2, (a, b) -> {\n    System.out.println(\"task3\" + Thread.currentThread() + \"->\" + (a + b));\n    return a + b;\n});\n\nSystem.out.println(task3.get());\n```\næŒ‰é“ç†æ¥è¯´task3åº”è¯¥æ˜¯è·Ÿtask1ä¸€æ ·çš„çº¿ç¨‹ï¼Œæœ‰ä¸€æ¬¡ç»“æœæ˜¯ä¸€æ ·çš„ï¼Œä¸çŸ¥é“è¿™é‡Œä¸ºä»€ä¹ˆæ˜¯main\n```text\ntask1Thread[ForkJoinPool.commonPool-worker-25,5,main]->1\ntask2Thread[ForkJoinPool.commonPool-worker-18,5,main]->2\ntask3Thread[main,5,main]->3\n3\n```\n\n**å›ç­”ï¼šä¸ºä»€ä¹ˆé»˜è®¤æ˜¯ä¸»çº¿ç¨‹**\n\n1. ä¸»çº¿ç¨‹è°ƒç”¨getæ–¹æ³•ï¼šå½“ä¸»çº¿ç¨‹è°ƒç”¨getæ–¹æ³•æ—¶ï¼Œå¦‚æœtask1å’Œtask2å·²ç»å®Œæˆï¼Œç»„åˆä»»åŠ¡task3ä¼šç«‹å³æ‰§è¡Œï¼Œè€Œä¸éœ€è¦åˆ‡æ¢åˆ°å¦ä¸€ä¸ªçº¿ç¨‹ã€‚è¿™æ ·å¯ä»¥å‡å°‘çº¿ç¨‹åˆ‡æ¢çš„å¼€é”€ï¼Œæé«˜æ€§èƒ½ã€‚\n\n2. å®Œæˆçš„çº¿ç¨‹ï¼šå¦‚æœä»»åŠ¡åœ¨æŸä¸ªçº¿ç¨‹ä¸­å®Œæˆï¼Œä¸”æ²¡æœ‰å…¶ä»–çº¿ç¨‹ç­‰å¾…ç»“æœï¼Œé‚£ä¹ˆå›è°ƒä»»åŠ¡å¯èƒ½åœ¨å®Œæˆä»»åŠ¡çš„çº¿ç¨‹ä¸­æ‰§è¡Œã€‚è¿™ç§è¡Œä¸ºç”±CompletableFutureçš„é»˜è®¤æ‰§è¡Œç­–ç•¥å†³å®šã€‚\n\nä½¿ç”¨thenCombineAsyncå¯ä»¥æ˜¾å¼æŒ‡å®šåœ¨å¼‚æ­¥çº¿ç¨‹ä¸­æ‰§è¡Œå›è°ƒä»»åŠ¡ï¼Œä»è€Œé¿å…åœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œç»„åˆä»»åŠ¡ã€‚\n\n> éšåè¯•äº†ä¸€ä¸‹å»¶é•¿å¤„ç†æ—¶é—´ï¼Œå‘ç°è¿˜çœŸæ˜¯ï¼š\n> \n> task1Thread[pool-1-thread-1,5,main]->1\n> \n> task2Thread[pool-1-thread-2,5,main]->2\n> \n> task3Thread[pool-1-thread-1,5,main]->3\n> \n> 3\n> \n> è¯´æ˜ç¡®å®æ˜¯å¤„ç†æ—¶é—´çŸ­ï¼Œå¤„ç†æ—¶é—´çŸ­ä¼šç”±äºå›ºå®šçš„ç­–ç•¥ç›´æ¥mainåšï¼Œå‡å°‘çº¿ç¨‹å¼€é”€ã€‚æ‰€ä»¥éœ€è¦asyncå¼‚æ­¥ï¼Œæ˜¾ç¤ºç»™å‡º\n\n### applyToEitherï¼ŒacceptEitherï¼ŒrunAfterEither\n\nä¸¤ä¸ªé‡Œé¢åšå®Œä¸€ä¸ªå°±å¯ä»¥äº†ï¼Œå…¶ä»–éƒ½ä¸€æ ·\n\n```java\nCompletableFuture<Integer> task1 = CompletableFuture.supplyAsync(()->{\n    System.out.println(\"task1\"+Thread.currentThread()+\"->\"+1);\n    try {\n        Thread.sleep(100);\n    } catch (InterruptedException e) {\n        throw new RuntimeException(e);\n    }\n    return 1;\n},myThreadPool);\n\nCompletableFuture<Integer> task2 = CompletableFuture.supplyAsync(() -> {\n    System.out.println(\"task2\" + Thread.currentThread() + \"->\" + 2);\n    try {\n        Thread.sleep(10);\n    } catch (InterruptedException e) {\n        throw new RuntimeException(e);\n    }\n    return 2;\n},myThreadPool);\nCompletableFuture<Integer> task3 = task1.applyToEither(task2,(first)->{\n    System.out.println(\"task3\" + Thread.currentThread() + \"->\" + first);\n    return first;\n});\n\n\nSystem.out.println(task3.get());\n```\n\n```text\ntask1Thread[pool-1-thread-1,5,main]->1\ntask2Thread[pool-1-thread-2,5,main]->2\ntask3Thread[pool-1-thread-2,5,main]->2\n2\n```\n\n### allOf / anyOf\n\nallOfï¼šCompletableFutureæ˜¯å¤šä¸ªä»»åŠ¡éƒ½æ‰§è¡Œå®Œæˆåæ‰ä¼šæ‰§è¡Œï¼Œåªæœ‰æœ‰ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå¼‚å¸¸ï¼Œåˆ™è¿”å›çš„CompletableFutureæ‰§è¡Œgetæ–¹æ³•æ—¶ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œå¦‚æœéƒ½æ˜¯æ­£å¸¸æ‰§è¡Œï¼Œåˆ™getè¿”å›nullã€‚\n\nanyOf ï¼šCompletableFutureæ˜¯å¤šä¸ªä»»åŠ¡åªè¦æœ‰ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæˆï¼Œåˆ™è¿”å›çš„CompletableFutureæ‰§è¡Œgetæ–¹æ³•æ—¶ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œå¦‚æœéƒ½æ˜¯æ­£å¸¸æ‰§è¡Œï¼Œåˆ™getè¿”å›æ‰§è¡Œå®Œæˆä»»åŠ¡çš„ç»“æœã€‚\n\n```java\nCompletableFuture<Integer> task1 = CompletableFuture.supplyAsync(()->{\n    System.out.println(\"task1\"+Thread.currentThread()+\"->\"+1);\n    try {\n        Thread.sleep(100);\n    } catch (InterruptedException e) {\n        throw new RuntimeException(e);\n    }\n    return 1;\n},myThreadPool);\n\nCompletableFuture<Integer> task2 = CompletableFuture.supplyAsync(() -> {\n    System.out.println(\"task2\" + Thread.currentThread() + \"->\" + 2);\n    try {\n        Thread.sleep(100);\n    } catch (InterruptedException e) {\n        throw new RuntimeException(e);\n    }\n    return 2;\n},myThreadPool);\nCompletableFuture<Integer> task3 = CompletableFuture.supplyAsync(()->{\n    System.out.println(\"task3\" + Thread.currentThread() + \"->\" + 3);\n    try {\n        Thread.sleep(100);\n    } catch (InterruptedException e) {\n        throw new RuntimeException(e);\n    }\n    return 3;\n},myThreadPool);\n\n\nSystem.out.println(CompletableFuture.allOf(task1,task2,task3).get());\n```\n\n```text\ntask1Thread[pool-1-thread-1,5,main]->1\ntask2Thread[pool-1-thread-2,5,main]->2\ntask3Thread[pool-1-thread-3,5,main]->3\nnull\n\n\n//ä¸‹é¢è¿™æ˜¯task2æœ‰1/0çš„æƒ…å†µ\ntask1Thread[pool-1-thread-1,5,main]->1\ntask2Thread[pool-1-thread-2,5,main]->2\ntask3Thread[pool-1-thread-3,5,main]->3\nException in thread \"main\" java.util.concurrent.ExecutionException: java.lang.ArithmeticException: / by zero\n\tat java.util.concurrent.CompletableFuture.reportGet(CompletableFuture.java:357)\n\tat java.util.concurrent.CompletableFuture.get(CompletableFuture.java:1908)\n\tat com.hmdp.service.impl.BlogServiceImpl.main(BlogServiceImpl.java:319)\nCaused by: java.lang.ArithmeticException: / by zero\n\tat com.hmdp.service.impl.BlogServiceImpl.lambda$main$4(BlogServiceImpl.java:301)\n\tat java.util.concurrent.CompletableFuture$AsyncSupply.run(CompletableFuture.java:1604)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)\n\tat java.lang.Thread.run(Thread.java:750)\n```\n> anyofå¾ˆç®€å•å°±ä¸æ¼”ç¤ºäº†\n","tags":["Java"]},{"title":"redisé¡¹ç›®-ç¼“å­˜å’Œè¯»å†™ä¸€è‡´æ€§","url":"/2024/06/01/redisé¡¹ç›®-ç¼“å­˜å’Œè¯»å†™ä¸€è‡´æ€§/","content":"> ä»Šå¤©ç¡®å®å­¦åˆ°äº†è›®å¤šä¸œè¥¿çš„ï¼Œå¿™é‡Œå·é—²çš„æ„Ÿè§‰çœŸå¥½\n> \n> å›é¡¾ä¸€ä¸‹ç¼“å­˜ï¼Œå¦‚åŒè®¡ç»„é‡Œé¢cacheå’Œå†…å­˜ä¹‹é—´çš„å…³ç³»ã€‚åœ¨javaé¡¹ç›®ä¸­redisä½œä¸ºç¼“å­˜ï¼Œmysqlå°±ç›¸å½“äºå†…å­˜ã€‚åŸºæœ¬çš„é€»è¾‘æ˜¯å…ˆæ‰¾ç¼“å­˜ï¼Œå¦‚æœç¼“å­˜æ²¡æœ‰å‘½ä¸­å°±æ‰¾mysqlï¼Œç„¶åå†å†™åˆ°ç¼“å­˜ä¸­ã€‚\n> è¿™é‡Œè¿˜æœ‰å¾ˆå¤šå¯ä»¥è€ƒè™‘çš„ç‚¹ï¼Œå†™ç­–ç•¥å’Œè°ƒåº¦ï¼Œåç»­éƒ½ä¼šè€ƒè™‘ä¸€éã€‚\n\né¦–å…ˆæ˜¯rediså¦‚ä½•ä½œä¸ºç¼“å­˜çš„ï¼Œå¾ˆç®€å•ï¼š\n\n```java\n@Override\n    public Result queryById(Long id) throws InterruptedException {\n        //è¯»å†™é”\n        RLock lock = redissonClient.getLock(\"lock:shop:write\");\n        while (!lock.tryLock(1000,2000,TimeUnit.MILLISECONDS)){\n            Thread.sleep(100);\n        }\n        try {\n            //return Result.ok(getById(id));\n            //1.å…ˆå»æŸ¥redis\n            String shopJsonStr = stringRedisTemplate.opsForValue().get(CACHE_SHOP + id);\n            //2.å¦‚æœredisæ²¡æœ‰å°±æ‰¾æ•°æ®åº“\n            if (shopJsonStr == null || shopJsonStr.isEmpty()){\n                //2.1 æ‰¾æ•°æ®åº“\n                Shop shop = getById(id);\n                //2.2 ç„¶åå†å†™å›redisé‡Œ\n                String jsonString = JSONUtil.toJsonStr(shop);\n                stringRedisTemplate.opsForValue().set(CACHE_SHOP + id,jsonString);\n                //è®¾ç½®30sçš„è¿‡æœŸæ—¶é—´\n                stringRedisTemplate.expire(CACHE_SHOP + id,30, TimeUnit.MINUTES);\n                return Result.ok(shop);\n            }\n            //3.å¦‚æœredisæœ‰å°±è¿”å›\n            else {\n                Shop shop = JSONUtil.toBean(shopJsonStr, Shop.class);\n                //åˆ·æ–°è¿‡æœŸæ—¶é—´\n                stringRedisTemplate.expire(CACHE_SHOP + id,30, TimeUnit.MINUTES);\n                return Result.ok(shop);\n            }\n        }\n        finally {\n            lock.unlock();\n        }\n\n    }\n```\n\n\nè¿™é‡Œä¸»è¦è€ƒè™‘åŒå†™ä¸€è‡´æ€§ã€‚å…ˆåˆ åå†™å’Œå…ˆå†™ååˆ éƒ½ä¼šæœ‰é—®é¢˜ï¼Œè¯¦æƒ…è§åŸæ¥çš„blogã€‚ä¸»è¦æœ‰ä¸‰ç§è§£å†³æ–¹æ³•ï¼š\n- å»¶è¿ŸåŒåˆ ï¼šåˆ é™¤->å†™->åˆ é™¤ï¼Œè¿™æ ·å¯ä»¥è§£å†³ç¬¬ä¸€æ¬¡åˆ é™¤ä¹‹å‰è¯»æ“ä½œå˜æ›´redisçš„è„æ•°æ®ï¼Œè¿™é‡Œçš„æœ€åä¸€æ¬¡åˆ é™¤ä¸ºä»€ä¹ˆè¦å»¶è¿Ÿï¼Œå› ä¸ºè‡³å°‘å¾—ç­‰å­˜æ•°æ®åº“æ“ä½œåšå®Œæ‰è¡Œï¼Œè¿™æ˜¯å¼‚æ­¥çš„ï¼Œä¸€èˆ¬éƒ½ä»¥ä¸šåŠ¡çš„å¹³å‡æ—¶é—´ä½œä¸ºå»¶è¿Ÿæ—¶é—´ã€‚\n- åˆ†å¸ƒå¼é”ï¼šç›´æ¥ä¸Šè¯»å†™é”ï¼Œå°±æ²¡æœ‰è¿™ä¹ˆå¤šäº‹æƒ…äº†\n- å…ˆå†™ååˆ ï¼šå…¶å®è¿™æ ·çš„æ¦‚ç‡æŒºä½çš„ï¼Œä¸€ç§æŠ•æœºæ–¹æ³•ã€‚\n\n### å»¶è¿ŸåŒåˆ \n\nè¿™é‡Œç”¨ä¸€ä¸ªå¼‚æ­¥çº¿ç¨‹æ± å®Œæˆï¼Œåœ¨å†™æ•°æ®åº“çš„æ—¶å€™å°±å¼€ä¸€ä¸ªæ–°çš„çº¿ç¨‹ï¼Œæœ€åæ ¹æ®å»¶è¿Ÿæ—¶é—´åˆ é™¤å°±è¡Œäº†ã€‚\n\nå€¼å¾—æ³¨æ„çš„æ˜¯è¿™é‡Œå¯ä»¥ç”¨aop+æ³¨è§£çš„æ–¹å¼å®Œæˆæ— ä¾µå…¥å®ç°ã€‚ç›¸æ¯”å‰é¢çš„ï¼Œåé¢è¿™ç§çš„å®ç”¨æ€§æ›´å¹¿æ³›ã€‚\n\n```java\n/**\n * å»¶æ—¶åŒåˆ \n * @param shop\n * @return\n */\npublic Result updateShopDoubleDel(Shop shop) {\n    stringRedisTemplate.delete(CACHE_SHOP + shop.getId().toString());\n    //æ›´æ–°æ•°æ®åº“\n    updateById(shop);\n    //å¼€å¯ä¸€ä¸ªæ–°çš„çº¿ç¨‹å»¶æ—¶åˆ é™¤\n    shopDoubleDelThreadPool.submit(new doubleDelThread(CACHE_SHOP + shop.getId().toString()));\n    return Result.ok();\n}\nprivate ExecutorService shopDoubleDelThreadPool = Executors.newFixedThreadPool(4);\n/**\n * å»¶è¿ŸåŒåˆ \n * @param\n * @return\n */\nprivate class doubleDelThread implements Callable<Result>{\n    private String id;\n    public doubleDelThread(String id) {\n        this.id = id;\n    }\n    @Override\n    public Result call() {\n        try {\n            Thread.sleep(DELAY_TIME);\n            stringRedisTemplate.delete(id);\n            log.debug(\"å»¶è¿Ÿ1ç§’åˆ é™¤\");\n            return Result.ok();\n        } catch (InterruptedException e) {\n            log.debug(\"å»¶è¿ŸåŒåˆ å‡ºé”™\");\n            return Result.fail(\"å»¶è¿ŸåŒåˆ å‡ºé”™\");\n        }\n    }\n}\n```\n\n**aop+æ³¨è§£**\n\n```java\n@Documented\n@Retention(RetentionPolicy.RUNTIME)\n@Target(ElementType.METHOD)\npublic @interface DelayDoubleDelete {\n    //å¿…é¡»å¡«å°±ä¸è¦å†™default\n    String redisKey();\n    int delayTime() default 1000;\n}\n```\nè¿™æ˜¯ç¬¬ä¸€æ¬¡å¼€å‘æ³¨è§£ï¼Œè¸©äº†ä¸å°‘å‘ï¼š\n- é¦–å…ˆaopåªèƒ½ä½œç”¨äºæ¥å£ä¸Šï¼Œæœªåœ¨æ¥å£ä¸­å£°æ˜çš„æˆå‘˜æ–¹æ³•æ˜¯ä¸ç”Ÿæ•ˆçš„ï¼Œå…·ä½“çš„å¯ä»¥çœ‹è¿™ç¯‡æ–‡ç« ï¼šhttps://blog.csdn.net/Show_line/article/details/136786252?ops_request_misc=&request_id=&biz_id=102&utm_term=aop%E5%BF%85%E9%A1%BB%E4%BD%9C%E7%94%A8%E4%BA%8E%E6%8E%A5%E5%8F%A3%E5%90%97&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduweb~default-1-136786252.142^v100^pc_search_result_base1&spm=1018.2226.3001.4187\n> gptçš„å›ç­”ä¹Ÿå¾ˆæœ‰æ„æ€ï¼šåœ¨ Spring ä¸­ï¼ŒAOP æ˜¯é€šè¿‡ä»£ç†å¯¹è±¡æ¥å®ç°çš„ï¼Œä»£ç†å¯¹è±¡çš„åˆ›å»ºæ–¹å¼æœ‰ä¸¤ç§ä¸»è¦æ¨¡å¼ï¼šJDK åŠ¨æ€ä»£ç†å’Œ CGLIB ä»£ç†ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒSpring ä¼šæ ¹æ®ç›®æ ‡ç±»æ˜¯å¦å®ç°äº†æ¥å£æ¥å†³å®šä½¿ç”¨å“ªç§ä»£ç†æœºåˆ¶ï¼š\n> 1. **JDK åŠ¨æ€ä»£ç†**ï¼šå¦‚æœç›®æ ‡ç±»å®ç°äº†ä¸€ä¸ªæˆ–å¤šä¸ªæ¥å£ï¼ŒSpring ä¼šä½¿ç”¨ JDK åŠ¨æ€ä»£ç†ã€‚JDK åŠ¨æ€ä»£ç†åªèƒ½ä»£ç†æ¥å£ä¸­çš„æ–¹æ³•ã€‚\n> 2. **CGLIB ä»£ç†**ï¼šå¦‚æœç›®æ ‡ç±»æ²¡æœ‰å®ç°ä»»ä½•æ¥å£ï¼ŒSpring ä¼šä½¿ç”¨ CGLIB æ¥ç”Ÿæˆç›®æ ‡ç±»çš„å­ç±»ï¼Œä»è€Œåˆ›å»ºä»£ç†å¯¹è±¡ã€‚CGLIB ä»£ç†å¯ä»¥ä»£ç†ç±»ä¸­çš„æ‰€æœ‰æ–¹æ³•ï¼ˆåŒ…æ‹¬æ²¡æœ‰åœ¨æ¥å£ä¸­å£°æ˜çš„æ–¹æ³•ï¼‰ã€‚\n\n> å¦‚æœæ‚¨åœ¨æŸä¸ªå®ç°ç±»çš„æˆå‘˜æ–¹æ³•ä¸Šä½¿ç”¨æ³¨è§£ä½†æ²¡æœ‰åœ¨æ¥å£ä¸­å£°æ˜è¯¥æ–¹æ³•ï¼Œè€Œè¯¥ç±»å®ç°äº†æ¥å£ï¼Œé‚£ä¹ˆé»˜è®¤æƒ…å†µä¸‹ï¼ŒSpring AOP ä½¿ç”¨ JDK åŠ¨æ€ä»£ç†ï¼Œå¯¼è‡´ä»£ç†å¯¹è±¡æ— æ³•æ‹¦æˆªå®ç°ç±»ä¸­æ²¡æœ‰åœ¨æ¥å£ä¸­å£°æ˜çš„æ–¹æ³•ã€‚è¿™æ˜¯å› ä¸º JDK åŠ¨æ€ä»£ç†åªèƒ½ä»£ç†æ¥å£ä¸­çš„æ–¹æ³•ã€‚\n> 1. **ä½¿ç”¨ CGLIB ä»£ç†**ï¼šæ˜ç¡®è¦æ±‚ Spring ä½¿ç”¨ CGLIB ä»£ç†ã€‚è¿™å¯ä»¥é€šè¿‡åœ¨ Spring é…ç½®ä¸­è®¾ç½®ä»£ç†æ¨¡å¼æ¥å®ç°ã€‚\n> 2. **ç¡®ä¿æ¥å£ä¸­å£°æ˜æ–¹æ³•**ï¼šå°†éœ€è¦ä»£ç†çš„æ–¹æ³•å£°æ˜åœ¨æ¥å£ä¸­ï¼Œä»¥ä¾¿ JDK åŠ¨æ€ä»£ç†èƒ½å¤Ÿæ­£å¸¸å·¥ä½œã€‚\n- å…¶æ¬¡æ˜¯ï¼Œæ³¨è§£æ˜¯æ— æ³•ç›´æ¥è®¿é—®è¢«æ³¨è§£æ–¹æ³•çš„å‚æ•°çš„ï¼Œä½†æ˜¯å¯ä»¥è¿›è¡Œéšå¼å¤„ç†ï¼ŒproceedingJoinPoint.getArgs();å¯ä»¥å¾—åˆ°è¿™ä¸ªå‡½æ•°çš„å‚æ•°ã€‚è¿™é‡Œç”¨äº†aroundï¼Œå› ä¸ºå»¶è¿ŸåŒåˆ é™¤åˆšå¥½æ˜¯æ‰§è¡Œä¸šåŠ¡çš„ä¸Šä¸‹\n```java\n@Aspect\n@Component\n@Slf4j\npublic class DelayDoubleDeleteAspect\n{\n    @Resource\n    private StringRedisTemplate stringRedisTemplate;\n    private ExecutorService shopDoubleDelThreadPool = Executors.newFixedThreadPool(4);\n    /**\n     * å»¶è¿ŸåŒåˆ \n     * @param\n     * @return\n     */\n    private class doubleDelThread implements Callable<Result> {\n        private String id;\n        private int DELAY_TIME;\n        public doubleDelThread(String id,int DELAY_TIME) {\n            this.id = id;\n            this.DELAY_TIME = DELAY_TIME;\n        }\n        @Override\n        public Result call() {\n            try {\n                Thread.sleep(DELAY_TIME);\n                stringRedisTemplate.delete(id);\n                log.debug(\"å»¶è¿Ÿ1ç§’åˆ é™¤\");\n                return Result.ok();\n            } catch (InterruptedException e) {\n                log.debug(\"å»¶è¿ŸåŒåˆ å‡ºé”™\");\n                return Result.fail(\"å»¶è¿ŸåŒåˆ å‡ºé”™\");\n            }\n        }\n    }\n\n    @Pointcut(\"@annotation(com.hmdp.annotation.DelayDoubleDelete)\")\n    public void pointCut(){\n\n    }\n\n    @Around(\"pointCut()\")\n    public Object aroundAdvice(ProceedingJoinPoint proceedingJoinPoint){\n        //æ–¹æ³•ç­¾å\n        MethodSignature signature = (MethodSignature) proceedingJoinPoint.getSignature();\n        //è¢«ç¯ç»•çš„æ–¹æ³•å\n        String methodName = signature.getName();\n        //æ–¹æ³•å‚æ•°\n        Object[] args = proceedingJoinPoint.getArgs();\n        Shop shop = (Shop) args[0];\n        //æ‰¾åˆ°æ³¨è§£\n        DelayDoubleDelete annotation = AnnotationUtil.getAnnotation(signature.getMethod(), DelayDoubleDelete.class);\n        String redisKey = annotation.redisKey();\n        int delayTime = annotation.delayTime();\n        stringRedisTemplate.delete(redisKey+shop.getId());\n        //proceedç”¨æ¥æ¥å—ä¸šåŠ¡äº§ç”Ÿçš„ç»“æœ\n        Object proceed = null;\n        //ç”±äºæœ€åä¸€ä¸ªåˆ é™¤æ˜¯è¦ä¸šåŠ¡éƒ½åšå®Œäº†ï¼Œæ‰€ä»¥éœ€è¦åœ¨ä¹‹åè¿›è¡Œçº¿ç¨‹æäº¤\n        try {\n            //ç»§ç»­ä¸šåŠ¡\n            proceed = proceedingJoinPoint.proceed();\n        } catch (Throwable e) {\n            throw new RuntimeException(e);\n        }\n        //æœ€ååˆ é™¤\n        shopDoubleDelThreadPool.submit(new doubleDelThread(redisKey+shop.getId(), delayTime));\n        //ä¸ç”¨ä¿®æ”¹ç›´æ¥è¿”å›\n        return proceed;\n    }\n}\n```\n\n### åˆ†å¸ƒå¼é”\n\n**å†™æ“ä½œ**\n```java\n/**\n     * åˆ†å¸ƒå¼é”\n     * @param shop\n     * @return\n     */\n    public Result updateShopLock(Shop shop) throws InterruptedException {\n        RLock lock = redissonClient.getLock(\"lock:shop:write\");\n        while (!lock.tryLock(1000,2000,TimeUnit.MILLISECONDS)){\n            Thread.sleep(100);\n        }\n        try {\n            //æ›´æ–°æ•°æ®åº“\n            updateById(shop);\n            stringRedisTemplate.delete(CACHE_SHOP + shop.getId().toString());\n            return Result.ok(shop);\n        }\n        finally {\n            lock.unlock();\n        }\n    }\n```\n\n**è¯»æ“ä½œ**\n\n```java\n@Override\npublic Result queryById(Long id) throws InterruptedException {\n    //è¯»å†™é”\n    RLock lock = redissonClient.getLock(\"lock:shop:write\");\n    while (!lock.tryLock(1000,2000,TimeUnit.MILLISECONDS)){\n        Thread.sleep(100);\n    }\n    try {\n        //return Result.ok(getById(id));\n        //1.å…ˆå»æŸ¥redis\n        String shopJsonStr = stringRedisTemplate.opsForValue().get(CACHE_SHOP + id);\n        //2.å¦‚æœredisæ²¡æœ‰å°±æ‰¾æ•°æ®åº“\n        if (shopJsonStr == null || shopJsonStr.isEmpty()){\n            //2.1 æ‰¾æ•°æ®åº“\n            Shop shop = getById(id);\n            //2.2 ç„¶åå†å†™å›redisé‡Œ\n            String jsonString = JSONUtil.toJsonStr(shop);\n            stringRedisTemplate.opsForValue().set(CACHE_SHOP + id,jsonString);\n            //è®¾ç½®30sçš„è¿‡æœŸæ—¶é—´\n            stringRedisTemplate.expire(CACHE_SHOP + id,30, TimeUnit.MINUTES);\n            return Result.ok(shop);\n        }\n        //3.å¦‚æœredisæœ‰å°±è¿”å›\n        else {\n            Shop shop = JSONUtil.toBean(shopJsonStr, Shop.class);\n            //åˆ·æ–°è¿‡æœŸæ—¶é—´\n            stringRedisTemplate.expire(CACHE_SHOP + id,30, TimeUnit.MINUTES);\n            return Result.ok(shop);\n        }\n    }\n    finally {\n        lock.unlock();\n    }\n\n}\n```\n","tags":["Redis"]},{"title":"redisé¡¹ç›®-åˆ†å¸ƒå¼é”","url":"/2024/05/30/redisé¡¹ç›®-åˆ†å¸ƒå¼é”/","content":"## ç§’æ€ä¸šåŠ¡\n\nç§’æ€ä¸‹å•åº”è¯¥æ€è€ƒçš„å†…å®¹ï¼š\n\nä¸‹å•æ—¶éœ€è¦åˆ¤æ–­ä¸¤ç‚¹ï¼š\n\n* ç§’æ€æ˜¯å¦å¼€å§‹æˆ–ç»“æŸï¼Œå¦‚æœå°šæœªå¼€å§‹æˆ–å·²ç»ç»“æŸåˆ™æ— æ³•ä¸‹å•\n* åº“å­˜æ˜¯å¦å……è¶³ï¼Œä¸è¶³åˆ™æ— æ³•ä¸‹å•\n\nä¸‹å•æ ¸å¿ƒé€»è¾‘åˆ†æï¼š\n\nå½“ç”¨æˆ·å¼€å§‹è¿›è¡Œä¸‹å•ï¼Œæˆ‘ä»¬åº”å½“å»æŸ¥è¯¢ä¼˜æƒ å·ä¿¡æ¯ï¼ŒæŸ¥è¯¢åˆ°ä¼˜æƒ å·ä¿¡æ¯ï¼Œåˆ¤æ–­æ˜¯å¦æ»¡è¶³ç§’æ€æ¡ä»¶\n\næ¯”å¦‚æ—¶é—´æ˜¯å¦å……è¶³ï¼Œå¦‚æœæ—¶é—´å……è¶³ï¼Œåˆ™è¿›ä¸€æ­¥åˆ¤æ–­åº“å­˜æ˜¯å¦è¶³å¤Ÿï¼Œå¦‚æœä¸¤è€…éƒ½æ»¡è¶³ï¼Œåˆ™æ‰£å‡åº“å­˜ï¼Œåˆ›å»ºè®¢å•ï¼Œç„¶åè¿”å›è®¢å•idï¼Œå¦‚æœæœ‰ä¸€ä¸ªæ¡ä»¶ä¸æ»¡è¶³åˆ™ç›´æ¥ç»“æŸã€‚\n\n![](../img/hmdp/img_3.png)\n\n> æœ€åŸºæœ¬çš„é€»è¾‘ï¼Œé¦–å…ˆåˆ¤æ–­æ—¶é—´å’Œåº“å­˜ï¼Œå†è¿›è¡Œåº“å­˜æ‰£å‡ï¼Œå¦‚æœæˆåŠŸæ‰£å‡åº“å­˜å°±ä¸‹è®¢å•\n\n```java\n@Override\npublic Result seckillVoucher(Long voucherId) {\n    // 1.æŸ¥è¯¢ä¼˜æƒ åˆ¸\n    SeckillVoucher voucher = seckillVoucherService.getById(voucherId);\n    // 2.åˆ¤æ–­ç§’æ€æ˜¯å¦å¼€å§‹\n    if (voucher.getBeginTime().isAfter(LocalDateTime.now())) {\n        // å°šæœªå¼€å§‹\n        return Result.fail(\"ç§’æ€å°šæœªå¼€å§‹ï¼\");\n    }\n    // 3.åˆ¤æ–­ç§’æ€æ˜¯å¦å·²ç»ç»“æŸ\n    if (voucher.getEndTime().isBefore(LocalDateTime.now())) {\n        // å°šæœªå¼€å§‹\n        return Result.fail(\"ç§’æ€å·²ç»ç»“æŸï¼\");\n    }\n    // 4.åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³\n    if (voucher.getStock() < 1) {\n        // åº“å­˜ä¸è¶³\n        return Result.fail(\"åº“å­˜ä¸è¶³ï¼\");\n    }\n    //5ï¼Œæ‰£å‡åº“å­˜\n    boolean success = seckillVoucherService.update()\n            .setSql(\"stock= stock -1\")\n            .eq(\"voucher_id\", voucherId).update();\n    if (!success) {\n        //æ‰£å‡åº“å­˜\n        return Result.fail(\"åº“å­˜ä¸è¶³ï¼\");\n    }\n    //6.åˆ›å»ºè®¢å•\n    VoucherOrder voucherOrder = new VoucherOrder();\n    // 6.1.è®¢å•id\n    long orderId = redisIdWorker.nextId(\"order\");\n    voucherOrder.setId(orderId);\n    // 6.2.ç”¨æˆ·id\n    Long userId = UserHolder.getUser().getId();\n    voucherOrder.setUserId(userId);\n    // 6.3.ä»£é‡‘åˆ¸id\n    voucherOrder.setVoucherId(voucherId);\n    save(voucherOrder);\n\n    return Result.ok(orderId);\n\n}\n```\n\n### è¶…å–é—®é¢˜\n> å¤šçº¿ç¨‹å¹¶å‘ï¼Œè¿™æ ·çš„é€»è¾‘å½“å‡ºç°æœ€åä¸€å¼ çš„æ—¶å€™å¤šä¸ªçº¿ç¨‹æ¶Œå…¥å°±ä¼šå˜æˆè´Ÿæ•°ï¼Œæ— éœ€å¤šè¨€\n\n### ä¸€äººä¸€å•\n\nå‡ ä¸ªé˜¶æ®µï¼š\n- æœ€ç®€å•é€»è¾‘ï¼Œåªè¦åŠ ä¸Šä¸€ä¸ªå¯¹äºè®¢å•çš„æŸ¥è¯¢å°±å¯ï¼ŒæŸ¥è¯¢æ¡ä»¶æ˜¯å½“å‰çš„ç”¨æˆ·idå’Œç§’æ€åˆ¸id\n- ä½†æ˜¯å‘ç°è¿™æ ·å¯¹äºä¸¤ä¸ªåŒç”¨æˆ·çš„çº¿ç¨‹è¿˜æ˜¯ä¼šé€ æˆä¸æ˜¯ä¸€äººä¸€å•çš„æƒ…å†µï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬éœ€è¦æ‚²è§‚é”\n```java\n@Transactional\npublic synchronized Result createVoucherOrder(Long voucherId) {\n    ...\n}\n```\n- é¦–å…ˆæ˜¯åŠ åœ¨æ–¹æ³•ä¸Šï¼Œè¿™æ ·ç²’åº¦æœ‰ç‚¹å¤§ï¼Œé”çš„æ˜¯æ•´ä¸ªæ–¹æ³•ï¼Œæˆ‘ä»¬è€ƒè™‘ç»†åŒ–é”ï¼Œç”¨ä»£ç å—ï¼Œé‚£ä¹ˆè¿™ä¸ªé”çš„å‚æ•°æ˜¯ä»€ä¹ˆå‘¢\n```java\n@Transactional\npublic  Result createVoucherOrder(Long voucherId) {\n\tLong userId = UserHolder.getUser().getId();\n\tsynchronized(userId.toString().intern()){\n        ...\n    }\n}\n```\n- å¯¹äºä¸€ä¸ªç”¨æˆ·çš„idè‚¯å®šæ˜¯å¯ä»¥äº’ç›¸åŒºåˆ†çš„ï¼Œæˆ‘ä»¬å°±é”è¿™ä¸ªidï¼Œä½†æ˜¯idçš„tostringæ–¹æ³•æ˜¯ä¸€ä¸ªnewçš„è¿‡ç¨‹ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬ç”¨tostringéƒ½æ˜¯ä¸€ä¸ªæ–°çš„ï¼Œè¿™ä¸ªæ—¶å€™éœ€è¦ç”¨jvmçš„çŸ¥è¯†äº†ï¼Œç›´æ¥åœ¨å­—ç¬¦ä¸²å¸¸é‡æ± é‡Œé¢æ‰¾åˆ°è¿™ä¸ªå¯¹è±¡ï¼Œè¿™æ ·å°±ç¡®ä¿äº†æ˜¯å”¯ä¸€çš„ä¸€ä¸ªå¯¹è±¡ã€‚\n```java\nsynchronized (user.getId().toString().intern()){\n    //ä»£ç†å¯¹è±¡æ˜¯springåœ¨åˆå§‹åŒ–çš„æ—¶å€™åŒ…è£…åœ¨æˆ‘ä»¬ç±»ä¸Šçš„å¦ä¸€ä¸ªç±»ï¼Œä»–ä¼šåœ¨ä»£ç†å¯¹è±¡ä¸­é€šè¿‡trycatchå®ç°äº‹åŠ¡\n    //é‚£ä¹ˆå¦‚æœæˆ‘ä»¬ç›´æ¥ä½¿ç”¨äº†proxyè¿™ä¸ªç±»ï¼Œå°±å¯ä»¥å¾—åˆ°äº‹åŠ¡çš„æ”¯æŒ\n    //é€šè¿‡aopå®ç°ï¼Œä½†æ˜¯è¦åœ¨å¯åŠ¨ç±»ä¸Šæš´éœ²aop\n    IVoucherOrderService proxy = (IVoucherOrderService) AopContext.currentProxy();\n    return proxy.createVoucherOrder(voucherId);\n}\n```\n- ä½†æ˜¯äº‹åŠ¡æ˜¯åœ¨é”çš„å¤–é¢çš„ï¼Œä¹Ÿå°±æ˜¯è¯´æœ‰å¯èƒ½é”é‡Šæ”¾äº†ä½†æ˜¯è¿˜æ²¡æœ‰å†™å…¥æ•°æ®åº“ï¼Œè¿™æ ·è¿˜æ˜¯æœ‰éšæ‚£ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†é”çš„èŒƒå›´æ¯”äº‹åŠ¡å¤§ï¼Œè€Œäº‹åŠ¡æ˜¯å†™åœ¨å‡½æ•°ä¸Šçš„ï¼Œé‚£ä¹ˆå°±éœ€è¦åœ¨è°ƒç”¨è¿™ä¸ªå‡½æ•°çš„åœ°æ–¹ä¸Šé”ï¼Œè€Œä¸æ˜¯åœ¨è¿™ä¸ªå‡½æ•°é‡Œé¢ä¸Šé”ã€‚\n- æœ€åéœ€è¦è®©äº‹åŠ¡ç”Ÿæ•ˆï¼Œè¦ç”¨åˆ°ä»£ç†å¯¹è±¡ï¼Œè¿™æ ·å°±æœ‰äº†ä¸€ä¸ªå®Œæ•´çš„æ–¹æ¡ˆã€‚\n```java\n@Service\npublic class VoucherOrderServiceImpl extends ServiceImpl<VoucherOrderMapper, VoucherOrder> implements IVoucherOrderService {\n    @Autowired\n    private ISeckillVoucherService seckillVoucherService;\n    @Autowired\n    private RedisIdWorker redisIdWorker;\n    @Autowired\n    private StringRedisTemplate stringRedisTemplate;\n\n    @Override\n    public Result seckillVoucher(Long voucherId) {\n        SeckillVoucher voucher = seckillVoucherService.getById(voucherId);\n        if (voucher.getBeginTime().isAfter(LocalDateTime.now())){\n            return Result.fail(\"ç§’æ€å°šæœªå¼€å§‹\");\n        }\n        if (voucher.getEndTime().isBefore(LocalDateTime.now())){\n            return Result.fail(\"ç§’æ€å·²ç»ç»“æŸ\");\n        }\n        if (voucher.getStock() < 1){\n            return Result.fail(\"åº“å­˜ä¸è¶³\");\n        }\n\n        //ä¸€äººä¸€å•ï¼Œæ˜¯åŒä¸€ä¸ªç”¨æˆ·çš„å¹¶å‘å®‰å…¨é—®é¢˜ï¼Œæ‰€ä»¥åŠ é”çš„æ˜¯userId\n        UserDTO user = UserHolder.getUser();\n\n        //åˆ†å¸ƒå¼é”\n        SimpleRedisLock lock = new SimpleRedisLock(stringRedisTemplate,\"order:\"+user.getId());\n        boolean isLock = lock.tryLock(1200);\n        //è¿™é‡Œå¦‚æœæ²¡æœ‰è·å–åˆ°é”ï¼Œè¯´æ˜æœ‰ä¸€ä¸ªç›¸åŒç”¨æˆ·idçš„äººå·²ç»åœ¨ä¸‹å•äº†ï¼Œæ‰€ä»¥ç›´æ¥è¿”å›ä¸å…è®¸é‡å¤\n        if (!isLock){\n            return Result.fail(\"ä¸å…è®¸é‡å¤ä¸‹å•\");\n        }\n        /*synchronized (user.getId().toString().intern()){\n            //ä»£ç†å¯¹è±¡æ˜¯springåœ¨åˆå§‹åŒ–çš„æ—¶å€™åŒ…è£…åœ¨æˆ‘ä»¬ç±»ä¸Šçš„å¦ä¸€ä¸ªç±»ï¼Œä»–ä¼šåœ¨ä»£ç†å¯¹è±¡ä¸­é€šè¿‡trycatchå®ç°äº‹åŠ¡\n            //é‚£ä¹ˆå¦‚æœæˆ‘ä»¬ç›´æ¥ä½¿ç”¨äº†proxyè¿™ä¸ªç±»ï¼Œå°±å¯ä»¥å¾—åˆ°äº‹åŠ¡çš„æ”¯æŒ\n            //é€šè¿‡aopå®ç°ï¼Œä½†æ˜¯è¦åœ¨å¯åŠ¨ç±»ä¸Šæš´éœ²aop\n            IVoucherOrderService proxy = (IVoucherOrderService) AopContext.currentProxy();\n            return proxy.createVoucherOrder(voucherId);\n        }*/\n        try {\n            IVoucherOrderService proxy = (IVoucherOrderService) AopContext.currentProxy();\n            return proxy.createVoucherOrder(voucherId);\n        }\n        finally {\n            lock.unlock();\n        }\n    }\n\n    /**\n     * äº‹åŠ¡çš„ä½œç”¨åŸŸè¦å°äºé”ï¼Œå¦åˆ™ä¼šå‡ºç°é”é‡Šæ”¾äº†è€Œäº‹åŠ¡æ²¡ç»“æŸï¼Œæœ‰å®‰å…¨éšæ‚£\n     * @param voucherId\n     * @return\n     */\n    @Transactional\n    @Override\n    public Result createVoucherOrder(Long voucherId){\n        //ä¸€äººä¸€å•\n        UserDTO user = UserHolder.getUser();\n        Integer count = lambdaQuery()\n                .eq(VoucherOrder::getUserId,user.getId())\n                .eq(VoucherOrder::getVoucherId,voucherId)\n                .count();\n        if (count>0){\n            return Result.fail(\"ç”¨æˆ·å·²ç»è´­ä¹°è¿‡äº†\");\n        }\n        //æ›´æ–°åº“å­˜\n        LambdaUpdateWrapper<SeckillVoucher> lambdaUpdateWrapper = new LambdaUpdateWrapper<>();\n        lambdaUpdateWrapper.setSql(\"stock = stock-1\")\n                .eq(SeckillVoucher::getVoucherId,voucherId)\n                .ge(SeckillVoucher::getStock,0);\n        boolean success = seckillVoucherService.update(lambdaUpdateWrapper);\n        if (!success){\n            return Result.fail(\"åº“å­˜ä¸è¶³\");\n        }\n        //åˆ›å»ºè®¢å•\n        long orderId = redisIdWorker.nextId(\"order\");\n        VoucherOrder voucherOrder = new VoucherOrder();\n        voucherOrder.setId(orderId);\n        voucherOrder.setVoucherId(voucherId);\n        voucherOrder.setUserId(user.getId());\n        save(voucherOrder);\n        return Result.ok(orderId);\n    }\n}\n```\n\n## åˆ†å¸ƒå¼é”\n\nå‡ ä¸ªé˜¶æ®µï¼š\n- åˆ†å¸ƒå¼é”æå‡ºæ˜¯ä¸ºäº†è§£å†³é”ä¸å¯è§çš„é—®é¢˜ï¼Œæœ‰äº†ä¸€ä¸ªå…¨å±€çš„é”å°±å¯ä»¥è¿›è¡Œè·¨æœåŠ¡å™¨çš„ä¸Šé”\n- ä¸»è¦çš„å®ç°æ“ä½œä¸ºsetnxï¼Œä¹Ÿå°±æ˜¯set if not existä¸ºä»€ä¹ˆè¿™ä¸ªæ“ä½œèƒ½å½“é”å‘¢ï¼Ÿå½“ç¬¬ä¸€ä¸ªçº¿ç¨‹setnxäº†ï¼Œé‚£ä¹ˆvalueå°±ä¼šæ˜¯è‡ªå·±çš„é‚£ä¸ªï¼Œå¹¶ä¸”è¿”å›ä¸ºçœŸã€‚å¦ä¸€ä¸ªçº¿ç¨‹åˆ°äº†ä¸Šé”çš„è¿™ä¸€æ®µï¼Œä¹Ÿsetnxï¼Œæ­¤æ—¶ç”±äºä»–è¦çš„keyå·²ç»æœ‰äº†å¦ä¸€ä¸ªå€¼ï¼Œä¸æ»¡è¶³not existï¼Œæ‰€ä»¥å°±è¿”å›å¦ï¼›è¿™ä¸ªçš„ä¸»è¦åŸå› è¿˜æ˜¯åœ¨äºsetnxæ˜¯ä¸€ä¸ªåŸå­å‘½ä»¤ï¼Œä¸€æ¬¡æ‰§è¡Œä¸€è¡Œå°±èƒ½æ»¡è¶³å¹¶å‘çš„éœ€æ±‚\n- ç¬¬ä¸€é˜¶æ®µï¼šæˆ‘ä»¬å°±ç”¨setnxæ¥å®Œæˆï¼Œä¸Šé”è¿‡ç¨‹ç›´æ¥å°†çº¿ç¨‹å·ä½œä¸ºå€¼ï¼Œè§£é”æ ¹æ®é”åç§°åˆ é™¤\n- ç¬¬äºŒé˜¶æ®µï¼šå¯èƒ½å‡ºç°è¿™æ ·ä¸€ç§æƒ…å†µï¼Œçº¿ç¨‹æ‹¿åˆ°é”ä»¥åå¡äº†ï¼Œè¿‡äº†é‡Šæ”¾æ—¶é—´é‡Šæ”¾ç»™å¦ä¸€ä¸ªçº¿ç¨‹ï¼Œæ­¤æ—¶çº¿ç¨‹1ç¼“è¿‡æ¥äº†ï¼Œæ‰§è¡Œåˆ°è§£é”è¿‡ç¨‹å°±æŠŠåˆ«äººçš„ç»™è§£é”äº†ã€‚è§£å†³æ–¹æ³•å¾ˆç®€å•ï¼Œåªè¦åˆ¤æ–­ç°åœ¨è¿™ä¸ªé”é‡Œé¢çš„å€¼æ˜¯ä¸æ˜¯è‡ªå·±çš„å°±å¯ä»¥\n- ç¬¬ä¸‰é˜¶æ®µï¼šå¦‚æœçº¿ç¨‹1åœ¨åˆ¤æ–­å®Œäº†ä¹‹åå¡äº†ï¼Œåˆ¤æ–­çš„ç»“æœç¡®å®æ˜¯è‡ªå·±çš„ï¼Œä½†æ˜¯åˆšå¥½è¶…æ—¶äº†ï¼Œè¿™ä¸ªæ—¶å€™åˆè¢«åˆ«äººæŠ¢èµ°äº†ï¼Œæœ€åé‡Šæ”¾çš„è¿˜æ˜¯åˆ«äººçš„é”ï¼Œè¿™æ˜¯å› ä¸ºé”ä¸æ˜¯åŸå­æ€§çš„ï¼Œæ£€æŸ¥æ˜¯å¦ä¸€è‡´å’Œé‡Šæ”¾è¦å˜æˆåŸå­æ“ä½œã€‚éœ€è¦ç”¨åˆ°luaè„šæœ¬\n- ç¬¬å››é˜¶æ®µï¼šç”¨åˆ°äº†luaè„šæœ¬å®Œæˆäº†åˆ¤æ–­\n```java\npublic class SimpleRedisLock implements ILock{\n    private StringRedisTemplate stringRedisTemplate;\n    private static final String KEY_PREFIX = \"lock:\";\n    private String name;\n    private static final String ID_PREFIX = UUID.randomUUID().toString(true) + \"-\";\n\n    public SimpleRedisLock(StringRedisTemplate stringRedisTemplate, String name) {\n        this.stringRedisTemplate = stringRedisTemplate;\n        this.name = name;\n    }\n\n    @Override\n    public boolean tryLock(long timeoutsec) {\n        //è¿™é‡ŒåŠ uuidæ˜¯å› ä¸ºåœ¨ä¸åŒæœºå™¨ä¸Šçš„çº¿ç¨‹æ ‡è¯†å¯èƒ½ä¸€è‡´\n        String id = ID_PREFIX+Thread.currentThread().getId();\n        Boolean b = stringRedisTemplate.opsForValue()\n                .setIfAbsent(KEY_PREFIX+name, id , timeoutsec, TimeUnit.SECONDS);\n        return Boolean.TRUE.equals(b);\n    }\n    private static final DefaultRedisScript<Long> UNLOCK_SCRIPT;\n    static {\n        UNLOCK_SCRIPT = new DefaultRedisScript<>();\n        UNLOCK_SCRIPT.setLocation(new ClassPathResource(\"unlock.lua\"));\n        UNLOCK_SCRIPT.setResultType(Long.class);\n    }\n    @Override\n    public void unlock() {\n        //lua\n        stringRedisTemplate.execute(UNLOCK_SCRIPT, Collections.singletonList(KEY_PREFIX+name),ID_PREFIX+Thread.currentThread().getId());\n\n    }\n\n    /**\n     * è¿™æ˜¯éåŸå­æ“ä½œçš„è§£é”\n     */\n    public void unlockNotSafe(){\n        //è¦åˆ¤æ–­æ˜¯ä¸æ˜¯å½“å‰çº¿ç¨‹æ‰èƒ½åˆ é™¤ï¼Œå¦åˆ™ä¼šè¯¯åˆ \n        String redisValue = stringRedisTemplate.opsForValue().get(KEY_PREFIX + name);\n        String id = ID_PREFIX+Thread.currentThread().getId();\n        if (id.equals(redisValue)){\n            stringRedisTemplate.delete(KEY_PREFIX+name);\n        }\n    }\n}\n\n```\n### æ‰‹å†™å¯é‡å…¥åˆ†å¸ƒå¼é”\n\n> ä¸reentrantLockç›¸ä¼¼ï¼Œå®ç°å¯é‡å…¥çš„è¿‡ç¨‹å°±æ˜¯ä¸€ä¸ªhashæ•°æ®ç»“æ„ï¼Œå°keyä¸ºçº¿ç¨‹idï¼Œå¤§keyä¸ºé”åå­—ï¼Œå€¼ä¸ºè¿›å…¥çš„æ¬¡æ•°ã€‚å¯é‡å…¥æŒ‡çš„æ˜¯ä¸€ä¸ªçº¿ç¨‹å¯ä»¥å¤šæ¬¡è·å¾—è¿™ä¸ªé”ï¼Œæ¯æ¬¡çº¿ç¨‹è¿›å…¥ï¼Œvalueéƒ½è¦+1ï¼ŒåŒç†ï¼Œå‡ºå»äº†å°±è¦-1ï¼Œè¦ä¿è¯æœ€åé€€å‡ºçš„æ—¶å€™ä¸º0.\n> \n> è¿™é‡Œä½¿ç”¨luaè„šæœ¬å®Œæˆï¼Œç¬¬ä¸€æ¬¡æ‰‹å†™é‡åˆ°äº†å¾ˆå¤šå›°éš¾ï¼Œä¸»è¦åŸå› æ˜¯ä¸€ä¸ªç©ºæŒ‡é’ˆå¼‚å¸¸ï¼Œä¼°è®¡æ˜¯å› ä¸ºæˆ‘ç”¨çš„æ¨¡æ¿æ˜¯stringRedisTemplateï¼Œæœ‰ä¸€ä¸ªlongç±»å‹çš„æ•°æ®ä¸€ç›´æŠ¥é”™ã€‚\n\nä¸»è¦æ€è·¯æ˜¯ï¼Œé¦–å…ˆçœ‹redisä¸­æ˜¯å¦æœ‰è¿™ä¸ªé”ï¼Œå¦‚æœæ²¡æœ‰å°±ç›´æ¥ä¸Šé”ã€‚å¦‚æœæœ‰çš„è¯è¿›ä¸€æ­¥æ£€æŸ¥çº¿ç¨‹å·æ˜¯å¦æ˜¯è‡ªå·±çš„ï¼Œå¦‚æœæ˜¯è‡ªå·±çš„å°±+1ï¼Œä¸æ˜¯çš„è¯å°±ç›´æ¥é€€å‡ºã€‚\n\n```lua\n---key[1]ä¸ºå¤§keyï¼Œargv[1]ä¸ºå°keyï¼Œargv[2]ä¸ºæ—¶é—´\n---å¦‚æœä¸å­˜åœ¨å¤§keyï¼Œå°±ç›´æ¥setnx\nif redis.call('exists',KEYS[1]) == 0 then\n    --- è®¾ç½®å€¼ä¸º1\n    redis.call('hset',KEYS[1],ARGV[1],1)\n    --- è®¾ç½®è¿‡æœŸæ—¶é—´\n    redis.call('pexpire',KEYS[1],ARGV[2])\n    return 1\nend\n---å¦‚æœæ²¡è¿›å…¥å‰é¢çš„åˆ¤æ–­ï¼Œé‚£ä¹ˆå°±æ˜¯å­˜åœ¨è¿™ä¸ªå¤§keyï¼Œè¦è¿›ä¸€æ­¥åˆ¤æ–­æ˜¯ä¸æ˜¯è‡ªå·±çš„key\nif redis.call('hexists',KEYS[1],ARGV[1]) == 1 then\n    redis.call('hincrby',KEYS[1],ARGV[1],1)\n    redis.call('pexpire',KEYS[1],ARGV[2])\n    return 1\nend\n--- å¦‚æœéƒ½æ²¡æœ‰å‡ºå»ï¼Œè¯´æ˜ä¸¤ä¸ªæ¡ä»¶éƒ½ä¸æ»¡è¶³ï¼Œä¸æ˜¯è‡ªå·±çš„é”ï¼Œéœ€è¦ç­‰å¾…ï¼Œè¿”å›å‰©ä½™çš„æ—¶é—´\nreturn 0\n```\n\nä¸»è¦æ€è·¯æ˜¯åˆ¤æ–­æ˜¯å¦æ˜¯è‡ªå·±çš„ï¼Œå¦‚æœä¸æ˜¯è‡ªå·±çš„ç›´æ¥é€€å‡ºï¼Œå¦‚æœæ˜¯è‡ªå·±çš„åœ¨åˆ¤æ–­æ˜¯å¦å‡åˆ°0äº†ï¼Œå¦‚æœå‡å°‘åˆ°0ç›´æ¥åˆ é™¤è¿™ä¸ªhash\n\n```lua\n--- åˆ¤æ–­æ˜¯å¦æ˜¯è‡ªå·±çš„ï¼Œç„¶ååœ¨åˆ¤æ–­æ˜¯å¦å‡æ‰ä¹‹åä¸º0ï¼Œä¸º0åˆ™åˆ é™¤\nif redis.call('hexists',KEYS[1],ARGV[1]) == 0 then\n    return 0\nelseif redis.call('hincrby',KEYS[1],ARGV[1],-1) == 0 then\n    redis.call('del',KEYS[1])\n    return 1\nelse\n    return 1\nend\n\n```\næ”¹è¿›åçš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š\n\n```java\n//å¯é‡å…¥çš„åˆ†å¸ƒå¼ä¸Šé”\nprivate static final DefaultRedisScript<Boolean> REENTRANTLOCK;\nstatic {\n    REENTRANTLOCK = new DefaultRedisScript<>();\n    REENTRANTLOCK.setLocation(new ClassPathResource(\"reentrantLock.lua\"));\n    REENTRANTLOCK.setResultType(Boolean.class);\n}\n//å¯é‡å…¥çš„åˆ†å¸ƒå¼è§£é”\nprivate static final DefaultRedisScript<Boolean> REENTRANTUNLOCK;\nstatic {\n    REENTRANTUNLOCK = new DefaultRedisScript<>();\n    REENTRANTUNLOCK.setResultType(Boolean.class);\n    REENTRANTUNLOCK.setLocation(new ClassPathResource(\"reentrantUnlock.lua\"));\n}\n\npublic String getId() {\n    return Thread.currentThread().getId() + \":\" + ID_PREFIX;\n}\n@Override\npublic boolean tryLock(long timeoutsec) throws InterruptedException {\n    Boolean execute = stringRedisTemplate.execute(REENTRANTLOCK, Collections.singletonList(KEY_PREFIX+lockName), getId(), timeoutsec+\"\");\n    if (Boolean.TRUE.equals(execute)){\n        //å¼€å¯çœ‹é—¨ç‹—çº¿ç¨‹\n        WatchDogThread watchDogThread = new WatchDogThread(stringRedisTemplate,KEY_PREFIX + lockName);\n        watchDogThreadThreadLocal.set(watchDogThread);\n        watchDogThread.start();\n        log.debug(\"å¼€å¯çœ‹é—¨ç‹—è¿›ç¨‹\");\n        return true;\n    }\n    else {\n        return false;\n    }\n}\n\n@Override\npublic void unlock() {\n    long ThreadId = Thread.currentThread().getId();\n    Boolean execute = stringRedisTemplate.execute(REENTRANTUNLOCK, Collections.singletonList(KEY_PREFIX + lockName), getId());\n    if (Boolean.FALSE.equals(execute)) {\n        throw new IllegalMonitorStateException(\"è§£é”å¤±è´¥ï¼Œè¿™ä¸æ˜¯ä½ çš„é”\");\n    }\n    // åœæ­¢çœ‹é—¨ç‹—\n    WatchDogThread watchDogThread = watchDogThreadThreadLocal.get();\n    watchDogThread.interrupt();\n    log.debug(\"åœæ­¢çœ‹é—¨ç‹—è¿›ç¨‹\");\n    watchDogThreadThreadLocal.remove();\n\n\n}\n```\n\n### çœ‹é—¨ç‹—æœºåˆ¶\n\nå¼€å¯ä¸€ä¸ªçº¿ç¨‹ç›‘è§†ttlï¼Œå¦‚æœåˆ°äº†æŸä¸ªé˜ˆå€¼ç¨‹åºè¿˜æ²¡ç»“æŸå°±ç»­æœŸ\n\n```java\nstatic class WatchDogThread extends Thread {\n\n    private String watchKey;\n    private StringRedisTemplate stringRedisTemplate;\n\n    WatchDogThread(StringRedisTemplate redisTemplate, String key) {\n        this.stringRedisTemplate = redisTemplate;\n        this.watchKey = key;\n    }\n\n    @Override\n    public void run() {\n        while (!Thread.interrupted()) {\n            try {\n                Long expire = stringRedisTemplate.getExpire(watchKey, TimeUnit.MILLISECONDS);\n                //5ç§’é’Ÿç»­2ç§’\n                if (expire != null && expire.intValue() < 300) {\n                    stringRedisTemplate.expire(watchKey, 1, TimeUnit.SECONDS);\n                }\n\n            } catch (RedisSystemException e) {\n            }\n\n        }\n    }\n}\n```\n\n> å‰©ä¸‹çš„å†…å®¹æˆ‘è§‰å¾—ä»–è¯¾ç¨‹æ²¡å•¥ç”¨ï¼Œè‡ªå·±ç”¨æ¶ˆæ¯é˜Ÿåˆ—å°±è§£å†³äº†ï¼Œæ²¡å•¥æŠ€æœ¯å«é‡å°±ä¸å†™ï¼Œä¸»è¦æ˜¯è§£è€¦çš„æ“ä½œã€‚\n> æ”¹é€ åå°±å˜æˆäº†å‰é¢æ ¡éªŒå®Œå…¨ç”¨luaè„šæœ¬ï¼Œä¿è¯åŸå­æ€§çš„åŒæ—¶ä¹Ÿä¸ç”¨ä¸Šé”äº†ï¼Œå› ä¸ºredisæ˜¯å•çº¿ç¨‹ã€‚æœ‰è®¢å•çš„å°±mqï¼Œkafkaå¤„ç†ã€‚\n> è¯¾ç¨‹ä¹Ÿæœ‰å¯å–ä¹‹å¤„ï¼ŒBlockingQueueæ˜¯æˆ‘ç¬¬ä¸€æ¬¡è§ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªç®€æ˜“ç‰ˆæœ¬çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œåœ¨é˜Ÿåˆ—ä¸ºç©ºçš„æ—¶å€™ä¼šé˜»å¡æ¶ˆè´¹è€…è¿›ç¨‹ï¼Œæ»¡çš„æ—¶å€™ä¼šé˜»å¡ç”Ÿäº§è€…è¿›ç¨‹ã€‚\n","tags":["Redis"]},{"title":"redisé¡¹ç›®-ç™»å½•é€»è¾‘","url":"/2024/05/30/redisé¡¹ç›®-ç™»å½•é€»è¾‘/","content":"> æ¯•ä¸šè®¾è®¡å’Œå„ç§è€ƒè¯•è€½æäº†å¿«ä¸¤ä¸ªæœˆäº†ï¼Œçªç„¶æ„è¯†åˆ°å†ä¸ç»§ç»­å­¦è·Ÿæˆ‘çš„æƒ³æ³•å°±ä¼šè¶Šèµ°è¶Šè¿œäº†ï¼Œé‚å¼€å§‹é»‘é©¬ç‚¹è¯„çš„å­¦ä¹ \n\n## åŸºäºsessionå®ç°ç™»å½•\n\n**å‘é€éªŒè¯ç **\n\né¦–å…ˆæ ¡éªŒæ‰‹æœºå·ï¼Œé€šè¿‡æ­£åˆ™è¡¨è¾¾å¼ï¼Œç„¶åå†éšæœºç”Ÿæˆä¸€ä¸ªé•¿åº¦ä¸º6çš„å­—ç¬¦ä¸²ï¼Œä¿å­˜åœ¨sessionä¸­\n\n**ç™»å½•æ³¨å†Œ**\n\nå¦‚æœè¾“å…¥çš„éªŒè¯ç å’Œå­˜åœ¨sessionä¸­çš„æ˜¯ä¸€æ ·çš„ï¼Œé‚£ä¹ˆå°±é€šè¿‡æ ¡éªŒæ‰¾å¯¹åº”çš„userå®ä½“ç±»ï¼Œuserä¸ºç©ºå°±ç›´æ¥æ³¨å†Œï¼ˆä¹Ÿå°±æ˜¯insertï¼‰ï¼Œç„¶åå°†useræ”¾åœ¨sessionä¸­\n\n**æ£€éªŒç™»å½•çŠ¶æ€**\n\nç”¨æˆ·åœ¨è¯·æ±‚æ—¶å€™ï¼Œä¼šä»cookieä¸­æºå¸¦è€…JsessionIdåˆ°åå°ï¼Œåå°é€šè¿‡JsessionIdä»sessionä¸­æ‹¿åˆ°ç”¨æˆ·ä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰sessionä¿¡æ¯ï¼Œåˆ™è¿›è¡Œæ‹¦æˆªï¼Œå¦‚æœæœ‰sessionä¿¡æ¯ï¼Œåˆ™å°†ç”¨æˆ·ä¿¡æ¯ä¿å­˜åˆ°threadLocalä¸­ï¼Œå¹¶ä¸”æ”¾è¡Œ\n\n![](../img/hmdp/img.png)\n\n### å‘é€éªŒè¯ç \n> Todoï¼šåç»­å¯ä»¥æ ¹æ®Ruoyié‚£ä¸ªå›¾ç‰‡éªŒè¯ç æ”¹è¿›ï¼Œä½†æ˜¯é€»è¾‘éƒ½å·®ä¸å¤š\n```java\n@Override\npublic Result sendCode(String phone, HttpSession session) {\n    // 1.æ ¡éªŒæ‰‹æœºå·\n    if (RegexUtils.isPhoneInvalid(phone)) {\n        // 2.å¦‚æœä¸ç¬¦åˆï¼Œè¿”å›é”™è¯¯ä¿¡æ¯\n        return Result.fail(\"æ‰‹æœºå·æ ¼å¼é”™è¯¯ï¼\");\n    }\n    // 3.ç¬¦åˆï¼Œç”ŸæˆéªŒè¯ç \n    String code = RandomUtil.randomNumbers(6);\n\n    // 4.ä¿å­˜éªŒè¯ç åˆ° session\n    session.setAttribute(\"code\",code);\n    // 5.å‘é€éªŒè¯ç \n    log.debug(\"å‘é€çŸ­ä¿¡éªŒè¯ç æˆåŠŸï¼ŒéªŒè¯ç ï¼š{}\", code);\n    // è¿”å›ok\n    return Result.ok();\n}\n```\n\n### ç™»å½•\n\n```java\n@Override\npublic Result login(LoginFormDTO loginForm, HttpSession session) {\n    // 1.æ ¡éªŒæ‰‹æœºå·\n    String phone = loginForm.getPhone();\n    if (RegexUtils.isPhoneInvalid(phone)) {\n        // 2.å¦‚æœä¸ç¬¦åˆï¼Œè¿”å›é”™è¯¯ä¿¡æ¯\n        return Result.fail(\"æ‰‹æœºå·æ ¼å¼é”™è¯¯ï¼\");\n    }\n    // 3.æ ¡éªŒéªŒè¯ç \n    Object cacheCode = session.getAttribute(\"code\");\n    String code = loginForm.getCode();\n    if(cacheCode == null || !cacheCode.toString().equals(code)){\n         //3.ä¸ä¸€è‡´ï¼ŒæŠ¥é”™\n        return Result.fail(\"éªŒè¯ç é”™è¯¯\");\n    }\n    //ä¸€è‡´ï¼Œæ ¹æ®æ‰‹æœºå·æŸ¥è¯¢ç”¨æˆ·\n    User user = query().eq(\"phone\", phone).one();\n\n    //5.åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨\n    if(user == null){\n        //ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»º\n        user =  createUserWithPhone(phone);\n    }\n    //7.ä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ°sessionä¸­\n    session.setAttribute(\"user\",user);\n\n    return Result.ok();\n}\n```\n\n### æ‹¦æˆª\n> åˆå§‹ç‰ˆæœ¬çœ‹sessionä¸­æ˜¯å¦æœ‰userå¯¹è±¡ï¼Œå¦‚æœæœ‰å°±æŠŠä»–æ”¾åˆ°ThreadLocalä¸­ï¼Œæ–¹ä¾¿åç»­è°ƒç”¨ï¼Œä¸ºä»€ä¹ˆä¸æ¯æ¬¡éƒ½åœ¨sessionä¸­å–å‘¢ï¼Ÿæˆ‘çŒœæ˜¯å› ä¸ºhttpçš„requestä¸æ˜¯éšæ—¶éšåœ°å“ªä¸ªæ–¹æ³•éƒ½è¦å†™çš„ï¼Œthreadlocalå¯ä»¥æ¯”è¾ƒæ–¹ä¾¿\n\nå…ˆå†™ç™»å½•çš„æ‹¦æˆªå™¨ï¼Œç”±äºè¦è¿›è¡Œå¤„ç†ï¼Œå°±è·Ÿaopä¸€æ ·ï¼Œæœ‰ä¸€ä¸ªpreæœ‰ä¸€ä¸ªafterï¼Œå®ç°çš„æ˜¯HandlerInterceptor\n\n```java\npublic class LoginInterceptor implements HandlerInterceptor {\n\n    @Override\n    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {\n        //1.è·å–session\n        HttpSession session = request.getSession();\n        //2.è·å–sessionä¸­çš„ç”¨æˆ·\n        Object user = session.getAttribute(\"user\");\n        //3.åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨\n        if(user == null){\n            //4.ä¸å­˜åœ¨ï¼Œæ‹¦æˆªï¼Œè¿”å›401çŠ¶æ€ç \n            response.setStatus(401);\n            return false;\n        }\n        //5.å­˜åœ¨ï¼Œä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ°Threadlocal\n        UserHolder.saveUser((User)user);\n        //6.æ”¾è¡Œ\n        return true;\n    }\n}\n```\n\næœ‰äº†è¿™ä¸ªæ‹¦æˆªå™¨ä½†æ˜¯è¿˜è¦è®©ä»–ç”Ÿæ•ˆï¼Œè¢«springmvcç®¡ç†ï¼Œéœ€è¦ä¸€ä¸ªé…ç½®æ–‡ä»¶\n\n```java\npackage com.hmdp.config;\n\nimport com.hmdp.interceptor.LoginInterceptor;\nimport com.hmdp.interceptor.RefreshInterceptor;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.data.redis.core.StringRedisTemplate;\nimport org.springframework.web.servlet.config.annotation.InterceptorRegistry;\nimport org.springframework.web.servlet.config.annotation.WebMvcConfigurer;\n\nimport javax.annotation.Resource;\n\n@Configuration\npublic class MvcConfig implements WebMvcConfigurer {\n    @Autowired\n    private StringRedisTemplate stringRedisTemplate;\n    @Override\n    public void addInterceptors(InterceptorRegistry registry) {\n        // ç™»å½•æ‹¦æˆªå™¨\n        registry.addInterceptor(new LoginInterceptor())\n                .excludePathPatterns(\n                        \"/shop/**\",\n                        \"/voucher/**\",\n                        \"/shop-type/**\",\n                        \"/upload/**\",\n                        \"/blog/hot\",\n                        \"/user/code\",\n                        \"/user/login\"\n                ).order(1);\n        // tokenåˆ·æ–°çš„æ‹¦æˆªå™¨\n        registry.addInterceptor(new RefreshInterceptor(stringRedisTemplate)).addPathPatterns(\"/**\").order(0);\n    }\n}\n```\n\nWebMvcConfigureré…ç½®ç±»å…¶å®æ˜¯Springå†…éƒ¨çš„ä¸€ç§é…ç½®æ–¹å¼ï¼Œé‡‡ç”¨JavaBeançš„å½¢å¼æ¥ä»£æ›¿ä¼ ç»Ÿçš„xmlé…ç½®æ–‡ä»¶å½¢å¼è¿›è¡Œé’ˆå¯¹æ¡†æ¶ä¸ªæ€§åŒ–å®šåˆ¶ï¼Œå¯ä»¥è‡ªå®šä¹‰ä¸€äº›Handlerï¼ŒInterceptorï¼ŒViewResolverï¼ŒMessageConverterã€‚åŸºäºjava-basedæ–¹å¼çš„spring mvcé…ç½®ï¼Œéœ€è¦åˆ›å»ºä¸€ä¸ªé…ç½®ç±»å¹¶å®ç°WebMvcConfigurer æ¥å£ï¼›\n\nå¸¸ç”¨çš„æ–¹æ³•ï¼š\n\n**addInterceptorsï¼šæ‹¦æˆªå™¨**\n\n- addInterceptorï¼šéœ€è¦ä¸€ä¸ªå®ç°HandlerInterceptoræ¥å£çš„æ‹¦æˆªå™¨å®ä¾‹\n- addPathPatternsï¼šç”¨äºè®¾ç½®æ‹¦æˆªå™¨çš„è¿‡æ»¤è·¯å¾„è§„åˆ™ï¼›addPathPatterns(\"/**\")å¯¹æ‰€æœ‰è¯·æ±‚éƒ½æ‹¦æˆª\n- excludePathPatternsï¼šç”¨äºè®¾ç½®ä¸éœ€è¦æ‹¦æˆªçš„è¿‡æ»¤è§„åˆ™\n- æ‹¦æˆªå™¨ä¸»è¦ç”¨é€”ï¼šè¿›è¡Œç”¨æˆ·ç™»å½•çŠ¶æ€çš„æ‹¦æˆªï¼Œæ—¥å¿—çš„æ‹¦æˆªç­‰ã€‚\n\n**addViewControllersï¼šé¡µé¢è·³è½¬**\n\næ‹¦æˆªåˆ°ä¸€ä¸ªè·¯å¾„å°±è·³è½¬åˆ°å¯¹åº”çš„é¡µé¢\n\n```java\n@Override\npublic void addViewControllers(ViewControllerRegistry registry) {\n    registry.addViewController(\"/toLogin\").setViewName(\"login\");\n}\n```\n\nè¿™ä¸ªæ–¹æ³•æ„æ€ä¼°è®¡å°±æ˜¯å½“/toLogin\"è·¯å¾„çš„æ—¶å€™è·³è½¬åˆ°loginé¡µé¢\n\n> Todoï¼šä»¥åæ…¢æ…¢è¡¥å……\n\n## Redisä»£æ›¿sessionçš„ä¸šåŠ¡\n> codeå’Œuseréƒ½å­˜åœ¨sessionä¸­ï¼Œè€Œsessionæ˜¯æœ¬åœ°çš„ï¼Œåœ¨é›†ç¾¤æ¨¡å¼ä¸‹ä¼šå¤±æ•ˆï¼Œæ‰€ä»¥éœ€è¦ä¸€ä¸ªå…¨å±€çš„è§£å†³æ–¹æ¡ˆã€‚\n\nåŸºæœ¬çš„è§£å†³æ€è·¯å°±æ˜¯æŠŠéªŒè¯ç å’Œuseréƒ½å­˜åœ¨redisé‡Œé¢ï¼Œè®¾å®šè¿‡æœŸæ—¶é—´ï¼Œæ‹¦æˆªå™¨å˜æˆç»­æœŸå³å¯ã€‚æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯ä»¥ä»€ä¹ˆæ•°æ®ç»“æ„æ¥å­˜ã€‚codeå¯ä»¥ä»¥stringç±»å‹æ¥å­˜å‚¨ã€‚\nuserå…¶å®ä¹Ÿå¯ä»¥ï¼Œæˆ‘è¿™é‡ŒåŸæœ¬æƒ³çš„æ˜¯ç”¨JSONå­˜ï¼Œä½†æ˜¯ä¸å¤Ÿç›´è§‚ï¼Œè€Œä¸”å­˜å‚¨æ•ˆç‡ä¹Ÿæ²¡æœ‰hashå¥½ï¼Œæ‰€ä»¥è¿˜æ˜¯è·Ÿç€ä»–ç”¨äº†hashã€‚\n\n![](../img/hmdp/img_1.png)\n\n```java\n@Service\n@Slf4j\npublic class UserServiceImpl extends ServiceImpl<UserMapper, User> implements IUserService {\n    @Autowired\n    private StringRedisTemplate redisTemplate;\n\n    @Override\n    public Result sendCode(String phone, HttpSession session) {\n        if (RegexUtils.isPhoneInvalid(phone)){\n            return Result.fail(\"æ‰‹æœºå·æ ¼å¼é”™è¯¯\");\n        }\n        String code = RandomUtil.randomNumbers(6);\n        //è¿™é‡Œç”¨Rediså®Œæˆ\n        //session.setAttribute(\"code\",code);\n        redisTemplate.opsForValue().set(redisConstants.LOGINREDISCODE + phone,code, 60,TimeUnit.SECONDS);\n        log.debug(\"éªŒè¯ç ä¸ºï¼š\"+code);\n        return Result.ok();\n    }\n\n    @Override\n    public Result login(LoginFormDTO loginForm, HttpSession session) {\n        if (RegexUtils.isPhoneInvalid(loginForm.getPhone())||RegexUtils.isCodeInvalid(loginForm.getCode())){\n            return Result.fail(\"æ‰‹æœºå·æ ¼å¼é”™è¯¯\");\n        }\n        //è¿™é‡Œæ”¹ç”¨Redis\n        //String sessionCode = session.getAttribute(\"code\").toString();\n        String code = redisTemplate.opsForValue().get(redisConstants.LOGINREDISCODE + loginForm.getPhone());\n        if (code == null || !loginForm.getCode().equals(code)){\n            return Result.fail(\"éªŒè¯ç æœ‰è¯¯\");\n        }\n        LambdaQueryWrapper<User> lambdaQueryWrapper = new LambdaQueryWrapper<>();\n        lambdaQueryWrapper.eq(User::getPhone,loginForm.getPhone());\n        User user = getOne(lambdaQueryWrapper);\n        if (user == null){\n            User temp = new User();\n            temp.setPhone(loginForm.getPhone());\n            save(temp);\n            user = temp;\n        }\n        String token = UUID.randomUUID(true).toString();\n        //ç”¨jsonå­˜å‚¨\n        //String jsonStr = JSONUtil.toJsonStr(user);\n        //ç”¨hashå­˜å‚¨\n        UserDTO userDTO = BeanUtil.copyProperties(user, UserDTO.class);\n        Map<String, Object> userMap = BeanUtil.beanToMap(userDTO, new HashMap<>(),\n                CopyOptions.create()\n                        .setIgnoreNullValue(true)\n                        .setFieldValueEditor((fieldName, fieldValue) -> fieldValue.toString()));\n\n        redisTemplate.opsForHash().putAll(redisConstants.LOGINUSER+token,userMap);\n        redisTemplate.expire(redisConstants.LOGINUSER,30,TimeUnit.MINUTES);\n        return Result.ok(token);\n    }\n}\n```\n\n> ä¸»è¦å°±æ˜¯ç”¨äº†redisTemplateçš„ä¸¤ç§æ–¹æ³•ï¼Œstringç±»å‹çš„å°±ç”¨opsForValueï¼Œhashç”¨opsForHashï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯è¿™é‡ŒputAllæ˜¯å°†ä¸€ä¸ªmapå…¨éƒ¨å­˜è¿›å»ï¼Œåªæœ‰ä¸¤ä¸ªå‚æ•°ï¼Œè€Œputå¯èƒ½æŒ‡çš„æ˜¯**åœ¨è¿™ä¸ªkeyä¸‹çš„mapä¸­çš„å…¶ä¸­ä¸€è¡Œ**ï¼Œä¹Ÿå°±æ˜¯è¯´æœ‰ä¸‰ä¸ªå‚æ•°ï¼Œkeyï¼Œnameå’Œvalueã€‚\n> \n> è¿™é‡Œçš„beanToMapä¸»è¦è®°ä½setFieldValueEditoræ˜¯ç¼–è¾‘åŸŸçš„ï¼Œé‚£å½“ç„¶æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œä¿®æ”¹å¯¹åº”fieldNameä¸‹çš„fieldValue\n> \n> è¿˜æœ‰ä¸€ä¸ªæ˜¯setFieldNameEditorç¼–è¾‘nameçš„ï¼Œæ¯”å¦‚ä½ æƒ³è®©nameå˜æˆå¤§å†™ï¼Œå°±ç”¨UpperCase\n\n## è§£å†³ç™»å½•åˆ·æ–°é—®é¢˜\n> æˆ‘ä»¬ä¹‹å‰çš„æ‹¦æˆªå™¨ä¼šæ’é™¤ä¸€äº›è·¯å¾„è¿›è¡Œåˆ·æ–°ï¼Œä½†æ˜¯æˆ‘ä»¬è¦è¿™äº›è·¯å¾„è¢«è®¿é—®çš„æ—¶å€™ä¹Ÿè¦åˆ·æ–°ï¼Œæ‰€ä»¥é€‰æ‹©äº†è¿ä¸ªæ‹¦æˆªå™¨çš„æ–¹æ¡ˆï¼Œå…¶ä¸­ç¬¬ä¸€ä¸ªå®Œæˆæ‰€æœ‰redisçš„ç»­æœŸï¼Œåé¢ä¸€ä¸ªå»¶ç»­æ‹¦æˆªæŒ‡å®šè·¯å¾„æ ¡éªŒç™»å½•çŠ¶æ€ã€‚\n\n![](../img/hmdp/img_2.png)\n\n```java\n@Slf4j\npublic class RefreshInterceptor implements HandlerInterceptor {\n    private StringRedisTemplate stringRedisTemplate;\n    public RefreshInterceptor(StringRedisTemplate stringRedisTemplate) {\n        this.stringRedisTemplate = stringRedisTemplate;\n    }\n\n    @Override\n\n    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {\n        //1.æ£€éªŒæ˜¯å¦æœ‰token\n        String token = request.getHeader(\"authorization\");\n        if (token == null || token.isEmpty()){\n            //1.1 å¦‚æœæ²¡æœ‰tokenç›´æ¥æ”¾è¡Œç»™ä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨ï¼Œè¿™æ ·è‚¯å®šä¼šè¢«æ‹¦æˆª\n            return true;\n        }\n        //2.æ£€éªŒæ˜¯å¦åœ¨redisä¸­\n        //entrieså¾—åˆ°çš„æ˜¯ä¸€ä¸ªmapï¼ŒgetæŸ¥å…·ä½“çš„ï¼Œæ‰€ä»¥æœ‰ä¸¤ä¸ªå‚æ•°keyå’ŒfieldName\n        Map<Object, Object> objectMap = stringRedisTemplate.opsForHash().entries(redisConstants.LOGINUSER + token);\n        if (objectMap.isEmpty()){\n            return true;\n        }\n        UserDTO dto = BeanUtil.mapToBean(objectMap, UserDTO.class, CopyOptions.create());\n        //3.ä¿å­˜åœ¨threadLocalä¸­\n\n        //UserDTO userDTO = BeanUtil.fillBeanWithMap(objectMap, new UserDTO(), false);\n        log.debug(dto.toString());\n        UserHolder.saveUser(dto);\n        //4.åˆ·æ–°æ—¶é—´\n        stringRedisTemplate.expire(redisConstants.LOGINUSER + token,30, TimeUnit.MINUTES);\n        return true;\n    }\n    @Override\n    public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception {\n        // ç§»é™¤ç”¨æˆ·\n        UserHolder.removeUser();\n    }\n}\n\n```\n\n```java\n@Slf4j\npublic class LoginInterceptor implements HandlerInterceptor {\n    @Override\n    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {\n        UserDTO user = UserHolder.getUser();\n        if (user == null){\n            response.setStatus(401);\n            return false;\n        }\n        log.debug(\"å½“å‰ç”¨æˆ·:\"+user.getNickName());\n        return true;\n    }\n}\n```\n","tags":["Redis"]},{"title":"java-è™šæ‹Ÿæœºï¼ˆä¸Šï¼‰","url":"/2024/04/08/java-è™šæ‹Ÿæœºï¼ˆä¸Šï¼‰/","content":"# JVMç»„æˆ\næŒ‰ç…§å¤§çš„æ¥åˆ†å¯ä»¥åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼š\n1. ç±»åŠ è½½å™¨ï¼Œç”±äºjavaæ˜¯çº¯é¢å‘å¯¹è±¡è¯­è¨€ï¼Œç±»åŠ è½½å™¨ä¼šæŠŠjavaç±»è½¬æ¢æˆæˆå­—èŠ‚ç \n2. è¿è¡Œæ—¶æ•°æ®åŒºï¼ˆå†…å­˜åˆ†åŒºï¼‰ï¼šå†ç»†åˆ†å¯ä»¥åˆ†ä¸ºå…±äº«çš„æ–¹æ³•åŒºå’Œå †ï¼Œçº¿ç¨‹ä¸å…±äº«çš„è™šæ‹Ÿæœºæ ˆå’Œæœ¬åœ°æ–¹æ³•æ ˆï¼Œè¿˜æœ‰æ¯ä¸ªçº¿ç¨‹çš„æŒ‡é’ˆ\n3. æ‰§è¡Œå¼•æ“ï¼šå°†ä¸­é—´ä»£ç è½¬æ¢æˆæœºå™¨æŒ‡ä»¤ï¼ˆx86ï¼Œarmç­‰ï¼‰\n4. æœ¬åœ°åº“æ¥å£\n\n# è¿è¡Œæ—¶æ•°æ®åŒºè¯¦ç»†ä»‹ç»\n- å †ï¼ˆçº¿ç¨‹å…±äº«ï¼‰\n- æ–¹æ³•åŒºï¼ˆçº¿ç¨‹å…±äº«ï¼‰\n- ç¨‹åºè®¡æ•°å™¨ï¼ˆçº¿ç¨‹ç‹¬å ï¼‰\n- è™šæ‹Ÿæœºæ ˆï¼ˆçº¿ç¨‹ç‹¬å ï¼‰\n- æœ¬åœ°æ–¹æ³•æ ˆï¼ˆçº¿ç¨‹ç‹¬å ï¼‰\n## ç¨‹åºè®¡æ•°å™¨\nå°±å¦‚åŒcpuä¸­çš„pcï¼Œè™šæ‹Ÿæœºä¸­ä¹Ÿæœ‰å¯¹åº”ä»£ç çš„pcï¼Œä¸ºäº†å®ç°å¹¶å‘ï¼Œæ¯ä¸€ä¸ªçº¿ç¨‹ç¨‹åºè¿è¡Œåˆ°å“ªé‡Œéƒ½ä¸ä¸€æ ·ï¼Œä¹Ÿå°±éœ€è¦ä¿å­˜ï¼Œæ¢å¤ä¸Šä¸‹æ–‡ä¹Ÿæ–¹ä¾¿ã€‚æ‰€ä»¥åœ¨jvmä¸­ç¨‹åºè®¡æ•°å™¨æ˜¯ç§æœ‰çš„ã€‚\n\næ³¨æ„ï¼špcæ˜¯å”¯ä¸€ä¸€ä¸ªä¸ä¼šå‘ç”ŸOOMçš„å†…å­˜åŒºåŸŸï¼Œä¼°è®¡æ˜¯å› ä¸ºæœ¬æ¥å°±æ”¾ä¸€ä¸ªæŒ‡é’ˆï¼Œå†æ€ä¹ˆæ ·ä¹Ÿè¶…ä¸å‡ºå»ã€‚ç”Ÿå­˜å‘¨æœŸï¼Œéšç€çº¿ç¨‹çš„åˆ›å»ºè€Œåˆ›å»ºï¼Œéšç€çº¿ç¨‹æ­»äº¡è€Œæ­»äº¡ã€‚\n\n## è™šæ‹Ÿæœºæ ˆ\nè¿™é‡Œçš„è™šæ‹Ÿæœºæ ˆè·ŸçœŸå®çš„ç”¨cè¯­è¨€ç¼–è¯‘çš„æ ˆç±»ä¼¼ï¼Œéƒ½æ˜¯å­˜å‡½æ•°è°ƒç”¨çš„ï¼Œæœ‰è¿”å›åœ°å€ï¼Œå±€éƒ¨å˜é‡ï¼Œæ“ä½œæ•°ï¼Œè¿™é‡Œè¿˜æœ‰ä¸€ä¸ª**åŠ¨æ€é“¾æ¥**\n- å±€éƒ¨å˜é‡è¡¨ï¼šä¸»è¦å­˜æ”¾äº†ç¼–è¯‘æœŸå¯çŸ¥çš„å„ç§æ•°æ®ç±»å‹ï¼ˆbooleanã€byteã€charã€shortã€intã€floatã€longã€doubleï¼‰ã€å¯¹è±¡å¼•ç”¨ï¼ˆreference ç±»å‹ï¼Œå®ƒä¸åŒäºå¯¹è±¡æœ¬èº«ï¼Œå¯èƒ½æ˜¯ä¸€ä¸ªæŒ‡å‘å¯¹è±¡èµ·å§‹åœ°å€çš„å¼•ç”¨æŒ‡é’ˆï¼Œä¹Ÿå¯èƒ½æ˜¯æŒ‡å‘ä¸€ä¸ªä»£è¡¨å¯¹è±¡çš„å¥æŸ„æˆ–å…¶ä»–ä¸æ­¤å¯¹è±¡ç›¸å…³çš„ä½ç½®ï¼‰ã€‚\n- æ“ä½œæ•°æ ˆï¼šä¸»è¦æ˜¯ä½œä¸ºæ–¹æ³•è°ƒç”¨çš„ä¸­é—´ç«™ï¼Œæ¯”å¦‚addi a,b,aï¼ˆä¼°è®¡ä¸æ˜¯è¿™ä¹ˆå†™çš„ï¼Œåæ­£å°±æ˜¯a+bè®¡ç®—å‡ºæ¥çš„å€¼å†èµ‹ç»™aï¼‰ï¼Œå­˜æ”¾çš„é‚£ä¸ªä¸´æ—¶å˜é‡å°±a+bå°±æ”¾åœ¨æ“ä½œæ•°æ ˆ\n- åŠ¨æ€é“¾æ¥ï¼šè¿è¡Œåˆ°ä¸€å®šä½ç½®çš„æ—¶å€™å¯èƒ½ä¼šéœ€è¦è°ƒç”¨å…¶ä»–çš„ç±»æˆ–è€…æ–¹æ³•ï¼Œè¿™ä¸ªæ—¶å€™å°±è¦æŠŠ**ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºè°ƒç”¨æ–¹æ³•çš„ç›´æ¥å¼•ç”¨**ï¼Œå› ä¸ºå†ç¼–è¯‘çš„æ—¶å€™éƒ½æ˜¯ç”¨çš„å¸¸é‡æ± ï¼Œåœ¨å¸¸é‡æ± å¼•ç”¨çš„ï¼Œä¸€å±‚å¥—ä¸€å±‚ï¼Œè¿™ä¸ªæ—¶å€™å°±è¦æŠŠæœ€æ ¸å¿ƒçš„é‚£ä¸ªå‡½æ•°ç»™æ‹¿å‡ºæ¥ï¼Œå˜æˆç›´æ¥å¼•ç”¨\nè™šæ‹Ÿæœºæ ˆè¶…å‡ºä¼šæŠ¥é”™çš„ï¼Œæ ˆå¸§æ•°é‡ä¸èƒ½å¤šäºä¸€ä¸ªå€¼ã€‚æ¯”å¦‚æ— é™é€’å½’ï¼Œæœ€åæŠ¥é”™æŠ¥çš„æ˜¯æ ˆæº¢å‡ºï¼Œè€Œä¸æ˜¯å †æº¢å‡ºï¼Œå› ä¸ºåœ¨çˆ†å †ä¹‹å‰å°±å·²ç»çˆ†æ ˆ\n\n## æœ¬åœ°æ–¹æ³•æ ˆ\nè¿™ä¸ªè·Ÿè™šæ‹Ÿæœºæ ˆå¾ˆåƒï¼Œä½†æ˜¯è™šæ‹Ÿæœºæ ˆæ˜¯ä¸ºäº†javaè¯­å¥æœåŠ¡çš„ï¼Œæœ¬åœ°æ–¹æ³•æ ˆæ˜¯ä½¿ç”¨åˆ°çš„æœ¬åœ°nativeæ–¹æ³•æœåŠ¡\n\n## å †\n> æ³¨æ„ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œè¯´çš„è¿™äº”ä¸ªå…¶å®æ˜¯é€»è¾‘éƒ¨åˆ†ï¼Œå°±å¥½åƒè®¡ç®—æœºç»„æˆåŸç†ä¸­é‚£äº”ä¸ªéƒ¨åˆ†ä¸€æ ·ï¼Œä½†æ˜¯å®é™…cpuåˆæ˜¯æ§åˆ¶å™¨å’Œè¿ç®—å™¨ç»„åˆçš„ã€‚\n> \n> è¿™é‡Œä¹Ÿæ˜¯ç±»ä¼¼ï¼Œå¯ä»¥ç†è§£ä¸ºè¿™æ˜¯jvmçš„é€»è¾‘è®¾è®¡å›¾ï¼Œå…·ä½“å®ç°çš„æ¯”å¦‚jdk1.7çš„æŒä¹…ä»£å’Œ1.8çš„å…ƒç©ºé—´ï¼Œå…¶å®ä¹Ÿåªæ˜¯æ–¹æ³•åŒºçš„ä¸€ä¸ªå®ç°ç½¢äº†\n\n## æŒä¹…ä»£å’Œå…ƒç©ºé—´\n\næœ€å¤§çš„ä¸€å—ï¼Œjdk1.7ä¸»è¦æ˜¯ä¸‰å—ï¼Œæ–°ç”Ÿä»£ï¼Œè€å¹´ä»£å’ŒæŒä¹…ä»£ï¼Œ1.8æŠŠæŒä¹…ä»£å–æ¶ˆäº†ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯å…ƒç©ºé—´\n\nä¸ªäººç†è§£ï¼Œæœ¬æ¥åœ¨å †ä¸­å°±å®Œæˆäº†æ–¹æ³•åŒºçš„è®¾è®¡ï¼Œåœ¨æŒä¹…åŒºæ”¾é™æ€å˜é‡ï¼Œä»£ç å—å’Œç¼–è¯‘å¥½çš„ä»£ç ï¼Œä½†æ˜¯ç”±äºå¯èƒ½ä¼šå‡ºç°oomï¼Œä»¥åŠè¶Šæ¥è¶Šå¤šçš„åŠ¨æ€ç±»ï¼Œæ—¶çš„å¾ˆå®¹æ˜“çˆ†å †ï¼Œè¿™ä¸ªæ—¶å€™ä¸å¦‚æŠŠå®ƒæå‡ºè™šæ‹Ÿæœºå§ï¼æ”¾åœ¨å®é™…å†…å­˜ä¸‹é¢ï¼Œè¿™æ ·å°±æœ‰æ›´å¹¿é˜”çš„ç©ºé—´ç»™ä½ çˆ†äº†ã€‚\n\näºæ˜¯å…ƒç©ºé—´è¿™ä¸ªæ¦‚å¿µå°±å‡ºæ¥äº†ï¼Œä½†æ˜¯ä¹Ÿä¸æ˜¯æ— é™æ‰©å¤§ï¼Œæœ‰å¤§å°é™åˆ¶çš„\n\n**ä¸ºä»€ä¹ˆä½¿ç”¨å…ƒç©ºé—´ï¼Ÿ**\n- 1ï¼‰ç”±äº PermGen å†…å­˜ç»å¸¸ä¼šæº¢å‡ºï¼Œå¼•å‘OutOfMemoryErrorï¼Œå› æ­¤ JVM çš„å¼€å‘è€…å¸Œæœ›è¿™ä¸€å—å†…å­˜å¯ä»¥æ›´çµæ´»åœ°è¢«ç®¡ç†ï¼Œä¸è¦å†ç»å¸¸å‡ºç°è¿™æ ·çš„ OOMã€‚\n- 2ï¼‰ç§»é™¤ PermGen å¯ä»¥ä¿ƒè¿› HotSpot JVM ä¸ JRockit VM çš„èåˆï¼Œå› ä¸º JRockit æ²¡æœ‰æ°¸ä¹…ä»£ã€‚\n- 3ï¼‰å‡è½»gcçš„è´Ÿæ‹…ï¼Œæ”¾åœ¨å¤–é¢çš„å…ƒç©ºé—´å¯ä»¥ä¸ç”¨gc\n\nå‡†ç¡®æ¥è¯´ï¼ŒPerm åŒºä¸­çš„å­—ç¬¦ä¸²å¸¸é‡æ± è¢«ç§»åˆ°äº†å †å†…å­˜ä¸­æ˜¯åœ¨ Java7 ä¹‹åï¼ŒJava 8 æ—¶ï¼ŒPermGen è¢«å…ƒç©ºé—´ä»£æ›¿ï¼Œå…¶ä»–å†…å®¹æ¯”å¦‚**ç±»å…ƒä¿¡æ¯ã€å­—æ®µã€é™æ€å±æ€§ã€æ–¹æ³•ã€å¸¸é‡**ç­‰éƒ½ç§»åŠ¨åˆ°å…ƒç©ºé—´åŒºã€‚æ¯”å¦‚ java/lang/Object ç±»å…ƒä¿¡æ¯ã€é™æ€å±æ€§ System.outã€æ•´å‹å¸¸é‡ç­‰ã€‚\n\nå…ƒç©ºé—´çš„æœ¬è´¨å’Œæ°¸ä¹…ä»£ç±»ä¼¼ï¼Œéƒ½æ˜¯å¯¹ JVM è§„èŒƒä¸­æ–¹æ³•åŒºçš„å®ç°ã€‚ä¸è¿‡å…ƒç©ºé—´ä¸æ°¸ä¹…ä»£ä¹‹é—´æœ€å¤§çš„åŒºåˆ«åœ¨äºï¼šå…ƒç©ºé—´å¹¶ä¸åœ¨è™šæ‹Ÿæœºä¸­ï¼Œè€Œæ˜¯ä½¿ç”¨æœ¬åœ°å†…å­˜ã€‚å› æ­¤ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œå…ƒç©ºé—´çš„å¤§å°ä»…å—æœ¬åœ°å†…å­˜é™åˆ¶ã€‚\n\n## æ–°ç”Ÿä»£å’Œè€å¹´ä»£\n\n- å¹´è½»ä»£è¢«åˆ’åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼ŒEdenåŒºå’Œä¸¤ä¸ªå¤§å°ä¸¥æ ¼ç›¸åŒçš„SurvivoråŒºï¼Œæ ¹æ®JVMçš„ç­–ç•¥ï¼Œåœ¨ç»è¿‡å‡ æ¬¡åƒåœ¾æ”¶é›†åï¼Œä»»ç„¶å­˜æ´»äºSurvivorçš„å¯¹è±¡å°†è¢«ç§»åŠ¨åˆ°è€å¹´ä»£åŒºé—´ã€‚\n- è€å¹´ä»£ä¸»è¦ä¿å­˜ç”Ÿå‘½å‘¨æœŸé•¿çš„å¯¹è±¡ï¼Œä¸€èˆ¬æ˜¯ä¸€äº›è€çš„å¯¹è±¡\n\nè¿™å°±æ¶‰åŠåˆ°åé¢çš„åƒåœ¾å›æ”¶ç®—æ³•äº†\n\n## æ–¹æ³•åŒº\nä¸€èˆ¬æ¥å­˜é™æ€å˜é‡ï¼Œå¸¸é‡ä»¥åŠç¼–è¯‘å¥½çš„ä»£ç \n\n> è¿™é‡Œè¦æ³¨æ„ï¼Œæ—¢ç„¶æ–¹æ³•åŒºé‡Œé¢æœ‰å¸¸é‡ï¼Œé‚£ä¹Ÿä¼šæœ‰è¿è¡Œæ—¶å¸¸é‡æ± ã€‚è¿™é‡Œè¦åŒºåˆ†**å­—ç¬¦ä¸²å¸¸é‡æ± **ï¼Œjdk1.7ä¹‹å‰ï¼Œå­—ç¬¦ä¸²å¸¸é‡æ± æ˜¯è·ŸæŒä¹…ä»£æ”¾åœ¨ä¸€èµ·çš„ï¼Œæ˜¯æŒä¹…ä»£çš„ä¸€ä¸ªç»„æˆéƒ¨åˆ†ï¼Œ1.7ä¹‹åï¼Œå­—ç¬¦ä¸²å¸¸é‡æ± å°±æ”¾åœ¨å †ç©ºé—´é‡Œäº†ï¼Œä¹Ÿå°±æ˜¯è¯´æå‡ºæ¥äº†ï¼Œç›´åˆ°ç°åœ¨ä¹Ÿè¿˜æ˜¯åœ¨å †ç©ºé—´\n> \n> **ä¸ºä»€ä¹ˆï¼Ÿ**\n> \n> ä¸»è¦æ˜¯å› ä¸ºæ°¸ä¹…ä»£ï¼ˆæ–¹æ³•åŒºå®ç°ï¼‰çš„ GC å›æ”¶æ•ˆç‡å¤ªä½ï¼Œåªæœ‰åœ¨æ•´å †æ”¶é›† (Full GC)çš„æ—¶å€™æ‰ä¼šè¢«æ‰§è¡Œ GCã€‚Java ç¨‹åºä¸­é€šå¸¸ä¼šæœ‰å¤§é‡çš„è¢«åˆ›å»ºçš„å­—ç¬¦ä¸²ç­‰å¾…å›æ”¶ï¼Œå°†å­—ç¬¦ä¸²å¸¸é‡æ± æ”¾åˆ°å †ä¸­ï¼Œèƒ½å¤Ÿæ›´é«˜æ•ˆåŠæ—¶åœ°å›æ”¶å­—ç¬¦ä¸²å†…å­˜ã€‚\n> \n> è€Œè¿è¡Œæ—¶å¸¸é‡æ± æ˜¯æ”¾åœ¨æ–¹æ³•åŒºçš„ï¼Œä¹Ÿå°±æ˜¯å…ƒç©ºé—´\n\n# ç±»åŠ è½½å™¨ä¸åŒäº²å§”æ´¾æ¨¡å‹\n> è¿™é‡Œçš„åŠ è½½æœ‰ç‚¹åƒdnsçš„é€’å½’æŸ¥æ‰¾\n- bootstrapClassLoaderï¼šæ ¹åŠ è½½å™¨ï¼Œæ¯ä¸ªéƒ½ä¼šä»å®ƒå¼€å§‹\n- ExtClassLoaderï¼šæ‰©å±•åŠŸèƒ½çš„ä¸€äº›jaråŒ…é‡Œé¢çš„ç±»\n- AppClassLoaderï¼šåº”ç”¨ç±»åŠ è½½å™¨\n- è‡ªå®šä¹‰ï¼Œå¯ä»¥é‡å†™æ–¹æ³•\n\n**åŒäº²å§”æ´¾æ¨¡å‹**\n\nå¦‚æœä¸€ä¸ªç±»åŠ è½½å™¨åœ¨æ¥åˆ°åŠ è½½ç±»çš„è¯·æ±‚æ—¶ï¼Œå®ƒé¦–å…ˆä¸ä¼šè‡ªå·±å°è¯•å»åŠ è½½è¿™ä¸ªç±»ï¼Œè€Œæ˜¯æŠŠè¿™ä¸ªè¯·æ±‚ä»»åŠ¡å§”æ‰˜ç»™çˆ¶ç±»åŠ è½½å™¨å»å®Œæˆï¼Œä¾æ¬¡é€’å½’ï¼Œå¦‚æœçˆ¶ç±»åŠ è½½å™¨å¯ä»¥å®Œæˆç±»åŠ è½½ä»»åŠ¡ï¼Œå°±è¿”å›æˆåŠŸï¼›åªæœ‰çˆ¶ç±»åŠ è½½å™¨æ— æ³•å®Œæˆæ­¤åŠ è½½ä»»åŠ¡æ—¶ï¼Œæ‰ç”±ä¸‹ä¸€çº§å»åŠ è½½ã€‚ \n\nåŒäº²å§”æ´¾æ¨¡å‹ä¿è¯äº† Java ç¨‹åºçš„ç¨³å®šè¿è¡Œï¼Œå¯ä»¥é¿å…ç±»çš„é‡å¤åŠ è½½ï¼ˆJVM åŒºåˆ†ä¸åŒç±»çš„æ–¹å¼ä¸ä»…ä»…æ ¹æ®ç±»åï¼Œç›¸åŒçš„ç±»æ–‡ä»¶è¢«ä¸åŒçš„ç±»åŠ è½½å™¨åŠ è½½äº§ç”Ÿçš„æ˜¯ä¸¤ä¸ªä¸åŒçš„ç±»ï¼‰ï¼Œä¹Ÿä¿è¯äº† Java çš„æ ¸å¿ƒ API ä¸è¢«ç¯¡æ”¹ã€‚å¦‚æœæ²¡æœ‰ä½¿ç”¨åŒäº²å§”æ´¾æ¨¡å‹ï¼Œè€Œæ˜¯æ¯ä¸ªç±»åŠ è½½å™¨åŠ è½½è‡ªå·±çš„è¯å°±ä¼šå‡ºç°ä¸€äº›é—®é¢˜ï¼Œæ¯”å¦‚æˆ‘ä»¬ç¼–å†™ä¸€ä¸ªç§°ä¸º java.lang.Object ç±»çš„è¯ï¼Œé‚£ä¹ˆç¨‹åºè¿è¡Œçš„æ—¶å€™ï¼Œç³»ç»Ÿå°±ä¼šå‡ºç°ä¸¤ä¸ªä¸åŒçš„ Object ç±»ã€‚åŒäº²å§”æ´¾æ¨¡å‹å¯ä»¥ä¿è¯åŠ è½½çš„æ˜¯ JRE é‡Œçš„é‚£ä¸ª Object ç±»ï¼Œè€Œä¸æ˜¯ä½ å†™çš„ Object ç±»ã€‚è¿™æ˜¯å› ä¸º AppClassLoader åœ¨åŠ è½½ä½ çš„ Object ç±»æ—¶ï¼Œä¼šå§”æ‰˜ç»™ ExtClassLoader å»åŠ è½½ï¼Œè€Œ ExtClassLoader åˆä¼šå§”æ‰˜ç»™ BootstrapClassLoaderï¼ŒBootstrapClassLoader å‘ç°è‡ªå·±å·²ç»åŠ è½½è¿‡äº† Object ç±»ï¼Œä¼šç›´æ¥è¿”å›ï¼Œä¸ä¼šå»åŠ è½½ä½ å†™çš„ Object ç±»\n\n\nå¥½å¤„ï¼š\n- é˜²æ­¢æ ¸å¿ƒåº“è¢«ç¯¡æ”¹\n- ä¸é‡å¤åŠ è½½ç±»\n\n# æ‰“ç ´åŒäº²å§”æ´¾\ntomcatï¼Œé‡å†™äº†loadClassæ–¹æ³•\n","tags":["Java"]},{"title":"java-å¤šçº¿ç¨‹-ThreadLocalå’Œçº¿ç¨‹æ± ","url":"/2024/04/07/java-å¤šçº¿ç¨‹ï¼ˆä¸­/","content":"# ThreadLocal\n\né€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åˆ›å»ºçš„å˜é‡æ˜¯å¯ä»¥è¢«ä»»ä½•ä¸€ä¸ªçº¿ç¨‹è®¿é—®å¹¶ä¿®æ”¹çš„ã€‚å¦‚æœæƒ³å®ç°æ¯ä¸€ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„ä¸“å±æœ¬åœ°å˜é‡è¯¥å¦‚ä½•è§£å†³å‘¢ï¼Ÿ\n\nJDK ä¸­è‡ªå¸¦çš„ThreadLocalç±»æ­£æ˜¯ä¸ºäº†è§£å†³è¿™æ ·çš„é—®é¢˜ã€‚ ThreadLocalç±»ä¸»è¦è§£å†³çš„å°±æ˜¯è®©æ¯ä¸ªçº¿ç¨‹ç»‘å®šè‡ªå·±çš„å€¼ï¼Œå¯ä»¥å°†ThreadLocalç±»å½¢è±¡çš„æ¯”å–»æˆå­˜æ”¾æ•°æ®çš„ç›’å­ï¼Œç›’å­ä¸­å¯ä»¥å­˜å‚¨æ¯ä¸ªçº¿ç¨‹çš„ç§æœ‰æ•°æ®ã€‚\n\nå¦‚æœä½ åˆ›å»ºäº†ä¸€ä¸ªThreadLocalå˜é‡ï¼Œé‚£ä¹ˆè®¿é—®è¿™ä¸ªå˜é‡çš„æ¯ä¸ªçº¿ç¨‹éƒ½ä¼šæœ‰è¿™ä¸ªå˜é‡çš„æœ¬åœ°å‰¯æœ¬ï¼Œè¿™ä¹Ÿæ˜¯ThreadLocalå˜é‡åçš„ç”±æ¥ã€‚ä»–ä»¬å¯ä»¥ä½¿ç”¨ get() å’Œ set() æ–¹æ³•æ¥è·å–é»˜è®¤å€¼æˆ–å°†å…¶å€¼æ›´æ”¹ä¸ºå½“å‰çº¿ç¨‹æ‰€å­˜çš„å‰¯æœ¬çš„å€¼ï¼Œä»è€Œé¿å…äº†çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚\n\nå†ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼šä¸¤ä¸ªäººå»å®å±‹æ”¶é›†å®ç‰©ï¼Œè¿™ä¸¤ä¸ªå…±ç”¨ä¸€ä¸ªè¢‹å­çš„è¯è‚¯å®šä¼šäº§ç”Ÿäº‰æ‰§ï¼Œä½†æ˜¯ç»™ä»–ä»¬ä¸¤ä¸ªäººæ¯ä¸ªäººåˆ†é…ä¸€ä¸ªè¢‹å­çš„è¯å°±ä¸ä¼šå‡ºç°è¿™æ ·çš„é—®é¢˜ã€‚å¦‚æœæŠŠè¿™ä¸¤ä¸ªäººæ¯”ä½œçº¿ç¨‹çš„è¯ï¼Œé‚£ä¹ˆ ThreadLocal å°±æ˜¯ç”¨æ¥é¿å…è¿™ä¸¤ä¸ªçº¿ç¨‹ç«äº‰çš„ã€‚\n\n## æ•°æ®ç»“æ„\n\n![](../img/Java/img_5.png)\n\nå…¶å®ä¸æ˜¯ThreadLocalæœ‰è¿™ä¸ªæ•°æ®ç»“æ„ï¼Œæ˜¯ThreadæŒæœ‰çš„ï¼Œæœ‰ä¸€ä¸ªThreadLocalMapçš„æ•°ç»„ï¼Œä¸“é—¨æ”¾é”®å€¼å¯¹ï¼ŒKä¸ºThreadLocalçš„ç±»å¯¹è±¡ï¼ŒVä¸ºThreadLocalæ³›å‹çš„æ•°æ®ã€‚\n\nä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­ï¼Œå¦‚æœæœ‰å¤šä¸ªThreadLocalï¼ŒæŸ¥æ‰¾Mapé”®ä¸ºè¿™ä¸ªThreadLocalå˜é‡ï¼Œå°±å¯ä»¥å¾ˆè½»æ¾æ‹¿åˆ°å­˜çš„å€¼ã€‚\n\n```java\npublic void set(T value) {\n    //è·å–å½“å‰è¯·æ±‚çš„çº¿ç¨‹\n    Thread t = Thread.currentThread();\n    //å–å‡º Thread ç±»å†…éƒ¨çš„ threadLocals å˜é‡(å“ˆå¸Œè¡¨ç»“æ„)\n    ThreadLocalMap map = getMap(t);\n    if (map != null)\n        // å°†éœ€è¦å­˜å‚¨çš„å€¼æ”¾å…¥åˆ°è¿™ä¸ªå“ˆå¸Œè¡¨ä¸­\n        map.set(this, value);\n    else\n        createMap(t, value);\n}\nThreadLocalMap getMap(Thread t) {\n    return t.threadLocals;\n}\n```\n## å†…å­˜æ³„éœ²é—®é¢˜\n\nè¿™ä¸ªMapé‡Œé¢ï¼ŒKeyæ˜¯å¼±å¼•ç”¨çš„ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯æ¬¡gcéƒ½ä¼šå›æ”¶keyï¼Œè€Œvalueæ˜¯å¼ºå¼•ç”¨çš„ã€‚è¿™ä¸ªæ—¶å€™å°±ä¼šå‡ºç°ï¼Œkeyè¢«gcå›æ”¶äº†ä¸ºnullï¼Œvalueè¿˜æœ‰çš„æƒ…å†µã€‚è¿™ä¸ªæ—¶å€™å°±ä¼šäº§ç”Ÿå†…å­˜æ³„éœ²ã€‚\n\nè§£å†³æ–¹æ³•ï¼šé‡Šæ”¾çš„æ—¶å€™æ‰‹åŠ¨removeã€‚\n\n# çº¿ç¨‹æ± çš„å››ä¸ªç§ç±»\n1. newCachedThreadPoolåˆ›å»ºä¸€ä¸ªå¯ç¼“å­˜çš„çº¿ç¨‹æ± ï¼Œé»˜è®¤é˜»å¡é˜Ÿåˆ—æ˜¯SynchronousQueue\n2. newFixedThreadPoolåˆ›å»ºä¸€ä¸ªå®šé•¿çš„çº¿ç¨‹æ± ï¼Œé»˜è®¤é˜»å¡é˜Ÿåˆ—æ˜¯LinkedBlockingQueue\n3. newSingleThreadExecutoråˆ›å»ºä¸€ä¸ªå•ä¾‹çº¿ç¨‹ï¼Œé»˜è®¤ä¹Ÿæ˜¯LinkedBlockingQueue\n4. newScheduledåˆ›å»ºä¸€ä¸ªå¯ä»¥è®¾ç½®å®šæ—¶ä»»åŠ¡çš„çº¿ç¨‹\n\n# çº¿ç¨‹æ± çš„æ ¸å¿ƒå‚æ•°\n\né™¤äº†ä¸Šé¢å››ç§å°è£…å¥½çš„ï¼Œè¿˜å¯ä»¥è‡ªå·±åˆ›å»º\n\n```java\n    /**\n     * ç”¨ç»™å®šçš„åˆå§‹å‚æ•°åˆ›å»ºä¸€ä¸ªæ–°çš„ThreadPoolExecutorã€‚\n     */\n    public ThreadPoolExecutor(int corePoolSize,//çº¿ç¨‹æ± çš„æ ¸å¿ƒçº¿ç¨‹æ•°é‡\n                              int maximumPoolSize,//çº¿ç¨‹æ± çš„æœ€å¤§çº¿ç¨‹æ•°\n                              long keepAliveTime,//å½“çº¿ç¨‹æ•°å¤§äºæ ¸å¿ƒçº¿ç¨‹æ•°æ—¶ï¼Œå¤šä½™çš„ç©ºé—²çº¿ç¨‹å­˜æ´»çš„æœ€é•¿æ—¶é—´\n                              TimeUnit unit,//æ—¶é—´å•ä½\n                              BlockingQueue<Runnable> workQueue,//ä»»åŠ¡é˜Ÿåˆ—ï¼Œç”¨æ¥å‚¨å­˜ç­‰å¾…æ‰§è¡Œä»»åŠ¡çš„é˜Ÿåˆ—\n                              ThreadFactory threadFactory,//çº¿ç¨‹å·¥å‚ï¼Œç”¨æ¥åˆ›å»ºçº¿ç¨‹ï¼Œä¸€èˆ¬é»˜è®¤å³å¯\n                              RejectedExecutionHandler handler//æ‹’ç»ç­–ç•¥ï¼Œå½“æäº¤çš„ä»»åŠ¡è¿‡å¤šè€Œä¸èƒ½åŠæ—¶å¤„ç†æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å®šåˆ¶ç­–ç•¥æ¥å¤„ç†ä»»åŠ¡\n                               ) {\n        if (corePoolSize < 0 ||\n            maximumPoolSize <= 0 ||\n            maximumPoolSize < corePoolSize ||\n            keepAliveTime < 0)\n            throw new IllegalArgumentException();\n        if (workQueue == null || threadFactory == null || handler == null)\n            throw new NullPointerException();\n        this.corePoolSize = corePoolSize;\n        this.maximumPoolSize = maximumPoolSize;\n        this.workQueue = workQueue;\n        this.keepAliveTime = unit.toNanos(keepAliveTime);\n        this.threadFactory = threadFactory;\n        this.handler = handler;\n    }\n```\n\nä¸ƒä¸ªæ ¸å¿ƒå‚æ•°ï¼š\n1. æ ¸å¿ƒçº¿ç¨‹æ•°é‡\n2. æœ€å¤§çº¿ç¨‹æ•°é‡\n3. è¿‡æœŸæ—¶é—´ï¼šå¦‚æœçº¿ç¨‹æ± çš„çº¿ç¨‹æ•°é‡å¤§äºæ ¸å¿ƒçº¿ç¨‹æ•°é‡ï¼Œå¦‚æœæ²¡æœ‰æ–°çš„ä»»åŠ¡æäº¤ï¼Œé‚£ä¹ˆå·²ç»åˆ°æœŸçš„çº¿ç¨‹ä¸ä¼šç«‹åˆ»é”€æ¯ï¼Œè€Œæ˜¯ç­‰ä¸€æ®µæ—¶é—´é”€æ¯\n4. è¿‡æœŸæ—¶é—´å•ä½ï¼šå¯ä»¥æ˜¯ç§’ï¼Œæ¯«ç§’\n5. é˜»å¡é˜Ÿåˆ—ï¼šåˆšåˆšæçš„é‚£äº›ï¼Œåé¢è¿˜ä¼šè¯´\n6. é¥±å’Œç¼©ç•¥\n7. çº¿ç¨‹å·¥å‚ç±»ï¼šä¸€èˆ¬éƒ½æ˜¯é»˜è®¤çš„ï¼Œå¯ä»¥å®šåˆ¶çº¿ç¨‹å¯¹è±¡çš„åˆ›å»ºï¼Œä¾‹å¦‚è®¾ç½®çº¿ç¨‹åå­—ã€æ˜¯å¦æ˜¯å®ˆæŠ¤çº¿ç¨‹ç­‰\n\n# é¥±å’Œç­–ç•¥\nå½“é˜»å¡é˜Ÿåˆ—æ»¡äº†ï¼Œè€Œä¸”æœ€å¤§çº¿ç¨‹æ•°é‡ä¹Ÿæ»¡äº†ï¼Œå°±ä¼šè§¦å‘é¥±å’Œç­–ç•¥\n1. æŠ›å‡ºå¼‚å¸¸ï¼Œä¸è®©åŠ äº†\n2. çº¿ç¨‹ä¸èµ°çº¿ç¨‹æ± ï¼Œæäº¤çº¿ç¨‹çš„é‚£ä¸ªçº¿ç¨‹è‡ªå·±æ¥è¿è¡Œ\n3. ä¸æŠ¥é”™ï¼Œç›´æ¥ä¸¢å¼ƒ\n4. ä¸¢å¼ƒé˜Ÿåˆ—æœ€å‰é¢é‚£ä¸ªï¼Œç„¶ååŠ è¿›é˜Ÿåˆ—\n\n# å¦‚ä½•ç¡®å®šçº¿ç¨‹æ•°é‡\n- ioå¯†é›†å‹ï¼š2n+1\n- cpuå¯†é›†å‹ï¼šn+1\nè¿™é‡Œçš„néƒ½æ˜¯å½“å‰æœºå™¨çš„è™šæ‹Ÿå†…æ ¸æ•°é‡ï¼Œioå¯†é›†å‹ä¸»è¦éƒ½æ˜¯ioæ—¶é—´å¤šï¼Œå¯¹äºcpuè´Ÿè½½å¹¶ä¸å¤§\n","tags":["Java"]},{"title":"java-å¤šçº¿ç¨‹-volatileï¼Œsynchronizedå’Œlock","url":"/2024/04/07/zjava-å¤šçº¿ç¨‹-ä¸Š/","content":"> ç”±äºä¸œè¥¿å¾ˆå¤šå¾ˆä¹±ï¼Œå°±æŒ‰ç…§Q&Açš„æ–¹å¼æ•´ç†ä»¥ä¸‹\n\n# è¿›ç¨‹ä¸çº¿ç¨‹çš„åŒºåˆ«\n\n- è°ƒåº¦æ–¹é¢ï¼šåœ¨ä¼ ç»Ÿè®¡ç®—æœºä¸­ï¼Œè¿›ç¨‹æ˜¯è°ƒåº¦çš„åŸºæœ¬å•ä½ï¼Œä½†æ˜¯åœ¨å¼•å…¥çº¿ç¨‹ä¹‹åï¼Œçº¿ç¨‹æ˜¯è°ƒåº¦çš„åŸºæœ¬å•ä½ã€‚åŒä¸€ä¸ªè¿›ç¨‹ä¸‹çš„çº¿ç¨‹åˆ‡æ¢ä¸ä¼šå¼•èµ·è¿›ç¨‹åˆ‡æ¢ï¼Œä½†æ˜¯ä¸åŒçš„å°±ä¼šå½±å“\n- æ‹¥æœ‰èµ„æºæ–¹é¢ï¼šè¿›ç¨‹æ˜¯æ‹¥æœ‰èµ„æºçš„å•ä½ï¼Œçº¿ç¨‹ä¹‹é—´å…±äº«å†…å­˜ç©ºé—´\n- åˆ‡æ¢æ–¹é¢ï¼šè¿›ç¨‹åˆ‡æ¢è¦ä¿å­˜ä¸Šä¸‹æ–‡ç¨‹åºè®¡æ•°å™¨å¾ˆå¤šä¸œè¥¿ï¼Œè€Œçº¿ç¨‹åˆ‡æ¢åªç”¨ä¿å­˜ä¸€äº›å¯„å­˜å™¨ã€‚å¼€é”€è¿œå°äºè¿›ç¨‹\n- å¹¶å‘æ€§ï¼šåŒä¸€ä¸ªè¿›ç¨‹ä¸‹çš„çº¿ç¨‹å¯ä»¥å¹¶å‘ï¼Œä¸åŒè¿›ç¨‹ä¸‹çš„çº¿ç¨‹ä¹Ÿå¯ä»¥å¹¶å‘\n\n# volatileå…³é”®å­—\nvolatileæ˜¯ä¸ç¨³å®šçš„æ„æ€ï¼Œä¸æ­¢ç”¨äºjavaï¼Œc++ä¹Ÿæœ‰ä½¿ç”¨ï¼Œå£°æ˜äº†è¿™ä¸ªå…³é”®å­—çš„å˜é‡ä¼šç¦ç”¨ç¼“å­˜ï¼Œæ¯ä¸€æ¬¡éƒ½ä»å†…å­˜æ‰¾æœ€æ–°çš„å€¼ï¼Œè¿™æ ·å°±èƒ½ä¿è¯å¯è§æ€§ï¼Œä½†æ˜¯ä¸ä¼šä¿è¯åŸå­æ€§ï¼Œä¾‹å¦‚ä¸‹é¢è¿™æ®µä»£ç \n```java\npublic class VolatileAtomicityDemo {\n    public volatile static int inc = 0;\n\n    public void increase() {\n        inc++;\n    }\n\n    public static void main(String[] args) throws InterruptedException {\n        ExecutorService threadPool = Executors.newFixedThreadPool(5);\n        VolatileAtomicityDemo volatileAtomicityDemo = new VolatileAtomicityDemo();\n        for (int i = 0; i < 5; i++) {\n            threadPool.execute(() -> {\n                for (int j = 0; j < 500; j++) {\n                    volatileAtomicityDemo.increase();\n                }\n            });\n        }\n        // ç­‰å¾…1.5ç§’ï¼Œä¿è¯ä¸Šé¢ç¨‹åºæ‰§è¡Œå®Œæˆ\n        Thread.sleep(1500);\n        System.out.println(inc);\n        threadPool.shutdown();\n    }\n}\n```\nè¿™é‡Œå¾—ä¸åˆ°ç»“æœçš„ä¸»è¦åŸå› æ˜¯ï¼Œinc++ä¸æ˜¯ä¸€ä¸ªåŸå­æ“ä½œï¼Œå…¶å®æ˜¯ç”±ä¸‰ä¸ªæ“ä½œå¹¶æˆï¼Œå…ˆè¯»å–incï¼Œå†++ï¼Œæœ€åå†™å›ï¼Œå¯èƒ½ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶éƒ½è¯»åˆ°incä¸º100ï¼Œè¿™ä¸ªæ—¶å€™å†åŒæ—¶æ›´æ”¹å†™å›å†…å­˜ï¼Œè¿™æ ·å°±ä¼šè¾¾ä¸åˆ°é¢„æœŸï¼Œæ‰€ä»¥volatileå…³é”®ä¹‹**åªèƒ½ä¿è¯å¯è§æ€§ï¼Œä¸èƒ½ä¿è¯åŸå­æ€§**\n\nå¦‚æœè¦ä¿è¯åŸå­æ€§ï¼Œå¯ä»¥ä½¿ç”¨ï¼š\n- synchronizedå…³é”®å­—ä¸Šé”increaseæ–¹æ³•\n- æ—¢ç„¶å¯ä»¥ç”¨synchronizedæ–¹æ³•ï¼Œé‚£è‚¯å®šä¹Ÿå¯ä»¥ç”¨ReentrantLockï¼Œå…³äºè¿™ä¸¤è€…çš„åŒºåˆ«åæ–‡å†è¯´\n- ReentrantLockåŸºäºCASå’ŒAQSï¼Œé‚£è‚¯å®šç”¨CASçš„åŸå­æ–¹æ³•ä¹Ÿå¯ä»¥è§£å†³ï¼Œåæ–‡å†è¯´\n\n# ä¹è§‚é”å’Œæ‚²è§‚é”\n- æ‚²è§‚é”ï¼šæ‚²è§‚çš„è§‰å¾—ä¸´ç•ŒåŒºä¸€å®šä¼šæœ‰äººæ¥ç«äº‰ï¼Œæ‰€ä»¥æ¯æ¬¡è®¿é—®çš„æ—¶å€™ä¸€å®šè¦ä¸Šé”ï¼Œsynchronizedå’ŒReentrantLockå°±æ˜¯æ¯”è¾ƒå…¸å‹çš„æ‚²è§‚é”\n- ä¹è§‚é”ï¼šå¾ˆæŠ•æœºçš„è§‰å¾—ï¼Œè¿™æ®µä»£ç å¯èƒ½ä¸ä¼šæœ‰åˆ«çš„çº¿ç¨‹è®¿é—®ï¼Œå°±ç®—æœ‰æˆ‘ä¹Ÿä¸ä¸Šé”ï¼Œç”¨å…¶ä»–çš„æ–¹æ³•ï¼Œä¾‹å¦‚é˜Ÿåˆ—ï¼Œé“¾è¡¨çš„æ–¹å¼ï¼Œæ¯”è¾ƒå…¸å‹çš„å°±æ˜¯CASï¼ˆå…¶å®æˆ‘è§‰å¾—MVCCå¤šå°‘ä¹Ÿæœ‰ç‚¹è¿™ç§æ€æƒ³ï¼‰\næœ€å¤§çš„åŒºåˆ«å°±æ˜¯é”çš„ç²’åº¦ä¸ä¸€æ ·ï¼Œæ‚²è§‚é”ç”±äºæ¯ä¸€æ¬¡éƒ½è¦ä¸Šé”ï¼Œè‚¯å®šæ•ˆç‡æ²¡æœ‰ä¹è§‚é”é«˜ï¼Œåè€Œè¨€ä¹‹ï¼Œå¦‚æœé¢‘ç¹å‘ç”Ÿå†²çªï¼Œä¹è§‚é”çš„æ•ˆç‡ä¹Ÿæ˜¯å¾ˆä½çš„ã€‚æ€»è€Œè¨€ä¹‹ï¼Œåœ¨è¯»å¤šå†™å°‘çš„åœºæ™¯ï¼Œå¯ä»¥ä½¿ç”¨ä¹è§‚é”ï¼Œå†™å¤šè¯»å°‘çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨æ‚²è§‚é”ã€‚\n\n# CASå’Œè‡ªæ—‹é”\n## CAS\ncompare and swapï¼Œæ¯”è¾ƒå¹¶ä¸”äº¤æ¢ï¼Œä¸»è¦æ€æƒ³æ˜¯ç»™å‡ºä¸‰ä¸ªæ•°æ®ï¼šè¦ä¿®æ”¹çš„æ•°æ®çš„æ›´æ–°å€¼ï¼Œè¿™ä¸ªè¦ä¿®æ”¹çš„æ•°æ®çš„é¢„æœŸå€¼ï¼Œè¦ä¿®æ”¹æ•°æ®çš„å®é™…å€¼ã€‚ä»€ä¹ˆæ„æ€å‘¢ï¼Œä¾‹å¦‚æˆ‘ä»¬è¦æŠŠä¸€ä¸ªç­‰äº1çš„æ•°æ®ä¿®æ”¹æˆ6ï¼Œæˆ‘å¯¹äºè¿™ä¸ªè¦ä¿®æ”¹æ•°æ®çš„é¢„æœŸå€¼å°±æ˜¯1ï¼Œå½“ä¸”ä»…å½“æ•°æ®æ˜¯1çš„æ—¶å€™ï¼Œæˆ‘æ‰ä¼šæŠŠå®ƒä¿®æ”¹æˆ6.\nè¿™ä¸ªæ€æƒ³æ€ä¹ˆåœ¨å¹¶å‘çš„ç¯å¢ƒä¸‹ä½“ç°å‘¢ï¼Ÿæ¯”å¦‚è¿™ä¸ªæ—¶å€™ä¸¤ä¸ªçº¿ç¨‹éƒ½è¦ä¿®æ”¹è¿™ä¸ªæ•°æ®ï¼Œæœ‰ä¸€ä¸ªåˆ«çš„çº¿ç¨‹æŠ¢å å…ˆæœºï¼Œç”±äºè¿™ä¸ªæ˜¯ç”±volatileä¿®é¥°çš„ï¼Œå¦ä¸€è¾¹ç«‹å³ä¼šå°±çœ‹åˆ°ä¿®æ”¹æˆäº†å¦å¤–ä¸€ä¸ªå€¼ï¼Œä¸å†æ˜¯é¢„æœŸå€¼1ï¼Œè¿™ä¸ªæ—¶å€™caså°±ä¼šå¤±æ•ˆï¼Œä»è€Œä¿è¯äº†å¹¶å‘ã€‚\n\n**ä¸ºä»€ä¹ˆè¿™æ ·å°±èƒ½ä½œä¸ºé”å‘¢ï¼Ÿ**\n\nç†ç”±å¾ˆç®€å•ï¼Œcas**ä¿è¯åŸå­æ€§**ï¼Œä¸ºä»€ä¹ˆä»–æ•¢ç†ç›´æ°”å£®çš„è¯´è‡ªå·±æ˜¯åŸå­çš„ã€‚è¿™å°±è¦æ¶‰åŠåˆ°ä¸€ä¸ªç¥å¥‡çš„ç±»Unsafeï¼Œåœ¨å®ç°javaè™šæ‹Ÿæœºçš„æ—¶å€™ï¼Œç”±äºjvmçš„éš”ç¦»æ€§ï¼Œä½¿å¾—javaå¾ˆéš¾æ¥è¿‘åº•å±‚æ“ä½œç³»ç»Ÿï¼ŒUnsafeè¿™ä¸ªç±»é‡Œé¢å…¨éƒ½æ˜¯nativeæ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯ç”¨çš„æœ¬åœ°æ–¹æ³•ï¼Œå¯¹äºcasè€Œè¨€ï¼Œè¿™ä¸ªåº•å±‚çš„æ–¹æ³•ä¸æ˜¯javaå®ç°çš„ï¼Œæ˜¯ç”±Unsafeè°ƒç”¨dllåŠ¨æ€åº“ï¼Œä¹Ÿå°±æ˜¯c++å®ç°çš„ï¼Œcasè¿™æ¡æ“ä½œå¯ä»¥ç†è§£æˆæ±‡ç¼–çš„ä¸€ä¸ªåŸå­æŒ‡ä»¤ï¼Œæ—¢ç„¶æ˜¯ä¸€æ¡æŒ‡ä»¤ï¼Œé‚£ä¹ˆè‚¯å®šæ˜¯å¯ä»¥ä¿è¯åŸå­æ€§çš„ã€‚\n\né‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œä¸ºä»€ä¹ˆä¸ç›´æ¥å¼„ä¸€æ¡é”çš„åŸå­æŒ‡ä»¤ï¼Œè€Œè¿™ä¹ˆæ‹å¼¯æŠ¹è§’çš„ç”¨åˆ°è¿™ä¸ªè¯­å¥é—´æ¥å®Œæˆä¹è§‚é”ï¼Œå°ç¼–ä¹Ÿä¸çŸ¥é“\n\n## è‡ªæ—‹é”\n\næˆ‘ä»¬æœ‰äº†è¿™ä¸ªCASæ“ä½œï¼Œåˆ°åº•æ€ä¹ˆç”¨åˆ°é”ä¸Šé¢å‘¢ï¼Ÿæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸ªç”¨CASçš„ä¾‹å­ï¼š\n\nAtomicIntegerä¸­è°ƒç”¨unsafeè¿›è¡Œè‡ªå¢æ“ä½œçš„æºç ä¸­çš„do-whileå¾ªç¯å°±æ˜¯ä¸€ä¸ªè‡ªæ—‹æ“ä½œï¼Œå¦‚æœä¿®æ”¹æ•°å€¼å¤±è´¥åˆ™é€šè¿‡å¾ªç¯æ¥æ‰§è¡Œè‡ªæ—‹ï¼Œç›´è‡³ä¿®æ”¹æˆåŠŸã€‚AtomicIntegeræ˜¯ä¸€ä¸ªæ“ä½œIntegerç±»å‹çš„åŸå­æ“ä½œç±»ï¼Œè¿™é‡Œçš„getAndAddIntå¯ä»¥ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œè·å–Objectå¯¹è±¡åœ¨å†…å­˜åç§»é‡ï¼Œç„¶ååœ¨+i\n```java\npublic final int getAndAddInt (Object var1, Long var2, int var4) {\n\tint var5;\n    //è‡ªå¾ªç¯çš„æ€æƒ³ï¼Œæ¯ä¸€æ¬¡å¾ªç¯éƒ½æ‰¾Objectçš„åç§»é‡ä¸ºvar2çš„é‚£ä¸ªå€¼ï¼Œè¿™ä¸ªè·å¾—çš„å°±æ˜¯é¢„æœŸå€¼ï¼Œ\n    //å¾ªç¯æ¡ä»¶æ˜¯å¦‚æœè·Ÿä»–ä¸€æ ·å°±æ–­å¼€ï¼Œå¦‚æœä¸ä¸€æ ·ï¼Œä¸é˜»å¡ï¼Œä¸é‡Šæ”¾CPUï¼Œä½†æ˜¯ä¹Ÿè¾¾åˆ°äº†é”çš„åŠŸèƒ½\n    //èƒ½åŠ å°±åŠ ï¼ŒåŠ ä¸ä¸Šå°±ä¸€åªå¾ªç¯ä¸€ç›´å°è¯•\n\tdo {\n\t\tvar5 = this.getIntVolatile(var1, var2);\n\t} while( !this.compareAndSwapInt(var1, var2, var5, var5 + var4));\n\t\n\treturn var5;\n}\n\n\n```\nä¸»è¦æ€æƒ³æ˜¯åŠ çš„ä¸Šå°±åŠ ï¼ŒåŠ ä¸ä¸Šä¸€ç›´å°è¯•ï¼Œå³ä½¿æ²¡æœ‰åŠ é”ï¼Œä½†æ˜¯ä¹Ÿè¾¾åˆ°äº†é”çš„åŠŸèƒ½ã€‚\n\nè¿™ç§æ€æƒ³ç§°ä¸º**è‡ªæ—‹**ï¼Œæˆ‘ä»¬æŠŠè¿™ç§dowhileçš„æ€æƒ³è¿ç”¨åˆ°ç±»ä¸Šå°±æ˜¯**è‡ªæ—‹é”**ï¼Œæˆ‘çŒœå–è¿™ä¸ªåå­—çš„åŸå› æ˜¯å› ä¸ºä¸€ç›´å¾ªç¯ï¼Œå¾ˆåƒè‡ªå·±ä¸€ä¸ªäººåœ¨è½¬\n```java\npublic class SpinLock {\n    private AtomicReference<Thread> owner = new AtomicReference<Thread>();\n\n    public void lock() {\n        Thread currentThread = Thread.currentThread();\n        // å¦‚æœé”æœªè¢«å ç”¨ï¼Œåˆ™è®¾ç½®å½“å‰çº¿ç¨‹ä¸ºé”çš„æ‹¥æœ‰è€…\n        while (!owner.compareAndSet(null, currentThread)) {\n        }\n    }\n\n    public void unlock() {\n        Thread currentThread = Thread.currentThread();\n        // åªæœ‰é”çš„æ‹¥æœ‰è€…æ‰èƒ½é‡Šæ”¾é”\n        owner.compareAndSet(currentThread, null);\n    }\n}\n```\nAtomicReferenceæ˜¯ä¸€ä¸ªåŸå­ç±»ï¼Œæä¾›çš„compareAndSetæ–¹æ³•å°è£…äº†CASæ–¹æ³•ï¼Œå‚æ•°ä¸­å‰é¢æ˜¯é¢„æœŸå€¼ï¼Œåé¢æ˜¯è¦ä¿®æ”¹çš„å€¼ï¼Œå¦‚æœé¢„æœŸå€¼å’Œå®é™…å€¼æ˜¯ä¸€æ ·çš„ï¼Œé‚£ä¹ˆå°±è®¾ç½®ä¸ºä¿®æ”¹å€¼ã€‚\n\nä¸Šé”è¿‡ç¨‹ï¼šownerè¿™é‡Œç©ºå‚æ•°æ„é€ ï¼Œæ‰€ä»¥æˆ‘çš„é¢„æœŸå€¼æ˜¯ç©ºï¼Œå¦‚æœè¿™ä¸ªæ—¶å€™åªæœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œé‚£ä¹ˆæ²¡æœ‰äººä¸Šé”è‚¯å®šä¹Ÿæ˜¯ç©ºï¼Œæ‰€ä»¥å®é™…å€¼ä¹Ÿæ˜¯ç©ºï¼Œæ»¡è¶³æ¡ä»¶ï¼Œé‚£ä¹ˆå°±æŠŠç©ºè®¾ç½®ä¸ºå½“å‰çº¿ç¨‹ã€‚å¦‚æœæœ‰ä¸¤ä¸ªçº¿ç¨‹ï¼Œéƒ½åŒæ—¶è¦ä¸Šé”ï¼Œå…ˆè¿›æ¥çš„é‚£ä¸ªä¸Šäº†é”ï¼Œä¸‹ä¸€ä¸ªcompareAndSetæ–¹æ³•è‚¯å®šæ˜¯å‡ï¼Œå°±ä¼šä¸€ç›´whileï¼Œä¸ä¼šé‡Šæ”¾cpu\n\nè§£é”è¿‡ç¨‹ï¼šé¢„æœŸå€¼ä¸ºå½“å‰çº¿ç¨‹ï¼Œè¿™ä¸ªçº¿ç¨‹åˆšåˆšä¸Šé”äº†ï¼Œæ‰€ä»¥å®é™…å€¼è‚¯å®šå­˜çš„ä¹Ÿæ˜¯è¿™ä¸ªï¼Œæœ€åæ»¡è¶³æ¡ä»¶å°±æŠŠé”è®¾ç½®ä¸ºnullï¼Œæ­¤æ—¶ç¬¬äºŒä¸ªçº¿ç¨‹ç»ˆäºä¸ç”¨è‡ªæ—‹äº†ï¼Œå°±ä¼šè·å–é”ã€‚\n\né€šè¿‡è¿™ä¸ªè¿‡ç¨‹ä¹Ÿçœ‹åˆ°äº†ï¼Œè‡ªæ—‹çš„ä¼˜ç‚¹å’Œç¼ºç‚¹éƒ½å¾ˆæ˜æ˜¾ï¼Œä¼˜ç‚¹æ˜¯å¦‚æœæ—¶é—´çŸ­çš„è¯ï¼Œå¯ä»¥å…å»çº¿ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢æ—¶é—´ï¼›ä½†æ˜¯å¦‚æœæ—¶é—´é•¿ï¼Œé‚£å°±æ˜¯å¾ˆæ¶ˆè€—cpuçš„ï¼Œä¸€ç›´ä¸é‡Šæ”¾ï¼Œè¿™ä¸ªç¼ºç‚¹æœ‰æ”¹è¿›æªæ–½ï¼Œå¯ä»¥ç”¨**è‡ªé€‚åº”è‡ªæ—‹é”**ï¼Œä¹Ÿå°±è¯´ï¼Œä¸å†æ˜¯æ— é™å¾ªç¯ï¼Œå¯ä»¥è®¾ç½®ä¸€ä¸ªæœ€å¤§å¾ªç¯æ¬¡æ•°ï¼Œå°±ä¸ä¼šå¯¼è‡´æ­»å¾ªç¯çš„æƒ…å†µã€‚\n\n## ABAé—®é¢˜\nCASå­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œåˆ¤æ–­å®é™…å€¼å’Œé¢„æœŸå€¼ç›¸åŒï¼Œå…¶å®ä¸ä¸€å®šå°±èƒ½è¯´æ˜æ²¡æ”¹è¿‡ï¼Œæœ‰å¯èƒ½é¢„æœŸå€¼æ˜¯Aï¼Œå®é™…å€¼ä»Aå˜æˆäº†Bå†å˜æˆäº†Aï¼Œè¿™ä¸ªé—®é¢˜å…¶å®è›®ä¸¥é‡çš„ï¼Œå¦‚æœæ˜¯å˜é‡è¿˜å¥½ï¼Œå¦‚æœåœ¨é“¾è¡¨ä¸­ï¼Œåˆ¤æ–­å¤´èŠ‚ç‚¹æ²¡å˜åŒ–ï¼Œä¸ä»£è¡¨æ¥ä¸‹æ¥çš„èŠ‚ç‚¹æ²¡æœ‰å˜åŒ–ï¼Œå°±ä¼šå¯¼è‡´å®Œå…¨ä¸ä¸€æ ·çš„ç»“æœã€‚\n\nå¦‚ä½•é¿å…ï¼Ÿ\n\nåŠ æ—¶é—´æˆ³ï¼Œä¸Šæ–‡ç”¨äº†AtomicReferenceï¼Œè¿™å›ç”¨AtomicStampedReferenceï¼Œè¿™é‡Œä½¿ç”¨äº†æ—¶é—´æˆ³ï¼Œåªæœ‰å½“æ—¶é—´æˆ³ç›¸åŒå¹¶ä¸”å®é™…å€¼ç­‰äºé¢„æœŸå€¼ï¼Œæ‰å¯ä»¥ã€‚\n\n# Synchronizedå…³é”®å­—\n\nåœ¨ Java æ—©æœŸç‰ˆæœ¬ä¸­ï¼Œsynchronized å±äº é‡é‡çº§é”ï¼Œæ•ˆç‡ä½ä¸‹ã€‚è¿™æ˜¯å› ä¸ºç›‘è§†å™¨é”ï¼ˆmonitorï¼‰æ˜¯ä¾èµ–äºåº•å±‚çš„æ“ä½œç³»ç»Ÿçš„ Mutex Lock æ¥å®ç°çš„ï¼ŒJava çš„çº¿ç¨‹æ˜¯æ˜ å°„åˆ°æ“ä½œç³»ç»Ÿçš„åŸç”Ÿçº¿ç¨‹ä¹‹ä¸Šçš„ã€‚å¦‚æœè¦æŒ‚èµ·æˆ–è€…å”¤é†’ä¸€ä¸ªçº¿ç¨‹ï¼Œéƒ½éœ€è¦æ“ä½œç³»ç»Ÿå¸®å¿™å®Œæˆï¼Œè€Œæ“ä½œç³»ç»Ÿå®ç°çº¿ç¨‹ä¹‹é—´çš„åˆ‡æ¢æ—¶éœ€è¦ä»ç”¨æˆ·æ€è½¬æ¢åˆ°å†…æ ¸æ€ï¼Œè¿™ä¸ªçŠ¶æ€ä¹‹é—´çš„è½¬æ¢éœ€è¦ç›¸å¯¹æ¯”è¾ƒé•¿çš„æ—¶é—´ï¼Œæ—¶é—´æˆæœ¬ç›¸å¯¹è¾ƒé«˜ã€‚\n\nä¸è¿‡ï¼Œåœ¨ Java 6 ä¹‹åï¼Œ synchronized å¼•å…¥äº†å¤§é‡çš„ä¼˜åŒ–å¦‚è‡ªæ—‹é”ã€é€‚åº”æ€§è‡ªæ—‹é”ã€é”æ¶ˆé™¤ã€é”ç²—åŒ–ã€åå‘é”ã€è½»é‡çº§é”ç­‰æŠ€æœ¯æ¥å‡å°‘é”æ“ä½œçš„å¼€é”€ï¼Œè¿™äº›ä¼˜åŒ–è®© synchronized é”çš„æ•ˆç‡æå‡äº†å¾ˆå¤šã€‚å› æ­¤ï¼Œ synchronized è¿˜æ˜¯å¯ä»¥åœ¨å®é™…é¡¹ç›®ä¸­ä½¿ç”¨çš„ï¼Œåƒ JDK æºç ã€å¾ˆå¤šå¼€æºæ¡†æ¶éƒ½å¤§é‡ä½¿ç”¨äº† synchronized ã€‚\n\nå…³äºåå‘é”å¤šè¡¥å……ä¸€ç‚¹ï¼šç”±äºåå‘é”å¢åŠ äº† JVM çš„å¤æ‚æ€§ï¼ŒåŒæ—¶ä¹Ÿå¹¶æ²¡æœ‰ä¸ºæ‰€æœ‰åº”ç”¨éƒ½å¸¦æ¥æ€§èƒ½æå‡ã€‚å› æ­¤ï¼Œåœ¨ JDK15 ä¸­ï¼Œåå‘é”è¢«é»˜è®¤å…³é—­ï¼ˆä»ç„¶å¯ä»¥ä½¿ç”¨ -XX:+UseBiasedLocking å¯ç”¨åå‘é”ï¼‰ï¼Œåœ¨ JDK18 ä¸­ï¼Œåå‘é”å·²ç»è¢«å½»åº•åºŸå¼ƒï¼ˆæ— æ³•é€šè¿‡å‘½ä»¤è¡Œæ‰“å¼€ï¼‰ã€‚\n\n## å¦‚ä½•ä½¿ç”¨Synchronizedå…³é”®å­—ï¼Ÿ\n1. ä¿®é¥°æ–¹æ³•\n2. ä¿®é¥°é™æ€æ–¹æ³•ï¼ˆé”ä½å½“å‰ç±»ï¼‰ï¼šæ³¨æ„ä¿®é¥°é™æ€æ–¹æ³•æ˜¯æ²¡æœ‰äº’æ–¥æ€§çš„ï¼Œå› ä¸ºé™æ€æ–¹æ³•æ˜¯æ”¾åœ¨è¿›ç¨‹ä¸­é™æ€ä»£ç å—é‚£ä¸€éƒ¨åˆ†çš„ï¼Œæ‰€æœ‰çº¿ç¨‹å…±äº«ï¼Œæ¯ä¸€ä¸ªçº¿ç¨‹éƒ½å¯ä»¥è®¿é—®\n3. ä¿®é¥°ä»£ç å—ï¼š\n- synchronized(object) è¡¨ç¤ºè¿›å…¥åŒæ­¥ä»£ç åº“å‰è¦è·å¾— ç»™å®šå¯¹è±¡çš„é”ã€‚\n- synchronized(ç±».class) è¡¨ç¤ºè¿›å…¥åŒæ­¥ä»£ç å‰è¦è·å¾— ç»™å®š Class çš„é”\n\næ€»ç»“ï¼š\n- synchronized å…³é”®å­—åŠ åˆ° static é™æ€æ–¹æ³•å’Œ synchronized(class) ä»£ç å—ä¸Šéƒ½æ˜¯æ˜¯ç»™ Class ç±»ä¸Šé”ï¼›\n- synchronized å…³é”®å­—åŠ åˆ°å®ä¾‹æ–¹æ³•ä¸Šæ˜¯ç»™å¯¹è±¡å®ä¾‹ä¸Šé”ï¼›\n- å°½é‡ä¸è¦ä½¿ç”¨ synchronized(String a) å› ä¸º JVM ä¸­ï¼Œå­—ç¬¦ä¸²å¸¸é‡æ± å…·æœ‰ç¼“å­˜åŠŸèƒ½ã€‚\n\n## æ„é€ æ–¹æ³•å¯ä»¥è¢«Synchronizedä¿®é¥°å—ã€‹\nä¸å¯ä»¥ï¼Œå› ä¸ºæœ¬èº«æ„é€ æ–¹æ³•å°±å·²ç»æ˜¯çº¿ç¨‹å®‰å…¨çš„äº†\n\n## Synchronizedåº•å±‚åŸç†\n\nåŸºäºjvmçš„monitor,åœ¨javaç¼–è¯‘çš„æ—¶å€™ä¼šç»™åŠ é”ä»£ç åŠ ä¸Šmonitorenterå’Œä¸¤ä¸ªmonitorexitï¼Œåœ¨è¿™ä¸­é—´çš„å°±æ˜¯äº’æ–¥çš„ï¼Œä¸ºä»€ä¹ˆè¦æœ‰ä¸¤ä¸ªå‘¢ï¼Œçº¿ç¨‹æœ‰çš„æ—¶å€™ä¼šæŠ›å‡ºå¼‚å¸¸æˆ–è€…é”™è¯¯ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¼šèµ°ç¬¬äºŒä¸ªexitï¼Œç”¨ä¸¤ä¸ªæ˜¯ä¸ºäº†ä¿è¯ä¸€å®šèƒ½é€€å‡ºã€‚\n\nmonitorä¹Ÿæ˜¯åŸºäºc++çš„ï¼Œåˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼Œä¸€ä¸ªæ˜¯å½“å‰è·å–é”çš„å¯¹è±¡ï¼Œè¿˜æœ‰ä¸€ä¸ªæ˜¯ç­‰å¾…é˜Ÿåˆ—ï¼Œä¸€ä¸ªæ˜¯é˜»å¡é˜Ÿåˆ—ã€‚\n\nä¸Šé”æˆåŠŸçš„æ ‡å¿—æ˜¯monitorçš„æ‹¥æœ‰è€…ä¸ºå½“å‰çº¿ç¨‹ï¼Œå½“é‡Šæ”¾çš„æ—¶å€™ä¼šå”¤é†’é˜»å¡è¿›ç¨‹ï¼Œæœ‰ä¸€ç‚¹è¦è¯´æ˜çš„æ˜¯è¿™ä¸ªè¿‡ç¨‹æ˜¯éå…¬å¹³ï¼Œä¹Ÿå°±æ˜¯è¿è¡Œä¸åœ¨é˜Ÿåˆ—é‡Œçš„æ–°è¿›ç¨‹ä¹Ÿæ¥æŠ¢ã€‚\n\n## Synchronizedé”å‡çº§åŸç†\n\n> è¿™ä¸€å—æš‚æ—¶è¿˜æ²¡æœ‰ç»†ç»†ç ”ç©¶ã€‚\n\næœ‰å››ç§é”ç­‰çº§ï¼Œé”çš„é‡é‡ä¾æ¬¡é€’å¢ï¼š\n1. ä¸åŠ é”\n2. åŠ åå‘é”ï¼šä¸€æ®µå¾ˆé•¿çš„æ—¶é—´å†…éƒ½åªè¢«ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨é”ï¼Œå¯ä»¥ä½¿ç”¨äº†åå‘é”ï¼Œåœ¨ç¬¬ä¸€æ¬¡è·å¾—é”æ—¶ï¼Œä¼šæœ‰ä¸€ä¸ªCASæ“ä½œï¼Œä¹‹åè¯¥çº¿ç¨‹å†è·å–é”ï¼Œåªéœ€è¦åˆ¤æ–­mark wordä¸­æ˜¯å¦æ˜¯è‡ªå·±çš„çº¿ç¨‹idå³å¯ï¼Œè€Œä¸æ˜¯å¼€é”€ç›¸å¯¹è¾ƒå¤§çš„CASå‘½ä»¤ã€‚è¿™ä¹Ÿæ˜¯æŸç§æŠ•æœºè¡Œä¸ºï¼Œä¹è§‚é”æ€æƒ³ï¼Œåœ¨å¾ˆå°‘æœ‰è¿›ç¨‹ç«äº‰çš„æ—¶å€™æ¯”è¾ƒèŠ‚çº¦èµ„æº\n3. åŠ è½»åº¦é”ï¼šä¹Ÿå°±æ˜¯è‡ªæ—‹é”ç­‰ï¼Œæ¯æ¬¡æ“ä½œéƒ½æ˜¯casï¼Œè¿˜æ˜¯ä¹è§‚é”æ€æƒ³ï¼Œè¿™ä¸ªå°±æ¯”åå‘é”ç¨å¾®æ§åˆ¶äº†ä¸€ç‚¹\n4. é‡åº¦é”ï¼Œä½¿ç”¨monitoré‚£ç§æ‚²è§‚é”\n\nSynchronizedå‘ç”Ÿç«äº‰ä¼šä¾æ¬¡å‡çº§é”ï¼Œé«˜å¹¶å‘ä¸‹å˜æˆæ‚²è§‚é”\n\n## Synchronizedå’Œvolatileä»€ä¹ˆåŒºåˆ«\n\n1. Synchronizedä¿®é¥°æ–¹æ³•ï¼Œé™æ€æ–¹æ³•ï¼Œä»£ç å—ç­‰ï¼Œè€Œvolatileä¿®é¥°å˜é‡\n2. volatileæ˜¯çº¿ç¨‹åŒæ­¥çš„è½»é‡å®ç°ï¼Œå…·æœ‰å¯è§æ€§ä½†æ˜¯æ²¡æœ‰åŸå­æ€§ï¼ŒSynchronizedå¯ä»¥ä¿è¯å¯è§æ€§å’ŒåŸå­æ€§\n3. volatileæ€§èƒ½è‚¯å®šæ¯”Synchronizedå¥½ï¼Œä½†æ˜¯ä¸»è¦è§£å†³çš„æ˜¯å˜é‡çš„é—®é¢˜ï¼ŒSynchronizedè§£å†³æ–¹æ³•çš„åŒæ­¥å’Œäº’æ–¥ã€‚\n\n# ReentrantLock\n\nå¯é‡å…¥é”ï¼Œå®ç°äº†Lockæ¥å£ï¼Œç›¸æ¯”SynchronizedåŠŸèƒ½æ›´å¤šï¼Œå®ç°äº†è½®è¯¢ï¼Œè¶…æ—¶ï¼Œä¸­æ–­ï¼Œå…¬å¹³é”å’Œéå…¬å¹³é”ã€‚\n\nå…¬å¹³å’Œéå…¬å¹³é”ä¸»è¦æ˜¯Syncé‡Œé¢å®ç°çš„ï¼Œè€ŒSyncç»§æ‰¿è‡ª**AQS**ï¼Œä¹Ÿå°±æ˜¯è¯´ReentrantLockç”¨çš„å°±æ˜¯AQSæ€æƒ³ã€‚\n\n## AQS\nä¸»è¦æ•°æ®ç»“æ„æ˜¯CLHï¼Œæœ€æ—©çš„CLHæ˜¯ä¸€ä¸ªè™šæ‹Ÿçš„å•å‘é“¾è¡¨ï¼Œä¸ºä»€ä¹ˆæ˜¯è™šæ‹Ÿçš„å‘¢ï¼Œå› ä¸ºç”šè‡³è¿æŒ‡é’ˆéƒ½æ²¡æœ‰ï¼Œä¸€ä¸ªCLHèŠ‚ç‚¹å°±åŒ…å«ä¸¤ä¸ªç»“æ„ï¼Œä¸€ä¸ªæ˜¯å½“å‰çº¿ç¨‹ï¼Œå¦å¤–ä¸€ä¸ªæ˜¯ä¸€ä¸ªboolå˜é‡ï¼Œç”¨æ¥è¡¨ç¤ºæ˜¯å¦è·å¾—äº†é”ã€‚\n\n**é‚£æ˜¯æ€ä¹ˆè¿ä½œçš„å‘¢ï¼Ÿ**\n\nåˆå§‹åŒ–ä¸€ä¸ªå°¾èŠ‚ç‚¹ï¼Œçº¿ç¨‹é‚£éƒ¨åˆ†ä¸ºç©ºï¼Œbooléƒ¨åˆ†ä¸ºtrueï¼Œä¹Ÿå°±æ˜¯è¯´å¯ä»¥è¢«ä¸Šé”ï¼Œæ¯ä¸€ä¸ªçº¿ç¨‹éƒ½ç”¨**è‡ªæ—‹çš„æ–¹å¼**å°è¯•è·å¾—æ¥çš„æ—¶å€™çš„å°¾èŠ‚ç‚¹çš„boolå€¼ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™æ¥äº†ä¸€ä¸ªçº¿ç¨‹ï¼Œç”¨CASå°è¯•è·å–ç°åœ¨çš„å°¾èŠ‚ç‚¹çš„boolï¼Œä¸ºçœŸï¼Œé‚£å°±å¯ä»¥ä¸Šé”ä¸ºfalseï¼ŒåŒæ—¶è‡ªå·±çš„boolä¹Ÿä¸ºfalseï¼Œè¡¨ç¤ºå‰é¢çš„èŠ‚ç‚¹éƒ½ä¸èƒ½ç”¨ï¼Œæ‰€ä»¥ä¸‹ä¸€ä¸ªä¹Ÿä¸èƒ½ã€‚\n\næ¥äº†ä¸€ä¸ªçº¿ç¨‹2ï¼Œç°åœ¨çš„å°¾èŠ‚ç‚¹æ˜¯çº¿ç¨‹1ï¼Œä»–çš„boolæ˜¯falseï¼Œçº¿ç¨‹2ä¼šä¸€ç›´è‡ªæ—‹çš„è·å–å‰ä¸€ä¸ªèŠ‚ç‚¹çš„boolå€¼ï¼Œåé¢çš„ä¹Ÿæ˜¯ï¼Œå¦‚æœæ­¤æ—¶çº¿ç¨‹1å¥½äº†ï¼Œé‚£ä¹ˆçº¿ç¨‹2ç›‘å¬åˆ°å‰é¢ä¸€ä¸ªå˜æˆäº†trueï¼Œé‚£å°±ä¼šå¼€å§‹çº¿ç¨‹2ï¼Œä»¥æ­¤ç±»æ¨ã€‚\n\nä¼˜ç‚¹å¾ˆæ˜æ˜¾ï¼šå¦‚æœæ—¶é—´çŸ­ï¼Œé‚£ä¹ˆè·å–å’Œé‡Šæ”¾é”çš„å¼€é”€å°ã€‚CLH çš„é”çŠ¶æ€ä¸å†æ˜¯å•ä¸€çš„åŸå­å˜é‡ï¼Œè€Œæ˜¯åˆ†æ•£åœ¨æ¯ä¸ªèŠ‚ç‚¹çš„çŠ¶æ€ä¸­ï¼Œé™ä½äº†è‡ªæ—‹é”åœ¨ç«äº‰æ¿€çƒˆæ—¶é¢‘ç¹åŒæ­¥çš„å¼€é”€ã€‚è¿˜æœ‰å°±æ˜¯å…¬å¹³ï¼Œå…ˆè¿›å…ˆå‡º\n\nè¿™æ ·çš„CLHæœ‰ä»€ä¹ˆç¼ºç‚¹å‘¢ï¼Œé¦–å…ˆæ˜¯éƒ½æ˜¯è‡ªæ—‹ï¼Œå¦‚æœæ—¶é—´çŸ­è¿˜å¥½ï¼Œé•¿äº†é‚£è‚¯å®šæµªè´¹èµ„æºã€‚åŠŸèƒ½å•ä¸€ï¼Œä¸èƒ½æ”¯æŒReentrantLockçš„é‚£äº›æ¥å£åŠŸèƒ½ã€‚\n\n**AQSå¯¹äºCLHçš„æ”¹é€ **\n\né’ˆå¯¹è‡ªæ—‹ï¼ŒAQSéƒ½æ”¹é€ æˆäº†é˜»å¡ï¼Œè¿˜æ˜¯ä¸èƒ½ç”¨è‡ªæ—‹ã€‚é’ˆå¯¹ç¬¬äºŒä¸ªåŠŸèƒ½å•ä¸€çš„ç¼ºç‚¹ï¼Œä½¿ç”¨äº†åŒå‘é“¾è¡¨å’Œä¸€ä¸ªå…¨å±€å˜é‡stateï¼ˆå…¶å®æˆ‘è§‰å¾—ä¹‹å‰é‚£ç§çœ‹ä¸Šä¸€ä¸ªèŠ‚ç‚¹æƒ…å†µçš„æœºåˆ¶è¿˜è›®å¥½çš„ï¼Œè¿™ä¸æ˜¯åˆé‡æ–°å˜æˆä¿¡å·é‡é‚£ç§æœºåˆ¶äº†ï¼‰\n\nstateå±æ€§è¡¨ç¤ºèµ„æºçš„çŠ¶æ€ï¼Œä¸º0è¡¨ç¤ºå¯ä»¥æŠ¢äº†ï¼Œä¸º1è¡¨ç¤ºä¸èƒ½ï¼Œä¸º1æ—¶å€™æ¥çš„çº¿ç¨‹è¿›é˜»å¡é˜Ÿåˆ—\n- å…¬å¹³ä¸éå…¬å¹³ï¼Œå…¬å¹³å°±æ˜¯ç›´æ¥æ¯æ¬¡éƒ½å”¤é†’é˜Ÿåˆ—å¤´çš„ï¼Œéå…¬å¹³å°±æ˜¯æ¥çš„ä¹Ÿä¸€èµ·ç«äº‰ï¼Œä½†æ˜¯å¯èƒ½ä¼šå¯¼è‡´é¥¥é¥¿\n- å¯é‡å…¥ï¼šä¸€ä¸ªçº¿ç¨‹å¤šæ¬¡è¿›å…¥å¯ä»¥stateè‡ªå¢ï¼Œå¦‚æœé‡å…¥ä¸¤æ¬¡é‚£ä¹ˆstateå°±æ˜¯2ï¼Œä½†æ˜¯è¦ä¿è¯åŠ é”å‡ æ¬¡å°±è§£é”å‡ æ¬¡ï¼Œä¿è¯æœ€ç»ˆè¿˜æ˜¯0\n\n# ReentrantLockå’ŒsynchronizedåŒºåˆ«\n\n1. é¦–å…ˆä¸¤è€…éƒ½æ˜¯æ‚²è§‚é”ï¼Œä¹Ÿéƒ½æ˜¯å¯é‡å…¥çš„ï¼Œsynchronizedæ˜¯ä¸€ä¸ªå…³é”®å­—ï¼ŒåŸºäºjvmå®ç°ï¼ŒReentrantLockæ˜¯ä¸€ä¸ªæ˜¯å®ç°ç±»ï¼Œå®ç°Lockæ¥å£ï¼Œä½¿ç”¨çš„æ—¶å€™éœ€è¦å£°æ˜ã€‚\n2. ReentrantLockåŠŸèƒ½æ¯”è¾ƒå¤šï¼Œå®ç°äº†å¯ä¸­æ–­ï¼ˆä¸­æ–­ä¹Ÿå°±è¯´å¦‚æœå¾—ä¸åˆ°é”å°±å»å¹²åˆ«çš„äº‹æƒ…äº†ï¼Œsynchronizedä¸å¯ä¸­æ–­ï¼‰ï¼Œå¯è¶…æ—¶ï¼ˆReentrantLockå®ç°äº†ï¼Œå¦‚æœè¶…æ—¶å¤šå°‘å°±ä¸å»äº‰æŠ¢é”äº†ï¼Œsynå®ç°ä¸äº†ï¼‰ï¼Œé”å¯ä»¥ç»‘å®šå¤šä¸ªæ¡ä»¶ï¼ˆConditionç±»ï¼Œå°±ç›¸å½“äºä¸åŒçš„ä¿¡å·é‡ï¼Œå¯ä»¥æ§åˆ¶ä¸€éƒ¨åˆ†Conditionä¸‹çš„è¿›ç¨‹ç­‰å¾…ï¼Œå¦ä¸€éƒ¨åˆ†çš„æ‰§è¡Œï¼‰\n3. æ²¡æœ‰ç«äº‰çš„æ—¶å€™synchronizedä¼˜åŒ–å¾ˆå¤šï¼Œé”æ²¡æœ‰å‡çº§çš„æ—¶å€™æ€§èƒ½å¾ˆå¥½ï¼›é‡åº¦çš„æ—¶å€™Lockçš„æ€§èƒ½æ¯”è¾ƒå¥½ï¼Œå› ä¸ºåº•å±‚è¿˜æ˜¯ç”¨äº†casçš„ä¸€éƒ¨åˆ†ä¹è§‚æœºåˆ¶ï¼Œç›¸æ¯”synchronizedçš„monitorè¿˜æ˜¯å¥½ä¸€ç‚¹\n\n","tags":["Java"]},{"title":"mysql-ç´¢å¼•å’Œç´¢å¼•å¤±æ•ˆ","url":"/2024/04/05/mysql-ç´¢å¼•å’Œç´¢å¼•å¤±æ•ˆ/","content":"# ç´¢å¼•å¤±æ•ˆ\n## å·¦åŒ¹é…æˆ–è€…å·¦å³åŒ¹é…\nå½“æˆ‘ä»¬ä½¿ç”¨å·¦æˆ–è€…å·¦å³æ¨¡ç³ŠåŒ¹é…çš„æ—¶å€™ï¼Œä¹Ÿå°±æ˜¯ like %xx æˆ–è€… like %xx% è¿™ä¸¤ç§æ–¹å¼éƒ½ä¼šé€ æˆç´¢å¼•å¤±æ•ˆã€‚\n\n**ä¸ºä»€ä¹ˆ like å…³é”®å­—å·¦æˆ–è€…å·¦å³æ¨¡ç³ŠåŒ¹é…æ— æ³•èµ°ç´¢å¼•å‘¢ï¼Ÿ**\n\nå› ä¸ºç´¢å¼• B+ æ ‘æ˜¯æŒ‰ç…§ã€Œç´¢å¼•å€¼ã€æœ‰åºæ’åˆ—å­˜å‚¨çš„ï¼Œåªèƒ½æ ¹æ®å‰ç¼€è¿›è¡Œæ¯”è¾ƒã€‚\n\nä¸¾ä¸ªä¾‹å­ï¼Œä¸‹é¢è¿™å¼ äºŒçº§ç´¢å¼•å›¾ï¼ˆå›¾ä¸­å¶å­èŠ‚ç‚¹ä¹‹é—´æˆ‘ç”»äº†å•å‘é“¾è¡¨ï¼Œä½†æ˜¯å®é™…ä¸Šæ˜¯åŒå‘é“¾è¡¨ï¼ŒåŸå›¾æˆ‘æ‰¾ä¸åˆ°äº†ï¼Œä¿®æ”¹ä¸äº†ï¼Œå·ä¸ªæ‡’æˆ‘ä¸é‡ç”»äº†ï¼Œå¤§å®¶è„‘è¡¥æˆåŒå‘é“¾è¡¨å°±è¡Œï¼‰ï¼Œæ˜¯ä»¥ name å­—æ®µæœ‰åºæ’åˆ—å­˜å‚¨çš„ã€‚\n\n![](../img/Mysql/img_13.png)\n\n\nå‡è®¾æˆ‘ä»¬è¦æŸ¥è¯¢ name å­—æ®µå‰ç¼€ä¸ºã€Œæ—ã€çš„æ•°æ®ï¼Œä¹Ÿå°±æ˜¯ name like 'æ—%'ï¼Œæ‰«æç´¢å¼•çš„è¿‡ç¨‹ï¼ˆè¿™é‡Œä¸­æ–‡éƒ½æ˜¯æŒ‰ç…§æŸç§æ’åºï¼Œä¸çŸ¥é“æ˜¯ä¸æ˜¯æŒ‰ç…§utf-8çš„ç¼–ç å€¼æ¯”è¾ƒçš„ï¼Œä½†æ˜¯è¿™ä¸ªè§„åˆ™ä¸å½±å“å¯»æ‰¾åˆ°é€»è¾‘ï¼‰ï¼š\n- èŠ‚ç‚¹1åˆ¤æ–­å‡ºâ€œæ—â€å°äºâ€œå‘¨â€å¹¶ä¸”å¤§äºâ€œé™ˆâ€ï¼ˆè¿™ä¸ªæ­¥éª¤æ˜¯é€šè¿‡**é¡µç›®å½•**è¿›è¡Œæœç´¢çš„ï¼Œå›é¡¾ä¸€ä¸‹ï¼šå‡è®¾è¿™é‡Œå¤´æŒ‡é’ˆæ˜¯ä¸€ä¸ªåˆ†ç»„ï¼Œé™ˆæ˜¯ä¸€ä¸ªåˆ†ç»„ï¼Œå‰©ä¸‹ä¸¤ä¸ªå’Œå°¾æŒ‡é’ˆæ˜¯ä¸€ä¸ªåˆ†ç»„ï¼ŒäºŒåˆ†æŸ¥æ‰¾ç›®å½•é¡¹ï¼Œç”±äºç›®å½•é¡¹æŒ‡å‘åˆ†ç»„çš„æœ€å¤§å€¼ï¼Œé‚£ä¹ˆâ€œæ—â€æ˜¯å¤§äºé™ˆå°äºå‘¨çš„ï¼ŒæŒ‰ç…§ç›®å½•é¡¹çš„è§„åˆ™ï¼Œä»*åŒ…å«å°¾æŒ‡é’ˆçš„é‚£ä¸ªåˆ†ç»„å¼€å§‹*ï¼Œä½†æ˜¯ç”±äºå­˜çš„æ˜¯æœ€å¤§å€¼ä¹Ÿå°±æ˜¯å°¾æŒ‡é’ˆï¼Œä¸ºäº†ä»å¤´å¼€å§‹éå†ï¼Œå°±è¦æ‰¾åˆ°ä¸Šä¸€ä¸ªæ§½çš„æŒ‡é’ˆï¼Œå¾€åæ•°ä¸€ä¸ªå°±æ˜¯å½“å‰çš„æœ€å°å€¼ï¼Œç»“æœå‘ç°å½“å‰çš„æœ€å°å€¼â€œå‘¨â€è¿˜æ˜¯å¤§äºâ€œæ—â€ï¼Œè¿™æ ·å°±å®šä½åœ¨â€œé™ˆâ€å’Œâ€œå‘¨â€ä¹‹é—´ï¼ŒæŒ‰ç…§å­˜å‚¨è§„åˆ™ï¼Œ**éå¶å­èŠ‚ç‚¹å­˜çš„æ˜¯ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„æœ€å°å€¼**ï¼Œé‚£å°±è¦åœ¨â€œé™ˆâ€è¿™ä¸ªèŠ‚ç‚¹æ‰¾ï¼‰\n- èŠ‚ç‚¹2ç»§ç»­æ¯”è¾ƒï¼šèŠ‚ç‚¹2çš„ç¬¬ä¸€ä¸ªç´¢å¼•å€¼ä¸­çš„é™ˆå­—çš„æ‹¼éŸ³å¤§å°æ¯”æ—å­—å°ï¼Œæ‰€ä»¥ç»§ç»­çœ‹ä¸‹ä¸€ä¸ªç´¢å¼•å€¼ï¼Œå‘ç°èŠ‚ç‚¹2æœ‰ä¸æ—å­—å‰ç¼€åŒ¹é…çš„ç´¢å¼•å€¼ï¼Œäºæ˜¯å°±å¾€å¶å­èŠ‚ç‚¹æŸ¥è¯¢ï¼Œå³å¶å­èŠ‚ç‚¹4\n- èŠ‚ç‚¹4æŸ¥è¯¢æ¯”è¾ƒï¼šèŠ‚ç‚¹4çš„ç¬¬ä¸€ä¸ªç´¢å¼•å€¼çš„å‰ç¼€ç¬¦åˆæ—å­—ï¼Œäºæ˜¯å°±è¯»å–è¯¥è¡Œæ•°æ®ï¼Œæ¥ç€ç»§ç»­å¾€å³åŒ¹é…ï¼Œç›´åˆ°åŒ¹é…ä¸åˆ°å‰ç¼€ä¸ºæ—çš„ç´¢å¼•å€¼ã€‚\n  \nå¦‚æœä½¿ç”¨ name like '%æ—' æ–¹å¼æ¥æŸ¥è¯¢ï¼Œå› ä¸ºæŸ¥è¯¢çš„ç»“æœå¯èƒ½æ˜¯ã€Œé™ˆæ—ã€å¼ æ—ã€å‘¨æ—ã€ç­‰ä¹‹ç±»çš„ï¼Œæ‰€ä»¥ä¸çŸ¥é“ä»å“ªä¸ªç´¢å¼•å€¼å¼€å§‹æ¯”è¾ƒï¼Œäºæ˜¯å°±åªèƒ½é€šè¿‡å…¨è¡¨æ‰«æçš„æ–¹å¼æ¥æŸ¥è¯¢ã€‚\n> æ€»è€Œè¨€ä¹‹ï¼Œç´¢å¼•æ˜¯ä»å·¦è¾¹å¼€å§‹åŒ¹é…çš„ï¼Œå¦‚æœå·¦è¾¹ç¬¬ä¸€ä¸ªéƒ½ä¸èƒ½ç¡®å®šï¼Œé‚£å°±è¦å…¨éƒ¨éå†\n## å¯¹ç´¢å¼•ä½¿ç”¨å‡½æ•°\næœ‰æ—¶å€™æˆ‘ä»¬ä¼šç”¨ä¸€äº› MySQL è‡ªå¸¦çš„å‡½æ•°æ¥å¾—åˆ°æˆ‘ä»¬æƒ³è¦çš„ç»“æœï¼Œè¿™æ—¶å€™è¦æ³¨æ„äº†ï¼Œå¦‚æœæŸ¥è¯¢æ¡ä»¶ä¸­å¯¹ç´¢å¼•å­—æ®µä½¿ç”¨å‡½æ•°ï¼Œå°±ä¼šå¯¼è‡´ç´¢å¼•å¤±æ•ˆã€‚\n\n**ä¸ºä»€ä¹ˆå¯¹ç´¢å¼•ä½¿ç”¨å‡½æ•°ï¼Œå°±æ— æ³•èµ°ç´¢å¼•äº†å‘¢ï¼Ÿ**\n\nå› ä¸ºç´¢å¼•ä¿å­˜çš„æ˜¯ç´¢å¼•å­—æ®µçš„åŸå§‹å€¼ï¼Œè€Œä¸æ˜¯ç»è¿‡å‡½æ•°è®¡ç®—åçš„å€¼ï¼Œè‡ªç„¶å°±æ²¡åŠæ³•èµ°ç´¢å¼•äº†ã€‚\n\nä¸è¿‡ï¼Œä» MySQL 8.0 å¼€å§‹ï¼Œç´¢å¼•ç‰¹æ€§å¢åŠ äº†å‡½æ•°ç´¢å¼•ï¼Œå³å¯ä»¥é’ˆå¯¹å‡½æ•°è®¡ç®—åçš„å€¼å»ºç«‹ä¸€ä¸ªç´¢å¼•ï¼Œä¹Ÿå°±æ˜¯è¯´è¯¥ç´¢å¼•çš„å€¼æ˜¯å‡½æ•°è®¡ç®—åçš„å€¼ï¼Œæ‰€ä»¥å°±å¯ä»¥é€šè¿‡æ‰«æç´¢å¼•æ¥æŸ¥è¯¢æ•°æ®ã€‚\n\nä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘é€šè¿‡ä¸‹é¢è¿™æ¡è¯­å¥ï¼Œå¯¹ length(name) çš„è®¡ç®—ç»“æœå»ºç«‹ä¸€ä¸ªåä¸º idx_name_length çš„ç´¢å¼•ã€‚\n\n```text\nalter table t_user add key idx_name_length ((length(name)));\n```\n> æ€»è€Œè¨€ä¹‹ï¼Œç´¢å¼•ä¿å­˜çš„æ˜¯åŸå§‹å€¼ï¼Œä½¿ç”¨å‡½æ•°åé‡æ–°è®¡ç®—å¯¼è‡´ä¸èƒ½ç´¢å¼•åˆ°ï¼Œå°±å¤±æ•ˆäº†ï¼Œä½†æ˜¯å¦‚æœå¯¹è¿™ä¸ªå‡½æ•°ä¹Ÿå»ºç«‹ä¸€ä¸ªç´¢å¼•ï¼Œé‚£ä¹Ÿå¯ä»¥èµ°ç´¢å¼•\n## æ•°æ®ç±»å‹å¼ºåˆ¶è½¬æ¢\n> è¿™ä¸ªå°è±¡æ¯”è¾ƒæ·±åˆ»ï¼šé¦–å…ˆä¸¾ä¸€ä¸ªä¾‹å­ï¼Œselect \"10\" > 9ï¼Œé€šè¿‡è¿™ä¸ªä¾‹å­å¯ä»¥çœ‹å‡ºæ¥åœ¨mysqlæ˜¯æ€ä¹ˆå¤„ç†å­—ç¬¦ä¸²çš„\n> - å¦‚æœæ˜¯ç»“æœæ˜¯1ï¼Œä¹Ÿå°±æ˜¯select 10>9ï¼Œé‚£ä¹ˆå†…éƒ¨ä¼šæŠŠå­—ç¬¦ä¸²å¤„ç†æˆæ•°å­—\n> - å¦‚æœç»“æœæ˜¯0ï¼Œä¹Ÿå°±æ˜¯select \"10\" > \"9\"ï¼Œå­—ç¬¦ä¸²æ˜¯æ¯”è¾ƒé¦–ä½ï¼Œ1è‚¯å®šå°äº9ï¼Œæ‰€ä»¥è¿™ä¸ªç»“æœæ˜¯0ï¼Œé‚£ä¹ˆå†…éƒ¨æŠŠæ•°å­—å¤„ç†æˆå­—ç¬¦ä¸²\n> ç»“æœæ˜¯1ï¼Œä¹Ÿå°±æ˜¯**mysqlå†…éƒ¨æŠŠå­—ç¬¦ä¸²å˜æˆæ•°å­—è¿›è¡Œæ¯”è¾ƒ**\n\nå‡è®¾phoneåœ¨æ•°æ®åº“æ˜¯ç”¨varcharå­˜çš„ï¼Œæœ‰äº†è¿™ä¸ªç»“è®ºï¼Œé‚£ä¹ˆ\n```text\nselect * from t_user where phone = 1300000001;\n```\nè¿™ä¸ªä»£ç å°±ä¼šå˜æˆï¼š\n```text\nselect * from t_user where CAST(phone AS signed int) = 1300000001;\n```\nå› ä¸ºå†…éƒ¨ä¼šæŠŠç´¢å¼•çš„å­—ç¬¦ä¸²å˜æˆæ•´æ•°è¿›è¡Œæ¯”è¾ƒï¼Œç›¸å½“äºç»™ç´¢å¼•ä½¿ç”¨äº†å‡½æ•°ï¼Œæ‰€ä»¥å°±ä¼šå¤±æ•ˆ\n\nå¦‚æœæŸ¥è¯¢æ¡ä»¶æ˜¯å­—ç¬¦ä¸²ï¼Œidåœ¨æ•°æ®åº“ç”¨intå­˜çš„\n```text\nselect * from t_user where id = \"1\";\n```\né‚£ä¹ˆå°±ä¼šå˜æˆï¼š\n```text\nselect * from t_user where id = CAST(\"1\" AS signed int);\n```\nä¹Ÿå°±æ˜¯è¯´ï¼Œåªæœ‰è¿™ä¸ªæŸ¥è¯¢æ¡ä»¶ä¼šè¦ç”¨è¿™ä¸ªå‡½æ•°ï¼Œç´¢å¼•æ²¡æœ‰ç”¨ï¼Œç´¢å¼•å°±ä¸å¤±æ•ˆ\n## å¯¹ç´¢å¼•è¿›è¡Œè¡¨è¾¾å¼è®¡ç®—\nåœ¨æŸ¥è¯¢æ¡ä»¶ä¸­å¯¹ç´¢å¼•è¿›è¡Œè¡¨è¾¾å¼è®¡ç®—ï¼Œä¹Ÿæ˜¯æ— æ³•èµ°ç´¢å¼•çš„ã€‚\n\næ¯”å¦‚ï¼Œä¸‹é¢è¿™æ¡æŸ¥è¯¢è¯­å¥ï¼Œæ‰§è¡Œè®¡åˆ’ä¸­ type = ALLï¼Œè¯´æ˜æ˜¯é€šè¿‡å…¨è¡¨æ‰«æçš„æ–¹å¼æŸ¥è¯¢æ•°æ®çš„ï¼š\n\n```text\nexplain select * from t_user where id + 1 = 10;\n```\n\n**ä¸ºä»€ä¹ˆå¯¹ç´¢å¼•è¿›è¡Œè¡¨è¾¾å¼è®¡ç®—ï¼Œå°±æ— æ³•èµ°ç´¢å¼•äº†å‘¢ï¼Ÿ**\n\nåŸå› è·Ÿå¯¹ç´¢å¼•ä½¿ç”¨å‡½æ•°å·®ä¸å¤šã€‚\n\nå› ä¸ºç´¢å¼•ä¿å­˜çš„æ˜¯ç´¢å¼•å­—æ®µçš„åŸå§‹å€¼ï¼Œè€Œä¸æ˜¯ id + 1 è¡¨è¾¾å¼è®¡ç®—åçš„å€¼ï¼Œæ‰€ä»¥æ— æ³•èµ°ç´¢å¼•ï¼Œåªèƒ½é€šè¿‡æŠŠç´¢å¼•å­—æ®µçš„å–å€¼éƒ½å–å‡ºæ¥ï¼Œç„¶åä¾æ¬¡è¿›è¡Œè¡¨è¾¾å¼çš„è®¡ç®—æ¥è¿›è¡Œæ¡ä»¶åˆ¤æ–­ï¼Œå› æ­¤é‡‡ç”¨çš„å°±æ˜¯å…¨è¡¨æ‰«æçš„æ–¹å¼ã€‚\n\næœ‰çš„åŒå­¦å¯èƒ½ä¼šè¯´ï¼Œè¿™ç§å¯¹ç´¢å¼•è¿›è¡Œç®€å•çš„è¡¨è¾¾å¼è®¡ç®—ï¼Œåœ¨ä»£ç ç‰¹æ®Šå¤„ç†ä¸‹ï¼Œåº”è¯¥æ˜¯å¯ä»¥åšåˆ°ç´¢å¼•æ‰«æçš„ï¼Œæ¯”æ–¹å°† id + 1 = 10 å˜æˆ id = 10 - 1ã€‚\n\næ˜¯çš„ï¼Œæ˜¯èƒ½å¤Ÿå®ç°ï¼Œä½†æ˜¯ MySQL è¿˜æ˜¯å·äº†è¿™ä¸ªæ‡’ï¼Œæ²¡æœ‰å®ç°ã€‚\n\næˆ‘çš„æƒ³æ³•æ˜¯ï¼Œå¯èƒ½ä¹Ÿæ˜¯å› ä¸ºï¼Œè¡¨è¾¾å¼è®¡ç®—çš„æƒ…å†µå¤šç§å¤šæ ·ï¼Œæ¯ç§éƒ½è¦è€ƒè™‘çš„è¯ï¼Œä»£ç å¯èƒ½ä¼šå¾ˆè‡ƒè‚¿ï¼Œæ‰€ä»¥å¹²è„†å°†è¿™ç§ç´¢å¼•å¤±æ•ˆçš„åœºæ™¯å‘Šè¯‰ç¨‹åºå‘˜ï¼Œè®©ç¨‹åºå‘˜è‡ªå·±ä¿è¯åœ¨æŸ¥è¯¢æ¡ä»¶ä¸­ä¸è¦å¯¹ç´¢å¼•è¿›è¡Œè¡¨è¾¾å¼è®¡ç®—ã€‚\n\n## è”åˆç´¢å¼•çš„å·¦åŒ¹é…é—®é¢˜\nå¯¹ä¸»é”®å­—æ®µå»ºç«‹çš„ç´¢å¼•å«åšèšç°‡ç´¢å¼•ï¼Œå¯¹æ™®é€šå­—æ®µå»ºç«‹çš„ç´¢å¼•å«åšäºŒçº§ç´¢å¼•ã€‚\n\né‚£ä¹ˆå¤šä¸ªæ™®é€šå­—æ®µç»„åˆåœ¨ä¸€èµ·åˆ›å»ºçš„ç´¢å¼•å°±å«åšè”åˆç´¢å¼•ï¼Œä¹Ÿå«ç»„åˆç´¢å¼•ã€‚\n\nåˆ›å»ºè”åˆç´¢å¼•æ—¶ï¼Œæˆ‘ä»¬éœ€è¦æ³¨æ„åˆ›å»ºæ—¶çš„é¡ºåºé—®é¢˜ï¼Œå› ä¸ºè”åˆç´¢å¼• (a, b, c) å’Œ (c, b, a) åœ¨ä½¿ç”¨çš„æ—¶å€™ä¼šå­˜åœ¨å·®åˆ«ã€‚\n\nè”åˆç´¢å¼•è¦èƒ½æ­£ç¡®ä½¿ç”¨éœ€è¦éµå¾ªæœ€å·¦åŒ¹é…åŸåˆ™ï¼Œä¹Ÿå°±æ˜¯æŒ‰ç…§æœ€å·¦ä¼˜å…ˆçš„æ–¹å¼è¿›è¡Œç´¢å¼•çš„åŒ¹é…ã€‚\n\næ¯”å¦‚ï¼Œå¦‚æœåˆ›å»ºäº†ä¸€ä¸ª (a, b, c) è”åˆç´¢å¼•ï¼Œå¦‚æœæŸ¥è¯¢æ¡ä»¶æ˜¯ä»¥ä¸‹è¿™å‡ ç§ï¼Œå°±å¯ä»¥åŒ¹é…ä¸Šè”åˆç´¢å¼•ï¼š\n- where a=1ï¼›\n- where a=1 and b=2 and c=3ï¼›\n- where a=1 and b=2ï¼›\néœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå› ä¸ºæœ‰æŸ¥è¯¢ä¼˜åŒ–å™¨ï¼Œæ‰€ä»¥ a å­—æ®µåœ¨ where å­å¥çš„é¡ºåºå¹¶ä¸é‡è¦ã€‚\n\nä½†æ˜¯ï¼Œå¦‚æœæŸ¥è¯¢æ¡ä»¶æ˜¯ä»¥ä¸‹è¿™å‡ ç§ï¼Œå› ä¸ºä¸ç¬¦åˆæœ€å·¦åŒ¹é…åŸåˆ™ï¼Œæ‰€ä»¥å°±æ— æ³•åŒ¹é…ä¸Šè”åˆç´¢å¼•ï¼Œè”åˆç´¢å¼•å°±ä¼šå¤±æ•ˆ:\n- where b=2ï¼›\n- where c=3ï¼›\n- where b=2 and c=3ï¼›\n> å…¶å®ç±»ä¼¼ç¬¬ä¸€ç§æƒ…å†µï¼Œä¸ç®¡æ˜¯å­—ç¬¦ä¸²è¿˜æ˜¯ç´¢å¼•ï¼Œéƒ½æ˜¯æŒ‰ç…§æœ€å·¦åŒ¹é…çš„ï¼Œå¦‚æœè¿ç¬¬ä¸€ä¸ªéƒ½æ²¡æœ‰ï¼Œé‚£å°±ä¼šå¯¼è‡´ç´¢å¼•å¤±æ•ˆï¼Œè¿™é‡Œè¿˜æœ‰ä¸€ä¸ª**ç´¢å¼•ä¸‹æ¨**çš„æœºåˆ¶ï¼Œç­‰ä»¥åå†æ¥è¡¥ã€‚\n## orå¯¼è‡´çš„å¤±æ•ˆé—®é¢˜\n\nåœ¨ WHERE å­å¥ä¸­ï¼Œå¦‚æœåœ¨ OR å‰çš„æ¡ä»¶åˆ—æ˜¯ç´¢å¼•åˆ—ï¼Œè€Œåœ¨ OR åçš„æ¡ä»¶åˆ—ä¸æ˜¯ç´¢å¼•åˆ—ï¼Œé‚£ä¹ˆç´¢å¼•ä¼šå¤±æ•ˆã€‚\n\nè¿™æ˜¯å› ä¸º OR çš„å«ä¹‰å°±æ˜¯ä¸¤ä¸ªåªè¦æ»¡è¶³ä¸€ä¸ªå³å¯ï¼Œå› æ­¤åªæœ‰ä¸€ä¸ªæ¡ä»¶åˆ—æ˜¯ç´¢å¼•åˆ—æ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œåªè¦æœ‰æ¡ä»¶åˆ—ä¸æ˜¯ç´¢å¼•åˆ—ï¼Œå°±ä¼šè¿›è¡Œå…¨è¡¨æ‰«æã€‚\n\n> orå°±æ˜¯ä¸¤ä¸ªé‡Œé¢æ»¡è¶³ä¸€ä¸ªï¼Œä¹Ÿå°±æ˜¯ç´¢å¼•è¦æœ‰ä¸¤ä¸ªï¼Œæ‰å¯ä»¥ä¸€èµ·ç”¨ç´¢å¼•ï¼Œandå…¶å®æ˜¯åªè¦æœ‰ä¸€ä¸ªæ˜¯ç´¢å¼•å°±å¯ä»¥èµ°ç´¢å¼•çš„ï¼Œè¦æ³¨æ„","tags":["Mysql"]},{"title":"mysql-Buffer Pool","url":"/2024/04/05/mysql-Buffer-Pool/"},{"title":"mysql-äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸MVCC","url":"/2024/04/05/mysql-äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸MVCC/","content":"# äº‹åŠ¡çš„ç‰¹æ€§ï¼ˆACIDï¼‰\n- åŸå­æ€§ï¼ˆAtomicityï¼‰ï¼šè¦ä¹ˆä¸€èµ·æˆåŠŸï¼Œè¦ä¹ˆä¸€èµ·å¤±è´¥ï¼Œæ˜¯ä¸€ä¸ªæ“ä½œï¼Œä¸å¯åˆ†å‰²\n- ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ï¼šæ˜¯æŒ‡äº‹åŠ¡çš„æ‰§è¡Œä¸èƒ½ç ´åæ•°æ®åº“æ•°æ®çš„å®Œæ•´æ€§å’Œä¸€è‡´æ€§ï¼Œä¸€ä¸ªäº‹åŠ¡åœ¨æ‰§è¡Œå‰åï¼Œæ•°æ®åº“éƒ½å¿…é¡»å¤„äºä¸€è‡´æ€§çŠ¶æ€ã€‚æ¢å¥è¯è¯´ï¼Œäº‹åŠ¡çš„æ‰§è¡Œç»“æœå¿…é¡»æ˜¯ä½¿æ•°æ®åº“ä»ä¸€ä¸ªä¸€è‡´æ€§çŠ¶æ€è½¬å˜åˆ°å¦ä¸€ä¸ªä¸€è‡´æ€§çŠ¶æ€ã€‚\n- éš”ç¦»æ€§ï¼ˆIsolationï¼‰ï¼šå¤šä¸ªå¹¶å‘äº‹åŠ¡æ“ä½œæ˜¯éš”ç¦»çš„ï¼Œä¸ä¼šå½¼æ­¤æ‰“æ‰°\n- æŒä¹…æ€§ï¼ˆDurabilityï¼‰ï¼šä¿®æ”¹ä¹‹åæ˜¯æŒä¹…çš„ï¼Œä¸ä¼šæ‰ç”µå°±å¤±æ•ˆäº†\n# å¹¶å‘å¯¼è‡´çš„ä¸ä¸€è‡´æ€§\n- è„è¯»\n**å¦‚æœä¸€ä¸ªäº‹åŠ¡ã€Œè¯»åˆ°ã€äº†å¦ä¸€ä¸ªã€Œæœªæäº¤äº‹åŠ¡ä¿®æ”¹è¿‡çš„æ•°æ®ã€ï¼Œå°±æ„å‘³ç€å‘ç”Ÿäº†ã€Œè„è¯»ã€ç°è±¡ã€‚**\n\nå‡è®¾æœ‰ A å’Œ B è¿™ä¸¤ä¸ªäº‹åŠ¡åŒæ—¶åœ¨å¤„ç†ï¼Œäº‹åŠ¡ A å…ˆå¼€å§‹ä»æ•°æ®åº“ä¸­è¯»å–å°æ—çš„ä½™é¢æ•°æ®ï¼Œç„¶åå†æ‰§è¡Œæ›´æ–°æ“ä½œï¼Œå¦‚æœæ­¤æ—¶äº‹åŠ¡ A è¿˜æ²¡æœ‰æäº¤äº‹åŠ¡ï¼Œè€Œæ­¤æ—¶æ­£å¥½äº‹åŠ¡ B ä¹Ÿä»æ•°æ®åº“ä¸­è¯»å–å°æ—çš„ä½™é¢æ•°æ®ï¼Œé‚£ä¹ˆäº‹åŠ¡ B è¯»å–åˆ°çš„ä½™é¢æ•°æ®æ˜¯åˆšæ‰äº‹åŠ¡ A æ›´æ–°åçš„æ•°æ®ï¼Œå³ä½¿æ²¡æœ‰æäº¤äº‹åŠ¡ã€‚\n\n![](../img/Mysql/img_14.png)\n\nå› ä¸ºäº‹åŠ¡ A æ˜¯è¿˜æ²¡æäº¤äº‹åŠ¡çš„ï¼Œä¹Ÿå°±æ˜¯å®ƒéšæ—¶å¯èƒ½å‘ç”Ÿå›æ»šæ“ä½œï¼Œå¦‚æœåœ¨ä¸Šé¢è¿™ç§æƒ…å†µäº‹åŠ¡ A å‘ç”Ÿäº†å›æ»šï¼Œé‚£ä¹ˆäº‹åŠ¡ B åˆšæ‰å¾—åˆ°çš„æ•°æ®å°±æ˜¯è¿‡æœŸçš„æ•°æ®ï¼Œè¿™ç§ç°è±¡å°±è¢«ç§°ä¸ºè„è¯»\n> ä¹Ÿå°±æ˜¯äº‹åŠ¡Båœ¨Aè¿˜æ²¡æäº¤ä¹‹å‰å°±å·²ç»è¯»åˆ°äº†ä¿®æ”¹çš„æ•°æ®ï¼Œä½†æ˜¯Aå› ä¸ºæŸäº›åŸå› å›æ»šäº†ï¼Œè¿™ä¸ªæ—¶å€™Bå°±è¯»åˆ°äº†è„æ•°æ®ï¼Œç§°ä¸ºè„è¯»\n- ä¸å¯é‡å¤è¯»\n**åœ¨ä¸€ä¸ªäº‹åŠ¡å†…å¤šæ¬¡è¯»å–åŒä¸€ä¸ªæ•°æ®ï¼Œå¦‚æœå‡ºç°å‰åä¸¤æ¬¡è¯»åˆ°çš„æ•°æ®ä¸ä¸€æ ·çš„æƒ…å†µï¼Œå°±æ„å‘³ç€å‘ç”Ÿäº†ã€Œä¸å¯é‡å¤è¯»ã€ç°è±¡ã€‚**\n\nå‡è®¾æœ‰ A å’Œ B è¿™ä¸¤ä¸ªäº‹åŠ¡åŒæ—¶åœ¨å¤„ç†ï¼Œäº‹åŠ¡ A å…ˆå¼€å§‹ä»æ•°æ®åº“ä¸­è¯»å–å°æ—çš„ä½™é¢æ•°æ®ï¼Œç„¶åç»§ç»­æ‰§è¡Œä»£ç é€»è¾‘å¤„ç†ï¼Œåœ¨è¿™è¿‡ç¨‹ä¸­å¦‚æœäº‹åŠ¡ B æ›´æ–°äº†è¿™æ¡æ•°æ®ï¼Œå¹¶æäº¤äº†äº‹åŠ¡ï¼Œé‚£ä¹ˆå½“äº‹åŠ¡ A å†æ¬¡è¯»å–è¯¥æ•°æ®æ—¶ï¼Œå°±ä¼šå‘ç°å‰åä¸¤æ¬¡è¯»åˆ°çš„æ•°æ®æ˜¯ä¸ä¸€è‡´çš„ï¼Œè¿™ç§ç°è±¡å°±è¢«ç§°ä¸ºä¸å¯é‡å¤è¯»ã€‚\n\n![](../img/Mysql/img_15.png)\n\n> ä¹Ÿå°±æ˜¯Aè¯»åˆ°äº†Bä¿®æ”¹å‰å’Œä¿®æ”¹åçš„ä¸¤æ¬¡æ•°æ®ï¼Œä¸ä¸€è‡´çš„é—®é¢˜ï¼Œå°±æ˜¯ä¸å¯é‡å¤è¯»\n- å¹»è¯»\n\n","tags":["Mysql"]},{"title":"mysql-B+æ ‘ä¸æ•°æ®é¡µ","url":"/2024/04/03/mysql-B-æ ‘ä¸æ•°æ®å—/","content":"> æˆ‘ä»¬å…ˆä»æœ€åŸºæœ¬çš„å­˜å‚¨å¼•æ“InnoDBå¼€å§‹å­¦èµ·ï¼Œ[åŸæ–‡é“¾æ¥](https://blog.csdn.net/liang921119/article/details/130556995)\n# InnoDB æ˜¯å¦‚ä½•å­˜å‚¨æ•°æ®çš„ï¼Ÿ\nMySQL æ”¯æŒå¤šç§å­˜å‚¨å¼•æ“ï¼Œä¸åŒçš„å­˜å‚¨å¼•æ“ï¼Œå­˜å‚¨æ•°æ®çš„æ–¹å¼ä¹Ÿæ˜¯ä¸åŒçš„ï¼Œæˆ‘ä»¬æœ€å¸¸ä½¿ç”¨çš„æ˜¯ InnoDB å­˜å‚¨å¼•æ“ï¼Œæ‰€ä»¥å°±è·Ÿå¤§å®¶å›¾è§£ä¸‹InnoDB æ˜¯å¦‚ä½•å­˜å‚¨æ•°æ®çš„ã€‚\n\nè®°å½•æ˜¯æŒ‰ç…§è¡Œæ¥å­˜å‚¨çš„ï¼Œä½†æ˜¯æ•°æ®åº“çš„è¯»å–å¹¶ä¸ä»¥ã€Œè¡Œã€ä¸ºå•ä½ï¼Œå¦åˆ™ä¸€æ¬¡è¯»å–ï¼ˆä¹Ÿå°±æ˜¯ä¸€æ¬¡ I/O æ“ä½œï¼‰åªèƒ½å¤„ç†ä¸€è¡Œæ•°æ®ï¼Œæ•ˆç‡ä¼šéå¸¸ä½ã€‚\n\nå› æ­¤ï¼ŒInnoDB çš„æ•°æ®æ˜¯æŒ‰ã€Œæ•°æ®é¡µã€ä¸ºå•ä½æ¥è¯»å†™çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå½“éœ€è¦è¯»ä¸€æ¡è®°å½•çš„æ—¶å€™ï¼Œå¹¶ä¸æ˜¯å°†è¿™ä¸ªè®°å½•æœ¬èº«ä»ç£ç›˜è¯»å‡ºæ¥ï¼Œè€Œæ˜¯ä»¥é¡µä¸ºå•ä½ï¼Œå°†å…¶æ•´ä½“è¯»å…¥å†…å­˜ã€‚\n# æ•°æ®é¡µ\næ•°æ®åº“çš„ I/O æ“ä½œçš„æœ€å°å•ä½æ˜¯é¡µï¼ŒInnoDB æ•°æ®é¡µçš„é»˜è®¤å¤§å°æ˜¯ 16KBï¼Œæ„å‘³ç€æ•°æ®åº“æ¯æ¬¡è¯»å†™éƒ½æ˜¯ä»¥ 16KB ä¸ºå•ä½çš„ï¼Œä¸€æ¬¡æœ€å°‘ä»ç£ç›˜ä¸­è¯»å– 16K çš„å†…å®¹åˆ°å†…å­˜ä¸­ï¼Œä¸€æ¬¡æœ€å°‘æŠŠå†…å­˜ä¸­çš„ 16K å†…å®¹åˆ·æ–°åˆ°ç£ç›˜ä¸­ã€‚\n\næ•°æ®é¡µåŒ…æ‹¬ä¸ƒä¸ªéƒ¨åˆ†ï¼Œç»“æ„å¦‚ä¸‹å›¾ï¼š\n\n![](../img/Mysql/img.png)\n\n![](../img/Mysql/img_1.png)\n> è¿™é‡Œæœ€é‡è¦çš„æ˜¯æœ€å°å’Œæœ€å¤§è®°å½•ï¼Œä»¥åŠç”¨æˆ·è®°å½•\n\n## ç”¨æˆ·çœŸå®è®°å½•åœ¨æ•°æ®é¡µä¸­çš„å­˜å‚¨ï¼ˆFree Spaceï¼‰\nåœ¨é¡µçš„7ä¸ªç»„æˆéƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬è‡ªå·±å­˜å‚¨çš„è®°å½•ä¼šæŒ‰ç…§æˆ‘ä»¬æŒ‡å®šçš„è¡Œæ ¼å¼å­˜å‚¨åˆ°User Recordséƒ¨åˆ†ã€‚ä½†æ˜¯åœ¨ä¸€å¼€å§‹ç”Ÿæˆé¡µçš„æ—¶å€™ï¼Œå…¶å®å¹¶æ²¡æœ‰User Recordsè¿™ä¸ªéƒ¨åˆ†ï¼Œæ¯å½“æˆ‘ä»¬æ’å…¥ä¸€æ¡è®°å½•ï¼Œéƒ½ä¼šä»Free Spaceéƒ¨åˆ†ï¼Œä¹Ÿå°±æ˜¯å°šæœªä½¿ç”¨çš„å­˜å‚¨ç©ºé—´ä¸­ç”³è¯·ä¸€ä¸ªè®°å½•å¤§å°çš„ç©ºé—´åˆ’åˆ†åˆ°User Recordséƒ¨åˆ†ï¼Œå½“Free Spaceéƒ¨åˆ†çš„ç©ºé—´å…¨éƒ¨è¢«User Recordséƒ¨åˆ†æ›¿ä»£æ‰ä¹‹åï¼Œä¹Ÿå°±æ„å‘³ç€è¿™ä¸ªé¡µä½¿ç”¨å®Œäº†ï¼Œå¦‚æœè¿˜æœ‰æ–°çš„è®°å½•æ’å…¥çš„è¯ï¼Œå°±éœ€è¦å»ç”³è¯·æ–°çš„é¡µäº†ã€‚è¿™ä¸ªè¿‡ç¨‹çš„å›¾ç¤ºå¦‚ä¸‹ï¼š\n\n![](../img/Mysql/img_2.png)\n\nä¸ºäº†æ›´å¥½çš„ç®¡ç†åœ¨User Recordsä¸­çš„è¿™äº›è®°å½•ï¼ŒInnoDBå¯è´¹äº†ä¸€ç•ªåŠ›æ°”å‘¢ï¼Œåœ¨å“ªè´¹åŠ›æ°”äº†å‘¢ï¼Ÿä¸å°±æ˜¯æŠŠè®°å½•æŒ‰ç…§æŒ‡å®šçš„è¡Œæ ¼å¼ä¸€æ¡ä¸€æ¡æ‘†åœ¨User Recordséƒ¨åˆ†ä¹ˆï¼Ÿå…¶å®è¿™è¯è¿˜å¾—ä»è®°å½•è¡Œæ ¼å¼çš„è®°å½•å¤´ä¿¡æ¯ä¸­è¯´èµ·\n\n## è®°å½•å¤´ä¿¡æ¯å¼•å‡ºçš„æ•°æ®é¡µâ€œè®°å½•â€ç»“æ„\næˆ‘ä»¬è¿™é‡Œå…ˆåˆ›å»ºä¸€å¼ è¡¨\n\n```text\nmysql> create table demo5 (c1 int, c2 int, c3 varchar(10000),primary key (c1)) charset=ascii row_format=compact;\n\nQuery OK, 0 rows affected (0.04 sec)\n```\n\nè¿™ä¸ªæ–°å»ºçš„è¡¨æœ‰ä¸‰ä¸ªåˆ—ï¼Œc1å’Œc2åˆ—æ˜¯ç”¨æ¥å­˜å‚¨æ•´æ•°çš„ï¼Œc3å­˜å‚¨çš„å­—ç¬¦ä¸²ï¼Œä½†æ˜¯æˆ‘ä»¬æŒ‡å®šc1ä½ä¸»é”®ï¼Œæ‰€ä»¥åœ¨å…·ä½“çš„è¡Œæ ¼å¼ä¸­ï¼ŒInnodbå°±æ²¡æœ‰å¿…è¦ç»™æˆ‘ä»¬åˆ›å»ºrow_idéšè—åˆ—äº† **ï¼ˆè¿™é‡Œè¯´çš„éšè—åˆ—æ˜¯åœ¨æ²¡æœ‰æ˜ç¡®ç»™ä¸»é”®çš„æ—¶å€™ï¼Œmysqlä¼šè‡ªå·±æ‰¾ä¸€ä¸ªuniqueå¹¶ä¸”æ²¡æœ‰ç©ºå€¼çš„åˆ—ä¸ºä¸»é”®ç´¢å¼•ï¼Œè¿™ä¸ªå°±æ˜¯éšè—åˆ—ï¼‰**ã€‚æ‰€ä»¥è¡¨ä¸­çš„è¡Œæ ¼å¼ç¤ºæ„å›¾å¦‚ä¸‹ï¼š\n\n![](../img/Mysql/img_3.png)\n\n![](../img/Mysql/img_4.png)\n\n\n| åç§°\t          | â¼¤â¼©ï¼ˆå•ä½ï¼šbitï¼‰\t | æè¿°                                              |\n|--------------|-------------|-------------------------------------------------|\n| é¢„ç•™ä½1\t        | 1           | \tæ²¡æœ‰ä½¿â½¤                                           | \n| é¢„ç•™ä½2\t        | 1\t          | æ²¡æœ‰ä½¿â½¤                                            | \n| delete_mask\t | 1\t          | æ ‡è®°è¯¥è®°å½•æ˜¯å¦è¢«åˆ é™¤                                      |\n| min_rec_mask | \t1\t         | B+æ ‘çš„æ¯å±‚â¾®å¶â¼¦èŠ‚ç‚¹ä¸­çš„æœ€â¼©è®°å½•éƒ½ä¼šæ·»åŠ è¯¥æ ‡è®°                        |\n| n_owned\t     | 4\t          | è¡¨ç¤ºå½“å‰è®°å½•æ‹¥æœ‰çš„è®°å½•æ•°                                    | \n| heap_no\t     | 13\t         | è¡¨ç¤ºå½“å‰è®°å½•åœ¨è®°å½•å †çš„ä½ç½®ä¿¡æ¯                                 |  \n| record_type  | \t3\t         | è¡¨ç¤ºå½“å‰è®°å½•çš„ç±»å‹ï¼Œ0è¡¨ç¤ºæ™®é€šè®°å½•ï¼Œ1è¡¨ç¤ºB+æ ‘â¾®å¶â¼¦èŠ‚ç‚¹è®°å½•ï¼Œ2è¡¨ç¤ºæœ€â¼©è®°å½•ï¼Œ3è¡¨ç¤ºæœ€â¼¤è®°å½• |   \n| next_record\t | 16\t         | è¡¨ç¤ºä¸‹â¼€æ¡è®°å½•çš„ç›¸å¯¹ä½ç½®                                    |\n\nå‡è®¾æˆ‘ä»¬æ’å…¥äº†å‡ æ¡æ•°æ®ï¼š\n\n![](../img/Mysql/img_5.png)\n\næ¥ä¸‹æ¥ä¼šä¸€ä¸ªä¸ªè§£é‡Šè¿™å‡ ä¸ªå­—æ®µ\n\n### delete_mask\nè¿™ä¸ªå±æ€§æ ‡è®°å½“å‰è®°å½•æ˜¯å¦è¢«åˆ é™¤ï¼Œå ç”¨ä¸€ä¸ªäºŒè¿›åˆ¶ä½ï¼Œä¸º0ä¸ºæ²¡æœ‰åˆ é™¤ï¼Œä¸º1è¢«åˆ é™¤\n> è¢«åˆ é™¤çš„è®°å½•ä¸ç«‹å³ä»ç£ç›˜ä¸Šç§»é™¤ï¼Œå› ä¸ºç§»é™¤å®ƒä»¬ä¹‹åæŠŠå…¶ä»–çš„è®°å½•åœ¨ç£ç›˜ä¸Šé‡æ–°æ’åˆ—éœ€è¦æ€§èƒ½æ¶ˆè€—ï¼Œæ‰€ä»¥åªæ˜¯æ‰“ä¸€ä¸ªåˆ é™¤æ ‡è®°è€Œå·²ï¼Œæ‰€æœ‰è¢«åˆ é™¤æ‰çš„è®°å½•éƒ½ä¼šç»„æˆä¸€ä¸ªæ‰€è°“çš„åƒåœ¾é“¾è¡¨ï¼Œåœ¨è¿™ä¸ªé“¾è¡¨ä¸­çš„è®°å½•å ç”¨çš„ç©ºé—´ç§°ä¹‹ä¸ºæ‰€è°“çš„å¯é‡ç”¨ç©ºé—´ï¼Œä¹‹åå¦‚æœæœ‰æ–°è®°å½•æ’å…¥åˆ°è¡¨ä¸­çš„è¯ï¼Œå¯èƒ½æŠŠè¿™äº›è¢«åˆ é™¤çš„è®°å½•å ç”¨çš„å­˜å‚¨ç©ºé—´è¦†ç›–æ‰ã€‚è¿™ä¸ªdelete_maskä½è®¾ç½®ä¸º1å’Œå°†è¢«åˆ é™¤çš„è®°å½•åŠ å…¥åˆ°åƒåœ¾é“¾è¡¨ä¸­æ˜¯ä¸¤ä¸ªé˜¶æ®µ\n\n### min_rec_mask\nB+æ ‘çš„æ¯å±‚éå¶å­èŠ‚ç‚¹ä¸­çš„æœ€å°è®°å½•éƒ½ä¼šæ·»åŠ è¯¥æ ‡è®°ã€‚å€¼ä¸º1ï¼Œè¡¨ç¤ºè¯¥æ¡è®°å½•æ˜¯B+æ ‘çš„éå¶å­èŠ‚ç‚¹ä¸­çš„æœ€å°è®°å½•ï¼›å€¼ä¸º0ï¼Œæ„å‘³ç€è¯¥æ¡æ•°æ®ä¸æ˜¯B+æ ‘çš„éå¶å­èŠ‚ç‚¹ä¸­çš„æœ€å°è®°å½• **ï¼ˆæš‚æ—¶è¿˜ä¸çŸ¥é“è¿™ä¸ªå…·ä½“ä½œç”¨ï¼Œå¯èƒ½å°±æ˜¯è®°å½•æ¯ä¸€å±‚çš„å¤´èŠ‚ç‚¹ï¼Ÿï¼‰**\n\n### n_owned\nè¿™ä¸ªæ¶‰åŠåˆ°**åˆ†ç»„**çš„æ¦‚å¿µäº†ï¼Œå­˜çš„å°±æ˜¯å½“å‰åˆ†ç»„æœ‰å¤šå°‘ä¸ªå…ƒç´ ï¼Œåç»­ä¼šä»‹ç»\n\n### heap_no\nè¿™ä¸ªå±æ€§è¡¨ç¤ºå½“å‰è®°å½•åœ¨æœ¬é¡µä¸­çš„ä½ç½®ï¼ˆç±»ä¼¼é¡µè¡¨ä¸­çš„æœ¬é¡µåœ°å€å­—æ®µï¼Œä½†æ˜¯è¿™ä¸ªå•çº¯ç”¨æ¥æ¯”è¾ƒé¡ºåºï¼‰ã€‚MySQLè‡ªåŠ¨ç»™æ¯ä¸ªé¡µé‡Œè¾¹å„¿åŠ äº†ä¸¤ä¸ªè®°å½•ï¼Œç”±äºè¿™ä¸¤ä¸ªè®°å½•å¹¶ä¸æ˜¯æˆ‘ä»¬è‡ªå·±æ’å…¥çš„ï¼Œæ‰€ä»¥æœ‰æ—¶å€™ä¹Ÿç§°ä¸ºä¼ªè®°å½•æˆ–è€…è™šæ‹Ÿè®°å½•ã€‚è¿™ä¸¤ä¸ªä¼ªè®°å½•ä¸€ä¸ªä»£è¡¨æœ€å°è®°å½•ï¼Œä¸€ä¸ªä»£è¡¨æœ€å¤§è®°å½•ï¼ˆè¿™å°±æ˜¯æœ€å‰é¢ä»‹ç»çš„7éƒ¨åˆ†ä¸­çš„ **æœ€å¤§æœ€å°è®°å½•**ï¼‰ã€‚\n\nè®°å½•ä¹Ÿå¯ä»¥æ¯”å¤§å°ï¼Œå¯¹äºä¸€æ¡å®Œæ•´çš„è®°å½•æ¥è¯´ï¼Œæ¯”è¾ƒè®°å½•çš„å¤§å°å°±æ˜¯æ¯”è¾ƒä¸»é”®çš„å¤§å°ã€‚ä½†æ˜¯ä¸ç®¡æˆ‘ä»¬å‘é¡µä¸­æ’å…¥äº†å¤šå°‘è‡ªå·±çš„è®°å½•ï¼ŒInnoDBè§„å®šä»–ä»¬å®šä¹‰çš„ä¸¤æ¡ä¼ªè®°å½•åˆ†åˆ«ä¸ºæœ€å°è®°å½•ä¸æœ€å¤§è®°å½•ã€‚è¿™ä¸¤æ¡è®°å½•çš„æ„é€ ååˆ†ç®€å•ï¼Œéƒ½æ˜¯ç”±5å­—èŠ‚å¤§å°çš„è®°å½•å¤´ä¿¡æ¯å’Œ8å­—èŠ‚å¤§å°çš„ä¸€ä¸ªå›ºå®šçš„éƒ¨åˆ†ç»„æˆçš„ã€‚\n\n![](../img/Mysql/img_6.png)\n> è¿™é‡Œè§„å®šçš„æœ€å°è®°å½•çš„heapnoä¸º0ï¼Œæœ€å¤§è®°å½•çš„ä¸º1\n\n### record_type\nè¿™ä¸ªå±æ€§è¡¨ç¤ºå½“å‰è®°å½•çš„ç±»å‹ï¼Œä¸€å…±æœ‰4ç§ç±»å‹çš„è®°å½•ï¼Œ0è¡¨ç¤ºæ™®é€šè®°å½•ï¼Œ1è¡¨ç¤ºB+æ ‘éå¶èŠ‚ç‚¹è®°å½•ï¼Œ2è¡¨ç¤ºæœ€å°è®°å½•ï¼Œ3è¡¨ç¤ºæœ€å¤§è®°å½•ã€‚ä»å›¾ä¸­æˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹å‡ºæ¥ï¼Œæˆ‘ä»¬è‡ªå·±æ’å…¥çš„è®°å½•å°±æ˜¯æ™®é€šè®°å½•ï¼Œå®ƒä»¬record_typeå€¼éƒ½æ˜¯0ï¼Œè€Œæœ€å°è®°å½•å’Œæœ€å¤§è®°å½•çš„record_typeå€¼åˆ†åˆ«ä¸º2å’Œ3ï¼Œè‡³äºrecord_typeä¸º1çš„æƒ…å†µï¼Œæˆ‘ä»¬ä¹‹ååœ¨è¯´ç´¢å¼•çš„æ—¶å€™ä¼šé‡ç‚¹å¼ºè°ƒçš„ã€‚\n\n### next_record\n\nè¿™ä¸ªä¿¡æ¯éå¸¸é‡è¦ï¼Œè¡¨ç¤ºä»å½“å‰è®°å½•çš„çœŸå®æ•°æ®åˆ°ä¸‹ä¸€æ¡è®°å½•çš„çœŸå®æ•°æ®çš„åœ°å€åç§»é‡ã€‚æ¯”æ–¹è¯´ç¬¬ä¸€æ¡è®°å½•çš„next_recordå€¼ä¸º32ï¼Œæ„å‘³ç€ä»ç¬¬ä¸€æ¡è®°å½•çš„çœŸå®æ•°æ®çš„åœ°å€å¤„å‘åæ‰¾32ä¸ªå­—èŠ‚ä¾¿æ˜¯ä¸‹ä¸€æ¡è®°å½•çš„çœŸå®æ•°æ®ã€‚å¦‚æœä½ ç†Ÿæ‚‰æ•°æ®ç»“æ„çš„è¯ï¼Œå°±ç«‹å³æ˜ç™½äº†ï¼Œè¿™å…¶å®æ˜¯ä¸ªé“¾è¡¨ï¼Œå¯ä»¥é€šè¿‡ä¸€æ¡è®°å½•æ‰¾åˆ°å®ƒçš„ä¸‹ä¸€æ¡è®°å½•ã€‚ä½†æ˜¯éœ€è¦æ³¨æ„æ³¨æ„å†æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œä¸‹ä¸€æ¡è®°å½•æŒ‡çš„å¹¶ä¸æ˜¯æŒ‰ç…§æˆ‘ä»¬æ’å…¥é¡ºåºçš„ä¸‹ä¸€æ¡è®°å½•ï¼Œè€Œæ˜¯æŒ‰ç…§ä¸»é”®å€¼ç”±å°åˆ°å¤§çš„é¡ºåºçš„ä¸‹ä¸€æ¡è®°å½•ã€‚è€Œä¸”è§„å®šInfimumè®°å½•ï¼ˆä¹Ÿå°±æ˜¯æœ€å°è®°å½•ï¼‰ çš„ä¸‹ä¸€æ¡è®°å½•å°±æ˜¯æœ¬é¡µä¸­ä¸»é”®å€¼æœ€å°çš„ç”¨æˆ·è®°å½•ï¼Œè€Œæœ¬é¡µä¸­ä¸»é”®å€¼æœ€å¤§çš„ç”¨æˆ·è®°å½•çš„ä¸‹ä¸€æ¡è®°å½•å°±æ˜¯Supremumè®°å½•ï¼ˆä¹Ÿå°±æ˜¯æœ€å¤§è®°å½•ï¼‰ ï¼Œä¸ºäº†æ›´å½¢è±¡çš„è¡¨ç¤ºä¸€ä¸‹è¿™ä¸ªnext_recordèµ·åˆ°çš„ä½œç”¨ï¼Œæˆ‘ä»¬ç”¨ç®­å¤´æ¥æ›¿ä»£ä¸€ä¸‹next_recordä¸­çš„åœ°å€åç§»é‡ï¼š\n\n![](../img/Mysql/img_7.png)\n\nå‡è®¾åˆ æ‰ç¬¬2æ¡è®°å½•åï¼Œç”±äºåˆ é™¤åªæ˜¯æ ‡è®°ä¸ºåˆ é™¤ï¼Œå®é™…ä¸Šæ²¡æœ‰åˆ é™¤ï¼Œå°±ä¼šå˜æˆï¼š\n\n![](../img/Mysql/img_8.png)\n\nä»å›¾ä¸­å¯ä»¥çœ‹å‡ºæ¥ï¼Œåˆ é™¤ç¬¬2æ¡è®°å½•å‰åä¸»è¦å‘ç”Ÿäº†è¿™äº›å˜åŒ–ï¼š\n\n- ç¬¬2æ¡è®°å½•å¹¶æ²¡æœ‰ä»å­˜å‚¨ç©ºé—´ä¸­ç§»é™¤ï¼Œè€Œæ˜¯æŠŠè¯¥æ¡è®°å½•çš„delete_maskå€¼è®¾ç½®ä¸º1ã€‚\n- ç¬¬2æ¡è®°å½•çš„next_recordå€¼å˜ä¸ºäº†0ï¼Œæ„å‘³ç€è¯¥è®°å½•æ²¡æœ‰ä¸‹ä¸€æ¡è®°å½•äº†ã€‚\n- ç¬¬1æ¡è®°å½•çš„next_recordå€¼å˜ä¸ºäº†64ï¼ŒæŒ‡å‘äº†ç¬¬3æ¡è®°å½•ã€‚\n- æœ€å¤§è®°å½•çš„n_ownedå€¼ä»5å˜æˆäº†4ï¼Œå…³äºè¿™ä¸€ç‚¹çš„å˜åŒ–æˆ‘ä»¬ç¨åä¼šè¯¦ç»†è¯´æ˜çš„ã€‚\næ‰€ä»¥ï¼Œä¸è®ºæˆ‘ä»¬æ€ä¹ˆå¯¹é¡µä¸­çš„è®°å½•åšå¢åˆ æ”¹æ“ä½œï¼ŒInnoDBå§‹ç»ˆä¼šç»´æŠ¤ä¸€æ¡è®°å½•çš„å•é“¾è¡¨ï¼Œé“¾è¡¨ä¸­çš„å„ä¸ªèŠ‚ç‚¹æ˜¯æŒ‰ç…§ä¸»é”®å€¼ç”±å°åˆ°å¤§çš„é¡ºåºè¿æ¥èµ·æ¥çš„\n\n## é¡µç›®å½•ï¼ˆé‡è¦ï¼‰\n> é¡µç›®å½•çš„å­˜åœ¨æ„ä¹‰ä¸»è¦æ˜¯åŠ é€Ÿæ£€ç´¢é€Ÿåº¦ï¼Œå¹¶ä¸æ˜¯å°†ä»–ä»¬é‡æ–°åˆ†ç»„ï¼Œæˆ‘æœ€å¼€å§‹ä»¥ä¸ºæ˜¯å°†è®°å½•å†åˆ†æˆå‡ å—è¿›è¡Œæ£€ç´¢ï¼Œä½†æ˜¯å…¶å®åªæ˜¯ä¸€ä¸ªæ–¹ä¾¿äºŒåˆ†æŸ¥æ‰¾çš„å·¥å…·\n\nç°åœ¨æˆ‘ä»¬äº†è§£äº†è®°å½•åœ¨é¡µä¸­æŒ‰ç…§ä¸»é”®å€¼ç”±å°åˆ°å¤§é¡ºåºä¸²è”æˆä¸€ä¸ªå•é“¾è¡¨ï¼Œé‚£å¦‚æœæˆ‘ä»¬æƒ³æ ¹æ®ä¸»é”®å€¼æŸ¥æ‰¾é¡µä¸­çš„æŸæ¡è®°å½•è¯¥å’‹åŠå‘¢ï¼Ÿæ¯”å¦‚è¯´è¿™æ ·çš„æŸ¥è¯¢è¯­å¥ï¼š\n```text\nselect * from where c1=3;\n```\næœ€ç¬¨çš„åŠæ³•ï¼šä»Infimumè®°å½•ï¼ˆæœ€å°è®°å½•ï¼‰å¼€å§‹ï¼Œæ²¿ç€é“¾è¡¨ä¸€ç›´å¾€åæ‰¾ï¼Œæ€»ä¼šæ‰¾åˆ°ã€‚åœ¨æ‰¾çš„æ—¶å€™è¿˜èƒ½æŠ•æœºå–å·§ï¼Œå› ä¸ºé“¾è¡¨ä¸­å„ä¸ªè®°å½•çš„å€¼æ˜¯æŒ‰ç…§ä»å°åˆ°å¤§é¡ºåºæ’åˆ—çš„ï¼Œæ‰€ä»¥å½“é“¾è¡¨çš„æŸä¸ªèŠ‚ç‚¹ä»£è¡¨çš„è®°å½•çš„ä¸»é”®å€¼å¤§äºä½ æƒ³è¦æŸ¥æ‰¾çš„ä¸»é”®å€¼æ—¶ï¼Œä½ å°±å¯ä»¥åœæ­¢æŸ¥æ‰¾äº†ï¼Œå› ä¸ºè¯¥èŠ‚ç‚¹åè¾¹çš„èŠ‚ç‚¹çš„ä¸»é”®å€¼ä¾æ¬¡é€’å¢ã€‚\n\nä½†æ˜¯InnoDBèƒ½ç”¨è¿™ä¹ˆç¬¨çš„åŠæ³•ä¹ˆï¼Œå½“ç„¶æ˜¯è¦è®¾è®¡ä¸€ç§æ›´å¿«çš„æŸ¥æ‰¾æ–¹å¼ï¼Œäºæ˜¯ä¹ä»ä¹¦çš„ç›®å½•ä¸­æ‰¾åˆ°äº†çµæ„Ÿã€‚\n\næˆ‘ä»¬å¹³å¸¸æƒ³ä»ä¸€æœ¬ä¹¦ä¸­æŸ¥æ‰¾æŸä¸ªå†…å®¹çš„æ—¶å€™ï¼Œä¸€èˆ¬ä¼šå…ˆçœ‹ç›®å½•ï¼Œæ‰¾åˆ°éœ€è¦æŸ¥æ‰¾çš„å†…å®¹å¯¹åº”çš„ä¹¦çš„é¡µç ï¼Œç„¶ååˆ°å¯¹åº”çš„é¡µç æŸ¥çœ‹å†…å®¹ã€‚InnoDBä¸ºæˆ‘ä»¬çš„è®°å½•ä¹Ÿåˆ¶ä½œäº†ä¸€ä¸ªç±»ä¼¼çš„ç›®å½•ï¼Œä»–ä»¬çš„åˆ¶ä½œè¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼š\n\n- å°†æ‰€æœ‰æ­£å¸¸çš„è®°å½•ï¼ˆåŒ…æ‹¬æœ€å¤§å’Œæœ€å°è®°å½•ï¼Œä¸åŒ…æ‹¬æ ‡è®°ä¸ºå·²åˆ é™¤çš„è®°å½•ï¼‰åˆ’åˆ†ä¸ºå‡ ä¸ªç»„ã€‚\n- æ¯ä¸ªç»„çš„æœ€åä¸€æ¡è®°å½•ï¼ˆä¹Ÿå°±æ˜¯ç»„å†…æœ€å¤§çš„é‚£æ¡è®°å½•ï¼‰çš„å¤´ä¿¡æ¯ä¸­çš„n_ownedå±æ€§è¡¨ç¤ºè¯¥è®°å½•æ‹¥æœ‰å¤šå°‘æ¡è®°å½•ï¼Œä¹Ÿå°±æ˜¯è¯¥ç»„å†…å…±æœ‰å‡ æ¡è®°å½•ã€‚\n- å°†æ¯ä¸ªç»„çš„æœ€åä¸€æ¡è®°å½•çš„åœ°å€åç§»é‡å•ç‹¬æå–å‡ºæ¥æŒ‰é¡ºåºå­˜å‚¨åˆ°é è¿‘é¡µçš„å°¾éƒ¨çš„åœ°æ–¹ï¼Œè¿™ä¸ªåœ°æ–¹å°±æ˜¯æ‰€è°“çš„Page Directoryï¼Œä¹Ÿå°±æ˜¯é¡µç›®å½•ã€‚é¡µé¢ç›®å½•ä¸­çš„è¿™äº›åœ°å€åç§»é‡è¢«ç§°ä¸ºæ§½ï¼ˆè‹±æ–‡åï¼šSlotï¼‰ï¼Œæ‰€ä»¥è¿™ä¸ªé¡µé¢ç›®å½•å°±æ˜¯ç”±æ§½ç»„æˆçš„ã€‚\néœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒPage Directoryæ˜¯é€†åºå­˜æ”¾çš„ï¼Œæ¯ä¸ªæ§½å 2å­—èŠ‚\n\n![](../img/Mysql/img_9.png)\n> è¿™é‡Œç¬¬ä¸€ä¸ªslotä¸ºä»€ä¹ˆæ˜¯99ï¼Ÿå› ä¸ºæ˜¯ä»é¡µçš„ç¬¬ä¸€ä½å¼€å§‹ç®— ~~ï¼ˆæ–‡ä»¶å¤´+é¡µå¤´+æœ€å°è®°å½•å‰çš„6å­—èŠ‚=38+56+5=100ï¼Œä½†æ˜¯æ˜¯0å¼€å§‹çš„ï¼Œæ‰€ä»¥ï¼‰~~ æœ€å°è®°å½•å•æˆä¸€ä¸ªåˆ†ç»„ï¼Œé‚£slotä¹Ÿå°±æŒ‡å‘çš„æ˜¯æœ€å°è®°å½•çš„æ•°æ®\n\nä»è¿™ä¸ªå›¾ä¸­æˆ‘ä»¬éœ€è¦æ³¨æ„è¿™ä¹ˆå‡ ç‚¹ï¼š\n\nç°åœ¨é¡µç›®å½•éƒ¨åˆ†ä¸­æœ‰ä¸¤ä¸ªæ§½ï¼Œä¹Ÿå°±æ„å‘³ç€æˆ‘ä»¬çš„è®°å½•è¢«åˆ†æˆäº†ä¸¤ä¸ªç»„ï¼Œæ§½1ä¸­çš„å€¼æ˜¯112ï¼Œä»£è¡¨æœ€å¤§è®°å½•çš„åœ°å€åç§»é‡ï¼ˆå°±æ˜¯ä»é¡µé¢çš„0å­—èŠ‚å¼€å§‹æ•°ï¼Œæ•°112ä¸ªå­—èŠ‚ï¼‰ï¼›æ§½0ä¸­çš„å€¼æ˜¯99ï¼Œä»£è¡¨æœ€å°è®°å½•çš„åœ°å€åç§»é‡ã€‚\n\næ³¨æ„æœ€å°å’Œæœ€å¤§è®°å½•çš„å¤´ä¿¡æ¯ä¸­çš„n_ownedå±æ€§\n\næœ€å°è®°å½•çš„n_ownedå€¼ä¸º1ï¼Œè¿™å°±ä»£è¡¨ç€ä»¥æœ€å°è®°å½•ç»“å°¾çš„è¿™ä¸ªåˆ†ç»„ä¸­åªæœ‰1æ¡è®°å½•ï¼Œä¹Ÿå°±æ˜¯æœ€å°è®°å½•æœ¬èº«ã€‚\n\næœ€å¤§è®°å½•çš„n_ownedå€¼ä¸º5ï¼Œè¿™å°±ä»£è¡¨ç€ä»¥æœ€å¤§è®°å½•ç»“å°¾çš„è¿™ä¸ªåˆ†ç»„ä¸­åªæœ‰5æ¡è®°å½•ï¼ŒåŒ…æ‹¬æœ€å¤§è®°å½•æœ¬èº«è¿˜æœ‰æˆ‘ä»¬è‡ªå·±æ’å…¥çš„4æ¡è®°å½•ã€‚\n\n99å’Œ112è¿™æ ·çš„åœ°å€åç§»é‡å¾ˆä¸ç›´è§‚ï¼Œæˆ‘ä»¬ç”¨ç®­å¤´æŒ‡å‘çš„æ–¹å¼æ›¿ä»£æ•°å­—ï¼Œè¿™æ ·æ›´æ˜“äºæˆ‘ä»¬ç†è§£ï¼Œæ‰€ä»¥ä¿®æ”¹åçš„ç¤ºæ„å›¾å°±æ˜¯è¿™æ ·ï¼š\n\n![](../img/Mysql/img_10.png)\n\n![](../img/Mysql/img_11.png)\n\n\nInnoDBå¯¹æ¯ä¸ªåˆ†ç»„ä¸­çš„è®°å½•æ¡æ•°æ˜¯æœ‰è§„å®šçš„ï¼šå¯¹äºæœ€å°è®°å½•æ‰€åœ¨çš„åˆ†ç»„åªèƒ½æœ‰1æ¡è®°å½•ï¼Œæœ€å¤§è®°å½•æ‰€åœ¨çš„åˆ†ç»„æ‹¥æœ‰çš„è®°å½•æ¡æ•°åªèƒ½åœ¨1 ~ 8æ¡ä¹‹é—´ï¼Œå‰©ä¸‹çš„åˆ†ç»„ä¸­è®°å½•çš„æ¡æ•°èŒƒå›´åªèƒ½åœ¨æ˜¯4 ~ 8æ¡ä¹‹é—´ã€‚æ‰€ä»¥åˆ†ç»„æ˜¯æŒ‰ç…§ä¸‹è¾¹çš„æ­¥éª¤è¿›è¡Œçš„ï¼š\n- åˆå§‹æƒ…å†µä¸‹ä¸€ä¸ªæ•°æ®é¡µé‡Œåªæœ‰æœ€å°è®°å½•å’Œæœ€å¤§è®°å½•ä¸¤æ¡è®°å½•ï¼Œå®ƒä»¬åˆ†å±äºä¸¤ä¸ªåˆ†ç»„ã€‚\n- ä¹‹åæ¯æ’å…¥ä¸€æ¡è®°å½•ï¼Œéƒ½ä¼šä»é¡µç›®å½•ä¸­æ‰¾åˆ°ä¸»é”®å€¼æ¯”æœ¬è®°å½•çš„ä¸»é”®å€¼å¤§å¹¶ä¸”å·®å€¼æœ€å°çš„æ§½ï¼Œç„¶åæŠŠè¯¥æ§½å¯¹åº”çš„è®°å½•çš„n_ownedå€¼åŠ 1ï¼Œè¡¨ç¤ºæœ¬ç»„å†…åˆæ·»åŠ äº†ä¸€æ¡è®°å½•ï¼Œç›´åˆ°è¯¥ç»„ä¸­çš„è®°å½•æ•°ç­‰äº8ä¸ªã€‚\n- åœ¨ä¸€ä¸ªç»„ä¸­çš„è®°å½•æ•°ç­‰äº8ä¸ªåå†æ’å…¥ä¸€æ¡è®°å½•æ—¶ï¼Œä¼šå°†ç»„ä¸­çš„è®°å½•æ‹†åˆ†æˆä¸¤ä¸ªç»„ï¼Œä¸€ä¸ªç»„ä¸­4æ¡è®°å½•ï¼Œå¦ä¸€ä¸ª5æ¡è®°å½•ã€‚è¿™ä¸ªè¿‡ç¨‹ä¼šåœ¨é¡µç›®å½•ä¸­æ–°å¢ä¸€ä¸ªæ§½æ¥è®°å½•è¿™ä¸ªæ–°å¢åˆ†ç»„ä¸­æœ€å¤§çš„é‚£æ¡è®°å½•çš„åç§»é‡ã€‚\n\n### ä¸¾ä¾‹\n\n```text\ninsert into demo5 values(1,100,'aaaa'),(2,200,'bbbb'),(3,300,'cccc'),(4,400,'dddd');\ninsert into demo5 values(5, 500, 'eeee');\ninsert into demo5 values(6, 600, 'ffff');\ninsert into demo5 values(7, 700, 'gggg');\ninsert into demo5 values(8, 800, 'hhhh');\ninsert into demo5 values(9, 900, 'iiii');\ninsert into demo5 values(10, 1000, 'jjjj');\ninsert into demo5 values(11, 1100, 'kkkk');\ninsert into demo5 values(12, 1200, 'llll');\ninsert into demo5 values(13, 1300, 'mmmm');\ninsert into demo5 values(14, 1400, 'nnnn');\ninsert into demo5 values(15, 1500, 'oooo');\ninsert into demo5 values(16, 1600, 'pppp');\n```\n![](../img/Mysql/img_12.png)\n\nå› ä¸ºæŠŠ16æ¡è®°å½•çš„å…¨éƒ¨ä¿¡æ¯éƒ½ç”»åœ¨ä¸€å¼ å›¾é‡Œå¤ªå åœ°æ–¹ï¼Œè®©äººçœ¼èŠ±ç¼­ä¹±çš„ï¼Œæ‰€ä»¥åªä¿ç•™äº†ç”¨æˆ·è®°å½•å¤´ä¿¡æ¯ä¸­çš„n_ownedå’Œnext_recordå±æ€§ï¼Œä¹Ÿçœç•¥äº†å„ä¸ªè®°å½•ä¹‹é—´çš„ç®­å¤´ï¼Œæˆ‘æ²¡ç”»ä¸ç­‰äºæ²¡æœ‰å•Šï¼ç°åœ¨çœ‹æ€ä¹ˆä»è¿™ä¸ªé¡µç›®å½•ä¸­æŸ¥æ‰¾è®°å½•ã€‚å› ä¸ºå„ä¸ªæ§½ä»£è¡¨çš„è®°å½•çš„ä¸»é”®å€¼éƒ½æ˜¯ä»å°åˆ°å¤§æ’åºçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ‰€è°“çš„äºŒåˆ†æ³•æ¥è¿›è¡Œå¿«é€ŸæŸ¥æ‰¾ã€‚5ä¸ªæ§½çš„ç¼–å·åˆ†åˆ«æ˜¯ï¼š0ã€1ã€2ã€3ã€4ï¼Œæ‰€ä»¥åˆå§‹æƒ…å†µä¸‹æœ€ä½çš„æ§½å°±æ˜¯low=0ï¼Œæœ€é«˜çš„æ§½å°±æ˜¯high=4ã€‚æ¯”æ–¹è¯´æˆ‘ä»¬æƒ³æ‰¾ä¸»é”®å€¼ä¸º6çš„è®°å½•ï¼Œè¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼š\n- è®¡ç®—ä¸­é—´æ§½çš„ä½ç½®ï¼š(0+4)/2=2ï¼Œæ‰€ä»¥æŸ¥çœ‹æ§½2ï¼Œå¯¹åº”è®°å½•çš„ä¸»é”®å€¼ä¸º8ï¼Œåˆå› ä¸º8 > 6ï¼Œæ‰€ä»¥è®¾ç½®high=2ï¼Œlowä¿æŒä¸å˜ã€‚\n- é‡æ–°è®¡ç®—ä¸­é—´æ§½çš„ä½ç½®ï¼š(0+2)/2=1ï¼Œæ‰€ä»¥æŸ¥çœ‹æ§½1å¯¹åº”çš„ä¸»é”®å€¼ä¸º4ï¼Œåˆå› ä¸º4 < 6ï¼Œæ‰€ä»¥è®¾ç½®low=1ï¼Œhighä¿æŒä¸å˜ã€‚\n- å› ä¸ºhigh - lowçš„å€¼ä¸º1ï¼Œæ‰€ä»¥ç¡®å®šä¸»é”®å€¼ä¸º6çš„è®°å½•åœ¨æ§½2å¯¹åº”çš„ç»„ä¸­ï¼Œæ­¤åˆ»æˆ‘ä»¬éœ€è¦æ‰¾åˆ°æ§½2ä¸­ä¸»é”®å€¼æœ€å°çš„é‚£æ¡è®°å½•ï¼Œç„¶åæ²¿ç€å•å‘é“¾è¡¨éå†æ§½2ä¸­çš„è®°å½•ã€‚ä½†æ˜¯æˆ‘ä»¬å‰è¾¹åˆè¯´è¿‡ï¼Œæ¯ä¸ªæ§½å¯¹åº”çš„è®°å½•éƒ½æ˜¯è¯¥ç»„ä¸­ä¸»é”®å€¼æœ€å¤§çš„è®°å½•ï¼Œè¿™é‡Œæ§½2å¯¹åº”çš„è®°å½•æ˜¯ä¸»é”®å€¼ä¸º8çš„è®°å½•ï¼Œæ€ä¹ˆå®šä½ä¸€ä¸ªç»„ä¸­æœ€å°çš„è®°å½•å‘¢ï¼Ÿåˆ«å¿˜äº†å„ä¸ªæ§½éƒ½æ˜¯æŒ¨ç€çš„ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆè½»æ˜“çš„æ‹¿åˆ°æ§½1å¯¹åº”çš„è®°å½•ï¼ˆä¸»é”®å€¼ä¸º4ï¼‰ï¼Œè¯¥æ¡è®°å½•çš„ä¸‹ä¸€æ¡è®°å½•å°±æ˜¯æ§½2ä¸­ä¸»é”®å€¼æœ€å°çš„è®°å½•ï¼Œè¯¥è®°å½•çš„ä¸»é”®å€¼ä¸º5ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä»è¿™æ¡ä¸»é”®å€¼ä¸º5çš„è®°å½•å‡ºå‘ï¼Œéå†æ§½2ä¸­çš„å„æ¡è®°å½•ï¼Œç›´åˆ°æ‰¾åˆ°ä¸»é”®å€¼ä¸º6çš„é‚£æ¡è®°å½•å³å¯ã€‚ç”±äºä¸€ä¸ªç»„ä¸­åŒ…å«çš„è®°å½•æ¡æ•°åªèƒ½æ˜¯1~8æ¡ï¼Œæ‰€ä»¥éå†ä¸€ä¸ªç»„ä¸­çš„è®°å½•çš„ä»£ä»·æ˜¯å¾ˆå°çš„ã€‚\n\næ‰€ä»¥åœ¨ä¸€ä¸ªæ•°æ®é¡µä¸­æŸ¥æ‰¾æŒ‡å®šä¸»é”®å€¼çš„è®°å½•çš„è¿‡ç¨‹åˆ†ä¸ºä¸¤æ­¥ï¼š\n- é€šè¿‡äºŒåˆ†æ³•ç¡®å®šè¯¥è®°å½•æ‰€åœ¨çš„æ§½ï¼Œå¹¶æ‰¾åˆ°è¯¥æ§½æ‰€åœ¨åˆ†ç»„ä¸­ä¸»é”®å€¼æœ€å°çš„é‚£æ¡è®°å½•ã€‚\n- é€šè¿‡è®°å½•çš„next_recordå±æ€§éå†è¯¥æ§½æ‰€åœ¨çš„ç»„ä¸­çš„å„ä¸ªè®°å½•\n\n# B+æ ‘","tags":["Mysql"]},{"title":"redis-è¯»å†™ä¸€è‡´æ€§","url":"/2024/04/03/redis-è¯»å†™ä¸€è‡´æ€§/","content":"# Mysqlå¦‚ä½•ä¸Redisä¿æŒåŒæ­¥\n\n![](../img/Redis/img_24.png)\n\nç±»æ¯”è®¡ç®—æœºç»„æˆåŸç†ä¸­çš„cacheå’Œå†…å­˜ï¼Œredisä¹Ÿå°±æ˜¯mysqlçš„ç¼“å­˜ï¼Œé‚£ä¹ˆä¿æŒè¯»å†™ä¸€è‡´æ€§ä¹Ÿæ˜¯ååˆ†é‡è¦çš„ï¼Œæˆ‘ä»¬åœ¨ä¿®æ”¹æ•°æ®åº“çš„åŒæ—¶ï¼Œç¼“å­˜ä¸­ä¹Ÿè¦å¯¹åº”æ›´æ–°ã€‚\n- è¯»æ“ä½œï¼šç¼“å­˜å‘½ä¸­å°±ç›´æ¥è¿”å›ï¼Œç¼“å­˜æœªå‘½ä¸­å°±æŸ¥æ‰¾æ•°æ®åº“ï¼Œç„¶åæ›´æ–°ç¼“å­˜\n- å†™æ“ä½œï¼š**å»¶è¿ŸåŒåˆ **\n![](../img/Redis/img_25.png)\n\n## å…ˆåˆ é™¤ç¼“å­˜ï¼Œå†æ›´æ–°æ•°æ®åº“\n1. **æ­£å¸¸æƒ…å†µ**\n\n![](../img/Redis/img_26.png)\n\né¦–å…ˆçº¿ç¨‹1åˆ é™¤ç¼“å­˜ï¼Œç„¶åæ›´æ–°æ•°æ®åº“ï¼Œæ­¤æ—¶æ²¡æœ‰ä»»ä½•çº¿ç¨‹æ¥æ‰“æ‰°ï¼Œå®Œæˆæ“ä½œä»¥åçº¿ç¨‹2å†æ¥æŸ¥æ‰¾ç¼“å­˜ï¼Œè¿™ä¸ªæ—¶å€™ç”±äºçº¿ç¨‹1å·²ç»åˆ é™¤äº†ç¼“å­˜ï¼Œé‚£å°±ä¼šæŸ¥æ‰¾æ•°æ®åº“æ‰¾åˆ°åˆšåˆšæ›´æ–°çš„æ•°æ®ï¼Œæœ€åå†™å…¥ç¼“å­˜ã€‚è¿™ä¸ªè¿‡ç¨‹ä¸ä¼šå‡ºç°è¯»å†™ä¸€è‡´æ€§é—®é¢˜\n\n2. **ç‰¹æ®Šæƒ…å†µ**\n> å…¶å®ä¸‹é¢å…ˆå†™ååˆ é™¤çš„ç‰¹æ®Šæƒ…å†µä¹Ÿé€‚ç”¨äºæœ¬ä¾‹ä¸­ï¼Œé¦–å…ˆçº¿ç¨‹1æŸ¥è¯¢åˆ°äº†ä¸€ä¸ªè¿‡æœŸkeyï¼Œå»æ•°æ®åº“æ‰¾ï¼Œæš‚æ—¶ä¿å­˜ï¼Œä½†æ˜¯æ²¡å†™è¿›redisã€‚æ­¤æ—¶å¦ä¸€ä¸ªè¿›ç¨‹æ˜¯å†™è¿›ç¨‹ï¼Œå…ˆåˆ é™¤äº†è¿™ä¸ªkeyï¼Œéšåæ›´æ–°ï¼Œæœ€åæ‰è½®åˆ°çº¿ç¨‹1ï¼Œå†™å›åˆšåˆšçš„æ—§æ•°æ®åˆ°redisï¼ŒåŒæ ·ä¼šæœ‰æ•°æ®ä¸ä¸€è‡´\n\n![](../img/Redis/img_27.png)\n\næˆ‘ä»¬å‡è®¾çº¿ç¨‹1åˆ é™¤ç¼“å­˜ä¹‹åï¼Œç”±äºçº¿ç¨‹æ˜¯å¹¶å‘çš„ï¼Œçº¿ç¨‹2æ¥æŸ¥è¯¢ï¼Œæ­¤æ—¶ç”±äºè¿˜æ²¡æœ‰æ›´æ–°æ•°æ®åº“ï¼Œæ‰¾åˆ°çš„è¿˜æ˜¯åŸæ¥çš„æ•°æ®ï¼Œéšåæ”¾å›ç¼“å­˜ï¼Œè¿™ä¸ªæ—¶å€™æ‰è½®åˆ°çº¿ç¨‹1ï¼Œæ›´æ–°æ•°æ®åº“ï¼Œä½†æ˜¯æ­¤æ—¶redisè¿˜æ˜¯ç”¨çš„ä»¥å‰çš„æ•°æ®ï¼Œæ•°æ®åº“çš„æ˜¯åˆšåˆšæ›´æ–°çš„ï¼Œå°±å‡ºç°äº†è¯»å†™ä¸€è‡´æ€§é—®é¢˜\n## å…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†æ›´æ–°ç¼“å­˜\n> é‚£å¦‚æœæˆ‘ä»¬å…ˆæ›´æ–°æ•°æ®åº“ï¼Œåœ¨æ›´æ–°ç¼“å­˜æ˜¯ä¸æ˜¯æ­£ç¡®çš„å‘¢ï¼Ÿ**ç­”æ¡ˆæ˜¯è¿˜æ˜¯ä¼šæœ‰è¯»å†™ä¸€è‡´æ€§é—®é¢˜**\n\n1. **æ­£å¸¸æƒ…å†µ**\n\n ![](../img/Redis/img_28.png)\nçº¿ç¨‹2å…ˆæ›´æ–°æ•°æ®åº“ï¼Œç„¶ååˆ é™¤ï¼Œè·Ÿä¸Šé¢çš„ä¸€æ ·ï¼Œåªè¦ä¸¤ä¸ªæ“ä½œæ˜¯åŸå­æ€§çš„å°±ä¸ä¼šæœ‰é—®é¢˜ï¼Œä½†æ˜¯åªè¦æ˜¯çº¿ç¨‹æ˜¯å¹¶å‘çš„ï¼Œé‚£å°±è‚¯å®šä¸ä¸€è‡´\n\n2. **ç‰¹æ®Šæƒ…å†µ**\n\n![](../img/Redis/img_29.png)\n\n>å¦‚æœåœ¨ä¸åœ¨è¿™ä¸ªåˆšåˆšè¿‡æœŸçš„æ—¶é—´èŠ‚ç‚¹ï¼Œé‚£ä¼šæ€ä¹ˆæ ·å‘¢ï¼Ÿå…¶å®å¦‚æœä¸æ˜¯åˆšåˆšè¦è¿‡æœŸï¼Œé‚£å°±ç›´æ¥ä¼šæ‹¿èµ°ç¼“å­˜ä¸­çš„æ•°æ®ï¼Œä¹Ÿä¸ä¼šåˆ é™¤ç¼“å­˜ï¼Œé‚£å†™è¿›ç¨‹åç»­å…ˆæ”¹å†å†™redisä¹Ÿä¸ä¼šå‡ºç°è¯»å†™ä¸€è‡´æ€§é—®é¢˜ï¼Œä¸ªäººè§‰å¾—æ ¸å¿ƒçš„é—®é¢˜åœ¨äºè¯»è¿›ç¨‹çš„æœºåˆ¶ï¼Œæ²¡æŸ¥åˆ°æˆ–è€…è¿‡æœŸçš„ç¼“å­˜å°±ä¼šä¸»åŠ¨å»æ•°æ®åº“é‡Œè°ƒç”¨ï¼Œä¼šæ‰°ä¹±æ­£å¸¸çš„å†™è¿›ç¨‹å¯¼è‡´ä¸ä¸€è‡´\n> \n> å¦‚æœæ˜¯å‘½ä¸­çš„è¯»è¿›ç¨‹ï¼Œé‚£å°±æ ¹æœ¬ä¸ä¼šæ‰°ä¹±å†™è¿›ç¨‹ï¼Œåªæ˜¯è„æ•°æ®çš„é—®é¢˜ï¼Œrediså’Œmysqlæœ€ç»ˆéƒ½æ˜¯ä¸€è‡´çš„ã€‚è€Œè¿™é‡Œè®¨è®ºçš„åˆšå¥½è¿‡æœŸï¼Œæ‰ä¼šå¯¼è‡´è¯»è¿›ç¨‹å†™redisï¼Œæ‰ä¼šæœ‰ä¸ä¸€è‡´æ€§çš„é—®é¢˜å‘ç”Ÿï¼‰\n\nçº¿ç¨‹1å…ˆå»æŸ¥è¯¢ç¼“å­˜ï¼Œè¿™ä¸ªæ—¶å€™åˆšå¥½keyè¿‡æœŸï¼Œå°±è¦å»æ•°æ®åº“æ‰¾ï¼Œåœ¨æ•°æ®åº“æ‰¾åˆ°çš„æ˜¯æ—§æ•°æ®ï¼Œå…ˆä¿å­˜ä¸‹æ¥ï¼Œä½†æ˜¯æ­¤æ—¶çº¿ç¨‹2æ›´æ–°äº†æ•°æ®åº“ï¼Œç„¶ååˆ é™¤ï¼Œæœ€åæ‰æ˜¯çº¿ç¨‹1å†™å›æ—§æ•°æ®åˆ°redisï¼Œå‡ºç°ä¸ä¸€è‡´ã€‚\n\n## è§£å†³æ–¹æ³•\n- **åˆ†å¸ƒå¼é”**ï¼šåœ¨æ›´æ–°ç¼“å­˜å‰å…ˆåŠ ä¸ªåˆ†å¸ƒå¼é”ï¼Œä¿è¯åŒä¸€æ—¶é—´åªè¿è¡Œä¸€ä¸ªè¯·æ±‚æ›´æ–°ç¼“å­˜ï¼Œå°±ä¼šä¸ä¼šäº§ç”Ÿå¹¶å‘é—®é¢˜äº†ï¼Œå½“ç„¶å¼•å…¥äº†é”åï¼Œå¯¹äºå†™å…¥çš„æ€§èƒ½å°±ä¼šå¸¦æ¥å½±å“ã€‚\n- **å»¶è¿ŸåŒåˆ **ï¼šé’ˆå¯¹ã€Œå…ˆåˆ é™¤ç¼“å­˜ï¼Œå†æ›´æ–°æ•°æ®åº“ã€æ–¹æ¡ˆåœ¨ã€Œè¯» + å†™ã€å¹¶å‘è¯·æ±‚è€Œé€ æˆç¼“å­˜ä¸ä¸€è‡´çš„è§£å†³åŠæ³•æ˜¯ã€Œå»¶è¿ŸåŒåˆ ã€ã€‚\n- - ä¸ºä»€ä¹ˆè¦åŒåˆ ï¼Ÿå› ä¸ºåˆšåˆšåœ¨[å…ˆåˆ é™¤ç¼“å­˜ï¼Œå†æ›´æ–°æ•°æ®åº“]æ–¹æ¡ˆä¸­ä¼šå‡ºç°è¯»å†™ä¸€è‡´é—®é¢˜ï¼Œè¿™ä¸ªæ—¶å€™åªè¦å†å»åˆ é™¤ä¸€æ¬¡ç¼“å­˜å°±å¯ä»¥äº†ï¼Œä¸‹ä¸€ä¸ªæ¥çš„è¯»è¯·æ±‚ä¼šå‘ç°ä¸å­˜åœ¨å¯¹åº”çš„keyï¼Œç„¶åä»æ•°æ®åº“æ‰¾ï¼Œæœ€ç»ˆè¾¾åˆ°ä¸€è‡´æ€§ \n- - ä¸ºä»€ä¹ˆè¦å»¶è¿Ÿï¼Ÿä¸»è¦æ˜¯ä¸ºäº†ç¡®ä¿è¯·æ±‚ A åœ¨ç¡çœ çš„æ—¶å€™ï¼Œè¯·æ±‚ B èƒ½å¤Ÿåœ¨è¿™è¿™ä¸€æ®µæ—¶é—´å®Œæˆã€Œä»æ•°æ®åº“è¯»å–æ•°æ®ï¼Œå†æŠŠç¼ºå¤±çš„ç¼“å­˜å†™å…¥ç¼“å­˜ã€çš„æ“ä½œï¼Œç„¶åè¯·æ±‚ A ç¡çœ å®Œï¼Œå†åˆ é™¤ç¼“å­˜ã€‚\næ‰€ä»¥ï¼Œè¯·æ±‚ A çš„ç¡çœ æ—¶é—´å°±éœ€è¦å¤§äºè¯·æ±‚ B ã€Œä»æ•°æ®åº“è¯»å–æ•°æ® + å†™å…¥ç¼“å­˜ã€çš„æ—¶é—´ã€‚å› ä¸ºè¿™ä¸ªå»¶æ—¶æ—¶é—´ä¸å¥½æ§åˆ¶ï¼Œåœ¨æç«¯æƒ…å†µä¸‹è¿˜æ˜¯ä¼šå‡ºç°è¯»å†™ä¸ä¸€è‡´çš„ç°è±¡ã€‚\n- **ä½¿ç”¨ã€Œå…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜ã€æ–¹æ¡ˆ**ï¼šå…¶å®è¿™ç§æ–¹æ¡ˆçš„ç‰¹æ®Šæƒ…å†µå¾ˆéš¾é‡è§ï¼Œå› ä¸º**ç¼“å­˜çš„å†™å…¥é€šå¸¸è¦è¿œè¿œå¿«äºæ•°æ®åº“çš„å†™å…¥**ï¼Œæ‰€ä»¥åœ¨å®é™…ä¸­å¾ˆéš¾å‡ºç°è¯·æ±‚ B å·²ç»æ›´æ–°äº†æ•°æ®åº“å¹¶ä¸”åˆ é™¤äº†ç¼“å­˜ï¼Œè¯·æ±‚ A æ‰æ›´æ–°å®Œç¼“å­˜çš„æƒ…å†µã€‚\nè€Œä¸€æ—¦è¯·æ±‚ A æ—©äºè¯·æ±‚ B åˆ é™¤ç¼“å­˜ä¹‹å‰æ›´æ–°äº†ç¼“å­˜ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥çš„è¯·æ±‚å°±ä¼šå› ä¸ºç¼“å­˜ä¸å‘½ä¸­è€Œä»æ•°æ®åº“ä¸­é‡æ–°è¯»å–æ•°æ®ï¼Œæ‰€ä»¥ä¸ä¼šå‡ºç°è¿™ç§ä¸ä¸€è‡´çš„æƒ…å†µã€‚**ï¼ˆæ„æ€æ˜¯å³ä½¿Bå…ˆå†™äº†æ•°æ®åº“ï¼ŒAå†å†™æ—§çš„å€¼ï¼Œå› ä¸ºæ•°æ®åº“æ¶‰åŠioï¼ˆæ‰¯è¿œç‚¹å°±æ˜¯ioä¸­æ–­ï¼‰é˜»å¡è¿›ç¨‹Bç›´åˆ°æ—¶é—´ç‰‡åˆ°äº†ï¼Œè¿›ç¨‹ä¼šäº¤æ›¿æ‰§è¡Œè€Œioæä¸€è¾¹ï¼Œå¯èƒ½å½“æ‰§è¡Œåˆ°Aå†™å®Œäº†æ—§å€¼ï¼Œæ›´æ–°æ‰åˆšåˆšç»“æŸï¼Œè¿™ä¸ªæ—¶å€™Bå†æ‰§è¡Œåˆ é™¤ï¼Œå°±å¯ä»¥ä¿è¯ä¸€è‡´æ€§ï¼‰**\n\n## åœ¨ä¸é‚£ä¹ˆè¦æ±‚å¼ºä¸€è‡´æ€§çš„åœºæ™¯\næœ‰çš„æ—¶å€™å¯ä»¥å®¹å¿ä¸€ç¬é—´çš„è„æ•°æ®ï¼Œä½†æ˜¯è¦ä¿æŒæœ€ç»ˆä¸€è‡´æ€§çš„åœºæ™¯ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä¸¤ç§æ–¹æ³•ï¼š\n- åŸºäºæ¶ˆæ¯é˜Ÿåˆ—ï¼ˆä¾‹å¦‚kafkaï¼‰ï¼šå†™å…¥æ•°æ®åº“åï¼Œå‘ä¸€ä¸ªæ¶ˆæ¯ç»™mqé€šçŸ¥redisæ›´æ–°ç¼“å­˜ï¼Œè¿™ç§æ–¹å¼çš„å¯é æ€§ä¸»è¦å–å†³äºmqï¼Œè‚¯å®šæ˜¯æœ‰ä¸€å®šçš„å»¶æ—¶çš„ï¼Œä½†æ˜¯æœ€ç»ˆä¼šä¿è¯ä¸€è‡´\n- åŸºäºé˜¿é‡Œå·´å·´çš„Canalä¸­é—´ä»¶ï¼šã€Œå…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†åˆ ç¼“å­˜ã€çš„ç­–ç•¥çš„ç¬¬ä¸€æ­¥æ˜¯æ›´æ–°æ•°æ®åº“ï¼Œé‚£ä¹ˆæ›´æ–°æ•°æ®åº“æˆåŠŸï¼Œå°±ä¼šäº§ç”Ÿä¸€æ¡å˜æ›´æ—¥å¿—ï¼Œè®°å½•åœ¨ binlog é‡Œã€‚\nCanal æ¨¡æ‹Ÿ MySQL ä¸»ä»å¤åˆ¶çš„äº¤äº’åè®®ï¼ŒæŠŠè‡ªå·±ä¼ªè£…æˆä¸€ä¸ª MySQL çš„ä»èŠ‚ç‚¹ï¼Œå‘ MySQL ä¸»èŠ‚ç‚¹å‘é€ dump è¯·æ±‚ï¼ŒMySQL æ”¶åˆ°è¯·æ±‚åï¼Œå°±ä¼šå¼€å§‹æ¨é€ Binlog ç»™ Canalï¼ŒCanal è§£æ Binlog å­—èŠ‚æµä¹‹åï¼Œè½¬æ¢ä¸ºä¾¿äºè¯»å–çš„ç»“æ„åŒ–æ•°æ®ï¼Œä¾›ä¸‹æ¸¸ç¨‹åºè®¢é˜…ä½¿ç”¨ã€‚\n","tags":["Redis"]},{"title":"leetcode-2024-4-2","url":"/2024/04/02/leetcode-2024-4-2/","content":"# 894 æ‰€æœ‰å¯èƒ½çš„çœŸäºŒå‰æ ‘\nç»™ä½ ä¸€ä¸ªæ•´æ•° n ï¼Œè¯·ä½ æ‰¾å‡ºæ‰€æœ‰å¯èƒ½å« n ä¸ªèŠ‚ç‚¹çš„ çœŸäºŒå‰æ ‘ ï¼Œå¹¶ä»¥åˆ—è¡¨å½¢å¼è¿”å›ã€‚ç­”æ¡ˆä¸­æ¯æ£µæ ‘çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½å¿…é¡»ç¬¦åˆ Node.val == 0 ã€‚\n\nç­”æ¡ˆçš„æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€æ£µçœŸäºŒå‰æ ‘çš„æ ¹èŠ‚ç‚¹ã€‚ä½ å¯ä»¥æŒ‰ ä»»æ„é¡ºåº è¿”å›æœ€ç»ˆçš„çœŸäºŒå‰æ ‘åˆ—è¡¨ã€‚\n\nçœŸäºŒå‰æ ‘ æ˜¯ä¸€ç±»äºŒå‰æ ‘ï¼Œæ ‘ä¸­æ¯ä¸ªèŠ‚ç‚¹æ°å¥½æœ‰ 0 æˆ– 2 ä¸ªå­èŠ‚ç‚¹ã€‚\n\n![](../img/coding/2024_4_2_1.png)\n> æ„Ÿè§‰å¾ˆåƒä¹‹å‰å†™è¿‡çš„ä¸€é“é¢˜\n## è®°å¿†åŒ–æœç´¢\nç”±åˆ†æçŸ¥é“ï¼Œnä¸èƒ½ä¸ºå¶æ•°ï¼Œå¶å­èŠ‚ç‚¹ä¸ºï¼ˆn+1ï¼‰/2ï¼Œåº¦ä¸ºäºŒçš„èŠ‚ç‚¹ä¸º(n-1)/2ï¼Œn=1çš„æ—¶å€™å°±åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹ï¼Œnå¯ä»¥æ‹†åˆ†å‡º[x,1,y]ä¸‰ä¸ªï¼Œxå’Œyéƒ½å¿…é¡»æ˜¯å¥‡æ•°ï¼Œxå’Œyéƒ½æ¯”nå°è€Œä¸”ä¸€å®šåœ¨ä¹‹å‰çš„éå†ä¸­å·²ç»è®¡ç®—è¿‡ï¼Œåªè¦æ·±æ‹·è´n=xå’Œn=yçš„æ•°ç»„ï¼Œä½œä¸ºå·¦è¾¹å³è¾¹ï¼Œå°±å¯ä»¥å¾—åˆ°æœ€ç»ˆç­”æ¡ˆ\n\n\n```java\n/**\n * Definition for a binary tree node.\n * public class TreeNode {\n *     int val;\n *     TreeNode left;\n *     TreeNode right;\n *     TreeNode() {}\n *     TreeNode(int val) { this.val = val; }\n *     TreeNode(int val, TreeNode left, TreeNode right) {\n *         this.val = val;\n *         this.left = left;\n *         this.right = right;\n *     }\n * }\n */\nclass Solution {\n    //è®°å¿†åŒ–ä¿å­˜çš„æ•°ç»„\n    List<List<TreeNode>> list = new ArrayList<>();\n    List<TreeNode> treeNodeList;\n    public List<TreeNode> allPossibleFBT(int n) {\n        //æ’é™¤å¶æ•°\n        if (n%2==0){\n            return new ArrayList<>();\n        }\n        treeNodeList = new ArrayList<>();\n        treeNodeList.add(new TreeNode(0));\n        list.add(treeNodeList);\n        for (int k = 3; k <= n; k+=2) {\n            treeNodeList = new ArrayList<>();\n            for (int i = 1; i < k-1; i+=2) {\n                //System.out.println(i);\n                //ç”±äºiæ˜¯+=2çš„ï¼Œå¯¹åº”çš„listä¸‹æ ‡æ˜¯++ï¼Œæ‰€ä»¥è¦/2\n                List<TreeNode> left = new ArrayList<>(list.get(i/2));\n                List<TreeNode> right = new ArrayList<>(list.get((k-1-i)/2));\n                for (int p = 0; p < left.size(); p++) {\n                    for (int q = 0; q < right.size(); q++) {\n                        TreeNode root = new TreeNode(0);\n                        root.left = left.get(p);\n                        root.right = right.get(q);\n                        //å…ˆä¿å­˜åˆ°treenodeListé‡Œ\n                        treeNodeList.add(root);\n                    }\n                }\n            }\n            //System.out.println(treeNodeList.size());\n            //æœ€ååŠ ä¸Šè¿™ä¸ª\n            list.add(treeNodeList);\n        }\n        //System.out.println(list.get(n/2).size());\n        //è¿”å›è®°å¿†åŒ–æœç´¢æœ€åä¸€ä¸ª\n        return list.get(n/2);\n\n    }\n}\n```","tags":["åˆ·é¢˜ç¬”è®°"]},{"title":"redis-é«˜å¯ç”¨ç¯‡","url":"/2024/04/02/redis-é«˜å¯ç”¨ç¯‡/","content":"# ä¸»ä»å¤åˆ¶\n\nå•ç‚¹Redisçš„å¹¶å‘èƒ½åŠ›æ˜¯ç”±ä¸Šé™çš„ï¼Œå¦‚æœéƒ½å­˜å‚¨åœ¨ä¸€å°æœåŠ¡å™¨ä¸Šï¼Œå‡ºäº‹äº†å°±ä¼šæœ‰å¾ˆä¸¥é‡çš„å½±å“ã€‚\n- å¦‚æœå‡ºç°äº†å®•æœºï¼Œé‚£ä¹ˆæ•°æ®æ¢å¤éœ€è¦æ—¶é—´ï¼Œè€Œä¸”ä¸»è¿›ç¨‹åœ¨æ­¤æœŸé—´ä¸èƒ½æœåŠ¡æ–°è¯·æ±‚ï¼Œ\n- ç¡¬ç›˜å‡ºäº†é—®é¢˜é‚£å°±ä¼šé€ æˆæ•°æ®ä¸¢å¤±ã€‚\nå¦‚ä½•è§£å†³è¿™ç§é—®é¢˜ï¼Œå¹¶ä¸”è¿˜è¦è¿›ä¸€æ­¥æé«˜å¹¶å‘æ€§ï¼Ÿå¯ä»¥æ­å»º**ä¸»ä»æ¨¡å¼**ï¼Œå®ç°è¯»å†™åˆ†ç¦»ã€‚\n\n> **è¯»å†™åˆ†ç¦»**:\n> ä¸»æœåŠ¡å™¨å¯ä»¥è¿›è¡Œè¯»å†™æ“ä½œï¼Œå½“å‘ç”Ÿå†™æ“ä½œæ—¶è‡ªåŠ¨å°†å†™æ“ä½œåŒæ­¥ç»™ä»æœåŠ¡å™¨ï¼Œè€Œä»æœåŠ¡å™¨ä¸€èˆ¬æ˜¯åªè¯»ï¼Œå¹¶æ¥å—ä¸»æœåŠ¡å™¨åŒæ­¥è¿‡æ¥å†™æ“ä½œå‘½ä»¤ï¼Œç„¶åæ‰§è¡Œè¿™æ¡å‘½ä»¤ã€‚\n> ![](../img/Redis/img_12.png)\n> \n> ä¹Ÿå°±æ˜¯è¯´ï¼Œæ‰€æœ‰çš„æ•°æ®ä¿®æ”¹åªåœ¨ä¸»æœåŠ¡å™¨ä¸Šè¿›è¡Œï¼Œç„¶åå°†æœ€æ–°çš„æ•°æ®åŒæ­¥ç»™ä»æœåŠ¡å™¨ï¼Œè¿™æ ·å°±ä½¿å¾—ä¸»ä»æœåŠ¡å™¨çš„æ•°æ®æ˜¯ä¸€è‡´çš„ã€‚\n\n## ç¬¬ä¸€æ¬¡åŒæ­¥\nå¤šå°æœåŠ¡å™¨ä¹‹é—´è¦é€šè¿‡ä»€ä¹ˆæ–¹å¼æ¥ç¡®å®šè°æ˜¯ä¸»æœåŠ¡å™¨ï¼Œæˆ–è€…è°æ˜¯ä»æœåŠ¡å™¨å‘¢ï¼Ÿ\n\næˆ‘ä»¬å¯ä»¥ä½¿ç”¨ replicaofï¼ˆRedis 5.0 ä¹‹å‰ä½¿ç”¨ slaveofï¼‰å‘½ä»¤å½¢æˆä¸»æœåŠ¡å™¨å’Œä»æœåŠ¡å™¨çš„å…³ç³»ã€‚\n\næ¯”å¦‚ï¼Œç°åœ¨æœ‰æœåŠ¡å™¨ A å’Œ æœåŠ¡å™¨ Bï¼Œæˆ‘ä»¬åœ¨æœåŠ¡å™¨ B ä¸Šæ‰§è¡Œä¸‹é¢è¿™æ¡å‘½ä»¤ï¼š\n\n```text\n# æœåŠ¡å™¨ B æ‰§è¡Œè¿™æ¡å‘½ä»¤\nreplicaof <æœåŠ¡å™¨ A çš„ IP åœ°å€> <æœåŠ¡å™¨ A çš„ Redis ç«¯å£å·>\n```\n\næ¥ç€ï¼ŒæœåŠ¡å™¨ B å°±ä¼šå˜æˆæœåŠ¡å™¨ A çš„ã€Œä»æœåŠ¡å™¨ã€ï¼Œç„¶åä¸ä¸»æœåŠ¡å™¨è¿›è¡Œç¬¬ä¸€æ¬¡åŒæ­¥ã€‚\n\nä¸»ä»æœåŠ¡å™¨é—´çš„ç¬¬ä¸€æ¬¡åŒæ­¥çš„è¿‡ç¨‹å¯åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼š\n\n- ç¬¬ä¸€é˜¶æ®µæ˜¯å»ºç«‹é“¾æ¥ã€åå•†åŒæ­¥ï¼›\n- ç¬¬äºŒé˜¶æ®µæ˜¯ä¸»æœåŠ¡å™¨åŒæ­¥æ•°æ®ç»™ä»æœåŠ¡å™¨ï¼›\n- ç¬¬ä¸‰é˜¶æ®µæ˜¯ä¸»æœåŠ¡å™¨å‘é€æ–°å†™æ“ä½œå‘½ä»¤ç»™ä»æœåŠ¡å™¨ã€‚\n\n![](../img/Redis/img_13.png)\n\n> 1. ä¸€ä¸ªä»æœåŠ¡å™¨è¦åŠ å…¥ä¸»æœåŠ¡å™¨çš„ä»èŠ‚ç‚¹ï¼Œé¦–å…ˆæ‰§è¡Œä¸Šé¢è¿™æ¡replicaofï¼Œå‘Šè¯‰ä¸»æœåŠ¡å™¨æˆ‘æ˜¯æ–°åŠ å…¥çš„\n> 2. ç„¶åå»ºç«‹è¿æ¥ã€‚è¿™é‡Œæœ‰ä¸¤ä¸ªå…³é”®å‚æ•°**replication id**ï¼Œæ ‡è¯†ä¸€ä¸ªæ•°æ®é›†ï¼Œæ¯ä¸€ä¸ªmasteréƒ½ä¼šæœ‰ä¸€ä¸ªè¿™ä¸ªidï¼Œç›¸å½“äºæ ‡è®°äº†ä¸€å—ç©ºé—´ï¼Œå½“slaveåŠ å…¥æ—¶ï¼Œå¹¶ä¸çŸ¥é“masterçš„è¿™ä¸ªidï¼Œå°±ç»™â€œï¼Ÿâ€ï¼Œè¿˜æœ‰ä¸€ä¸ªå‚æ•°**offset**ä¹Ÿå°±æ˜¯åç§»é‡ï¼Œè¡¨ç¤ºå¤åˆ¶çš„è¿›åº¦ï¼Œåˆå§‹åŒ–ä¸º-1ï¼Œï¼ˆ***æœ‰ç‚¹ç±»ä¼¼TCPçš„åºå·å’Œç¡®è®¤å·***ï¼‰ã€‚\n> æ‰§è¡Œpsyncå‘½ä»¤ï¼Œå‘Šè¯‰ä¸»æœåŠ¡å™¨ä¸€ä¸ªä»èŠ‚ç‚¹è¦å»ºç«‹è¿æ¥äº†\n> 3. ä¸»æœåŠ¡å™¨åˆ¤æ–­æ¥çš„è¿™ä¸ªreplication idæ˜¯å¦æ˜¯è‡ªå·±çš„ï¼Œå¦‚æœä¸æ˜¯è‡ªå·±çš„è¯´æ˜æ˜¯ç¬¬ä¸€æ¬¡åŠ å…¥çš„ä»æœåŠ¡å™¨ï¼Œè¿”å›å‰é¢çš„è¿™ä¸¤ä¸ªå€¼ï¼Œè‡ªå·±çš„idå’Œå½“å‰çš„å¤åˆ¶è¿›åº¦ã€‚\n> 4. ä»æœåŠ¡å™¨æ”¶åˆ°å“åº”ä¹‹åä¼šè®°å½•è¿™ä¸¤ä¸ªå€¼ï¼Œå‡†å¤‡è¿›è¡Œ**å…¨é‡å¤åˆ¶**\n> 5. æ­¤æ—¶ä¸»æœåŠ¡å™¨forkä¸€ä¸ªå­è¿›ç¨‹å®Œæˆbgsaveå‘½ä»¤ï¼Œç”Ÿæˆ**RDB**æ–‡ä»¶ï¼Œç„¶åä¼ è¾“ç»™ä»æœåŠ¡å™¨ã€‚æ­¤æ—¶ä¸ä¼šé˜»å¡ä¸»è¿›ç¨‹ï¼Œè¿˜æ˜¯èƒ½æ¥æ”¶æ–°çš„æ•°æ®ï¼Œé‚£ä¹ˆå°±éœ€è¦ä¸€ä¸ªæ•°æ®ç»“æ„æ¥å­˜è¿™äº›åˆšåˆšåŠ å…¥ï¼Œä½†æ˜¯æ²¡æœ‰å†™å…¥RDBæ–‡ä»¶çš„æ•°æ®ï¼Œè¿™é‡Œå°±æœ‰ä¸€ä¸ª**replication buffer**ç¼“å†²åŒºç”¨æ¥å­˜è¿™äº›æ•°æ®\n> 6. ä»æœåŠ¡å™¨æ”¶åˆ°äº†bump.rdbæ–‡ä»¶ï¼Œç„¶åè¿›è¡Œè½½å…¥ï¼Œåœ¨æ­¤ä¹‹å‰æ¸…ç©ºå½“å‰æ•°æ®\n> 7. å¯¹äºä¸»æœåŠ¡å™¨åœ¨**å¤åˆ¶ä¼ è¾“å’Œå­æœåŠ¡å™¨é‡å»º**è¿‡ç¨‹ä¸­æ–°åˆ°çš„æ•°æ®ï¼Œç¼“å†²åŒºå†…çš„æ•°æ®å‘é€æ–°çš„å†™å‘½ä»¤ç»™ä»æœåŠ¡å™¨ã€‚\n\n**ç¬¬ä¸€é˜¶æ®µï¼šå»ºç«‹é“¾æ¥ã€åå•†åŒæ­¥**\n\næ‰§è¡Œäº† replicaof å‘½ä»¤åï¼Œä»æœåŠ¡å™¨å°±ä¼šç»™ä¸»æœåŠ¡å™¨å‘é€ psync å‘½ä»¤ï¼Œè¡¨ç¤ºè¦è¿›è¡Œæ•°æ®åŒæ­¥ã€‚\n\npsync å‘½ä»¤åŒ…å«ä¸¤ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯ä¸»æœåŠ¡å™¨çš„ runID å’Œå¤åˆ¶è¿›åº¦ offsetã€‚\n\nrunIDï¼Œæ¯ä¸ª Redis æœåŠ¡å™¨åœ¨å¯åŠ¨æ—¶éƒ½ä¼šè‡ªåŠ¨ç”Ÿäº§ä¸€ä¸ªéšæœºçš„ ID æ¥å”¯ä¸€æ ‡è¯†è‡ªå·±ã€‚å½“ä»æœåŠ¡å™¨å’Œä¸»æœåŠ¡å™¨ç¬¬ä¸€æ¬¡åŒæ­¥æ—¶ï¼Œå› ä¸ºä¸çŸ¥é“ä¸»æœåŠ¡å™¨çš„ run IDï¼Œæ‰€ä»¥å°†å…¶è®¾ç½®ä¸º \"?\"ã€‚\noffsetï¼Œè¡¨ç¤ºå¤åˆ¶çš„è¿›åº¦ï¼Œç¬¬ä¸€æ¬¡åŒæ­¥æ—¶ï¼Œå…¶å€¼ä¸º -1ã€‚\nä¸»æœåŠ¡å™¨æ”¶åˆ° psync å‘½ä»¤åï¼Œä¼šç”¨ FULLRESYNC ä½œä¸ºå“åº”å‘½ä»¤è¿”å›ç»™å¯¹æ–¹ã€‚\n\nå¹¶ä¸”è¿™ä¸ªå“åº”å‘½ä»¤ä¼šå¸¦ä¸Šä¸¤ä¸ªå‚æ•°ï¼šä¸»æœåŠ¡å™¨çš„ runID å’Œä¸»æœåŠ¡å™¨ç›®å‰çš„å¤åˆ¶è¿›åº¦ offsetã€‚ä»æœåŠ¡å™¨æ”¶åˆ°å“åº”åï¼Œä¼šè®°å½•è¿™ä¸¤ä¸ªå€¼ã€‚\n\nFULLRESYNC å“åº”å‘½ä»¤çš„æ„å›¾æ˜¯é‡‡ç”¨å…¨é‡å¤åˆ¶çš„æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯ä¸»æœåŠ¡å™¨ä¼šæŠŠæ‰€æœ‰çš„æ•°æ®éƒ½åŒæ­¥ç»™ä»æœåŠ¡å™¨ã€‚\n\næ‰€ä»¥ï¼Œç¬¬ä¸€é˜¶æ®µçš„å·¥ä½œæ—¶ä¸ºäº†å…¨é‡å¤åˆ¶åšå‡†å¤‡ã€‚\n\né‚£å…·ä½“æ€ä¹ˆå…¨é‡åŒæ­¥å‘€å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥å¾€ä¸‹çœ‹ç¬¬äºŒé˜¶æ®µã€‚\n\n**ç¬¬äºŒé˜¶æ®µï¼šä¸»æœåŠ¡å™¨åŒæ­¥æ•°æ®ç»™ä»æœåŠ¡å™¨**\n\næ¥ç€ï¼Œä¸»æœåŠ¡å™¨ä¼šæ‰§è¡Œ bgsave å‘½ä»¤æ¥ç”Ÿæˆ RDB æ–‡ä»¶ï¼Œç„¶åæŠŠæ–‡ä»¶å‘é€ç»™ä»æœåŠ¡å™¨ã€‚\n\nä»æœåŠ¡å™¨æ”¶åˆ° RDB æ–‡ä»¶åï¼Œä¼šå…ˆæ¸…ç©ºå½“å‰çš„æ•°æ®ï¼Œç„¶åè½½å…¥ RDB æ–‡ä»¶ã€‚\n\nè¿™é‡Œæœ‰ä¸€ç‚¹è¦æ³¨æ„ï¼Œä¸»æœåŠ¡å™¨ç”Ÿæˆ RDB è¿™ä¸ªè¿‡ç¨‹æ˜¯ä¸ä¼šé˜»å¡ä¸»çº¿ç¨‹çš„ï¼Œå› ä¸º bgsave å‘½ä»¤æ˜¯äº§ç”Ÿäº†ä¸€ä¸ªå­è¿›ç¨‹æ¥åšç”Ÿæˆ RDB æ–‡ä»¶çš„å·¥ä½œï¼Œæ˜¯å¼‚æ­¥å·¥ä½œçš„ï¼Œè¿™æ · Redis ä¾ç„¶å¯ä»¥æ­£å¸¸å¤„ç†å‘½ä»¤ã€‚\n\nä½†æ˜¯ï¼Œè¿™æœŸé—´çš„å†™æ“ä½œå‘½ä»¤å¹¶æ²¡æœ‰è®°å½•åˆ°åˆšåˆšç”Ÿæˆçš„ RDB æ–‡ä»¶ä¸­ï¼Œè¿™æ—¶ä¸»ä»æœåŠ¡å™¨é—´çš„æ•°æ®å°±ä¸ä¸€è‡´äº†ã€‚\n\né‚£ä¹ˆä¸ºäº†ä¿è¯ä¸»ä»æœåŠ¡å™¨çš„æ•°æ®ä¸€è‡´æ€§ï¼Œä¸»æœåŠ¡å™¨åœ¨ä¸‹é¢è¿™ä¸‰ä¸ªæ—¶é—´é—´éš™ä¸­å°†æ”¶åˆ°çš„å†™æ“ä½œå‘½ä»¤ï¼Œå†™å…¥åˆ° replication buffer ç¼“å†²åŒºé‡Œï¼š\n\n- ä¸»æœåŠ¡å™¨ç”Ÿæˆ RDB æ–‡ä»¶æœŸé—´ï¼›\n- ä¸»æœåŠ¡å™¨å‘é€ RDB æ–‡ä»¶ç»™ä»æœåŠ¡å™¨æœŸé—´ï¼›\n- ã€Œä»æœåŠ¡å™¨ã€åŠ è½½ RDB æ–‡ä»¶æœŸé—´ï¼›\n\n**ç¬¬ä¸‰é˜¶æ®µï¼šä¸»æœåŠ¡å™¨å‘é€æ–°å†™æ“ä½œå‘½ä»¤ç»™ä»æœåŠ¡å™¨**\n\nåœ¨ä¸»æœåŠ¡å™¨ç”Ÿæˆçš„ RDB æ–‡ä»¶å‘é€å®Œï¼Œä»æœåŠ¡å™¨æ”¶åˆ° RDB æ–‡ä»¶åï¼Œä¸¢å¼ƒæ‰€æœ‰æ—§æ•°æ®ï¼Œå°† RDB æ•°æ®è½½å…¥åˆ°å†…å­˜ã€‚å®Œæˆ RDB çš„è½½å…¥åï¼Œä¼šå›å¤ä¸€ä¸ªç¡®è®¤æ¶ˆæ¯ç»™ä¸»æœåŠ¡å™¨ã€‚\n\næ¥ç€ï¼Œä¸»æœåŠ¡å™¨å°† replication buffer ç¼“å†²åŒºé‡Œæ‰€è®°å½•çš„å†™æ“ä½œå‘½ä»¤å‘é€ç»™ä»æœåŠ¡å™¨ï¼Œä»æœåŠ¡å™¨æ‰§è¡Œæ¥è‡ªä¸»æœåŠ¡å™¨ replication buffer ç¼“å†²åŒºé‡Œå‘æ¥çš„å‘½ä»¤ï¼Œè¿™æ—¶ä¸»ä»æœåŠ¡å™¨çš„æ•°æ®å°±ä¸€è‡´äº†ã€‚\n\nè‡³æ­¤ï¼Œä¸»ä»æœåŠ¡å™¨çš„ç¬¬ä¸€æ¬¡åŒæ­¥çš„å·¥ä½œå°±å®Œæˆäº†ã€‚\n\n## å‘½ä»¤ä¼ æ’­\nä¸»ä»æœåŠ¡å™¨åœ¨å®Œæˆç¬¬ä¸€æ¬¡åŒæ­¥ä»¥åå°±ä¼šç»´æŠ¤ä¸€ä¸ªTcpè¿æ¥ã€‚\n\n![](../img/Redis/img_14.png)\n\nåç»­ä¸»æœåŠ¡å™¨å¯ä»¥é€šè¿‡è¿™ä¸ªè¿æ¥ç»§ç»­å°†å†™æ“ä½œå‘½ä»¤ä¼ æ’­ç»™ä»æœåŠ¡å™¨ï¼Œç„¶åä»æœåŠ¡å™¨æ‰§è¡Œè¯¥å‘½ä»¤ï¼Œä½¿å¾—ä¸ä¸»æœåŠ¡å™¨çš„æ•°æ®åº“çŠ¶æ€ç›¸åŒã€‚\n\nè€Œä¸”è¿™ä¸ªè¿æ¥æ˜¯é•¿è¿æ¥çš„ï¼Œç›®çš„æ˜¯é¿å…é¢‘ç¹çš„ TCP è¿æ¥å’Œæ–­å¼€å¸¦æ¥çš„æ€§èƒ½å¼€é”€ã€‚\n\nä¸Šé¢çš„è¿™ä¸ªè¿‡ç¨‹è¢«ç§°ä¸ºåŸºäºé•¿è¿æ¥çš„å‘½ä»¤ä¼ æ’­ï¼Œé€šè¿‡è¿™ç§æ–¹å¼æ¥ä¿è¯ç¬¬ä¸€æ¬¡åŒæ­¥åçš„ä¸»ä»æœåŠ¡å™¨çš„æ•°æ®ä¸€è‡´æ€§ã€‚\n\n## å¢é‡å¤åˆ¶\n> ä¸»ä»æœåŠ¡å™¨åœ¨ç¬¬ä¸€æ¬¡åŒæ­¥ä¹‹åï¼Œå°±ä¼šå»ºç«‹ä¸€ä¸ªtcpé•¿è¿æ¥å®Œæˆå‘½ä»¤ä¼ è¾“ã€‚ä½†æ˜¯æ­¤æ—¶ç½‘ç»œäº§ç”Ÿå»¶è¿Ÿæˆ–è€…æ–­å¼€ã€‚é‚£ä¹ˆå°±ä¸èƒ½è¿›è¡Œå‘½ä»¤ä¼ æ’­äº†ï¼ˆè¿™é‡Œçš„æ–­å¼€ç½‘ç»œæŒ‡çš„æ˜¯ä¸»ä»æœåŠ¡å™¨ä¹‹é—´çš„åŒæ­¥è¢«æ‰“æ–­ï¼‰ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯è¿˜æ˜¯å¯ä»¥ä»ä»æœåŠ¡å™¨è¯»åˆ°æ—§çš„æ•°æ®äº§ç”Ÿä¸ä¸€è‡´æ€§ã€‚\n\n![](../img/Redis/img_15.png)\n\nå¦‚æœæ­¤æ—¶ç½‘ç»œåˆæ¢å¤æ­£å¸¸äº†ï¼Œä»æœåŠ¡å™¨å·²ç»è½åä¸»æœåŠ¡å™¨ï¼Œè¦è¿›è¡Œå†æ¬¡åŒæ­¥ï¼Œè¿™ä¸ªæ—¶å€™ç”¨**å…¨å±€å¤åˆ¶**é€ æˆçš„å¼€é”€ä¼šå¾ˆå¤§ï¼Œå¯ä»¥é‡‡ç”¨**å¢é‡å¤åˆ¶**çš„æ–¹æ³•è¿›è¡ŒåŒæ­¥ï¼Œåªä¼šæŠŠç½‘ç»œæ–­å¼€æœŸé—´ä¸»æœåŠ¡å™¨æ”¶åˆ°çš„å†™æ“ä½œåŒæ­¥ç»™ä»æœåŠ¡å™¨ï¼Œåˆ©ç”¨çš„å°±æ˜¯offsetä¹‹é—´çš„å·®å€¼ã€‚\n![](../img/Redis/img_16.png)\n>1. æ¢å¤è¿æ¥åä»æœåŠ¡å™¨ç»™ä¸»æœåŠ¡å™¨å‘é€idå’Œoffset\n>2. ä¸»æœåŠ¡å™¨çŸ¥é“idæ˜¯è‡ªå·±çš„ï¼Œä½†æ˜¯offestè½åçš„æœ‰ç‚¹å¤šï¼Œè¿™ä¸ªæ—¶å€™å°±ä¼šè®¡ç®—è‡ªå·±çš„offsetå’Œä»æœåŠ¡å™¨ç»™çš„offsetä¹‹é—´å·®äº†å¤šå°‘ï¼Œç„¶åå‘é€CONTINUEå‘½ä»¤ï¼Œå‘Šè¯‰ä»æœåŠ¡å™¨è¦å‘é€å¢é‡æ•°æ®ã€‚\n>3. ä»æœåŠ¡å™¨é‡æ–°æ‰§è¡Œè¿™äº›å‘½ä»¤\n\n**offsetå…·ä½“æ€ä¹ˆè®¡ç®—ï¼Ÿ**\n- repl_backlog_bufferï¼Œæ˜¯ä¸€ä¸ªã€Œç¯å½¢ã€ç¼“å†²åŒºï¼Œç”¨äºä¸»ä»æœåŠ¡å™¨æ–­è¿åï¼Œä»ä¸­æ‰¾åˆ°å·®å¼‚çš„æ•°æ®ï¼›\n- replication offsetï¼Œæ ‡è®°ä¸Šé¢é‚£ä¸ªç¼“å†²åŒºçš„åŒæ­¥è¿›åº¦ï¼Œä¸»ä»æœåŠ¡å™¨éƒ½æœ‰å„è‡ªçš„åç§»é‡ï¼Œä¸»æœåŠ¡å™¨ä½¿ç”¨ master_repl_offset æ¥è®°å½•è‡ªå·±ã€Œå†™ã€åˆ°çš„ä½ç½®ï¼Œä»æœåŠ¡å™¨ä½¿ç”¨ slave_repl_offset æ¥è®°å½•è‡ªå·±ã€Œè¯»ã€åˆ°çš„ä½ç½®ã€‚\n\n**é‚£ repl_backlog_buffer ç¼“å†²åŒºæ˜¯ä»€ä¹ˆæ—¶å€™å†™å…¥çš„å‘¢ï¼Ÿ**\n\nåœ¨ä¸»æœåŠ¡å™¨è¿›è¡Œå‘½ä»¤ä¼ æ’­æ—¶ï¼Œä¸ä»…ä¼šå°†å†™å‘½ä»¤å‘é€ç»™ä»æœåŠ¡å™¨ï¼Œè¿˜ä¼šå°†å†™å‘½ä»¤å†™å…¥åˆ° repl_backlog_buffer ç¼“å†²åŒºé‡Œï¼Œå› æ­¤ è¿™ä¸ªç¼“å†²åŒºé‡Œä¼šä¿å­˜ç€æœ€è¿‘ä¼ æ’­çš„å†™å‘½ä»¤ã€‚\n\nç½‘ç»œæ–­å¼€åï¼Œå½“ä»æœåŠ¡å™¨é‡æ–°è¿ä¸Šä¸»æœåŠ¡å™¨æ—¶ï¼Œä»æœåŠ¡å™¨ä¼šé€šè¿‡ psync å‘½ä»¤å°†è‡ªå·±çš„å¤åˆ¶åç§»é‡ slave_repl_offset å‘é€ç»™ä¸»æœåŠ¡å™¨ï¼Œä¸»æœåŠ¡å™¨æ ¹æ®è‡ªå·±çš„ master_repl_offset å’Œ slave_repl_offset ä¹‹é—´çš„å·®è·ï¼Œç„¶åæ¥å†³å®šå¯¹ä»æœåŠ¡å™¨æ‰§è¡Œå“ªç§åŒæ­¥æ“ä½œï¼š\n\n- å¦‚æœåˆ¤æ–­å‡ºä»æœåŠ¡å™¨è¦è¯»å–çš„æ•°æ®è¿˜åœ¨ repl_backlog_buffer ç¼“å†²åŒºé‡Œï¼Œé‚£ä¹ˆä¸»æœåŠ¡å™¨å°†é‡‡ç”¨å¢é‡åŒæ­¥çš„æ–¹å¼ï¼›\n- ç›¸åï¼Œå¦‚æœåˆ¤æ–­å‡ºä»æœåŠ¡å™¨è¦è¯»å–çš„æ•°æ®å·²ç»ä¸å­˜åœ¨ repl_backlog_buffer ç¼“å†²åŒºé‡Œï¼Œé‚£ä¹ˆä¸»æœåŠ¡å™¨å°†é‡‡ç”¨å…¨é‡åŒæ­¥çš„æ–¹å¼ã€‚ï¼ˆè¿™æ˜¯ç”±äºç¼“å†²åŒºæ˜¯ç¯å½¢çš„ï¼Œæ—¶é—´è¿‡é•¿å°±ä¼šå¯¼è‡´åŸæ¥çš„æ•°æ®è¢«è¦†ç›–ï¼‰\n\n**ç¯å½¢ç¼“å†²åŒºrepl_backlog_buffer**\n\nå½“ä¸»æœåŠ¡å™¨åœ¨ repl_backlog_buffer ä¸­æ‰¾åˆ°ä¸»ä»æœåŠ¡å™¨å·®å¼‚ï¼ˆå¢é‡ï¼‰çš„æ•°æ®åï¼Œå°±ä¼šå°†å¢é‡çš„æ•°æ®å†™å…¥åˆ° replication buffer ç¼“å†²åŒºï¼Œè¿™ä¸ªç¼“å†²åŒºæˆ‘ä»¬å‰é¢ä¹Ÿæåˆ°è¿‡ï¼Œå®ƒæ˜¯ç¼“å­˜å°†è¦ä¼ æ’­ç»™ä»æœåŠ¡å™¨çš„å‘½ä»¤ã€‚\n\nrepl_backlog_buffer ç¼“è¡Œç¼“å†²åŒºçš„é»˜è®¤å¤§å°æ˜¯ 1Mï¼Œå¹¶ä¸”ç”±äºå®ƒæ˜¯ä¸€ä¸ªç¯å½¢ç¼“å†²åŒºï¼Œæ‰€ä»¥å½“ç¼“å†²åŒºå†™æ»¡åï¼Œä¸»æœåŠ¡å™¨ç»§ç»­å†™å…¥çš„è¯ï¼Œå°±ä¼šè¦†ç›–ä¹‹å‰çš„æ•°æ®ã€‚å› æ­¤ï¼Œå½“ä¸»æœåŠ¡å™¨çš„å†™å…¥é€Ÿåº¦è¿œè¶…äºä»æœåŠ¡å™¨çš„è¯»å–é€Ÿåº¦ï¼Œç¼“å†²åŒºçš„æ•°æ®ä¸€ä¸‹å°±ä¼šè¢«è¦†ç›–ã€‚\n\né‚£ä¹ˆåœ¨ç½‘ç»œæ¢å¤æ—¶ï¼Œå¦‚æœä»æœåŠ¡å™¨æƒ³è¯»çš„æ•°æ®å·²ç»è¢«è¦†ç›–äº†ï¼Œä¸»æœåŠ¡å™¨å°±ä¼šé‡‡ç”¨å…¨é‡åŒæ­¥ï¼Œè¿™ä¸ªæ–¹å¼æ¯”å¢é‡åŒæ­¥çš„æ€§èƒ½æŸè€—è¦å¤§å¾ˆå¤šã€‚\n\nå› æ­¤ï¼Œä¸ºäº†é¿å…åœ¨ç½‘ç»œæ¢å¤æ—¶ï¼Œä¸»æœåŠ¡å™¨é¢‘ç¹åœ°ä½¿ç”¨å…¨é‡åŒæ­¥çš„æ–¹å¼ï¼Œæˆ‘ä»¬åº”è¯¥è°ƒæ•´ä¸‹ repl_backlog_buffer ç¼“å†²åŒºå¤§å°ï¼Œå°½å¯èƒ½çš„å¤§ä¸€äº›ï¼Œå‡å°‘å‡ºç°ä»æœåŠ¡å™¨è¦è¯»å–çš„æ•°æ®è¢«è¦†ç›–çš„æ¦‚ç‡ï¼Œä»è€Œä½¿å¾—ä¸»æœåŠ¡å™¨é‡‡ç”¨å¢é‡åŒæ­¥çš„æ–¹å¼ã€‚\n\n**repl_backlog_buffer ç¼“å†²åŒºå…·ä½“è¦è°ƒæ•´åˆ°å¤šå¤§å‘¢ï¼Ÿ**\n\n$$\nsecond * write_size_per_second\n$$\n \n- secondä¸ºä»æœåŠ¡å™¨æ‰çº¿ä»¥åé‡æ–°è¿ä¸Šä¸»æœåŠ¡å™¨æ‰€éœ€çš„å¹³å‡æ—¶é—´ï¼ˆä»¥ç§’è®¡ç®—ï¼‰\n- write_size_per_secondä¸ºä¸»æœåŠ¡å™¨å¹³å‡æ¯ç§’äº§ç”Ÿçš„å†™å‘½ä»¤æ•°æ®é‡å¤§å°\n\n> ç¯å½¢ç¼“å†²åŒºçš„å¤§å°ä¸èƒ½ä½äºå¹³å‡æ‰çº¿æ—¶é—´*ä¸»æœåŠ¡å™¨å¹³å‡æ¯ç§’äº§ç”Ÿçš„æ•°æ®é‡ï¼Œè¦ä¸ç„¶ä¼šé¢‘ç¹bgsaveå½±å“ä¸»è¿›ç¨‹ï¼Œå¼€é”€å¤§\n> \n> ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœä¸»æœåŠ¡å™¨å¹³å‡æ¯ç§’äº§ç”Ÿ 1 MB çš„å†™å‘½ä»¤ï¼Œè€Œä»æœåŠ¡å™¨æ–­çº¿ä¹‹åå¹³å‡è¦ 5 ç§’æ‰èƒ½é‡æ–°è¿æ¥ä¸»æœåŠ¡å™¨ã€‚\n>\n> é‚£ä¹ˆ repl_backlog_buffer å¤§å°å°±ä¸èƒ½ä½äº 5 MBï¼Œå¦åˆ™æ–°å†™åœ°å‘½ä»¤å°±ä¼šè¦†ç›–æ—§æ•°æ®äº†ã€‚\n>\n> å½“ç„¶ï¼Œä¸ºäº†åº”å¯¹ä¸€äº›çªå‘çš„æƒ…å†µï¼Œå¯ä»¥å°† repl_backlog_buffer çš„å¤§å°è®¾ç½®ä¸ºæ­¤åŸºç¡€ä¸Šçš„ 2 å€ï¼Œä¹Ÿå°±æ˜¯ 10 MBã€‚\n> \n> å…³äº repl_backlog_buffer å¤§å°ä¿®æ”¹çš„æ–¹æ³•ï¼Œåªéœ€è¦ä¿®æ”¹é…ç½®æ–‡ä»¶é‡Œä¸‹é¢è¿™ä¸ªå‚æ•°é¡¹çš„å€¼å°±å¯ä»¥ã€‚ repl-backlog-size 1mb\n\n\n# å“¨å…µæœºåˆ¶\n\nåœ¨ Redis çš„ä¸»ä»æ¶æ„ä¸­ï¼Œç”±äºä¸»ä»æ¨¡å¼æ˜¯è¯»å†™åˆ†ç¦»çš„ï¼Œå¦‚æœä¸»èŠ‚ç‚¹ï¼ˆmasterï¼‰æŒ‚äº†ï¼Œé‚£ä¹ˆå°†æ²¡æœ‰ä¸»èŠ‚ç‚¹æ¥æœåŠ¡å®¢æˆ·ç«¯çš„å†™æ“ä½œè¯·æ±‚ï¼Œä¹Ÿæ²¡æœ‰ä¸»èŠ‚ç‚¹ç»™ä»èŠ‚ç‚¹ï¼ˆslaveï¼‰è¿›è¡Œæ•°æ®åŒæ­¥äº†ã€‚\n![](../img/Redis/img_17.png)\nè¿™æ—¶å¦‚æœè¦æ¢å¤æœåŠ¡çš„è¯ï¼Œéœ€è¦äººå·¥ä»‹å…¥ï¼Œé€‰æ‹©ä¸€ä¸ªã€Œä»èŠ‚ç‚¹ã€åˆ‡æ¢ä¸ºã€Œä¸»èŠ‚ç‚¹ã€ï¼Œç„¶åè®©å…¶ä»–ä»èŠ‚ç‚¹æŒ‡å‘æ–°çš„ä¸»èŠ‚ç‚¹ï¼ŒåŒæ—¶è¿˜éœ€è¦é€šçŸ¥ä¸Šæ¸¸é‚£äº›è¿æ¥ Redis ä¸»èŠ‚ç‚¹çš„å®¢æˆ·ç«¯ï¼Œå°†å…¶é…ç½®ä¸­çš„ä¸»èŠ‚ç‚¹ IP åœ°å€æ›´æ–°ä¸ºã€Œæ–°ä¸»èŠ‚ç‚¹ã€çš„ IP åœ°å€ã€‚\n\nè¿™æ ·ä¹Ÿä¸å¤ªâ€œæ™ºèƒ½â€äº†ï¼Œè¦æ˜¯æœ‰ä¸€ä¸ªèŠ‚ç‚¹èƒ½ç›‘æ§ã€Œä¸»èŠ‚ç‚¹ã€çš„çŠ¶æ€ï¼Œå½“å‘ç°ä¸»èŠ‚ç‚¹æŒ‚äº†ï¼Œå®ƒè‡ªåŠ¨å°†ä¸€ä¸ªã€Œä»èŠ‚ç‚¹ã€åˆ‡æ¢ä¸ºã€Œä¸»èŠ‚ç‚¹ã€çš„è¯ï¼Œé‚£ä¹ˆå¯ä»¥èŠ‚çœæˆ‘ä»¬å¾ˆå¤šäº‹æƒ…å•Šï¼\n\nRedis åœ¨ 2.8 ç‰ˆæœ¬ä»¥åæä¾›çš„**å“¨å…µï¼ˆSentinelï¼‰æœºåˆ¶**ï¼Œå®ƒçš„ä½œç”¨æ˜¯å®ç°**ä¸»ä»èŠ‚ç‚¹æ•…éšœè½¬ç§»**ã€‚å®ƒä¼šç›‘æµ‹ä¸»èŠ‚ç‚¹æ˜¯å¦å­˜æ´»ï¼Œå¦‚æœå‘ç°ä¸»èŠ‚ç‚¹æŒ‚äº†ï¼Œå®ƒå°±ä¼šé€‰ä¸¾ä¸€ä¸ªä»èŠ‚ç‚¹åˆ‡æ¢ä¸ºä¸»èŠ‚ç‚¹ï¼Œå¹¶ä¸”æŠŠæ–°ä¸»èŠ‚ç‚¹çš„ç›¸å…³ä¿¡æ¯é€šçŸ¥ç»™ä»èŠ‚ç‚¹å’Œå®¢æˆ·ç«¯\n\n\n## å“¨å…µçš„åŠŸèƒ½\n- ç›‘æ§ï¼šSentinelä¼šå®šæœŸæ£€æŸ¥masterå’Œslaveæ˜¯å¦æŒ‰ç…§é¢„æœŸå·¥ä½œï¼ˆé€šè¿‡å¿ƒè·³æœºåˆ¶ï¼‰\n- è‡ªåŠ¨æ•…éšœæ¢å¤ï¼šå¦‚æœmasteræ•…éšœï¼Œå°±é€‰ä¸¾å‡ºä¸€ä¸ªslaveä½œä¸ºæ–°çš„masterï¼Œç„¶åè¿›è¡Œä¸»èŠ‚ç‚¹æ•…éšœè¿ç§»\n- é€šçŸ¥ï¼šå½“å‘ç”Ÿæ•…éšœè½¬ç§»æ—¶ï¼Œä¼šå°†æœ€æ–°ä¿¡æ¯å‘é€ç»™Rediså®¢æˆ·ç«¯ ![](../img/Redis/img_18.png)\n\n## æœåŠ¡çŠ¶æ€ç›‘æ§\n\n> SentinelåŸºäºå¿ƒè·³æœºåˆ¶ping-pongï¼Œæ¯éš”1ç§’å‘æ¯ä¸ªé›†ç¾¤å†…çš„å®ä¾‹å‘é€pingã€‚\n> - ä¸»è§‚ä¸‹çº¿ï¼šå¦‚æœæŸsentinelèŠ‚ç‚¹å‘ç°å®ä¾‹æ²¡æœ‰åœ¨è§„å®šæ—¶é—´å†…å“åº”ï¼Œé‚£å°±æ ‡è®°æˆ**ä¸»è§‚ä¸‹çº¿**ï¼Œè¿™ä¸ªè§„å®šçš„æ—¶é—´æ˜¯é…ç½®é¡¹down-after-milliseconds å‚æ•°è®¾å®šçš„ï¼Œå•ä½æ˜¯æ¯«ç§’ã€‚\n> - å®¢è§‚ä¸‹çº¿ï¼šæœ‰çš„æ—¶å€™ä¸»èŠ‚ç‚¹å…¶å®å¹¶æ²¡æœ‰å‘ç”Ÿæ•…éšœï¼Œåªæ˜¯å› ä¸ºç½‘ç»œæ‹¥å¡ï¼Œå¯¼è‡´æ²¡æœ‰åœ¨è§„å®šæ—¶é—´å“åº”Pingã€‚ä¸ºäº†å‡å°‘è¯¯åˆ¤çš„æƒ…å†µï¼Œå“¨å…µä¸ä¼šä¹‹é…ç½®æˆä¸€ä¸ªèŠ‚ç‚¹ï¼ˆè‡³å°‘æœ‰ä¸‰å°æœºå™¨æ¥éƒ¨ç½²å“¨å…µé›†ç¾¤ï¼‰å¦‚æœè¶…è¿‡æŒ‡å®šæ•°é‡ï¼ˆquorumï¼‰çš„å“¨å…µè®¤ä¸ºè¯¥å®ä¾‹ä¸»è§‚ä¸‹çº¿ï¼Œé‚£ä¹ˆè¯¥èŠ‚ç‚¹å°±æ˜¯**å®¢è§‚ä¸‹çº¿**ï¼Œé‚£å°±è¢«è®¤ä¸ºæ˜¯æ•…éšœã€‚\n\nå“¨å…µä¼šæ¯éš” 1 ç§’ç»™æ‰€æœ‰ä¸»ä»èŠ‚ç‚¹å‘é€ PING å‘½ä»¤ï¼Œå½“ä¸»ä»èŠ‚ç‚¹æ”¶åˆ° PING å‘½ä»¤åï¼Œä¼šå‘é€ä¸€ä¸ªå“åº”å‘½ä»¤ç»™å“¨å…µï¼Œè¿™æ ·å°±å¯ä»¥åˆ¤æ–­å®ƒä»¬æ˜¯å¦åœ¨æ­£å¸¸è¿è¡Œã€‚\n\nå¦‚æœä¸»èŠ‚ç‚¹æˆ–è€…ä»èŠ‚ç‚¹æ²¡æœ‰åœ¨è§„å®šçš„æ—¶é—´å†…å“åº”å“¨å…µçš„ PING å‘½ä»¤ï¼Œå“¨å…µå°±ä¼šå°†å®ƒä»¬æ ‡è®°ä¸ºã€Œä¸»è§‚ä¸‹çº¿ã€ã€‚è¿™ä¸ªã€Œè§„å®šçš„æ—¶é—´ã€æ˜¯é…ç½®é¡¹ down-after-milliseconds å‚æ•°è®¾å®šçš„ï¼Œå•ä½æ˜¯æ¯«ç§’ã€‚\n\nä¹‹æ‰€ä»¥é’ˆå¯¹ã€Œä¸»èŠ‚ç‚¹ã€è®¾è®¡ã€Œä¸»è§‚ä¸‹çº¿ã€å’Œã€Œå®¢è§‚ä¸‹çº¿ã€ä¸¤ä¸ªçŠ¶æ€ï¼Œæ˜¯å› ä¸ºæœ‰å¯èƒ½ã€Œä¸»èŠ‚ç‚¹ã€å…¶å®å¹¶æ²¡æœ‰æ•…éšœï¼Œå¯èƒ½åªæ˜¯å› ä¸ºä¸»èŠ‚ç‚¹çš„ç³»ç»Ÿå‹åŠ›æ¯”è¾ƒå¤§æˆ–è€…ç½‘ç»œå‘é€äº†æ‹¥å¡ï¼Œå¯¼è‡´ä¸»èŠ‚ç‚¹æ²¡æœ‰åœ¨è§„å®šæ—¶é—´å†…å“åº”å“¨å…µçš„ PING å‘½ä»¤ã€‚\n\næ‰€ä»¥ï¼Œä¸ºäº†å‡å°‘è¯¯åˆ¤çš„æƒ…å†µï¼Œå“¨å…µåœ¨éƒ¨ç½²çš„æ—¶å€™ä¸ä¼šåªéƒ¨ç½²ä¸€ä¸ªèŠ‚ç‚¹ï¼Œè€Œæ˜¯ç”¨å¤šä¸ªèŠ‚ç‚¹éƒ¨ç½²æˆå“¨å…µé›†ç¾¤ï¼ˆæœ€å°‘éœ€è¦ä¸‰å°æœºå™¨æ¥éƒ¨ç½²å“¨å…µé›†ç¾¤ï¼‰ï¼Œé€šè¿‡å¤šä¸ªå“¨å…µèŠ‚ç‚¹ä¸€èµ·åˆ¤æ–­ï¼Œå°±å¯ä»¥å°±å¯ä»¥é¿å…å•ä¸ªå“¨å…µå› ä¸ºè‡ªèº«ç½‘ç»œçŠ¶å†µä¸å¥½ï¼Œè€Œè¯¯åˆ¤ä¸»èŠ‚ç‚¹ä¸‹çº¿çš„æƒ…å†µã€‚åŒæ—¶ï¼Œå¤šä¸ªå“¨å…µçš„ç½‘ç»œåŒæ—¶ä¸ç¨³å®šçš„æ¦‚ç‡è¾ƒå°ï¼Œç”±å®ƒä»¬ä¸€èµ·åšå†³ç­–ï¼Œè¯¯åˆ¤ç‡ä¹Ÿèƒ½é™ä½ã€‚\n\nå…·ä½“æ˜¯æ€ä¹ˆåˆ¤å®šä¸»èŠ‚ç‚¹ä¸ºã€Œå®¢è§‚ä¸‹çº¿ã€çš„å‘¢ï¼Ÿ\n\nå½“ä¸€ä¸ªå“¨å…µåˆ¤æ–­ä¸»èŠ‚ç‚¹ä¸ºã€Œä¸»è§‚ä¸‹çº¿ã€åï¼Œå°±ä¼šå‘å…¶ä»–å“¨å…µå‘èµ·å‘½ä»¤ï¼Œå…¶ä»–å“¨å…µæ”¶åˆ°è¿™ä¸ªå‘½ä»¤åï¼Œå°±ä¼šæ ¹æ®è‡ªèº«å’Œä¸»èŠ‚ç‚¹çš„ç½‘ç»œçŠ¶å†µï¼Œåšå‡ºèµæˆæŠ•ç¥¨æˆ–è€…æ‹’ç»æŠ•ç¥¨çš„å“åº”ã€‚\n\n![](../img/Redis/img_19.png)\n\nå½“è¿™ä¸ªå“¨å…µçš„èµåŒç¥¨æ•°è¾¾åˆ°å“¨å…µé…ç½®æ–‡ä»¶ä¸­çš„ quorum é…ç½®é¡¹è®¾å®šçš„å€¼åï¼Œè¿™æ—¶ä¸»èŠ‚ç‚¹å°±ä¼šè¢«è¯¥å“¨å…µæ ‡è®°ä¸ºã€Œå®¢è§‚ä¸‹çº¿ã€ã€‚\n\nä¾‹å¦‚ï¼Œç°åœ¨æœ‰ 3 ä¸ªå“¨å…µï¼Œquorum é…ç½®çš„æ˜¯ 2ï¼Œé‚£ä¹ˆä¸€ä¸ªå“¨å…µéœ€è¦ 2 å¼ èµæˆç¥¨ï¼Œå°±å¯ä»¥æ ‡è®°ä¸»èŠ‚ç‚¹ä¸ºâ€œå®¢è§‚ä¸‹çº¿â€äº†ã€‚è¿™ 2 å¼ èµæˆç¥¨åŒ…æ‹¬å“¨å…µè‡ªå·±çš„ä¸€å¼ èµæˆç¥¨å’Œå¦å¤–ä¸¤ä¸ªå“¨å…µçš„èµæˆç¥¨ï¼ˆ**åŒ…æ‹¬è‡ªå·±çš„ä¸€ç¥¨**ï¼‰ã€‚\n\nPSï¼šquorum çš„å€¼ä¸€èˆ¬è®¾ç½®ä¸ºå“¨å…µä¸ªæ•°çš„äºŒåˆ†ä¹‹ä¸€åŠ  1ï¼Œä¾‹å¦‚ 3 ä¸ªå“¨å…µå°±è®¾ç½® 2ã€‚\n\nå“¨å…µåˆ¤æ–­å®Œä¸»èŠ‚ç‚¹å®¢è§‚ä¸‹çº¿åï¼Œå“¨å…µå°±è¦å¼€å§‹åœ¨å¤šä¸ªã€Œä»èŠ‚ç‚¹ã€ä¸­ï¼Œé€‰å‡ºä¸€ä¸ªä»èŠ‚ç‚¹æ¥åšæ–°ä¸»èŠ‚ç‚¹\n\n## ç”±å“ªä¸ªå“¨å…µè¿›è¡Œä¸»ä»æ•…éšœè½¬ç§»ï¼Ÿ\n> å‡è®¾åˆšåˆšåœ¨å“¨å…µçš„å†…éƒ¨å·²ç»å°†ä¸»èŠ‚ç‚¹æ ‡è®°æˆäº†**å®¢è§‚ä¸‹çº¿**ï¼Œé‚£ä¹ˆå“¨å…µé›†ç¾¤å“ªä¸ªèŠ‚ç‚¹æ¥å¯¹å…¶è¿›è¡Œæ•…éšœè½¬ç§»å‘¢ï¼Ÿ\n> \n> è¿™ä¸ªæ—¶å€™éœ€è¦é€‰ä¸¾ä¸€ä¸ªå“¨å…µé›†ç¾¤çš„leaderæ¥è¿›è¡Œæ•…éšœè½¬ç§»ï¼Œä½†æ˜¯åœ¨æŠ•ç¥¨ä¹‹å‰è‚¯å®šéœ€è¦ä¸€ä¸ª**å€™é€‰è€…**ï¼Œè¿™ä¸ªå€™é€‰è€…ä¸€èˆ¬æ˜¯é¦–å…ˆå‘ç°ä¸»èŠ‚ç‚¹çš„å“¨å…µã€‚\n> \n> é‚£ä¹ˆæ€ä¹ˆæ ·æˆä¸ºleaderå‘¢ï¼Œå“¨å…µé›†ç¾¤éœ€è¦è¿›è¡ŒæŠ•ç¥¨ï¼Œæ¯ä¸ªå“¨å…µåªæœ‰ä¸€æ¬¡æŠ•ç¥¨æœºä¼šï¼Œåªæœ‰å€™é€‰è€…èƒ½å¤ŸæŠ•ç»™è‡ªå·±ï¼ˆä¸€èˆ¬ä¹Ÿåªæœ‰ä¸€ä¸ªå€™é€‰è€…ï¼Œé™¤éå‡ºç°åŒä¸€æ—¶é—´ç‚¹æœ‰ä¸¤ä¸ªå“¨å…µå‘ç°äº†ä¸»èŠ‚ç‚¹æ•…éšœå‘èµ·ä¸»è§‚ä¸‹çº¿ï¼‰\n> \n> åœ¨æŠ•ç¥¨è¿‡ç¨‹ä¸­ï¼Œåªè¦å€™é€‰è€…è¾¾åˆ°ä»¥ä¸‹æ¡ä»¶å°±å¯ä»¥å˜æˆleaderï¼š\n> - ç¬¬ä¸€ï¼Œæ‹¿åˆ°åŠæ•°ä»¥ä¸Šçš„èµæˆç¥¨\n> - ç¬¬äºŒï¼Œç¥¨æ•°è¿˜è¦åŒæ—¶å¤§äºç­‰äºquorum å€¼\n\n**å¦‚æœæŸä¸ªæ—¶é—´ç‚¹ï¼Œåˆšå¥½æœ‰ä¸¤ä¸ªå“¨å…µèŠ‚ç‚¹åˆ¤æ–­åˆ°ä¸»èŠ‚ç‚¹ä¸ºå®¢è§‚ä¸‹çº¿ï¼Œé‚£è¿™æ—¶ä¸å°±æœ‰ä¸¤ä¸ªå€™é€‰è€…äº†ï¼Ÿè¿™æ—¶è¯¥å¦‚ä½•å†³å®šè°æ˜¯ Leader å‘¢ï¼Ÿ**\n\næ¯ä½å€™é€‰è€…éƒ½ä¼šå…ˆç»™è‡ªå·±æŠ•ä¸€ç¥¨ï¼Œç„¶åå‘å…¶ä»–å“¨å…µå‘èµ·æŠ•ç¥¨è¯·æ±‚ã€‚å¦‚æœæŠ•ç¥¨è€…å…ˆæ”¶åˆ°ã€Œå€™é€‰è€… Aã€çš„æŠ•ç¥¨è¯·æ±‚ï¼Œå°±ä¼šå…ˆæŠ•ç¥¨ç»™å®ƒï¼Œå¦‚æœæŠ•ç¥¨è€…ç”¨å®ŒæŠ•ç¥¨æœºä¼šåï¼Œæ”¶åˆ°ã€Œå€™é€‰è€… Bã€çš„æŠ•ç¥¨è¯·æ±‚åï¼Œå°±ä¼šæ‹’ç»æŠ•ç¥¨ã€‚è¿™æ—¶ï¼Œå€™é€‰è€… A å…ˆæ»¡è¶³äº†ä¸Šé¢çš„é‚£ä¸¤ä¸ªæ¡ä»¶ï¼Œæ‰€ä»¥ã€Œå€™é€‰è€… Aã€å°±ä¼šè¢«é€‰ä¸¾ä¸º Leaderã€‚\n\n**Redis 1 ä¸» 4 ä»ï¼Œ5 ä¸ªå“¨å…µï¼Œquorum è®¾ç½®ä¸º 3ï¼Œå¦‚æœ 2 ä¸ªå“¨å…µæ•…éšœï¼Œå½“ä¸»èŠ‚ç‚¹å®•æœºæ—¶ï¼Œå“¨å…µèƒ½å¦åˆ¤æ–­ä¸»èŠ‚ç‚¹â€œå®¢è§‚ä¸‹çº¿â€ï¼Ÿä¸»ä»èƒ½å¦è‡ªåŠ¨åˆ‡æ¢ï¼Ÿ**\n\n- å“¨å…µé›†ç¾¤å¯ä»¥åˆ¤å®šä¸»èŠ‚ç‚¹â€œå®¢è§‚ä¸‹çº¿â€ã€‚å“¨å…µé›†ç¾¤è¿˜å‰©ä¸‹ 3 ä¸ªå“¨å…µï¼Œå½“ä¸€ä¸ªå“¨å…µåˆ¤æ–­ä¸»èŠ‚ç‚¹â€œä¸»è§‚ä¸‹çº¿â€åï¼Œè¯¢é—®å¦å¤– 2 ä¸ªå“¨å…µåï¼Œæœ‰å¯èƒ½èƒ½æ‹¿åˆ° 3 å¼ èµåŒç¥¨ï¼Œè¿™æ—¶å°±è¾¾åˆ°äº† quorum çš„å€¼ï¼Œå› æ­¤ï¼Œå“¨å…µé›†ç¾¤å¯ä»¥åˆ¤å®šä¸»èŠ‚ç‚¹ä¸ºâ€œå®¢è§‚ä¸‹çº¿â€ã€‚\n\n- å“¨å…µé›†ç¾¤å¯ä»¥å®Œæˆä¸»ä»åˆ‡æ¢ã€‚å½“æœ‰ä¸ªå“¨å…µæ ‡è®°ä¸»èŠ‚ç‚¹ä¸ºã€Œå®¢è§‚ä¸‹çº¿ã€åï¼Œå°±ä¼šè¿›è¡Œé€‰ä¸¾ Leader çš„è¿‡ç¨‹ï¼Œå› ä¸ºæ­¤æ—¶å“¨å…µé›†ç¾¤è¿˜å‰©ä¸‹ 3 ä¸ªå“¨å…µï¼Œé‚£ä¹ˆè¿˜æ˜¯å¯ä»¥æ‹¿åˆ°åŠæ•°ä»¥ä¸Šï¼ˆ5/2+1=3ï¼‰çš„ç¥¨ï¼Œè€Œä¸”ä¹Ÿè¾¾åˆ°äº† quorum å€¼ï¼Œæ»¡è¶³äº†é€‰ä¸¾ Leader çš„ä¸¤ä¸ªæ¡ä»¶ï¼Œæ‰€ä»¥å°±èƒ½é€‰ä¸¾æˆåŠŸï¼Œå› æ­¤å“¨å…µé›†ç¾¤å¯ä»¥å®Œæˆä¸»ä»åˆ‡æ¢ã€‚\n\nå¦‚æœ quorum è®¾ç½®ä¸º 2ï¼Œå¹¶ä¸”å¦‚æœæœ‰ 3 ä¸ªå“¨å…µæ•…éšœçš„è¯ã€‚æ­¤æ—¶å“¨å…µé›†ç¾¤è¿˜æ˜¯å¯ä»¥åˆ¤å®šä¸»èŠ‚ç‚¹ä¸ºâ€œå®¢è§‚ä¸‹çº¿â€ï¼Œä½†æ˜¯å“¨å…µä¸èƒ½å®Œæˆä¸»ä»åˆ‡æ¢äº†ï¼Œå¤§å®¶å¯ä»¥è‡ªå·±æ¨æ¼”ä¸‹ã€‚\n\nå¦‚æœ quorum è®¾ç½®ä¸º 3ï¼Œå¹¶ä¸”å¦‚æœæœ‰ 3 ä¸ªå“¨å…µæ•…éšœçš„è¯ï¼Œå“¨å…µé›†ç¾¤å³ä¸èƒ½åˆ¤å®šä¸»èŠ‚ç‚¹ä¸ºâ€œå®¢è§‚ä¸‹çº¿â€ï¼Œä¹Ÿä¸èƒ½å®Œæˆä¸»ä»åˆ‡æ¢äº†ã€‚\n\nå¯ä»¥çœ‹åˆ°ï¼Œquorum ä¸º 2 çš„æ—¶å€™ï¼Œå¹¶ä¸”å¦‚æœæœ‰ 3 ä¸ªå“¨å…µæ•…éšœçš„è¯ï¼Œè™½ç„¶å¯ä»¥åˆ¤å®šä¸»èŠ‚ç‚¹ä¸ºâ€œå®¢è§‚ä¸‹çº¿â€ï¼Œä½†æ˜¯ä¸èƒ½å®Œæˆä¸»ä»åˆ‡æ¢ï¼Œè¿™æ ·æ„Ÿè§‰ã€Œåˆ¤å®šä¸»èŠ‚ç‚¹ä¸ºå®¢è§‚ä¸‹çº¿ã€è¿™ä»¶äº‹æƒ…ç™½åšäº†ä¸€æ ·ï¼Œæ—¢ç„¶è¿™æ ·ï¼Œè¿˜ä¸å¦‚ä¸è¦åšï¼Œquorum ä¸º 3 çš„æ—¶å€™ï¼Œå°±å¯ä»¥é¿å…è¿™ç§æ— ç”¨åŠŸã€‚\n\n**æ‰€ä»¥ï¼Œquorum çš„å€¼å»ºè®®è®¾ç½®ä¸ºå“¨å…µä¸ªæ•°çš„äºŒåˆ†ä¹‹ä¸€åŠ  1ï¼Œä¾‹å¦‚ 3 ä¸ªå“¨å…µå°±è®¾ç½® 2ï¼Œ5 ä¸ªå“¨å…µè®¾ç½®ä¸º 3ï¼Œè€Œä¸”å“¨å…µèŠ‚ç‚¹çš„æ•°é‡åº”è¯¥æ˜¯å¥‡æ•°ã€‚**\n\n## ä¸»ä»æ•…éšœè½¬ç§»çš„è¿‡ç¨‹\n\n> ä¸»ä»æ•…éšœè½¬ç§»æ“ä½œåŒ…å«ä»¥ä¸‹å››ä¸ªæ­¥éª¤ï¼š \n> - ç¬¬ä¸€æ­¥ï¼šåœ¨å·²ä¸‹çº¿ä¸»èŠ‚ç‚¹ï¼ˆæ—§ä¸»èŠ‚ç‚¹ï¼‰å±ä¸‹çš„æ‰€æœ‰ã€Œä»èŠ‚ç‚¹ã€é‡Œé¢ï¼ŒæŒ‘é€‰å‡ºä¸€ä¸ªä»èŠ‚ç‚¹ï¼Œå¹¶å°†å…¶è½¬æ¢ä¸ºä¸»èŠ‚ç‚¹ã€‚\n> - ç¬¬äºŒæ­¥ï¼šè®©å·²ä¸‹çº¿ä¸»èŠ‚ç‚¹å±ä¸‹çš„æ‰€æœ‰ã€Œä»èŠ‚ç‚¹ã€ä¿®æ”¹å¤åˆ¶ç›®æ ‡ï¼Œä¿®æ”¹ä¸ºå¤åˆ¶ã€Œæ–°ä¸»èŠ‚ç‚¹ã€ï¼›\n> - ç¬¬ä¸‰æ­¥ï¼šå°†æ–°ä¸»èŠ‚ç‚¹çš„ IP åœ°å€å’Œä¿¡æ¯ï¼Œé€šè¿‡ã€Œå‘å¸ƒè€…/è®¢é˜…è€…æœºåˆ¶ã€é€šçŸ¥ç»™å®¢æˆ·ç«¯ï¼› \n> - ç¬¬å››æ­¥ï¼šç»§ç»­ç›‘è§†æ—§ä¸»èŠ‚ç‚¹ï¼Œå½“è¿™ä¸ªæ—§ä¸»èŠ‚ç‚¹é‡æ–°ä¸Šçº¿æ—¶ï¼Œå°†å®ƒè®¾ç½®ä¸ºæ–°ä¸»èŠ‚ç‚¹çš„ä»èŠ‚ç‚¹\n\n### æ­¥éª¤ä¸€ï¼šé€‰å‡ºæ–°èŠ‚ç‚¹\n\næ•…éšœè½¬ç§»æ“ä½œç¬¬ä¸€æ­¥è¦åšçš„å°±æ˜¯åœ¨å·²ä¸‹çº¿ä¸»èŠ‚ç‚¹å±ä¸‹çš„æ‰€æœ‰ã€Œä»èŠ‚ç‚¹ã€ä¸­ï¼ŒæŒ‘é€‰å‡ºä¸€ä¸ªçŠ¶æ€è‰¯å¥½ã€æ•°æ®å®Œæ•´çš„ä»èŠ‚ç‚¹ï¼Œç„¶åå‘è¿™ä¸ªã€Œä»èŠ‚ç‚¹ã€å‘é€ SLAVEOF no one å‘½ä»¤ï¼Œå°†è¿™ä¸ªã€Œä»èŠ‚ç‚¹ã€è½¬æ¢ä¸ºã€Œä¸»èŠ‚ç‚¹ã€ã€‚\n\né‚£ä¹ˆå¤šã€Œä»èŠ‚ç‚¹ã€ï¼Œåˆ°åº•é€‰æ‹©å“ªä¸ªä»èŠ‚ç‚¹ä½œä¸ºæ–°ä¸»èŠ‚ç‚¹çš„ï¼Ÿ\n\néšæœºçš„æ–¹å¼å¥½å—ï¼Ÿéšæœºçš„æ–¹å¼ï¼Œå®ç°èµ·æ¥å¾ˆç®€å•ï¼Œä½†æ˜¯å¦‚æœé€‰åˆ°ä¸€ä¸ªç½‘ç»œçŠ¶æ€ä¸å¥½çš„ä»èŠ‚ç‚¹ä½œä¸ºæ–°ä¸»èŠ‚ç‚¹ï¼Œé‚£ä¹ˆå¯èƒ½åœ¨å°†æ¥ä¸ä¹…åˆè¦åšä¸€æ¬¡ä¸»ä»æ•…éšœè¿ç§»ã€‚\n\næ‰€ä»¥ï¼Œæˆ‘ä»¬é¦–å…ˆè¦æŠŠç½‘ç»œçŠ¶æ€ä¸å¥½çš„ä»èŠ‚ç‚¹ç»™è¿‡æ»¤æ‰ã€‚é¦–å…ˆæŠŠå·²ç»ä¸‹çº¿çš„ä»èŠ‚ç‚¹è¿‡æ»¤æ‰ï¼Œç„¶åæŠŠä»¥å¾€ç½‘ç»œè¿æ¥çŠ¶æ€ä¸å¥½çš„ä»èŠ‚ç‚¹ä¹Ÿç»™è¿‡æ»¤æ‰ã€‚\n\næ€ä¹ˆåˆ¤æ–­ä»èŠ‚ç‚¹ä¹‹å‰çš„ç½‘ç»œè¿æ¥çŠ¶æ€ä¸å¥½å‘¢ï¼Ÿ\n\nRedis æœ‰ä¸ªå« down-after-milliseconds * 10 é…ç½®é¡¹ï¼Œå…¶ down-after-milliseconds æ˜¯ä¸»ä»èŠ‚ç‚¹æ–­è¿çš„æœ€å¤§è¿æ¥è¶…æ—¶æ—¶é—´ã€‚å¦‚æœåœ¨ down-after-milliseconds æ¯«ç§’å†…ï¼Œä¸»ä»èŠ‚ç‚¹éƒ½æ²¡æœ‰é€šè¿‡ç½‘ç»œè”ç³»ä¸Šï¼Œæˆ‘ä»¬å°±å¯ä»¥è®¤ä¸ºä¸»ä»èŠ‚ç‚¹æ–­è¿äº†ã€‚å¦‚æœå‘ç”Ÿæ–­è¿çš„æ¬¡æ•°è¶…è¿‡äº† 10 æ¬¡ï¼Œå°±è¯´æ˜è¿™ä¸ªä»èŠ‚ç‚¹çš„ç½‘ç»œçŠ¶å†µä¸å¥½ï¼Œä¸é€‚åˆä½œä¸ºæ–°ä¸»èŠ‚ç‚¹ã€‚\n\nè‡³æ­¤ï¼Œæˆ‘ä»¬å°±æŠŠç½‘ç»œçŠ¶æ€ä¸å¥½çš„ä»èŠ‚ç‚¹è¿‡æ»¤æ‰äº†ï¼Œæ¥ä¸‹æ¥è¦å¯¹æ‰€æœ‰ä»èŠ‚ç‚¹è¿›è¡Œä¸‰è½®è€ƒå¯Ÿï¼š**ä¼˜å…ˆçº§ã€å¤åˆ¶è¿›åº¦ã€ID å·**ã€‚åœ¨è¿›è¡Œæ¯ä¸€è½®è€ƒå¯Ÿçš„æ—¶å€™ï¼Œå“ªä¸ªä»èŠ‚ç‚¹ä¼˜å…ˆèƒœå‡ºï¼Œå°±é€‰æ‹©å…¶ä½œä¸ºæ–°ä¸»èŠ‚ç‚¹ã€‚\n\n1. ç¬¬ä¸€è½®è€ƒå¯Ÿï¼šå“¨å…µé¦–å…ˆä¼šæ ¹æ®ä»èŠ‚ç‚¹çš„ä¼˜å…ˆçº§æ¥è¿›è¡Œæ’åºï¼Œä¼˜å…ˆçº§è¶Šå°æ’åè¶Šé å‰ï¼Œ \n2. ç¬¬äºŒè½®è€ƒå¯Ÿï¼šå¦‚æœä¼˜å…ˆçº§ç›¸åŒï¼Œåˆ™æŸ¥çœ‹å¤åˆ¶çš„ä¸‹æ ‡ï¼Œå“ªä¸ªä»ã€Œä¸»èŠ‚ç‚¹ã€æ¥æ”¶çš„å¤åˆ¶æ•°æ®å¤šï¼Œå“ªä¸ªå°±é å‰ï¼ˆä¹Ÿå°±æ˜¯offsetæ›´é è¿‘ä¸»èŠ‚ç‚¹é‚£ä¸ªï¼‰\n3. ç¬¬ä¸‰è½®è€ƒå¯Ÿï¼šå¦‚æœä¼˜å…ˆçº§å’Œä¸‹æ ‡éƒ½ç›¸åŒï¼Œå°±é€‰æ‹©ä»èŠ‚ç‚¹ ID è¾ƒå°çš„é‚£ä¸ªã€‚\n\n![](../img/Redis/img_20.png)\n\n### æ­¥éª¤äºŒï¼šå°†ä»èŠ‚ç‚¹æŒ‡å‘ä¸»èŠ‚ç‚¹\n\nå½“æ–°ä¸»èŠ‚ç‚¹å‡ºç°ä¹‹åï¼Œå“¨å…µ leader ä¸‹ä¸€æ­¥è¦åšçš„å°±æ˜¯ï¼Œè®©å·²ä¸‹çº¿ä¸»èŠ‚ç‚¹å±ä¸‹çš„æ‰€æœ‰ã€Œä»èŠ‚ç‚¹ã€æŒ‡å‘ã€Œæ–°ä¸»èŠ‚ç‚¹ã€ï¼Œè¿™ä¸€åŠ¨ä½œå¯ä»¥é€šè¿‡å‘ã€Œä»èŠ‚ç‚¹ã€å‘é€ SLAVEOF å‘½ä»¤æ¥å®ç°ã€‚\n\nå¦‚ä¸‹å›¾ï¼Œå“¨å…µ leader å‘æ‰€æœ‰ä»èŠ‚ç‚¹ï¼ˆserver3 å’Œ server4ï¼‰å‘é€ SLAVEOF ï¼Œè®©å®ƒä»¬æˆä¸ºæ–°ä¸»èŠ‚ç‚¹çš„ä»èŠ‚ç‚¹ã€‚\n\n![](../img/Redis/img_21.png)\n\n![](../img/Redis/img_22.png)\n\n### æ­¥éª¤ä¸‰ï¼šé€šçŸ¥å®¢æˆ·çš„ä¸»èŠ‚ç‚¹å·²æ›´æ¢\n\nç»è¿‡å‰é¢ä¸€ç³»åˆ—çš„æ“ä½œåï¼Œå“¨å…µé›†ç¾¤ç»ˆäºå®Œæˆä¸»ä»åˆ‡æ¢çš„å·¥ä½œï¼Œé‚£ä¹ˆæ–°ä¸»èŠ‚ç‚¹çš„ä¿¡æ¯è¦å¦‚ä½•é€šçŸ¥ç»™å®¢æˆ·ç«¯å‘¢ï¼Ÿ\n\nè¿™ä¸»è¦é€šè¿‡ Redis çš„å‘å¸ƒè€…/è®¢é˜…è€…æœºåˆ¶æ¥å®ç°çš„ã€‚æ¯ä¸ªå“¨å…µèŠ‚ç‚¹æä¾›å‘å¸ƒè€…/è®¢é˜…è€…æœºåˆ¶ï¼Œå®¢æˆ·ç«¯å¯ä»¥ä»å“¨å…µè®¢é˜…æ¶ˆæ¯ã€‚\n\n> ç±»ä¼¼kafkaé‚£ç§è®¢é˜…æœºåˆ¶ï¼Œä¹Ÿå¯ä»¥æƒ³è±¡æˆè®¡ç½‘çš„é‚£ç§å¹¿æ’­ä¿¡é“ï¼Œæ¯ä¸ªå“¨å…µè¿›è¡Œå¹¿æ’­ï¼Œå®¢æˆ·ç«¯æ¥å—ç›¸åº”è¡¨å¤´çš„æ—¶é—´ï¼Œå®Œæˆé€šçŸ¥\n\nå“¨å…µæä¾›çš„æ¶ˆæ¯è®¢é˜…é¢‘é“æœ‰å¾ˆå¤šï¼Œä¸åŒé¢‘é“åŒ…å«äº†ä¸»ä»èŠ‚ç‚¹åˆ‡æ¢è¿‡ç¨‹ä¸­çš„ä¸åŒå…³é”®äº‹ä»¶ï¼Œå‡ ä¸ªå¸¸è§çš„äº‹ä»¶å¦‚ä¸‹ï¼š\n![](../img/Redis/img_23.png)\n\nå®¢æˆ·ç«¯å’Œå“¨å…µå»ºç«‹è¿æ¥åï¼Œå®¢æˆ·ç«¯ä¼šè®¢é˜…å“¨å…µæä¾›çš„é¢‘é“ã€‚ä¸»ä»åˆ‡æ¢å®Œæˆåï¼Œå“¨å…µå°±ä¼šå‘ +switch-master é¢‘é“å‘å¸ƒæ–°ä¸»èŠ‚ç‚¹çš„ IP åœ°å€å’Œç«¯å£çš„æ¶ˆæ¯ï¼Œè¿™ä¸ªæ—¶å€™å®¢æˆ·ç«¯å°±å¯ä»¥æ”¶åˆ°è¿™æ¡ä¿¡æ¯ï¼Œç„¶åç”¨è¿™é‡Œé¢çš„æ–°ä¸»èŠ‚ç‚¹çš„ IP åœ°å€å’Œç«¯å£è¿›è¡Œé€šä¿¡äº†ã€‚\n\né€šè¿‡å‘å¸ƒè€…/è®¢é˜…è€…æœºåˆ¶æœºåˆ¶ï¼Œæœ‰äº†è¿™äº›äº‹ä»¶é€šçŸ¥ï¼Œå®¢æˆ·ç«¯ä¸ä»…å¯ä»¥åœ¨ä¸»ä»åˆ‡æ¢åå¾—åˆ°æ–°ä¸»èŠ‚ç‚¹çš„è¿æ¥ä¿¡æ¯ï¼Œè¿˜å¯ä»¥ç›‘æ§åˆ°ä¸»ä»èŠ‚ç‚¹åˆ‡æ¢è¿‡ç¨‹ä¸­å‘ç”Ÿçš„å„ä¸ªé‡è¦äº‹ä»¶ã€‚è¿™æ ·ï¼Œå®¢æˆ·ç«¯å°±å¯ä»¥çŸ¥é“ä¸»ä»åˆ‡æ¢è¿›è¡Œåˆ°å“ªä¸€æ­¥äº†ï¼Œæœ‰åŠ©äºäº†è§£åˆ‡æ¢è¿›åº¦ã€‚\n\n### æ­¥éª¤å››ï¼šå°†æ—§ä¸»èŠ‚ç‚¹å˜ä¸ºä»èŠ‚ç‚¹\n\næ•…éšœè½¬ç§»æ“ä½œæœ€åè¦åšçš„æ˜¯ï¼Œç»§ç»­ç›‘è§†æ—§ä¸»èŠ‚ç‚¹ï¼Œå½“æ—§ä¸»èŠ‚ç‚¹é‡æ–°ä¸Šçº¿æ—¶ï¼Œå“¨å…µé›†ç¾¤å°±ä¼šå‘å®ƒå‘é€ SLAVEOF å‘½ä»¤ï¼Œè®©å®ƒæˆä¸ºæ–°ä¸»èŠ‚ç‚¹çš„ä»èŠ‚ç‚¹\n\nè‡³æ­¤ï¼Œæ•´ä¸ªä¸»ä»èŠ‚ç‚¹çš„æ•…éšœè½¬ç§»çš„å·¥ä½œç»“æŸ","tags":["Redis"]},{"title":"redis-æŒä¹…åŒ–ç¯‡","url":"/2024/04/01/redis-æŒä¹…åŒ–ç¯‡/","content":"# RedisæŒä¹…åŒ–\nRedis æ˜¯**å†…å­˜æ•°æ®åº“**ï¼Œå¦‚æœä¸å°†å†…å­˜ä¸­çš„æ•°æ®åº“çŠ¶æ€ä¿å­˜åˆ°ç£ç›˜ï¼Œé‚£ä¹ˆä¸€æ—¦æœåŠ¡å™¨è¿›ç¨‹é€€å‡ºï¼ŒæœåŠ¡å™¨ä¸­çš„æ•°æ®åº“çŠ¶æ€ä¹Ÿä¼šæ¶ˆå¤±ã€‚æ‰€ä»¥ Redis æä¾›äº†**æŒä¹…åŒ–åŠŸèƒ½ **!\n## RDB\nRDBå…¨ç§°Redis Database Backup fileï¼ˆRedisæ•°æ®å¤‡ä»½æ–‡ä»¶ï¼‰ï¼Œä¹Ÿè¢«å«åšRedisæ•°æ®å¿«ç…§ã€‚ç®€å•æ¥è¯´å°±æ˜¯å®šæœŸæŠŠå†…å­˜æ‰€æœ‰æ•°æ®éƒ½è®°å½•åˆ°ç£ç›˜ä¸­ã€‚\n\nä¸€æ—¦Rediså®ä¾‹å‡ºç°æ•…éšœé‡å¯ï¼Œå°±ä¼šä»ç£ç›˜ä¸­è¯»å–å¿«ç…§æ–‡ä»¶ï¼Œæ¢å¤æ•°æ®\n\n> ä»€ä¹ˆæ˜¯å¿«ç…§ï¼Ÿå¯ä»¥ç†è§£æˆå®šæœŸç»™å½“å‰çš„å†…å­˜ä¸­çš„redisæ•°æ®æ‹ä¸€å¼ ç…§ï¼Œç„¶åä¿å­˜ä¸‹æ¥ã€‚\n\n### RDBè§¦å‘æœºåˆ¶\n  å¯ä»¥åˆ†ä¸ºæ‰‹åŠ¨è§¦å‘å’Œè‡ªåŠ¨è§¦å‘ï¼Œæ‰‹åŠ¨çš„saveå ç”¨ä¸»è¿›ç¨‹ï¼Œbgsaveæ˜¯forkä¸€ä¸ªæ–°è¿›ç¨‹æ¥å®Œæˆå¿«ç…§ä¿å­˜ï¼Œåœ¨æ­¤æœŸé—´ä¸»è¿›ç¨‹é€šè¿‡copyonwriteçš„æœºåˆ¶ï¼ˆç±»ä¼¼copyonwriteçš„Arraylisté‚£æ ·ï¼‰ï¼Œæ‹·è´ä¸€ä»½å½“å‰æ•°æ®ï¼Œåœ¨æ‹·è´çš„åœ°æ–¹è¿›è¡Œä¿®æ”¹ï¼Œç­‰åˆ°å­è¿›ç¨‹å®Œæˆç£ç›˜å†™ä¹‹åå†è¿›è¡Œè¦†ç›–ã€‚\n\n  è‡ªåŠ¨è§¦å‘å†™åœ¨redis.confä¸Šï¼Œsave X Yï¼Œè¡¨ç¤ºåœ¨Xç§’å†…å¦‚æœæœ‰Yä¸ªkeyä¿®æ”¹ï¼Œé‚£ä¹ˆå°±saveï¼ˆæ³¨æ„è¿™é‡Œè§¦å‘çš„è¿˜æ˜¯bgsaveï¼‰\n![](../img/Redis/img_7.png)\n- æ‰‹åŠ¨è§¦å‘\n![](../img/Redis/img_6.png)\nç”¨bgsaveå¯ä»¥é˜²æ­¢ä¸»è¿›ç¨‹è¢«é˜»å¡ï¼Œæé«˜æ•ˆç‡\n\nforké‡‡ç”¨çš„æ˜¯copy-on-write\n- å½“ä¸»è¿›ç¨‹æ‰§è¡Œè¯»æ“ä½œçš„æ—¶å€™å¯ä»¥è®¿é—®å…±äº«å†…å­˜\n- å½“ä¸»è¿›ç¨‹æ‰§è¡Œå†™æ“ä½œçš„æ—¶å€™ï¼Œåˆ™ä¼šæ‹·è´ä¸€ä»½æ•°æ®\n\n![](../img/Redis/img_9.png)\n> å­è¿›ç¨‹å’Œä¸»çº¿ç¨‹æ€ä¹ˆå…±äº«å†…å­˜ï¼Œä¹Ÿå°±æ˜¯æ€ä¹ˆè®©å­è¿›ç¨‹çŸ¥é“redisçš„å†…å­˜æ˜¯é‚£äº›å—ï¼Ÿé€šè¿‡æ‹·è´ä¸»è¿›ç¨‹çš„é¡µè¡¨ï¼ˆæ²¡é”™å°±æ˜¯è®¡ç»„é‚£ä¸ªé¡µè¡¨ï¼‰ï¼Œè¿™æ ·å°±çŸ¥é“ä¸»è¿›ç¨‹å ç”¨çš„è™šæ‹Ÿåœ°å€å’Œç‰©ç†åœ°å€çš„æ˜ å°„å…³ç³»ï¼Œä»è€Œæ‰¾åˆ°è¿™äº›å—ã€‚\n> \n> copyonwriteä¼šå°†æ­¤æ—¶çš„å…±äº«å†…å­˜å˜æˆ**åªè¯»**ï¼Œä¸»è¿›ç¨‹æ¥è¯»çš„æ—¶å€™å°±å¯ä»¥ç›´æ¥è¯»ï¼Œå†™çš„æ—¶å€™æ‹·è´ä¸€ä»½ã€‚\n- è‡ªåŠ¨è§¦å‘\n![](../img/Redis/img_8.png)\n> æ³¨æ„è¿™é‡Œsaveå…¶å®ä¹Ÿæ˜¯bgsaveï¼Œä¸€èˆ¬éƒ½ä¸ä¼šå½±å“ä¸»è¿›ç¨‹\n\n### ä¼˜ç¼ºç‚¹\n**ä¼˜ç‚¹**ï¼š\n- åªæœ‰ä¸€ä¸ªdump.rdbï¼Œæ–¹ä¾¿æŒä¹…åŒ–ï¼Œæ˜¯ä¸€ä¸ªç´§å‡‘çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ¢å¤çš„æ—¶å€™é€Ÿåº¦ä¹Ÿæ¯”AOFæ›´å¿«ï¼Œåœ¨æ•°æ®é‡å¤§çš„æ—¶å€™æ›´æ˜æ˜¾ã€‚\n- å®ç°äº†æ€§èƒ½çš„æœ€å¤§åŒ–ï¼Œforkå­è¿›ç¨‹æ¥å®Œæˆè€Œä¸å½±å“ä¸»è¿›ç¨‹ï¼Œä¿è¯äº†Redisçš„é«˜æ€§èƒ½ã€‚\n\n**ç¼ºç‚¹**ï¼š\n- å¯èƒ½å­˜åœ¨æ•°æ®ä¸¢å¤±ï¼Œåœ¨ä¸¤æ¬¡RDBçš„æ—¶é—´é‡Œï¼Œå¦‚æœå‡ºç°å®•æœºï¼Œè¿™æ®µæ—¶é—´æ²¡æœ‰å†™å…¥çš„æ•°æ®éƒ½å°†ä¸¢å¤±\n- æ²¡æœ‰åŠæ³•åšåˆ°ç§’çº§æŒä¹…åŒ–/å®æ—¶æŒä¹…åŒ–\n- å¯¹äºcpuå’Œå†…å­˜çš„å¼€é”€æ¯”è¾ƒå¤§ï¼Œæ¯•ç«Ÿè¦forkä¸€ä¸ªæ–°è¿›ç¨‹å ç”¨cpuï¼Œè¿˜è¦è¿›è¡ŒCOWå ç”¨å†…å­˜è€Œï¼ŒAOFä¸»è¦å ç”¨çš„æ˜¯IOèµ„æº\n\n**ä½¿ç”¨åœºæ™¯**ï¼š\n- å¯ä»¥å®¹å¿æ•°åˆ†é’Ÿæ•°æ®ä¸¢å¤±ï¼Œè¿½æ±‚æ›´å¿«çš„å¯åŠ¨é€Ÿåº¦å’Œæ¢å¤é€Ÿåº¦ã€‚\n\n## AOF\nAOFï¼ˆappend only fileï¼‰ æŒä¹…åŒ–ï¼Œé‡‡ç”¨æ—¥å¿—çš„å½¢å¼æ¥è®°å½•æ¯ä¸ªå†™æ“ä½œï¼Œè¿½åŠ åˆ°AOFæ–‡ä»¶çš„æœ«å°¾ã€‚\n> æ„æ€å°±æ˜¯æŠŠæ“ä½œçš„æ¯ä¸€æ¡è¯­å¥éƒ½è®°å½•ä¸‹æ¥ï¼Œé‚£è‚¯å®šå ç”¨çš„ç©ºé—´å¤§\n\nRedisé»˜è®¤æƒ…å†µæ˜¯ä¸å¼€å¯AOFçš„ã€‚é‡å¯æ—¶å†é‡æ–°æ‰§è¡ŒAOFæ–‡ä»¶ä¸­çš„å‘½ä»¤æ¥æ¢å¤æ•°æ®ã€‚å®ƒä¸»è¦è§£å†³æ•°æ®æŒä¹…åŒ–çš„å®æ—¶æ€§é—®é¢˜ã€‚\n\n![](../img/Redis/img_10.png)\n\nAOFæ˜¯**æ‰§è¡Œå®Œå‘½ä»¤åæ‰è®°å½•æ—¥å¿—**çš„ã€‚ä¸ºä»€ä¹ˆä¸å…ˆè®°å½•æ—¥å¿—å†æ‰§è¡Œå‘½ä»¤å‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºRedisåœ¨å‘AOFè®°å½•æ—¥å¿—æ—¶ï¼Œä¸ä¼šå…ˆå¯¹è¿™äº›å‘½ä»¤è¿›è¡Œè¯­æ³•æ£€æŸ¥ï¼Œå¦‚æœå…ˆè®°å½•æ—¥å¿—å†æ‰§è¡Œå‘½ä»¤ï¼Œæ—¥å¿—ä¸­å¯èƒ½è®°å½•äº†é”™è¯¯çš„å‘½ä»¤ï¼ŒRedisä½¿ç”¨æ—¥å¿—å›å¤æ•°æ®æ—¶ï¼Œå¯èƒ½ä¼šå‡ºé”™ã€‚\n\næ­£æ˜¯å› ä¸ºæ‰§è¡Œå®Œå‘½ä»¤åæ‰è®°å½•æ—¥å¿—ï¼Œæ‰€ä»¥ä¸ä¼šé˜»å¡å½“å‰çš„å†™æ“ä½œã€‚ä½†æ˜¯ä¼šå­˜åœ¨ä¸¤ä¸ªé£é™©ï¼š\n\n- æ›´æ‰§è¡Œå®Œå‘½ä»¤è¿˜æ²¡è®°å½•æ—¥å¿—æ—¶ï¼Œå®•æœºäº†ä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±\n- AOFä¸ä¼šé˜»å¡å½“å‰å‘½ä»¤ï¼Œä½†æ˜¯å¯èƒ½ä¼šé˜»å¡ä¸‹ä¸€ä¸ªæ“ä½œã€‚\n\n> è¿™ä¸¤ä¸ªé£é™©æœ€å¥½çš„è§£å†³æ–¹æ¡ˆæ˜¯æŠ˜ä¸­å¦™ç”¨AOFæœºåˆ¶çš„ä¸‰ç§å†™å›ç­–ç•¥ appendfsyncï¼š\n>- alwaysï¼ŒåŒæ­¥å†™å›ï¼Œæ¯ä¸ªå­å‘½ä»¤æ‰§è¡Œå®Œï¼Œéƒ½ç«‹å³å°†æ—¥å¿—å†™å›ç£ç›˜ã€‚\n>- everysecï¼Œæ¯ä¸ªå‘½ä»¤æ‰§è¡Œå®Œï¼Œåªæ˜¯å…ˆæŠŠæ—¥å¿—å†™åˆ°AOFå†…å­˜ç¼“å†²åŒºï¼Œæ¯éš”ä¸€ç§’åŒæ­¥åˆ°ç£ç›˜ã€‚\n>- noï¼šåªæ˜¯å…ˆæŠŠæ—¥å¿—å†™åˆ°AOFå†…å­˜ç¼“å†²åŒºï¼Œæœ‰æ“ä½œç³»ç»Ÿå»å†³å®šä½•æ—¶å†™å…¥ç£ç›˜ã€‚\n\n![](../img/Redis/img_11.png)\n\nalwaysåŒæ­¥å†™å›ï¼Œå¯ä»¥åŸºæœ¬ä¿è¯æ•°æ®ä¸ä¸¢å¤±ï¼Œnoç­–ç•¥åˆ™æ€§èƒ½é«˜ä½†æ˜¯æ•°æ®å¯èƒ½ä¼šä¸¢å¤±ï¼Œä¸€èˆ¬å¯ä»¥è€ƒè™‘æŠ˜ä¸­é€‰æ‹©everysecã€‚\n\nå¦‚æœæ¥å—çš„å‘½ä»¤è¶Šæ¥è¶Šå¤šï¼ŒAOFæ–‡ä»¶ä¹Ÿä¼šè¶Šæ¥è¶Šå¤§ï¼Œæ–‡ä»¶è¿‡å¤§è¿˜æ˜¯ä¼šå¸¦æ¥æ€§èƒ½é—®é¢˜ã€‚æ—¥å¿—æ–‡ä»¶è¿‡å¤§æ€ä¹ˆåŠå‘¢ï¼Ÿ\n> **AOFé‡å†™æœºåˆ¶**å°±æ˜¯éšç€æ—¶é—´æ¨ç§»ï¼ŒAOFæ–‡ä»¶ä¼šæœ‰ä¸€äº›å†—ä½™çš„å‘½ä»¤å¦‚ï¼šæ— æ•ˆå‘½ä»¤ã€è¿‡æœŸæ•°æ®çš„å‘½ä»¤ç­‰ç­‰ï¼ŒAOFé‡å†™æœºåˆ¶å°±æ˜¯æŠŠå®ƒä»¬åˆå¹¶ä¸ºä¸€ä¸ªå‘½ä»¤ï¼ˆç±»ä¼¼æ‰¹å¤„ç†å‘½ä»¤ï¼‰ï¼Œä»è€Œè¾¾åˆ°ç²¾ç®€å‹ç¼©ç©ºé—´çš„ç›®çš„ã€‚\n> \n> AOFé‡å†™ä¼šé˜»å¡å˜›ï¼ŸAOFæ—¥å¿—æ˜¯ç”±ä¸»çº¿ç¨‹ä¼šå†™çš„ï¼Œè€Œé‡å†™åˆ™ä¸ä¸€æ ·ï¼Œé‡å†™è¿‡ç¨‹æ˜¯ç”±åå°å­è¿›ç¨‹bgrewriteaofå®Œæˆã€‚\n\n\n### ä¼˜ç¼ºç‚¹\n**ä¼˜ç‚¹**ï¼š\n- å®æ—¶æŒä¹…åŒ–ï¼Œæ•°æ®å®‰å…¨ï¼ŒAOFæŒä¹…åŒ–é…ç½®ä¸ºalwayså°±å¯ä»¥åŸºæœ¬ä¸Šé¿å…ä¸¢å¤±ï¼Œä½†æ˜¯å¼€é”€æ¯”è¾ƒå¤§ï¼Œé€šå¸¸ç”¨å®¹å¿1så†…ä¸¢å¤±çš„everysec\n- é€šè¿‡appendæ¨¡å¼å†™æ–‡ä»¶ï¼Œé‚£ä¹ˆå³ä½¿ä¸­é€”æœåŠ¡å™¨å®•æœºï¼Œä¹Ÿå¯ä»¥å°½é‡è§£å†³ä¸€è‡´æ€§é—®é¢˜ï¼ˆå–å†³äºåˆ·ç›˜ç­–ç•¥ï¼‰\n- é‡å†™æœºåˆ¶ï¼Œåœ¨æ–‡ä»¶å¤ªå¤§çš„æ—¶å€™å¯ä»¥å‹ç¼©ç©ºé—´\n\n**ç¼ºç‚¹**ï¼š\n- æ–‡ä»¶æ¯”RDBå¤§ï¼Œæ¢å¤æ—¶é—´ä¹Ÿä¼šæ…¢å¾ˆå¤š\n- å¯åŠ¨æ•ˆç‡ä½\n- æ–‡ä»¶ä½“ç§¯è¿…é€Ÿå˜å¤§ï¼Œéœ€è¦å®šæœŸæ‰§è¡Œé‡å†™æœºåˆ¶é™ä½æ–‡ä»¶ä½“ç§¯ã€‚\n\n\n**ä½¿ç”¨åœºæ™¯**ï¼š\n- å¯¹æ•°æ®å®‰å…¨æ€§æœ‰è¾ƒé«˜éœ€æ±‚çš„åœºæ™¯\n\n> Redis4.0å¼€å§‹æ”¯æŒRDBå’ŒAOFçš„æ··åˆæŒä¹…åŒ–ï¼Œå°±æ˜¯å†…å­˜å¿«ç…§ä»¥ä¸€å®šé¢‘ç‡æ‰§è¡Œï¼Œä¸¤æ¬¡å¿«ç…§ä¹‹é—´ï¼Œå†ä½¿ç”¨AOFè®°å½•è¿™æœŸé—´çš„æ‰€æœ‰å‘½ä»¤æ“ä½œã€‚\n\n","tags":["Redis"]},{"title":"redis-ç¼“å­˜ä¸‰å…„å¼Ÿ","url":"/2024/03/31/redis-ç¼“å­˜ä¸‰å…„å¼Ÿ/","content":"# ç¼“å­˜ç©¿é€\n> è¿™é‡Œçš„rediså¯ä»¥å…¨éƒ¨æƒ³è±¡æˆcacheï¼Œæ•°æ®åº“å¯ä»¥æƒ³è±¡æˆcpuï¼Œç©¿é€æœ‰ç‚¹ç»•è¿‡redisçš„æ„æ€\n\n![](../img/Redis/img.png)\nå‡è®¾æœ‰ä¸€ä¸ªè¯·æ±‚api/news/getById/1ï¼Œä½†æ˜¯è¿™ä¸ªidä¸º1çš„é”®å¹¶**ä¸å­˜åœ¨**äºæ•°æ®åº“ï¼Œæ‰€ä»¥ä¹Ÿä¸ä¼šå­˜åœ¨äºç¼“å­˜ï¼Œé‚£ä¹ˆå¦‚æœæœ‰å¾ˆå¤šè¿™ç§è¯·æ±‚ï¼Œé‚£ä¹ˆéƒ½ä¼šç»•è¿‡rediså»æŸ¥è¯¢æ•°æ®åº“ï¼Œé€ æˆæ•°æ®åº“çš„è´Ÿè½½ã€‚\n\n## è§£å†³æ–¹æ³•\n1. ç¼“å­˜ç©ºæ•°æ®ï¼Œå°±ç®—æ˜¯æ•°æ®åº“æ‰¾ä¸åˆ°ä¹Ÿè¦ç¼“å­˜ä¸€ä¸ªç©ºæ•°æ®ç»™redisï¼Œè¦ä¸ç„¶å°±ä¼šä¸€ç›´ä¼šå»ç»•è¿‡rediså»æ‰¾æ•°æ®åº“ã€‚æ¯”å¦‚ç»™çš„key=1ä½†æ˜¯mysqlæ²¡æœ‰ç›¸åº”æ•°æ®ï¼Œé‚£ä¹ˆåœ¨redisä¸Šç¼“å­˜ä¸€ä¸ªkey=1ï¼Œvalue=nullçš„é”®å€¼å¯¹ã€‚\n- **ä¼˜ç‚¹**ï¼šéå¸¸ç®€å•ï¼Œç»´æŠ¤æ–¹ä¾¿\n- **ç¼ºç‚¹**ï¼šä¼šé€ æˆé¢å¤–çš„å†…å­˜æ¶ˆè€—ï¼Œå› ä¸ºredisæ˜¯å­˜åœ¨å†…å­˜ä¸­çš„ï¼Œæœ‰å¤šå°‘ä¸ªæ²¡æœ‰çš„é”®å°±ä¼šæœ‰å¤šå°‘ä¸ªç©ºï¼Œæµªè´¹å†…å­˜ã€‚è¿˜å¯èƒ½é€ æˆ**çŸ­æœŸä¸ä¸€è‡´**é—®é¢˜ï¼Œå¦‚æœåœ¨redisé‡Œé¢å­˜äº†è¿™ä¸ªç©ºä½†æ˜¯è¿™ä¸ªæ—¶å€™æ•°æ®åº“æ›´æ–°äº†è¿™ä¸ªé”®å€¼å¯¹ï¼Œé‚£ä¹ˆåœ¨è¿™ä¸€æ®µæ—¶é—´è®¿é—®redisçš„è¿˜æ˜¯nullï¼Œå°±ä¼šé€ æˆä¸ä¸€è‡´çš„é—®é¢˜\n2. å¸ƒéš†è¿‡æ»¤å™¨\nåœ¨å®¢æˆ·ç«¯ä¸Redisä¹‹é—´åŠ äº†ä¸€ä¸ªå¸ƒéš†è¿‡æ»¤å™¨ï¼Œå¯¹äºè¯·æ±‚è¿›è¡Œè¿‡æ»¤ã€‚\n\n![](../img/Redis/img_1.png)\n\n> **å¸ƒéš†è¿‡æ»¤å™¨**\n> - bitmapï¼ˆä½å›¾ï¼‰:bitä½çš„æ•°ç»„ï¼Œæ•°ç»„çš„å…ƒç´ æ˜¯0æˆ–è€…1ï¼Œæ‰€ä»¥å¸ƒéš†è¿‡æ»¤å™¨å ç”¨çš„å†…å­˜å°\n> - ![](../img/Redis/img_2.png)\n> - ä½œç”¨ï¼šå¯ä»¥ç”¨æ¥æ£€ç´¢å…ƒç´ ï¼Œç›¸å½“äºä¸€ç§æ ¡éªŒç”µè·¯\n> - å®ç°åŸç†ï¼šç±»ä¼¼hashmapï¼Œå‡è®¾æ¥äº†ä¸€ä¸ªé”®ï¼Œç”¨ä¸‰ç§ä¸åŒçš„hashç®—æ³•å¾—åˆ°ä½å›¾çš„ä¸‰ä¸ªä½ç½®ï¼Œç„¶åè¿™äº›ä½ç½®éƒ½ç½®ä¸º1ï¼Œè¿™é‡Œè¦è·Ÿredisç¼“å­˜çš„ä¿æŒä¸€è‡´ï¼Œåœ¨åˆå§‹åŒ–çš„æ—¶å€™å°±è¦é¢„çƒ­è¿›å¸ƒéš†è¿‡æ»¤å™¨ã€‚é‚£ä¹ˆå°±ä¼šæœ‰å¾ˆå¤šé‡å¤çš„ï¼Œæ•°ç»„è¶Šå¤§è¿™ç§æƒ…å†µä¼šè¶Šå°‘ã€‚é‚£ä¹ˆæ­¤æ—¶æœ‰ä¸€ä¸ª**ç¡®å®ä¸å­˜åœ¨çš„å…ƒç´ **ï¼Œä½†æ˜¯è®¡ç®—å‡ºæ¥çš„ä¸‰ä¸ªå“ˆå¸Œå€¼å°±æ˜¯éƒ½æ˜¯1ï¼Œé‚£ä¹ˆè¿˜æ˜¯ä¼šå‘ç”Ÿç¼“å­˜ç©¿é€çš„ç°è±¡\n> - åˆ¤æ–­ä¸å­˜åœ¨çš„æ—¶å€™ä¸€å®šä¸å­˜åœ¨ï¼Œä¹Ÿå°±æ˜¯è¯´3ä¸ªåœ°æ–¹ä¸€å®šéƒ½ä¸ä¸º1\n> - åˆ¤æ–­å­˜åœ¨çš„æ—¶å€™ä¸ä¸€å®šå­˜åœ¨ï¼Œå› ä¸ºæœ‰å¯èƒ½ä¼šæœ‰è¯¯åˆ¤\n> - **ä¼˜ç‚¹**ï¼šå†…å­˜å ç”¨å°ï¼Œæ²¡æœ‰å¤šä½™key\n> - **ç¼ºç‚¹**ï¼šå®ç°æ¯”è¾ƒå¤æ‚ï¼Œå­˜åœ¨è¯¯åˆ¤ï¼Œå¤§æ¦‚åœ¨5%å·¦å³ï¼Œä½†æ˜¯å¯¹äºæ•°æ®åº“ä¹Ÿæ˜¯å¯ä»¥æ¥å—çš„\n\nå¸ƒéš†è¿‡æ»¤å™¨çš„å¤§è‡´çš„åŸç†ï¼šå¸ƒéš†è¿‡æ»¤å™¨ä¸­å­˜æ”¾äºŒè¿›åˆ¶ä½ã€‚æ•°æ®åº“çš„æ•°æ®é€šè¿‡hashç®—æ³•è®¡ç®—å…¶hashå€¼å¹¶å­˜æ”¾åˆ°å¸ƒéš†è¿‡æ»¤å™¨ä¸­ï¼Œä¹‹ååˆ¤æ–­æ•°æ®æ˜¯å¦å­˜åœ¨çš„æ—¶å€™ï¼Œå°±æ˜¯åˆ¤æ–­è¯¥hashå€¼æ˜¯0è¿˜æ˜¯1ã€‚\n\nä½†æ˜¯è¿™ä¸ªç©æ„æ˜¯ä¸€ç§æ¦‚ç‡ä¸Šçš„ç»Ÿè®¡ï¼Œå½“å…¶åˆ¤æ–­ä¸å­˜åœ¨çš„æ—¶å€™å°±ä¸€å®šæ˜¯ä¸å­˜åœ¨ï¼›å½“å…¶åˆ¤æ–­å­˜åœ¨çš„æ—¶å€™å°±ä¸ä¸€å®šå­˜åœ¨ã€‚æ‰€ä»¥æœ‰ä¸€å®šçš„ç©¿é€é£é™©ï¼ï¼ï¼\n\n# ç¼“å­˜å‡»ç©¿\nç¼“å­˜å‡»ç©¿ï¼ŒæŒ‡çš„æ˜¯ä¸€ä¸ªkeyåœ¨ä¸æ–­åœ°æ”¯æ’‘é«˜å¹¶å‘ï¼Œé«˜å¹¶å‘æŒç»­å¯¹è¿™ä¸ªç‚¹è¿›è¡Œè®¿é—®ï¼Œå½“è¿™ä¸ªç‚¹åœ¨å¤±æ•ˆçš„ç¬é—´ï¼Œ50mså·¦å³ï¼Œå¤§é‡çš„é«˜å¹¶å‘å°±å†²å¡ç¼“å­˜è¯·æ±‚æ•°æ®åº“ï¼Œé€ æˆæ•°æ®åº“ç˜«ç—ªã€‚\n\nå¯¹äºä¸€èˆ¬çš„ç½‘ç«™è€Œè¨€å¾ˆéš¾æœ‰ç¼“å­˜å‡»ç©¿çš„çº§åˆ«ï¼Œä¸€èˆ¬æ˜¯çƒ­é—¨ç½‘ç«™æˆ–è€…ç§’æ€ç¬æ—¶é«˜å¹¶å‘ã€‚\n## è§£å†³æ–¹æ³•\n1. äº’æ–¥é”\n\n![](../img/Redis/img_3.png)\n\nç±»ä¼¼pvæ“ä½œï¼Œç»™ä¸´ç•ŒåŒºä¸Šäº’æ–¥é”ï¼Œä¸€æ®µæ—¶é—´åªè¦ä¸€ä¸ªçº¿ç¨‹åœ¨é‡å»ºæ•°æ®å°±è¡Œï¼Œä½†æ˜¯è¿™æ ·ä¼šé€ æˆå…¶ä»–çº¿ç¨‹ç­‰å¾…ã€‚é€šå¸¸æ˜¯éœ€è¦å¼ºä¸€è‡´æ€§çš„åº”ç”¨éœ€è¦è¿™ç§ç­–ç•¥ã€‚\n- **ä¼˜ç‚¹**ï¼šå¼ºä¸€è‡´æ€§ï¼Œåœ¨redisæ²¡æœ‰æ›´æ–°å®Œä¹‹å‰éƒ½ä¸è®¸è®¿é—®ï¼Œåªèƒ½è¦æœ€æ–°çš„ï¼Œä¸€èˆ¬æ¶‰åŠé’±çš„éƒ½ä¼šæœ‰è¿™ç§é€»è¾‘\n- **ç¼ºç‚¹**ï¼šæ€§èƒ½å·®\n\n2. é€»è¾‘è¿‡æœŸ\n\n![](../img/Redis/img_4.png)\n\né€»è¾‘è¿‡æœŸå°±æ˜¯åœ¨ä¸€ä¸ªé”®å€¼å¯¹çš„æœ€ååŠ ä¸Šé€»è¾‘æ—¶é—´ï¼Œå¹¶ä¸çœŸå®è®¾ç½®è¿‡æœŸæ—¶é—´ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸ä¼šçœŸæ­£çš„è¿‡æœŸåªä¼šé€»è¾‘ä¸Šçš„è¿‡æœŸã€‚\n\nå½“ä¸€ä¸ªçº¿ç¨‹å»è®¿é—®ä¸€ä¸ªé€»è¾‘æ—¶é—´åˆ°äº†çš„é”®å€¼å¯¹ï¼Œé‚£ä¹ˆå…¶å®redisä¹Ÿè¿˜æœ‰è¿™éƒ¨åˆ†ï¼Œä»–è¿˜æ˜¯**é‚£è¿™éƒ¨åˆ†æ—§çš„æ•°æ®**ï¼Œä½†æ˜¯ä¼šå¼€å¯ä¸€ä¸ªæ–°çš„çº¿ç¨‹æ¥å®Œæˆæ•°æ®åº“åˆ°mysqlçš„æ›´æ–°\n- **ä¼˜ç‚¹**ï¼šå¯ç”¨æ€§å¼ºï¼Œæ€§èƒ½å¼ºåœ¨ä¸æ³¨é‡å¼ºä¸€è‡´æ€§çš„åœºæ™¯ï¼Œä¸ä¼šæœ‰å…¶ä»–çº¿ç¨‹ç­‰å¾…çš„æƒ…å†µï¼Œä½†æ˜¯æ‹¿çš„éƒ½æ˜¯æ—§æ•°æ®\n- **ç¼ºç‚¹**ï¼šä¸€è‡´æ€§å¼±\n\n\n# ç¼“å­˜é›ªå´©\n\nå¦‚æœç¼“å­˜é›†ä¸­åœ¨ä¸€æ®µæ—¶é—´å†…è¿‡æœŸï¼Œé‚£ä¹ˆä¼šæœ‰å¤§é‡çš„ç¼“å­˜ç©¿é€ï¼Œæ‰€æœ‰çš„æŸ¥è¯¢éƒ½è½åœ¨æ•°æ®åº“ä¸Šï¼Œé€ æˆç¼“å­˜é›ªå´©\n\n> ç¼“å­˜é›ªå´©å’Œç¼“å­˜å‡»ç©¿çš„åŒºåˆ«ï¼šç¼“å­˜å‡»ç©¿æ˜¯é’ˆå¯¹æŸä¸€ä¸ªkeyï¼Œç¼“å­˜é›ªå´©æ˜¯é’ˆå¯¹å¾ˆå¤škeyé›†ä¸­è¿‡æœŸï¼Œ\n\n![](../img/Redis/img_5.png)\n\n## è§£å†³æ–¹æ³•ï¼š\n1. ç»™ä¸åŒçš„keyçš„TTLæ·»åŠ éšæœºå€¼\n2. å¤šä¸ªredisé›†ç¾¤æé«˜æœåŠ¡çš„å¯ç”¨æ€§","tags":["Redis"]},{"title":"å‘¨èµ›2024-3-31","url":"/2024/03/31/å‘¨èµ›2024-3-31/","content":"> å› ä¸ºç¬¬ä¸‰é¢˜longè¢«å¡äº†ä¸‰å‘waï¼Œæ‰€ä»¥å³ä½¿åšå‡ºäº†ç¬¬ä¸‰é¢˜ä¹Ÿæ²¡ä¸Šæ¬¡æ’åé«˜\n\n# ç¬¬ä¸€é¢˜ï¼šå“ˆæ²™å¾·æ•°\n\nå¦‚æœä¸€ä¸ªæ•´æ•°èƒ½å¤Ÿè¢«å…¶å„ä¸ªæ•°ä½ä¸Šçš„æ•°å­—ä¹‹å’Œæ•´é™¤ï¼Œåˆ™ç§°ä¹‹ä¸º **å“ˆæ²™å¾·æ•°**ï¼ˆHarshad numberï¼‰ã€‚ç»™ä½ ä¸€ä¸ªæ•´æ•° x ã€‚å¦‚æœ x æ˜¯ **å“ˆæ²™å¾·æ•°** ï¼Œåˆ™è¿”å› x å„ä¸ªæ•°ä½ä¸Šçš„æ•°å­—ä¹‹å’Œï¼Œå¦åˆ™ï¼Œè¿”å› -1 ã€‚\n\n> å­—ç¬¦ä¸²æ‹†åˆ†æˆæ•°ç»„ï¼Œç„¶åç´¯è®¡å’Œï¼Œæœ€ååšä¸ªåˆ¤æ–­\n```java\nclass Solution {\n    public int sumOfTheDigitsOfHarshadNumber(int x) {\n        String num = \"\"+x;\n        String[] split = num.split(\"\");\n        int ans = 0;\n        //System.out.println(Arrays.toString(split));\n        for (int i = 0; i < split.length; i++) {\n            ans+=Integer.parseInt(split[i]);\n        }\n        if (x % ans ==0){\n            return ans;\n        }\n        else {\n            return -1;\n        }\n    }\n}\n```\n# ç¬¬äºŒé¢˜ï¼šæ¢æ°´é—®é¢˜\nç»™ä½ ä¸¤ä¸ªæ•´æ•° numBottles å’Œ numExchange ã€‚\n\nnumBottles ä»£è¡¨ä½ æœ€åˆæ‹¥æœ‰çš„æ»¡æ°´ç“¶æ•°é‡ã€‚åœ¨ä¸€æ¬¡æ“ä½œä¸­ï¼Œä½ å¯ä»¥æ‰§è¡Œä»¥ä¸‹æ“ä½œä¹‹ä¸€ï¼š\n\n- å–æ‰ä»»æ„æ•°é‡çš„æ»¡æ°´ç“¶ï¼Œä½¿å®ƒä»¬å˜æˆç©ºæ°´ç“¶ã€‚\n- ç”¨ numExchange ä¸ªç©ºæ°´ç“¶äº¤æ¢ä¸€ä¸ªæ»¡æ°´ç“¶ã€‚ç„¶åï¼Œå°† numExchange çš„å€¼å¢åŠ  1 ã€‚\næ³¨æ„ï¼Œä½ ä¸èƒ½ä½¿ç”¨ç›¸åŒçš„ numExchange å€¼äº¤æ¢å¤šæ‰¹ç©ºæ°´ç“¶ã€‚ä¾‹å¦‚ï¼Œå¦‚æœ numBottles == 3 å¹¶ä¸” numExchange == 1 ï¼Œåˆ™ä¸èƒ½ç”¨ 3 ä¸ªç©ºæ°´ç“¶äº¤æ¢æˆ 3 ä¸ªæ»¡æ°´ç“¶ã€‚\n\nè¿”å›ä½  **æœ€å¤š** å¯ä»¥å–åˆ°å¤šå°‘ç“¶æ°´ã€‚\n\n![](../img/coding/2024_3_31_2.png)\n> å°å­¦å¥¥æ•°è²Œä¼¼ç¢°åˆ°è¿‡è¿™æ ·çš„é—®é¢˜ï¼Œå°±æ˜¯æ²¡å…‘æ¢ä¸€æ¬¡ï¼Œå…‘æ¢çš„è¦æ±‚å°±å¤šä¸€ç“¶ï¼Œç›´æ¥æš´åŠ›æ¨¡æ‹Ÿå°±è¡Œ\n```java\nclass Solution {\n    public int maxBottlesDrunk(int numBottles, int numExchange) {\n        int empty = numBottles;\n        int ans = numBottles;\n        //ç›´åˆ°æ¢ä¸äº†äº†\n        while (empty >= numExchange){\n            //å…‘æ¢æ–°çš„ä¹‹åå‰©ä¸‹çš„\n            empty -=numExchange;\n            numExchange++;\n            //å…‘æ¢å¤šçš„\n            empty +=1;\n            ans++;\n        }\n        return ans;\n    }\n}\n```\n# ç¬¬ä¸‰é¢˜ï¼šäº¤æ›¿å­æ•°ç»„è®¡æ•°\nç»™ä½ ä¸€ä¸ª**äºŒè¿›åˆ¶æ•°ç»„**nums ã€‚\n\nå¦‚æœä¸€ä¸ªå­æ•°ç»„ä¸­ **ä¸å­˜åœ¨** ä¸¤ä¸ª **ç›¸é‚»** å…ƒç´ çš„å€¼ **ç›¸åŒ** çš„æƒ…å†µï¼Œæˆ‘ä»¬ç§°è¿™æ ·çš„å­æ•°ç»„ä¸º **äº¤æ›¿å­æ•°ç»„** ã€‚\n\nè¿”å›æ•°ç»„ nums ä¸­äº¤æ›¿å­æ•°ç»„çš„æ•°é‡ã€‚\n\nç¤ºä¾‹ 1ï¼š\n\nè¾“å…¥ï¼š nums = [0,1,1,1]\n\nè¾“å‡ºï¼š 5\n\nè§£é‡Šï¼š ä»¥ä¸‹å­æ•°ç»„æ˜¯äº¤æ›¿å­æ•°ç»„ï¼š[0] ã€[1] ã€[1] ã€[1] ä»¥åŠ [0,1] ã€‚\n> è¿™é‡Œæœ‰ä¸ªç”¨ä¾‹çœŸçš„å¥½æ¶å¿ƒï¼Œwaä¸‰æ¬¡éƒ½æ˜¯è¿™ä¸€ä¸ªç”¨ä¾‹æ²¡è¿‡ï¼Œéœ€è¦å…¨å¼€longæˆ–è€…long longæ‰èƒ½è¿‡\n## è®°å¿†åŒ–æœç´¢è¶…å‡ºå†…å­˜é™åˆ¶\n> æœ€æ—©çš„æ€è·¯æ˜¯ç”¨ä¸€ä¸ªäºŒç»´æ•°ç»„å­˜dp[i][j]æ˜¯å¦æ˜¯ä¸€ä¸ªäº¤æ›¿å­æ•°ç»„ï¼Œä¸º1è¡¨ç¤ºiåˆ°jæ˜¯ä¸€ä¸ªäº¤æ›¿å­æ•°ç»„ï¼Œåˆ¤æ–­æ¡ä»¶$$ dp[i][j-1] == 1 && nums[j] != nums[j-1] $$\n> \n> å…¶å®å®Œå…¨ä¸ç”¨è¿™ä¹ˆå¤§çš„ç©ºé—´ï¼ŒäºŒç»´æ•°ç»„è¶…ç©ºé—´ä¹Ÿæ˜¯åº”è¯¥çš„\n```java\nclass Solution {\n    public long countAlternatingSubarrays(int[] nums) {\n        //è®°å¿†åŒ–æœç´¢\n        int[][] dp = new int[nums.length][nums.length];\n        for (int i = 0; i < nums.length; i++) {\n            for (int j = i; j < nums.length; j++) {\n                //å¯¹è§’çº¿è‚¯å®šæ˜¯äº¤æ›¿å­æ•°ç»„\n                if (i==j){\n                    dp[i][j] = 1;\n                }\n                else {\n                    //åªæœ‰å‰é¢æ˜¯ä¸€ä¸ªäº¤æ›¿å­æ•°ç»„å¹¶ä¸”ä¸ç­‰äºæœ€åçš„é‚£ä¸ªå…ƒç´ \n                    if (dp[i][j-1] == 1 && nums[j] != nums[j-1]){\n                        dp[i][j] = 1;\n                    }\n                    else {\n                        dp[i][j] = 0;\n                    }\n                }\n            }\n        }\n        //æœ€åå†éå†ä¸€æ¬¡æ•°ç»„ï¼Œæ¯ä¸€ä¸ª1å°±æ˜¯ä¸€ä¸ªäº¤æ›¿å­æ•°ç»„\n        long ans = 0;\n        for (int i = 0; i < nums.length; i++) {\n            for (int j = i; j < nums.length; j++) {\n                if (dp[i][j] == 1){\n                    ans+=1;\n                }\n            }\n        }\n        return ans;\n\n    }\n}\n```\n\n## åŒæŒ‡é’ˆ(AC)\n> æ€è·¯æ˜¯ï¼Œå¦‚æœä¸€ä¸ªæ•°ç»„æ˜¯äº¤æ›¿æ•°ç»„ï¼Œé‚£ä¹ˆå­æ•°ç»„è‚¯å®šä¹Ÿæ˜¯ï¼Œåˆ©ç”¨åŒæŒ‡é’ˆæ‰¾åˆ°å°½é‡æœ€é•¿çš„äº¤æ›¿å­æ•°ç»„å­˜èµ·æ¥ï¼Œæœ€åéå†è¿™äº›æœ€é•¿çš„äº¤æ›¿å­æ•°ç»„ã€‚ç”±äºä»–ä»¬çš„å­æ•°ç»„è‚¯å®šä¹Ÿæ˜¯äº¤æ›¿çš„ï¼Œé‚£å°±æ˜¯ç­‰å·®æ•°åˆ—æ±‚å’Œå°±å¯ä»¥ç®—å‡ºã€‚æœ€åç´¯åŠ å¾—åˆ°ç­”æ¡ˆ\n```java\nclass Solution {\n    public long countAlternatingSubarrays(int[] nums) {\n        //æ¶å¿ƒçš„long\n        List<long[]> list = new ArrayList<>();\n        long head = 0;\n        long rear = 0;\n        //åŒæŒ‡é’ˆæ‰¾åˆ°é•¿çš„æ•°ç»„ï¼Œå­˜èµ·æ¥ä»–ä»¬çš„ä¸‹æ ‡\n        for (int i = 1; i < nums.length; i++) {\n            if (nums[i] == nums[i-1]){\n                list.add(new long[]{head,rear});\n                head = i;\n            }\n            rear++;\n        }\n        //æœ€åä¸€ä¸ªæ²¡åŠ ä¸Šå°±é€€å‡ºå¾ªç¯äº†ï¼Œéœ€è¦æœ€ååŠ ä¸Š\n        list.add(new long[]{head,rear});\n        long ans = 0;\n        for (int i = 0; i < list.size(); i++) {\n            long length = list.get(i)[1]-list.get(i)[0]+1;\n            //å­æ•°ç»„çš„æ•°é‡\n            ans += length *(length+1)/2;\n        }\n        return ans;\n    }\n}\n```\næ—¶é—´å¤æ‚åº¦:o(n)\nç©ºé—´å¤æ‚åº¦ï¼šo(n)","tags":["åˆ·é¢˜ç¬”è®°"]},{"title":"leetcode-2024-3-31","url":"/2024/03/31/leetcode-2024-3-31/","content":"# 331 éªŒè¯äºŒå‰æ ‘çš„å‰åºåºåˆ—åŒ–ï¼ˆMediumï¼‰\n\nåºåˆ—åŒ–äºŒå‰æ ‘çš„ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨ **å‰åºéå†** ã€‚å½“æˆ‘ä»¬é‡åˆ°ä¸€ä¸ªéç©ºèŠ‚ç‚¹æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥è®°å½•ä¸‹è¿™ä¸ªèŠ‚ç‚¹çš„å€¼ã€‚å¦‚æœå®ƒæ˜¯ä¸€ä¸ªç©ºèŠ‚ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€ä¸ªæ ‡è®°å€¼è®°å½•ï¼Œä¾‹å¦‚ #ã€‚\n![](../img/coding/2024_3_31_1.png)\n\nä¾‹å¦‚ï¼Œä¸Šé¢çš„äºŒå‰æ ‘å¯ä»¥è¢«åºåˆ—åŒ–ä¸ºå­—ç¬¦ä¸² \"9,3,4,#,#,1,#,#,2,#,6,#,#\"ï¼Œå…¶ä¸­ # ä»£è¡¨ä¸€ä¸ªç©ºèŠ‚ç‚¹ã€‚\n\nç»™å®šä¸€ä¸²ä»¥é€—å·åˆ†éš”çš„åºåˆ—ï¼ŒéªŒè¯å®ƒæ˜¯å¦æ˜¯æ­£ç¡®çš„äºŒå‰æ ‘çš„å‰åºåºåˆ—åŒ–ã€‚ç¼–å†™ä¸€ä¸ªåœ¨ä¸é‡æ„æ ‘çš„æ¡ä»¶ä¸‹çš„å¯è¡Œç®—æ³•ã€‚\n\nä¿è¯ æ¯ä¸ªä»¥é€—å·åˆ†éš”çš„å­—ç¬¦æˆ–ä¸ºä¸€ä¸ªæ•´æ•°æˆ–ä¸ºä¸€ä¸ªè¡¨ç¤º null æŒ‡é’ˆçš„ '#' ã€‚\n\nä½ å¯ä»¥è®¤ä¸ºè¾“å…¥æ ¼å¼æ€»æ˜¯æœ‰æ•ˆçš„\n\nä¾‹å¦‚å®ƒæ°¸è¿œä¸ä¼šåŒ…å«ä¸¤ä¸ªè¿ç»­çš„é€—å·ï¼Œæ¯”å¦‚ \"1,,3\" ã€‚\n\næ³¨æ„ï¼šä¸å…è®¸é‡å»ºæ ‘ã€‚\n\n## æ ˆ\n> ç”±äºæ˜¯å…ˆåºéå†ï¼Œæˆ‘ä»¬è€ƒè™‘æ ˆã€‚æ ˆçš„å­˜æ”¾ä¸€ä¸ªæ•°ç»„ï¼Œç¬¬ä¸€ä½è¡¨ç¤ºåœ¨splitä¸­çš„ä¸‹æ ‡ï¼Œç¬¬äºŒä½è¡¨ç¤ºå·¦è¾¹æ˜¯å¦æœ‰èŠ‚ç‚¹ï¼Œç¬¬ä¸‰ä½è¡¨ç¤ºå³è¾¹æ˜¯å¦æœ‰èŠ‚ç‚¹\n> \n> éå†è¿™ä¸ªæ•°ç»„ï¼Œç„¶åå¦‚æœæ ˆéç©ºï¼Œå½“å‰å…ƒç´ å°±æ˜¯æ ˆé¡¶å…ƒç´ çš„å·¦å­©å­æˆ–è€…å³å­©å­ï¼Œæ›´æ–°æ ˆé¡¶æ•°ç»„ï¼Œæ¯æ¬¡éå†éƒ½è¦åˆ¤æ–­æ ˆé¡¶å…ƒç´ æ˜¯å¦å·¦å³éƒ½æœ‰ï¼Œå¦‚æœæœ‰å°±å‡ºæ ˆã€‚\n> éå†å®Œçœ‹æ ˆæ˜¯å¦ä¸ºç©ºï¼Œä¸ºç©ºè¯´æ˜æ˜¯äºŒå‰æ ‘\n\n> è¿™é‡Œæœ‰ä¸¤ä¸ªç»†èŠ‚ï¼Œ\n> - é¦–å…ˆæ˜¯å¯èƒ½å‡ºç°å¤šæ£µæ ‘çš„æƒ…å†µï¼Œä¹Ÿå°±æ˜¯è¯´ä»¥ä¸Šç®—æ³•å¯¹äºä¸¤ä¸ªå®Œæ•´çš„æ ‘æ‹¼åœ¨ä¸€èµ·çš„å­—ç¬¦ä¸²ç»“æœè¿˜æ˜¯ä¸ºtrueï¼Œéœ€è¦ä¸€ä¸ªè®¡æ•°å™¨ï¼Œå¦‚æœåœ¨å¾ªç¯è¿‡ç¨‹ä¸­æ ˆå°±å·²ç»ç©ºäº†ï¼Œå°±è¿”å›false\n> - è¿˜æœ‰å°±æ˜¯è¿™é‡Œç”¨äº†trycatchï¼Œå¦‚æœå‡ºç°å¼‚å¸¸æƒ…å†µæ¯”å¦‚æ ˆé¡¶ä¸ºç©ºäº†ï¼Œé‚£è‚¯å®šæ˜¯å‡ºé—®é¢˜äº†ï¼Œç›´æ¥è¿”å›falseï¼Œä¹Ÿç®—æ˜¯ä¸€ç§å·æ‡’å§ã€‚\n```java\npublic boolean isValidSerialization(String preorder) {\n    try {\n        int count = 0;\n        String[] split = preorder.split(\",\");\n        if (split.length == 1 && Objects.equals(split[0], \"#\")){\n            return true;\n        }\n        Stack<int[]> stack = new Stack<>();\n        for (int i = 0; i < split.length; i++) {\n            if (!Objects.equals(split[i], \"#\")){\n                if (!stack.isEmpty()){\n                    if (stack.peek()[1] ==0 && stack.peek()[2] == 0){\n                        stack.peek()[1]  = 1;\n                    }\n                    else if (stack.peek()[1] == 1 && stack.peek()[2] == 0){\n                        stack.peek()[2] = 1;\n                    }\n\n                }\n                stack.add(new int[]{i,0,0});\n            }\n            else {\n                if (stack.peek()[1] == 0 && stack.peek()[2] ==0){\n                    stack.peek()[1]  = 1;\n                }\n                else if (stack.peek()[1] == 1 && stack.peek()[2] == 0){\n                    stack.peek()[2] = 1;\n                }\n            }\n            while (!stack.isEmpty() && stack.peek()[1] == 1 && stack.peek()[2] == 1){\n                stack.pop();\n            }\n            if (stack.isEmpty() && i != split.length-1){\n                count++;\n            }\n        }\n        if (count!=0){\n            return false;\n        }\n        return stack.isEmpty();\n    }\n    catch (Exception e){\n        return false;\n    }\n\n}\n```\næ—¶é—´å¤æ‚åº¦ï¼šO(n)ï¼Œå…¶ä¸­ n ä¸ºå­—ç¬¦ä¸²çš„é•¿åº¦ã€‚æˆ‘ä»¬æ¯ä¸ªå­—ç¬¦åªéå†ä¸€æ¬¡ï¼ŒåŒæ—¶æ¯ä¸ªå­—ç¬¦å¯¹åº”çš„æ“ä½œéƒ½æ˜¯å¸¸æ•°æ—¶é—´çš„ã€‚\n\nç©ºé—´å¤æ‚åº¦ï¼šO(n)ã€‚æ­¤ä¸ºæ ˆæ‰€éœ€è¦ä½¿ç”¨çš„ç©ºé—´ã€‚\n","tags":["åˆ·é¢˜ç¬”è®°"]},{"title":"leetcode-2024-3-30","url":"/2024/03/30/leetcode-2024-3-30/","content":"# 2952 éœ€è¦æ·»åŠ çš„ç¡¬å¸çš„æœ€å°æ•°é‡ï¼ˆMediumï¼‰\n> è¿™é“é¢˜æ­¢ä¸­ç­‰ï¼Ÿ\n> \nç»™ä½ ä¸€ä¸ªä¸‹æ ‡ä» 0 å¼€å§‹çš„æ•´æ•°æ•°ç»„ coinsï¼Œè¡¨ç¤ºå¯ç”¨çš„ç¡¬å¸çš„é¢å€¼ï¼Œä»¥åŠä¸€ä¸ªæ•´æ•° target ã€‚\n\nå¦‚æœå­˜åœ¨æŸä¸ª coins çš„å­åºåˆ—æ€»å’Œä¸º xï¼Œé‚£ä¹ˆæ•´æ•° x å°±æ˜¯ä¸€ä¸ª **å¯å–å¾—çš„é‡‘é¢** ã€‚\n\nè¿”å›éœ€è¦æ·»åŠ åˆ°æ•°ç»„ä¸­çš„ **ä»»æ„é¢å€¼** ç¡¬å¸çš„ æœ€å°æ•°é‡ ï¼Œä½¿èŒƒå›´ $[1, target]$ å†…çš„æ¯ä¸ªæ•´æ•°éƒ½å±äº **å¯å–å¾—çš„é‡‘é¢** ã€‚\n\næ•°ç»„çš„ **å­åºåˆ—** æ˜¯é€šè¿‡åˆ é™¤åŸå§‹æ•°ç»„çš„ä¸€äº›ï¼ˆ**å¯èƒ½ä¸åˆ é™¤**ï¼‰å…ƒç´ è€Œå½¢æˆçš„æ–°çš„ **éç©º** æ•°ç»„ï¼Œåˆ é™¤è¿‡ç¨‹ä¸ä¼šæ”¹å˜å‰©ä½™å…ƒç´ çš„ç›¸å¯¹ä½ç½®ã€‚\n\n\n\nç¤ºä¾‹ 1ï¼š\n\nè¾“å…¥ï¼šcoins = [1,4,10], target = 19\n\nè¾“å‡ºï¼š2\n\nè§£é‡Šï¼šéœ€è¦æ·»åŠ é¢å€¼ä¸º 2 å’Œ 8 çš„ç¡¬å¸å„ä¸€æšï¼Œå¾—åˆ°ç¡¬å¸æ•°ç»„ [1,2,4,8,10] ã€‚\n\nå¯ä»¥è¯æ˜ä» 1 åˆ° 19 çš„æ‰€æœ‰æ•´æ•°éƒ½å¯ç”±æ•°ç»„ä¸­çš„ç¡¬å¸ç»„åˆå¾—åˆ°ï¼Œä¸”éœ€è¦æ·»åŠ åˆ°æ•°ç»„ä¸­çš„ç¡¬å¸æ•°ç›®æœ€å°ä¸º 2 ã€‚\n\n> è‡ªå·±æƒ³æ²¡æƒ³å‡ºæ¥\n## å®˜æ–¹è§£ï¼šè´ªå¿ƒç®—æ³•\n\nä¸ºæ–¹ä¾¿æè¿°ï¼ŒæŠŠ 0ä¹Ÿç®—ä½œå¯ä»¥å¾—åˆ°çš„æ•°ã€‚\n\nå‡è®¾ç°åœ¨å¾—åˆ°äº†åŒºé—´ $[0,sâˆ’1]$ ä¸­çš„æ‰€æœ‰æ•´æ•°ï¼Œå¦‚æœæ­¤æ—¶éå†åˆ°æ•´æ•° $x=coins[i]$ï¼Œé‚£ä¹ˆæŠŠ $[0,sâˆ’1]$ ä¸­çš„æ¯ä¸ªæ•´æ•°éƒ½å¢åŠ  xï¼Œæˆ‘ä»¬å°±å¾—åˆ°äº†åŒºé—´ $[x,s+xâˆ’1]$ ä¸­çš„æ‰€æœ‰æ•´æ•°ã€‚\n\næŠŠ coins ä»å°åˆ°å¤§æ’åºï¼Œéå† $x=coins[i]$ã€‚åˆ†ç±»è®¨è®ºï¼Œçœ‹æ˜¯å¦è¦æ·»åŠ æ•°å­—ï¼š\n- å¦‚æœ xâ‰¤sï¼Œé‚£ä¹ˆåˆå¹¶ $[0,sâˆ’1]$ å’Œ $[x,s+xâˆ’1]$è¿™ä¸¤ä¸ªåŒºé—´ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ° $[0,s+xâˆ’1]$ ä¸­çš„æ‰€æœ‰æ•´æ•°ã€‚\n- å¦‚æœ x>sï¼Œæˆ–è€…éå†å®Œäº† coins æ•°ç»„ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬æ— æ³•å¾—åˆ° sï¼Œé‚£ä¹ˆå°±ä¸€å®šè¦æŠŠ s åŠ åˆ°æ•°ç»„ä¸­ï¼ˆåŠ ä¸€ä¸ªæ¯” s è¿˜å°çš„æ•°å­—å°±æ²¡æ³•å¾—åˆ°æ›´å¤§çš„æ•°ï¼Œä¸å¤Ÿè´ªï¼‰ï¼Œè¿™æ ·å°±å¯ä»¥å¾—åˆ°äº† $[s,2sâˆ’1]$ ä¸­çš„æ‰€æœ‰æ•´æ•°ï¼Œå†ä¸ $[0,sâˆ’1]$ åˆå¹¶ï¼Œå¯ä»¥å¾—åˆ° $[0,2sâˆ’1]$ ä¸­çš„æ‰€æœ‰æ•´æ•°ã€‚ç„¶åå†è€ƒè™‘ x å’Œ 2s çš„å¤§å°å…³ç³»ï¼Œç»§ç»­åˆ†ç±»è®¨è®ºã€‚\nå½“ s>targets æ—¶ï¼Œæˆ‘ä»¬å°±å¾—åˆ°äº† $[1,target]$ ä¸­çš„æ‰€æœ‰æ•´æ•°ï¼Œé€€å‡ºå¾ªç¯ã€‚\n\n```java\nclass Solution {\n    public int minimumAddedCoins(int[] coins, int target) {\n        Arrays.sort(coins);\n        int ans = 0, s = 1, i = 0;\n        while (s <= target) {\n            if (i < coins.length && coins[i] <= s) {\n                s += coins[i++];\n            } else {\n                s *= 2; // å¿…é¡»æ·»åŠ  s\n                ans++;\n            }\n        }\n        return ans;\n    }\n}\n```","tags":["åˆ·é¢˜ç¬”è®°"]},{"title":"leetcode-2024-3-29","url":"/2024/03/29/leetcode-2024-3-29/","content":"> ç»è¿‡ä¸€å¤©çš„å†²ä¸šç»©ç»ˆäºä¸Šäº†200é¢˜ï¼Œè¯´å®è¯æœ‰ç‚¹è¿½æ±‚æ•°é‡ä¸è¿½æ±‚è´¨é‡äº†ã€‚ä½†æ˜¯æˆ‘ç¡®å®ä¹Ÿæ„Ÿè§‰è®°æ€§æ²¡ä»¥å‰é‚£ä¹ˆå¥½äº†ï¼Œèœå°±å¤šç»ƒã€‚\n> \n> ![](../img/coding/2024_3_29_2.png)\n\n# 2908 å…ƒç´ å’Œæœ€å°çš„å±±å½¢ä¸‰å…ƒç»„ï¼ˆEazyï¼‰\n\nç»™ä½ ä¸€ä¸ªä¸‹æ ‡ä» 0 å¼€å§‹çš„æ•´æ•°æ•°ç»„ nums ã€‚\n\nå¦‚æœä¸‹æ ‡ä¸‰å…ƒç»„$ (i, j, k) $æ»¡è¶³ä¸‹è¿°å…¨éƒ¨æ¡ä»¶ï¼Œåˆ™è®¤ä¸ºå®ƒæ˜¯ä¸€ä¸ª **å±±å½¢ä¸‰å…ƒç»„** ï¼š\n\n- $i < j < k$\n- $nums[i] < nums[j]$ ä¸” $nums[k] < nums[j]$\nè¯·ä½ æ‰¾å‡º nums ä¸­ **å…ƒç´ å’Œæœ€å°** çš„å±±å½¢ä¸‰å…ƒç»„ï¼Œå¹¶è¿”å›å…¶ **å…ƒç´ å’Œ** ã€‚å¦‚æœä¸å­˜åœ¨æ»¡è¶³æ¡ä»¶çš„ä¸‰å…ƒç»„ï¼Œè¿”å› -1 ã€‚\n\n\n\nç¤ºä¾‹ 1ï¼š\n\nè¾“å…¥ï¼š$nums = [8,6,1,5,3]$\nè¾“å‡ºï¼š9\nè§£é‡Šï¼šä¸‰å…ƒç»„ (2, 3, 4) æ˜¯ä¸€ä¸ªå…ƒç´ å’Œç­‰äº 9 çš„å±±å½¢ä¸‰å…ƒç»„ï¼Œå› ä¸ºï¼š\n- 2 < 3 < 4\n- $nums[2] < nums[3]$ ä¸” $nums[4] < nums[3]$\n\nè¿™ä¸ªä¸‰å…ƒç»„çš„å…ƒç´ å’Œç­‰äº $nums[2] + nums[3] + nums[4] = 9$ ã€‚å¯ä»¥è¯æ˜ä¸å­˜åœ¨å…ƒç´ å’Œå°äº 9 çš„å±±å½¢ä¸‰å…ƒç»„ã€‚\n\n## æš´åŠ›æšä¸¾ï¼ˆå±…ç„¶æ²¡è¶…æ—¶ï¼‰\n> æ²¡ä»€ä¹ˆå¥½è¯´çš„ç›´æ¥éå†æ‰€æœ‰ä¸‰å…ƒç»„ï¼Œåˆ¤æ–­æ˜¯å¦æ˜¯å±±å½¢\n```java\nclass Solution {\n    public int minimumSum(int[] nums) {\n        int min = Integer.MAX_VALUE;\n        //éå†æ‰€æœ‰ä¸‰å…ƒç»„\n        for (int i = 0; i < nums.length - 2; i++) {\n            for (int j = i+1; j < nums.length-1; j++) {\n                for (int k = j+1; k < nums.length; k++) {\n                    if (nums[i] < nums[j] && nums[j] >nums[k]){\n                        //æ‰¾æœ€å°å€¼\n                        min = Math.min(min,nums[i]+nums[j]+nums[k]);\n                    }\n                }\n            }\n        }\n        if (min == Integer.MAX_VALUE){\n            min = -1;\n        }\n        return min;\n    }\n}\n```\næ—¶é—´å¤æ‚åº¦ï¼šo(n^3)ï¼Œè¿™ä¹ˆé«˜çš„å¤æ‚åº¦æ²¡è¶…æ—¶å°±ç®—äº†ï¼Œå±…ç„¶è¿˜77%ï¼Ÿæœ‰ç‚¹æç¬‘äº†\nç©ºé—´å¤æ‚åº¦ï¼šo(1)ï¼Œåªç”¨äº†ä¸€ä¸ªminæ¥ä¿å­˜æœ€å¤§å€¼\n\n# æœ‰æ•ˆçš„æ‹¬å·ï¼ˆEasyï¼‰\n\n> ä»Šå¤©çš„ä¸»èœæ˜¯å„ç§æ ˆï¼Œå…ˆä»æœ€ç®€å•çš„è¯´èµ·\n\nç»™å®šä¸€ä¸ªåªåŒ…æ‹¬ '('ï¼Œ')'ï¼Œ'{'ï¼Œ'}'ï¼Œ'['ï¼Œ']' çš„å­—ç¬¦ä¸² s ï¼Œåˆ¤æ–­å­—ç¬¦ä¸²æ˜¯å¦æœ‰æ•ˆã€‚\n\næœ‰æ•ˆå­—ç¬¦ä¸²éœ€æ»¡è¶³ï¼š\n\n1. å·¦æ‹¬å·å¿…é¡»ç”¨ç›¸åŒç±»å‹çš„å³æ‹¬å·é—­åˆã€‚\n2. å·¦æ‹¬å·å¿…é¡»ä»¥æ­£ç¡®çš„é¡ºåºé—­åˆã€‚\n3. æ¯ä¸ªå³æ‹¬å·éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„ç›¸åŒç±»å‹çš„å·¦æ‹¬å·ã€‚\n\nç¤ºä¾‹ 1ï¼š\n\nè¾“å…¥ï¼šs = \"()\"\n\nè¾“å‡ºï¼štrue\n\nç¤ºä¾‹ 2ï¼š\n\nè¾“å…¥ï¼šs = \"()[]{}\"\n\nè¾“å‡ºï¼štrue\n\nç¤ºä¾‹ 3ï¼š\n\nè¾“å…¥ï¼šs = \"(]\"\n\nè¾“å‡ºï¼šfalse\n\n## ç®€å•æ ˆ\n> æœ€åŸºç¡€çš„æ‹¬å·åŒ¹é…é—®é¢˜ï¼Œæ‰€æœ‰å·¦è¾¹æ‹¬å·è¿›æ ˆï¼Œå¦‚æœèƒ½å’Œå³è¾¹æ‹¬å·åŒ¹é…å°±å‡ºæ ˆï¼Œåˆ°æœ€åå¦‚æœè¿˜æœ‰æ‹¬å·æ²¡æœ‰åŒ¹é…ä¸Šï¼Œå°±è¿”å›falseï¼Œå¦‚æœä¸ºç©ºå°±æ˜¯true\n```java\nclass Solution {\n    public boolean isValid(String s) {\n        Stack<Character> stack = new Stack<>();\n        //flagç”¨æ¥è¡¨ç¤ºæ ˆé¡¶ä¸æ˜¯åŒ¹é…çš„ï¼Œæ¯”å¦‚â€œ]â€ï¼Œæ ˆé¡¶æ²¡æœ‰å…ƒç´ ï¼Œè¿”å›false\n        boolean flag = true;\n        for (int i = 0; i < s.length(); i++) {\n            char temp = s.charAt(i);\n            if (temp == '}'){\n                //åŒ¹é…å·¦è¾¹æ‹¬å·ï¼Œå‡ºæ ˆ\n                if (!stack.isEmpty()&&stack.peek() == '{'){\n                    stack.pop();\n                }\n                else {\n                    flag = false;\n                }\n            }\n            else if (temp == ')'){\n                //åŒ¹é…å·¦è¾¹æ‹¬å·ï¼Œå‡ºæ ˆ\n                if (!stack.isEmpty()&&stack.peek() == '('){\n                    stack.pop();\n                }\n                else {\n                    flag = false;\n                }\n            }\n            else if (temp == ']'){\n                //åŒ¹é…å·¦è¾¹æ‹¬å·ï¼Œå‡ºæ ˆ\n                if (!stack.isEmpty()&&stack.peek() == '['){\n                    stack.pop();\n                }\n                else {\n                    flag = false;\n                }\n            }\n            //ä¸æ˜¯å³è¾¹æ‹¬å·çš„è¯è¿›æ ˆ\n            else stack.push(temp);\n        }\n        return flag & stack.isEmpty();\n    }\n}\n```\næ—¶é—´å¤æ‚åº¦:o(n)\nç©ºé—´å¤æ‚åº¦:o(n)ï¼Œå› ä¸ºç»´æŠ¤äº†ä¸€ä¸ªæ ˆ\n\n# 394 å­—ç¬¦ä¸²è§£ç ï¼ˆMediumï¼‰\n\nç»™å®šä¸€ä¸ªç»è¿‡ç¼–ç çš„å­—ç¬¦ä¸²ï¼Œè¿”å›å®ƒè§£ç åçš„å­—ç¬¦ä¸²ã€‚\n\nç¼–ç è§„åˆ™ä¸º: $k[encoded_string]$ï¼Œè¡¨ç¤ºå…¶ä¸­æ–¹æ‹¬å·å†…éƒ¨çš„ encoded_string æ­£å¥½é‡å¤ k æ¬¡ã€‚æ³¨æ„ k ä¿è¯ä¸ºæ­£æ•´æ•°ã€‚\n\nä½ å¯ä»¥è®¤ä¸ºè¾“å…¥å­—ç¬¦ä¸²æ€»æ˜¯æœ‰æ•ˆçš„ï¼›è¾“å…¥å­—ç¬¦ä¸²ä¸­æ²¡æœ‰é¢å¤–çš„ç©ºæ ¼ï¼Œä¸”è¾“å…¥çš„æ–¹æ‹¬å·æ€»æ˜¯ç¬¦åˆæ ¼å¼è¦æ±‚çš„ã€‚\n\næ­¤å¤–ï¼Œä½ å¯ä»¥è®¤ä¸ºåŸå§‹æ•°æ®ä¸åŒ…å«æ•°å­—ï¼Œæ‰€æœ‰çš„æ•°å­—åªè¡¨ç¤ºé‡å¤çš„æ¬¡æ•° k ï¼Œä¾‹å¦‚ä¸ä¼šå‡ºç°åƒ 3a æˆ– 2[4] çš„è¾“å…¥ã€‚\n\nç¤ºä¾‹ 1ï¼š\n\nè¾“å…¥ï¼šs = \"3[a]2[bc]\"\n\nè¾“å‡ºï¼š\"aaabcbc\"\n\nç¤ºä¾‹ 2ï¼š\n\nè¾“å…¥ï¼šs = \"3[a2[c]]\"\n\nè¾“å‡ºï¼š\"accaccacc\"\n\n## ç®€å•æ ˆ\n> å…ˆè¿›åå‡ºï¼Œåˆæ˜¯ç”¨æ ˆçš„ç»å…¸é—®é¢˜ï¼Œç»´æŠ¤ä¸¤ä¸ªæ ˆï¼Œä¸€ä¸ªæ”¾æ•°å­—ï¼Œä¸€ä¸ªæ”¾ç¬¦å·ï¼Œè¿™é‡Œè€ƒè™‘åˆ°æ•°å­—ä¹Ÿä¼šåˆå¤šä½æ•°å­—ï¼Œæ‰€ä»¥åœ¨å­—ç¬¦ä¸²ä¸­éœ€è¦ç‰¹æ„è€ƒè™‘å¤šä½æ•°å­—ã€‚\n> å¦ä¸€ä¸ªæ ˆç”¨äºæ”¾å­—ç¬¦ä¸²ï¼Œè¿™é‡Œåˆšå¼€å§‹è€ƒè™‘ç”¨Charçš„æ ˆï¼Œä½†æ˜¯è¿™æ ·å°±ä¼šé¢‘ç¹å‡ºæ ˆå…¥æ ˆï¼Œæ‰€ä»¥è¿˜ä¸å¦‚å°±ç”¨å­—ç¬¦ä¸²ã€‚\n```java\nclass Solution {\n    public String decodeString(String s) {\n        Stack<String> stack = new Stack<>();\n        Stack<Integer> numstack = new Stack<>();\n        //è¿™é‡Œiæ‰‹åŠ¨æ”¹ï¼Œå› ä¸ºæ¶‰åŠåˆ°å¤šä½æ•°å­—çš„é—®é¢˜ï¼Œéœ€è¦æ‹¼æ¥å­—ç¬¦ä¸²\n        for (int i = 0; i < s.length();) {\n            //å¦‚æœæ˜¯æ•°å­—ï¼Œéœ€è¦è€ƒè™‘å¤šä½æ•°å­—çš„æƒ…å†µ\n            if (judgeNumOrChar(s.charAt(i))){\n                StringBuilder num = new StringBuilder();\n                //æ‹¼æ¥å­—ç¬¦ä¸²\n                while (judgeNumOrChar(s.charAt(i))){\n                    num.append(s.charAt(i));\n                    i++;\n                }\n                //æ­¤æ—¶içš„ä½ç½®è‚¯å®šæ˜¯[\n                numstack.push(Integer.parseInt(num.toString()));\n            }\n            else {\n                //å·¦æ‹¬å·ç›´æ¥è¿›\n                if (s.charAt(i) != ']'){\n                    stack.push(\"\"+s.charAt(i));\n                }\n                else {\n                    StringBuilder temp = new StringBuilder();\n                    //å½“å‰çš„æ•°å­—å‡ºæ ˆ\n                    int count = numstack.pop();\n                    //å­—ç¬¦ä¸²æ‹¼æ¥åŠ åœ¨å·¦è¾¹ï¼Œå› ä¸ºå…ˆè¿›åå‡º\n                    while (!Objects.equals(stack.peek(), \"[\")){\n                        temp.insert(0, stack.pop());\n                        //System.out.println(stack);\n                    }\n                    //æœ€åä¸€ä¸ªå·¦æ‹¬å·å‡ºæ ˆ\n                    stack.pop();\n                    //æ¥ä¸‹æ¥å°±æ˜¯å¾ªç¯countæ¬¡ï¼Œå­—ç¬¦ä¸²å…¥æ ˆï¼Œè¿™é‡Œå…¶å®ä¹Ÿå¯ä»¥æ‹¼æ¥å¥½äº†å†æ”¾ä¸€ä¸ªä½ç½®ï¼Œæˆ‘æ€•ä¼šæœ‰é—®é¢˜å°±æ²¡è¿™ä¹ˆåš\n                    for (int j = 0; j < count; j++) {\n                        stack.push(temp.toString());\n                    }\n\n                }\n                i++;\n\n            }\n            //System.out.println(stack);\n            //System.out.println(numstack);\n\n        }\n        StringBuilder ans = new StringBuilder();\n        while (!stack.isEmpty()){\n            ans.insert(0, stack.pop());\n        }\n        return ans.toString();\n    }\n    //åˆ¤æ–­æ˜¯å¦ä¸ºæ•°å­—\n    public boolean judgeNumOrChar(Character character){\n        return (character < 'a' || character > 'z') && character != '[' && character != ']';\n    }\n}\n```\næ—¶é—´å¤æ‚åº¦o(n)\nç©ºé—´å¤æ‚åº¦ï¼Œå°±æ˜¯è§£ç å‡ºçš„å­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œè¿™ä¸ªæ²¡åŠæ³•è·Ÿnæœ‰å…³\n\n# 739 æ¯æ—¥æ¸©åº¦ï¼ˆMediumï¼‰\nç»™å®šä¸€ä¸ªæ•´æ•°æ•°ç»„ temperatures ï¼Œè¡¨ç¤ºæ¯å¤©çš„æ¸©åº¦ï¼Œè¿”å›ä¸€ä¸ªæ•°ç»„ answer ï¼Œå…¶ä¸­ answer[i] æ˜¯æŒ‡å¯¹äºç¬¬ i å¤©ï¼Œä¸‹ä¸€ä¸ªæ›´é«˜æ¸©åº¦å‡ºç°åœ¨å‡ å¤©åã€‚å¦‚æœæ°”æ¸©åœ¨è¿™ä¹‹åéƒ½ä¸ä¼šå‡é«˜ï¼Œè¯·åœ¨è¯¥ä½ç½®ç”¨ 0 æ¥ä»£æ›¿ã€‚\n\nç¤ºä¾‹ 1:\n\nè¾“å…¥: temperatures = [73,74,75,71,69,72,76,73]\n\nè¾“å‡º: [1,1,4,2,1,1,0,0]\n\n## å•è°ƒæ ˆ\n> ç»´æŠ¤ä¸€ä¸ªå­˜å‚¨ä¸‹æ ‡çš„å•è°ƒé€’å‡æ ˆï¼Œå½“è¦è¿›å…¥çš„å…ƒç´ æ¯”æ ˆé¡¶å…ƒç´ å¤§çš„æ—¶å€™ï¼Œå¼¹å‡ºæ ˆé¡¶ï¼Œé‚£ä¹ˆæ ˆé¡¶å¯¹åº”çš„ä»Šæ—¥æœ€é«˜æ¸©åº¦å°±æ˜¯å½“å‰è¿™ä¸ªï¼Œæ•°ç»„ä¸­æ”¾è¿›ä¸¤è€…çš„æ—¥æœŸå·®å€¼ï¼Œä»¥æ­¤å¾ªç¯ã€‚ç›´åˆ°è¿›å…¥å…ƒç´ æ¯”æ ˆé¡¶å°\n```java\nclass Solution {\n    public int[] dailyTemperatures(int[] temperatures) {\n        //int[]ï¼Œ0è¡¨ç¤ºå½“å‰å…ƒç´ ï¼Œ1è¡¨ç¤ºä¸‹æ ‡\n        //å…¶å®å¯ä»¥å®Œå…¨å­˜ä¸‹æ ‡çš„ï¼Œè¿™é‡Œæµªè´¹ç©ºé—´äº†\n        Stack<int[]> monoStack = new Stack<>();\n        int[] ans = new int[temperatures.length];\n        for (int i = 0; i < temperatures.length; i++) {\n            //è¿›å…¥å…ƒç´ æ¯”æ ˆé¡¶å¤§ï¼Œç›´åˆ°æ¯”æ ˆé¡¶å°\n            while (!monoStack.isEmpty() && monoStack.peek()[0] < temperatures[i]){\n                int[] latest = monoStack.pop();\n                //è®¡ç®—å½“å‰å…ƒç´ å’Œå‡ºæ ˆçš„å·®å€¼ï¼Œæ”¾åœ¨å‡ºæ ˆçš„é‚£ä¸ªå…ƒç´ çš„ä¸‹æ ‡ä½ç½®\n                ans[latest[1]] = i-latest[1];\n            }\n            monoStack.push(new int[]{temperatures[i],i});\n        }\n        //æœ€åå¦‚æœç•™ä¸‹å‡ ä¸ªé€’å‡çš„å…ƒç´ ï¼Œé‚£ä¹ˆè¡¨ç¤ºåç»­æ²¡æœ‰æ›´é«˜æ¸©åº¦ï¼Œå°±å…¨éƒ¨ä¸º0\n        while (!monoStack.isEmpty()){\n            int[] latest = monoStack.pop();\n            ans[latest[1]] = 0;\n        }\n        return ans;\n    }\n}\n```\næ—¶é—´å¤æ‚åº¦o(n)\nç©ºé—´å¤æ‚åº¦o(n)\n> æ¥ä¸‹æ¥æ˜¯ä¸¤ä¸ªå•è°ƒæ ˆéš¾é¢˜\n# 84 æŸ±çŠ¶å›¾ä¸­æœ€å¤§çš„çŸ©å½¢ï¼ˆHardï¼‰\n\nç»™å®š n ä¸ªéè´Ÿæ•´æ•°ï¼Œç”¨æ¥è¡¨ç¤ºæŸ±çŠ¶å›¾ä¸­å„ä¸ªæŸ±å­çš„é«˜åº¦ã€‚æ¯ä¸ªæŸ±å­å½¼æ­¤ç›¸é‚»ï¼Œä¸”å®½åº¦ä¸º 1 ã€‚\n\næ±‚åœ¨è¯¥æŸ±çŠ¶å›¾ä¸­ï¼Œèƒ½å¤Ÿå‹¾å‹’å‡ºæ¥çš„çŸ©å½¢çš„æœ€å¤§é¢ç§¯ã€‚\n\n![](../img/coding/2024_3_29_3.png)\n\n## å•è°ƒæ ˆ\n\n> å‡è®¾å½“å‰å…ƒç´ nums[i]ï¼Œæˆ‘åªè¦æ‰¾åˆ°åœ¨ä»–å·¦è¾¹ç¬¬ä¸€ä¸ªæ¯”å½“å‰å…ƒç´ å°ï¼Œå’Œå³è¾¹ç¬¬ä¸€ä¸ªæ¯”å½“å‰å…ƒç´ å°çš„ï¼Œé‚£ä¹ˆä»–ä»¬å›´æˆçš„çŸ©å½¢çš„é«˜åº¦å°±æ˜¯nums[i]ï¼Œé•¿åº¦å°±æ˜¯å³è¾¹-å·¦è¾¹-1ï¼ˆå› ä¸ºå®é™…ä¸Šä¸èƒ½åˆ°æ¯”å®ƒå°çš„ä½ç½®ï¼‰ï¼Œ\n> \n> è¿™æ ·é—®é¢˜å°±ç®€åŒ–äº†ï¼Œæœ‰äº†å·¦è¾¹å³è¾¹è¿™äº›å…ƒç´ ï¼Œåªéœ€è¦éå†ä¸€æ¬¡ï¼Œè®¡ç®—ï¼ˆå³è¾¹-å·¦è¾¹-1ï¼‰*å½“å‰å…ƒç´ ï¼Œæ‰¾åˆ°æœ€å¤§å€¼å°±æ˜¯ç­”æ¡ˆã€‚\n> \n> é‚£ä¹ˆæ€ä¹ˆæ ·æ‰¾åˆ°è¿™äº›ç¬¬ä¸€ä¸ªæ¯”å®ƒå°çš„å…ƒç´ å‘¢ï¼Œç”¨**å•è°ƒæ ˆ**\n> \n> å¯¹äºå·¦è¾¹æ¥è¯´ï¼Œç»´æŠ¤ä¸€ä¸ªå•è°ƒé€’å¢çš„æ ˆï¼Œé‚£ä¹ˆæ¯ä¸€ä¸ªæ¯”æ ˆé¡¶è¿›å»å¤§çš„å…ƒç´ ï¼Œæœ€å·¦è¾¹ç¬¬ä¸€ä¸ªæ¯”å®ƒå°çš„å…ƒç´ è‚¯å®šæ˜¯æ ˆé¡¶çš„ã€‚å¦‚æœè¿›å…¥å…ƒç´ æ¯”æ ˆé¡¶å°ï¼Œé‚£å°±ä¸€ç›´å‡ºæ ˆï¼Œç›´åˆ°è¿›å…¥å…ƒç´ æ¯”æ ˆé¡¶å¤§ï¼Œè¿™ä¸ªæ—¶å€™å‡ºæ ˆçš„å…ƒç´ è‚¯å®šéƒ½æ˜¯å¤§äºå½“å‰å…ƒç´ çš„ï¼Œ\n> ä¹Ÿå°±æ˜¯ä¸æ˜¯æœ€å·¦è¾¹æ¯”å®ƒå°çš„å…ƒç´ ï¼Œæ­¤æ—¶æ ˆé¡¶çš„æ‰æ¯”å®ƒå°ï¼Œè¿™å°±ç®—å‡ºäº†æœ€å·¦è¾¹æ¯”å®ƒå°çš„å…ƒç´ ä½ç½®ï¼Œä½†æ˜¯å¦‚æœæ­¤æ—¶æ ˆç©ºäº†ï¼Œè¯´æ˜å·¦è¾¹çš„å…¨æ¯”è‡ªå·±å¤§ï¼Œé‚£å°±è¿”å›-1.\n> \n> å³è¾¹çš„åŒç†ï¼Œåªä¸è¿‡æ ˆç©ºå¯¹åº”çš„æ˜¯nums.length\n```java\nclass Solution {\n    public int largestRectangleArea(int[] nums) {\n        Stack<Integer> stack = new Stack<>();\n        //ä¿å­˜æœ€å·¦è¾¹çš„æ¯”å½“å‰å…ƒç´ å°çš„ä¸‹æ ‡\n        int[] left = new int[nums.length];\n        //ä¿å­˜æœ€å³è¾¹çš„æ¯”å½“å‰å…ƒç´ å°çš„ä¸‹æ ‡\n        int[] right = new int[nums.length];\n        for (int i = 0; i < nums.length; i++) {\n            //å•è°ƒæ ˆçš„ä¸‹ä¸€ä¸ªè‚¯å®šæ˜¯æ¯”å½“å‰å…ƒç´ å°çš„ï¼Œä¹Ÿè‚¯å®šæ˜¯æœ€å·¦è¾¹çš„\n            while (!stack.isEmpty() && nums[stack.peek()] >= nums[i]){\n                stack.pop();\n            }\n            if (stack.isEmpty()){\n                left[i] = -1;\n            }\n            else {\n                left[i] = stack.peek();\n            }\n            stack.push(i);\n            //System.out.println(stack);\n        }\n        stack = new Stack<>();\n        for (int i = nums.length-1; i >= 0; i--) {\n            while (!stack.isEmpty() && nums[stack.peek()] >= nums[i]){\n                stack.pop();\n            }\n            if (stack.isEmpty()){\n                right[i] = nums.length;\n            }\n            else {\n                right[i] = stack.peek();\n            }\n            stack.push(i);\n        }\n        //System.out.println(Arrays.toString(left));\n        //System.out.println(Arrays.toString(right));\n        int max = Integer.MIN_VALUE;\n        for (int i = 0; i < nums.length; i++) {\n            //è®¡ç®—å®½åº¦\n            max = Math.max(max,(right[i]-left[i]-1)*nums[i]);\n        }\n        return max;\n    }\n}\n```\n> å¾ˆé‡è¦è¿™ä¸ªé¢˜ï¼Œè¿™ç§æ€æƒ³å·²ç»ä¸æ˜¯ç¬¬ä¸€æ¬¡è§åˆ°äº†ï¼Œåˆ†åˆ«æŒ‰ç…§å·¦è¾¹å³è¾¹ä¸¤ä¸ªæ•°ç»„ï¼Œéå†ä¸‰æ¬¡\n\næ—¶é—´å¤æ‚åº¦ï¼šo(n)\nç©ºé—´å¤æ‚åº¦ï¼šo(n)\n\n# æ¥é›¨æ°´ï¼ˆHardï¼‰\n\nç»™å®š n ä¸ªéè´Ÿæ•´æ•°è¡¨ç¤ºæ¯ä¸ªå®½åº¦ä¸º 1 çš„æŸ±å­çš„é«˜åº¦å›¾ï¼Œè®¡ç®—æŒ‰æ­¤æ’åˆ—çš„æŸ±å­ï¼Œä¸‹é›¨ä¹‹åèƒ½æ¥å¤šå°‘é›¨æ°´ã€‚\n\n![](../img/coding/2024_3_29_4.png)\n\n## åŠ¨æ€è§„åˆ’\n>å…¶å®ä¹Ÿç”¨äº†ä¸Šä¸€é¢˜çš„æ€æƒ³\n\nå¯¹äºä¸‹æ ‡ iï¼Œä¸‹é›¨åæ°´èƒ½åˆ°è¾¾çš„æœ€å¤§é«˜åº¦ç­‰äºä¸‹æ ‡ i ä¸¤è¾¹çš„æœ€å¤§é«˜åº¦çš„æœ€å°å€¼ï¼Œä¸‹æ ‡ i å¤„èƒ½æ¥çš„é›¨æ°´é‡ç­‰äºä¸‹æ ‡ i å¤„çš„æ°´èƒ½åˆ°è¾¾çš„æœ€å¤§é«˜åº¦å‡å» height[i]ã€‚\n\næœ´ç´ çš„åšæ³•æ˜¯å¯¹äºæ•°ç»„ height ä¸­çš„æ¯ä¸ªå…ƒç´ ï¼Œåˆ†åˆ«å‘å·¦å’Œå‘å³æ‰«æå¹¶è®°å½•å·¦è¾¹å’Œå³è¾¹çš„æœ€å¤§é«˜åº¦ï¼Œç„¶åè®¡ç®—æ¯ä¸ªä¸‹æ ‡ä½ç½®èƒ½æ¥çš„é›¨æ°´é‡ã€‚å‡è®¾æ•°ç»„ height çš„é•¿åº¦ä¸º nï¼Œè¯¥åšæ³•éœ€è¦å¯¹æ¯ä¸ªä¸‹æ ‡ä½ç½®ä½¿ç”¨ O(n) çš„æ—¶é—´å‘ä¸¤è¾¹æ‰«æå¹¶å¾—åˆ°æœ€å¤§é«˜åº¦ï¼Œå› æ­¤æ€»æ—¶é—´å¤æ‚åº¦æ˜¯ O(n^2)\n\nä¸Šè¿°åšæ³•çš„æ—¶é—´å¤æ‚åº¦è¾ƒé«˜æ˜¯å› ä¸ºéœ€è¦å¯¹æ¯ä¸ªä¸‹æ ‡ä½ç½®éƒ½å‘ä¸¤è¾¹æ‰«æã€‚å¦‚æœå·²ç»çŸ¥é“æ¯ä¸ªä½ç½®ä¸¤è¾¹çš„æœ€å¤§é«˜åº¦ï¼Œåˆ™å¯ä»¥åœ¨ O(n)çš„æ—¶é—´å†…å¾—åˆ°èƒ½æ¥çš„é›¨æ°´æ€»é‡ã€‚ä½¿ç”¨åŠ¨æ€è§„åˆ’çš„æ–¹æ³•ï¼Œå¯ä»¥åœ¨ O(n) çš„æ—¶é—´å†…é¢„å¤„ç†å¾—åˆ°æ¯ä¸ªä½ç½®ä¸¤è¾¹çš„æœ€å¤§é«˜åº¦ã€‚\n\nåˆ›å»ºä¸¤ä¸ªé•¿åº¦ä¸º n çš„æ•°ç»„ leftMax å’Œ rightMaxã€‚å¯¹äº 0â‰¤i<n0 ï¼ŒleftMax[i] è¡¨ç¤ºä¸‹æ ‡ i åŠå…¶å·¦è¾¹çš„ä½ç½®ä¸­ï¼Œheight çš„æœ€å¤§é«˜åº¦ï¼ŒrightMax[i] è¡¨ç¤ºä¸‹æ ‡ i åŠå…¶å³è¾¹çš„ä½ç½®ä¸­ï¼Œheight çš„æœ€å¤§é«˜åº¦ã€‚\n\næ˜¾ç„¶ï¼Œ$leftMax[0]=height[0]$ï¼Œ$rightMax[nâˆ’1]=height[nâˆ’1]$ã€‚ä¸¤ä¸ªæ•°ç»„çš„å…¶ä½™å…ƒç´ çš„è®¡ç®—å¦‚ä¸‹ï¼š\n\n- å½“ $1â‰¤iâ‰¤nâˆ’1$ æ—¶ï¼Œ$leftMax[i]=max(leftMax[iâˆ’1],height[i])$ï¼›\n- å½“ $0â‰¤iâ‰¤nâˆ’2$ æ—¶ï¼Œ$rightMax[i]=max(rightMax[i+1],height[i])$ã€‚\n\nå› æ­¤å¯ä»¥æ­£å‘éå†æ•°ç»„ height å¾—åˆ°æ•°ç»„ leftMax çš„æ¯ä¸ªå…ƒç´ å€¼ï¼Œåå‘éå†æ•°ç»„ height å¾—åˆ°æ•°ç»„ rightMax çš„æ¯ä¸ªå…ƒç´ å€¼ã€‚\n\nåœ¨å¾—åˆ°æ•°ç»„ leftMax å’Œ rightMax çš„æ¯ä¸ªå…ƒç´ å€¼ä¹‹åï¼Œå¯¹äº 0â‰¤i<nï¼Œä¸‹æ ‡ i å¤„èƒ½æ¥çš„é›¨æ°´é‡ç­‰äº $min(leftMax[i],rightMax[i])âˆ’height[i]$ã€‚éå†æ¯ä¸ªä¸‹æ ‡ä½ç½®å³å¯å¾—åˆ°èƒ½æ¥çš„é›¨æ°´æ€»é‡ã€‚\n\n![](../img/coding/2024_3_29_5.png)\n\n```java\nclass Solution {\n    public int trap(int[] height) {\n        int[] left = new int[height.length];\n        left[0] = height[0];\n        int[] right = new int[height.length];\n        right[height.length-1] = height[height.length-1];\n        for (int i = 1; i < height.length; i++) {\n            left[i] = Math.max(left[i-1],height[i]);\n        }\n        for (int i = height.length-2; i >=0 ; i--) {\n            right[i] = Math.max(right[i+1],height[i]);\n        }\n        int ans = 0;\n        for (int i = 0; i < height.length; i++) {\n            ans += Math.min(left[i],right[i])-height[i];\n        }\n        return ans;\n    }\n}\n```\n\n## å•è°ƒæ ˆ\n> è¿™ä¸ªæŒºéš¾ç†è§£çš„\n\né™¤äº†è®¡ç®—å¹¶å­˜å‚¨æ¯ä¸ªä½ç½®ä¸¤è¾¹çš„æœ€å¤§é«˜åº¦ä»¥å¤–ï¼Œä¹Ÿå¯ä»¥ç”¨å•è°ƒæ ˆè®¡ç®—èƒ½æ¥çš„é›¨æ°´æ€»é‡ã€‚\n\nç»´æŠ¤ä¸€ä¸ªå•è°ƒæ ˆï¼Œå•è°ƒæ ˆå­˜å‚¨çš„æ˜¯ä¸‹æ ‡ï¼Œæ»¡è¶³ä»æ ˆåº•åˆ°æ ˆé¡¶çš„ä¸‹æ ‡å¯¹åº”çš„æ•°ç»„ height ä¸­çš„å…ƒç´ é€’å‡ã€‚\n\nä»å·¦åˆ°å³éå†æ•°ç»„ï¼Œéå†åˆ°ä¸‹æ ‡ i æ—¶ï¼Œå¦‚æœæ ˆå†…è‡³å°‘æœ‰ä¸¤ä¸ªå…ƒç´ ï¼Œè®°æ ˆé¡¶å…ƒç´ ä¸º topï¼Œtop çš„ä¸‹é¢ä¸€ä¸ªå…ƒç´ æ˜¯ leftï¼Œåˆ™ä¸€å®šæœ‰ $height[left]â‰¥height[top]$ã€‚å¦‚æœ $height[i]>height[top]$ï¼Œåˆ™å¾—åˆ°ä¸€ä¸ªå¯ä»¥æ¥é›¨æ°´çš„åŒºåŸŸï¼Œè¯¥åŒºåŸŸçš„å®½åº¦æ˜¯ $iâˆ’leftâˆ’1$ï¼Œé«˜åº¦æ˜¯ $min(height[left],height[i])âˆ’height[top]$ï¼Œæ ¹æ®å®½åº¦å’Œé«˜åº¦å³å¯è®¡ç®—å¾—åˆ°è¯¥åŒºåŸŸèƒ½æ¥çš„é›¨æ°´é‡ã€‚\n\nä¸ºäº†å¾—åˆ° leftï¼Œéœ€è¦å°† top å‡ºæ ˆã€‚åœ¨å¯¹ top è®¡ç®—èƒ½æ¥çš„é›¨æ°´é‡ä¹‹åï¼Œleft å˜æˆæ–°çš„ topï¼Œé‡å¤ä¸Šè¿°æ“ä½œï¼Œç›´åˆ°æ ˆå˜ä¸ºç©ºï¼Œæˆ–è€…æ ˆé¡¶ä¸‹æ ‡å¯¹åº”çš„ height ä¸­çš„å…ƒç´ å¤§äºæˆ–ç­‰äº height[i]ã€‚\n\nåœ¨å¯¹ä¸‹æ ‡ i å¤„è®¡ç®—èƒ½æ¥çš„é›¨æ°´é‡ä¹‹åï¼Œå°† i å…¥æ ˆï¼Œç»§ç»­éå†åé¢çš„ä¸‹æ ‡ï¼Œè®¡ç®—èƒ½æ¥çš„é›¨æ°´é‡ã€‚éå†ç»“æŸä¹‹åå³å¯å¾—åˆ°èƒ½æ¥çš„é›¨æ°´æ€»é‡ã€‚\n\n```java\nclass Solution {\n    public int trap(int[] height) {\n        Stack<Integer> stack = new Stack<>();\n        int ans = 0;\n        for (int i = 0; i < height.length; i++) {\n            while (!stack.isEmpty() && height[i] > height[stack.peek()]) {\n                int top = stack.pop();\n                if (stack.isEmpty()) {\n                    break;\n                }\n                int left = stack.peek();\n                int currWidth = i - left - 1;\n                int currHeight = Math.min(height[left], height[i]) - height[top];\n                ans += currWidth * currHeight;\n            }\n\n            stack.push(i);\n        }\n        return ans;\n    }\n}\n```","tags":["åˆ·é¢˜ç¬”è®°"]},{"title":"leetcode-2024-3-28","url":"/2024/03/28/leetcode-2024-3-28/","content":"> ä»Šå¤©æ–—èƒ†è¯•äº†ä¸€ä¸‹è“æ¡¥æ¯çš„é¢˜ï¼Œå®åœ¨æ˜¯æ„Ÿè§‰å¤ªéš¾äº†ï¼Œä¸æš´åŠ›æ ¹æœ¬ä¸ä¼šåšï¼Œä»¥åæœ‰æœºä¼šå†å†™é¢˜è§£å§ã€‚\n> \n> æˆ‘è§‰å¾—è¿™ç§ç¨‹åºè®¾è®¡ç«èµ›è¿˜æ˜¯å¾—å¥½å¥½ç ”ç©¶ç®—æ³•æ‰è¡Œï¼Œæˆ‘è¿™ç§é‡è·¯å­è¿˜æœ‰å¾ˆé•¿ä¸€æ®µè·¯è¦èµ°\n# 1997 è®¿é—®å®Œæ‰€æœ‰æˆ¿é—´çš„ç¬¬ä¸€å¤©ï¼ˆMediumï¼‰\nä½ éœ€è¦è®¿é—® n ä¸ªæˆ¿é—´ï¼Œæˆ¿é—´ä» 0 åˆ° n - 1 ç¼–å·ã€‚åŒæ—¶ï¼Œæ¯ä¸€å¤©éƒ½æœ‰ä¸€ä¸ªæ—¥æœŸç¼–å·ï¼Œä» 0 å¼€å§‹ï¼Œä¾å¤©æ•°é€’å¢ã€‚ä½ æ¯å¤©éƒ½ä¼šè®¿é—®ä¸€ä¸ªæˆ¿é—´ã€‚\n\næœ€å¼€å§‹çš„ç¬¬ 0 å¤©ï¼Œä½ è®¿é—® 0 å·æˆ¿é—´ã€‚ç»™ä½ ä¸€ä¸ªé•¿åº¦ä¸º n ä¸” ä¸‹æ ‡ä» 0 å¼€å§‹ çš„æ•°ç»„ nextVisit ã€‚åœ¨æ¥ä¸‹æ¥çš„å‡ å¤©ä¸­ï¼Œä½ è®¿é—®æˆ¿é—´çš„ æ¬¡åº å°†æ ¹æ®ä¸‹é¢çš„ è§„åˆ™ å†³å®šï¼š\n\n- å‡è®¾æŸä¸€å¤©ï¼Œä½ è®¿é—® i å·æˆ¿é—´ã€‚\n- å¦‚æœç®—ä¸Šæœ¬æ¬¡è®¿é—®ï¼Œè®¿é—® i å·æˆ¿é—´çš„æ¬¡æ•°ä¸º å¥‡æ•° ï¼Œé‚£ä¹ˆ ç¬¬äºŒå¤© éœ€è¦è®¿é—® nextVisit[i] æ‰€æŒ‡å®šçš„æˆ¿é—´ï¼Œå…¶ä¸­ 0 <= nextVisit[i] <= i ã€‚\n- å¦‚æœç®—ä¸Šæœ¬æ¬¡è®¿é—®ï¼Œè®¿é—® i å·æˆ¿é—´çš„æ¬¡æ•°ä¸º å¶æ•° ï¼Œé‚£ä¹ˆ ç¬¬äºŒå¤© éœ€è¦è®¿é—® (i + 1) mod n å·æˆ¿é—´ã€‚\n\nè¯·è¿”å›ä½ è®¿é—®å®Œæ‰€æœ‰æˆ¿é—´çš„ç¬¬ä¸€å¤©çš„æ—¥æœŸç¼–å·ã€‚é¢˜ç›®æ•°æ®ä¿è¯æ€»æ˜¯å­˜åœ¨è¿™æ ·çš„ä¸€å¤©ã€‚ç”±äºç­”æ¡ˆå¯èƒ½å¾ˆå¤§ï¼Œè¿”å›å¯¹ 109 + 7 å–ä½™åçš„ç»“æœ\n## æš´åŠ›è¶…æ—¶ï¼šç®€é™‹çš„åŠ¨æ€è§„åˆ’\n> è™½ç„¶è¶…æ—¶äº†ä½†æ˜¯æ€è·¯è·Ÿç­”æ¡ˆæ˜¯ä¸€æ ·çš„ã€‚\n>\n> åˆ†æé¢˜æ„å‘ç° nextVisited[i]çš„èŒƒå›´å±äº [0,i]ï¼Œæ„å‘³ç€å½“ä½ é¦–æ¬¡åˆ°è¾¾æˆ¿é—´ i æ—¶ä¼šå›é€€åˆ°æˆ¿é—´ nextVisited[i]ã€‚è€Œåªæœ‰è®¿é—®è¿‡è¯¥æˆ¿é—´å¶æ•°æ¬¡æ—¶æ‰ä¼šåˆ°è¾¾ä¸‹ä¸€ä¸ªæˆ¿é—´ï¼Œè¿›è€Œæ¨æ–­å‡ºåˆ°è¾¾ i æ—¶ï¼Œ[0,i)çš„æˆ¿é—´å·²ç»è¢«è®¿é—®è¿‡å¶æ•°æ¬¡ã€‚\n\n>å®šä¹‰ f[i] è¡¨ç¤ºä»å¥‡æ•°æ¬¡åˆ°æˆ¿é—´ iï¼Œåˆ°å¥‡æ•°æ¬¡åˆ°è¾¾æˆ¿é—´ i+1 æ‰€éœ€è¦çš„å¤©æ•°ã€‚ä»¥ä¸‹ç”¨ to ä»£è¡¨ nextVisited[i]ï¼Œå›é€€åˆ°æˆ¿é—´ to æ—¶æ˜¯å¥‡æ•°æ¬¡è®¿é—®ï¼Œåˆéœ€è¦èŠ±è´¹ f[to] æ‰ä¼šåˆ°è¾¾æˆ¿é—´ to+1ã€‚ä» iii è®¿é—® to å’Œ i+1 åˆåˆ†åˆ«éœ€è¦èŠ±è´¹ä¸€å¤©ï¼Œæ‰€ä»¥æœ‰è½¬ç§»æ–¹ç¨‹:\n\n$$\nf[i] = \\sum\\limits_{j=to}^{i-1}f[j]+2\n$$\n![](../img/coding/2024_3_28_1.PNG)\n```java\nclass Solution {\n    public int firstDayBeenInAllRooms(int[] nextVisit) {\n        int[] dp = new int[nextVisit.length];\n        int MOD = 1000000007;\n        for (int i = 0; i < nextVisit.length; i++) {\n            //ç¬¬ä¸€æ¬¡è¿›æ¥ç„¶åå»nextVisited[i]ï¼Œç¬¬äºŒæ¬¡å›æ¥æ‰å˜æˆå¶æ•°\n            int temp = 2;\n            //è®¿é—®åˆ°nextVisited[i]ï¼ŒæŠŠä¹‹åæ‰€æœ‰çš„éƒ½ä¼šå†è®¿é—®ä¸€éï¼Œå…¨éƒ¨éƒ½åŠ èµ·æ¥\n            for (int j = nextVisit[i]; j < i; j++) {\n                temp = (dp[j]+temp)%MOD;\n            }\n            dp[i] = temp;\n        }\n        int ans = 0;\n        //dpå­˜æ”¾çš„åªæ˜¯è¿™ä¸ªèŠ‚ç‚¹çš„æ¬¡æ•°ï¼Œè¦æ€»ä½“çš„è¿˜è¦å…¨éƒ¨åŠ èµ·æ¥\n        for (int i = 0; i < nextVisit.length-1; i++) {\n            ans=(dp[i]+ans)%MOD;\n        }\n        return ans;\n    }\n\n}\n```\næ—¶é—´å¤æ‚åº¦o(n^2)ï¼Œé‚£è‚¯å®šæš´åŠ›è¶…æ—¶\n## ä¼˜åŒ–ç‰ˆï¼šå‰ç¼€å’Œ\nå®šä¹‰å‰ç¼€å’Œ\n$$\ns[0]=0,s[i+1] = \\sum\\limits_{j=0}^{i}f[i]\n$$\n\nå¯¹äº\n$$\nf[i] = \\sum\\limits_{j=to}^{i-1}f[j]+2\n$$\nå¯ä»¥åŒ–ç®€ä¸º\n$$\nf[i] = 2+s[i]-s[j]\n$$\nå¯¹äºå‰ç¼€å’Œ sï¼Œæœ‰å¦‚ä¸‹é€’æ¨å¼\n$$\ns[i+1] = 2*s[i]-s[j]+2\n$$\nè¿™æ ·æˆ‘ä»¬å°±ä¸ç”¨è®¡ç®—åŸå…ˆçš„dpæ•°ç»„ï¼Œé€šè¿‡å‰ç¼€å’Œå°±å¾—åˆ°ç­”æ¡ˆã€‚\n\n```java\nclass Solution {\n    public int firstDayBeenInAllRooms(int[] nextVisit) {\n        final long MOD = 1_000_000_007;\n        int n = nextVisit.length;\n        long[] s = new long[n];\n        for (int i = 0; i < n - 1; i++) {\n            int j = nextVisit[i];\n            s[i + 1] = (s[i] * 2 - s[j] + 2 + MOD) % MOD; // + MOD é¿å…ç®—å‡ºè´Ÿæ•°\n        }\n        return (int) s[n - 1];\n    }\n}\n```\n\n# 221 æœ€å¤§æ­£æ–¹å½¢ï¼ˆMediumï¼‰\n\nåœ¨ä¸€ä¸ªç”± '0' å’Œ '1' ç»„æˆçš„äºŒç»´çŸ©é˜µå†…ï¼Œæ‰¾åˆ°åªåŒ…å« '1' çš„æœ€å¤§æ­£æ–¹å½¢ï¼Œå¹¶è¿”å›å…¶é¢ç§¯ã€‚\n![](../img/coding/2024_3_28_3.png)\n> ç”±äºæ˜¯åœ¨ä¸Šè¯¾çš„æ—¶å€™çœ‹çš„ï¼Œæ²¡æœ‰è‡ªå·±åŠ¨æ‰‹å†™ï¼Œç›´æ¥çœ‹çš„ç­”æ¡ˆã€‚æˆ‘ä¼°è®¡è‡ªå·±å†™ä¹Ÿæ˜¯æ™ºèƒ½æš´åŠ›è§£æ³•\n## äºŒç»´åŠ¨æ€è§„åˆ’\n> æœ‰ç‚¹åƒâ€œç¼–è¾‘è·ç¦»â€å’ŒæŸä¸€å¤©çš„é‚£ä¸ªæˆªæœ¨å—çš„æ¯æ—¥ä¸€é¢˜ï¼Œ$dp[i][j]$è¡¨ç¤ºä»¥è¿™ä¸ªç‚¹ä¸ºå³ä¸‹è§’çš„æœ€å¤§æ­£æ–¹å½¢çš„è¾¹é•¿ï¼Œé‚£ä¹ˆå¦‚æœ$matrix[i][j]=0$ï¼Œé‚£dpè‚¯å®šä¹Ÿä¸º0ï¼Œæˆ‘ä»¬è€ƒè™‘ä¸º1çš„æƒ…å†µã€‚\n> \n> è¿™é‡Œçš„çŠ¶æ€è½¬ç§»æ–¹ç¨‹æ˜¯\n> $$\n> dp[i][j] = min(dp[i-1][j],dp[i][j-1],dp[i-1][j-1])+1\n> $$\n> ![](../img/coding/2024_3_28_2.png)\n\n```java\nclass Solution {\n    public int maximalSquare(char[][] matrix) {\n        int[][] dp = new int[matrix.length][matrix[0].length];\n        int ans = 0;\n        for (int i = 0; i < dp.length; i++) {\n            for (int j = 0; j < dp[0].length; j++) {\n                if (i != 0 || j !=0){\n                    if (matrix[i][j] == '1'){\n                        int left = 0,up = 0,up_left = 0;\n                        if (i-1 >= 0){\n                            up = dp[i-1][j];\n                        }\n                        if (j-1 >=0){\n                            left = dp[i][j-1];\n                        }\n                        if (i-1 >=0 && j-1>=0){\n                            up_left = dp[i-1][j-1];\n                        }\n                        dp[i][j] = Math.min(Math.min(left,up),up_left)+1;\n                        ans = Math.max(ans,dp[i][j]);\n                    }\n                }\n                else {\n                    if (matrix[i][j] == '1'){\n                        dp[i][j] = 1;\n                        ans = Math.max(ans,dp[i][j]);\n                    }\n                    else {\n                        dp[i][j] = 0;\n                    }\n                }\n\n            }\n        }\n        //System.out.println(Arrays.deepToString(dp));\n        return ans*ans;\n    }\n}\n```\n","tags":["åˆ·é¢˜ç¬”è®°"]},{"title":"leetcode-2024-3-27","url":"/2024/03/27/leetcode-2024-3-27/","content":"# 2580 ç»Ÿè®¡å°†é‡å åŒºé—´åˆå¹¶æˆç»„çš„æ–¹æ¡ˆæ•°ï¼ˆMediumï¼‰\n\nç»™ä½ ä¸€ä¸ªäºŒç»´æ•´æ•°æ•°ç»„ ranges ï¼Œå…¶ä¸­ ranges[i] = [starti, endi] è¡¨ç¤º starti åˆ° endi ä¹‹é—´ï¼ˆåŒ…æ‹¬äºŒè€…ï¼‰çš„æ‰€æœ‰æ•´æ•°éƒ½åŒ…å«åœ¨ç¬¬ i ä¸ªåŒºé—´ä¸­ã€‚\n\nä½ éœ€è¦å°† ranges åˆ†æˆ ä¸¤ä¸ª ç»„ï¼ˆå¯ä»¥ä¸ºç©ºï¼‰ï¼Œæ»¡è¶³ï¼š\n\næ¯ä¸ªåŒºé—´åªå±äºä¸€ä¸ªç»„ã€‚\nä¸¤ä¸ªæœ‰ äº¤é›† çš„åŒºé—´å¿…é¡»åœ¨ åŒä¸€ä¸ª ç»„å†…ã€‚\nå¦‚æœä¸¤ä¸ªåŒºé—´æœ‰è‡³å°‘ ä¸€ä¸ª å…¬å…±æ•´æ•°ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªåŒºé—´æ˜¯ æœ‰äº¤é›† çš„ã€‚\n\næ¯”æ–¹è¯´ï¼ŒåŒºé—´ [1, 3] å’Œ [2, 5] æœ‰äº¤é›†ï¼Œå› ä¸º 2 å’Œ 3 åœ¨ä¸¤ä¸ªåŒºé—´ä¸­éƒ½è¢«åŒ…å«ã€‚\nè¯·ä½ è¿”å›å°† ranges åˆ’åˆ†æˆä¸¤ä¸ªç»„çš„ æ€»æ–¹æ¡ˆæ•° ã€‚ç”±äºç­”æ¡ˆå¯èƒ½å¾ˆå¤§ï¼Œå°†å®ƒå¯¹ 109 + 7 å–ä½™ åè¿”å›ã€‚\n\n\n\nç¤ºä¾‹ 1ï¼š\n\nè¾“å…¥ï¼šranges = [[6,10],[5,15]]\nè¾“å‡ºï¼š2\nè§£é‡Šï¼š\nä¸¤ä¸ªåŒºé—´æœ‰äº¤é›†ï¼Œæ‰€ä»¥å®ƒä»¬å¿…é¡»åœ¨åŒä¸€ä¸ªç»„å†…ã€‚\næ‰€ä»¥æœ‰ä¸¤ç§æ–¹æ¡ˆï¼š\n- å°†ä¸¤ä¸ªåŒºé—´éƒ½æ”¾åœ¨ç¬¬ 1 ä¸ªç»„ä¸­ã€‚\n- å°†ä¸¤ä¸ªåŒºé—´éƒ½æ”¾åœ¨ç¬¬ 2 ä¸ªç»„ä¸­ã€‚\n\n## åŒºé—´åˆå¹¶+ç»„åˆæ•°\n> æ€è·¯æ˜¯å°†é‡Œé¢çš„åŒºé—´å…ˆåˆå¹¶ï¼Œå¾—åˆ°é•¿åº¦ã€‚ç„¶åå°±ç›¸å½“äºä¸¤ä¸ªæ¡¶å­ï¼Œæœ€ç»ˆçš„ç»“æœä¸ºç»„åˆæ•°ç›¸åŠ ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªæ¨è¾‰ä¸‰è§’ï¼Œé‚£ä¹ˆä¸€è¡Œçš„æ€»æ•°å°±æ˜¯2^n\n\n![](../img/coding/2024_3_27_1.png)\n\n> åŒºé—´åˆå¹¶ï¼šè®¾ç½®ä¸€ä¸ªåŠ¨æ€æ•°ç»„ï¼Œé¦–å…ˆæŒ‰ç…§å·¦æ‹¬å·æ’åºï¼Œæ¥ç€ä»åå¾€å‰éå†ï¼Œå¦‚æœä¸¤ä¸ªåŒºé—´å­˜åœ¨é‡åˆï¼Œå°±æŠŠåé¢çš„åˆ é™¤ï¼Œå‰é¢çš„æ”¹æˆåˆå¹¶ä»¥åçš„æ–°åŒºé—´ã€‚\n>\n> è¿™æ ·ä¸»è¦æ˜¯å¯ä»¥é¿å…ä¸‹æ ‡çš„å½±å“ï¼Œä»å‰é¢éå†åˆ é™¤ä¼šä¹±åºå·\n> \n> ä½†æ˜¯è¿™æ ·è¿˜ä¸å¤Ÿï¼Œæ¯”å¦‚è¿™ä¸ªä¾‹å­[[2,3],[4,5],[6,7],[8,9],[1,10]]ï¼Œæ’åºä»¥å[[1,10],[2,3],[4,5],[6,7],[8,9]]ï¼Œè¿™æ ·ä»¥æ¥æ’åºä¹Ÿæ²¡ç”¨ï¼Œç»“æœæ˜¯[[1,10],[4,5],[6,7],[8,9]]ï¼Œé¢å¯¹è¿™ç§æƒ…å†µéœ€è¦å¤šå¾ªç¯å‡ æ¬¡ï¼Œæ¯æ¬¡å‡å°‘1ä¸ªï¼Œå½“é•¿åº¦ä¸å†å˜åŒ–çš„æ—¶å€™å°±åœæ­¢\n```java\nclass Solution {\n    public int countWays(int[][] ranges) {\n        int MOD = 1000000007;\n        int length = merge(ranges).length;\n        int ans = 1;\n        for (int i = 0; i < length; i++) {\n            ans = ans *2%MOD;\n        }\n        return ans;\n    }\n\n    /**\n     * åˆå¹¶åŒºé—´çš„ä»£ç \n     * @param intervals\n     * @return\n     */\n    public int[][] merge(int[][] intervals){\n        int[][] temp1 = mergeTemp(intervals);\n        int[][] temp2 = mergeTemp(temp1);\n        while (temp1.length != temp2.length){\n            temp1 = mergeTemp(temp2);\n            temp2 = mergeTemp(temp1);\n        }\n        return temp1;\n    }\n    public int[][] mergeTemp(int[][] intervals) {\n        //å…ˆæ’åº\n        Arrays.sort(intervals, new Comparator<int[]>() {\n            @Override\n            public int compare(int[] o1, int[] o2) {\n                if(o1[0]==o2[0]){\n                    return o1[1] - o2[1];\n                }\n                return o1[0] - o2[0];\n            }\n        });\n        List<int[]> arrList = new ArrayList<>();\n        int rear = intervals.length-1;\n        for (int[] interval : intervals) {\n            arrList.add(interval);\n        }\n        while (rear > 0){\n            int[] front = arrList.get(rear-1);\n            int[] behind = arrList.get(rear);\n            int temp;\n            if (front[1] >= behind[0]){\n                temp = Math.max(front[1],behind[1]);\n                arrList.set(rear-1,new int[]{\n                        arrList.get(rear-1)[0],temp\n                });\n                arrList.remove(rear);\n                rear--;\n            }\n            else rear--;\n        }\n        int[][] ans = new int[arrList.size()][2];\n        for (int i = 0; i < arrList.size(); i++) {\n            ans[i] = arrList.get(i);\n        }\n        return ans;\n    }\n}\n```\n\n> å½“åˆåœ¨åšåˆå¹¶åŒºé—´çš„æ—¶å€™å°±æœ‰ç‚¹ä¾¥å¹¸äº†ï¼Œè¿™ä¸ªé¢˜åç»­è¿˜è¦å¤šçœ‹\n\n# 25 Kä¸ªä¸€ç»„ç¿»è½¬é“¾è¡¨(Hard)\n\nç»™ä½ é“¾è¡¨çš„å¤´èŠ‚ç‚¹ head ï¼Œæ¯ k ä¸ªèŠ‚ç‚¹ä¸€ç»„è¿›è¡Œç¿»è½¬ï¼Œè¯·ä½ è¿”å›ä¿®æ”¹åçš„é“¾è¡¨ã€‚\n\nk æ˜¯ä¸€ä¸ªæ­£æ•´æ•°ï¼Œå®ƒçš„å€¼å°äºæˆ–ç­‰äºé“¾è¡¨çš„é•¿åº¦ã€‚å¦‚æœèŠ‚ç‚¹æ€»æ•°ä¸æ˜¯ k çš„æ•´æ•°å€ï¼Œé‚£ä¹ˆè¯·å°†æœ€åå‰©ä½™çš„èŠ‚ç‚¹ä¿æŒåŸæœ‰é¡ºåºã€‚\n\nä½ ä¸èƒ½åªæ˜¯å•çº¯çš„æ”¹å˜èŠ‚ç‚¹å†…éƒ¨çš„å€¼ï¼Œè€Œæ˜¯éœ€è¦å®é™…è¿›è¡ŒèŠ‚ç‚¹äº¤æ¢\n\n![](../img/coding/2024_3_27_2.png)\n\n>å…¶å®ä¹Ÿæ²¡é‚£ä¹ˆHardï¼Œå°±æ˜¯éº»çƒ¦äº†ä¸€ç‚¹\n\n## æ¨¡æ‹Ÿ\n```java\nclass Solution {\n    public ListNode reverseKGroup(ListNode head, int k) {\n        //å¦‚æœé—´éš”æ˜¯1ï¼Œé‚£ä¹ˆå°±ä¸è¿›è¡Œä¸‹é¢çš„é€»è¾‘ç›´æ¥è¿”å›\n        if (k==1){\n            return head;\n        }\n        ListNode p = head;\n        //é¦–å…ˆéå†ç»Ÿè®¡èŠ‚ç‚¹æ•°\n        int count = 0;\n        while (p!=null){\n            count++;\n            p = p.next;\n        }\n        p = head;\n        ListNode pre = head;\n        List<ListNode> listNodes = new ArrayList<>();\n        //å¯¹äºæ¯ä¸€ä¸ªå®Œæ•´çš„ç»„ï¼Œä¸å®Œæ•´çš„ç›´æ¥æ¥åœ¨å°¾éƒ¨å°±è¡Œ\n        for (int i = 1; i <= count / k; i++) {\n            //preæ‰¾çš„æ˜¯ä¸‹ä¸€ä¸ªçš„å®Œæ•´ç»„çš„å¤´èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯ä¸‹ä¸ªp\n            pre = getNext(pre,k);\n            //å°†åè½¬åçš„å¤´èŠ‚ç‚¹æ”¾è¿›æ•°ç»„ä¿å­˜\n            listNodes.add(reverse(p,k));\n            p = pre;\n        }\n        //éå†æ•°ç»„ï¼Œä¸€æ®µä¸€æ®µæ¥èµ·æ¥\n        ListNode temp = listNodes.get(0);\n        for (int i = 0; i < listNodes.size()-1; i++) {\n            temp= listNodes.get(i);\n            while (temp.next != null){\n                temp = temp.next;\n            }\n            temp.next = listNodes.get(i+1);\n        }\n        //è¿™é‡Œæœ€åä¸€æ®µè¿˜æ²¡éå†ï¼Œä¸ºäº†æ‰¾åˆ°å°¾æŒ‡é’ˆæ¥ä¸Šè½å•çš„é‚£å‡ ä¸ªèŠ‚ç‚¹\n        while (temp.next != null){\n            temp = temp.next;\n        }\n        //æ¥ä¸Šè½å•çš„å‡ ä¸ªèŠ‚ç‚¹\n        temp.next = pre;\n        //è¿”å›æœ€ç»ˆçš„å¤´èŠ‚ç‚¹\n        ListNode ans = listNodes.get(0);\n        \n        return listNodes.get(0);\n\n    }\n\n    /**\n     * è¿”å›ä¸‹ä¸€æ®µçš„å¤´èŠ‚ç‚¹\n     * @param p\n     * @param k\n     * @return\n     */\n    public ListNode getNext(ListNode p,int k){\n        for (int i = 0; i < k; i++) {\n            p = p.next;\n        }\n        return p;\n    }\n\n    /**\n     * åè½¬å½“å‰æ®µ\n     * @param head åŸé¡ºåºçš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹\n     * @param k æœ¬æ®µé•¿å¤šå°‘\n     * @return è¿”å›è¿™ä¸€æ®µåè½¬å®Œçš„å¤´èŠ‚ç‚¹\n     */\n    public ListNode reverse(ListNode head,int k){\n        //é¦–å…ˆè¿”å›çš„å¤´èŠ‚ç‚¹è‚¯å®šæ˜¯åŠ¨è¿‡çš„ï¼Œå¤´èŠ‚ç‚¹æ˜¯æœ€æœ«å°¾é‚£ä¸ªï¼Œåœ¨è¿™é‡Œæ˜¯k-1æ¬¡å¾ªç¯åçš„é‚£ä¸ªèŠ‚ç‚¹\n        ListNode ans = head;\n        for (int i = 0; i < k - 1; i++) {\n            ans = ans.next;\n        }\n        //æ‰§è¡Œå€’åºé€»è¾‘\n        ListNode pre =null,p = head,pa;\n        for (int i = 0; i < k; i++) {\n            pa = p.next;\n            p.next = pre;\n            pre = p;\n            p = pa;\n        }\n        return ans;\n    }\n}\n```\n\n# 136 åªå‡ºç°ä¸€æ¬¡çš„æ•°å­—ï¼ˆEasyï¼‰\n\nç»™ä½ ä¸€ä¸ª éç©º æ•´æ•°æ•°ç»„ nums ï¼Œé™¤äº†æŸä¸ªå…ƒç´ åªå‡ºç°ä¸€æ¬¡ä»¥å¤–ï¼Œå…¶ä½™æ¯ä¸ªå…ƒç´ å‡å‡ºç°ä¸¤æ¬¡ã€‚æ‰¾å‡ºé‚£ä¸ªåªå‡ºç°äº†ä¸€æ¬¡çš„å…ƒç´ ã€‚\n\nä½ å¿…é¡»è®¾è®¡å¹¶å®ç°çº¿æ€§æ—¶é—´å¤æ‚åº¦çš„ç®—æ³•æ¥è§£å†³æ­¤é—®é¢˜ï¼Œä¸”è¯¥ç®—æ³•åªä½¿ç”¨å¸¸é‡é¢å¤–ç©ºé—´ã€‚\n\nç¤ºä¾‹ 1 ï¼š\n\nè¾“å…¥ï¼šnums = [2,2,1]\n\nè¾“å‡ºï¼š1\n\n## å“ˆå¸Œè¡¨\n\n> è¿™é‡Œæˆ‘çš„æ€è·¯æ˜¯éå†ä¸€æ¬¡ç„¶ååŠ å…¥å“ˆå¸Œè¡¨è¿›è¡Œç»Ÿè®¡ï¼Œå†éå†ä¸€æ¬¡å“ˆå¸Œè¡¨æ‰¾å‡ºå…¶ä¸­ä¸º1çš„ï¼Œè¿™æ ·æ—¶é—´ç©ºé—´å¤æ‚åº¦è‚¯å®šéƒ½0(n)äº†\n\n## æŠ€å·§-ä½è¿ç®—\n\n> é€šè¿‡å¼‚æˆ–ï¼Œå› ä¸ºåªæœ‰ä¸¤ä¸ªä¸¤ä¸ªçš„ï¼Œä¸¤ä¸ªç›¸åŒçš„å¼‚æˆ–ç»“æœå°±æ˜¯0ï¼Œ0å’Œä»»ä½•å¼‚æˆ–éƒ½æ˜¯è‡ªèº«ï¼Œé‚£ä¹ˆæ‰€æœ‰è¿›è¡Œå¼‚æˆ–å¾—åˆ°çš„å°±æ˜¯è½å•çš„\n\n```java\nclass Solution {\n    public int singleNumber(int[] nums) {\n        int single = 0;\n        for (int num : nums) {\n            single ^= num;\n        }\n        return single;\n    }\n}\n\n``` \n\n","tags":["åˆ·é¢˜ç¬”è®°"]},{"title":"Collectionsé›†åˆç¯‡-Map","url":"/2024/03/26/Collectionsé›†åˆç¯‡-Map/","content":"# HashMap\n> æœ€å¸¸ç”¨çš„Mapç»“æ„ï¼Œä½¿ç”¨çš„æ˜¯æ‹‰é“¾æ³•\n\n## æ•°æ®ç»“æ„\nHashMapé‡‡ç”¨Entryæ•°ç»„æ¥å­˜å‚¨key-value,Entryæœ‰å››ä¸ªå±æ€§ï¼ŒKeyï¼Œvalueï¼Œå“ˆå¸Œå€¼å’Œä¸‹ä¸€ä¸ªçš„æŒ‡é’ˆ\n![](../img/Java/img_2.png)\n> è¿™é‡Œæ˜¯1.8çš„ç‰ˆæœ¬ï¼ŒNodeæ˜¯Entryçš„ä¸€ç§å®ç°\n```java\nstatic class Node<K,V> implements Map.Entry<K,V> {\n    final int hash;\n    final K key;\n    V value;\n    Node<K,V> next;\n\n    Node(int hash, K key, V value, Node<K,V> next) {\n        this.hash = hash;\n        this.key = key;\n        this.value = value;\n        this.next = next;\n    }\n}\n```\nè¡¨çš„æ•°æ®ç»“æ„å°±æ˜¯ä¸€ä¸ªä¸ªçš„Entry\n```java\ntransient Node<K,V>[] table;\n```\n## å±æ€§\n```java\n/**\n * åˆå§‹çš„å¤§å°\n */\nstatic final int DEFAULT_INITIAL_CAPACITY = 1 << 4; // aka 16\n\n/**\n * ä¸ºä»€ä¹ˆè¿™é‡Œæ˜¯2^31å‘¢ï¼Œå› ä¸ºhashCodeæ˜¯intç±»å‹çš„å€¼ï¼Œ\n * å¯¹äºæ•°ç»„ä¸‹æ ‡è€Œè¨€ä¸èƒ½æœ‰è´Ÿæ•°ï¼Œæ•´æ•°çš„èŒƒå›´å°±æ˜¯0-2^31-1\n */\nstatic final int MAXIMUM_CAPACITY = 1 << 30;\n\n/**\n * é˜ˆå€¼çš„è®¡ç®—å‚æ•°ï¼Œå¤ªå¤šäº†å¯èƒ½ä¼šé€ æˆé“¾è¡¨å˜é•¿è€Œé™ä½æŸ¥æ‰¾æ•ˆç‡\n * å¤ªä½äº†å¯èƒ½é¢‘ç¹æ‰©å®¹ä¹Ÿä¼šå½±å“æ•ˆç‡\n * è¿™ä¸ªå€¼æ˜¯é€šè¿‡æ³Šæ¾åˆ†å¸ƒè®¡ç®—å‡ºæ¥çš„\n */\nstatic final float DEFAULT_LOAD_FACTOR = 0.75f;\n\n/**\n * æ„å‘³ç€å¦‚æœé“¾è¡¨çš„é•¿åº¦å¤§äº8å°±è¦è½¬åŒ–ä¸ºçº¢é»‘æ ‘\n */\nstatic final int TREEIFY_THRESHOLD = 8;\n\n/**\n * ç›¸åçš„ï¼Œå¦‚æœå½“å‰æ ‘èŠ‚ç‚¹å°äº6ä¸ªå°±è¦å°†å…¶è½¬åŒ–ä¸ºé“¾è¡¨\n */\nstatic final int UNTREEIFY_THRESHOLD = 6;\n\n/**\n * é“¾è¡¨çš„é•¿åº¦å¤§äº8ä¸”æ•°ç»„é•¿åº¦å¤§äº64è½¬åŒ–ä¸ºçº¢é»‘æ ‘\n */\nstatic final int MIN_TREEIFY_CAPACITY = 64;\n\n```\n## hashCode()å’Œequals()æ–¹æ³•\né¦–å…ˆçœ‹Objectçš„hashCodeæ–¹æ³•ï¼š\n\nä½œç”¨ï¼šè¿”å›å¯¹è±¡çš„å“ˆå¸Œç å€¼ï¼Œç”¨äºåœ¨å“ˆå¸Œè¡¨ç­‰æ•°æ®ç»“æ„ä¸­å¿«é€Ÿå®šä½å¯¹è±¡ï¼Œæé«˜å“ˆå¸Œè¡¨çš„æ€§èƒ½ã€‚\n\né»˜è®¤å®ç°ï¼šObjectç±»ä¸­çš„hashCode()æ–¹æ³•é»˜è®¤è¿”å›å¯¹è±¡çš„å†…å­˜åœ°å€çš„å“ˆå¸Œç å€¼ã€‚\n\n> è¿™ä¸ªé»˜è®¤çš„æ–¹æ³•æ˜¯æ ¹æ®åœ°å€è®¡ç®—å‡ºæ¥çš„ï¼Œ\n> å¦‚æœä¸¤ä¸ªå¯¹è±¡çš„hashCode()è¿”å›å€¼ç›¸åŒï¼Œä¸ä¸€å®šè¡¨ç¤ºè¿™ä¸¤ä¸ªå¯¹è±¡ç›¸ç­‰(ä¸€èˆ¬æƒ…å†µä¸‹æ˜¯å¯ä»¥è¯´æ˜ä¸¤ä¸ªå¯¹è±¡ç›¸ç­‰)ï¼Œå› ä¸ºå¯èƒ½å­˜åœ¨å“ˆå¸Œå†²çªã€‚\n> \n> **å“ˆå¸Œå€¼ä¸èƒ½ç­‰ä»·äºåœ°å€ï¼Œå› ä¸ºJavaæ˜¯åœ¨JVMä¸­æ‰§è¡Œçš„ï¼Œå¹¶ä¸æ˜¯çœŸæ­£çš„åœ°å€ã€‚**\n```java\npublic class Hashcode {\n    public static void main(String[] args) {\n        A a = new A();\n        A a1 = new A();\n        A a2 = a1;\n        System.out.println(a.hashCode());//460141958\n        System.out.println(a1.hashCode());//1163157884\n        System.out.println(a2.hashCode());//1163157884\n    }\n}\n \nclass A{\n}\n```\n\næˆ‘ä»¬å†çœ‹HashMapé‡å†™çš„hashCode\n> è¿™é‡Œé€‰æ‹©é«˜åå…­ä½å’Œç¬¬åå…­ä½è¿›è¡Œå¼‚æˆ–è¿ç®—ï¼Œæ˜¯ä¸ºäº†å°½é‡æå–å…¨éƒ¨ä½çš„ç‰¹å¾å‚ä¸å“ˆå¸Œè®¡ç®—ï¼Œä½¿å¾—å…¶æ›´åŠ åˆ†æ•£\n```java\nstatic final int hash(Object key) {\n    int h;\n    return (key == null) ? 0 : (h = key.hashCode()) ^ (h >>> 16);\n}\n```\n\n1. int h;ï¼šå®šä¹‰ä¸€ä¸ªæ•´å‹å˜é‡ hï¼Œç”¨äºå­˜å‚¨è®¡ç®—å‡ºçš„å“ˆå¸Œå€¼ã€‚\n2. (key == null) ? 0 : (h = key.hashCode())ï¼šè¿™æ˜¯ä¸€ä¸ªä¸‰å…ƒè¿ç®—ç¬¦ï¼Œç”¨äºåˆ¤æ–­ç»™å®šçš„é”®æ˜¯å¦ä¸º nullã€‚å¦‚æœé”®ä¸º nullï¼Œåˆ™å°†å“ˆå¸Œå€¼ h è®¾ä¸º 0ï¼›å¦åˆ™ï¼Œè°ƒç”¨é”®çš„ hashCode() æ–¹æ³•è·å–å…¶å“ˆå¸Œç ï¼Œå¹¶å°†ç»“æœèµ‹ç»™å˜é‡ hã€‚\n3. (h >>> 16)ï¼šè¿™æ˜¯ä¸€ä¸ªæ— ç¬¦å·å³ç§»è¿ç®—ï¼Œå°†å˜é‡ h çš„äºŒè¿›åˆ¶è¡¨ç¤ºå‘å³ç§»åŠ¨ 16 ä½ã€‚è¿™ä¹ˆåšçš„ç›®çš„æ˜¯ä¸ºäº†å¢åŠ å“ˆå¸Œå€¼çš„éšæœºæ€§ï¼Œä½¿å¾—å“ˆå¸Œå€¼çš„é«˜ä½å’Œä½ä½éƒ½å‚ä¸äº†å“ˆå¸Œç çš„è®¡ç®—ã€‚\n4. (h = key.hashCode()) ^ (h >>> 16)ï¼šè¿™æ˜¯ä¸€ä¸ªæŒ‰ä½å¼‚æˆ–è¿ç®—ï¼Œå°†å“ˆå¸Œå€¼ h å’Œå³ç§»åçš„å“ˆå¸Œå€¼è¿›è¡Œå¼‚æˆ–è¿ç®—ã€‚æŒ‰ä½å¼‚æˆ–è¿ç®—æ˜¯ä¸€ç§å¸¸ç”¨çš„æ··åˆå“ˆå¸Œå‡½æ•°ï¼Œç”¨äºå°†é«˜ä½çš„ä¿¡æ¯ä¸ä½ä½çš„ä¿¡æ¯æ··åˆåœ¨ä¸€èµ·ï¼Œå¢åŠ å“ˆå¸Œå€¼çš„éšæœºæ€§ã€‚\n5. returnï¼šå°†è®¡ç®—å‡ºçš„å“ˆå¸Œå€¼è¿”å›ã€‚\n\n> åœ¨putæ“ä½œé‡Œé¢æ˜¯è¿™æ ·åˆ¤æ–­hashcodeå’Œequalsçš„\n```\np.hash == hash && ((k = p.key) == key || (key != null && key.equals(k)))\n```\n- é¦–å…ˆåˆ¤æ–­ä¸¤ä¸ªçš„å“ˆå¸Œæ˜¯å¦ç›¸ç­‰ï¼Œå¦‚æœå“ˆå¸Œä¸ç›¸ç­‰é‚£ä¹ˆè‚¯å®šä¸å­˜åœ¨å†²çª\n- å¦‚æœå“ˆå¸Œç›¸ç­‰ï¼Œå¯èƒ½æ˜¯å“ˆå¸Œç¢°æ’ï¼Œä¹Ÿå¯èƒ½æ˜¯çœŸçš„å°±æ˜¯ä¸€æ ·çš„å…ƒç´ ï¼Œéœ€è¦å¯¹å…·ä½“çš„kè¿›è¡Œåˆ¤æ–­\n- p.key == keyåˆ¤æ–­çš„æ˜¯**å¼•ç”¨æ˜¯å¦ç›¸ç­‰**ï¼Œä¹Ÿå°±æ˜¯æŒ‡é’ˆï¼Œæœ‰çš„æ—¶å€™ä¸¤ä¸ªç±»çš„æŒ‡é’ˆæŒ‡å‘çš„æ˜¯åŒä¸€å—ç©ºé—´ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™å°±è‚¯å®šæ˜¯ç›¸ç­‰çš„\n- key.equals(k)åˆ¤æ–­çš„æ˜¯**å†…å®¹æ˜¯å¦ç›¸ç­‰**ï¼Œæœ‰çš„æ—¶å€™ä¸¤ä¸ªæŒ‡é’ˆæŒ‡å¾—ç¡®å®æ˜¯ä¸ä¸€æ ·çš„ï¼Œä½†æ˜¯ä»–ä»¬åŒ…å«çš„å†…å®¹æ˜¯ä¸€æ ·çš„ï¼Œé‚£ä¹ˆè‚¯å®šä¹Ÿä¸èƒ½æ”¾è¿›å“ˆå¸Œè¡¨ï¼Œnew Student(\"yyf\")å’Œnew Student(\"xxy\")æŒ‡é’ˆè‚¯å®šæ˜¯ä¸åŒçš„ï¼Œå› ä¸ºæŒ‡å‘ä¸åŒçš„å†…å­˜ç©ºé—´ï¼Œä½†æ˜¯å†…å®¹ä¸ä¸€æ ·ã€‚è¿™ä¸ªæ£€æµ‹å°±éœ€è¦equalæ¥æ£€æµ‹äº†\n\n> çœ‹æºç è¿™ä¸€æ®µåˆ¤æ–­ï¼Œä¹¦é‡Œçš„é•¿ç¯‡å¤§è®ºéƒ½å¯ä»¥ä¸çœ‹äº†ï¼š\n> \n> hashcodeä¸€è‡´ï¼Œå†…å®¹ä¸ä¸€æ ·çš„ä¸¤ä¸ªè‚¯å®šæ˜¯èƒ½è¿›å“ˆå¸Œè¡¨çš„ï¼Œè¿™å°±æ˜¯å“ˆå¸Œç¢°æ’\n> \n> hashcodeä¸€è‡´ï¼Œequalsè¿”å›trueé‚£è‚¯å®šæ˜¯ä¸èƒ½è¿›çš„ï¼Œè¿™é‡Œé€»è¾‘æ˜¯æˆ–ï¼Œå°±æ˜¯å†…å®¹æˆ–è€…å¼•ç”¨æ»¡è¶³ä¸€ä¸ªç›¸ç­‰å°±ä¸èƒ½æ”¾äº†\n> \n> é‡å†™äº†hashcodeï¼Œä½†æ˜¯equalsè¿”å›trueæ˜¯å¯ä»¥æ”¾è¿›å»çš„ï¼Œå› ä¸ºé€»è¾‘æ˜¯ä¸\n\n## putæ“ä½œ\n\n```java\npublic V put(K key, V value) {\n    return putVal(hash(key), key, value, false, true);\n}\n```\n```java\nstatic final int hash(Object key) {\n    int h;\n    return (key == null) ? 0 : (h = key.hashCode()) ^ (h >>> 16);\n}\n```\n> è¿™é‡Œä¸»è¦æœ‰å‡ ç‚¹æ³¨æ„ï¼š\n> - (n - 1) & hashæ˜¯æ€ä¹ˆæ¥çš„ï¼Œå…¶å®è¿™å°±æ˜¯ä¸€ä¸ªå–ä½™çš„æ“ä½œï¼Œå› ä¸ºnä¸º2çš„æ•´æ•°å€ï¼Œé‚£ä¹ˆn-1è‚¯å®šæ˜¯æœ«å°¾å…¨ä¸º1å‰é¢å…¨ä¸º0çš„ï¼Œç”¨ä½è¿ç®—ä¼šæ¯”%å¿«\n> - p.hash == hash && ((k = p.key) == key || (key != null && key.equals(k))åœ¨å‰é¢å·²ç»è®²è¿‡äº†\n```java\nfinal V putVal(int hash, K key, V value, boolean onlyIfAbsent, boolean evict) {\n    Node<K,V>[] tab; Node<K,V> p; int n, i;\n    //åˆ¤æ–­æ•°ç»„æ˜¯å¦æœªåˆå§‹åŒ–,è¿™é‡Œtableå·²ç»èµ‹å€¼ç»™tabäº†ï¼Œnä¹ŸåŒç†\n    if ((tab = table) == null || (n = tab.length) == 0)\n        //å¦‚æœæœªåˆå§‹åŒ–ï¼Œè°ƒç”¨resizeæ–¹æ³• è¿›è¡Œåˆå§‹åŒ–\n        n = (tab = resize()).length;\n    //é€šè¿‡ & è¿ç®—æ±‚å‡ºè¯¥æ•°æ®ï¼ˆkeyï¼‰çš„æ•°ç»„ä¸‹æ ‡å¹¶åˆ¤æ–­è¯¥ä¸‹æ ‡ä½ç½®æ˜¯å¦æœ‰æ•°æ®\n    /**\n     * è¿™é‡Œæ˜¯å–ä½™æ“ä½œï¼Œä½è¿ç®—æ›´å¿«\n     * ç”±äºnå¿…ç„¶æ˜¯2çš„å€æ•°ï¼Œé‚£ä¹ˆ-1å°±æ˜¯é™¤äº†æœ€é«˜ä½å…¶ä»–éƒ½ä¸º1ï¼Œè¿™ä¸ªæ—¶å€™å°±ç›¸å½“äºæ©ç ï¼Œä¸hashè¿›è¡Œä¸è¿ç®—\n     * å°±å¯ä»¥å¾—åˆ°ä½™æ•°ï¼Œéå¸¸ç¥å¥‡\n     */\n    if ((p = tab[i = (n - 1) & hash]) == null)\n        //å¦‚æœæ²¡æœ‰ï¼Œç›´æ¥å°†æ•°æ®æ”¾åœ¨è¯¥ä¸‹æ ‡ä½ç½®\n        tab[i] = newNode(hash, key, value, null);\n    //è¯¥æ•°ç»„ä¸‹æ ‡æœ‰æ•°æ®çš„æƒ…å†µ\n    else {\n        Node<K,V> e; K k;\n        //åˆ¤æ–­è¯¥ä½ç½®æ•°æ®çš„keyå’Œæ–°æ¥çš„æ•°æ®æ˜¯å¦ä¸€æ ·\n        if (p.hash == hash && ((k = p.key) == key || (key != null && key.equals(k))))\n            //å¦‚æœä¸€æ ·ï¼Œè¯æ˜ä¸ºä¿®æ”¹æ“ä½œï¼Œè¯¥èŠ‚ç‚¹çš„æ•°æ®èµ‹å€¼ç»™e,åè¾¹ä¼šç”¨åˆ°\n            e = p;\n        //åˆ¤æ–­æ˜¯ä¸æ˜¯çº¢é»‘æ ‘\n        else if (p instanceof TreeNode)\n            //å¦‚æœæ˜¯çº¢é»‘æ ‘çš„è¯ï¼Œè¿›è¡Œçº¢é»‘æ ‘çš„æ“ä½œ\n            e = ((TreeNode<K,V>)p).putTreeVal(this, tab, hash, key, value);\n        //æ–°æ•°æ®å’Œå½“å‰æ•°ç»„æ—¢ä¸ç›¸åŒï¼Œä¹Ÿä¸æ˜¯çº¢é»‘æ ‘èŠ‚ç‚¹ï¼Œè¯æ˜æ˜¯é“¾è¡¨\n        else {\n            //éå†é“¾è¡¨\n            for (int binCount = 0; ; ++binCount) {\n                //åˆ¤æ–­nextèŠ‚ç‚¹ï¼Œå¦‚æœä¸ºç©ºçš„è¯ï¼Œè¯æ˜éå†åˆ°é“¾è¡¨å°¾éƒ¨äº†\n                if ((e = p.next) == null) {\n                    //æŠŠæ–°å€¼æ”¾å…¥é“¾è¡¨å°¾éƒ¨\n                    p.next = newNode(hash, key, value, null);\n                    //å› ä¸ºæ–°æ’å…¥äº†ä¸€æ¡æ•°æ®ï¼Œæ‰€ä»¥åˆ¤æ–­é“¾è¡¨é•¿åº¦æ˜¯ä¸æ˜¯å¤§äºç­‰äº8\n                    if (binCount >= TREEIFY_THRESHOLD - 1) // -1 for 1st\n                        //å¦‚æœæ˜¯ï¼Œè¿›è¡Œè½¬æ¢çº¢é»‘æ ‘æ“ä½œ\n                        treeifyBin(tab, hash);\n                    break;\n                }\n                //åˆ¤æ–­é“¾è¡¨å½“ä¸­æœ‰æ•°æ®ç›¸åŒçš„å€¼ï¼Œå¦‚æœä¸€æ ·ï¼Œè¯æ˜ä¸ºä¿®æ”¹æ“ä½œ\n                if (e.hash == hash &&\n                    ((k = e.key) == key || (key != null && key.equals(k))))\n                    break;\n                //æŠŠä¸‹ä¸€ä¸ªèŠ‚ç‚¹èµ‹å€¼ä¸ºå½“å‰èŠ‚ç‚¹\n                p = e;\n            }\n        }\n        //åˆ¤æ–­eæ˜¯å¦ä¸ºç©ºï¼ˆeå€¼ä¸ºä¿®æ”¹æ“ä½œå­˜æ”¾åŸæ•°æ®çš„å˜é‡ï¼‰\n        if (e != null) { // existing mapping for key\n            //ä¸ä¸ºç©ºçš„è¯è¯æ˜æ˜¯ä¿®æ”¹æ“ä½œï¼Œå–å‡ºè€å€¼\n            V oldValue = e.value;\n            //ä¸€å®šä¼šæ‰§è¡Œ  onlyIfAbsentä¼ è¿›æ¥çš„æ˜¯false\n            if (!onlyIfAbsent || oldValue == null)\n                //å°†æ–°å€¼èµ‹å€¼å½“å‰èŠ‚ç‚¹\n                e.value = value;\n            afterNodeAccess(e);\n            //è¿”å›è€å€¼\n            return oldValue;\n        }\n    }\n    //è®¡æ•°å™¨ï¼Œè®¡ç®—å½“å‰èŠ‚ç‚¹çš„ä¿®æ”¹æ¬¡æ•°\n    ++modCount;\n    //å½“å‰æ•°ç»„ä¸­çš„æ•°æ®æ•°é‡å¦‚æœå¤§äºæ‰©å®¹é˜ˆå€¼\n    if (++size > threshold)\n        //è¿›è¡Œæ‰©å®¹æ“ä½œ\n        resize();\n    //ç©ºæ–¹æ³•\n    afterNodeInsertion(evict);\n    //æ·»åŠ æ“ä½œæ—¶ è¿”å›ç©ºå€¼\n    return null;\n}\n```\nputçš„é€»è¾‘æ˜¯ï¼š\n- é¦–å…ˆåˆ¤æ–­æ˜¯ä¸æ˜¯æ²¡æœ‰è¿›è¡Œåˆå§‹åŒ–ï¼Œå¦‚æœæ˜¯ç¬¬ä¸€æ¬¡åŠ å…¥ï¼Œé‚£ä¹ˆresizeï¼Œè¿™é‡Œçš„é»˜è®¤é•¿åº¦æ˜¯16ï¼Œé˜ˆå€¼ä¸º16*0.75\n- å¦‚æœåˆå§‹åŒ–äº†ï¼Œçœ‹tab[(n - 1) & hash]æ˜¯å¦æœ‰æ•°æ®ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå°±ç›´æ¥æ”¾è¿™é‡Œï¼›å¦‚æœæœ‰é‚£ä¹ˆå°±è¿›è¡Œåé¢çš„é€»è¾‘\n- åˆ¤æ–­p.hash == hash && ((k = p.key) == key || (key != null && key.equals(k)))çœ‹è·Ÿå½“å‰çš„è¿™ä¸ªæ˜¯ä¸æ˜¯ä¸€æ ·çš„ï¼Œå¦‚æœæ˜¯ä¸€æ ·çš„é‚£å°±è¿›è¡Œä¿®æ”¹ï¼Œå¦‚æœä¸æ˜¯ï¼Œé‚£å°±è¦è¿›è¡Œé“¾è¡¨æˆ–è€…çº¢é»‘æ ‘çš„æ·»åŠ äº†\n- å¦‚æœæ˜¯çº¢é»‘æ ‘ï¼Œé‚£ä¹ˆå°±èµ°çº¢é»‘æ ‘çš„æ·»åŠ é€»è¾‘\n- å¦‚æœæ˜¯é“¾è¡¨ï¼Œå°±éå†é“¾è¡¨ï¼Œæ¯ä¸€ä¸ªéƒ½è¿›è¡Œåˆ¤æ–­p.hash == hash && ((k = p.key) == key || (key != null && key.equals(k)))ï¼Œå¦‚æœæ˜¯é‚£å°±ä¿®æ”¹ï¼Œå¦‚æœéå†åˆ°æœ€åäº†ï¼Œé‚£å°±æ·»åŠ åˆ°æœ«å°¾\n- è¾¹èµ°è¾¹åˆ¤æ–­æ˜¯ä¸æ˜¯è¦è¶…è¿‡8ä¸ªäº†ï¼Œå¦‚æœéå†åˆ°çš„èŠ‚ç‚¹åˆ°ç¬¬ä¸ƒä¸ªäº†ï¼Œé‚£å°±è¦æ ‘åŒ–äº†\n- æœ€åéå†å®Œäº†çœ‹æ˜¯å¦è¶…è¿‡æ‰©å®¹é˜ˆå€¼äº†ï¼Œå¦‚æœè¦æ‰©å®¹è¿˜è¦æ‰©\n> å…³äºè¿™é‡Œé“¾è¡¨çš„å°¾æ’æ³•ï¼Œåç»­è¿˜æœ‰ç›¸å…³çŸ¥è¯†ç‚¹\n## HashMapçš„æ‰©å®¹\n```java\n//æ‰©å®¹ã€åˆå§‹åŒ–æ•°ç»„\nfinal Node<K,V>[] resize() {\n        Node<K,V>[] oldTab = table;\n    \t//å¦‚æœå½“å‰æ•°ç»„ä¸ºnullçš„æ—¶å€™ï¼ŒæŠŠoldCapè€æ•°ç»„å®¹é‡è®¾ç½®ä¸º0\n        int oldCap = (oldTab == null) ? 0 : oldTab.length;\n        //è€çš„æ‰©å®¹é˜ˆå€¼\n    \tint oldThr = threshold;\n        int newCap, newThr = 0;\n        //åˆ¤æ–­æ•°ç»„å®¹é‡æ˜¯å¦å¤§äº0ï¼Œå¤§äº0è¯´æ˜æ•°ç»„å·²ç»åˆå§‹åŒ–\n    \tif (oldCap > 0) {\n            //åˆ¤æ–­å½“å‰æ•°ç»„é•¿åº¦æ˜¯å¦å¤§äºæœ€å¤§æ•°ç»„é•¿åº¦\n            if (oldCap >= MAXIMUM_CAPACITY) {\n                //å¦‚æœæ˜¯ï¼Œå°†æ‰©å®¹é˜ˆå€¼ç›´æ¥è®¾ç½®ä¸ºintç±»å‹çš„æœ€å¤§æ•°å€¼å¹¶ç›´æ¥è¿”å›\n                /**\n                 * å¦‚æœéƒ½å·²ç»åˆ°æœ€å¤§é™åˆ¶äº†ä¸èƒ½å†å¤šäº†ï¼Œé‚£ä¹ˆé˜ˆå€¼å°±è¦å˜å¾—æœ€å¤§ä»¥å…è¿˜è¦è¿›è¡Œæ‰©å®¹æ“ä½œ\n                 */\n                threshold = Integer.MAX_VALUE;\n                return oldTab;\n            }\n            //å¦‚æœåœ¨æœ€å¤§é•¿åº¦èŒƒå›´å†…ï¼Œåˆ™éœ€è¦æ‰©å®¹  OldCap << 1ç­‰ä»·äºoldCap*2\n            //è¿ç®—è¿‡ååˆ¤æ–­æ˜¯ä¸æ˜¯æœ€å¤§å€¼å¹¶ä¸”oldCapéœ€è¦å¤§äº16\n            else if ((newCap = oldCap << 1) < MAXIMUM_CAPACITY &&\n                     oldCap >= DEFAULT_INITIAL_CAPACITY)\n                newThr = oldThr << 1; // double threshold  ç­‰ä»·äºoldThr*2\n        }\n    \t//å¦‚æœoldCap<0ï¼Œä½†æ˜¯å·²ç»åˆå§‹åŒ–äº†ï¼ŒåƒæŠŠå…ƒç´ åˆ é™¤å®Œä¹‹åçš„æƒ…å†µï¼Œé‚£ä¹ˆå®ƒçš„ä¸´ç•Œå€¼è‚¯å®šè¿˜å­˜åœ¨ï¼Œ       \t\t\tå¦‚æœæ˜¯é¦–æ¬¡åˆå§‹åŒ–ï¼Œå®ƒçš„ä¸´ç•Œå€¼åˆ™ä¸º0\n        /**\n         * // ä¸ºä»€ä¹ˆè¿™é‡Œçš„oldThråœ¨æœªåˆå§‹åŒ–æ•°ç»„çš„æ—¶å€™å°±æœ‰å€¼å‘¢ï¼Ÿ\n         // è¿™æ˜¯å› ä¸ºHashMapæœ‰ä¸¤ä¸ªå¸¦å‚æ„é€ å™¨ï¼Œå¯ä»¥æŒ‡å®šåˆå§‹å®¹é‡ï¼Œ\n         // è‹¥ä½ è°ƒç”¨äº†è¿™ä¸¤ä¸ªå¯ä»¥æŒ‡å®šåˆå§‹å®¹é‡çš„æ„é€ å™¨ï¼Œ\n         // è¿™ä¸¤ä¸ªæ„é€ å™¨å°±ä¼šå°†é˜ˆå€¼è®°å½•ä¸ºç¬¬ä¸€ä¸ªå¤§äºç­‰äºä½ æŒ‡å®šå®¹é‡ï¼Œä¸”æ»¡è¶³2^nçš„æ•°ï¼ˆå¯ä»¥çœ‹çœ‹è¿™ä¸¤ä¸ªæ„é€ å™¨ï¼‰\n         */\n        else if (oldThr > 0) // initial capacity was placed in threshold\n            newCap = oldThr;\n        //æ•°ç»„æœªåˆå§‹åŒ–çš„æƒ…å†µï¼Œå°†é˜ˆå€¼å’Œæ‰©å®¹å› å­éƒ½è®¾ç½®ä¸ºé»˜è®¤å€¼\n        //åˆå§‹åŒ–èµ°è¿™ä¸ª\n    \telse {               // zero initial threshold signifies using defaults\n            newCap = DEFAULT_INITIAL_CAPACITY;\n            newThr = (int)(DEFAULT_LOAD_FACTOR * DEFAULT_INITIAL_CAPACITY);\n        }\n    \t//åˆå§‹åŒ–å®¹é‡å°äº16çš„æ—¶å€™ï¼Œæ‰©å®¹é˜ˆå€¼æ˜¯æ²¡æœ‰èµ‹å€¼çš„\n        if (newThr == 0) {\n            //åˆ›å»ºé˜ˆå€¼\n            float ft = (float)newCap * loadFactor;\n            //åˆ¤æ–­æ–°å®¹é‡å’Œæ–°é˜ˆå€¼æ˜¯å¦å¤§äºæœ€å¤§å®¹é‡\n            newThr = (newCap < MAXIMUM_CAPACITY && ft < (float)MAXIMUM_CAPACITY ?\n                      (int)ft : Integer.MAX_VALUE);\n        }\n    \t//è®¡ç®—å‡ºæ¥çš„é˜ˆå€¼èµ‹å€¼\n        threshold = newThr;\n        @SuppressWarnings({\"rawtypes\",\"unchecked\"})\n        //æ ¹æ®ä¸Šè¾¹è®¡ç®—å¾—å‡ºçš„å®¹é‡ åˆ›å»ºæ–°çš„æ•°ç»„       \n    \tNode<K,V>[] newTab = (Node<K,V>[])new Node[newCap];\n    \t//èµ‹å€¼\n    \ttable = newTab;\n    \t//æ‰©å®¹æ“ä½œï¼Œåˆ¤æ–­ä¸ä¸ºç©ºè¯æ˜ä¸æ˜¯åˆå§‹åŒ–æ•°ç»„\n        if (oldTab != null) {\n            //éå†æ•°ç»„\n            for (int j = 0; j < oldCap; ++j) {\n                Node<K,V> e;\n                //åˆ¤æ–­å½“å‰ä¸‹æ ‡ä¸ºjçš„æ•°ç»„å¦‚æœä¸ä¸ºç©ºçš„è¯èµ‹å€¼ä¸ªeï¼Œè¿›è¡Œä¸‹ä¸€æ­¥æ“ä½œ\n                if ((e = oldTab[j]) != null) {\n                    //å°†æ•°ç»„ä½ç½®ç½®ç©º\n                    oldTab[j] = null;\n                    //åˆ¤æ–­æ˜¯å¦æœ‰ä¸‹ä¸ªèŠ‚ç‚¹\n                    if (e.next == null)\n                        //å¦‚æœæ²¡æœ‰ï¼Œå°±é‡æ–°è®¡ç®—åœ¨æ–°æ•°ç»„ä¸­çš„ä¸‹æ ‡å¹¶æ”¾è¿›å»\n                        newTab[e.hash & (newCap - 1)] = e;\n                   \t//æœ‰ä¸‹ä¸ªèŠ‚ç‚¹çš„æƒ…å†µï¼Œå¹¶ä¸”åˆ¤æ–­æ˜¯å¦å·²ç»æ ‘åŒ–\n                    else if (e instanceof TreeNode)\n                        //è¿›è¡Œçº¢é»‘æ ‘çš„æ“ä½œ\n                        ((TreeNode<K,V>)e).split(this, newTab, j, oldCap);\n                    //æœ‰ä¸‹ä¸ªèŠ‚ç‚¹çš„æƒ…å†µï¼Œå¹¶ä¸”æ²¡æœ‰æ ‘åŒ–ï¼ˆé“¾è¡¨å½¢å¼ï¼‰\n                    else {\n                        //æ¯”å¦‚è€æ•°ç»„å®¹é‡æ˜¯16ï¼Œé‚£ä¸‹æ ‡å°±ä¸º0-15\n                        //æ‰©å®¹æ“ä½œ*2ï¼Œå®¹é‡å°±å˜ä¸º32ï¼Œä¸‹æ ‡ä¸º0-31\n                        //ä½ä½ï¼š0-15ï¼Œé«˜ä½16-31\n                        //å®šä¹‰äº†å››ä¸ªå˜é‡\n                        //        ä½ä½å¤´          ä½ä½å°¾\n                        Node<K,V> loHead = null, loTail = null;\n                        //        é«˜ä½å¤´\t\t   é«˜ä½å°¾\n                        Node<K,V> hiHead = null, hiTail = null;\n                        //ä¸‹ä¸ªèŠ‚ç‚¹\n                        Node<K,V> next;\n                        //å¾ªç¯éå†\n                        do {\n                            //å–å‡ºnextèŠ‚ç‚¹\n                            next = e.next;\n                            //é€šè¿‡ ä¸æ“ä½œ è®¡ç®—å¾—å‡ºç»“æœä¸º0\n                            if ((e.hash & oldCap) == 0) {\n                                //å¦‚æœä½ä½å°¾ä¸ºnullï¼Œè¯æ˜å½“å‰æ•°ç»„ä½ç½®ä¸ºç©ºï¼Œæ²¡æœ‰ä»»ä½•æ•°æ®\n                                if (loTail == null)\n                                    //å°†eå€¼æ”¾å…¥ä½ä½å¤´\n                                    loHead = e;\n                                //ä½ä½å°¾ä¸ä¸ºnullï¼Œè¯æ˜å·²ç»æœ‰æ•°æ®äº†\n                                else\n                                    //å°†æ•°æ®æ”¾å…¥nextèŠ‚ç‚¹\n                                    loTail.next = e;\n                                //è®°å½•ä½ä½å°¾æ•°æ®\n                                loTail = e;\n                            }\n                            //é€šè¿‡ ä¸æ“ä½œ è®¡ç®—å¾—å‡ºç»“æœä¸ä¸º0\n                            else {\n                                 //å¦‚æœé«˜ä½å°¾ä¸ºnullï¼Œè¯æ˜å½“å‰æ•°ç»„ä½ç½®ä¸ºç©ºï¼Œæ²¡æœ‰ä»»ä½•æ•°æ®\n                                if (hiTail == null)\n                                    //å°†eå€¼æ”¾å…¥é«˜ä½å¤´\n                                    hiHead = e;\n                                //é«˜ä½å°¾ä¸ä¸ºnullï¼Œè¯æ˜å·²ç»æœ‰æ•°æ®äº†\n                                else\n                                    //å°†æ•°æ®æ”¾å…¥nextèŠ‚ç‚¹\n                                    hiTail.next = e;\n                               //è®°å½•é«˜ä½å°¾æ•°æ®\n                               \thiTail = e;\n                            }\n                            \n                        } \n                        //å¦‚æœeä¸ä¸ºç©ºï¼Œè¯æ˜æ²¡æœ‰åˆ°é“¾è¡¨å°¾éƒ¨ï¼Œç»§ç»­æ‰§è¡Œå¾ªç¯\n                        while ((e = next) != null);\n                        //ä½ä½å°¾å¦‚æœè®°å½•çš„æœ‰æ•°æ®ï¼Œæ˜¯é“¾è¡¨\n                        if (loTail != null) {\n                            //å°†ä¸‹ä¸€ä¸ªå…ƒç´ ç½®ç©º\n                            loTail.next = null;\n                            //å°†ä½ä½å¤´æ”¾å…¥æ–°æ•°ç»„çš„åŸä¸‹æ ‡ä½ç½®\n                            newTab[j] = loHead;\n                        }\n                        //é«˜ä½å°¾å¦‚æœè®°å½•çš„æœ‰æ•°æ®ï¼Œæ˜¯é“¾è¡¨\n                        if (hiTail != null) {\n                            //å°†ä¸‹ä¸€ä¸ªå…ƒç´ ç½®ç©º\n                            hiTail.next = null;\n                            //å°†é«˜ä½å¤´æ”¾å…¥æ–°æ•°ç»„çš„(åŸä¸‹æ ‡+åŸæ•°ç»„å®¹é‡)ä½ç½®\n                            newTab[j + oldCap] = hiHead;\n                        }\n                    }\n                }\n            }\n        }\n    \t//è¿”å›æ–°çš„æ•°ç»„å¯¹è±¡\n        return newTab;\n    }\n```\n  resize()çš„é€»è¾‘æ˜¯ï¼š\n- é¦–å…ˆåˆ¤æ–­oldCapæ˜¯å¦å¤§äº0ï¼Œå¦‚æœæ˜¯å¤§äº0é‚£ä¹ˆè¯´æ˜å·²ç»åˆå§‹åŒ–äº†ï¼Œå¦‚æœæ˜¯ç­‰äº0ä½†æ˜¯æœ‰é˜ˆå€¼ï¼Œè¯´æ˜å¯èƒ½æ˜¯é€šè¿‡removeå…‰äº†ï¼Œä¹Ÿå¯èƒ½æ˜¯åˆå§‹åŒ–çš„æ—¶å€™ä½¿ç”¨æœ‰å‚æ„é€ æ–¹æ³•ï¼Œæœ€åæ˜¯ç­‰äº0ä½†æ˜¯ä¹Ÿæ²¡æœ‰é˜ˆå€¼ï¼Œå¯¹åº”çš„æ˜¯æ— å‚æ„é€ æ–¹æ³•ï¼Œè¿™ä¸ªæ—¶å€™è¿˜æ²¡æœ‰çœŸæ­£ç»™hashmapç©ºé—´\n- å¤§äº0ï¼Œé‚£ä¹ˆå°±æ˜¯æ‰©å±•hashmapé•¿åº¦ä¸ºåŸæ¥ä¸¤å€ï¼ˆè¿™é‡Œæ˜¯å·¦ç§»ä¸€ä½ï¼Œä¹Ÿå°±æ˜¯*2ï¼‰ï¼Œé‚£ä¹ˆé˜ˆå€¼ä¹Ÿè·Ÿç€æ‰©å±•ï¼Œå¦‚æœç­‰äº0ä½†æ˜¯æœ‰é˜ˆå€¼ï¼Œé‚£ä¹ˆæ–°çš„é˜ˆå€¼ä¹Ÿæ˜¯åŸæ¥çš„ï¼Œå¦‚æœæ˜¯æ— å‚çš„åˆå§‹åŒ–ï¼Œé‚£ä¹ˆå°±æ˜¯é»˜è®¤çš„16ï¼Œé˜ˆå€¼16*0ï¼Œ75\n- å®Œæˆäº†æ–°æ•°ç»„é•¿åº¦å’Œæ–°é˜ˆå€¼çš„è®¡ç®—ï¼Œæ¥ç€å°±æ˜¯ç§»åŠ¨æ•°ç»„äº†ï¼Œæ–°å»ºä¸€ä¸ªæ–°é•¿åº¦çš„æ•°ç»„\n- åœ¨æ—§çš„æ•°ç»„é‡Œé¢éå†ï¼Œå¦‚æœä¸ä¸ºç©ºï¼Œè¯´æ˜è¦ç§»åŠ¨äº†ï¼Œå¦‚æœåç»­æ²¡æœ‰ï¼Œé‚£ä¹ˆç›´æ¥è¿›æ–°æ•°ç»„ï¼Œå¦‚æœè¿˜æœ‰åç»­ï¼Œå…ˆåˆ¤æ–­æ˜¯å¦æ˜¯çº¢é»‘æ ‘çš„TreeNodeèŠ‚ç‚¹ï¼Œæ˜¯çš„è¯å°±èµ°çº¢é»‘æ ‘çš„é€»è¾‘ï¼Œå¦‚æœä¸æ˜¯é‚£å°±è¯´æ˜æ˜¯é“¾è¡¨äº†\n- é“¾è¡¨çš„æ·»åŠ æœ‰ä¸¤ç§ï¼Œé¦–å…ˆæ–°å»ºä¸¤ä¸ªé“¾è¡¨ï¼Œä¸€ä¸ªæ˜¯éœ€è¦åŸå°ä¸åŠ¨æ”¾åœ¨æ–°é“¾è¡¨å¯¹åº”èŠ‚ç‚¹çš„ï¼Œå¦ä¸€ç»„æ˜¯æ”¾åœ¨$newTab[j + oldCap] = hiHead$ä¸­\n- å¦‚ä½•åˆ¤æ–­ç§»åŠ¨å‘¢ï¼Ÿè¿›è¡Œ$e.hash & oldCap$çš„åˆ¤æ–­ï¼Œè¿™ä¸ªè®¡ç®—çš„ç»“æœæ˜¯oldcapæœ€é«˜ä½çš„å€¼ï¼Œæˆ‘ä»¬æ”¾åœ¨tableæ•°ç»„é‡Œé¢çš„å“ˆå¸Œç¢°æ’éƒ½æ˜¯é€šè¿‡å–ä½™æ“ä½œï¼Œè¿™ä¸ªè®¡ç®—çš„æ˜¯oldcapçš„æœ€é«˜ä½åé¢çš„ä½æ•°ï¼Œæœ€é«˜ä½è¢«å¿½è§†äº†ï¼Œæ¯”å¦‚101010 & 001111å’Œ111010 & 001111ç»“æœéƒ½æ˜¯1010ï¼Œæ”¾åœ¨10çš„ä½ç½®ï¼Œå¯¹äºè¿™ä¸ªé“¾è¡¨æ¥è¯´æœ€é«˜ä½10å’Œ11çš„æ•ˆæœæ˜¯ä¸€æ ·çš„ï¼Œå› æ­¤ä¸ºäº†ç¼©çŸ­é“¾è¡¨ï¼ŒæŠŠè¿™ä¸€éƒ¨åˆ†è¿›è¡Œåˆ†å¼€æ˜¯å¾ˆæœ‰å¿…è¦çš„ï¼Œè¿™æ ·å°±å¯ä»¥æœ‰æ•ˆç¼©çŸ­é“¾è¡¨ã€‚\n- ç„¶åé€šè¿‡åˆ¤æ–­éå†è¿™ä¸ªé“¾è¡¨ï¼ŒæŒ‰ç…§ä¸Šé¢çš„æ¡ä»¶åˆ†åˆ«è¿›å…¥ä¸¤ä¸ªå¾…ç§»åŠ¨é“¾è¡¨ã€‚\n- æœ€åç§»åŠ¨é“¾è¡¨ï¼Œå®Œæˆæ‰©å®¹\n### å¼•ç”³ï¼šä¸ºä»€ä¹ˆHashMapçš„æ•°ç»„æ˜¯2çš„æ¬¡å¹‚\nå›ç­”è¿™ä¸ªé—®é¢˜å¯ä»¥çœ‹ä¸¤ä¸ªåˆ¤æ–­æ¡ä»¶\n1. (n - 1) & hashï¼Œnä¸ºæ•°ç»„é•¿åº¦\n2. e.hash & oldCapï¼ŒoldCapä¸ºæ•°ç»„é•¿åº¦\nå‚è€ƒå›ç­”ï¼š\n- å¯¹äºå–ä½™æ“ä½œï¼šè®¡ç®—ç´¢å¼•çš„æ•ˆç‡æ›´é«˜ï¼Œå¦‚æœæ˜¯2çš„næ¬¡å¹‚å¯ä»¥ç”¨ä½è¿ç®—ä»£æ›¿å–æ¨¡è¿ç®—\n- å¯¹äºè®¡ç®—æ–°ç´¢å¼•ï¼Œe.hash & oldCapå¯ä»¥è®¡ç®—é«˜ä½ï¼Œåˆ¤æ–­æ˜¯å¦è½¬ç§»åˆ°æ–°è¡¨ä¸‹ã€‚\n## Java1.7çš„HashMapæ­»å¾ªç¯é—®é¢˜\njdk7çš„çš„æ•°æ®ç»“æ„æ˜¯ï¼šæ•°ç»„+é“¾è¡¨\n\nåœ¨æ•°ç»„è¿›è¡Œæ‰©å®¹çš„æ—¶å€™ï¼Œå› ä¸ºé“¾è¡¨æ˜¯å¤´æ’æ³•ï¼Œåœ¨è¿›è¡Œæ•°æ®è¿ç§»çš„è¿‡ç¨‹ä¸­ï¼Œæœ‰å¯èƒ½å¯¼è‡´æ­»å¾ªç¯\n\n![image-20230428213115071](../img/Java/image-20230428213115071.png)\n\n- å˜é‡eæŒ‡å‘çš„æ˜¯éœ€è¦è¿ç§»çš„å¯¹è±¡\n- å˜é‡nextæŒ‡å‘çš„æ˜¯ä¸‹ä¸€ä¸ªéœ€è¦è¿ç§»çš„å¯¹è±¡\n- Jdk1.7ä¸­çš„é“¾è¡¨é‡‡ç”¨çš„å¤´æ’æ³•\n- åœ¨æ•°æ®è¿ç§»çš„è¿‡ç¨‹ä¸­å¹¶æ²¡æœ‰æ–°çš„å¯¹è±¡äº§ç”Ÿï¼Œåªæ˜¯æ”¹å˜äº†å¯¹è±¡çš„å¼•ç”¨\n\n\n\näº§ç”Ÿæ­»å¾ªç¯çš„è¿‡ç¨‹ï¼š\n\nçº¿ç¨‹1å’Œçº¿ç¨‹2çš„å˜é‡eå’Œnextéƒ½å¼•ç”¨äº†è¿™ä¸ªä¸¤ä¸ªèŠ‚ç‚¹\n\n![image-20230428213533483](../img/Java/image-20230428213533483.png)\n\nçº¿ç¨‹2æ‰©å®¹åï¼Œç”±äºå¤´æ’æ³•ï¼Œé“¾è¡¨é¡ºåºé¢ å€’ï¼Œä½†æ˜¯çº¿ç¨‹1çš„ä¸´æ—¶å˜é‡eå’Œnextè¿˜å¼•ç”¨äº†è¿™ä¸¤ä¸ªèŠ‚ç‚¹\n\n![image-20230428214732877](../img/Java/image-20230428214732877.png)\n\nç¬¬ä¸€æ¬¡å¾ªç¯\n\nç”±äºçº¿ç¨‹2è¿ç§»çš„æ—¶å€™ï¼Œå·²ç»æŠŠBçš„nextæ‰§è¡Œäº†A\n\n![image-20230428214806072](../img/Java/image-20230428214806072.png)\n\nç¬¬äºŒæ¬¡å¾ªç¯\n\n![image-20230428214908652](../img/Java/image-20230428214908652.png)\n\nç¬¬ä¸‰æ¬¡å¾ªç¯\n\n![image-20230428214937231](../img/Java/image-20230428214937231.png)\n\nå‚è€ƒå›ç­”ï¼š\n\nåœ¨jdk1.7çš„hashmapä¸­åœ¨æ•°ç»„è¿›è¡Œæ‰©å®¹çš„æ—¶å€™ï¼Œå› ä¸ºé“¾è¡¨æ˜¯å¤´æ’æ³•ï¼Œåœ¨è¿›è¡Œæ•°æ®è¿ç§»çš„è¿‡ç¨‹ä¸­ï¼Œæœ‰å¯èƒ½å¯¼è‡´æ­»å¾ªç¯\n\næ¯”å¦‚è¯´ï¼Œç°åœ¨æœ‰ä¸¤ä¸ªçº¿ç¨‹\n\nçº¿ç¨‹ä¸€ï¼šè¯»å–åˆ°å½“å‰çš„hashmapæ•°æ®ï¼Œæ•°æ®ä¸­ä¸€ä¸ªé“¾è¡¨ï¼Œåœ¨å‡†å¤‡æ‰©å®¹æ—¶ï¼Œçº¿ç¨‹äºŒä»‹å…¥\n\nçº¿ç¨‹äºŒï¼šä¹Ÿè¯»å–hashmapï¼Œç›´æ¥è¿›è¡Œæ‰©å®¹ã€‚å› ä¸ºæ˜¯å¤´æ’æ³•ï¼Œé“¾è¡¨çš„é¡ºåºä¼šè¿›è¡Œé¢ å€’è¿‡æ¥ã€‚æ¯”å¦‚åŸæ¥çš„é¡ºåºæ˜¯ABï¼Œæ‰©å®¹åçš„é¡ºåºæ˜¯BAï¼Œçº¿ç¨‹äºŒæ‰§è¡Œç»“æŸã€‚\n\nçº¿ç¨‹ä¸€ï¼šç»§ç»­æ‰§è¡Œçš„æ—¶å€™å°±ä¼šå‡ºç°æ­»å¾ªç¯çš„é—®é¢˜ã€‚\n\nçº¿ç¨‹ä¸€å…ˆå°†Aç§»å…¥æ–°çš„é“¾è¡¨ï¼Œå†å°†Bæ’å…¥åˆ°é“¾å¤´ï¼Œç”±äºå¦å¤–ä¸€ä¸ªçº¿ç¨‹çš„åŸå› ï¼ŒBçš„nextæŒ‡å‘äº†Aï¼Œ\n\næ‰€ä»¥B->A->B,å½¢æˆå¾ªç¯ã€‚\n\nå½“ç„¶ï¼ŒJDK 8 å°†æ‰©å®¹ç®—æ³•åšäº†è°ƒæ•´ï¼Œä¸å†å°†å…ƒç´ åŠ å…¥é“¾è¡¨å¤´ï¼ˆè€Œæ˜¯ä¿æŒä¸æ‰©å®¹å‰ä¸€æ ·çš„é¡ºåºï¼‰ï¼Œ**å°¾æ’æ³•**ï¼Œå°±é¿å…äº†jdk7ä¸­æ­»å¾ªç¯çš„é—®é¢˜ã€‚\n\n\n# LinkedHashMap\nLinkedHashMapç»§æ‰¿è‡ªHashMapï¼Œå®ç°äº†Mapæ¥å£ï¼ŒHashMapæ˜¯ä¸è®°å½•é¡ºåºçš„ï¼Œæœ‰çš„æ—¶å€™æˆ‘ä»¬éœ€è¦è®°ä½æ’å…¥çš„é¡ºåºï¼ŒLinkedHashMapé€šè¿‡ç»´æŠ¤ä¸€ä¸ªé“¾è¡¨æ¥è®°å½•é¡ºåºï¼Œå¯ä»¥æƒ³è±¡æˆæ¯æ’å…¥ä¸€ä¸ªåˆ°HashMapï¼Œé“¾è¡¨ä¹Ÿè¦æ’å…¥ä¸€ä¸ªä¿ç•™é¡ºåºã€‚\n```java\npublic class LinkedHashMap<K,V>\n    extends HashMap<K,V>\n    implements Map<K,V>\n```\n\n## æ•°æ®ç»“æ„\n  åœ¨1.8ç»´æŠ¤äº†ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œå®šä¹‰å¤´æŒ‡é’ˆå’Œå°¾æŒ‡é’ˆï¼Œæ¯ä¸€ä¸ªEntryéƒ½ä¼šæœ‰å‰é©±å’Œåç»§\n  ![](../img/Java/img_4.png)\n> è¿™æ˜¯æ–°çš„ Entryçš„æ•°æ®ç»“æ„ï¼Œç»§æ‰¿è‡ªHashMapçš„Nodeï¼Œå¤šäº†å‰é©±å’Œåç»§\n```java\n    /**\n     * LinkedHashMapä¸­çš„nodeç›´æ¥ç»§æ‰¿è‡ªHashMapä¸­çš„Nodeã€‚å¹¶ä¸”å¢åŠ äº†åŒå‘çš„æŒ‡é’ˆ\n     */\n    static class Entry<K,V> extends HashMap.Node<K,V> {\n        Entry<K,V> before, after;\n        Entry(int hash, K key, V value, Node<K,V> next) {\n            super(hash, key, value, next);\n        }\n    }\n```\n> LinkedHashMapå®šä¹‰äº†å¤´å°¾æŒ‡é’ˆï¼ŒaccessOrderæ˜¯ä¸€ä¸ªé‡è¦å˜é‡ï¼Œè®¾ç½®ä¸ºçœŸçš„è¯ï¼Œgetä¹Ÿä¼šä½¿å…ƒç´ ç§»åŠ¨åˆ°é“¾è¡¨æœ«å°¾ï¼Œå¯ä»¥ç”¨è¿™ä¸ªå˜é‡å®ç°**LRU**\n```java\n  /**\n     * å¤´æŒ‡é’ˆï¼ŒæŒ‡å‘ç¬¬ä¸€ä¸ªnode\n     */\n    transient LinkedHashMap.Entry<K,V> head;\n\n    /**\n     * å°¾æŒ‡é’ˆï¼ŒæŒ‡å‘æœ€åä¸€ä¸ªnode\n     */\n    transient LinkedHashMap.Entry<K,V> tail;\n\n    /**\n     * ä¸€ä¸ªæ¡ä»¶å˜é‡ï¼Œå®ƒæ§åˆ¶äº†æ˜¯å¦åœ¨getæ“ä½œåéœ€è¦å°†æ–°çš„getçš„èŠ‚ç‚¹é‡æ–°æ”¾åˆ°é“¾è¡¨çš„å°¾éƒ¨\n     * LinkedHashMapå¯ä»¥ç»´æŒäº†æ’å…¥çš„é¡ºåºï¼Œä½†æ˜¯è¿™ä¸ªé¡ºåºä¸æ˜¯ä¸å˜çš„ï¼Œå¯ä»¥è¢«getæ“ä½œæ‰“ä¹±ã€‚\n     *\n     * @serial\n     */\n    final boolean accessOrder;\n\n```\n## æ„é€ å‡½æ•°\n\n```java\n  /**\n     * Constructs an empty insertion-ordered <tt>LinkedHashMap</tt> instance\n     * with the specified initial capacity and load factor.\n     *\n     * @param  initialCapacity the initial capacity\n     * @param  loadFactor      the load factor\n     * @throws IllegalArgumentException if the initial capacity is negative\n     *         or the load factor is nonpositive\n     */\n    public LinkedHashMap(int initialCapacity, float loadFactor) {\n        super(initialCapacity, loadFactor);\n        accessOrder = false;\n    }\n\n    /**\n     * æ„é€ ä¸€ä¸ªç©ºçš„ï¼ŒæŒ‰æ’å…¥åºï¼ˆaccessOrder = falseï¼‰çš„LinkedHashMapï¼Œä½¿ç”¨é»˜è®¤åˆå§‹å¤§å°å’Œè´Ÿè½½å› å­0.75\n     */\n    public LinkedHashMap(int initialCapacity) {\n        super(initialCapacity);\n        accessOrder = false;\n    }\n\n    /**\n     * é»˜è®¤çš„æ— å‚æ„é€ å‡½æ•°ç»§æ‰¿è‡ªHashMapçš„æ— å‚æ„é€ ï¼Œé‚£ä¹ˆä¹Ÿæ˜¯åˆšå¼€å§‹æ‡’åŠ è½½\n     * ç›´åˆ°ç¬¬ä¸€ä¸ªå…ƒç´ è¿›æ¥æ‰ä¼šæœ‰åˆ†é…ç©ºé—´resizeä¸€æ¬¡\n     * é»˜è®¤ä¹Ÿæ˜¯accessOrderä¸ºå‡ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸èƒ½getæ”¹å˜é¡ºåº\n     */\n    public LinkedHashMap() {\n        super();\n        accessOrder = false;\n    }\n    \n    public LinkedHashMap(Map<? extends K, ? extends V> m) {\n        super();\n        accessOrder = false;\n        putMapEntries(m, false);\n    }\n\n    /**\n     * è¿™ä¸ªæ„é€ æ–¹æ³•æŒ‡å®šäº†accessOrder\n     * æ³¨æ„ç»†èŠ‚ï¼Œè¦é…ç½®accessOrderåªèƒ½ç”¨å®¹é‡å’Œè´Ÿè½½å› å­çš„æœ‰å‚æ„é€ æ–¹æ³•\n     */\n    public LinkedHashMap(int initialCapacity,\n                         float loadFactor,\n                         boolean accessOrder) {\n        super(initialCapacity, loadFactor);\n        this.accessOrder = accessOrder;\n    }\n\n```\n## Java1.7å’Œ1.8LinkedHashMapçš„åŒºåˆ«\n- 1.7ç‰ˆæœ¬çš„æ˜¯ç”¨çš„åŒå‘å¾ªç¯é“¾è¡¨ï¼Œç›¸æ¯”äºHashMapå¤šäº†ä¸¤ä¸ªå˜é‡ï¼Œä¸€ä¸ªæ˜¯å¤´èŠ‚ç‚¹ï¼Œå› ä¸ºæ˜¯åŒå‘å¾ªç¯é“¾è¡¨ï¼Œheadæ—¢å¯ä»¥æ˜¯å¤´ä¹Ÿå¯ä»¥æ˜¯å°¾ã€‚è¿˜æœ‰ä¸ªé¡ºåºçš„å˜é‡ï¼Œtrueæ˜¯é¡ºåºï¼Œfalseæ˜¯é€†åºï¼Œå¯¹äºé“¾è¡¨æ¥è¯´å°±æ˜¯å¤´æ’æ³•å’Œå°¾æ’æ³•çš„åŒºåˆ«ï¼Œå¤´æ’æ³•å°±æ˜¯é€†åºï¼Œå°¾æ’æ³•å°±æ˜¯é¡ºåº\n- 1.8ç”¨çš„æ˜¯åŒå‘é“¾è¡¨ï¼Œæ¥ä¸‹æ¥é‡ç‚¹ä»‹ç»\n## 1.8ç»´æŠ¤é“¾è¡¨çš„æ“ä½œ\n> å¯¹äºæ•°ç»„çš„æ’å…¥å’Œæ‰©å®¹ç»§æ‰¿è‡ªHashMapï¼Œä¸åœ¨èµ˜è¿°ã€‚ä¸»è¦ç ”ç©¶åŒå‘é“¾è¡¨å¦‚ä½•ç»´æŠ¤ã€‚\n### afterNodeRemoval\né¡¾åæ€ä¹‰ï¼Œåœ¨èŠ‚ç‚¹ç§»é™¤ä¹‹åè¦åšçš„äº‹æƒ…\n```java\n    //åœ¨èŠ‚ç‚¹åˆ é™¤åï¼Œç»´æŠ¤é“¾è¡¨ï¼Œä¼ å…¥åˆ é™¤çš„èŠ‚ç‚¹\n    void afterNodeRemoval(Node<K,V> e) { // unlink\n        //pæŒ‡å‘å¾…åˆ é™¤å…ƒç´ ï¼Œbæ‰§è¡Œå‰é©±ï¼Œaæ‰§è¡Œåé©±\n        LinkedHashMap.Entry<K,V> p =\n            (LinkedHashMap.Entry<K,V>)e, b = p.before, a = p.after;\n        //è¿™é‡Œæ‰§è¡ŒåŒå‘é“¾è¡¨åˆ é™¤pèŠ‚ç‚¹æ“ä½œï¼Œå¾ˆç®€å•ã€‚\n        p.before = p.after = null;\n        //å¦‚æœæ²¡æœ‰å‰é¢çš„èŠ‚ç‚¹ï¼Œé‚£è¿™ä¸ªå°±æ˜¯ç¬¬ä¸€ä¸ªï¼Œè¿™ä¸ªæ—¶å€™å…¨å±€çš„headæŒ‡é’ˆè¦ç»™å½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªä½œä¸ºå¤´èŠ‚ç‚¹\n        if (b == null)\n            head = a;\n        //å¦‚æœä¸æ˜¯ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼Œé‚£å°±å‰é¢èŠ‚ç‚¹çš„åç»§ä¸ºå½“å‰èŠ‚ç‚¹çš„åç»§\n        else\n            b.after = a;\n        //å¦‚æœæ²¡æœ‰åç»§çš„èŠ‚ç‚¹ï¼Œé‚£ä¹ˆå‰é¢çš„èŠ‚ç‚¹å°±è¦æ¥æ›¿æˆä¸ºå°¾èŠ‚ç‚¹\n        if (a == null)\n            tail = b;\n        //åŒç†\n        else\n            a.before = b;\n    }\n\n```\n### afterNodeAccess\næ ¹æ®accessOrderåˆ¤æ–­æ˜¯å¦è¦åœ¨getä¹‹åè¿›è¡Œè°ƒæ•´\n```java\n  //åœ¨èŠ‚ç‚¹è¢«è®¿é—®åæ ¹æ®accessOrderåˆ¤æ–­æ˜¯å¦éœ€è¦è°ƒæ•´é“¾è¡¨é¡ºåº\n//å°†èŠ‚ç‚¹æ”¾åœ¨æœ€åé¢\n    void afterNodeAccess(Node<K,V> e) { // move node to last\n        LinkedHashMap.Entry<K,V> last;\n        //å¦‚æœaccessOrderä¸ºfalseæˆ–è€…åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹äº†ï¼Œä»€ä¹ˆéƒ½ä¸åš\n        if (accessOrder && (last = tail) != e) {\n            //pæŒ‡å‘å¾…åˆ é™¤å…ƒç´ ï¼Œbæ‰§è¡Œå‰é©±ï¼Œaæ‰§è¡Œåé©±\n            LinkedHashMap.Entry<K,V> p =\n                (LinkedHashMap.Entry<K,V>)e, b = p.before, a = p.after;\n            //è¿™é‡Œæ‰§è¡ŒåŒå‘é“¾è¡¨åˆ é™¤æ“ä½œ\n            p.after = null;\n            if (b == null)\n                head = a;\n            else\n                b.after = a;\n            if (a != null)\n                a.before = b;\n            else\n                last = b;\n            //è¿™é‡Œæ‰§è¡Œå°†pæ”¾åˆ°å°¾éƒ¨\n            if (last == null)\n                head = p;\n            else {\n                p.before = last;\n                last.after = p;\n            }\n            tail = p;\n            //ä¿è¯å¹¶å‘è¯»å®‰å…¨ã€‚\n            ++modCount;\n        }\n    }\n```\n### afterNodeInsertion\nè¿™ä¸ªæ–¹æ³•æ˜¯åœ¨æ·»åŠ ä¹‹åçš„æ“ä½œï¼Œå¯ä»¥æƒ³è±¡æˆLRUï¼Œå½“å®¹é‡è¶…è¿‡é˜ˆå€¼çš„æ—¶å€™å¯ä»¥é‡å†™removeEldestEntryæ–¹æ³•è¿”å›trueï¼Œå°±ä¼šåˆ é™¤æœ€è€çš„ä¸€ä¸ªå…ƒç´ \n```java\nvoid afterNodeInsertion(boolean evict) { // possibly remove eldest\n    LinkedHashMap.Entry<K,V> first;\n    //removeEldestEntry(first)é»˜è®¤è¿”å›falseï¼Œæ‰€ä»¥afterNodeInsertionè¿™ä¸ªæ–¹æ³•å…¶å®å¹¶ä¸ä¼šæ‰§è¡Œ\n    if (evict && (first = head) != null && removeEldestEntry(first)) {\n        K key = first.key;\n        removeNode(hash(key), key, null, false, true);\n    }\n}\n\nprotected boolean removeEldestEntry(Map.Entry<K,V> eldest) {\n    return false;\n}\n\n```\n\n## getæ“ä½œ\n\n```java\n/**\n * è°ƒç”¨hashmapçš„getNodeæ–¹æ³•è·å–åˆ°å€¼ä¹‹åï¼Œç»´æŠ¤é“¾è¡¨\n * @param key\n * @return\n */\npublic V get(Object key) {\n    Node<K,V> e;\n    if ((e = getNode(hash(key), key)) == null)\n        return null;\n    //æ ¹æ®è¿™ä¸ªaccessOrderæ¥çœ‹æ˜¯å¦è¦æ›´æ–°é˜Ÿä¼\n    if (accessOrder)\n        afterNodeAccess(e);\n    return e.value;\n}\n\n```\n\n## putæ“ä½œ","tags":["Java"]},{"title":"Collectionsé›†åˆç¯‡-List","url":"/2024/03/26/Collectionsé›†åˆç¯‡-List/","content":"> ä»Šå¤©å¼€å§‹å­¦ä¹ JavaåŸºç¡€å…«è‚¡æ–‡ï¼Œå…ˆä»æˆ‘ç”¨çš„æœ€å¤šçš„ä¸€ä¸ªæ•°æ®ç»“æ„å¼€å§‹çœ‹èµ·ã€‚è™½ç„¶æˆ‘å­¦Javaæ¥è§¦äº†è¿™ä¸ªæ¦‚å¿µå¿«ä¸¤ä¸‰å¹´äº†ï¼Œä½†æ˜¯ä¸çœ‹æºç è¿˜æ˜¯ä¸çŸ¥é“ArrayListçš„å…·ä½“å®ç°ã€‚\n\n# Collections\n\né›†åˆåˆ†ä¸ºä¸¤å¤§ç±»ï¼ŒCollectionæ˜¯å•åˆ—é›†åˆï¼ŒåŒ…å«å¸¸ç”¨çš„Setï¼ŒListï¼ŒQueueç­‰ï¼Œå…¶ä¸­Seté‡Œé¢ä½¿ç”¨HashSetæ¯”è¾ƒå¤šï¼ŒListé‡Œé¢ä½¿ç”¨Arraylistæ¯”è¾ƒå¤šï¼ŒQueueä¸­æœ‰ä¸€ä¸ªä¼˜å…ˆé˜Ÿåˆ—PriorityQueueçš„æ¦‚å¿µã€‚\n\n- Setï¼šHashSetï¼ŒLinkedHashSetï¼ŒSortedSetå’Œç»§æ‰¿å…¶çš„TreeSet\n- Listï¼šArrayListï¼ŒLinkedListï¼ŒVector\n- Queueï¼šPriorityQueue\n\nè¿˜æœ‰ä¸€ç±»æ˜¯åŒåˆ—é›†åˆMapï¼Œä½¿ç”¨çš„æ¯”è¾ƒå¤šçš„æœ‰HashMapï¼ŒLinkedHashMapï¼ŒTreeMapï¼ŒHashTable\n\n![](../img/Java/img.png)\n\n## List\n\né¦–å…ˆæˆ‘ä»¬å…ˆå¤ä¹ ä¸€ä¸‹é¡ºåºå­˜å‚¨å’Œé“¾å¼å­˜å‚¨çš„åŒºåˆ«ä»¥åŠæ—¶é—´å¤æ‚åº¦å’Œç©ºé—´å¤æ‚åº¦ã€‚\n\n### é¡ºåºå­˜å‚¨ï¼š\n\næ”¯æŒéšæœºæŸ¥æ‰¾ï¼Œç©ºé—´è¿ç»­ï¼Œæ•°æ®å¯†åº¦å¤§ï¼ˆä¸åƒé“¾è¡¨é‚£æ ·æœ‰é¢å¤–çš„æŒ‡é’ˆç©ºé—´ï¼‰ï¼Œåˆ é™¤å’Œæ’å…¥éº»çƒ¦ï¼Œä¸é€‚åˆé¢‘ç¹åœ¨å…¶ä¸­åˆ é™¤æ’å…¥\n\n- æ’å…¥ï¼šå¦‚æœåœ¨è¡¨å°¾å°±ä¸éœ€è¦ç§»åŠ¨å…ƒç´ ä¸ºo(1)ï¼Œå¦‚æœæ˜¯åœ¨å†…éƒ¨ï¼Œéœ€è¦ç§»åŠ¨çš„æœŸæœ›ä¸º (1+2+3+...+n)/(n+1) = n(n+1)/2(n+1) = n/2ï¼Œæ—¶é—´å¤æ‚åº¦ä¸ºo(n)ã€‚\n- åˆ é™¤ï¼šå¦‚æœåœ¨è¡¨å°¾åˆ é™¤ä¹Ÿä¸ç”¨ç§»åŠ¨ï¼Œå¦‚æœåœ¨å†…éƒ¨ï¼ŒæœŸæœ›ä¸º (1+2+...+n-1)/n = n(n-1)/2n = (n-1)/2 ä¹Ÿæ˜¯o(n)\n- æŸ¥æ‰¾ï¼šå¹³å‡æŸ¥æ‰¾æœŸæœ› (1+2+..+n)/n = (n+1)/2 ä¹Ÿä¸ºo(n)\n\n### é“¾å¼å­˜å‚¨ï¼š\n\nä¸æ”¯æŒéšæœºæŸ¥æ‰¾ï¼Œä½†æ˜¯ç›¸å¯¹äºé¡ºåºçš„æ’å…¥å’Œåˆ é™¤æ•ˆç‡è¿˜æ˜¯é«˜é‚£ä¹ˆä¸€ç‚¹ï¼Œç©ºé—´ä¸è¿ç»­ï¼Œæ•°æ®çš„å¯†åº¦å°ï¼Œå› ä¸ºè¦å­˜æŒ‡é’ˆã€‚\n\n- æ’å…¥ï¼šæ’å…¥è¿™ä¸ªæ“ä½œæœ¬èº«æ˜¯o(1)çš„åªéœ€è¦æ”¹æŒ‡é’ˆï¼Œä½†æ˜¯è¦æ‰¾åˆ°è¿™ä¸ªæ’å…¥çš„ä½ç½®æ˜¯éœ€è¦o(n)ï¼Œåˆ é™¤åŒç†ã€‚\n- æŸ¥æ‰¾ï¼šä¸æ”¯æŒéšæœºæŸ¥æ‰¾ï¼Œæ¯æ¬¡æ‰¾éƒ½éœ€è¦ä»å¤´å¼€å§‹æ‰¾(åŒå‘é“¾è¡¨å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜)ï¼Œä¹Ÿæ˜¯o(n)\n\n### ArrayList\n\n> ArrayListå’ŒVectoræ˜¯åŸºäºæ•°ç»„å®ç°çš„ï¼Œä½†æ˜¯æ˜¯åŠ¨æ€çš„ï¼Œæ¯æ¬¡æ·»åŠ ä¹‹å‰éƒ½è¦åˆ¤æ–­æ˜¯å¦ä¸‹ä¸€ä¸ªå°±è¦è¶…è¿‡äº†ï¼Œå¦‚æœæº¢å‡ºå°±è¦é‡æ–°å¼€è¾Ÿä¸€ä¸ªæ›´é•¿çš„æ•°ç»„ã€‚\n\n#### æˆå‘˜å˜é‡\n\n```java\n/**\n * é»˜è®¤çš„åˆå§‹å®¹é‡ä¸º10\n */\nprivate static final int DEFAULT_CAPACITY = 10;\n/**\n * å¦‚æœåˆå§‹åŒ–ä¸ºnew ArrayList(n)ï¼Œä½†æ˜¯è¿˜æ²¡æœ‰åœ¨è¿™ä¸ªé‡Œé¢åŠ ä¸œè¥¿çš„æ—¶å€™ï¼ŒelementDataå°±æ˜¯è¿™ä¸ª\n */\nprivate static final Object[] EMPTY_ELEMENTDATA = {};\n/**\n * å¦‚æœåˆå§‹åŒ–ä¸ºnew ArrayList()ï¼Œä½†æ˜¯è¿˜æ²¡æœ‰å…ƒç´ æ·»åŠ çš„æ—¶å€™ï¼Œå°±æ˜¯è¿™ä¸ªDefaultï¼Œä¸ºäº†å’Œä¸Šé¢çš„åŒºåˆ†å¼€\n */\nprivate static final Object[] DEFAULTCAPACITY_EMPTY_ELEMENTDATA = {};\n/**\n * å®é™…å­˜å‚¨çš„æ•°ç»„ç»“æ„\n */\ntransient Object[] elementData;\n\nprivate int size;\n```\n\n#### æ„é€ æ–¹æ³•\n>å½“initialCapacityç»™äº†æ˜¯0æˆ–è€…æ²¡æœ‰æä¾›çš„æ—¶å€™ï¼Œä¸è¿›è¡Œå®ä¾‹åŒ–ï¼Œç­‰åˆ°æœ‰å…ƒç´ è¿›æ¥äº†åœ¨è¿›è¡Œæ‰©å®¹\n```java\n/**\n * æœ‰å‚æ•°çš„ï¼šåªè¦æœ‰è¿™ä¸ªå‚æ•°å°±æ˜¯EMPTY_ELEMENTDATAï¼Œè·Ÿä¸‹é¢è¿™ä¸ªåŒºåˆ†å¼€\n * å¯ä»¥æŒ‰ç…§æŒ‡å®šå®¹é‡åˆå§‹åŒ–\n */\npublic ArrayList(int initialCapacity) {\n    if (initialCapacity > 0) {\n        this.elementData = new Object[initialCapacity];\n    } else if (initialCapacity == 0) {\n        this.elementData = EMPTY_ELEMENTDATA;\n    } else {\n        throw new IllegalArgumentException(\"Illegal Capacity: \"+\n                                           initialCapacity);\n    }\n}\n\n/**\n * æ— å‚æ•°æ„é€ æ–¹æ³•ï¼šDEFAULTCAPACITY_EMPTY_ELEMENTDATAæ¥åŒºåˆ†\n */\npublic ArrayList() {\n    this.elementData = DEFAULTCAPACITY_EMPTY_ELEMENTDATA;\n}\n\n\n```\n\n#### addæ·»åŠ æ–¹æ³•æµç¨‹\n\n```java\npublic boolean add(E e) {\n    //æ¯ä¸€æ¬¡åŠ ä¹‹å‰å…ˆæ£€æŸ¥size+1ä¸ä¼šå¤§äºæ•°ç»„æœ€å¤§å€¼\n    ensureCapacityInternal(size + 1);  // Increments modCount!!\n    elementData[size++] = e;\n    return true;\n}\n```\n\n```java\nprivate void ensureCapacityInternal(int minCapacity) {\n    //calculateCapacity(elementData, minCapacity)å¦‚æœæ˜¯æ— å‚çš„è¿”å›å°±æ˜¯10\n    //å¦‚æœä¸æ˜¯è¿”å›çš„å°±æ˜¯minCapacity\n    ensureExplicitCapacity(calculateCapacity(elementData, minCapacity));\n}\n```\n\n\n```java\nprivate static int calculateCapacity(Object[] elementData, int minCapacity) {\n    //å¦‚æœæ˜¯æ— å‚çš„åˆå§‹åŒ–ï¼Œé‚£ä¹ˆå°±åœ¨å½“å‰è¿™ä¸ªå®¹é‡å’Œ10ä¹‹é—´é€‰ä¸€ä¸ªæœ€å¤§çš„\n    //ä½†æ˜¯ä¸€èˆ¬æ¥è¯´ç¬¬ä¸€ä¸ªå…ƒç´ sizeè‚¯å®šæ˜¯0å§ï¼Œè¿™é‡Œä¼ æ¥çš„minCapacityä¼°è®¡æ˜¯1\n    //æ‰€ä»¥ç¬¬ä¸€æ¬¡åº”è¯¥æ˜¯åˆå§‹åŒ–10ä¸ªï¼Œå¯¹äºæ— å‚æ„é€ æ–¹æ³•è€Œè¨€\n    if (elementData == DEFAULTCAPACITY_EMPTY_ELEMENTDATA) {\n        return Math.max(DEFAULT_CAPACITY, minCapacity);\n    }\n    return minCapacity;\n}\n```\n\n\n```java\nprivate void ensureExplicitCapacity(int minCapacity) {\n    //æ“ä½œæ¬¡æ•°ï¼Œä¸€ä¸ªå†…éƒ¨å˜é‡\n    modCount++;\n\n    // overflow-conscious code\n    //å¦‚æœæœ‰å¢å¤§çš„éœ€æ±‚ï¼Œå³ç°åœ¨çš„éœ€æ±‚å·²ç»æ¯”ç°é•¿åº¦å¤§äº†\n    if (minCapacity - elementData.length > 0)\n        grow(minCapacity);\n}\n```\n\n```java\nprivate void grow(int minCapacity) {\n    // overflow-conscious code\n    int oldCapacity = elementData.length;\n    //1.5å€ï¼ŒoldCapacityå³ç§»ä¸€ä½ä»£è¡¨/2ï¼Œ1+0.5\n    int newCapacity = oldCapacity + (oldCapacity >> 1);\n    //åªæœ‰ç¬¬ä¸€æ¬¡ä¼šè¿™æ ·minCapacityç»™çš„æ˜¯10ï¼Œè¿™ä¸ªè‚¯å®šæ˜¯<0\n    if (newCapacity - minCapacity < 0)\n        newCapacity = minCapacity;\n    if (newCapacity - MAX_ARRAY_SIZE > 0)\n        newCapacity = hugeCapacity(minCapacity);\n    // minCapacity is usually close to size, so this is a win:\n    //ç„¶åæ‹·è´ä¸€ä»½è¿™ä¸ªæ•°ç»„\n    elementData = Arrays.copyOf(elementData, newCapacity);\n}\n```\n\n#### ArrayListçš„çº¿ç¨‹ä¸å®‰å…¨é—®é¢˜\n\n> ArrayListä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„\n> \n> - éåŒæ­¥æ“ä½œï¼š ArrayList çš„æ–¹æ³•å¹¶æ²¡æœ‰è¿›è¡ŒåŒæ­¥å¤„ç†ï¼Œå› æ­¤åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œå¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶è®¿é—®å’Œä¿®æ”¹ ArrayList çš„çŠ¶æ€ã€‚\n> - ä¸ä¿è¯æ“ä½œçš„åŸå­æ€§ï¼š ArrayList çš„æ“ä½œï¼ˆä¾‹å¦‚æ·»åŠ ã€åˆ é™¤ã€ä¿®æ”¹å…ƒç´ ç­‰ï¼‰å¹¶ä¸æ˜¯åŸå­æ“ä½œï¼Œå®ƒä»¬å¯èƒ½ä¼šåˆ†è§£æˆå¤šä¸ªæ­¥éª¤ã€‚åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹åœ¨æ‰§è¡Œæ“ä½œçš„è¿‡ç¨‹ä¸­è¢«å¦ä¸€ä¸ªçº¿ç¨‹ä¸­æ–­ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µå‘ç”Ÿ\n> - è¿­ä»£å™¨ä¸æ”¯æŒå¹¶å‘ä¿®æ”¹ï¼š åœ¨ä½¿ç”¨è¿­ä»£å™¨éå† ArrayList çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœå…¶ä»–çº¿ç¨‹å¯¹ ArrayList è¿›è¡Œäº†ç»“æ„æ€§ä¿®æ”¹ï¼ˆå¦‚æ·»åŠ æˆ–åˆ é™¤å…ƒç´ ï¼‰ï¼Œåˆ™ä¼šæŠ›å‡º ConcurrentModificationException å¼‚å¸¸\n\n>ä¸¾ä¸ªä¾‹å­ï¼Œè¿™é‡Œä¼šæŠ¥é”™ï¼ŒCopyOnWriteArrayListå°±ä¸ä¼š\n```java\npublic static void main(String[] args) {\n    ArrayListTest arrayListTest = new ArrayListTest();\n    VectorTest vectorTest = new VectorTest();\n    for (int i = 0; i < 10; i++) {\n        new Thread(() -> {\n            for (int j = 0; j < 1000; j++) {\n                arrayListTest.insert(j);\n            }\n            System.out.println(arrayListTest.getSize());\n        }).start();\n    }\n\n    // ç­‰å¾…æ‰€æœ‰çº¿ç¨‹æ‰§è¡Œå®Œæ¯•\n    try {\n        Thread.sleep(1000);\n    } catch (InterruptedException e) {\n        e.printStackTrace();\n    }\n}\n```\næœ‰å‡ ç§è§£å†³æ–¹æ³•\n\n- CopyOnWriteArrayListï¼šä½¿ç”¨ java.util.concurrent åŒ…ä¸­æä¾›çš„çº¿ç¨‹å®‰å…¨çš„é›†åˆç±»ï¼Œä¾‹å¦‚ CopyOnWriteArrayListï¼Œå®ƒé€šè¿‡åœ¨å†™æ“ä½œæ—¶å¤åˆ¶æ•´ä¸ªæ•°ç»„æ¥å®ç°çº¿ç¨‹å®‰å…¨ï¼Œé€‚ç”¨äºè¯»å¤šå†™å°‘çš„åœºæ™¯ã€‚\n\n```java\nList<String> threadSafeList = new CopyOnWriteArrayList<>();\n\n```\n- ä½¿ç”¨åŒæ­¥æœºåˆ¶ï¼š ä½¿ç”¨ Collections å·¥å…·ç±»æä¾›çš„ synchronizedList æ–¹æ³•ï¼Œå°† ArrayList åŒ…è£…æˆä¸€ä¸ªåŒæ­¥çš„ Listï¼Œè¿™æ ·å¯ä»¥ä¿è¯åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹å¯¹ ArrayList çš„æ“ä½œæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä½†æ€§èƒ½å¯èƒ½ä¼šå—åˆ°å½±å“ã€‚\n```java\nList<String> synchronizedList = Collections.synchronizedList(new ArrayList<>());\n\n```\n\n### å‡ ä¸ªé¢è¯•é¢˜\n\n#### new ArrayList(10)growäº†å‡ æ¬¡\n\nç­”ï¼š0æ¬¡ï¼Œå› ä¸ºè¿™ä¸ªåœ¨æœ‰å‚æ„é€ å‡½æ•°é‡Œé¢å·²ç»æœ‰äº†\n\n#### new ArrayList(0)å’Œnew ArrayList()åœ¨ç¬¬ä¸€æ¬¡æ‰©å®¹åéƒ½æ˜¯å¤šå°‘\n\nnew ArrayList()å’Œnew ArrayList(0)æ‰§è¡Œå®Œä¹‹åelementDataéƒ½æ˜¯ç©ºæ•°ç»„ï¼Œä½†æ˜¯è¿™ä¸¤ä¸ªç©ºæ•°ç»„çš„å†…å­˜åœ°å€æ˜¯ä¸ä¸€æ ·çš„ã€‚if (elementData == DEFAULTCAPACITY_EMPTY_ELEMENTDATA) è¿™ä¸€æ®µä»£ç åœ¨new(0)çš„æ—¶å€™æ˜¯ä¸ä¼šèµ°çš„ï¼Œå› ä¸ºæ¯”çš„æ˜¯åœ°å€ï¼Œæ‰€ä»¥è¿”å›å€¼æ˜¯1ï¼Œæœ€åç»“æœä¹Ÿæ˜¯1\næ‰€ä»¥new ArrayList(0)ç¬¬ä¸€æ¬¡æ‰©å®¹æ˜¯1ï¼Œnew ArrayList()ç¬¬ä¸€æ¬¡æ‰©å®¹æ˜¯10\n\n#### æ•°ç»„å’Œlistä¹‹é—´çš„è½¬æ¢ï¼Ÿ\n\n>æ•°ç»„->list:Arrays.asList()\n> \n>list->æ•°ç»„: list.toArray(n)\n\n- æ•°ç»„è½¬List ï¼Œä½¿ç”¨JDKä¸­java.util.Arrayså·¥å…·ç±»çš„asListæ–¹æ³•\n\n- Listè½¬æ•°ç»„ï¼Œä½¿ç”¨Listçš„toArrayæ–¹æ³•ã€‚æ— å‚toArrayæ–¹æ³•è¿”å› Objectæ•°ç»„ï¼Œä¼ å…¥åˆå§‹åŒ–é•¿åº¦çš„æ•°ç»„å¯¹è±¡ï¼Œè¿”å›è¯¥å¯¹è±¡æ•°ç»„\n\n#### ç”¨Arrays.asListè½¬Liståï¼Œå¦‚æœä¿®æ”¹äº†æ•°ç»„å†…å®¹ï¼Œlistå—å½±å“å—\n\nArrays.asListè½¬æ¢listä¹‹åï¼Œå¦‚æœä¿®æ”¹äº†æ•°ç»„çš„å†…å®¹ï¼Œlistä¼šå—å½±å“ï¼Œ\nå› ä¸ºå®ƒçš„åº•å±‚ä½¿ç”¨çš„Arraysç±»ä¸­çš„ä¸€ä¸ªå†…éƒ¨ç±»ArrayListæ¥æ„é€ çš„é›†åˆï¼Œ\nåœ¨è¿™ä¸ªé›†åˆçš„æ„é€ å™¨ä¸­ï¼ŒæŠŠæˆ‘ä»¬ä¼ å…¥çš„è¿™ä¸ªé›†åˆè¿›è¡Œäº†åŒ…è£…è€Œå·²ï¼Œæœ€ç»ˆæŒ‡å‘çš„éƒ½æ˜¯åŒä¸€ä¸ªå†…å­˜åœ°å€\n\n#### Listç”¨toArrayè½¬æ•°ç»„åï¼Œå¦‚æœä¿®æ”¹äº†Listå†…å®¹ï¼Œæ•°ç»„å—å½±å“å—\n\nlistç”¨äº†toArrayè½¬æ•°ç»„åï¼Œå¦‚æœä¿®æ”¹äº†listå†…å®¹ï¼Œæ•°ç»„ä¸ä¼šå½±å“ï¼Œå½“è°ƒç”¨äº†toArrayä»¥åï¼Œåœ¨åº•å±‚æ˜¯å®ƒæ˜¯è¿›è¡Œäº†æ•°ç»„çš„æ‹·è´ï¼Œè·ŸåŸæ¥çš„å…ƒç´ å°±æ²¡å•¥å…³ç³»äº†ï¼Œæ‰€ä»¥å³ä½¿listä¿®æ”¹äº†ä»¥åï¼Œæ•°ç»„ä¹Ÿä¸å—å½±å“\n\n## LinkedList\n\nç‰¹ç‚¹ï¼š\n- åŸºäºåŒå‘é“¾è¡¨å®ç°\n- ä¹Ÿç¬¦åˆé“¾å¼å­˜å‚¨çš„ä¸€ç³»åˆ—ä¼˜ç¼ºç‚¹\n- çº¿ç¨‹ä¸å®‰å…¨ï¼Œå› ä¸ºæ˜¯é“¾è¡¨ï¼Œå¦‚ä½•å®‰å…¨å‘¢ï¼Œè·Ÿä¸Šé¢çš„ArrayListä¸€æ ·ä½¿ç”¨Collections.synchronizedList(new ArrayList<>());\n\n## Vector\n\nç‰¹ç‚¹ï¼š\n- ä¹Ÿæ˜¯åŸºäºé¡ºåºå­˜å‚¨ï¼ˆæ•°ç»„ç»“æ„ï¼‰ï¼Œä½†æ˜¯å¢é•¿çš„ç­–ç•¥ä¸ArrayListä¸åŒï¼Œè€Œä¸”æ¯æ¬¡å¢é•¿2å€\n- çº¿ç¨‹å®‰å…¨ï¼Œè¿™ä½¿å…¶æ€§èƒ½ç•¥é€ŠäºArrayList\n- Stackæ˜¯åŸºäºVectorçš„\n\n## å¯¹æ¯”\n\n\n| åç§°         | åŸºäºæ•°æ®ç»“æ„ | çº¿ç¨‹æ˜¯å¦å®‰å…¨ |\n|------------|--------|--------|\n| ArrayList  | æ•°ç»„     | å¦      |\n| Vector     | æ•°ç»„     | æ˜¯      |\n| LinkedList | åŒå‘é“¾è¡¨   | å¦      |\n","tags":["Java"]},{"title":"leetcode-2024-3-26","url":"/2024/03/26/leetcode-2024-3-26/","content":"# 2642 è®¾è®¡å¯ä»¥æ±‚æœ€çŸ­è·¯å¾„çš„å›¾ç±»ï¼ˆHardï¼‰\n>é¢˜ç›®å¤ªé•¿äº†å°±æ¢æˆå›¾ç‰‡äº†\n\n![](../img/coding/2024_3_26_1.png)\n\n## è¿ªæ°æ–¯ç‰¹æ‹‰\n> æˆ‘è‡ªå·±çš„åšæ³•æ˜¯Dijkstra+é‚»æ¥çŸ©é˜µï¼Œè¿˜å¯ä»¥æœ‰Floydï¼Œè€ƒè™‘åˆ°è¿™ä¸ªé‚»æ¥çŸ©é˜µéƒ½å·²ç»å†…å­˜99%äº†ï¼Œæ‰€ä»¥åº”è¯¥çŸ©é˜µ+Floydæ˜¯æœ€ä½³æ–¹æ¡ˆ\n\n> å°±å½“æ˜¯å¤ä¹ Dijkstraäº†\n```java\nclass Graph {\n\n    private int[][] matrix;\n    private int[] finalArr;\n    private int[] visited;\n    //ç”¨é‚»æ¥çŸ©é˜µè¡¨ç¤ºå›¾\n    public Graph(int n, int[][] edges) {\n        matrix = new int[n][n];\n        for (int i = 0; i < n; i++) {\n            for (int j = 0; j < n; j++) {\n                if (i != j){\n                    matrix[i][j] = Integer.MAX_VALUE;\n                }\n            }\n        }\n        for (int i = 0; i < edges.length; i++) {\n            matrix[edges[i][0]][edges[i][1]] = edges[i][2];\n        }\n    }\n    //å¢åŠ ä¸€æ¡è¾¹å°±æ˜¯å†æ”¹ä¸€ä¸ªå€¼\n    public void addEdge(int[] edge) {\n        matrix[edge[0]][edge[1]] = edge[2];\n    }\n\n    /**\n     * Dijkstraï¼Œnæ¬¡æ‰¾åˆ°nä¸ªæœ€çŸ­è·¯å¾„ï¼Œæ‰€ä»¥éœ€è¦ä¸€ä¸ªvisitedçŸ©é˜µä¿å­˜å·²ç»æ‰¾åˆ°æœ€çŸ­è·¯å¾„çš„ç‚¹\n     * finalArrå­˜æ”¾æœ€çŸ­è·¯å¾„ï¼Œåˆå§‹åŒ–ä¸ºåˆå§‹ç‚¹çš„é‚»æ¥æ•°ç»„ï¼Œæ¯æ¬¡æ‰¾åˆ°å…¶ä¸­æœ€å°çš„\n     * æ›´æ–°è·ç¦»\n     * @param node1\n     * @param node2\n     * @return\n     */\n    public int shortestPath(int node1, int node2) {\n        finalArr = matrix[node1].clone();\n        visited = new int[matrix.length];\n        //System.out.println(Arrays.toString(finalArr));\n        int k = node1;\n        for (int i = 0; i < matrix.length-1; i++) {\n            visited[k] = 1;\n            int[] adj = getMin(finalArr);\n            k = adj[0];\n            int price = adj[1];\n            //å¦‚æœè¿™é‡Œè¿”å›-1è¯´æ˜æ‰¾ä¸åˆ°æœ€å°å€¼ï¼Œæœ€å°å€¼éƒ½å·²ç»æ˜¯æ­£æ— ç©·äº†\n            //è¯´æ˜æ­¤æ—¶å…¶ä»–çš„éƒ½å·²ç»æœ€ä¼˜ï¼Œç›´æ¥è·³å‡ºå¾ªç¯\n            if (k ==-1){\n                break;\n            }\n            for (int j = 0; j < matrix.length; j++) {\n                if (matrix[k][j] != Integer.MAX_VALUE&&price != Integer.MAX_VALUE && visited[j] == 0 && matrix[k][j]+price < finalArr[j]){\n                    finalArr[j] = matrix[k][j]+price;\n                }\n            }\n            //System.out.println(Arrays.toString(finalArr));\n        }\n        if (finalArr[node2] == Integer.MAX_VALUE){\n            return -1;\n        }else {\n            return finalArr[node2];\n        }\n    }\n    public int[] getMin(int[] arr){\n        int min = Integer.MAX_VALUE;\n        int vexNum = -1;\n        for (int i = 0; i < arr.length; i++) {\n            if (visited[i] ==0 && arr[i] != 0){\n                if (arr[i] <min){\n                    min = arr[i];\n                    vexNum = i;\n                }\n            }\n        }\n        return new int[]{vexNum,min};\n    }\n}\n\n/**\n * Your Graph object will be instantiated and called as such:\n * Graph obj = new\n * Graph(n, edges);\n * obj.addEdge(edge);\n * int param_2 = obj.shortestPath(node1,node2);\n */\n```\n\n# çŸ©é˜µç½®é›¶ï¼ˆMediumï¼‰\n![](../img/coding/2024_3_26_2.png)\n## å¹¿åº¦ä¼˜å…ˆæœç´¢\n>å…¶å®æœ¬æ¥æ˜¯æƒ³å¤šæºå¹¿åº¦ä¼˜å…ˆæœç´¢çš„ï¼Œåæ¥å‘ç°å¥½åƒä¸ç”¨è¿™å¤æ‚ã€‚ç›´æ¥æš´åŠ›æ¯ä¸€è¡Œæ¯ä¸€åˆ—éƒ½å˜æˆ0å°±å¯ä»¥äº†\n```java\nclass Solution {\n    public void setZeroes(int[][] matrix) {\n        //å­˜å‚¨åœ¨é‡Œé¢æ‰¾åˆ°çš„0\n        List<int[]> points = new ArrayList<>();\n        for (int i = 0; i < matrix.length; i++) {\n            for (int j = 0; j < matrix[0].length; j++) {\n                if (matrix[i][j] == 0){\n                    points.add(new int[]{i,j});\n                }\n            }\n        }\n        //éå†æ¯ä¸€ä¸ª0ï¼Œä½¿å…¶æ¨ªç«–éƒ½å˜ä¸º0\n        for(int[] point:points){\n            for (int i = 0; i < matrix.length; i++) {\n                matrix[i][point[1]] = 0;\n            }\n            for (int j = 0; j < matrix[0].length; j++) {\n                matrix[point[0]][j] = 0;\n            }\n        }\n    }\n}\n```\nrowä¸ºè¡Œï¼Œcolä¸ºåˆ—\n\næ—¶é—´å¤æ‚åº¦ï¼šo(row*col)\n\nç©ºé—´å¤æ‚åº¦ï¼šo(row+col)\n\n# 130 è¢«å›´ç»•çš„åŒºåŸŸï¼ˆMediumï¼‰\n![](../img/coding/2024_3_26_3.png)\n## æ·±åº¦ä¼˜å…ˆæœç´¢\n> ä¸»è¦æ€è·¯æ˜¯ï¼Œé¦–å…ˆæ‰¾åˆ°ä¸€ä¸ªåŒºåŸŸå…ˆæŠŠå…¶å…¨éƒ¨å˜ä¸ºXï¼Œç”¨ä¸€ä¸ªæ•°ç»„ä¿å­˜ï¼Œå¦‚æœè¿™ä¸ªåŒºåŸŸé‡Œé¢åŒ…å«åœ¨è¾¹ç•Œçš„å—ï¼Œé‚£ä¹ˆè¿™ä¸ªæ•°ç»„ç”¨äºåç»­å†æŠŠä»–å˜ä¸ºO\n```java\nclass Solution {\n    List<int[]> points = new ArrayList<>();\n    List<List<int[]>> list = new ArrayList<>();\n    public void solve(char[][] board) {\n        for (int i = 0; i < board.length; i++) {\n            for (int j = 0; j < board[0].length; j++) {\n                if (board[i][j] == 'O'){\n                    points = new ArrayList<>();\n                    //å¦‚æœæœ‰é“¾æ¥åˆ°è¾¹ç•Œ,éšåæŠŠè¿™äº›æ”¹å›æ¥\n                    if (!dfs(board,i,j)){\n                        list.add(points);\n                    }\n                }\n            }\n        }\n        for (List<int[]> points:list){\n            for (int[] point:points){\n                board[point[0]][point[1]] = 'O';\n            }\n        }\n        //System.out.println(Arrays.deepToString(board));\n    }\n    //ä¸€ä¸ªåŒºåŸŸå—ï¼Œé¦–å…ˆå…¨éƒ¨å˜ä¸ºXï¼Œè¿”å›çœŸåœ¨åç»­æŠŠä»–å˜å›O\n    public boolean dfs(char[][] board,int i,int j){\n        if (board[i][j] == 'O'){\n            boolean temp = true;\n            points.add(new int[]{i,j});\n            board[i][j] = 'X';\n            if (i == 0||j==0||i==board.length-1||j==board[0].length-1){\n                temp = false;\n            }\n            if (i+1<=board.length-1){\n                temp &= dfs(board,i+1,j);\n            }\n            if (i-1 >=0){\n                temp &= dfs(board,i-1,j);\n            }\n            if (j+1 <= board[0].length-1){\n                temp &= dfs(board,i,j+1);\n            }\n            if (j-1 >= 0){\n                temp &= dfs(board,i,j-1);\n            }\n            return temp;\n        }\n        else {\n            return true;\n        }\n    }\n}\n```\næ—¶é—´å¤æ‚åº¦ï¼šo(m*n)\nç©ºé—´å¤æ‚åº¦ï¼šo(m*n)\n\n## è¿˜æœ‰ä¸¤é¢˜å¤ªç®€å•äº†æˆ‘å°±å½“å¤ä¹ äº†\n### æ’åºé“¾è¡¨\n### å¿«é€Ÿæ’åº\n```java\nclass Solution {\n    public int[] sortArray(int[] nums) {\n        quickSort(nums,0,nums.length-1);\n    \n        return nums;\n    }\n    public void quickSort(int[] nums,int head,int rear){\n        if (head < rear){\n            int mid = partition(nums,head,rear);\n            quickSort(nums,head,mid-1);\n            quickSort(nums,mid+1,rear);\n        }\n    }\n    public int partition(int[] arr,int head,int rear){\n        int temp = arr[head];\n        while(head < rear){\n            //ä¸»è¦æ˜¯è¦è®°å¾—è¿™é‡Œæ˜¯æ¯ä¸ªéƒ½è¦å¸¦=ï¼Œ\n            while (head < rear && arr[rear] >= temp){\n                rear--;\n            }\n            arr[head] = arr[rear];\n            while (head < rear && arr[head] <= temp){\n                head++;\n            }\n            arr[rear] = arr[head];\n        }\n        arr[head] = temp;\n        //System.out.println(Arrays.toString(arr));\n        return head;\n    }\n}\n```","tags":["åˆ·é¢˜ç¬”è®°"]},{"title":"leetcode-2024-3-25","url":"/2024/03/25/leetcode-2024-3-25/","content":"# 518 é›¶é’±å…‘æ¢2ï¼ˆMediumï¼‰\nç»™ä½ ä¸€ä¸ªæ•´æ•°æ•°ç»„ coins è¡¨ç¤ºä¸åŒé¢é¢çš„ç¡¬å¸ï¼Œå¦ç»™ä¸€ä¸ªæ•´æ•° amount è¡¨ç¤ºæ€»é‡‘é¢ã€‚\n\nè¯·ä½ è®¡ç®—å¹¶è¿”å›å¯ä»¥å‡‘æˆæ€»é‡‘é¢çš„ç¡¬å¸ç»„åˆæ•°ã€‚å¦‚æœä»»ä½•ç¡¬å¸ç»„åˆéƒ½æ— æ³•å‡‘å‡ºæ€»é‡‘é¢ï¼Œè¿”å› 0 ã€‚\n\nå‡è®¾æ¯ä¸€ç§é¢é¢çš„ç¡¬å¸æœ‰æ— é™ä¸ªã€‚\n\né¢˜ç›®æ•°æ®ä¿è¯ç»“æœç¬¦åˆ 32 ä½å¸¦ç¬¦å·æ•´æ•°ã€‚\n\n\n\nç¤ºä¾‹ 1ï¼š\n\nè¾“å…¥ï¼šamount = 5, coins = [1, 2, 5]\n\nè¾“å‡ºï¼š4\n\nè§£é‡Šï¼šæœ‰å››ç§æ–¹å¼å¯ä»¥å‡‘æˆæ€»é‡‘é¢ï¼š\n\n5=5\n\n5=2+2+1\n\n5=2+1+1+1\n\n5=1+1+1+1+1\n\n## å¾ˆæ„šè ¢çš„æš´åŠ›è§£ï¼šDFSï¼ˆ8/28ï¼‰\n> æœ€æç¬‘çš„æ˜¯æˆ‘ç‚¹äº†ä¸€ä¸ªè¿è¡Œï¼Œç„¶ååƒå®Œé¥­éƒ½æ²¡æœ‰ç®—å‡ºç»“æœæ¥ï¼Œæˆ‘æ„¿ç§°ä¹‹ä¸ºæœ€æš´åŠ›çš„ä¸€é›†\n\n> æœ¬æ„æ˜¯æ·±åº¦ä¼˜å…ˆæœç´¢ï¼Œç„¶åå°†è·¯å¾„ä¸Šçš„å€¼ä¿å­˜è¿›å“ˆå¸Œè¡¨ï¼Œå“ˆå¸Œè¡¨è®°å½•çš„æ˜¯ç¡¬å¸å’Œä¸ªæ•°ï¼Œå¦‚æœæœ€åèƒ½å…¨éƒ¨æ‰¾å®Œï¼Œå°±æŠŠå½“å‰å“ˆå¸Œè¡¨å­˜åˆ°seté‡Œé¢ï¼ˆå…¶å®è®©æˆ‘æ„æƒ³ä¸åˆ°çš„æ˜¯è¿™æ ·å­setä¹Ÿå¯ä»¥å»é‡ï¼‰\n\n> è¿™ç§æ–¹æ³•è¦é‡å¤è®¡ç®—å¤ªå¤šæ¬¡äº†ï¼Œå¯ä»¥ä¼˜åŒ–æˆå³è¾¹çš„æœ‰å‘æ— ç¯å›¾ï¼Œä½†æ˜¯å°±è¿™ä¸ªé¢˜è€Œè¨€å®Œå…¨æ²¡å¿…è¦è¿™ä¹ˆå¤æ‚ã€‚\n\n![](../img/coding/2024_3_25_1.png)\n```java\n//hashmapç”¨æ¥æ”¾å…·ä½“æ‰¾é›¶\nprivate HashMap<Integer,Integer> hashMap = new HashMap<>();\n//setå»é‡\nprivate Set<HashMap<Integer,Integer>> set = new HashSet<>();\npublic int change1(int amount, int[] coins) {\n    Arrays.sort(coins);\n    dfs(amount,coins);\n    return set.size();\n}\npublic void dfs(int amount,int[] coins){\n    //å¯ä»¥æ‰¾å®Œï¼Œæ”¾è¿›seté‡Œé¢\n    if (amount == 0){\n        set.add(new HashMap<>(hashMap));\n        return;\n    }\n    //ä¸èƒ½ç”¨å·²æœ‰çš„æ‰¾é›¶äº†ï¼Œå¤±è´¥\n    if (amount < coins[0]){\n        return;\n    }\n    //é€’å½’éå†æ¯ä¸€ç§æƒ…å†µ\n    for (int i = 0; i < coins.length; i++) {\n        //å…ˆåŠ å…¥hashmap\n        if (!hashMap.containsKey(coins[i])){\n            hashMap.put(coins[i],1);\n        }\n        else {\n            Integer integer = hashMap.get(coins[i]);\n            hashMap.replace(coins[i],integer+1);\n        }\n\n        dfs(amount-coins[i],coins);\n        //åç»­é€’å½’å†åˆ é™¤å›åˆ°ä¸Šä¸€å±‚ï¼Œä¿è¯æ¯ä¸ªå¾ªç¯éƒ½æ˜¯ä¸€æ ·çš„\n        int temp = hashMap.get(coins[i]);\n        if (temp == 1){\n            hashMap.remove(coins[i]);\n        }\n        else {\n            hashMap.put(coins[i],temp-1);\n        }\n    }\n}\n```\n\n## åŠ¨æ€è§„åˆ’ï¼ˆå…¶å®å°±æ˜¯è·³æˆ¿å­æ¸¸æˆï¼‰\n\n> é—®é¢˜ä¸€ï¼šæˆ‘å¯¹è¿™é“é¢˜çš„ä¸»è¦çº ç»“ç‚¹åœ¨äºï¼Œæ¯”å¦‚11ï¼Œç¡¬å¸æœ‰1ï¼Œ2ï¼Œ5ï¼Œç†åº”æ‰¾dp[10],dp[9],dp[6],ä½†æ˜¯æˆ‘ä»¬ä¸çŸ¥é“è¿™é‡Œé¢æ˜¯ä¸æ˜¯å¯èƒ½é€ æˆé‡å¤ï¼Œäº‹å®ä¸Šdp[9]é‡Œé¢è‚¯å®šä¹Ÿä¼šåªä½¿ç”¨ä¸€ä¸ª5ï¼Œå¯¹äºdp[6]çš„æƒ…å†µæ¥è¯´åªæ˜¯**æ”¹äº†é¡ºåº**\n\n> å¦‚ä½•è§£å†³ï¼Ÿæˆ‘ä»¬ä¸å†éå†11è€Œéå†ç¡¬å¸ï¼Œè¿™æ ·å°±èƒ½ä¿è¯åœ¨éå†åˆ°å½“å‰ç¡¬å¸ä¹‹å‰ä¸ä¼šæœ‰è¿™ä¸ªè·¯å¾„å‡ºç°ã€‚æ¯ä¸€æ¬¡éå†éƒ½æ˜¯å¦‚ä½•é€šè¿‡å½“å‰çš„è¿™ä¸ªç¡¬å¸æ¢åˆ°ç°åœ¨çš„é’±ï¼Œ\n> è‡ªç„¶è€Œç„¶å¾—åˆ°è½¬ç§»æ–¹ç¨‹ï¼Œdp[j] += dp[j-coins[i]];\n```java\nclass Solution {\n    public int change(int amount, int[] coins) {\n        int[] dp = new int[amount+1];\n        dp[0] = 1;\n        for (int i = 0; i < coins.length; i++) {\n            for (int j = coins[i]; j < dp.length; j++) {\n                dp[j] += dp[j-coins[i]];\n            }\n            \n        }\n\n        return dp[dp.length-1];\n    }\n}\n```\n>çœ‹å®Œåå…¶å®æ˜¯æœ‰æç„¶å¤§é›¾çš„æ„Ÿè§‰ï¼Œå¤šçœ‹å¤šå­¦ã€‚\n\n# åˆå¹¶Kä¸ªæœ‰åºé“¾è¡¨ï¼ˆHardï¼‰\n\nç»™ä½ ä¸€ä¸ªé“¾è¡¨æ•°ç»„ï¼Œæ¯ä¸ªé“¾è¡¨éƒ½å·²ç»æŒ‰å‡åºæ’åˆ—ã€‚\n\nè¯·ä½ å°†æ‰€æœ‰é“¾è¡¨åˆå¹¶åˆ°ä¸€ä¸ªå‡åºé“¾è¡¨ä¸­ï¼Œè¿”å›åˆå¹¶åçš„é“¾è¡¨ã€‚\n\n>å®åœ¨ä¸æ˜ç™½è¿™ä¸ªé¢˜æ€ä¹ˆä¼šæ˜¯hardï¼Œç»™æˆ‘åˆ·æˆ˜ç»©çš„é¢˜\n\n>å…¶å®è¿˜ä¸å¤Ÿå¿«ï¼Œå¦‚æœç”¨åˆ†æ²»æ³•å¯ä»¥logn\n\n## é˜Ÿåˆ—\n> ä¸¤ä¸¤åˆå¹¶ç„¶åå…¥é˜Ÿï¼Œç›´åˆ°é˜Ÿé‡Œé¢åªæœ‰ä¸€ä¸ªï¼Œå°±æ˜¯ç­”æ¡ˆ\n```java\nclass Solution {\n    public ListNode mergeKLists(ListNode[] lists) {\n        //åˆ¤æ–­æ˜¯å¦ä¸ºç©º\n        if (lists.length == 0){\n            return null;\n        }\n        Queue<ListNode> queue = new ArrayDeque<>();\n        for (int i = 0; i < lists.length; i++) {\n            if (lists[i] != null){\n                queue.add(lists[i]);\n            }\n        }\n        //è¿™é‡Œä¹Ÿè¢«å¡äº†ä¸€ä¸‹ï¼Œå¦‚æœé•¿åº¦æ˜¯0å°±ä¸èƒ½è¿›è¡Œä¸‹é¢çš„æ­¥éª¤\n        if (queue.isEmpty()){\n            return null;\n        }\n        while (queue.size() != 1){\n            ListNode listNode1 = queue.poll();\n            ListNode listNode2 = queue.poll();\n            if (listNode1 != null && listNode2 != null){\n                queue.add(merge(listNode1,listNode2));\n            }\n        }\n        return queue.poll();\n    }\n\n    /**\n     * ä¸¤ä¸ªé“¾è¡¨åˆå¹¶ï¼ŒåŸºæœ¬æ–¹æ³•\n     * @param listNode1\n     * @param listNode2\n     * @return\n     */\n    public ListNode merge(ListNode listNode1,ListNode listNode2){\n        //ç”¨äº†ä¸€ä¸ªå¤´èŠ‚ç‚¹æ–¹ä¾¿ä¿å­˜\n        ListNode temp = new ListNode();\n        ListNode ans = temp;\n        while (listNode1!=null && listNode2!=null){\n            if (listNode1.val <= listNode2.val){\n                temp.next = listNode1;\n                listNode1 = listNode1.next;\n            }\n            else {\n                temp.next = listNode2;\n                listNode2 = listNode2.next;\n            }\n            temp = temp.next;\n        }\n        //æ¥ä¸Šæ²¡éå†åˆ°çš„\n        if (listNode1 != null){\n            temp.next = listNode1;\n        }\n        if (listNode2 != null){\n            temp.next = listNode2;\n        }\n        return ans.next;\n    }\n\n}\n```\n\n# æœç´¢äºŒç»´çŸ©é˜µ2ï¼ˆMediumï¼‰\n\nç¼–å†™ä¸€ä¸ªé«˜æ•ˆçš„ç®—æ³•æ¥æœç´¢ m x n çŸ©é˜µ matrix ä¸­çš„ä¸€ä¸ªç›®æ ‡å€¼ target ã€‚è¯¥çŸ©é˜µå…·æœ‰ä»¥ä¸‹ç‰¹æ€§ï¼š\n\næ¯è¡Œçš„å…ƒç´ ä»å·¦åˆ°å³å‡åºæ’åˆ—ã€‚\n\næ¯åˆ—çš„å…ƒç´ ä»ä¸Šåˆ°ä¸‹å‡åºæ’åˆ—ã€‚\n\n![](../img/coding/2024_3_25_2.png)\n\n## äºŒç»´åŒæŒ‡é’ˆ\n>æˆ‘ä»¬å¯ä»¥è§‚å¯Ÿåˆ°ï¼Œä»ä¸‹å¾€ä¸Šæ•°æ¯ä¸€è¡Œç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œå¦‚æœæ¯”ç›®æ ‡å¤§å°±å¯ä»¥åˆ é™¤äº†ï¼ŒåŒç†æ¯ä¸€åˆ—ä»åå¾€å‰æ•°ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œå¦‚æœå¤§ä¹Ÿå¯ä»¥åˆ é™¤äº†ã€‚\n> è¿™æ ·å°±å¾—åˆ°äº†ä¸€ä¸ªæ–°çŸ©é˜µã€‚\n\n>æ¥ç€æ‰¾æ–°çŸ©é˜µæœ€åä¸€è¡Œçš„å…ƒç´ ï¼Œä»å‰å¾€åæ•°å¦‚æœæ¯”ç›®æ ‡å°ä¹Ÿå¯ä»¥åˆ é™¤äº†ï¼Œç„¶åæœ€åä¸€åˆ—ï¼Œä»ä¸Šåˆ°ä¸‹æ¯”ç›®æ ‡å°çš„ä¹Ÿå¯ä»¥åˆ é™¤ã€‚\n \n> è¿™æ ·å®Œæˆä¸€æ¬¡å¾ªç¯ï¼Œå‡å°‘äº†å¾ˆå¤§çš„æœç´¢èŒƒå›´ã€‚ä¸€ç›´æ”¶æ•›åˆ°åªæœ‰ä¸€è¡Œæˆ–è€…ä¸€åˆ—ã€‚\n\n>è¿™é‡Œç”¨äº†***å°æŠ€å·§***ï¼Œå¯¹äºæ‰¾ä¸åˆ°çš„å…ƒç´ è‚¯å®šæ˜¯ä¼š**æ•°ç»„ä¸‹æ ‡æŠ›å¼‚å¸¸**çš„ï¼Œcatchåˆ°äº†è‚¯å®šæ˜¯æ²¡æœ‰çš„ï¼Œè¿”å›å‡\n\n> è¿˜æœ‰æœ‰ä¸€ä¸ªå°é—®é¢˜ï¼Œå½“æˆ‘ä»¬é¢å¯¹[[5,6,9],[9,10,11],[11,14,18]]è¿™æ ·çš„æ•°ç»„ï¼Œæœ‰ä¸¤ä¸ª9ï¼Œè¿™æ—¶å€™æˆ‘ä»¬å°±æ°¸è¿œæ»¡è¶³ä¸äº†å¾ªç¯æ¡ä»¶å‡ºä¸æ¥äº†ï¼Œä¸ºäº†è§£å†³éœ€è¦çœ‹å¾ªç¯é‡Œé¢å››ä¸ªæŒ‡é’ˆæ˜¯å¦å˜åŒ–ï¼Œå¦‚æœæ²¡å˜å°±è¯´æ˜å‘ç”Ÿäº†è¿™ç§æƒ…å†µã€‚ç›´æ¥è·³å‡ºå¾ªç¯ã€‚è€Œå‡ºç°è¿™ç§æƒ…å†µçš„åŸå› å°±æ˜¯å› ä¸ºæœ‰ä¸¤ä¸ªä¸€æ ·çš„ç›®æ ‡å€¼ï¼Œé‚£è‚¯å®šè¿”å›çœŸã€‚\n```java\nclass Solution {\n    public boolean searchMatrix(int[][] matrix, int target) {\n        int row_top = 0,row_bottom = matrix.length-1,col_left = 0,col_right = matrix[0].length-1;\n        boolean flag = false;\n\n        try {\n            while (row_top < row_bottom && col_left < col_right){\n                //åˆ¤æ–­æ˜¯å¦æŒ‡é’ˆæœ‰å˜åŒ–\n                int temp = 0;\n                while (matrix[row_bottom][col_left] > target){\n                    temp++;\n                    row_bottom--;\n                }\n                while (matrix[row_top][col_right] > target){\n                    temp++;\n                    col_right--;\n                }\n                while (matrix[row_bottom][col_left] < target){\n                    temp++;\n                    col_left++;\n                }\n                while (matrix[row_top][col_right] <target){\n                    temp++;\n                    row_top++;\n                }\n                if (temp == 0){\n                    flag = true;\n                    break;\n                }\n\n            }\n            //System.out.println(row_top+\"  \"+row_bottom+\"  \"+col_left+\"  \"+col_right);\n            if (row_top == row_bottom){\n                for (int i = col_left; i <=col_right; i++) {\n                    if (matrix[row_bottom][i] == target){\n                        flag = true;\n                        break;\n                    }\n                }\n            }\n            if (col_left == col_right){\n                for (int i = row_top; i <= row_bottom; i++) {\n                    if (matrix[i][col_right] == target){\n                        flag = true;\n                        break;\n                    }\n                }\n            }\n            return flag;\n        }\n        //å°æŠ€å·§\n        catch (ArrayIndexOutOfBoundsException e){\n            return false;\n        }\n    }\n}\n```\n\nè¿™é“é¢˜åšå‡ºæ¥å…¶å®æœ‰ç‚¹ä¾¥å¹¸ï¼Œå¾ˆå¤šæƒ…å†µéƒ½æ˜¯é”™äº†ä»¥åè¯•éªŒå‡ºæ¥çš„ã€‚æ®ä»–ä»¬æ‰€è¯´è¿™æ ·è¿˜ä¸å¦‚éå†æ•´ä½“æ‰¾ç»“æœã€‚\n\n# 54 èºæ—‹çŸ©é˜µï¼ˆMediumï¼‰\n\nç»™ä½ ä¸€ä¸ª m è¡Œ n åˆ—çš„çŸ©é˜µ matrix ï¼Œè¯·æŒ‰ç…§ é¡ºæ—¶é’ˆèºæ—‹é¡ºåº ï¼Œè¿”å›çŸ©é˜µä¸­çš„æ‰€æœ‰å…ƒç´ ã€‚\n\n![](../img/coding/2024_3_25_3.png)\n\n> éå¸¸å¥½ç†è§£çš„ä¸€é“é¢˜ï¼Œæ ¹æ®ä¸Šä¸€é¢˜çš„æ€è·¯å¾ˆå¿«å°±èƒ½å†™å‡ºï¼Œä½†æ˜¯è¿™é‡Œä¸ç”¨é¢‘ç¹ç»´æŠ¤å››ä¸ªæŒ‡é’ˆï¼Œåªç”¨åœ¨å¾ªç¯æœ«å°¾ä½¿ç”¨å°±å¯ä»¥ã€‚\n\n> å°±è·Ÿæ´‹è‘±ä¸€æ ·ï¼Œæ¯æ¬¡éƒ½å‰¥æ‰æœ€å¤–ä¸€å±‚\n\n## åŒæŒ‡é’ˆ\n\n```java\nclass Solution {\n    public List<Integer> spiralOrder(int[][] matrix) {\n        List<Integer> ans = new ArrayList<>();\n        int row_top = 0,row_bottom = matrix.length-1,col_left = 0,col_right = matrix[0].length-1;\n        while (row_top < row_bottom && col_left < col_right){\n            for (int i = col_left; i < col_right; i++) {\n                ans.add(matrix[row_top][i]);\n            }\n            for (int i = row_top; i < row_bottom; i++) {\n                ans.add(matrix[i][col_right]);\n            }\n            for (int i = col_right; i > col_left ; i--) {\n                ans.add(matrix[row_bottom][i]);\n            }\n            for (int i = row_bottom; i > row_top; i--) {\n                ans.add(matrix[i][col_left]);\n            }\n            //æ¢åˆ°å†…å±‚\n            row_top++;\n            row_bottom--;\n            col_left++;\n            col_right--;\n        }\n        //ç‰¹åˆ¤ã€‚å¦‚æœéƒ½ç›¸ç­‰ï¼Œè¯´æ˜ä¸­é—´åªæœ‰ä¸€ä¸ªå…ƒç´ \n        if (row_top == row_bottom && col_left == col_right){\n            ans.add(matrix[row_top][col_right]);\n        }\n        else {\n            //ä¸€è¡Œ\n            if (row_top == row_bottom){\n                for (int i = col_left; i <= col_right; i++) {\n                    ans.add(matrix[row_top][i]);\n                }\n            }\n            //ä¸€åˆ—\n            if (col_left == col_right){\n                for (int i = row_top; i <= row_bottom; i++) {\n                    ans.add(matrix[i][col_left]);\n                }\n            }\n        }\n\n        return ans;\n    }\n}\n```\n\n# 59 èºæ—‹çŸ©é˜µ2ï¼ˆMediumï¼‰\nç»™ä½ ä¸€ä¸ªæ­£æ•´æ•° n ï¼Œç”Ÿæˆä¸€ä¸ªåŒ…å« 1 åˆ° n2 æ‰€æœ‰å…ƒç´ ï¼Œä¸”å…ƒç´ æŒ‰é¡ºæ—¶é’ˆé¡ºåºèºæ—‹æ’åˆ—çš„ n x n æ­£æ–¹å½¢çŸ©é˜µ matrix ã€‚\n\n![](../img/coding/2024_3_25_4.png)\n> è¿™ä¸ªæ¯”ä¸Šé¢çš„æ›´ç®€å•äº†ï¼Œä¸€ä¸ªè®¡æ•°å™¨ï¼Œç„¶åæ ¹æ®ä¸Šé¢çš„é€»è¾‘è½¬åœˆï¼Œæ¯æ¬¡éƒ½+1ï¼Œå°±å¯ä»¥äº†ï¼Œç”šè‡³æ²¡æœ‰ä¸­é—´æ˜¯ä¸€è¡Œæˆ–è€…ä¸€åˆ—çš„æƒ…å†µï¼Œè¦ä¸å°±æ˜¯æ²¡æœ‰è¦ä¸å°±åªæœ‰ä¸€ä¸ªã€‚\n```java\nclass Solution {\n    public int[][] generateMatrix(int n) {\n        int[][] matrix = new int[n][n];\n        int count = 1;\n        int row_top = 0,row_bottom = matrix.length-1,col_left = 0,col_right = matrix[0].length-1;\n        while (row_top < row_bottom && col_left < col_right){\n            for (int i = col_left; i < col_right; i++) {\n                matrix[row_top][i] = count++;\n            }\n            for (int i = row_top; i < row_bottom; i++) {\n                matrix[i][col_right]= count++;\n            }\n            for (int i = col_right; i > col_left ; i--) {\n                matrix[row_bottom][i]= count++;\n            }\n            for (int i = row_bottom; i > row_top; i--) {\n                matrix[i][col_left]= count++;\n            }\n            row_top++;\n            row_bottom--;\n            col_left++;\n            col_right--;\n        }\n        if (row_top == row_bottom && col_left == col_right){\n            matrix[row_top][col_right]= count++;\n        }\n        else {\n            if (row_top == row_bottom){\n                for (int i = col_left; i <= col_right; i++) {\n                    matrix[row_top][i]= count++;\n                }\n            }\n            if (col_left == col_right){\n                for (int i = row_top; i <= row_bottom; i++) {\n                    matrix[i][col_left]= count++;\n                }\n            }\n        }\n        return matrix;\n    }\n}\n```","tags":["åˆ·é¢˜ç¬”è®°"]},{"title":"å‘¨èµ›2024-3-24","url":"/2024/03/24/å‘¨èµ›2024-3-24/","content":">é™†é™†ç»­ç»­è¿™æ˜¯ç¬¬ä¸‰æ¬¡å‘¨èµ›ï¼Œç¬¬ä¸€æ¬¡æ˜¯è™šæ‹Ÿçš„æˆ‘çå†™acäº†ä¸¤é¢˜ï¼Œä¸Šä¸€æ¬¡ä¹Ÿæ˜¯acä¸¤é¢˜å› ä¸ºèµ·å¾—å¤ªæ™šäº†ã€‚è¿™æ¬¡ç¨å¾®ä¸€ç‚¹ç‚¹è¿›æ­¥ï¼Œacä¸¤ä¸ªåŠï¼Œç¬¬ä¸‰é¢˜æœ‰æ€è·¯ä½†æ˜¯æš´åŠ›è¶…æ—¶ï¼Œæ˜¯å› ä¸ºæˆ‘æ²¡è§è¿‡è¿™ç§æ•°æ®ç»“æ„ã€‚\n\n> Hardå°±è·³äº†å§\n\n# ç¬¬ä¸€é¢˜ï¼šæ¯ä¸ªå­—ç¬¦æœ€å¤šå‡ºç°ä¸¤æ¬¡çš„æœ€é•¿å­å­—ç¬¦ä¸²\nç»™ä½ ä¸€ä¸ªå­—ç¬¦ä¸² s ï¼Œè¯·æ‰¾å‡ºæ»¡è¶³æ¯ä¸ªå­—ç¬¦æœ€å¤šå‡ºç°ä¸¤æ¬¡çš„æœ€é•¿å­å­—ç¬¦ä¸²ï¼Œå¹¶è¿”å›è¯¥ å­å­—ç¬¦ä¸² çš„ æœ€å¤§ é•¿åº¦ã€‚\n\nç¤ºä¾‹ 1ï¼š\n\nè¾“å…¥ï¼š s = \"bcbbbcba\"\n\nè¾“å‡ºï¼š 4\n\nè§£é‡Šï¼š\n\nä»¥ä¸‹å­å­—ç¬¦ä¸²é•¿åº¦ä¸º 4ï¼Œå¹¶ä¸”æ¯ä¸ªå­—ç¬¦æœ€å¤šå‡ºç°ä¸¤æ¬¡ï¼š\"bcbbbcba\"ã€‚\n>éå†æ¯ä¸ªå­—ä¸²ï¼Œåˆ¤æ–­æ˜¯å¦å­—ç¬¦åªå‡ºç°ä¸¤æ¬¡\n```java\nclass Solution {\n    public int maximumLengthSubstring(String s) {\n        int max = 2;\n        for (int k = s.length(); k >=1; k--) {\n            for (int i = 0; i < s.length() - k; i++) {\n                String sub = s.substring(i,i+k+1);\n                //å¦‚æœæ²¡æœ‰è¿”å›false\n                if (judge(sub)){\n                    max = Math.max(max,sub.length());\n                }\n            }\n        }\n        return max;\n    }\n    //åˆ¤æ–­å­—ä¸²æ˜¯å¦åªå‡ºç°ä¸¤æ¬¡ï¼Œç”¨å“ˆå¸Œè¡¨å®ç°ï¼Œå¦‚æœå“ˆå¸Œè¡¨è¶…è¿‡2å°±è¿”å›false\n    public boolean judge(String s){\n        HashMap<Character,Integer> map = new HashMap<>();\n        boolean flag = true;\n        for (int i = 0; i < s.length(); i++) {\n            if (!map.containsKey(s.charAt(i))){\n                map.put(s.charAt(i),1);\n            }\n            else {\n                Integer integer = map.get(s.charAt(i));\n                if (integer >= 2){\n                    flag = false;\n                }\n                map.replace(s.charAt(i),integer+1);\n            }\n        }\n        return flag;\n    }\n\n}\n```\n# ç¬¬äºŒé¢˜ï¼šæ‰§è¡Œæ“ä½œä½¿æ•°æ®å…ƒç´ ä¹‹å’Œå¤§äºç­‰äº K\nç»™ä½ ä¸€ä¸ªæ­£æ•´æ•° k ã€‚æœ€åˆï¼Œä½ æœ‰ä¸€ä¸ªæ•°ç»„ nums = [1] ã€‚\n\nä½ å¯ä»¥å¯¹æ•°ç»„æ‰§è¡Œä»¥ä¸‹ ä»»æ„ æ“ä½œ ä»»æ„ æ¬¡æ•°ï¼ˆå¯èƒ½ä¸ºé›¶ï¼‰ï¼š\n\né€‰æ‹©æ•°ç»„ä¸­çš„ä»»ä½•ä¸€ä¸ªå…ƒç´ ï¼Œç„¶åå°†å®ƒçš„å€¼ å¢åŠ  1 ã€‚\n\nå¤åˆ¶æ•°ç»„ä¸­çš„ä»»ä½•ä¸€ä¸ªå…ƒç´ ï¼Œç„¶åå°†å®ƒé™„åŠ åˆ°æ•°ç»„çš„æœ«å°¾ã€‚\n\nè¿”å›ä½¿å¾—æœ€ç»ˆæ•°ç»„å…ƒç´ ä¹‹ å’Œ å¤§äºæˆ–ç­‰äº k æ‰€éœ€çš„ æœ€å°‘ æ“ä½œæ¬¡æ•°ã€‚\n\n\n\nç¤ºä¾‹ 1ï¼š\n\nè¾“å…¥ï¼šk = 11\n\nè¾“å‡ºï¼š5\n\nè§£é‡Šï¼š\n\nå¯ä»¥å¯¹æ•°ç»„ nums = [1] æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š\n\nå°†å…ƒç´ çš„å€¼å¢åŠ  1 ä¸‰æ¬¡ã€‚ç»“æœæ•°ç»„ä¸º nums = [4] ã€‚\nå¤åˆ¶å…ƒç´ ä¸¤æ¬¡ã€‚ç»“æœæ•°ç»„ä¸º nums = [4,4,4] ã€‚\næœ€ç»ˆæ•°ç»„çš„å’Œä¸º 4 + 4 + 4 = 12 ï¼Œå¤§äºç­‰äº k = 11 ã€‚\næ‰§è¡Œçš„æ€»æ“ä½œæ¬¡æ•°ä¸º 3 + 2 = 5 ã€‚\n>æ•°å­¦é¢˜ï¼Œå‡è®¾+1çš„æ¬¡æ•°ä¸ºxï¼Œå¤åˆ¶çš„æ¬¡æ•°ä¸ºyï¼Œè¦ä½¿å¾—(y+1)*(x+1)>=nï¼Œè€Œæ»¡è¶³x+yæœ€å°\n\n>æ»¡è¶³x+y+2æœ€å°å…¶å®ä¹Ÿæ˜¯æ»¡è¶³x+yæœ€å°ï¼Œé‚£ä¹ˆå°±æ˜¯å¼€æ ¹å·äº†ï¼Œç”±åŸºæœ¬ä¸ç­‰å¼å¯å¾—ã€‚\n \n>è¿˜æœ‰ä¸ªé—®é¢˜å°±æ˜¯è¿™é‡Œçš„æ˜¯æ•´æ•°ï¼Œå‡å¦‚n=29å¼€æ ¹å·æ˜¯5ï¼Œè¿™ä¸ªæ—¶å€™ç”¨6 * 6=36å°±æµªè´¹äº†ä¸€æ¬¡ï¼Œåªéœ€è¦ç”¨5 * 6=30å°±å¯ä»¥ï¼Œéœ€è¦è¿›è¡Œç‰¹æ®Šåˆ¤æ–­\n\n>waäº†ä¸€æ¬¡ï¼Œå› ä¸ºè¿™é‡Œå¦‚æœæ­£å¥½å¼€æ ¹å·ï¼Œå°±ç›´æ¥è¿”å›x+yäº†ï¼Œä¸éœ€è¦-2\n```java\nclass Solution {\n    public int minOperations(int k) {\n        if (k ==1){\n            return 0;\n        }\n        int sqrt = (int) Math.sqrt(k);\n        if (k == sqrt*sqrt){\n            return sqrt*2-2;\n        }\n        else {\n            if (k <= sqrt *(sqrt+1)){\n                return sqrt+sqrt+1-2;\n            }\n            else {\n                return sqrt+1+sqrt+1-2;\n            }\n        }\n\n    }\n}\n```\n# ç¬¬ä¸‰é¢˜ï¼šæœ€é«˜é¢‘ç‡çš„ ID\n>é«˜çº§çš„æ’åºå“ˆå¸Œé›†ï¼ˆTreeMapï¼‰ä¸å¾—ä¸å“\n> \nä½ éœ€è¦åœ¨ä¸€ä¸ªé›†åˆé‡ŒåŠ¨æ€è®°å½• ID çš„å‡ºç°é¢‘ç‡ã€‚ç»™ä½ ä¸¤ä¸ªé•¿åº¦éƒ½ä¸º n çš„æ•´æ•°æ•°ç»„ nums å’Œ freq ï¼Œnums ä¸­æ¯ä¸€ä¸ªå…ƒç´ è¡¨ç¤ºä¸€ä¸ª ID ï¼Œå¯¹åº”çš„ freq ä¸­çš„å…ƒç´ è¡¨ç¤ºè¿™ä¸ª ID åœ¨é›†åˆä¸­æ­¤æ¬¡æ“ä½œåéœ€è¦å¢åŠ æˆ–è€…å‡å°‘çš„æ•°ç›®ã€‚\n\nå¢åŠ  ID çš„æ•°ç›®ï¼šå¦‚æœ freq[i] æ˜¯æ­£æ•°ï¼Œé‚£ä¹ˆ freq[i] ä¸ª ID ä¸º nums[i] çš„å…ƒç´ åœ¨ç¬¬ i æ­¥æ“ä½œåä¼šæ·»åŠ åˆ°é›†åˆä¸­ã€‚\nå‡å°‘ ID çš„æ•°ç›®ï¼šå¦‚æœ freq[i] æ˜¯è´Ÿæ•°ï¼Œé‚£ä¹ˆ -freq[i] ä¸ª ID ä¸º nums[i] çš„å…ƒç´ åœ¨ç¬¬ i æ­¥æ“ä½œåä¼šä»é›†åˆä¸­åˆ é™¤ã€‚\nè¯·ä½ è¿”å›ä¸€ä¸ªé•¿åº¦ä¸º n çš„æ•°ç»„ ans ï¼Œå…¶ä¸­ ans[i] è¡¨ç¤ºç¬¬ i æ­¥æ“ä½œåå‡ºç°é¢‘ç‡æœ€é«˜çš„ ID æ•°ç›® ï¼Œå¦‚æœåœ¨æŸæ¬¡æ“ä½œåé›†åˆä¸ºç©ºï¼Œé‚£ä¹ˆ ans[i] ä¸º 0 ã€‚\n\n\n\nç¤ºä¾‹ 1ï¼š\n\nè¾“å…¥ï¼šnums = [2,3,2,1], freq = [3,2,-3,1]\n\nè¾“å‡ºï¼š[3,3,2,2]\n\nè§£é‡Šï¼š\n\nç¬¬ 0 æ­¥æ“ä½œåï¼Œæœ‰ 3 ä¸ª ID ä¸º 2 çš„å…ƒç´ ï¼Œæ‰€ä»¥ ans[0] = 3 ã€‚\nç¬¬ 1 æ­¥æ“ä½œåï¼Œæœ‰ 3 ä¸ª ID ä¸º 2 çš„å…ƒç´ å’Œ 2 ä¸ª ID ä¸º 3 çš„å…ƒç´ ï¼Œæ‰€ä»¥ ans[1] = 3 ã€‚\nç¬¬ 2 æ­¥æ“ä½œåï¼Œæœ‰ 2 ä¸ª ID ä¸º 3 çš„å…ƒç´ ï¼Œæ‰€ä»¥ ans[2] = 2 ã€‚\nç¬¬ 3 æ­¥æ“ä½œåï¼Œæœ‰ 2 ä¸ª ID ä¸º 3 çš„å…ƒç´ å’Œ 1 ä¸ª ID ä¸º 1 çš„å…ƒç´ ï¼Œæ‰€ä»¥ ans[3] = 2 ã€‚\n## æš´åŠ›è¶…æ—¶\n>hashmapç»´æŠ¤å½“å‰çš„é¢‘ç‡ï¼Œæ¯æ¬¡éƒ½å¯¹å…¶è¿›è¡Œæœ€å°å€¼æŸ¥æ‰¾ï¼Œæ—¶é—´å¤æ‚åº¦o(n^2)\n```java\nclass Solution {\n    public long[] mostFrequentIDs(int[] nums, int[] freq) {\n        long[] ans = new long[nums.length];\n        HashMap<Integer,Long> hashMap = new HashMap<>();\n        for (int i = 0; i < nums.length; i++) {\n            if (!hashMap.containsKey(nums[i])){\n                hashMap.put(nums[i], (long) freq[i]);\n            }\n            else {\n                long integer = hashMap.get(nums[i]);\n                hashMap.replace(nums[i],integer+freq[i]);\n            }\n            ans[i] = getMost(hashMap);\n        }\n        return ans;\n    }\n    //éå†å“ˆå¸Œæ‰¾æœ€å°å€¼\n    public long getMost(HashMap<Integer,Long> hashMap){\n        long max = Long.MIN_VALUE;\n        for (Map.Entry<Integer,Long> entry : hashMap.entrySet()){\n            max = Math.max(max,entry.getValue());\n        }\n        return max;\n    }\n}\n```\n## TreeMapï¼ˆé‡è¦ï¼‰\n\n>TreeMapæ˜¯ç´¢å¼•ä¸ºé”®çš„æœ‰åºå“ˆå¸Œè¡¨ï¼Œä»å°åˆ°å¤§æ’åºï¼Œæ¯æ¬¡ç»´æŠ¤treemapåªç”¨ä»æœ€åé¢æ‰¾åˆ°å°±æ˜¯æœ€å¤§å€¼ã€‚\n\n>è¿™é‡Œtreemapå­˜çš„æ˜¯é¢‘ç‡çš„é¢‘ç‡ï¼Œæ¯å½“æœ‰æ›´æ–°çš„æ—¶å€™å°±å¯¹åº”é¢‘ç‡çš„å€¼-1ï¼Œå¦‚æœä¸º0äº†å°±åˆ é™¤ï¼Œç„¶ååœ¨åŠ ä¸Šæ–°çš„\n```java\nclass Solution {\n    public long[] mostFrequentIDs(int[] nums, int[] freq) {\n        long[] ans = new long[nums.length];\n        HashMap<Integer,Long> hashMap = new HashMap<>();\n        TreeMap<Long,Integer> treeMap = new TreeMap<>();\n        for (int i = 0; i < nums.length; i++) {\n            if (!hashMap.containsKey(nums[i])){\n                hashMap.put(nums[i], (long) freq[i]);\n                //å¦‚æœæ²¡æœ‰å°±é»˜è®¤ä¸º1ï¼Œæœ‰å°±åŠ ä¸Š\n                treeMap.put((long) freq[i],treeMap.getOrDefault((long)freq[i],0)+1);\n            }\n            else {\n                long integer = hashMap.get(nums[i]);\n                if (treeMap.containsKey(integer)){\n                    int temp = treeMap.get(integer);\n                    if (temp == 1){\n                        //å¦‚æœæœ¬æ¥å°±åªæœ‰1äº†ï¼Œå°±ç§»é™¤\n                        treeMap.remove(integer);\n                    }\n                    else {\n                        //è¿™é‡Œå…¶å®å¯ä»¥ç›´æ¥ç”¨put\n                        treeMap.replace(integer,temp-1);\n                    }\n                    treeMap.put(integer+freq[i],treeMap.getOrDefault(integer+freq[i],0)+1);\n                }\n                hashMap.replace(nums[i],integer+freq[i]);\n            }\n            ans[i] = treeMap.lastKey();\n        }\n        return ans;\n    }\n}\n```\n## [å¼•ç”³ï¼šå‰å¤©çš„æ¯æ—¥ä¸€é¢˜](./leetcode-2024-3-21.md)\næœ‰ä¸€ç‚¹ç›¸ä¼¼\n","tags":["åˆ·é¢˜ç¬”è®°"]},{"title":"leetcode-2024-3-24","url":"/2024/03/24/leetcode-2024-3-24/","content":"# 323 é›¶é’±å…‘æ¢(Medium)\nç»™ä½ ä¸€ä¸ªæ•´æ•°æ•°ç»„ coins ï¼Œè¡¨ç¤ºä¸åŒé¢é¢çš„ç¡¬å¸ï¼›ä»¥åŠä¸€ä¸ªæ•´æ•° amount ï¼Œè¡¨ç¤ºæ€»é‡‘é¢ã€‚\n\nè®¡ç®—å¹¶è¿”å›å¯ä»¥å‡‘æˆæ€»é‡‘é¢æ‰€éœ€çš„ æœ€å°‘çš„ç¡¬å¸ä¸ªæ•° ã€‚å¦‚æœæ²¡æœ‰ä»»ä½•ä¸€ç§ç¡¬å¸ç»„åˆèƒ½ç»„æˆæ€»é‡‘é¢ï¼Œè¿”å› -1 ã€‚\n\nä½ å¯ä»¥è®¤ä¸ºæ¯ç§ç¡¬å¸çš„æ•°é‡æ˜¯æ— é™çš„ã€‚\n\n\n\nç¤ºä¾‹ 1ï¼š\n\nè¾“å…¥ï¼šcoins = [1, 2, 5], amount = 11\n\nè¾“å‡ºï¼š3\n\nè§£é‡Šï¼š11 = 5 + 5 + 1\n>ä»Šå¤©çš„æ¯æ—¥ä¸€é¢˜åœ¨åå¤©å‰åšè¿‡ï¼Œè¿‡ä¸€éå°±ä¸é‡æ–°åšäº†\n## åŠ¨æ€è§„åˆ’\n>dpæ•°ç»„å­˜å½“å‰ä¸‹æ ‡çš„é’±å¯ä»¥ç”¨çš„æœ€å°‘å…‘æ¢æ¬¡æ•°ï¼Œå¦‚æœç”¨ç°åœ¨çš„é›¶é’±å…‘ç°ä¸äº†ï¼Œå°±ä¸º-1\n\n>dp[k] = min{dp[i]+dp[k-1-i]} å½“ä¸”ä»…å½“dp[i]å’Œdp[k-1-i]éƒ½ä¸ä¸º-1\n> ä½†æ˜¯å¦‚æœè¿™ä¸ªæœ¬èº«å°±å¯ä»¥ç”¨é›¶é’±æ‰¾å¼€ï¼Œå°±ä¸º1\n```java\nclass Solution {\n    public int coinChange(int[] coins, int amount) {\n        if (amount == 0){\n            return 0;\n        }\n        int[] dp = new int[amount+1];\n        for (int i = 0; i < coins.length; i++) {\n            if (coins[i] <= amount){\n                dp[coins[i]] = 1;\n            }\n        }\n        //System.out.println(Arrays.toString(dp));\n        for (int i = 1; i <= amount; i++) {\n            if (i != 1){\n                int head = 1;\n                int rear = i-1;\n                int min = Integer.MAX_VALUE;\n                //dp[k] = min{dp[i]+dp[k-1-i]} å½“ä¸”ä»…å½“dp[i]å’Œdp[k-1-i]éƒ½ä¸ä¸º-1\n                while (head <= rear){\n                    if (dp[head] != -1 && dp[rear]!=-1 && dp[head] + dp[rear] < min){\n                        min = dp[head]+dp[rear];\n                    }\n                    //System.out.println(i+\":\"+dp[head] +\"  \"+ dp[rear]);\n                    head++;\n                    rear--;\n                }\n                //æœ€å°å€¼æ²¡æœ‰æ”¹å˜ï¼Œè¯´æ˜ä¸èƒ½æ‰¾çš„å¼€\n                if (dp[i] == 0 && min == Integer.MAX_VALUE){\n                    dp[i] = -1;\n                }\n                //æ”¹å˜äº†å°±æœ€å°å€¼\n                if (dp[i] == 0 && min != Integer.MAX_VALUE){\n                    dp[i] = min;\n                }\n                //å¦‚æœè¿™ä¸ªæœ¬èº«å°±æ˜¯1çš„è¯å°±ä¸è€ƒè™‘ï¼Œè¿˜æ˜¯1\n            }\n            else {\n                if (dp[i] == 0){\n                    dp[i] = -1;\n                }\n            }\n        }\n        //System.out.println(Arrays.toString(dp));\n    \n        return dp[amount];\n    }\n}\n```\n\n# 238 é™¤è‡ªèº«ä»¥å¤–æ•°ç»„çš„ä¹˜ç§¯(Medium)\nç»™ä½ ä¸€ä¸ªæ•´æ•°æ•°ç»„ **nums**ï¼Œè¿”å› æ•°ç»„ **answer** ï¼Œå…¶ä¸­ answer[i] ç­‰äº nums ä¸­é™¤ nums[i] ä¹‹å¤–å…¶ä½™å„å…ƒç´ çš„ä¹˜ç§¯ ã€‚\n\né¢˜ç›®æ•°æ® **ä¿è¯** æ•°ç»„ numsä¹‹ä¸­ä»»æ„å…ƒç´ çš„å…¨éƒ¨å‰ç¼€å…ƒç´ å’Œåç¼€çš„ä¹˜ç§¯éƒ½åœ¨  32 ä½ æ•´æ•°èŒƒå›´å†…ã€‚\n\nè¯· **ä¸è¦ä½¿ç”¨é™¤æ³•**ï¼Œä¸”åœ¨ **O(n)** æ—¶é—´å¤æ‚åº¦å†…å®Œæˆæ­¤é¢˜ã€‚\n\n## å·æ‡’æ–¹æ³•ï¼ˆå°±æ˜¯ç”¨äº†é™¤æ³•ï¼‰\n>æœ€ç®€å•æ–¹æ³•ï¼Œæ‰€æœ‰ä¹˜ç§¯èµ·æ¥ï¼Œå½“å‰å…ƒç´ åªè¦é™¤æ‰è¿™ä¸ªå°±å¯ä»¥ï¼Œéå†ä¸€æ¬¡å°±å¯ä»¥ã€‚0çš„æ—¶å€™è¦ç‰¹æ®Šåˆ¤æ–­ä¸€ä¸‹ï¼Œè¿™ä¸ªæ—¶å€™è¿˜æ˜¯å‚»æ–¹æ³•ï¼Œéå†å…¶ä»–çš„ã€‚\n\n```java\nclass Solution {\n    public int[] productExceptSelf(int[] nums) {\n        int[] ans = new int[nums.length];\n        if (nums.length == 1){\n            return nums;\n        }\n        else if (nums.length > 1){\n            int sum = nums[0];\n            //ä¹˜èµ·æ¥\n            for (int i = 1; i < nums.length; i++) {\n                sum *=nums[i];\n            }\n            \n            for (int i = 0; i < nums.length; i++) {\n                if (nums[i] != 0){\n                    ans[i] = sum /nums[i];\n                }\n                //å¦‚æœæ˜¯0ç‰¹åˆ¤\n                else {\n                    int front = i-1;\n                    int next = i+1;\n                    int anss = 1;\n                    while (front >=0){\n                        anss*=nums[front];\n                        front--;\n                    }\n                    while (next <=nums.length-1){\n                        anss*=nums[next];\n                        next++;\n                    }\n                    ans[i] = anss;\n                }\n            }\n        }\n        return ans;\n    }\n}\n```\n## å®˜æ–¹è§£ï¼šå·¦å³ä¹˜ç§¯åˆ—è¡¨\n>ç»´æŠ¤ä¸¤ä¸ªæ•°ç»„ï¼ŒL[i]æ˜¯å½“å‰å…ƒç´ iå·¦è¾¹çš„ä¹˜ç§¯ï¼ŒR[i]æ˜¯iå³è¾¹çš„ä¹˜ç§¯ï¼Œè¿”å›çš„æ•°ç»„å°±æ˜¯L[i]*R[i]ï¼Œæ¯æ¬¡éƒ½æ˜¯oï¼ˆnï¼‰\n\n```java\nclass Solution {\n    public int[] productExceptSelf(int[] nums) {\n        int[] L = new int[nums.length];\n        int[] R = new int[nums.length];\n        int[] ans = new int[nums.length];\n        L[0] = 1;\n        R[nums.length-1] = 1;\n        for (int i = 1; i < nums.length; i++) {\n            L[i] = L[i-1]*nums[i-1];\n        }\n        for (int j = nums.length-2; j >=0 ; j--) {\n            R[j] = R[j+1]*nums[j+1];\n        }\n        for (int i = 0; i < nums.length; i++) {\n            ans[i] = L[i] * R[i];\n        }\n        return ans;\n    }\n}\n```\n# 11 ç››æœ€å¤šæ°´çš„å®¹å™¨(Medium)\nç»™å®šä¸€ä¸ªé•¿åº¦ä¸º n çš„æ•´æ•°æ•°ç»„ height ã€‚æœ‰ n æ¡å‚çº¿ï¼Œç¬¬ i æ¡çº¿çš„ä¸¤ä¸ªç«¯ç‚¹æ˜¯ (i, 0) å’Œ (i, height[i]) ã€‚\n\næ‰¾å‡ºå…¶ä¸­çš„ä¸¤æ¡çº¿ï¼Œä½¿å¾—å®ƒä»¬ä¸ x è½´å…±åŒæ„æˆçš„å®¹å™¨å¯ä»¥å®¹çº³æœ€å¤šçš„æ°´ã€‚\n\nè¿”å›å®¹å™¨å¯ä»¥å‚¨å­˜çš„æœ€å¤§æ°´é‡ã€‚\n![](../img/coding/2024_3_24_1.png)\n## æš´åŠ›è¶…æ—¶\n>éå†æ‰¾æœ€å°\n```java\nclass Solution {\n    public int maxArea(int[] height) {\n        int max = Integer.MIN_VALUE;\n        for (int i = 0; i < height.length-1; i++) {\n            for (int j = i+1; j < height.length; j++) {\n                max = Math.max(max,(j-i)*Math.min(height[j],height[i]));\n            }\n        }\n        return max;\n    }\n}\n```\n## å®˜æ–¹è§£ï¼šåŒæŒ‡é’ˆ\n>æ„Ÿè§‰è¯æ˜æœ‰å¾…è€ƒå¯Ÿï¼Œåˆå§‹å·¦å³æŒ‡é’ˆä¸€ä¸ªåœ¨å·¦è¾¹ä¸€ä¸ªåœ¨å³è¾¹ï¼Œæ¯æ¬¡ç§»åŠ¨æ¯”è¾ƒå°çš„å°±å¯ä»¥æ‰¾åˆ°ã€‚\n\n![](../img/coding/2024_3_24_2.png)\n![](../img/coding/2024_3_24_3.png)\n>ç®€å•ç†è§£ä¸ºä»€ä¹ˆç§»åŠ¨å°çš„ï¼Œå› ä¸ºæœ¬æ¥å°±æ˜¯å–è¾ƒå°çš„ï¼Œç§»åŠ¨å¤§çš„è¯é“å®šæ²¡ä¹‹å‰å¤§ï¼Œå› ä¸ºè·ç¦»ç¼©çŸ­äº†1ï¼Œç§»åŠ¨å°çš„è¿˜å¯èƒ½ç¢°åˆ°å¤§çš„ä½¿åŸæ¥çš„å˜å¤§ã€‚\n```java\nclass Solution {\n    public int maxArea(int[] height) {\n        int head = 0;\n        int rear = height.length-1;\n        int max = Integer.MIN_VALUE;\n        while (head < rear){\n            int length = rear-head;\n            max = Math.max(max,length*Math.min(height[head],height[rear]));\n            if (height[head]<height[rear]){\n                head++;\n            }\n            else if (height[head]>height[rear]){\n                rear--;\n            }\n            else {\n                head++;\n            }\n        }\n        return max;\n    }\n}\n```","tags":["åˆ·é¢˜ç¬”è®°"]},{"title":"çŸ­æœŸçš„å°ç›®æ ‡å§","url":"/2024/03/23/çŸ­æœŸçš„å°ç›®æ ‡å§/","content":"è¿™å‡ å¤©æ™šä¸Šç¡ä¸å¥½ï¼Œæ€»åœ¨æƒ³è‡ªå·±ä¿ç ”äº†ä½†æ˜¯æ„Ÿè§‰ä¹Ÿä¸æ˜¯å¾ˆå¼€å¿ƒã€‚åŒä¸“ä¸šçš„åŒå­¦ä»¬é™†é™†ç»­ç»­å‡ºæˆç»©ï¼Œä¸€çœ‹è€ƒæœ¬æ ¡çš„å¯¥å¯¥æ— å‡ ï¼Œé¡¿æ—¶è§‰å¾—è‡ªå·±ä¿ç ”å¥½åƒä¹Ÿæ²¡ä»€ä¹ˆäº†ä¸èµ·çš„ã€‚\n\næ€»ä¸å¯èƒ½ä¸€ç›´éº»ç—¹è‡ªå·±ï¼Œè¯´æˆ‘è¿™ä¸¤ä¸ªæœˆå»åšäº†ä»€ä¹ˆäº‹æƒ…éƒ½æ²¡å¹²çš„å®ä¹ ï¼Œè¯´å»ç»™å­¦æ ¡æ‰“å·¥èµšäº†ä¸€äº›å°é’±ã€‚å¦‚ä½•å°†è¿™äº›ä¸œè¥¿å˜ç°æ‰æ˜¯æœ€é‡è¦çš„ï¼Œè¦ä¸ç„¶æˆ‘ä¼šä¸€ç›´ä¸å¹³è¡¡ã€‚\n\næˆ‘æ‰“ç®—å…ˆæŠŠé»‘é©¬å¤´æ¡é‚£ä¸ªé¡¹ç›®ç‹ ç‹ é‡æ–°æä¸€ä¸‹ï¼Œå—æ–¹ç”µç½‘çš„ä¹Ÿå¥½å¥½åŒ…è£…ä¸€ä¸‹ã€‚\n\nè¯´å®è¯ï¼Œæˆ‘å¯¹Rediså’ŒMongoDBå’ŒKafkaéƒ½æŒºæ„Ÿå…´è¶£çš„ï¼Œæ¯å¤©ä¿æŒåˆ·é¢˜çš„åŒæ—¶æˆ‘ä¹Ÿæƒ³å¤šçœ‹çœ‹è¿™æ–¹é¢çš„å…«è‚¡æ–‡ã€‚\n\næš‘å‡å¯ä»¥å…ˆå»è¯•è¯•æ°´ï¼Œæ²¡æœ‰å°±å¥½å¥½å®‰å¿ƒæ12306é‚£ä¸ªå¾®æœåŠ¡é¡¹ç›®ã€‚\n\n![](../img/IMG_8928.JPG)","tags":["é—²è°ˆ"]},{"title":"leetcode-2024-3-23","url":"/2024/03/23/leetcode-2024-3-23/","content":"# 2549 ç»Ÿè®¡æ¡Œé¢ä¸Šçš„ä¸åŒæ•°å­—(Easy)\nç»™ä½ ä¸€ä¸ªæ­£æ•´æ•° n ï¼Œå¼€å§‹æ—¶ï¼Œå®ƒæ”¾åœ¨æ¡Œé¢ä¸Šã€‚åœ¨ 10^9 å¤©å†…ï¼Œæ¯å¤©éƒ½è¦æ‰§è¡Œä¸‹è¿°æ­¥éª¤ï¼š\n\nå¯¹äºå‡ºç°åœ¨æ¡Œé¢ä¸Šçš„æ¯ä¸ªæ•°å­— x ï¼Œæ‰¾å‡ºç¬¦åˆ 1 <= i <= n ä¸”æ»¡è¶³ x % i == 1 çš„æ‰€æœ‰æ•°å­— i ã€‚\nç„¶åï¼Œå°†è¿™äº›æ•°å­—æ”¾åœ¨æ¡Œé¢ä¸Šã€‚\nè¿”å›åœ¨ 10^9 å¤©ä¹‹åï¼Œå‡ºç°åœ¨æ¡Œé¢ä¸Šçš„ ä¸åŒ æ•´æ•°çš„æ•°ç›®ã€‚\n\n>ç®€å•é¢˜é‡æ‹³å‡ºå‡»\n\n## æ­£å¸¸è§£\n\n>å‘ç°å¯ä»¥è¿›è¡Œé€’å½’ï¼Œå‡è®¾n=7ï¼Œé‚£ä¹ˆç¬¬ä¸€æ¬¡é€’å½’å°±æ˜¯6å’Œ3ï¼Œå› ä¸º7%3=1ï¼Œ7%6=1ï¼Œé‚£ä¹ˆæ€ä¹ˆæ ·è§£å†³é‡å¤çš„é—®é¢˜å‘¢ï¼Œç”¨ä¸€ä¸ªsetå°±å¥½äº†ã€‚\n\n```java\n//å»é‡\nHashSet<Integer> hashSet = new HashSet<>();\npublic int distinctIntegers(int n) {\n    dp(n);\n    //æœ€åè¿”å›å”¯ä¸€é›†åˆçš„é•¿åº¦å°±è¡Œ\n    return hashSet.size();\n}\npublic void dp(int n){\n    hashSet.add(n);\n    for (int i = n-1; i >=1; i--) {\n        //éå†è¿›è¡Œé€’å½’\n        if (n % i ==1){\n            distinctIntegers(i);\n        }\n    }\n}\n```\n\né‚£æ˜¯æ¯”ä¸ä¸Šæœ€å¿«ç‚¹æ–¹æ³•çš„ï¼Œå…¶å®æ‰¾è§„å¾‹ç›´æ¥å‡ºæ¥å°±æ˜¯n-1ï¼Œæˆ‘è¿™ä¸ªæ–¹æ³•è¿˜ç®—æ˜¯æœ‰ç‚¹ç¼–ç¨‹çš„ï¼Œè‡ªç„¶é€Ÿåº¦å¿«ä¸è¿‡é‚£äº›n-1çš„\n\n# 146 LRUç¼“å­˜ï¼ˆMediumï¼‰éå¸¸é‡è¦è¿™é“é¢˜\n\nå®ç°LRUç®—æ³•ï¼Œ**å…³é”®æ˜¯è¦æ—¶é—´å¤æ‚åº¦å’Œç©ºé—´éƒ½æ˜¯oï¼ˆ1ï¼‰**\n\n>è™½ç„¶ä»å‰åœ¨osä¸Šè¿˜æ˜¯æ‰‹æ“è¿‡è¿™ä¸ªç®—æ³•çš„ï¼Œä½†æ˜¯è¿™é‡Œè¦ç”¨å¸¸æ•°çš„å¤æ‚åº¦ã€‚\n\n>é‚£å¿…ç„¶æ˜¯è¦å“ˆå¸Œï¼Œä½†æ˜¯å“ˆå¸Œè¿˜ä¸å¤Ÿï¼Œåœ¨æœå¯»åœ¨é˜Ÿåˆ—é‡Œé¢çš„æ—¶å€™å¿…ç„¶è¿˜æ˜¯è¦éå†ï¼Œè¿™ä¸ªæ—¶å€™å°±è¦æƒ³åˆ°å¦ä¸€ç§æ•°æ®ç»“æ„ï¼Œé“¾è¡¨\n> è¿™é‡Œä¸ºä»€ä¹ˆç”¨åŒå‘é“¾è¡¨ï¼Œå› ä¸ºå‰é©±è¿˜æ˜¯è¦æ‰¾çš„ï¼Œæ€»ä¸èƒ½æ¯æ¬¡éƒ½å»éå†å§ï¼Œé‚£è¿˜æ˜¯æµªè´¹ä¸€ç‚¹ç©ºé—´å§ã€‚\n## å“ˆå¸Œè¡¨+åŒå‘é“¾è¡¨\n```java\nclass LRUCache{\n    //åŒå‘é“¾è¡¨æ•°æ®ç»“æ„\n    class LinkNode{\n        int key;\n        int value;\n        //å‰é©±\n        LinkNode front = null;\n        //åç»§\n        LinkNode behind = null;\n        LinkNode(int key,int value){\n            this.key = key;\n            this.value = value;\n        }\n        LinkNode(){}\n    }\n    //å®¹é‡\n    private int capacity;\n    //ç»´æŠ¤é¦–å°¾æŒ‡é’ˆ\n    private LinkNode head,tail;\n    //è®°å½•é“¾è¡¨é•¿åº¦\n    private int linkSize = 0;\n    //å“ˆå¸Œè¡¨æ¥æ ¹æ®é”®æ‰¾åˆ°é“¾è¡¨çš„å…·ä½“ä½ç½®\n    private HashMap<Integer,LinkNode> hashMap = new HashMap<>();\n    public LRUCache(int capacity) {\n        this.capacity = capacity;\n        head = new LinkNode();\n        tail = new LinkNode();\n    }\n    \n    public int get(int key) {\n        if (hashMap.containsKey(key)){\n            LinkNode linkNode = hashMap.get(key);\n            moveToHead(linkNode);\n            return linkNode.value;\n        }\n        else {\n            return -1;\n        }\n    }\n    \n    public void put(int key, int value) {\n        //å¦‚æœæ²¡åˆ°å®¹é‡ï¼Œå°±ä¸æ¶‰åŠé‡Šæ”¾ä½ç½®\n        if (linkSize < capacity){\n            //å¦‚æœmapæ²¡æœ‰\n            if (!hashMap.containsKey(key)){\n                LinkNode linkNode = new LinkNode(key,value);\n                //å¤´æ’æ³•\n                handleInsert(linkNode);\n                linkSize++;\n                //ä¿å­˜è¿™ä¸ªèŠ‚ç‚¹\n                hashMap.put(key,linkNode);\n            }\n            else {\n                LinkNode linkNode = hashMap.get(key);\n                linkNode.value = value;\n                moveToHead(linkNode);\n                hashMap.replace(key,linkNode);\n            }\n        }\n        else {\n            if (!hashMap.containsKey(key)){\n                int removeKey = handleRemove();\n                hashMap.remove(removeKey);\n                LinkNode linkNode = new LinkNode(key,value);\n                handleInsert(linkNode);\n                hashMap.put(key,linkNode);\n            }\n            else {\n                LinkNode linkNode = hashMap.get(key);\n                linkNode.value = value;\n                moveToHead(linkNode);\n                hashMap.replace(key,linkNode);\n            }\n        }\n    }\n\n    /**\n     * å¤´æ’æ³•\n     * @param linkNode æ’å…¥çš„èŠ‚ç‚¹\n     */\n    public void handleInsert(LinkNode linkNode){\n        LinkNode temp = head.behind;\n        //å¦‚æœè¿™æ˜¯ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå°¾æŒ‡é’ˆä¸€ç›´æŒ‚åœ¨è¿™ä¸ªå…ƒç´ ä¸Šï¼Œç›´åˆ°è¢«æèµ·æ¥rearå†å˜\n        if (temp != null){\n            linkNode.behind = temp;\n            head.behind = linkNode;\n            temp.front = linkNode;\n            linkNode.front = head;\n        }\n        //å¦‚æœä¸æ˜¯ç¬¬ä¸€ä¸ªï¼Œé‚£å°±å¤´æ’æ³•\n        else {\n            head.behind = linkNode;\n            linkNode.front = head;\n            tail = linkNode;\n        }\n    }\n\n    /**\n     * å‡ºé˜Ÿï¼Œç§»åŠ¨å°¾æŒ‡é’ˆå³å¯\n     * @return è¿”å›å°¾å…ƒç´ çš„é”®\n     */\n    public int handleRemove(){\n        int ans = tail.key;\n        tail = tail.front;\n        tail.behind = null;\n        return ans;\n    }\n\n    /**\n     * æ›´æ–°åœ¨é˜Ÿé¦–\n     * @param linkNode\n     */\n    public void moveToHead(LinkNode linkNode){\n        //ä¹Ÿå°±æ˜¯åœ¨æœ«å°¾çš„æ—¶å€™\n        if (linkNode.behind == null){\n            tail = linkNode.front;\n            linkNode.front.behind = null;\n            linkNode.front = null;\n            handleInsert(linkNode);\n\n        }\n        else {\n            LinkNode left = linkNode.front;\n            LinkNode right = linkNode.behind;\n            left.behind = right;\n            right.front = left;\n            linkNode.front = null;\n            linkNode.behind = null;\n            handleInsert(linkNode);\n        }\n    }\n}\n\n```\n\nå¤§åŒå°å¼‚è¿™äº›ç­”æ¡ˆï¼Œä¸»è¦è¿˜æ˜¯å“ˆå¸Œ+åŒå‘\n\n# 283 ç§»åŠ¨é›¶(Easy)\nç»™å®šä¸€ä¸ªæ•°ç»„ numsï¼Œç¼–å†™ä¸€ä¸ªå‡½æ•°å°†æ‰€æœ‰ 0 ç§»åŠ¨åˆ°æ•°ç»„çš„æœ«å°¾ï¼ŒåŒæ—¶ä¿æŒéé›¶å…ƒç´ çš„ç›¸å¯¹é¡ºåºã€‚\n\nè¯·æ³¨æ„ ï¼Œå¿…é¡»åœ¨ä¸å¤åˆ¶æ•°ç»„çš„æƒ…å†µä¸‹åŸåœ°å¯¹æ•°ç»„è¿›è¡Œæ“ä½œã€‚\n\nç¤ºä¾‹ 1:\n\nè¾“å…¥: nums = [0,1,0,3,12]\n\nè¾“å‡º: [1,3,12,0,0]\n\n>æ²¡ä»€ä¹ˆå¥½è¯´çš„è¿™ä¸ªé¢˜\n\n## ç›´æ¥æ’å…¥æ’åºæ€æƒ³\n\n```java\nclass Solution {\n    public void moveZeroes(int[] nums) {\n        for (int i = nums.length-2; i >=0; i--) {\n            if (nums[i] == 0){\n                int j=i+1;\n                while (j <= nums.length-1&&nums[j] != 0  ){\n                    nums[j-1] = nums[j];\n                    j++;\n                }\n                nums[j-1] = 0;\n            }\n        }\n    }\n}\n```\n\n# 236.äºŒå‰æ ‘çš„æœ€è¿‘å…¬å…±ç¥–å…ˆ(Medium)\né¢˜ç›®æ„æ€å°±æ˜¯å­—é¢æ„æ€\n>è¿™ä¸ªé¢˜å±…ç„¶è¿˜æ²¡æœ‰è€ƒç ”é‚£æ®µæ—¶é—´åšå¾—å¥½ï¼Œè¿™é‡Œæ€è·¯å°±æ˜¯æ‰¾åˆ°è¿™ä¸¤ä¸ªèŠ‚ç‚¹çš„è·¯å¾„åºåˆ—ï¼Œç„¶åæ‰¾åˆ°æœ€è¿‘çš„é‚£ä¸ªé‡å¤å…ƒç´ å°±å®Œäº‹ã€‚\n## 2024.3.23\n```java\nclass Solution {\n    List<TreeNode> list1 = new ArrayList<>();\n    List<List<TreeNode>> list = new ArrayList<>();\n    public TreeNode lowestCommonAncestor(TreeNode root, TreeNode p, TreeNode q) {\n        hxbl(root,p);\n        hxbl(root,q);\n        \n        return findSame(list.get(0),list.get(1));\n    }\n\n    /**\n     * æ ‡å‡†çš„ï¼ˆ+left+{}+right+)ç»“æ„\n     * @param root\n     * @param target\n     */\n    public void hxbl(TreeNode root,TreeNode target){\n    \n        list1.add(root);\n        if (root.val == target.val){\n        \n            list.add(new ArrayList<>(list1));\n        }\n    \n        if (root.left != null){\n            hxbl(root.left,target);\n        }\n        if (root.right != null){\n            hxbl(root.right,target);\n        }\n        list1.remove(list1.size()-1);\n\n    }\n\n    /**\n     * æ‰¾åˆ°è¿™ä¸¤ä¸ªåºåˆ—çš„æœ€è¿‘å…ƒç´ ï¼Œè¦ä»åå¾€å‰ï¼Œç¢°åˆ°äº†å°±break\n     * @param list1\n     * @param list2\n     * @return\n     */\n    public TreeNode findSame(List<TreeNode> list1, List<TreeNode> list2){\n        for (int i = list1.size()-1; i >=0; i--) {\n            for (int j = list2.size()-1; j >=0; j--) {\n                if (list1.get(i).val == list2.get(j).val){\n                    return list1.get(i);\n                }\n            }\n        }\n        return null;\n    }\n    \n}\n```\n\n## 2023.8.3\n\n```java\nclass Solution {\n    List<TreeNode> treeList = new ArrayList<>();\n    public TreeNode lowestCommonAncestor(TreeNode root, TreeNode p, TreeNode q) {\n        find(root,p);\n        List<TreeNode> treeList1 = new ArrayList<>(treeList);\n        treeList = new ArrayList<>();\n        find(root,q);\n        List<TreeNode> treeList2 = new ArrayList<>(treeList);\n        boolean flag = true;\n        if (treeList1.size()>treeList2.size()){\n            flag = false;\n        }\n        for (int i = 0;i<Math.max(treeList1.size(),treeList2.size());i++){\n            if (!flag && treeList2.contains(treeList1.get(i))){\n                return treeList1.get(i);\n            }\n            if (flag && treeList1.contains(treeList2.get(i))){\n                return treeList2.get(i);\n            }\n        }\n        return null;\n    }\n    \n    public boolean find(TreeNode root,TreeNode p){\n          if (root!=null){\n              boolean left = find(root.left,p);\n              boolean right = find(root.right,p);\n              if (root == p||left||right){\n                  treeList.add(root);\n                  return true;\n              }\n              else return false;\n          }\n          else {\n              return false;\n          }\n    }\n}\n```","tags":["åˆ·é¢˜ç¬”è®°"]},{"title":"leetcode-2024-3-21","url":"/2024/03/21/leetcode-2024-3-21/","content":"# 2671 é¢‘ç‡è·Ÿè¸ªå™¨(Medium)\nè¯·ä½ è®¾è®¡å¹¶å®ç°ä¸€ä¸ªèƒ½å¤Ÿå¯¹å…¶ä¸­çš„å€¼è¿›è¡Œè·Ÿè¸ªçš„æ•°æ®ç»“æ„ï¼Œå¹¶æ”¯æŒå¯¹é¢‘ç‡ç›¸å…³æŸ¥è¯¢è¿›è¡Œåº”ç­”ã€‚\n\nå®ç° FrequencyTracker ç±»ï¼š\n\nFrequencyTracker()ï¼šä½¿ç”¨ä¸€ä¸ªç©ºæ•°ç»„åˆå§‹åŒ– FrequencyTracker å¯¹è±¡ã€‚\n\nvoid add(int number)ï¼šæ·»åŠ ä¸€ä¸ª number åˆ°æ•°æ®ç»“æ„ä¸­ã€‚\n\nvoid deleteOne(int number)ï¼šä»æ•°æ®ç»“æ„ä¸­åˆ é™¤ä¸€ä¸ª number ã€‚æ•°æ®ç»“æ„ å¯èƒ½ä¸åŒ…å« number ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ä¸åˆ é™¤ä»»ä½•å†…å®¹ã€‚\n\nbool hasFrequency(int frequency): å¦‚æœæ•°æ®ç»“æ„ä¸­å­˜åœ¨å‡ºç° frequency æ¬¡çš„æ•°å­—ï¼Œåˆ™è¿”å› trueï¼Œå¦åˆ™è¿”å› falseã€‚\n\n\nç¤ºä¾‹ 1ï¼š\n\nè¾“å…¥\n\n[\"FrequencyTracker\", \"add\", \"add\", \"hasFrequency\"]\n\n[[], [3], [3], [2]]\n\nè¾“å‡º\n\n[null, null, null, true]\n\nè§£é‡Š\n\nFrequencyTracker frequencyTracker = new FrequencyTracker();\n\nfrequencyTracker.add(3); // æ•°æ®ç»“æ„ç°åœ¨åŒ…å« [3]\n\nfrequencyTracker.add(3); // æ•°æ®ç»“æ„ç°åœ¨åŒ…å« [3, 3]\n\nfrequencyTracker.hasFrequency(2); // è¿”å› true ï¼Œå› ä¸º 3 å‡ºç° 2 æ¬¡\n\n## åŒå“ˆå¸Œ\n>ä¸€ä¸ªç”¨æ¥å­˜é¢‘ç‡ï¼Œä¸€ä¸ªç”¨æ¥å­˜é¢‘ç‡çš„é¢‘ç‡\n```java\npublic class FrequencyTracker {\n    private HashMap<Integer,Integer> hashMap;\n    private TreeMap<Integer,Integer> treeMap;\n\n    public FrequencyTracker() {\n        hashMap = new HashMap<>();\n        treeMap = new TreeMap<>();\n    }\n\n    public void add(int number) {\n        if (!hashMap.containsKey(number)){\n            hashMap.put(number,1);\n            treeMap.put(1,treeMap.getOrDefault(1,0)+1);\n        }\n        else {\n            Integer integer = hashMap.get(number);\n            hashMap.put(number,integer+1);\n            if (treeMap.containsKey(integer)){\n                int count = treeMap.get(integer);\n                if (count == 1){\n                    treeMap.remove(integer);\n                }\n                else{\n                    treeMap.replace(integer,count-1);\n                }\n                treeMap.put(integer+1,treeMap.getOrDefault(integer+1,0)+1);\n            }\n        }\n    }\n\n    public void deleteOne(int number) {\n\n        if (hashMap.containsKey(number)){\n            int i1 = hashMap.get(number);\n            int temp = treeMap.get(i1);\n            if (temp == 1){\n                treeMap.remove(i1);\n            }\n            else {\n                treeMap.replace(i1,temp-1);\n            }\n            if (i1-1 !=0){\n                if (treeMap.containsKey(i1-1)){\n                    treeMap.put(i1-1,treeMap.get(i1-1)+1);\n                }\n                else {\n                    treeMap.put(i1-1,1);\n                }\n            }\n\n            if (i1 == 1){\n                hashMap.remove(number);\n            }\n            else {\n                hashMap.put(number,i1-1);\n            }\n\n        }\n    }\n\n    public boolean hasFrequency(int frequency) {\n\n        if (treeMap.containsKey(frequency)){\n            int temp = treeMap.get(frequency);\n            if (temp > 0){\n                return true;\n            }\n            else {\n                return false;\n            }\n        }\n        else {\n            return false;\n        }\n    }\n\n    public static void main(String[] args) {\n        FrequencyTracker frequencyTracker = new FrequencyTracker();\n\n        frequencyTracker.add(2);\n\n        frequencyTracker.add(7);\n\n        frequencyTracker.add(7);\n        frequencyTracker.add(3);\n        frequencyTracker.add(3);\n\n        frequencyTracker.deleteOne(7);\n        frequencyTracker.deleteOne(7);\n        System.out.println(frequencyTracker.hasFrequency(2));\n        System.out.println(frequencyTracker.hasFrequency(1));\n    }\n\n}\n\n```","tags":["åˆ·é¢˜ç¬”è®°"]},{"title":"rediså®ç°åˆ†å¸ƒå¼é”-åˆè§åˆ†å¸ƒå¼é”","url":"/2024/03/20/rediså®ç°åˆ†å¸ƒå¼é”-åˆè§åˆ†å¸ƒå¼é”/","content":"# ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼é”\n\nåˆ†å¸ƒå¼é”æ˜¯æ§åˆ¶åˆ†å¸ƒå¼ç³»ç»Ÿä¹‹é—´åŒæ­¥è®¿é—®å…±äº«èµ„æºçš„ä¸€ç§æ–¹å¼ï¼Œé€šè¿‡äº’æ–¥æ¥ä¿æŒä¸€è‡´æ€§ã€‚\n\näº†è§£åˆ†å¸ƒå¼é”ä¹‹å‰å…ˆäº†è§£ä¸‹çº¿ç¨‹é”å’Œè¿›ç¨‹é”ï¼š\n\n**çº¿ç¨‹é”**ï¼šä¸»è¦ç”¨æ¥ç»™æ–¹æ³•ã€ä»£ç å—åŠ é”ã€‚å½“æŸä¸ªæ–¹æ³•æˆ–ä»£ç ä½¿ç”¨é”ï¼Œåœ¨åŒä¸€æ—¶åˆ»ä»…æœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œè¯¥æ–¹æ³•æˆ–è¯¥ä»£ç æ®µã€‚çº¿ç¨‹é”åªåœ¨åŒä¸€JVMä¸­æœ‰æ•ˆæœï¼Œå› ä¸ºçº¿ç¨‹é”çš„å®ç°åœ¨æ ¹æœ¬ä¸Šæ˜¯ä¾é çº¿ç¨‹ä¹‹é—´å…±äº«å†…å­˜å®ç°çš„ï¼Œæ¯”å¦‚Synchronizedã€Lockç­‰\n\n**è¿›ç¨‹é”**ï¼šæ§åˆ¶åŒä¸€æ“ä½œç³»ç»Ÿä¸­å¤šä¸ªè¿›ç¨‹è®¿é—®æŸä¸ªå…±äº«èµ„æºï¼Œå› ä¸ºè¿›ç¨‹å…·æœ‰ç‹¬ç«‹æ€§ï¼Œå„ä¸ªè¿›ç¨‹æ— æ³•è®¿é—®å…¶ä»–è¿›ç¨‹çš„èµ„æºï¼Œå› æ­¤æ— æ³•é€šè¿‡synchronizedç­‰çº¿ç¨‹é”å®ç°è¿›ç¨‹é”\n\næ¯”å¦‚Golangè¯­è¨€ä¸­çš„syncåŒ…å°±æä¾›äº†åŸºæœ¬çš„åŒæ­¥åŸºå…ƒï¼Œå¦‚äº’æ–¥é”\n\nä½†æ˜¯ä»¥ä¸Šä¸¤ç§é€‚åˆåœ¨å•ä½“æ¶æ„åº”ç”¨ï¼Œä½†æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å¤šä¸ªæœåŠ¡èŠ‚ç‚¹ï¼Œå¤šä¸ªè¿›ç¨‹åˆ†æ•£éƒ¨ç½²åœ¨ä¸åŒèŠ‚ç‚¹æœºå™¨ä¸­ï¼Œæ­¤æ—¶å¯¹äºèµ„æºçš„ç«äº‰ï¼Œä¸Šè¯‰ä¸¤ç§å¯¹èŠ‚ç‚¹æœ¬åœ°èµ„æºçš„é”å°±æ— æ•ˆäº†ã€‚\n\nè¿™ä¸ªæ—¶å€™å°±éœ€è¦åˆ†å¸ƒå¼é”æ¥å¯¹åˆ†å¸ƒå¼ç³»ç»Ÿå¤šè¿›ç¨‹è®¿é—®èµ„æºè¿›è¡Œæ§åˆ¶ï¼Œå› æ­¤åˆ†å¸ƒå¼é”æ˜¯ä¸ºäº†è§£å†³åˆ†å¸ƒå¼äº’æ–¥é—®é¢˜ï¼\n\n![img.png](../img/coding/2024_3_20_2.png)\n","tags":["Redis"]},{"title":"leetcode-2024-3-20","url":"/2024/03/20/leetcode-2024-3-20/","content":"# 1969.æ•°ç»„å…ƒç´ çš„æœ€å°éé›¶ä¹˜ç§¯ï¼ˆMediumï¼‰\nç»™ä½ ä¸€ä¸ªæ­£æ•´æ•° **p** ã€‚ä½ æœ‰ä¸€ä¸ªä¸‹æ ‡ä» **1** å¼€å§‹çš„æ•°ç»„ **nums** ï¼Œè¿™ä¸ªæ•°ç»„åŒ…å«èŒƒå›´ [1, 2p - 1] å†…æ‰€æœ‰æ•´æ•°çš„äºŒè¿›åˆ¶å½¢å¼ï¼ˆä¸¤ç«¯éƒ½ **åŒ…å«**ï¼‰ã€‚ä½ å¯ä»¥è¿›è¡Œä»¥ä¸‹æ“ä½œ **ä»»æ„** æ¬¡ï¼š\n\nä» nums ä¸­é€‰æ‹©ä¸¤ä¸ªå…ƒç´  x å’Œ y  ã€‚\né€‰æ‹© x ä¸­çš„ä¸€ä½ä¸ y å¯¹åº”ä½ç½®çš„ä½äº¤æ¢ã€‚å¯¹åº”ä½ç½®æŒ‡çš„æ˜¯ä¸¤ä¸ªæ•´æ•° ç›¸åŒä½ç½® çš„äºŒè¿›åˆ¶ä½ã€‚\næ¯”æ–¹è¯´ï¼Œå¦‚æœ x = 11**0**1 ä¸” y = 00**1**1 ï¼Œäº¤æ¢å³è¾¹æ•°èµ·ç¬¬ 2 ä½åï¼Œæˆ‘ä»¬å¾—åˆ° x = 11**1**1 å’Œ y = 00**0**1 ã€‚\n\nè¯·ä½ ç®—å‡ºè¿›è¡Œä»¥ä¸Šæ“ä½œ **ä»»æ„æ¬¡** ä»¥åï¼Œnums èƒ½å¾—åˆ°çš„ **æœ€å°éé›¶** ä¹˜ç§¯ã€‚å°†ä¹˜ç§¯å¯¹ 109 + 7 å–ä½™ åè¿”å›ã€‚\n\næ³¨æ„ï¼šç­”æ¡ˆåº”ä¸ºå–ä½™ **ä¹‹å‰** çš„æœ€å°å€¼ã€‚\n\n> ~~è‡ªå·±æ²¡æƒ³å‡ºæ¥~~ï¼Œå…¶å®æœ‰æ€è·¯äº†å°±æ˜¯æ€»æ„Ÿè§‰ä¸å¯¹åŠ²ï¼Œçœ‹äº†ç­”æ¡ˆå¦‚æœç»§ç»­æƒ³åº”è¯¥èƒ½æƒ³å‡ºæ¥ï¼Œä½†æ˜¯é—®é¢˜æ˜¯è¿™ä¸ªå–ä½™è‚¯å®šä¹Ÿä¼šå›°æ‰°æˆ‘å¾ˆä¹…ï¼Œè¿˜æœ‰æˆ‘è‚¯å®šåªä¼šæš´åŠ›æ±‚å¹‚ï¼Œè¿™é‡Œçš„**å¿«é€Ÿå¹‚**å…¶å®æ˜¯å¾ˆå€¼å¾—å­¦ä¹ ä¸€ä¸‹çš„\n\n## å®˜æ–¹è§£ï¼šè´ªå¿ƒ+å¿«é€Ÿå¹‚\n\n>   x * yè‚¯å®šæ˜¯è¦æ¯”(x-1) * (y+1)å¤§çš„ï¼Œé‚£ä¹ˆä»€ä¹ˆæ—¶å€™ä¼šæœ‰æœ€å°å€¼å‘¢ï¼Œå°±æ˜¯å½“x=1ï¼Œyå˜å¾—æœ€å¤§çš„æ—¶å€™ï¼Œå¯¹äºéƒ½æ˜¯äºŒè¿›åˆ¶æ¥è¯´ï¼Œèƒ½é€šè¿‡äº¤æ¢ä½æ¥å˜å¤§åªèƒ½æ˜¯x=1,y=2^(p-1)-2äº†ï¼Œæ¯”å¦‚3ä½çš„æ—¶å€™ï¼Œæœ€å°å°±æ˜¯1ï¼Œæœ€å¤§å°±æ˜¯6ï¼Œè¦ä¿æŒxå’Œyäº’ä¸º**åç **\n\n>é‚£è¿™é“é¢˜å°±æ˜¯ä¸€ä¸ªçº¯æ•°å­¦é—®é¢˜äº†ï¼Œæ¯æ¬¡å–ä¸¤ä¸ªäº’ä¸º**åç **çš„æ•°éƒ½èƒ½å°†å…¶å˜æˆx=1ï¼Œy=2^p-2ï¼Œé‚£ä¹ˆä¸€å…±æœ‰å¤šå°‘å¯¹è¿™æ ·çš„åç å¯¹å‘¢ã€‚\n>n=(2^p-2)/2ï¼Œé™¤äº†æœ€åé¢é‚£ä¸ªæ•°å…¶ä»–éƒ½å¯ä»¥å‡‘å¯¹ï¼Œå°±æœ‰2^(p-1)-1å¯¹ã€‚\n> p=3çš„æ—¶å€™ï¼Œå°±æœ‰3å¯¹ï¼Œp=4æ—¶ï¼Œå°±æœ‰7å¯¹\n \n>ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬çš„æœ€ç»ˆç­”æ¡ˆæ˜¯**æœ€åä¸€ä¸ªå…ƒç´ *ï¼ˆæœ€åä¸€ä¸ªå…ƒç´ -1ï¼‰^(2^(p-1)-1)**\n> å³ï¼š![](../img/coding/2024-3-20-1.png)\n\n>**å¿«é€Ÿå¹‚**ï¼šé€šè¿‡è§‚å¯Ÿ ***p=3çš„æ—¶å€™ï¼Œå°±æœ‰3å¯¹ï¼Œp=4æ—¶ï¼Œå°±æœ‰7å¯¹***ï¼Œå¯ä»¥å‘ç°3å°±æ˜¯11ï¼Œ7å°±æ˜¯111ï¼Œæ ¹æ®å¹‚çš„å…¬å¼x^(111)=x^(100)*x^(010)*x^(001),\n> ç­”æ¡ˆé‡Œå·§å¦™åœ°ç”¨å¿«é€Ÿå¹‚è§£å†³ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸å†æ˜¯æš´åŠ›è¿ä¹˜ï¼Œè€Œæ˜¯xä¹Ÿè‡ªå·±è¿›è¡Œå¹‚è¿ç®—ï¼Œå°±å¯ä»¥å°†å¤æ‚åº¦é™ä¸ºo(log)\n\n```java\nprivate static final int MOD = 1_000_000_007;\n//è¿™é‡Œçš„på°±æ˜¯å·²ç»logåçš„ï¼Œä¸€å…±æœ‰å‡ ä½ï¼Œæ¯ä¸€ä½éƒ½å¾ªç¯ä¸€æ¬¡\nprivate long pow(long x, int p) {\n    x %= MOD;\n    long res = 1;\n    while (p-- > 0) {\n        res = res * x % MOD;\n        x = x * x % MOD;\n    }\n    return res;\n}\n\npublic int minNonZeroProduct(int p) {\n    //ç§»ä½ï¼Œ1Læ˜¯longå•ä½ä¸‹çš„1ï¼Œå°†å…¶åƒå·¦è¾¹ç§»åŠ¨pä½\n    //å¾—åˆ°çš„kå°±æ˜¯æœ€åä¸€ä¸ªå…ƒç´ \n    long k = (1L << p) - 1;\n    //æœ€åä¸€ä¸ªå…ƒç´ *ï¼ˆæœ€åä¸€ä¸ªå…ƒç´ -1ï¼‰^(2^(p-1)-1)\n    return (int) (k % MOD * pow(k - 1, p - 1) % MOD);\n}\n```\n\næ²¡æƒ³å‡ºæ¥è¿™ç§æ–¹æ³•ï¼Œè´ªå¿ƒè¿˜æ˜¯ç»ƒä¹ å°‘äº†\n\n# 49.å­—æ¯å¼‚ä½è¯åˆ†ç»„ï¼ˆMediumï¼‰\n\nç»™ä½ ä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„ï¼Œè¯·ä½ å°† å­—æ¯å¼‚ä½è¯ ç»„åˆåœ¨ä¸€èµ·ã€‚å¯ä»¥æŒ‰ä»»æ„é¡ºåºè¿”å›ç»“æœåˆ—è¡¨ã€‚\n\nå­—æ¯å¼‚ä½è¯ æ˜¯ç”±é‡æ–°æ’åˆ—æºå•è¯çš„æ‰€æœ‰å­—æ¯å¾—åˆ°çš„ä¸€ä¸ªæ–°å•è¯ã€‚\n\nç¤ºä¾‹ 1:\n\nè¾“å…¥: strs = [\"eat\", \"tea\", \"tan\", \"ate\", \"nat\", \"bat\"]\nè¾“å‡º: [[\"bat\"],[\"nat\",\"tan\"],[\"ate\",\"eat\",\"tea\"]]\n\n## è‡ªå·±è§£ï¼ˆä¹Ÿæ˜¯å®˜æ–¹è§£ï¼‰ï¼šå“ˆå¸Œè¡¨+æ’åº\n\n>éå†æ¯ä¸ªå­—ç¬¦ä¸²ï¼Œç„¶ååœ¨å¯¹å…¶æ’åºï¼Œå¦‚æœå“ˆå¸Œè¡¨æ²¡æœ‰å°±åŠ è¿›å»ï¼ŒlistæŠŠè¿™ä¸ªæ’åºä¹‹å‰çš„å­—ç¬¦ä¸²æ”¾è¿›å»ï¼Œæœ‰å°±åœ¨å“ˆå¸Œè¡¨å·²æœ‰çš„é”®é‡Œé¢æ·»åŠ è¿™ä¸ªå­—ç¬¦ä¸²ã€‚\n\n```java\npublic List<List<String>> groupAnagrams(String[] strs) {\n    HashMap<String,List<String>> hashMap = new HashMap<>();\n    List<List<String>> ans = new ArrayList<>();\n    for (String s:strs){\n        String temp = getAllStr(s);\n        //å¦‚æœè¡¨é‡Œæ²¡æœ‰å°±æ–°å¢é”®å€¼å¯¹\n        if (!hashMap.containsKey(temp)){\n            List<String> list = new ArrayList<>();\n            list.add(s);\n            hashMap.put(temp,list);\n        }\n        //æœ‰å°±åœ¨æœ«å°¾æ·»åŠ \n        else {\n            List<String> list = hashMap.get(temp);\n            list.add(s);\n            hashMap.replace(temp,list);\n        }\n    }\n    //éå†mapå­˜åœ¨listä¸­\n    for (Map.Entry<String,List<String>> entry : hashMap.entrySet()){\n        ans.add(entry.getValue());\n    }\n    return ans;\n}\n//å­—ç¬¦ä¸²å˜æˆcharæ•°ç»„ï¼Œæ’åºï¼Œè¿™æ ·å°±èƒ½å¾—åˆ°å”¯ä¸€\npublic String getAllStr(String s){\n    char[] temp = s.toCharArray();\n    Arrays.sort(temp);\n    return Arrays.toString(temp);\n}\n```\n\næ¯”è¾ƒç®€å•\n\n# 128.æœ€é•¿è¿ç»­åºåˆ—ï¼ˆMediumï¼‰\n\nç»™å®šä¸€ä¸ªæœªæ’åºçš„æ•´æ•°æ•°ç»„ nums ï¼Œæ‰¾å‡ºæ•°å­—è¿ç»­çš„æœ€é•¿åºåˆ—ï¼ˆä¸è¦æ±‚åºåˆ—å…ƒç´ åœ¨åŸæ•°ç»„ä¸­è¿ç»­ï¼‰çš„é•¿åº¦ã€‚\n\nè¯·ä½ è®¾è®¡å¹¶å®ç°æ—¶é—´å¤æ‚åº¦ä¸º **(n)** çš„ç®—æ³•è§£å†³æ­¤é—®é¢˜ã€‚\n\nç¤ºä¾‹ 1ï¼š\n\nè¾“å…¥ï¼šnums = [100,4,200,1,3,2]\n\nè¾“å‡ºï¼š4\n\nè§£é‡Šï¼šæœ€é•¿æ•°å­—è¿ç»­åºåˆ—æ˜¯ [1, 2, 3, 4]ã€‚å®ƒçš„é•¿åº¦ä¸º 4ã€‚\n\n## æš´åŠ›è§£ï¼šï¼ˆå…¶å®æ˜¯è¶…æ—¶çš„ï¼Œå› ä¸ºå¤æ‚åº¦ä¸ºo(nlogn)ï¼‰\n\n> æœ€å‚»é€¼çš„ä¸€é›†ï¼Œè¿™é‡Œ**Arrays.sort**å°±å·²ç»è¶…å‡ºå¤æ‚åº¦äº†ï¼Œä½†æ˜¯å±…ç„¶ä¹Ÿæ²¡è¶…æ—¶ï¼Œç”šè‡³æ¯”è¶…è¿‡90%ï¼Œæ„Ÿè§‰æœ‰ç‚¹ã€‚\n\n> æœ€ç®€å•çš„æ€è·¯ï¼Œæ’åºç„¶åæŒ‡é’ˆï¼Œä»å°åˆ°å¤§å¦‚æœä¸€ç›´é€’å¢å°±è®¡æ•°å™¨ä¸€ç›´åŠ ï¼Œå¦‚æœç›¸ç­‰é‚£å°±è®¡æ•°å™¨ä¸åŠ¨ï¼Œå¦‚æœä¸æ˜¯ï¼Œé‚£å°±è®¡æ•°å™¨é‡æ–°å˜ä¸º1 \n```java\npublic int longestConsecutive(int[] nums) {\n    if (nums == null){\n        return 0;\n    }\n    //æç¬‘çš„æ’åº\n    Arrays.sort(nums);\n    int count = 1;\n    int max = 1;\n    for (int i = 1; i < nums.length; i++) {\n        //å½“ä¸”ä»…å½“å½“å‰å…ƒç´ æ˜¯ä¹‹å‰å…ƒç´ çš„å¤š1\n        if (nums[i]==nums[i-1]+1){\n            count++;\n        }\n        //å¦‚æœç›¸ç­‰è®¡æ•°å™¨ç©ºè¿‡\n        else if (nums[i] == nums[i-1]) {\n\n        }\n        //å¦‚æœä¸æ˜¯è¿™æ ·çš„æƒ…å†µå°±ä¸æ˜¯è¿ç»­ï¼Œè®¡æ•°å™¨å˜æˆ1\n        else {\n            count = 1;\n        }\n        max = Math.max(max,count);\n        System.out.println(count);\n    }\n\n    return max;\n}\n```\n\n## å®˜æ–¹è§£ï¼šå“ˆå¸Œè¡¨\n\n>æˆ‘ä»¬è€ƒè™‘æšä¸¾æ•°ç»„ä¸­çš„æ¯ä¸ªæ•° xï¼Œè€ƒè™‘ä»¥å…¶ä¸ºèµ·ç‚¹ï¼Œä¸æ–­å°è¯•åŒ¹é… x+1,x+2... æ˜¯å¦å­˜åœ¨ï¼Œå‡è®¾æœ€é•¿åŒ¹é…åˆ°äº† x+yï¼Œé‚£ä¹ˆä»¥ x ä¸ºèµ·ç‚¹çš„æœ€é•¿è¿ç»­åºåˆ—å³ä¸º x,x+1,x+2,x+yï¼Œå…¶é•¿åº¦ä¸º y+1ï¼Œæˆ‘ä»¬ä¸æ–­æšä¸¾å¹¶æ›´æ–°ç­”æ¡ˆå³å¯ã€‚\n\n>å¯¹äºåŒ¹é…çš„è¿‡ç¨‹ï¼Œæš´åŠ›çš„æ–¹æ³•æ˜¯ O(n) éå†æ•°ç»„å»çœ‹æ˜¯å¦å­˜åœ¨è¿™ä¸ªæ•°ï¼Œä½†å…¶å®æ›´é«˜æ•ˆçš„æ–¹æ³•æ˜¯ç”¨ä¸€ä¸ªå“ˆå¸Œè¡¨å­˜å‚¨æ•°ç»„ä¸­çš„æ•°ï¼Œè¿™æ ·æŸ¥çœ‹ä¸€ä¸ªæ•°æ˜¯å¦å­˜åœ¨å³èƒ½ä¼˜åŒ–è‡³ O(1) çš„æ—¶é—´å¤æ‚åº¦ã€‚\n\n>ä»…ä»…æ˜¯è¿™æ ·æˆ‘ä»¬çš„ç®—æ³•æ—¶é—´å¤æ‚åº¦æœ€åæƒ…å†µä¸‹è¿˜æ˜¯ä¼šè¾¾åˆ° O(n2)\nå³å¤–å±‚éœ€è¦æšä¸¾ O(n) ä¸ªæ•°ï¼Œå†…å±‚éœ€è¦æš´åŠ›åŒ¹é… O(n) æ¬¡ï¼‰ï¼Œæ— æ³•æ»¡è¶³é¢˜ç›®çš„è¦æ±‚ã€‚ä½†ä»”ç»†åˆ†æè¿™ä¸ªè¿‡ç¨‹ï¼Œæˆ‘ä»¬ä¼šå‘ç°å…¶ä¸­æ‰§è¡Œäº†å¾ˆå¤šä¸å¿…è¦çš„æšä¸¾ï¼Œå¦‚æœå·²çŸ¥æœ‰ä¸€ä¸ª x,x+1,x+2,â‹¯,x+y çš„è¿ç»­åºåˆ—ï¼Œè€Œæˆ‘ä»¬å´é‡æ–°ä» x+1ï¼Œx+2 æˆ–è€…æ˜¯ x+y å¤„å¼€å§‹å°è¯•åŒ¹é…ï¼Œé‚£ä¹ˆå¾—åˆ°çš„ç»“æœè‚¯å®šä¸ä¼šä¼˜äºæšä¸¾ x ä¸ºèµ·ç‚¹çš„ç­”æ¡ˆï¼Œå› æ­¤æˆ‘ä»¬åœ¨å¤–å±‚å¾ªç¯çš„æ—¶å€™ç¢°åˆ°è¿™ç§æƒ…å†µè·³è¿‡å³å¯ã€‚\n\n>é‚£ä¹ˆæ€ä¹ˆåˆ¤æ–­æ˜¯å¦è·³è¿‡å‘¢ï¼Ÿç”±äºæˆ‘ä»¬è¦æšä¸¾çš„æ•° x ä¸€å®šæ˜¯åœ¨æ•°ç»„ä¸­ä¸å­˜åœ¨å‰é©±æ•° xâˆ’1 çš„ï¼Œä¸ç„¶æŒ‰ç…§ä¸Šé¢çš„åˆ†ææˆ‘ä»¬ä¼šä» xâˆ’1 å¼€å§‹å°è¯•åŒ¹é…ï¼Œå› æ­¤æˆ‘ä»¬æ¯æ¬¡åœ¨å“ˆå¸Œè¡¨ä¸­æ£€æŸ¥æ˜¯å¦å­˜åœ¨ xâˆ’1 å³èƒ½åˆ¤æ–­æ˜¯å¦éœ€è¦è·³è¿‡äº†ã€‚\n\n```java\npublic int longestConsecutive(int[] nums) {\n    Set<Integer> num_set = new HashSet<Integer>();\n    //å…ˆå»é‡ï¼Œç”¨é›†åˆ\n    for (int num : nums) {\n        num_set.add(num);\n    }\n\n    int longestStreak = 0;\n    //æœ‰ä¸‹ä¸€ä¸ªå€¼çš„æ—¶å€™å°±è·³æ‰ï¼Œä¸€å®šè¦æ²¡æœ‰ä¸‹ä¸€ä¸ªï¼Œè¿™æ ·éå†æ‰æ˜¯o(n)\n    for (int num : num_set) {\n        if (!num_set.contains(num - 1)) {\n            int currentNum = num;\n            int currentStreak = 1;\n            //ç„¶åæ¯”è¾ƒä¸€ä¸‹\n            while (num_set.contains(currentNum + 1)) {\n                currentNum += 1;\n                currentStreak += 1;\n            }\n\n            longestStreak = Math.max(longestStreak, currentStreak);\n        }\n    }\n\n    return longestStreak;\n}\n\n```\n\néå¸¸å·§å¦™çš„o(n),è¿™é‡ŒsetæŸ¥è¯¢æ˜¯o(1)ï¼Œéœ€è¦å¥½å¥½å­¦ä¹ ä¸€ä¸‹ï¼Œå¤šç”¨ç”¨å“ˆå¸Œ","tags":["åˆ·é¢˜ç¬”è®°"]},{"title":"leetcode-2024-3-19","url":"/2024/03/19/leetcode-2024-3-19/","content":"# 1793.å¥½å­æ•°ç»„çš„æœ€å¤§åˆ†æ•°ï¼ˆHardï¼‰\n\nç»™ä½ ä¸€ä¸ªæ•´æ•°æ•°ç»„ nums ï¼ˆä¸‹æ ‡ä» 0 å¼€å§‹ï¼‰å’Œä¸€ä¸ªæ•´æ•° k ã€‚\n\nä¸€ä¸ªå­æ•°ç»„ (i, j) çš„ **åˆ†æ•°** å®šä¹‰ä¸º min(nums[i], nums[i+1], ..., nums[j]) * (j - i + 1) ã€‚ä¸€ä¸ª å¥½ å­æ•°ç»„çš„ä¸¤ä¸ªç«¯ç‚¹ä¸‹æ ‡éœ€è¦æ»¡è¶³ i <= k <= j ã€‚\n\nè¯·ä½ è¿”å› **å¥½** å­æ•°ç»„çš„æœ€å¤§å¯èƒ½ **åˆ†æ•°** ã€‚\n\n## æš´åŠ›è§£ï¼šè¶…å‡ºå†…å­˜é™åˆ¶\n\n> æ€è·¯ï¼šç”¨ä¸€ä¸ªäºŒç»´æ•°ç»„ï¼Œdp[i][j]è¡¨ç¤ºnum[i]åˆ°num[j]çš„æœ€å°å€¼ï¼Œèµ·å§‹dp[i][i]éƒ½ä¸ºnum[i],çŠ¶æ€è½¬ç§»æ–¹ç¨‹ä¸ºï¼šdp[i][j] = min{dp[i][j-1],num[i]},\n> å…¶å®æ˜¯å¯ä»¥åšå‡ºæ¥çš„ã€‚ä½†æ˜¯è¿™æ˜¯hardï¼Œç©ºé—´å¤æ‚åº¦è¦æ±‚æœ‰ç‚¹é«˜ï¼Œå°±ä¼šè¶…å†…å­˜ã€‚æˆ‘çš„è¯„ä»·æ˜¯åŠ¨æ€è§„åˆ’å¾ˆå¥½ï¼Œä¸‹æ¬¡åˆ«ç”¨äº†\n\n```java\npublic int maximumScore(int[] nums, int k) {\n    //äºŒç»´åŠ¨æ€è§„åˆ’\n    int[][] dp = new int[nums.length][nums.length];\n    //åˆå§‹å¯¹è§’çº¿éƒ½ä¸ºè‡ªèº«ï¼Œè‡ªå·±è‚¯å®šæ˜¯æœ€å°å€¼\n    for (int i = 0; i < nums.length; i++) {\n        dp[i][i] = nums[i];\n    }\n    for (int i = 0; i < nums.length-1; i++) {\n        for (int j = i+1; j < nums.length; j++) {\n            //åŠ¨æ€è½¬ç§»æ–¹ç¨‹\n            dp[i][j] = Math.min(nums[j], dp[i][j - 1]);\n        }\n    }\n    //kè¦åœ¨ä¸­é—´ï¼Œé‚£ä¹ˆå°±æ˜¯çŸ©é˜µçš„å³ä¸Šè§’é‚£å—ï¼Œi<=k<=j\n    int max = Integer.MIN_VALUE;\n    for (int i = 0; i <= k; i++) {\n        for (int j = k; j < nums.length; j++) {\n            int length = j-i+1;\n            max = Math.max(max,length*dp[i][j]);\n        }\n    }\n    //è¿”å›åœ¨å³ä¸Šè§’çš„æœ€å¤§å€¼\n    return max;\n}\n```\n## å®˜æ–¹è§£ ï¼šåŒæŒ‡é’ˆ\n> ä»¥kä¸ºåŸç‚¹ï¼Œhead=k-1ï¼Œrear=k+1ï¼Œå·¦å¼€å³å¼€åŒºé—´ï¼Œæ•°æ®é•¿åº¦rear-head+1ï¼Œåˆå§‹æ—¶é•¿åº¦åªæœ‰1å³ä¸ºnums[k]æœ¬èº«ï¼Œä¹Ÿä¸ºæœ€å°å€¼ã€‚\n> é‚£ä¹ˆæ€ä¹ˆæ ·æ‰¾åŒ…å«ä»–çš„æœ€å°å€¼å‘¢ï¼Œåªè¦æ‰¾å·¦å³ä¸¤è¾¹æ¯”ä»–å¤§çš„ï¼Œæ•´ä½“çš„æœ€å°å€¼å°±æ˜¯ä¸å˜çš„ï¼Œé‚£ä¹ˆé•¿åº¦*æœ€å°å€¼å°±ä¼šæœ‰æ•ˆå˜å¤§ï¼Œç›´åˆ°åŒæŒ‡é’ˆé‡åˆ°æ¯”å½“å‰æœ€å°å€¼è¿˜è¦å°çš„å…ƒç´ \n> é‚£ä¹ˆç”±äºåˆå§‹æœ€å°å€¼å°±æ˜¯æœ¬èº«ï¼Œé‚£ä¹ˆåªè¦å¾ªç¯æœ¬èº«è¿™ä¸ªå€¼ä¸æ–­é€’å‡å°±å¯ä»¥äº†ã€‚\n```java\npublic int maximumScore(int[] nums, int k) {\n    int length = nums.length;\n    int head = k-1,rear = k+1;\n    int max = Integer.MIN_VALUE;\n    for (int i = nums[k];;i--){\n        while (head >=0 && nums[head] >= i){\n            head--;\n        }\n        while (rear < nums.length && nums[rear] >= i){\n            rear++;\n        }\n        max = Math.max(max,(rear-head-1)*i);\n        if (head == -1 && rear == length){\n            break;\n        }\n    }\n    return max;\n}\n```\nå¤æ‚åº¦åˆ†æ\n\næ—¶é—´å¤æ‚åº¦ï¼šO(n+C)ï¼Œå…¶ä¸­ n æ˜¯æ•°ç»„nums çš„é•¿åº¦ï¼ŒC æ˜¯æ•°ç»„ nums ä¸­å…ƒç´ çš„èŒƒå›´ã€‚\n\nç©ºé—´å¤æ‚åº¦ï¼šO(1)ã€‚æ˜æ˜¾æ¯”æˆ‘è‡ªå·±å†™çš„æš´åŠ›è§£å¥½\n\n","tags":["åˆ·é¢˜ç¬”è®°"]},{"title":"æˆ‘çš„ç¬¬ä¸€ç¯‡blog","url":"/2024/03/19/æˆ‘çš„ç¬¬ä¸€ç¯‡blog/","content":"  åšè¿™ä¸ªåšå®¢çš„ç›®çš„æ˜¯ä¸ºäº†èƒ½æ¿€åŠ±è‡ªå·±ï¼Œä¸è¦çœ‹äº†ä¸€éå°±è§‰å¾—è‡ªå·±ä¼šäº†ã€‚å¥½è®°æ€§ä¸å¦‚çƒ‚ç¬”å¤´ï¼Œåˆ·é¢˜çš„æ€è·¯å°½é‡å¤šå†™ï¼Œå¾ˆéš¾è¯´ä¸‹æ¬¡ç¢°åˆ°ä¸€æ ·çš„é¢˜ç›®ä¼šä¸ä¼šå¿˜æ‰ã€‚\n\n  è¿˜æœ‰25å¤©è“æ¡¥æ¯ï¼Œè®©æˆ‘è¿™ä¸ªå¤§å››è€ç‹—éšä¾¿å¾—ä¸ªå¥–å§~~\n\n  ![ä¸Šæµ·å¤–å›½è¯­å¤§å­¦æ ¡èŠ±](../img/coding/2024_3_19_1.JPG)\n","tags":["é—²è°ˆ"]}]