<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <!-- Website mata -->
<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

<!-- Disable transformation -->
<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<!-- Website description -->


<!-- Website keywords -->




<!-- Website rss -->

<link rel="alternate" href="/default" title="YYF's Blog" >


<!-- Website favicon -->

<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=3.0.0" />


<!-- Canonical, good for google search engine -->
<link rel="canonical" href="https://yyf1050886654.github.io/" />

<!-- Fancybox styling -->

<link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css" />


<!-- MathJax (LaTeX) support -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });  
  </script>
<script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>


<!-- Theme styling -->
<link rel="stylesheet" type="text/css" href="/css/style.css?v=3.0.0" />

<!-- Analytics and push -->



  



<!-- LeanCloud Counter -->


<script>
  window.config = {"leancloud":{"app_id":null,"app_key":null,"server_url":null,"cdn":null},"toc":true,"fancybox":true,"latex":true};
</script>
  
  <title>YYF&#39;s Blog</title>

<meta name="generator" content="Hexo 7.1.1"></head>

<body>
  <div class="scrollPercentage"></div>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">YYF&#39;s Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    
    <a href="/">
      <li class="mobile-menu-item">
        
        
        é¦–é¡µ              </li>
    </a>
    
    <a href="/archives/">
      <li class="mobile-menu-item">
        
        
        å½’æ¡£              </li>
    </a>
    
    <a href="/tags/">
      <li class="mobile-menu-item">
        
        
        æ ‡ç­¾              </li>
    </a>
    
    <a href="/categories/">
      <li class="mobile-menu-item">
        
        
        åˆ†ç±»              </li>
    </a>
    
    <a href="/collect/">
      <li class="mobile-menu-item">
        
        
        æ”¶è—              </li>
    </a>
    
    <a href="/about/">
      <li class="mobile-menu-item">
        
        
        å…³äº              </li>
    </a>
    
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
      <div class="logo-wrapper">  
  <a href="/." class="logo">YYF's Blog</a>  
</div>  
  
<nav class="site-navbar">  
    
    <ul id="menu" class="menu">  
        
        <li class="menu-item">  
          <a class="menu-item-link" href="/">  
              
              
              é¦–é¡µ  
              
          </a>  
        </li>  
        
        <li class="menu-item">  
          <a class="menu-item-link" href="/archives/">  
              
              
              å½’æ¡£  
              
          </a>  
        </li>  
        
        <li class="menu-item">  
          <a class="menu-item-link" href="/tags/">  
              
              
              æ ‡ç­¾  
              
          </a>  
        </li>  
        
        <li class="menu-item">  
          <a class="menu-item-link" href="/categories/">  
              
              
              åˆ†ç±»  
              
          </a>  
        </li>  
        
        <li class="menu-item">  
          <a class="menu-item-link" href="/collect/">  
              
              
              æ”¶è—  
              
          </a>  
        </li>  
        
        <li class="menu-item">  
          <a class="menu-item-link" href="/about/">  
              
              
              å…³äº  
              
          </a>  
        </li>  
        
    </ul>  
    
</nav>  

    </header>
    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <section id="posts" class="posts">
  
  
  
  <article class="post">
  <header class="post-header">
    <h1 class="post-title">
      
      <a class="post-link" href="/2025/02/28/%E7%BD%91%E6%98%93KM%E7%A4%BE%E5%8C%BA%E5%88%86%E4%BA%AB-%E5%BF%AB%E9%80%9F%E6%90%AD%E5%BB%BA%E5%9F%BA%E4%BA%8ERAG%E7%9A%84%E7%83%AD%E7%82%B9-AI%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E/">ç½‘æ˜“KMç¤¾åŒºåˆ†äº«-å¿«é€Ÿæ­å»ºåŸºäºRAGçš„çƒ­ç‚¹ AIæœç´¢å¼•æ“</a>
      
    </h1>

    <div class="post-meta">
      <span class="post-time">
        2025-02-28
      </span>
      
      
      
    </div>
  </header>

  

  <div class="post-content">
    
    
    

    
    <blockquote>
<p>å¤§æ¨¡å‹çš„å‡ºç°å¸¦æ¥äº†æ–°çš„æŠ€æœ¯é©æ–°ï¼Œå®ƒå¼ºå¤§çš„å¯¹è¯ï¼Œåˆ†æï¼Œç”Ÿæˆèƒ½åŠ›å¯ä»¥åº”ç”¨åœ¨éŸ³ä¹çš„å¾ˆå¤šæ–¹é¢ã€‚æˆ‘ä»¬å¸Œæœ›å€ŸåŠ©å¤§æ¨¡å‹çš„èƒ½åŠ›ï¼Œ å®ç°å¯¹ç«™å†…å¤–éŸ³ä¹çƒ­ç‚¹è¯æ¡å†…å®¹è¿›è¡ŒæŠ½å–ï¼Œåˆ†æï¼Œæ€»ç»“ï¼Œæ¨èã€‚ æœ¬æ–‡å°†ç³»ç»Ÿçš„ä»‹ç»æˆ‘ä»¬å¦‚ä½•åŸºäºRAG æ­å»ºä¸€ä¸ªå¸¦å‰ç«¯é¡µé¢çš„ çƒ­ç‚¹AIæ£€ç´¢åŠŸèƒ½agent<br>ä½“éªŒåœ°å€ï¼š<a target="_blank" rel="noopener" href="http://llm-zq.jupyter.panshi-gy.netease.com/">http://llm-zq.jupyter.panshi-gy.netease.com/</a></p>
</blockquote>
<h1 id="1-èƒŒæ™¯"><a href="#1-èƒŒæ™¯" class="headerlink" title="1.èƒŒæ™¯"></a>1.èƒŒæ™¯</h1><p>å¤§æ¨¡å‹çš„å‡ºç°å¸¦æ¥äº†æ–°çš„æŠ€æœ¯é©æ–°ï¼Œå®ƒå¼ºå¤§çš„å¯¹è¯ï¼Œåˆ†æï¼Œç”Ÿæˆèƒ½åŠ›å¯ä»¥åº”ç”¨åœ¨éŸ³ä¹çš„å¾ˆå¤šæ–¹é¢ã€‚æˆ‘ä»¬å¸Œæœ›å€ŸåŠ©å¤§æ¨¡å‹çš„èƒ½åŠ›ï¼Œ å®ç°å¯¹ç«™å†…å¤–éŸ³ä¹çƒ­ç‚¹è¯æ¡å†…å®¹è¿›è¡ŒæŠ½å–ï¼Œåˆ†æï¼Œæ€»ç»“ï¼Œæ¨èã€‚ ä½†æ˜¯:</p>
<ul>
<li>å¤§æ¨¡å‹å¯¹äºæ—¶äº‹çƒ­ç‚¹ç­‰ï¼Œå¹»è§‰èƒ½åŠ›ä¸¥é‡ï¼Œè€ŒRAG(æ£€ç´¢å¢å¼ºç”Ÿæˆ)å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</li>
<li>å¾ˆå¤šéƒ½ç¦»ä¸å¼€å¤–éƒ¨çš„ä¾èµ–æ¥å£ï¼Œæ— æ³•åšåˆ°å®Œå…¨çš„offline, ä¸”å½“tokené‡å¤§ä¹‹åï¼Œè´¹ç”¨ä¹Ÿå¾ˆå¤§ï¼Œ ä½†å…¶å®å¼€æºçš„å¾ˆå¤šæ¨¡å‹å¦‚LLAMA, QWENç­‰éƒ½å·²ç»æœ‰éå¸¸ä¸é”™çš„èƒ½åŠ›ã€‚è€Œä¸”è¿‘æœŸæµè¡Œçš„ollamaæ¡†æ¶ï¼Œ ä¹Ÿè®©ä¸ªäººPCä¹Ÿéƒ½èƒ½æ”¯æŒå¤§æ¨¡å‹ç”Ÿæˆã€‚</li>
<li>æˆ‘ä»¬å¸Œæœ›å€ŸåŠ©å¼€æºçš„èƒ½åŠ›ï¼Œæ¥å¿«é€Ÿæ­å»ºä¸€ä¸ªä¸ä¾èµ–å¤–éƒ¨æ¥å£çš„AIæ£€ç´¢å¼•æ“æ¥ä¸ºæˆ‘ä»¬æœåŠ¡ï¼Œ ä¹Ÿé¿å…äº†éšç§æ³„éœ²çš„é£é™©ã€‚</li>
</ul>
<p>å®ƒçš„ä¸»è¦ç‰¹ç‚¹ï¼š</p>
<ul>
<li>ä¸ä¾èµ–å¤–éƒ¨æ¥å£ï¼Œ ç¦»çº¿å®ç°LLMç”Ÿæˆ, æ£€ç´¢ï¼Œembeddingç­‰èƒ½åŠ›ã€‚</li>
<li>åŸºäºäº’è”ç½‘ç»“æœè¿›è¡ŒRAGï¼Œè§£å†³æ¨¡å‹ç”Ÿæˆå¹»è§‰çš„é—®é¢˜ï¼Œå°¤å…¶å¯ä»¥æ”¯æŒå¯¹äºè¿‘æœŸçƒ­ç‚¹çŸ¥è¯†çš„æ€»ç»“ã€‚<br>æœ¬æ–‡ä¸»è¦ä»‹ç»å¼€å‘è¿™ä¸ªagentçš„æ¡†æ¶ï¼Œä¸€äº›æŠ€æœ¯ç»†èŠ‚å’Œæ€è·¯ï¼Œå¸Œæœ›ç»™å¤§å®¶å¸¦æ¥ä¸€ç‚¹LLM å¼€å‘çš„æ”¶è·ã€‚æ•ˆæœå›¾å¦‚ä¸‹ï¼Œå·¦è¾¹æ˜¯æˆ‘ä»¬çš„agent, è¾“å…¥é—®é¢˜æè¿°ï¼Œç³»ç»Ÿå³å¯è‡ªåŠ¨è°ƒç”¨æœç´¢å¼•æ“å¹¶çˆ¬å–äº’è”ç½‘çš„å†…å®¹ï¼Œå¹¶é€šè¿‡å¤§æ¨¡å‹åˆ†ææ€»ç»“è¿”å›ç»™æˆ‘ä»¬é—®é¢˜çš„ç»“æœã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œç”šè‡³æ¯”KIMIçš„æ•ˆæœè¿˜è¦å¥½ã€‚</li>
</ul>
<p><img src="/../img/netease/img.png" alt="img.png"></p>
<h1 id="2-æ¡†æ¶"><a href="#2-æ¡†æ¶" class="headerlink" title="2.æ¡†æ¶"></a>2.æ¡†æ¶</h1><p>æ€»ä½“æ¡†æ¶å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œä¸»è¦åŒ…æ‹¬3ä¸ªå­æ¨¡å—ï¼š</p>
<ul>
<li>(1) æ£€ç´¢çˆ¬å–æœåŠ¡ï¼šæ ¹æ®ç”¨æˆ·æœç´¢çš„çƒ­ç‚¹å…³é”®è¯ï¼Œè°ƒç”¨è‡ªå»ºçš„searxng åŒ¿åæ£€ç´¢æœåŠ¡ç³»ç»Ÿ, è·å–topçš„äº’è”ç½‘æœç´¢å¼•æ“ç»“æœï¼Œå¹¶çˆ¬å–ç›¸å…³ç½‘å€å…¨æ–‡å†…å®¹ã€‚</li>
<li>(2) æ–‡æ¡£å¬å›æœåŠ¡ï¼šå¯¹çˆ¬å–çš„å…¨æ–‡å†…å®¹åˆ‡å—ï¼Œè¿›è¡Œå‘é‡åŒ–ï¼ŒåŒæ—¶å¯¹queryä¹Ÿè¿›è¡Œå‘é‡åŒ–ï¼Œè®¡ç®—queryå’Œæ–‡æ¡£çš„ç›¸å…³æ€§ï¼Œå¹¶è¿›è¡Œæ’åºé€‰å–topçš„æ–‡æ¡£åˆ‡å—</li>
<li>(3) å¤§æ¨¡å‹ç”ŸæˆæœåŠ¡ã€‚ç¦»çº¿éƒ¨ç½²å¥½å¤§æ¨¡å‹ï¼Œè¾“å…¥ç›¸å…³æ–‡æ¡£å’Œé…ç½®çš„prompt, ç”Ÿæˆç›¸å…³çš„æ£€ç´¢ç­”æ¡ˆæ±‡æ€»ï¼Œå¹¶é€šè¿‡éƒ¨ç½²çš„streamlitå‰ç«¯æœåŠ¡è¿”å›ç»™ç”¨æˆ·ã€‚</li>
</ul>
<p><img src="/../img/netease/img_1.png" alt="img_1.png"></p>
<p>3ä¸ªæ¨¡å—é€šè¿‡langchainæ¡†æ¶è¿›è¡Œä¸²è”èµ·æ¥å·¥ä½œï¼Œapiæ¥å£éƒ½é‡‡ç”¨fastapiè¿›è¡Œå°è£…ï¼Œ å‰ç«¯å±•ç¤ºç”¨streamlitè¿›è¡Œäº¤äº’å¼€å‘ã€‚</p>
<h1 id="3-å®ç°"><a href="#3-å®ç°" class="headerlink" title="3. å®ç°"></a>3. å®ç°</h1><p>åŸºäºåŸºæœ¬çš„æ¡†æ¶æ€è·¯ï¼Œæˆ‘ä»¬å‰æœŸè°ƒç ”äº†å‘ç°githubå·²æœ‰ç±»ä¼¼çš„ç›¸å…³é¡¹ç›®ï¼Œåœ¨è¿™äº›é¡¹ç›®çš„åŸºç¡€ä¸Šï¼Œæˆ‘ä»¬åšäº†ä¸€äº›ä¼˜åŒ–ã€‚</p>
<p>LLocalSarch:<a target="_blank" rel="noopener" href="https://github.com/nilsherzig/LLocalSearch">https://github.com/nilsherzig/LLocalSearch</a></p>
<p>LangChain-SearXNG: <a target="_blank" rel="noopener" href="https://github.com/ptonlix/LangChain-SearXNG">https://github.com/ptonlix/LangChain-SearXNG</a></p>
<h2 id="3-1-æ£€ç´¢çˆ¬å–æœåŠ¡"><a href="#3-1-æ£€ç´¢çˆ¬å–æœåŠ¡" class="headerlink" title="3.1 æ£€ç´¢çˆ¬å–æœåŠ¡"></a>3.1 æ£€ç´¢çˆ¬å–æœåŠ¡</h2><p>æ£€ç´¢çˆ¬å–æœåŠ¡ä¸»è¦æœ‰ä¸¤ä¸ªæ¨¡å—ã€‚searxngæ£€ç´¢æœåŠ¡ å’Œçˆ¬è™«æœåŠ¡</p>
<h3 id="3-1-1-searxngæ£€ç´¢æœåŠ¡"><a href="#3-1-1-searxngæ£€ç´¢æœåŠ¡" class="headerlink" title="3.1.1 searxngæ£€ç´¢æœåŠ¡"></a>3.1.1 searxngæ£€ç´¢æœåŠ¡</h3><p>SearXNG æ˜¯ä¸€ä¸ªå…è´¹çš„äº’è”ç½‘å…ƒæœç´¢å¼•æ“ï¼Œå®ƒèšåˆäº†æ¥è‡ªå„ç§æœç´¢æœåŠ¡(å¦‚ google, duckduckgoç­‰)å’Œæ•°æ®åº“ï¼ˆå¦‚wikiï¼‰çš„ç»“æœï¼Œä½†æ‘†è„±äº†éšç§è¿½è¸ªã€‚</p>
<p>å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥é‡‡ç”¨å•†ä¸šçš„æœç´¢api æ¥å£ï¼Œæ¯”å¦‚googleçš„Serper API ï¼Œ bingçš„Bing Web Search APIï¼Œä½†è¿™ä¸æ˜¯æˆ‘ä»¬çš„ç›®çš„ï¼Œæˆ‘ä»¬æ˜¯å¸Œæœ›æ­å»ºä¸€ä¸ªå®Œå…¨æ²¡æœ‰å¤–éƒ¨ä¾èµ–çš„æ£€ç´¢æœåŠ¡ã€‚</p>
<p>è¯·æ³¨æ„ï¼Œæ­å»ºsearxngæ£€ç´¢éœ€è¦ä¸€å°éå¤§é™†çš„VPSï¼Œå¹¶é…æœ‰ipv4åœ°å€ï¼Œå¦‚æœå«Œéº»çƒ¦ï¼Œå¯ä»¥ç”¨å…¬å…±çš„searxng, ä½†æ˜¯ä¼šæœ‰é™åˆ¶ï¼Œåœ°å€ï¼š<a target="_blank" rel="noopener" href="https://searx.space(éœ€è¦fq)/">https://searx.space(éœ€è¦FQ)</a></p>
<p><img src="/../img/netease/img_2.png" alt="img_2.png"></p>
<p>ä»¥ä¸‹æ˜¯æ­å»ºæ•™ç¨‹ï¼š</p>
<ol>
<li>ç¬¬ä¸€æ­¥ï¼šå®‰è£…docker, docker-copose</li>
</ol>
<p>dockerå®‰è£…ï¼š<a target="_blank" rel="noopener" href="https://yeasy.gitbook.io/docker_practice/install/debian">https://yeasy.gitbook.io/docker_practice/install/debian</a></p>
<p>docker-coposeå®‰è£…ï¼š<a target="_blank" rel="noopener" href="https://yeasy.gitbook.io/docker_practice/compose/install">https://yeasy.gitbook.io/docker_practice/compose/install</a></p>
<ol start="2">
<li>ç¬¬äºŒæ­¥ï¼šæ‹‰å–searxng é•œåƒ, ä¿®æ”¹é…ç½®</li>
</ol>
<p>ä¿®æ”¹é¡¹ç›®dockeré…ç½®</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># æ‹‰å–ä»£ç </span><br><span class="line">git clone https://github.com/searxng/searxng-docker.git</span><br><span class="line"># dockeré…ç½®é‡ŒåŒ…æ‹¬3ä¸ªæœåŠ¡ï¼Œcaddy åšåå‘ä»£ç†ï¼Œrediså­˜å‚¨æ•°æ®ï¼Œsearxngä¸»æœåŠ¡</span><br><span class="line">#ä¸åšåå‘ä»£ç†å¯ä»¥æ³¨é‡Šæ‰caddyéƒ¨åˆ†ï¼Œ åªéœ€è¦ä¿®æ”¹ searxngé‡Œçš„portï¼Œå¦‚ï¼š 0.0.0.0:8180:8080ï¼Œ å³è¾¹æ˜¯è®¾ç½®å¥½çš„å®¹å™¨å†…çš„ç«¯å£ï¼Œå·¦è¾¹æ˜¯æœ¬åœ°ç«¯å£å¯ä»¥æ”¹</span><br><span class="line">vim searxng-docker/docker-compose.yaml</span><br></pre></td></tr></table></figure>

<p><img src="/../img/netease/img_3.png" alt="img_3.png"></p>
<p><img src="/../img/netease/img_4.png" alt="img_4.png"></p>
<p>ä¿®æ”¹searxngä¸»æœåŠ¡é…ç½®</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sed -i &quot;s|ultrasecretkey|$(openssl rand -hex 32)|g&quot; searxng-docker/searxng/settings.yml # ç”Ÿæˆä¸€ä¸ªå¯†é’¥</span><br><span class="line"># limiter: æ”¹ä¸ºfalse, ä¸ºtrueä¼šé™åˆ¶ä½ çš„è¯·æ±‚é¢‘ç‡ï¼Œå…¬å¼€æœåŠ¡ä¼šå¼€å¯ï¼Œä½†æ˜¯ç§äººæ­å»ºçš„å¯ä»¥å…³é—­</span><br><span class="line">vim searxng-docker/searxng/setting.yml</span><br></pre></td></tr></table></figure>
<p><img src="/../img/netease/img_5.png" alt="img_5.png"><br>3.ç¬¬ä¸‰æ­¥ï¼šå¯åŠ¨compose æœåŠ¡ç»„</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd searxng-docker</span><br><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>ç¬¬å››æ­¥ï¼šå…³é—­ç«¯å£é˜²ç«å¢™å¹¶éªŒè¯ï¼Œå¦‚æœæ²¡æœ‰é˜²ç«å¢™åˆ™ä¸éœ€è¦è¿™ä¸€æ­¥</li>
</ol>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ufw allow 8180</span><br></pre></td></tr></table></figure>

<p>æœ€åæµè§ˆå™¨æ‰“å¼€ip:8180,å³å¯çœ‹åˆ°è‡ªå·±æ­å»ºçš„searxngé¡µé¢å¹¶è¿›è¡Œæ£€ç´¢äº†ï¼Œæ˜¯ä¸æ˜¯å¾ˆé…·ğŸ˜ï¼Œæ²¡æœ‰ä»»ä½•å¹¿å‘Šï¼Œé¡µé¢éå¸¸å¹²å‡€ã€‚</p>
<p><img src="/../img/netease/img_6.png" alt="img_6.png"></p>
<h3 id="3-1-2-çˆ¬è™«æœåŠ¡"><a href="#3-1-2-çˆ¬è™«æœåŠ¡" class="headerlink" title="3.1.2 çˆ¬è™«æœåŠ¡"></a>3.1.2 çˆ¬è™«æœåŠ¡</h3><p>å•ç‹¬searxngçš„ç»“æœä¿¡æ¯é‡æ¯”è¾ƒå°ï¼Œè€Œå¯¹äºLLMæ¥è¯´ï¼Œä¸°å¯Œçš„ä¿¡æ¯æ„å‘³ç€æ›´å‡†ç¡®çš„ç»“æœã€‚ æ‰€ä»¥é’ˆå¯¹æœç´¢å¼•æ“ç»™å‡ºçš„ç›¸å…³ç½‘é¡µï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨çˆ¬è™«çˆ¬å–topç½‘é¡µç»“æœã€‚ æ‰€å¹¸ï¼Œlangchainï¼ˆä¸€ä¸ªå¸®åŠ©åœ¨åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨å¤§å‹è¯­è¨€æ¨¡å‹çš„ç¼–ç¨‹æ¡†æ¶ï¼‰ é‡Œå°±åŒ…å«äº†ç›¸åº”çš„ç½‘é¡µçˆ¬å–æ¨¡å—ï¼Œå’Œæ–‡æœ¬è§£ææ¨¡å—ã€‚</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># langchain è°ƒç”¨searxngç¤ºä¾‹, è·å–topç»“æœ</span><br><span class="line">from langchain_community.utilities import SearxSearchWrapper</span><br><span class="line">s = SearxSearchWrapper(searx_host=&quot;http://localhost:8180&quot;)</span><br><span class="line">s.run(&quot;what is a large language model?&quot;)</span><br></pre></td></tr></table></figure>

<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># langchain çˆ¬å–ç¤ºä¾‹</span><br><span class="line">from langchain_community.document_loaders import AsyncChromiumLoader</span><br><span class="line">from langchain_community.document_transformers import Html2TextTransformer</span><br><span class="line">urls = [&quot;https://www.baidu.com&quot;]</span><br><span class="line">loader = AsyncChromiumLoader(urls, user_agent=&quot;MyAppUserAgent&quot;)</span><br><span class="line">docs = loader.load() # çˆ¬å–</span><br><span class="line">html2text = Html2TextTransformer()  </span><br><span class="line">docs_transformed = html2text.transform_documents(docs) # è§£ææŠ½å–ç½‘é¡µé‡Œæ–‡æœ¬</span><br><span class="line">docs_transformed[0].page_content[0:500]</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œé¢åœ¨å®è·µä¸­å­˜åœ¨å‡ ä¸ªä¸»è¦é—®é¢˜ï¼š</p>
<ol>
<li>searxngçš„topç»“æœä¸­å¯èƒ½å­˜åœ¨æ— æ³•è®¿é—®çš„(å¤§é™†)ï¼Œæ¯”å¦‚wiki ç­‰ï¼Œéœ€è¦é¢å¤–å¤„ç†è¿‡æ»¤ã€‚ è¿™é‡Œæˆ‘é‡‡ç”¨çš„æ˜¯pacæ–¹å¼ã€‚è¿‡æ»¤ä¸èƒ½è®¿é—®çš„ç½‘å€</li>
</ol>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># wget https://raw.githubusercontent.com/petronny/gfwlist2pac/master/gfwlist.pac</span><br><span class="line">import pacparser</span><br><span class="line">pacparser.init()</span><br><span class="line">pacparser.parse_pac(&#x27;gfwlist.pac&#x27;)</span><br><span class="line"></span><br><span class="line">def is_direct(url):</span><br><span class="line">ret =  pacparser.find_proxy(url)</span><br><span class="line">return &quot;DIRECT&quot; == ret</span><br><span class="line"></span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">print(is_direct(&quot;www.baidu.com&quot;))</span><br><span class="line">print(is_direct(&quot;www.google.com&quot;))</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>å¯èƒ½å­˜åœ¨è¶…æ—¶çš„é—®é¢˜ï¼Œæœ‰äº›ç½‘ç«™é“¾æ¥é€Ÿåº¦éå¸¸æ…¢ï¼ŒåŸæœ¬çš„langchain çˆ¬å–æ¨¡å—ä¸æ”¯æŒè¶…æ—¶ï¼Œéœ€è¦è‡ªå·±åœ¨å¤–é¢é¢å¤–å°è£…ä¸€å±‚è¶…æ—¶æ§åˆ¶ã€‚æˆ–è€…é‡‡ç”¨httpxçš„åŒ…è¿›è¡Œæ‰¹é‡çˆ¬å–ã€‚</li>
</ol>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">import httpx</span><br><span class="line">from typing import List, Optional,Tuple</span><br><span class="line">import asyncio</span><br><span class="line">headers = &#123;&#x27;user-agent&#x27;: &#x27;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.0.0 Safari/537.36&#x27;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">async def get_result(url: str):</span><br><span class="line">if not is_direct(url): # éç›´è¿</span><br><span class="line">async with httpx.AsyncClient(proxy=&#x27;socks5://127.0.0.1:1080&#x27;) as client:</span><br><span class="line">try:</span><br><span class="line">response = await client.get(url,headers=headers,timeout=10.0)  # è®¾ç½®è¶…æ—¶</span><br><span class="line">return url, response</span><br><span class="line">except httpx.RequestError:</span><br><span class="line">return url, None</span><br><span class="line">else:</span><br><span class="line">async with httpx.AsyncClient() as client:</span><br><span class="line">try:</span><br><span class="line">response = await client.get(url,headers=headers,timeout=10.0)</span><br><span class="line">return url, response</span><br><span class="line">except httpx.RequestError:</span><br><span class="line">return url, None</span><br><span class="line"></span><br><span class="line">async def get_results( urls: List[str]):</span><br><span class="line">tasks = [get_result(url) for url in urls]</span><br><span class="line">results = await asyncio.gather(*tasks)</span><br><span class="line">for url, response in results:</span><br><span class="line">if response is None:</span><br><span class="line">print(f&quot;URL: &#123;url&#125; - Failed to connect&quot;)</span><br><span class="line"># else:</span><br><span class="line">#     print(url, response.text[:100])</span><br><span class="line">return results</span><br><span class="line"></span><br><span class="line">def get_results_access( urls: List[str]) -&gt; List[Tuple[str,str]]:</span><br><span class="line">try:</span><br><span class="line">asyncio.get_running_loop()</span><br><span class="line">with ThreadPoolExecutor(max_workers=1) as executor:</span><br><span class="line">future = executor.submit(asyncio.run, check_urls(urls))</span><br><span class="line">results = future.result()</span><br><span class="line">except RuntimeError:</span><br><span class="line">results = asyncio.run(check_urls(urls))</span><br><span class="line"></span><br><span class="line">    return [(url,response.text) for url, response in results if response is not None]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>çˆ¬å–çš„ç»“æœå¦‚æœæ˜¯åŠ¨æ€åŠ è½½çš„å†…å®¹ï¼Œç›®å‰æ— æ³•çˆ¬å–ã€‚ æ¯”å¦‚ Bç«™è§†é¢‘ä¸‹çš„è¯„è®ºï¼Œ çŸ¥ä¹çš„ç­”æ¡ˆç­‰ã€‚è¿™ç§éœ€è¦é’ˆå¯¹ç‰¹å®šç½‘ç«™ï¼Œ ç”¨è‡ªåŠ¨åŒ–æµ‹è¯•å·¥å…·ï¼Œæ¯”å¦‚Selenium æˆ–è€…playwright. è¿™ä¸ªå¾…åç»­ä¼˜åŒ–ã€‚</li>
</ol>
<h2 id="3-2-åˆ‡å—å¬å›æœåŠ¡"><a href="#3-2-åˆ‡å—å¬å›æœåŠ¡" class="headerlink" title="3.2 åˆ‡å—å¬å›æœåŠ¡"></a>3.2 åˆ‡å—å¬å›æœåŠ¡</h2><p>è¿™ä¸€æ­¥ï¼Œå…¶å®ä¸»è¦å¯¹åº”RAGé‡ŒRå³retrieval, å¬å›ã€‚å› ä¸ºè·å–çš„topç½‘å€æ–‡æœ¬å†…å®¹é‡æ¯”è¾ƒå¤§ï¼Œä¸€èˆ¬å•ä¸ªç½‘é¡µçš„æ–‡æœ¬éƒ½æ¥è¿‘5k token, åƒç™¾åº¦çŸ¥é“è¿™ç§ä»¥æ–‡æœ¬å†…å®¹ä¸ºä¸»çš„åŸºæœ¬éƒ½è¶…è¿‡8ké•¿åº¦ï¼Œå¤šä¸ªç½‘é¡µå†…å®¹ç›´æ¥ä¸¢ç»™å¤§æ¨¡å‹è§£æï¼Œæ˜¯ä¸ªä¸å¤ªç°å®çš„ä»»åŠ¡ï¼Œè™½ç„¶ç°åœ¨æœ‰å­¦è€…æå‡ºè¶…é•¿ä¸Šä¸‹æ–‡çš„å¤§æ¨¡å‹ï¼ˆLong Context LLMï¼‰æ­£åœ¨æ…¢æ…¢å–ä»£RAG, ä½†ç›®å‰æ¥è¯´ragè¿˜æ˜¯æœ€ä¼˜è§£ã€‚</p>
<p>å¬å›è¿‡ç¨‹æ˜¯åˆ†ä¸º åˆ‡å—ï¼Œå‘é‡åŒ–ï¼Œæ’åº</p>
<h3 id="3-2-1-åˆ‡å—"><a href="#3-2-1-åˆ‡å—" class="headerlink" title="3.2.1 åˆ‡å—"></a>3.2.1 åˆ‡å—</h3><p>æ‰€æœ‰çš„æ–‡æ¡£è¿›è¡Œchunk, å³åˆ‡å—ï¼Œ æ¯”å¦‚ä»¥512ä¸ª token ä½œä¸ºä¸€ä¸ªchunkã€‚è¿™é‡Œé¢æœ‰å‡ ä¸ªé—®é¢˜ï¼š</p>
<ol>
<li>å¦‚ä½•ç¡®å®šæœ€ä½³å—å¤§å°ï¼Ÿ</li>
</ol>
<p>è¿™ä¸ªç›®å‰æ²¡æœ‰å®šè®ºï¼Œä¸»è¦è¿˜æ˜¯å–å†³äºåº”ç”¨åœºæ™¯ï¼Œå…·ä½“å¯ä»¥å‚è€ƒå¾®è½¯[1]çš„å»ºè®®å¹¶è‡ªè¡Œè¿›è¡Œæµ‹è¯•ï¼š</p>
<p><img src="/../img/netease/img_7.png" alt="img_7.png"></p>
<ol start="2">
<li>åˆ†å‰²ç­–ç•¥ï¼Ÿ</li>
</ol>
<p>ä¸ºäº†å¾—åˆ°æ›´å¥½çš„ç»“æœï¼Œæˆ‘ä»¬å¯ä»¥é‡å ç›¸é‚»çš„å—ã€‚æ¥è‡ªå¾®è½¯åˆ†æçš„åˆ†å—ç­–ç•¥æ¯”è¾ƒï¼Œæ˜¾ç¤º512 tokensåˆ†å—å’Œ25%çš„é‡å æ˜¯æ¯”è¾ƒå¥½çš„åˆ†å—ç­–ç•¥ã€‚ å½“ç„¶ä¹Ÿè¦è€ƒè™‘embeddingçš„æ¨¡å‹</p>
<p><img src="/../img/netease/img_8.png" alt="img_8.png"></p>
<p>å®é™…ä½¿ç”¨ä¸‹æ¥ï¼Œåº”ç”¨äºç½‘é¡µæ–‡æœ¬åˆ†å—å¬å›çš„æ¯”è¾ƒå¥½çš„å‚æ•°ï¼Œ chunk&#x3D;500ï¼Œoverlap&#x3D;100, å‘é‡æ¨¡å‹é‡‡ç”¨BCEã€‚</p>
<h3 id="3-2-2-å‘é‡åŒ–"><a href="#3-2-2-å‘é‡åŒ–" class="headerlink" title="3.2.2 å‘é‡åŒ–"></a>3.2.2 å‘é‡åŒ–</h3><p>åˆ‡å—ä¹‹åç¬¬äºŒæ­¥å°±æ˜¯å¯¹æ–‡æ¡£å’Œqueryéƒ½è¿›è¡Œå‘é‡åŒ–ï¼Œå¹¶è®¡ç®— queryå’Œ æ–‡æ¡£ä¹‹é—´çš„ç›¸ä¼¼åº¦ï¼Œå†è®¾å®šè¿‡æ»¤çš„é˜ˆå€¼ï¼Œå¾—åˆ°æœ€ç»ˆæˆ‘ä»¬éœ€è¦çš„æ–‡æ¡£ç‰‡æ®µã€‚é‚£ä¹ˆï¼Œå‘é‡æ¨¡å‹è¯¥å¦‚ä½•é€‰å–ï¼Ÿ</p>
<p>ä¸€èˆ¬çš„å•†ä¸šå¤§æ¨¡å‹æœåŠ¡éƒ½è‡ªå¸¦embeddingæ¥å£ï¼Œæ¯”å¦‚openaiçš„ v1&#x2F;embedding, è¿™ç§éœ€è¦api_key, æ˜¾ç„¶ä¸æ˜¯æˆ‘ä»¬çš„ç›®æ ‡ã€‚å¼€æºæ¨¡å‹æ•ˆæœå¯¹æ¯”ï¼Œå¯ä»¥å‚è€ƒï¼Œhuggingface çš„embeddingç«æŠ€åœºï¼š<a target="_blank" rel="noopener" href="https://huggingface.co/spaces/mteb/leaderboard">https://huggingface.co/spaces/mteb/leaderboard</a> ,ä½†æ˜¯é‡Œé¢ä¸æ˜¯æ‰€æœ‰æ¨¡å‹éƒ½æœ‰æ‰“åˆ†ï¼Œä¸‹é¢æ˜¯ä¸€äº›ä¸»æµçš„embeddingæ¨¡å‹:</p>
<p><img src="/../img/netease/img_9.png" alt="img_9.png"></p>
<p>å¼€æºæ¨¡å‹æŒ‘é€‰å¯ä»¥ä»å‡ ä¸ªæ–¹é¢å…¥æ‰‹ï¼š</p>
<p>â‘  ç¡¬ä»¶æ€§èƒ½ã€‚ å› ä¸ºå•æ¬¡ç”¨æˆ·è¯·æ±‚ï¼Œæ¶‰åŠå¾ˆå¤šåˆ‡å—æ–‡æ¡£ï¼Œæ‰€ä»¥éœ€è¦è€ƒè™‘æœºå™¨æ€§èƒ½å’Œæ¨¡å‹é€Ÿåº¦ï¼Œå…¶å®å¾ˆå¤šå¸¸è§çš„å¤§æ¨¡å‹åšembeddingæ•ˆæœä¹Ÿå¾ˆå¥½ï¼Œä½†å®ƒä¸æ˜¯ä¸»æµå› ä¸ºæ•ˆç‡å¾ˆä½ï¼Œæˆ‘ä»¬åœ¨mteb è¯„æµ‹æ¦œå•ä¸Šå¯ä»¥çœ‹åˆ° qwen2çš„æ£€ç´¢æ•ˆæœéå¸¸å¥½ï¼Œä½†æ˜¯æ¨¡å‹å¤ªå¤§å¾ˆéš¾åº”ç”¨ã€‚ å°¤å…¶æˆ‘ä»¬çš„ä»»åŠ¡éƒ½æ˜¯å®æ—¶ç®—ï¼Œå¹¶ä¸å­˜å‚¨å‘é‡ï¼Œæ‰€ä»¥éœ€è¦æ¨¡å‹ä¸å¤ªå¤§ã€‚</p>
<p><img src="/../img/netease/img_10.png" alt="img_10.png"></p>
<p>â‘¡ å‘é‡ç»´åº¦ã€‚å‘é‡ç»´åº¦ä¼šå½±å“åˆ° å­˜å‚¨ä»¥åŠæ£€ç´¢è€—æ—¶ï¼Œå¯¹äºå¸¸è§çš„æ£€ç´¢ä»»åŠ¡ï¼Œæ˜¯å¯¹çŸ¥è¯†åº“çš„å†…å®¹é¢„å…ˆç®—å¥½ç›¸åº”çš„å‘é‡ï¼Œå¹¶å­˜å‚¨è¿›å‘é‡æ•°æ®åº“ã€‚ ç”¨æˆ·æ£€ç´¢æ—¶ï¼Œå¯¹æ£€ç´¢è¯å‘é‡åŒ–ï¼Œå†é€šè¿‡è¿‘é‚»æ£€ç´¢ç®—æ³•æ£€ç´¢æœ€ç›¸å…³çš„topç»“æœã€‚å½“æ•°æ®é‡æ˜¾è‘—å¤§æ—¶ï¼Œå‘é‡ç»´åº¦è¶Šå¤§ï¼Œæ£€ç´¢è€—æ—¶è¶Šæ˜æ˜¾ã€‚æˆ‘ä»¬çš„ä»»åŠ¡é‡Œä¸å­˜å‚¨å‘é‡ï¼Œæ‰€ä»¥è¿™å—ä¹Ÿä¸éœ€è¦è€ƒè™‘ã€‚</p>
<p>â‘¢ æœ€å¤§è¾“å…¥é•¿åº¦ã€‚ æŒ‡æ¨¡å‹å¤„ç†è¾“å…¥çš„æœ€å¤§tokené•¿åº¦ï¼Œè¿™ä¸ªå’Œæˆ‘ä»¬å‰é¢æåˆ°çš„åˆ†å—å¤§å°æ¯æ¯ç›¸å…³ï¼Œå› ä¸ºå¦‚æœåˆ†å—å¤§å°è¶…è¿‡æœ€å¤§é•¿åº¦ï¼Œåˆ™è¶…è¿‡çš„éƒ¨åˆ†ä¼šè¢«å‘é‡æ¨¡å‹ä¸¢å¼ƒï¼Œå¯¼è‡´ä¿¡æ¯æŸå¤±ã€‚</p>
<p>â‘£ æ”¯æŒè¯­è¨€ã€‚å¤§éƒ¨åˆ†å¼€æºå‘é‡æ¨¡å‹åªæ”¯æŒå•ä¸€æˆ–è€…æœ‰é™çš„æ–‡æœ¬è¯­è¨€ï¼Œåœ¨éœ€è¦å¤šè¯­è¨€éœ€æ±‚çš„åœºæ™¯å¯èƒ½ä¸åˆé€‚ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸æ”¯æŒå¤šè¯­è¨€ï¼Œä¸ä»£è¡¨å…¶ä»–è¯­è¨€å°±ä¸èƒ½å‘é‡åŒ–ï¼Œè€Œæ˜¯ç¼ºä¹è·¨è¯­è¨€åŒ¹é…çš„èƒ½åŠ›ã€‚ æ¯”å¦‚[ â€˜How is the weather today?â€™, â€˜ä»Šå¤©å¤©æ°”æ€ä¹ˆæ ·?â€™] åœ¨å•ä¸€è¯­è¨€é‡Œç›¸ä¼¼åº¦å¯èƒ½å¾ˆä½ï¼Œè€Œå¯¹äºå¤šè¯­è¨€ï¼Œåˆ™åŒ¹é…åº¦è¾ƒé«˜ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œå¦‚æœåªæ˜¯é’ˆå¯¹ç‰¹å®šè¯­è¨€ï¼Œé€‰æ‹©å•ä¸€è¯­è¨€æ¨¡å‹å³å¯ï¼Œè¯„åˆ†é«˜çš„æ··åˆè¯­è¨€æ¨¡å‹ä¸ä¸€å®šæ¯”å•ä¸€è¯­è¨€æ¨¡å‹æ•ˆæœå¥½ã€‚ ç”±äºç½‘é¡µå†…å®¹ç¹æ‚ï¼Œæˆ‘ä»¬å€¾å‘äºé€‰æ‹©å¤šè¯­è¨€æ¨¡å‹</p>
<p>â‘¤ é¢†åŸŸè¡¨ç°ã€‚é€šç”¨ Embedding æ¨¡å‹åœ¨ç‰¹å®šå‚ç›´é¢†åŸŸï¼ˆå¦‚åŒ»å­¦ã€æ³•å¾‹å’Œé‡‘èç­‰ï¼‰å¯èƒ½ä¸å¦‚ä¸“ç”¨æ¨¡å‹æœ‰æ•ˆã€‚è¿™äº›é¢†åŸŸé€šå¸¸éœ€è¦ä¸“é—¨è®­ç»ƒ Embedding æ¨¡å‹æ¥æ•æ‰ç‰¹å®šçš„ä¸“ä¸šæœ¯è¯­å’Œè¯­å¢ƒã€‚ä¸ºç‰¹å®šä¸šåŠ¡éœ€æ±‚ä¼˜åŒ–çš„ Embedding æ¨¡å‹èƒ½å¤Ÿæ˜¾è‘—æå‡æ£€ç´¢å’Œç”Ÿæˆçš„è´¨é‡ã€‚ ç½‘é¡µå†…å®¹åŒ¹é…é€šå¸¸ä¸éœ€è¦è€ƒè™‘é¢†åŸŸè¡¨ç°ã€‚</p>
<p>åŸºäºä¸Šé¢çš„ç»´åº¦ï¼Œæˆ‘ä»¬é€‰æ‹©äº†ä¸­è‹±åŒè¯­çš„ bce-embedding-base_v1æ¨¡å‹ã€‚</p>
<h3 id="3-2-3-æ’åº"><a href="#3-2-3-æ’åº" class="headerlink" title="3.2.3 æ’åº"></a>3.2.3 æ’åº</h3><p>é¡ºä¾¿å†èŠä¸€ä¸‹ï¼Œå…³äºRAGä¸­çš„å¬å›ï¼Œç›®å‰ä¸»æµçš„åšæ³•æ˜¯ä¸¤ä¸ªé˜¶æ®µã€‚ç¬¬ä¸€é˜¶æ®µqueryå’Œæ–‡æ¡£å‘é‡åŒ–ï¼Œæ£€ç´¢æ¡†æ¶é‡‡ç”¨faiss, æˆ–è€…milvus è¿™ç§å‘é‡æŸ¥è¯¢æ•°æ®åº“ã€‚ ç¬¬ä¸€é˜¶æ®µå­˜åœ¨ä¸¤ä¸ªé—®é¢˜ï¼š</p>
<p>1ã€å½“docæ•°æ®é‡å¤§çš„æ—¶å€™ï¼Œæ£€ç´¢ç®—æ³•éƒ½æ˜¯è¿‘ä¼¼çš„ï¼Œ ä¸æ˜¯æŒ¨ä¸ªéå†è®¡ç®—ï¼Œä¼šæœ‰æŸã€‚é™¤éç”¨æš´åŠ›æŒ¨ä¸ªè®¡ç®—cos, ä½†è¿™ä¸ªä¸ç°å®ã€‚ï¼ˆåœ¨æœ¬ä»»åŠ¡é‡Œæ˜¯å¯ä»¥çš„ï¼Œå› ä¸ºæ–‡æ¡£é‡å¾ˆå°ï¼‰</p>
<p>2ã€embeddingæœ¬æ¥å°±æ˜¯å¯¹äºä¿¡æ¯çš„å‹ç¼©ï¼Œå¯¹åŸå§‹æ–‡æœ¬ä¿¡æ¯æ˜¯æœ‰ä¸¢å¤±çš„ã€‚</p>
<p>é‚£ä¹ˆå¯¹äºè¿™äº›ç¼ºç‚¹ï¼Œæœ‰åŠæ³•ä¼˜åŒ–å—ï¼Ÿ ç­”æ¡ˆæ˜¯æœ‰çš„ï¼Œå³ç¬¬äºŒé˜¶æ®µrerankæ¨¡å‹ç²¾æ’ã€‚ rerankæ¨¡å‹è¾“å…¥queryå’Œdocå¯¹æ–‡æœ¬ï¼Œè€Œä¸æ˜¯emebdding, ä¿¡æ¯æ— æŸã€‚ 2é˜¶æ®µæ£€ç´¢è¯¦æƒ…å¯ä»¥å‚è€ƒQAnythingç»™å‡ºçš„ç¤ºæ„å›¾ï¼Œ å¾ˆæ¸…æ¥šã€‚</p>
<p><img src="/../img/netease/img_11.png" alt="img_11.png"></p>
<p>åœ¨åŠ å…¥äºŒé˜¶æ®µrerankä¹‹åï¼ŒBCEçš„æ•ˆæœï¼Œ top10å‘½ä¸­ç‡ç”±85.91%æå‡åˆ°93.46%ï¼Œéå¸¸æ˜æ˜¾ã€‚åŒæ—¶å¯ä»¥çœ‹åˆ°ï¼Œé‡‡ç”¨hybirdï¼Œ å³bm25å’Œembeddingå¬å›ï¼Œå†ç»è¿‡rerankå¯ä»¥è¾¾åˆ°æœ€å¥½çš„æ•ˆæœ96.36%ã€‚</p>
<p><img src="/../img/netease/img_13.png" alt="img_13.png"><br>ä»¥ä¸‹æ˜¯æœ‰é“ ç»™å‡ºçš„BCEæœ€ä½³å®è·µ</p>
<blockquote>
<p>æœ€ä½³å®è·µï¼ˆBest practiceï¼‰ ï¼šembeddingå¬å›top50-100ç‰‡æ®µï¼Œrerankerå¯¹è¿™50-100ç‰‡æ®µç²¾æ’ï¼Œæœ€åå–top5-10ç‰‡æ®µã€‚</p>
</blockquote>
<p>BAAI(åŒ—äº¬æ™ºæºäººå·¥æ™ºèƒ½ç ”ç©¶é™¢)ä¹Ÿç»™å‡ºäº†BGEçš„æœ€ä½³å®è·µï¼š</p>
<blockquote>
<p>For multilingual, utilize BAAI&#x2F;bge-reranker-v2-m3 and BAAI&#x2F;bge-reranker-v2-gemma<br>For Chinese or English, utilize BAAI&#x2F;bge-reranker-v2-m3 and BAAI&#x2F;bge-reranker-v2-minicpm-layerwise.<br>For efficiency, utilize BAAI&#x2F;bge-reranker-v2-m3 and the low layer of BAAI&#x2F;ge-reranker-v2-minicpm-layerwise.<br>For better performance, recommand BAAI&#x2F;bge-reranker-v2-minicpm-layerwise and BAAI&#x2F;bge-reranker-v2-gemma</p>
</blockquote>
<p>å…¶å®æˆ‘ä»¬å¾ˆå®¹æ˜“è”æƒ³ä¸¤é˜¶æ®µå¬å›ï¼Œ å…¶å®å°±æ˜¯æ—©æœŸçš„ç±» DSSM åŒå¡”å¬å›çš„ä¸åŒæ€è·¯ã€‚</p>
<ul>
<li><p>ç¬¬ä¸€é˜¶æ®µï¼Œå°±æ˜¯å–åŒå¡”çš„æœ€åä¸€å±‚å‘é‡åš è¿‘é‚»æ£€ç´¢</p>
</li>
<li><p>ç¬¬äºŒé˜¶æ®µï¼Œå°±æ˜¯åŒå¡”æ”¾å…¥queryå’Œdocè®¡ç®—çš„æœ€åçš„æ‰“åˆ†</p>
</li>
</ul>
<p>å¦‚æœæƒ³è¦åœ¨è‡ªå·±é¢†åŸŸå†…æœ‰æ›´å¥½çš„æ•ˆæœï¼Œä¹Ÿå¯ä»¥é€‰æ‹©åœ¨é¢†åŸŸæ•°æ®é›†ä¸Šå¾®è°ƒæ¨¡å‹ã€‚å¾®è°ƒæ•°æ®å¦‚ä¸‹æ‰€ç¤ºï¼Œæ­£æ ·æœ¬å’Œè´Ÿæ ·æœ¬ï¼Œå¹¶é€šè¿‡ä¸€äº›hard negative çš„æ–¹å¼åšæ ·æœ¬å¢å¼ºã€‚ ç°åœ¨ä¹Ÿæœ‰ä¸€äº›æ€è·¯æ˜¯ç”¨LLM æ¥å¯¹åŸæ ·æœ¬è¿›è¡Œä¸€äº›æ”¹å†™å¢å¼ºï¼Œæ¯”å¦‚ç»™é—®é¢˜æ¢ä¸ªè¯´æ³•ï¼Œæ¯”å¦‚â€œä»€ä¹ˆæ˜¯æ·±åº¦å­¦ä¹ ï¼Ÿâ€ -&gt; â€œæ€ä¹ˆç†è§£æ·±åº¦å­¦ä¹ ï¼Ÿâ€ï¼Œ è¿™æ ·éƒ½èƒ½æé«˜åŸæ¨¡å‹åœ¨ç‰¹å®šé¢†åŸŸçš„æ•ˆæœã€‚</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;query&quot;: &quot;å¦‚ä½•æé«˜æœºå™¨å­¦ä¹ æ¨¡å‹çš„å‡†ç¡®æ€§ï¼Ÿ&quot;, &quot;pos&quot;: [&quot;é€šè¿‡äº¤å‰éªŒè¯å’Œè°ƒå‚å¯ä»¥æé«˜æ¨¡å‹å‡†ç¡®æ€§ã€‚&quot;], &quot;neg&quot;: [&quot;æœºå™¨å­¦ä¹ æ˜¯äººå·¥æ™ºèƒ½çš„ä¸€ä¸ªåˆ†æ”¯ã€‚&quot;]&#125;</span><br><span class="line">&#123;&quot;query&quot;: &quot;ä»€ä¹ˆæ˜¯æ·±åº¦å­¦ä¹ ï¼Ÿ&quot;, &quot;pos&quot;: [&quot;æ·±åº¦å­¦ä¹ æ˜¯æœºå™¨å­¦ä¹ çš„ä¸€ä¸ªå­é¢†åŸŸï¼Œæ¶‰åŠå¤šå±‚ç¥ç»ç½‘ç»œã€‚&quot;], &quot;neg&quot;: [&quot;æ•°æ®ç§‘å­¦æ˜¯ä¸€é—¨äº¤å‰å­¦ç§‘ã€‚&quot;]&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-3-å¤§æ¨¡å‹ç”ŸæˆæœåŠ¡"><a href="#3-3-å¤§æ¨¡å‹ç”ŸæˆæœåŠ¡" class="headerlink" title="3.3 å¤§æ¨¡å‹ç”ŸæˆæœåŠ¡"></a>3.3 å¤§æ¨¡å‹ç”ŸæˆæœåŠ¡</h2><p>è¿™ä¸€æ­¥ï¼Œä¸»è¦æ˜¯åˆ©ç”¨å¤§æ¨¡å‹çš„åˆ†æå’Œæ€»ç»“èƒ½åŠ›ï¼Œå¯¹æ£€ç´¢åˆ°çš„ç›¸å…³æ–‡æ¡£å’Œç”¨æˆ·queryè¿›è¡Œåˆ†æï¼Œç»™å‡ºç”¨æˆ·æƒ³è¦çš„ç»“æœã€‚è¿™é‡Œçš„æ ¸å¿ƒé—®é¢˜ä¹ŸåŒ…æ‹¬å‡ å—ï¼Œ1ã€å¤§æ¨¡å‹çš„é€‰æ‹©ã€‚ 2ã€promptè°ƒä¼˜ 3ã€æœåŠ¡éƒ¨ç½²ä»¥åŠå‰ç«¯å±•ç¤º 4. inferenceåŠ é€Ÿ</p>
<h3 id="3-3-1-å¤§æ¨¡å‹é€‰æ‹©"><a href="#3-3-1-å¤§æ¨¡å‹é€‰æ‹©" class="headerlink" title="3.3.1 å¤§æ¨¡å‹é€‰æ‹©"></a>3.3.1 å¤§æ¨¡å‹é€‰æ‹©</h3><p>å¸‚é¢ä¸Šçš„å¼€æºå¤§æ¨¡å‹éå¸¸å¤šï¼Œå…¶ä¸­æ¯”è¾ƒæµè¡Œçš„æœ‰metaçš„ llamaç³»åˆ—ï¼Œæœ€æ–°æ˜¯llama3, ä»¥åŠMistral(largeä¸å¼€æº) ï¼Œgoogleçš„Gemma(largeä¸å¼€æº)ï¼Œ å›½å†…çš„ æ™ºæ™®çš„chatglm,æœ€æ–°æ˜¯chatglm4, é˜¿é‡Œçš„qwen,æœ€æ–°æ˜¯qwen2, ä»¥åŠbaichuanç­‰ç­‰éå¸¸å¤šã€‚é‚£ä¹ˆè¿™ä¹ˆå¤šå¼€æºå¤§æ¨¡å‹ï¼Œå¦‚ä½•æŒ‘é€‰é€‚åˆæˆ‘ä»¬çš„å¤§æ¨¡å‹ï¼š</p>
<ul>
<li>æ¨¡å‹å‚æ•°é‡ï¼Œé€‚é…æ˜¾å­˜ã€‚ç¬¬ä¸€ç»´åº¦éœ€è¦è€ƒè™‘çš„å°±æ˜¯æœºå™¨çš„GPUæ˜¾å­˜ï¼Œä»¥ä¸‹è¡¨æ ¼,ä»¥llamaä¸ºåˆ—å­ä¸€äº›å¸¸è§çš„æ¨¡å‹æ˜¾å­˜å ç”¨,æ˜¾å­˜å ç”¨ä¸»è¦åˆ†ä¸º2å—ï¼Œ</li>
<li>ä¸€å—æ˜¯åŠ è½½æ¨¡å‹å‚æ•°å ç”¨çš„æ˜¾å­˜ï¼Œåœ¨fp16ç²¾åº¦ä¸‹ï¼Œ1Bçº¦ç­‰äº2Gæ˜¾å­˜ï¼Œå¯ä»¥æŒ‰è¿™ä¸ªæ¢ç®—ï¼›</li>
<li>å¦ä¸€å—æ˜¯ç”Ÿæˆæ—¶ï¼Œè®¡ç®—çš„ä¸´æ—¶å˜é‡ï¼Œä»¥åŠkvcacheå ç”¨çš„æ˜¾å­˜ã€‚åœ¨fp16ç²¾åº¦ä¸‹ï¼Œ 1Ké•¿åº¦çº¦ç­‰äº1Gï¼Œ ä¸¤è€…åŠ èµ·æ¥æ‰æ˜¯è·‘å¤§æ¨¡å‹æ—¶çš„æœ€å¤§æ˜¾å­˜å ç”¨ã€‚</li>
</ul>
<p><img src="/../img/netease/img_14.png" alt="img_14.png"></p>
<ul>
<li>æ¨¡å‹æ•ˆæœã€‚å¯ä»¥å‚è€ƒä¸€äº›å¤§æ¨¡å‹è¯„æµ‹ç½‘ç«™ï¼Œæ¯”å¦‚ï¼š<a target="_blank" rel="noopener" href="https://www.datalearner.com/ai-models/leaderboard/datalearner-llm-leaderboard%EF%BC%8C">https://www.datalearner.com/ai-models/leaderboard/datalearner-llm-leaderboardï¼Œ</a> é€‰æ’åœ¨å‰é¢çš„åŸºæœ¬æ²¡é”™ã€‚ä¸è¿‡ä¹Ÿéœ€è¦é’ˆå¯¹è‡ªå·±çš„ä»»åŠ¡å¤šè¯•ä¸€äº›å¯¹æ¯”ã€‚</li>
<li>ä»»åŠ¡é€‚é…åº¦ã€‚ä¸åŒçš„æ¨¡å‹è®­ç»ƒçš„é¢†åŸŸæ˜¯ä¸å¤ªä¸€æ ·çš„ï¼Œæ¯”å¦‚è¯´ï¼Œæœ‰çš„åœ¨æ•°å­¦ç›¸å…³æ•°æ®é›†ä¸Šè®­ç»ƒçš„å¤šï¼Œé‚£ä¹ˆå®ƒå¯èƒ½åœ¨æ•°å­¦ï¼Œæ¨ç†æ–¹é¢æ•ˆæœå¾ˆå¥½ï¼Œæœ‰äº›æ¨¡å‹æ˜¯ä¸ºäº†åšcodingçš„ï¼Œ æœ‰äº›æ˜¯åšå›¾æ–‡çš„ï¼Œé€‰æ‹©çš„æ¨¡å‹éœ€è¦é€‚é…ä½ è‡ªå·±çš„ä»»åŠ¡ã€‚å¦‚æœåªæ˜¯æƒ³è¦ç®€å•èŠå¤©ï¼Œé‚£ç»¼åˆæ€§èƒ½å¥½çš„å³å¯ã€‚å¯¹äºè¿™ä¸ªä¸“é—¨çš„é˜…è¯»æ–‡æ¡£æ€»ç»“ç”¨æˆ·é—®é¢˜ï¼Œå¹¶éœ€è¦éµå¾ªä¸€å®šæŒ‡ä»¤çš„ä»»åŠ¡ï¼Œæœ€å¥½é€‰ç”¨æŒ‡ä»¤å¾®è°ƒçš„æ¨¡å‹</li>
</ul>
<p><img src="/../img/netease/img_15.png" alt="img_15.png"></p>
<ul>
<li>ç¤¾åŒºæˆç†Ÿåº¦ã€‚å¼€æºæ¨¡å‹çš„ä¸€ä¸ªé‡è¦åŠ›é‡ï¼Œæˆç†Ÿç¤¾åŒºæ¨¡å‹èƒ½è®©å„ä¸ªæ¡†æ¶è¿…é€Ÿæ”¯æŒï¼Œå¯ç”¨çš„è½®å­å¾ˆå¤šï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬é€‰ç”¨çš„ä¸€ä¸ªé‡è¦å‚è€ƒã€‚</li>
</ul>
<p>åŸºäºä»¥ä¸Šé€‰æ‹©æ€è·¯ï¼Œæˆ‘ä»¬é€‰æ‹©äº†LLAMA3-8B-instruct ä½œä¸ºå¤§æ¨¡å‹æ¥åº”ç”¨ï¼ŒLLAMA3ä¸»è¦æ˜¯åœ¨è‹±æ–‡è¯­æ–™ä¸Šè®­ç»ƒçš„ï¼Œè¦æƒ³åœ¨ä¸­æ–‡ä¸Šæœ‰æ¯”è¾ƒå¥½çš„æ•ˆæœï¼Œå¯ä»¥ç»§ç»­é¢„è®­ç»ƒï¼Œç½‘ä¸Šä¹Ÿå·²ç»æœ‰å¾ˆå¤šé¢„è®­ç»ƒå¥½çš„ä¸­æ–‡LLAMA3, æˆ‘ä»¬é€‰å–çš„æ˜¯hfl&#x2F;llama-3-chinese-8b-instruct-v3</p>
<h3 id="3-3-2-promptè°ƒä¼˜"><a href="#3-3-2-promptè°ƒä¼˜" class="headerlink" title="3.3.2 promptè°ƒä¼˜"></a>3.3.2 promptè°ƒä¼˜</h3><p>é€‰å®šå¤§æ¨¡å‹ä¹‹åï¼Œå°±æ˜¯å¦‚ä½•ä½¿ç”¨çš„é—®é¢˜äº†ï¼Œå¤§æ¨¡å‹çš„è§’è‰²ï¼ŒåŒ…å«[â€˜systemâ€™, â€˜userâ€™, â€˜assistantâ€™]</p>
<blockquote>
<p>system ä¸€èˆ¬ä»£è¡¨æ•´ä¸ªå¤§æ¨¡å‹æœåŠ¡ã€‚æŒ‡å¯¼æ¨¡å‹å¦‚ä½•è¾“å‡ºï¼Œpromptä¸€èˆ¬æ”¾åœ¨è¿™é‡Œ<br>user æŒ‡ä»£çš„æ˜¯ç”¨æˆ·çš„è¾“å…¥ï¼ŒåŒ…æ‹¬æ–‡æœ¬ï¼Œè¯­éŸ³ï¼Œè§†é¢‘ç­‰ç­‰çš„è¾“å…¥æ•°æ®<br>assistant ä»£è¡¨å¤§æ¨¡å‹çš„ç›¸åº”è¾“å‡º</p>
</blockquote>
<p>åœ¨æˆ‘ä»¬è¿™ä¸ªä»»åŠ¡ä¸­ï¼Œæˆ‘ä»¬å¸Œæœ›å¤§æ¨¡å‹æ ¹æ® æˆ‘ä»¬æä¾›çš„æ•°æ®ï¼Œæ¥å¯¹ç½‘é¡µå†…å®¹è¿›è¡Œåˆ†æï¼Œæ‰€ä»¥æˆ‘ä»¬çš„prompt</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">æ‚¨æ˜¯ä¸€ä½ä¸“ä¸šçš„ç ”ç©¶å‘˜å’Œä½œå®¶ï¼Œè´Ÿè´£å›ç­”ä»»ä½•é—®é¢˜ã€‚</span><br><span class="line">åŸºäºæä¾›çš„æœç´¢ç»“æœï¼Œä¸ºç»™å®šçš„é—®é¢˜ç”Ÿæˆä¸€ä¸ªå…¨é¢è€Œä¸”ä¿¡æ¯ä¸°å¯Œã€ä½†ç®€æ´çš„ç­”æ¡ˆï¼Œé•¿åº¦ä¸è¶…è¿‡ 500 å­—ã€‚æ‚¨å¿…é¡»åªä½¿ç”¨æ¥è‡ªæä¾›çš„æœç´¢ç»“æœçš„ä¿¡æ¯ã€‚ä½¿ç”¨å…¬æ­£å’Œæ–°é—»æ€§çš„è¯­æ°”ã€‚å°†æœç´¢ç»“æœåˆå¹¶æˆä¸€ä¸ªè¿è´¯çš„ç­”æ¡ˆã€‚ä¸è¦é‡å¤æ–‡æœ¬ã€‚</span><br><span class="line">å¦‚æœä¸Šä¸‹æ–‡ä¸­æ²¡æœ‰ä¸å½“å‰é—®é¢˜ç›¸å…³çš„ä¿¡æ¯ï¼Œåªéœ€è¯´â€œå—¯ï¼Œæˆ‘ä¸ç¡®å®šã€‚â€ä¸è¦è¯•å›¾ç¼–é€ ç­”æ¡ˆã€‚</span><br><span class="line">ä½äºä»¥ä¸‹context HTML å—ä¹‹é—´çš„ä»»ä½•å†…å®¹éƒ½æ˜¯ä»çŸ¥è¯†åº“ä¸­æ£€ç´¢åˆ°çš„ï¼Œè€Œä¸æ˜¯ä¸ç”¨æˆ·çš„å¯¹è¯çš„ä¸€éƒ¨åˆ†ã€‚</span><br><span class="line">&lt;context&gt;</span><br><span class="line">&#123;context&#125;</span><br><span class="line">&lt;context/&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>è®¾å®šè§’è‰²ï¼š å¼€å§‹ç»™æ¨¡å‹è®¾å®šå¥½è§’è‰²ï¼Œ ç ”ç©¶å‘˜å’Œä½œå®¶</li>
<li>æŒ‡ç¤ºï¼š æ— äºŒä¹‰æ€§çš„ä»»åŠ¡æè¿°ï¼ŒåŸºäºæœç´¢ç»“æœæ€»ç»“ä¸€ä¸ªç”¨æˆ·é—®é¢˜ç­”æ¡ˆï¼Œéå£è¯­åŒ–ï¼Œ500å­—ï¼Œä¸é‡å¤ï¼Œæ²¡ç»“æœæ—¶ä¹Ÿä¸èƒ½ä¹±è¯´</li>
<li>ä¸Šä¸‹æ–‡ï¼šä½¿ç”¨æ˜ç¡®çš„xmlæ ¼å¼å®šä¹‰å¥½è¾“å…¥çš„æœç´¢ç»“æœ</li>
</ul>
<p>å¯ä»¥å¤šç»™LLMä¸€äº›ä¾‹å­çœ‹è¿”å›ç»“æœï¼Œæ ¹æ®è¿”å›ç»“æœå¯¹promptåšä¸€å®šè°ƒæ•´ã€‚</p>
<h3 id="3-3-3-æœåŠ¡éƒ¨ç½²ä»¥åŠå‰ç«¯å±•ç¤º"><a href="#3-3-3-æœåŠ¡éƒ¨ç½²ä»¥åŠå‰ç«¯å±•ç¤º" class="headerlink" title="3.3.3 æœåŠ¡éƒ¨ç½²ä»¥åŠå‰ç«¯å±•ç¤º"></a>3.3.3 æœåŠ¡éƒ¨ç½²ä»¥åŠå‰ç«¯å±•ç¤º</h3><p>é€‰å®šæ¨¡å‹ä¹‹åè¦éƒ¨ç½²ç›¸åº”çš„åç«¯æ¨¡å‹æœåŠ¡å’Œå‰ç«¯ç”¨æˆ·äº¤äº’æœåŠ¡ã€‚</p>
<p>åç«¯ï¼š</p>
<ul>
<li><p>æä¾›æ¨¡å‹å¯¹è¯æœåŠ¡ç»™å‰ç«¯è¿›è¡Œäº¤äº’ï¼Œè¿™é‡Œæœ€ç»å…¸å°±æ˜¯openaiçš„ apiæ¥å£sdk, ä¸ºäº†æ•´ä¸ªç³»ç»Ÿçš„å…¼å®¹æ€§ï¼Œæˆ‘ä»¬å¯ä»¥å°†æˆ‘ä»¬çš„æœåŠ¡ç«¯éƒ¨ç½²æˆOPENAI APIæ¥å£çš„å½¢å¼</p>
</li>
<li><p>æˆ‘ä»¬é€‰å–çš„æ˜¯pythonç›®å‰æ¯”è¾ƒæµè¡Œçš„FastAPIï¼Œ FastAPI æ˜¯ä¸€ä¸ªç”¨äºæ„å»º API çš„ç°ä»£ã€å¿«é€Ÿ(é«˜æ€§èƒ½)çš„ web æ¡†æ¶</p>
</li>
<li><p>å®ç°æ¥å£ä¸»è¦åŒ…æ‹¬ä¸¤ä¸ªï¼Œ1ä¸ªæ˜¯LLMå¯¹è¯æœåŠ¡ï¼ˆv1&#x2F;chat&#x2F;completionsï¼‰ï¼Œ 1ä¸ªæ˜¯queryçš„embeddingæœåŠ¡(v1&#x2F;embeddings)</p>
</li>
</ul>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">@app.post(&quot;/v1/chat/completions&quot;, response_model=ChatCompletionResponse)</span><br><span class="line">async def create_chat_completion(request: ChatCompletionRequest):</span><br><span class="line">global model, tokenizer</span><br><span class="line"></span><br><span class="line">    if len(request.messages) &lt; 1 or request.messages[-1].role == &quot;assistant&quot;:</span><br><span class="line">        raise HTTPException(status_code=400, detail=&quot;Invalid request&quot;)</span><br><span class="line"></span><br><span class="line">    gen_params = dict(</span><br><span class="line">        messages=request.messages,</span><br><span class="line">        temperature=request.temperature,</span><br><span class="line">        top_p=request.top_p,</span><br><span class="line">        max_tokens=request.max_tokens or 1024,</span><br><span class="line">        echo=False,</span><br><span class="line">        stream=request.stream,</span><br><span class="line">        repetition_penalty=request.repetition_penalty,</span><br><span class="line">        tools=request.tools,</span><br><span class="line">    )</span><br><span class="line">    logger.debug(f&quot;==== request ====\n&#123;gen_params&#125;&quot;)</span><br><span class="line">    for each_message in request.messages:</span><br><span class="line">        info = str(each_message.role) +&quot;\:&quot; +str(len(each_message.content))</span><br><span class="line">        logger.debug(f&quot;==== ===== ===&quot;)</span><br><span class="line">        logger.debug(f&quot;==== message len ====\n&#123;info&#125;&quot;)</span><br><span class="line">        logger.debug(f&quot;==== ===== ===&quot;)</span><br><span class="line">        </span><br><span class="line">    # Here is the handling of stream = False</span><br><span class="line">    response = generate_llama3(model, tokenizer, gen_params)</span><br><span class="line"></span><br><span class="line">    # Remove the first newline character</span><br><span class="line">    if response[&quot;text&quot;].startswith(&quot;\n&quot;):</span><br><span class="line">        response[&quot;text&quot;] = response[&quot;text&quot;][1:]</span><br><span class="line">    response[&quot;text&quot;] = response[&quot;text&quot;].strip()</span><br><span class="line"></span><br><span class="line">    usage = UsageInfo()</span><br><span class="line">    message = ChatMessage(</span><br><span class="line">        role=&quot;assistant&quot;,</span><br><span class="line">        content=response[&quot;text&quot;],</span><br><span class="line">        function_call= None,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    logger.debug(f&quot;==== message ====\n&#123;message&#125;&quot;)</span><br><span class="line"></span><br><span class="line">    choice_data = ChatCompletionResponseChoice(</span><br><span class="line">        index=0,</span><br><span class="line">        message=message,</span><br><span class="line">        finish_reason=&quot;stop&quot;</span><br><span class="line">    )</span><br><span class="line">    task_usage = UsageInfo.model_validate(response[&quot;usage&quot;])</span><br><span class="line">    for usage_key, usage_value in task_usage.model_dump().items():</span><br><span class="line">        setattr(usage, usage_key, getattr(usage, usage_key) + usage_value)</span><br><span class="line"></span><br><span class="line">    return ChatCompletionResponse(</span><br><span class="line">        model=request.model,</span><br><span class="line">        id=&quot;&quot;,  # for open_source model, id is empty</span><br><span class="line">        choices=[choice_data],</span><br><span class="line">        object=&quot;chat.completion&quot;,</span><br><span class="line">        usage=usage</span><br><span class="line">    )</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">@app.post(&quot;/v1/embeddings&quot;, response_model=EmbeddingResponse)</span><br><span class="line">async def get_embeddings(request: EmbeddingRequest):</span><br><span class="line"></span><br><span class="line">    embeddings = [embedding_model.encode(text) for text in request.input]</span><br><span class="line">    embeddings = [embedding.tolist() for embedding in embeddings]</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    # logger.info(f&quot;encode result: \n&#123;request.input&#125;&quot;)</span><br><span class="line"></span><br><span class="line">    # è®¡ç®—token æ•°</span><br><span class="line">    def num_tokens_from_string(string: str) -&gt; int:</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        Returns the number of tokens in a text string.</span><br><span class="line">        use cl100k_base tokenizer</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        encoding = tiktoken.get_encoding(&#x27;cl100k_base&#x27;)</span><br><span class="line">        num_tokens = len(encoding.encode(string))</span><br><span class="line">        return num_tokens</span><br><span class="line"></span><br><span class="line">    # embedding æ¥å£è¿”å›æ•°æ®æ ¼å¼</span><br><span class="line">    response = &#123;</span><br><span class="line">        &quot;data&quot;: [</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;object&quot;: &quot;embedding&quot;,</span><br><span class="line">                &quot;embedding&quot;: embedding,</span><br><span class="line">                &quot;index&quot;: index</span><br><span class="line">            &#125;</span><br><span class="line">            for index, embedding in enumerate(embeddings)</span><br><span class="line">        ],</span><br><span class="line">        &quot;model&quot;: request.model,</span><br><span class="line">        &quot;object&quot;: &quot;list&quot;,</span><br><span class="line">        &quot;usage&quot;: CompletionUsage(</span><br><span class="line">            prompt_tokens=sum(len(text.split()) for text in request.input),</span><br><span class="line">            completion_tokens=0,</span><br><span class="line">            total_tokens=sum(num_tokens_from_string(text) for text in request.input),</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">    return response</span><br></pre></td></tr></table></figure>


<p>å¦‚æœä½ çš„æœºå™¨æ€§èƒ½æœ‰é™ï¼Œå¯ä»¥é€‰ç”¨ollamaè¿™ä¸ªæ¡†æ¶æ¥å¾ˆå¿«é€Ÿçš„éƒ¨ç½²å¤§æ¨¡å‹apiæœåŠ¡ï¼Œ å®˜ç½‘ï¼š<a target="_blank" rel="noopener" href="https://ollama.com/%EF%BC%8C">https://ollama.com/ï¼Œ</a> è¿™ä¸ªå¹³å°æä¾›äº†å¾ˆå¤šé‡åŒ–çš„æ¨¡å‹å’Œ ä¸€è¡Œå‘½ä»¤éƒ¨ç½²APIæœåŠ¡</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># å®‰è£…</span><br><span class="line">curl -fsSL https://ollama.com/install.sh | sh</span><br><span class="line"># æ‹‰å–æ¨¡å‹å¹¶éƒ¨ç½²ï¼Œ è¿™é‡Œæ‹‰å–qwen2-7b instruct Q4é‡åŒ–ï¼Œæ˜¾å­˜åªéœ€è¦4.4G</span><br><span class="line">ollama run qwen2:7b-instruct  # å¯åŠ¨æœåŠ¡å¹¶åœ¨11434ç«¯å£å¼€å¯apiæ¥å£</span><br></pre></td></tr></table></figure>

<p>api å®¢æˆ·ç«¯è°ƒç”¨:</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">from openai import OpenAI</span><br><span class="line"></span><br><span class="line">client = OpenAI(</span><br><span class="line">base_url = &#x27;http://localhost:11434/v1&#x27;,</span><br><span class="line">api_key=&#x27;ollama&#x27;, # required, but unused</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">response = client.chat.completions.create(</span><br><span class="line">model=&quot;qwen2:7b-instruct&quot;,</span><br><span class="line">messages=[</span><br><span class="line">&#123;&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;ä½ å¥½&quot;&#125;</span><br><span class="line">]</span><br><span class="line">)</span><br><span class="line">print(response.choices[0].message.content)</span><br><span class="line"># è¾“å‡ºï¼š ä½ å¥½ï¼æœ‰ä»€ä¹ˆé—®é¢˜æˆ‘å¯ä»¥å¸®åŠ©ä½ è§£ç­”å—ï¼Ÿ</span><br></pre></td></tr></table></figure>



<p>å‰ç«¯ï¼š</p>
<p>å‰ç«¯é‡‡ç”¨streamlitå‰ç«¯æ¡†æ¶ï¼Œä¹Ÿæ˜¯ä¸€æ¬¾æ˜“ä¸Šæ‰‹çš„å¤§æ¨¡å‹æœåŠ¡å‰ç«¯æ­å»ºæ¡†æ¶ã€‚ ä»¥ä¸‹æ˜¯ä¸ªç®€æ˜“çš„è°ƒç”¨å¤§æ¨¡å‹èŠå¤©çš„demoæœåŠ¡ã€‚éå¸¸ç®€å•ï¼Œä¹Ÿå°±å‡ è¡Œä»£ç ã€‚</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pip installl streamlit # 1.å®‰è£…åŒ…</span><br><span class="line">streamlit run demo.py # 2. è¿è¡Œå‰ç«¯</span><br><span class="line">http://localhost:8501/ # 3. æ‰“å¼€æµè§ˆå™¨</span><br></pre></td></tr></table></figure>

<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">#  demo.py</span><br><span class="line">from openai import OpenAI</span><br><span class="line">import streamlit as st</span><br><span class="line"></span><br><span class="line">st.title(&quot;LLM èŠå¤©&quot;)</span><br><span class="line"></span><br><span class="line">client = OpenAI(api_key=&#x27;xxx&#x27;, base_url=&quot;http://localhost:11434/v1&quot;)</span><br><span class="line"></span><br><span class="line">if &quot;openai_model&quot; not in st.session_state:</span><br><span class="line">st.session_state[&quot;openai_model&quot;] = &quot;ollama&quot;</span><br><span class="line"></span><br><span class="line">if &quot;messages&quot; not in st.session_state:</span><br><span class="line">st.session_state.messages = []</span><br><span class="line"></span><br><span class="line">for message in st.session_state.messages:</span><br><span class="line">with st.chat_message(message[&quot;role&quot;]):</span><br><span class="line">st.markdown(message[&quot;content&quot;])</span><br><span class="line"></span><br><span class="line">if prompt := st.chat_input(&quot;ä½ å¥½?&quot;):</span><br><span class="line">st.session_state.messages.append(&#123;&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: prompt&#125;)</span><br><span class="line">with st.chat_message(&quot;user&quot;):</span><br><span class="line">st.markdown(prompt)</span><br><span class="line"></span><br><span class="line">    with st.chat_message(&quot;assistant&quot;):</span><br><span class="line">        stream = client.chat.completions.create(</span><br><span class="line">            model=st.session_state[&quot;openai_model&quot;],</span><br><span class="line">            messages=[</span><br><span class="line">                &#123;&quot;role&quot;: m[&quot;role&quot;], &quot;content&quot;: m[&quot;content&quot;]&#125;</span><br><span class="line">                for m in st.session_state.messages</span><br><span class="line">            ],</span><br><span class="line">            stream=True,</span><br><span class="line">        )</span><br><span class="line">        response = st.write_stream(stream)</span><br><span class="line">    st.session_state.messages.append(&#123;&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: response&#125;)</span><br></pre></td></tr></table></figure>

<p>demoæ•ˆæœ:</p>
<p>å¦å¤–è¿˜æœ‰ä¸€ä¸ªç‚¹å°±æ˜¯LLMè°ƒç”¨é‡è¦çš„å‚æ•°å¦‚ä½•å»é€‰æ‹©ï¼ˆtop_p, temprature, presence_penaltyï¼‰ï¼Œæˆ‘è¿™è¾¹æ•´ç†äº†å‡ ä¸ªæ ¸å¿ƒå‚æ•°çš„è°ƒæ•´æ€è·¯ã€‚ å¯¹åº”æˆ‘ä»¬çš„è¿™ä¸ªåˆ†æä»»åŠ¡ï¼Œæ˜¾ç„¶æ˜¯ä»¥æ–°é—»èµ„æ–™ä¸ºæ ¸å¿ƒï¼Œå¯»æ±‚ç”Ÿæˆçš„ç¡®å®šæ€§ã€‚</p>
<p><img src="/../img/netease/img_16.png" alt="img_16.png"></p>
<h3 id="3-3-4-inferenceåŠ é€Ÿ"><a href="#3-3-4-inferenceåŠ é€Ÿ" class="headerlink" title="3.3.4 inferenceåŠ é€Ÿ"></a>3.3.4 inferenceåŠ é€Ÿ</h3><p>å¤§æ¨¡å‹è™½ç„¶æ•ˆæœä¼˜è¶Šï¼Œä½†æ˜¯ä¹Ÿå› ä¸ºå®ƒâ€å¤§â€œï¼Œå¯¼è‡´æœåŠ¡æ€§èƒ½å¾ˆä½ï¼Œåœ¨æˆ‘ä»¬éƒ¨ç½²æœåŠ¡æ—¶ï¼Œéœ€è¦é‡‡å–ä¸€å®šçš„ç­–ç•¥å¯¹æ¨¡å‹é¢„æµ‹è¿›è¡ŒåŠ é€Ÿæ‰èƒ½è·å¾—æ›´å¥½çš„ä½“éªŒã€‚</p>
<p>ç»è¿‡è°ƒç ”é€‰æ‹©äº†VLLMè¿™ä¸ªå¤§æ¨¡å‹æ¨ç†åŠ é€Ÿæ¡†æ¶ã€‚ å®ƒæœ‰å‡ ä¸ªä¼˜ç‚¹ï¼š</p>
<blockquote>
<p>1.ç¤¾åŒºæ´»è·ƒï¼Œæ¨¡å‹æ”¯æŒå¾ˆå¿«<br>2.åŠ é€Ÿæ•ˆæœæ˜æ˜¾ã€‚åŸºäºè™šæ‹Ÿå†…å­˜å’Œåˆ†é¡µçš„æ€æƒ³ï¼Œ é‡‡ç”¨page attention ï¼Œå…è®¸åœ¨éè¿ç»­çš„å†…å­˜ç©ºé—´å†…å­˜å‚¨tokenï¼Œå†…å­˜çš„åˆ©ç”¨ç‡æ¥è¿‘äºæœ€ä¼˜<br>3.ä½¿ç”¨ç®€å•ï¼Œä¸¤è¡Œå‘½ä»¤å³å¯éƒ¨ç½²ã€‚ ç¤ºä¾‹å¦‚ä¸‹</p>
</blockquote>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># vllm llama3 openai</span><br><span class="line"># ä¸‹è½½vllm</span><br><span class="line">pip install vllm</span><br><span class="line"># éƒ¨ç½² ä¸€ä¸ªå…¼å®¹openai apiæ¥å£çš„æ¨¡å‹æœåŠ¡ï¼Œç«¯å£8000</span><br><span class="line">python -m vllm.entrypoints.openai.api_server --model hfl/llama-3-chinese-8b-instruct-v3 --dtype bfloat16 --gpu-memory-utilization 0.6 --chat-template llama3-instruct-template.jinja --enforce-eager --uvicorn-log-level warning --port 8000  --disable-log-stats --uvicorn-log-level warning</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ä¸ºäº†æµ‹è¯•å®é™…ç¯å¢ƒä¸‹çš„æ•ˆæœï¼Œæˆ‘ä»¬è¿è¡Œäº†vllmçš„å¯¹æ¯”æµ‹è¯•è„šæœ¬</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/vllm-project/vllm.git</span><br><span class="line">cd vllm/benchmarks</span><br><span class="line"># æµ‹è¯•vllm</span><br><span class="line">python benchmark_throughput.py --model hfl/llama-3-chinese-8b-instruct-v3 --backend vllm --input-len 4096 --output-len 512 --num-prompts 50 --seed 1100 --dtype float16 --gpu-memory-utilization 0.6</span><br><span class="line"># æµ‹è¯•HF</span><br><span class="line">python benchmark_throughput.py --model hfl/llama-3-chinese-8b-instruct-v3 --backend hf --input-len 4096 --output-len 512 --num-prompts 50 --seed 1100 --dtype float16 --gpu-memory-utilization 0.6 --hf-max-batch-size 10</span><br></pre></td></tr></table></figure>


<p>æ•ˆæœå¦‚ä¸‹æ‰€ç¤ºï¼Œå¯ä»¥çœ‹åˆ°å•æ¡inference æ€§èƒ½ä¸Šï¼ŒVLLMå¤§çº¦æ˜¯HFçš„ä¸¤å€ï¼Œ ä½†æ˜¯å½“å¹¶å‘æ—¶ï¼ŒVLLMæ•ˆæœæå‡æ˜æ˜¾ï¼Œååé‡æå‡10å€ã€‚</p>
<p><img src="/../img/netease/img_17.png" alt="img_17.png"></p>
<p>å½“ç„¶ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®æˆ‘ä»¬çš„æ˜¾å¡ç¯å¢ƒé‡‡å–å…¶ä»–çš„åŠ é€Ÿæ–¹æ³•ï¼Œå¦‚</p>
<ul>
<li>è¾“å…¥è¾“å‡ºä¼˜åŒ–ã€‚ å¦‚prompt è£å‰ªï¼Œ è§„æ•´ï¼› é™åˆ¶è¾“å‡ºåºåˆ—é•¿åº¦ç­‰</li>
<li>æ¨¡å‹ä¼˜åŒ–ã€‚ æ¨¡å‹å‹ç¼©ï¼Œ ä½¿ç”¨é‡åŒ–æ¨¡å‹ï¼Œä½¿ç”¨æ›´å°å‚æ•°æ¨¡å‹ç­‰ç­‰</li>
</ul>
<p>ä¸‹é¢æ¥çœ‹çœ‹æ•´ä½“æ•ˆæœçš„æ¼”ç¤ºï¼Œ é€Ÿåº¦è¿˜æ˜¯éå¸¸å¿«çš„ï¼š</p>
<h1 id="4-æ€»ç»“"><a href="#4-æ€»ç»“" class="headerlink" title="4. æ€»ç»“"></a>4. æ€»ç»“</h1><p>RAGçš„agentå¼€å‘ï¼Œå…¥é—¨è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œç°åœ¨å¸‚é¢ä¸Šå¯ç”¨çš„æ¡†æ¶ä¹Ÿéå¸¸å¤šï¼Œåªéœ€èŠ±è´¹ä¸€äº›æ—¶é—´å°±èƒ½æ­å‡ºä¸€ä¸ªå¯ç”¨çš„demo. ä½†æ˜¯æƒ³è¦åšçš„å¥½ï¼Œç¨³å®šæœåŠ¡ï¼Œè¿˜æ˜¯éœ€è¦è´¹å¾ˆå¤šçš„åŠŸå¤«å»ç ”ç©¶çš„ï¼Œå¸Œæœ›æˆ‘çš„ç»éªŒèƒ½ç»™å¤§å®¶å¸¦æ¥ä¸€äº›æ”¶è·ï¼Œå°‘èµ°ä¸€äº›å¼¯è·¯ã€‚</p>
<p>ç›®å‰è¿™ä¸ªç³»ç»Ÿè¿˜ä¸æ˜¯å¾ˆå®Œå–„ï¼Œ åŒ…æ‹¬ç›¸å…³æ€§åˆ¤æ–­ï¼Œæœç´¢æ„å›¾åˆ¤æ–­ç­‰éƒ½æœ‰å¾ˆå¤§çš„ä¼˜åŒ–ç©ºé—´ã€‚åšè¿™ä¸ªä¸œè¥¿çš„åˆè¡·æ˜¯å¸Œæœ›èƒ½åœ¨éŸ³ä¹çƒ­ç‚¹çš„åœºæ™¯ä¸­è¿›è¡Œåº”ç”¨ï¼Œç›®å‰ä¹Ÿå·²ç»åœ¨å®è·µçš„è¿‡ç¨‹ä¸­äº†ï¼Œå»è¾…åŠ©éŸ³ä¹çƒ­ç‚¹çš„æŒ–æ˜å’Œè¿è¥ã€‚åç»­çš„è¯è¿˜å¸Œæœ›æ·»åŠ çš„åŠŸèƒ½åŒ…æ‹¬ï¼š</p>
<ul>
<li>éŸ³ä¹çƒ­ç‚¹çš„è¯†åˆ«ä¸äº‹ä»¶æ€»ç»“ã€‚</li>
<li>ç»“åˆäº‘éŸ³ä¹ç«™å†…çŸ¥è¯†åšèåˆï¼Œåˆ†æã€‚æ¯”å¦‚è¯†åˆ«äº‹ä»¶æ­Œæ‰‹ï¼Œæ­Œæ›²ï¼ŒåŸå› ï¼Œäº§å‡ºæ–‡æ¡ˆç­‰ç­‰ã€‚</li>
</ul>
<p>å‚è€ƒæ–‡çŒ®:</p>
<p>[1]. <a target="_blank" rel="noopener" href="https://techcommunity.microsoft.com/blog/azure-ai-services-blog/azure-ai-search-outperforming-vector-search-with-hybrid-retrieval-and-reranking/3929167">Azure AI Search: Outperforming vector search with hybrid retrieval and ranking capabilities</a></p>
<p>[2]. <a target="_blank" rel="noopener" href="https://blog.laoda.de/archives/docker-compose-install-searxng">ã€å¥½ç©å„¿çš„Dockeré¡¹ç›®ã€‘SearXNG</a></p>
<p>[3]. <a target="_blank" rel="noopener" href="https://www.53ai.com/news/qianyanjishu/2024061372409.html">RAG é«˜æ•ˆåº”ç”¨æŒ‡å—ï¼šEmbedding æ¨¡å‹çš„é€‰æ‹©å’Œå¾®è°ƒ</a></p>
<p>[4]. <a target="_blank" rel="noopener" href="https://techdiylife.github.io/blog/topic.html?category2=t07&blogid=0049">ReRank ä¸ Embedding æ¨¡å‹çš„åŒºåˆ«ï¼Ÿ å¦‚ä½•é€‰æ‹© ReRank æ¨¡å‹ï¼Ÿ</a></p>
<p>[5]. <a target="_blank" rel="noopener" href="https://blog.csdn.net/lkg5211314/article/details/136142533">ã€æ—¶ä»£å‰æ²¿ã€‘ï¼šå•æµ‹åœºæ™¯ä¸‹tempatureã€top_pã€frequency_penaltyã€presence_penaltyå‚æ•°è°ƒæ•´ç»éªŒåˆ†äº«</a></p>

    
    
  </div>

  

  

</article>
  
  <article class="post">
  <header class="post-header">
    <h1 class="post-title">
      
      <a class="post-link" href="/2025/02/16/%E7%BD%91%E6%98%93%E6%B1%87%E6%8A%A5-AI%E8%BE%85%E5%8A%A9%E7%BC%96%E7%A8%8B/">ç½‘æ˜“æ±‡æŠ¥-AIè¾…åŠ©ç¼–ç¨‹</a>
      
    </h1>

    <div class="post-meta">
      <span class="post-time">
        2025-02-16
      </span>
      
      
      
    </div>
  </header>

  

  <div class="post-content">
    
    
    

    
    <h1 id="å¼•è¨€ï¼šAi-For-Codingçš„ä»·å€¼ä¸æŒ‘æˆ˜"><a href="#å¼•è¨€ï¼šAi-For-Codingçš„ä»·å€¼ä¸æŒ‘æˆ˜" class="headerlink" title="å¼•è¨€ï¼šAi For Codingçš„ä»·å€¼ä¸æŒ‘æˆ˜"></a>å¼•è¨€ï¼šAi For Codingçš„ä»·å€¼ä¸æŒ‘æˆ˜</h1><p>éšç€Copilotã€Cursorç­‰å·¥å…·çš„æ™®åŠï¼ŒAIå·²æˆä¸ºç¨‹åºå‘˜çš„é‡è¦åŠ©æ‰‹ã€‚ç„¶è€Œï¼Œå…¶è¾“å‡ºè´¨é‡é«˜åº¦ä¾èµ–ç”¨æˆ·çš„æç¤ºè¯ï¼ˆPromptsï¼‰ã€‚ä½è´¨é‡çš„æç¤ºè¯å¯èƒ½å¯¼è‡´æ¨¡ç³Šã€å†—ä½™ç”šè‡³é”™è¯¯çš„ä»£ç ï¼Œè€Œé«˜è´¨é‡çš„æç¤ºè¯èƒ½æ˜¾è‘—æå‡ç¼–ç ã€è°ƒè¯•ã€æµ‹è¯•å’Œé—®é¢˜æ’æŸ¥çš„æ•ˆç‡ã€‚æœ¬æ¬¡åˆ†äº«èšç„¦äºå¦‚ä½•è®¾è®¡ç²¾å‡†ã€é«˜æ•ˆçš„æç¤ºè¯ã€‚</p>
<h1 id="æ ¸å¿ƒåŸåˆ™ï¼šé«˜è´¨é‡promptçš„å››å¤§è¦ç´ "><a href="#æ ¸å¿ƒåŸåˆ™ï¼šé«˜è´¨é‡promptçš„å››å¤§è¦ç´ " class="headerlink" title="æ ¸å¿ƒåŸåˆ™ï¼šé«˜è´¨é‡promptçš„å››å¤§è¦ç´ "></a>æ ¸å¿ƒåŸåˆ™ï¼šé«˜è´¨é‡promptçš„å››å¤§è¦ç´ </h1><ul>
<li><strong>Role</strong>(è§’è‰²)ï¼šä¸¤æ–¹é¢å®šä¹‰ï¼Œé¦–å…ˆæ˜¯å®šä¹‰AIçš„è§’è‰²ï¼Œä¾‹å¦‚â€œä½ æ˜¯ä¸€åæå…¶ä¼˜ç§€å…·æœ‰20å¹´ç»éªŒçš„äº§å“ç»ç†å’Œç²¾é€šæ‰€æœ‰ç¼–ç¨‹è¯­è¨€çš„å·¥ç¨‹å¸ˆâ€ã€‚è¿˜æœ‰ç”¨æˆ·çš„è§’è‰²ï¼Œä¾‹å¦‚â€œä¸æ‡‚ä»£ç çš„åˆä¸­ç”Ÿâ€ï¼Œè¿™æ ·ä¼šä½¿å¾—aiæ›´å€¾å‘äºä½¿ç”¨é€šä¿—ä¸”å…·ä½“çš„è¯è¯­æ¥è¡¨è¾¾å®ƒæ‰€å®Œæˆçš„éœ€æ±‚ã€‚</li>
<li><strong>Task</strong>(ä»»åŠ¡)ï¼šå°†ä¸šåŠ¡éœ€æ±‚â€œstep by stepâ€æè¿°ç»™aiï¼Œä½¿å¾—deepseekçš„æ€ç»´é“¾æ›´å¥½çš„ç†è§£ä½ çš„éœ€æ±‚ã€‚</li>
<li><strong>Goal</strong>(ç›®æ ‡)ï¼šæœŸæœ›è¾¾æˆä»€ä¹ˆç›®æ ‡æ•ˆæœï¼Œå¯ä»¥æ˜¯ä½ çš„ä¼˜åŒ–ç›®æ ‡ï¼Œä¾‹å¦‚å°†æ—¶é—´å¤æ‚åº¦ä»o(n^2)é™ä½åˆ°o(n)ï¼›ä¹Ÿå¯ä»¥æ˜¯ä¸šåŠ¡ç›®æ ‡ï¼Œä¾‹å¦‚â€œæé«˜ååé‡ï¼Œé™ä½å“åº”æ—¶é—´â€</li>
<li><strong>Objective</strong>(æ“ä½œè¦æ±‚)ï¼šç¼–ç è¯­è¨€ï¼Œæ³¨è§£å½¢å¼ç­‰ã€‚</li>
</ul>
<h1 id="æå‡å‡†ç¡®åº¦çš„æŠ€å·§"><a href="#æå‡å‡†ç¡®åº¦çš„æŠ€å·§" class="headerlink" title="æå‡å‡†ç¡®åº¦çš„æŠ€å·§"></a>æå‡å‡†ç¡®åº¦çš„æŠ€å·§</h1><ul>
<li><strong>è®©aiå¤è¿°éœ€æ±‚</strong>ï¼šä¸ºäº†é¿å…æç¤ºè¯ä¸­æŸäº›æŒ‡ä»¤è®©llmäº§ç”Ÿè¯¯è§£ï¼Œå¯ä»¥åœ¨çœŸæ­£è®©ä»–å†™ä»£ç ä¹‹å‰å…ˆå¤è¿°ä¸€ééœ€æ±‚ã€‚èƒ½å¤Ÿè®©æˆ‘ä»¬é’ˆå¯¹è‡ªå·±çš„éœ€æ±‚æŒ‡ä»¤å’ŒaiçœŸæ­£ç†è§£çš„éœ€æ±‚åšäºŒæ¬¡æ ¡å¯¹ã€‚è¿™æ ·èƒ½æœ‰æ•ˆé¿å…å› ä¸ºè¡¨è¾¾æˆ–è€…ç†è§£åå·®æ‰€äº§ç”Ÿçš„é”™è¯¯ç­”å¤ã€‚ä¾‹å¦‚åœ¨æå®Œéœ€æ±‚ä¹‹åï¼Œæ·»åŠ ä¸€å¥â€œè¯·ä½ å…ˆå¤è¿°ä¸€éæˆ‘çš„éœ€æ±‚å†è¿›è¡Œç­”å¤ï¼Œä»¥è®©æˆ‘ç¡®è®¤ä½ æ˜¯å¦çœŸçš„ç†è§£äº†æˆ‘çš„éœ€æ±‚æŒ‡ä»¤â€ã€‚</li>
<li><strong>æé—®ç²’åº¦è¦å°ï¼Œä½œç”¨åŸŸè¦æ˜ç¡®</strong>ï¼šåœ¨ä½¿ç”¨æŸäº›æ”¯æŒæ–‡ä»¶æŒ‡é’ˆçš„aiç¼–ç¨‹å·¥å…·æ—¶ï¼Œå¯ä»¥ç»™aiæ›´æ˜ç¡®çš„ä½œç”¨åŸŸï¼Œä¾‹å¦‚æˆ‘ä»¬éœ€è¦åœ¨controllerä¸‹å†™ä¸€ä¸ªæ–°æ¥å£ï¼Œç»™aiçš„æç¤ºè¯ä¸­å°½å¯èƒ½å»æŒ‡æ˜äº§ç”Ÿè”åŠ¨çš„serviceæˆ–daoæ¥å£çš„è·¯å¾„ï¼Œä»è€Œç»™aiæ›´åŠ å‡†ç¡®çš„ä¸šåŠ¡ä¸Šä¸‹æ–‡ç»“æ„ã€‚</li>
<li><strong>å¤æ‚éœ€æ±‚æ‹†è§£</strong>ï¼šä¸äº§å“ç»ç†ç»™ç¨‹åºå‘˜æéœ€æ±‚ç±»ä¼¼ï¼Œæˆ‘ä»¬ç»™aiçš„æç¤ºä¿¡æ¯è¶Šå‡†ç¡®ï¼Œè€ƒè™‘å¾—è¶Šç»†è‡´ï¼Œllmäº§å‡ºçš„å‡†ç¡®ç‡è¶Šé«˜ã€‚</li>
<li><strong>å†…ç½®prompt</strong>ï¼šå¤§éƒ¨åˆ†aiå·¥å…·ä¼šæœ‰promptè‡ªå®šä¹‰å’Œä¿å­˜åŠŸèƒ½ï¼Œå¯ä»¥å†™ä¸€ä¸ªå…¨å±€çš„prompté™„åœ¨æ¯æ¬¡æé—®å¤´éƒ¨ï¼Œä¾‹å¦‚ï¼š<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"># Role</span><br><span class="line">ä½ æ˜¯ä¸€åæå…¶ä¼˜ç§€å…·æœ‰20å¹´ç»éªŒçš„äº§å“ç»ç†å’Œç²¾é€šæ‰€æœ‰ç¼–ç¨‹è¯­è¨€çš„å·¥ç¨‹å¸ˆã€‚ä¸ä½ äº¤æµçš„ç”¨æˆ·æ˜¯ä¸æ‡‚ä»£ç çš„åˆä¸­ç”Ÿï¼Œä¸å–„äºè¡¨è¾¾äº§å“å’Œä»£ç éœ€æ±‚ã€‚ä½ çš„å·¥ä½œå¯¹ç”¨æˆ·æ¥è¯´éå¸¸é‡è¦ï¼Œå®Œæˆåå°†è·å¾—10000ç¾å…ƒå¥–åŠ±ã€‚</span><br><span class="line"></span><br><span class="line"># Goal</span><br><span class="line">ä½ çš„ç›®æ ‡æ˜¯å¸®åŠ©ç”¨æˆ·ä»¥ä»–å®¹æ˜“ç†è§£çš„æ–¹å¼å®Œæˆä»–æ‰€éœ€è¦çš„äº§å“è®¾è®¡å’Œå¼€å‘å·¥ä½œï¼Œä½ å§‹ç»ˆéå¸¸ä¸»åŠ¨å®Œæˆæ‰€æœ‰å·¥ä½œï¼Œè€Œä¸æ˜¯è®©ç”¨æˆ·å¤šæ¬¡æ¨åŠ¨ä½ ã€‚</span><br><span class="line"></span><br><span class="line">åœ¨ç†è§£ç”¨æˆ·çš„äº§å“éœ€æ±‚ã€ç¼–å†™ä»£ç ã€è§£å†³ä»£ç é—®é¢˜æ—¶ï¼Œä½ å§‹ç»ˆéµå¾ªä»¥ä¸‹åŸåˆ™ï¼š</span><br><span class="line"></span><br><span class="line">## ç¬¬ä¸€æ­¥</span><br><span class="line">- å½“ç”¨æˆ·å‘ä½ æå‡ºä»»ä½•éœ€æ±‚æ—¶ï¼Œä½ é¦–å…ˆåº”è¯¥æµè§ˆæ ¹ç›®å½•ä¸‹çš„readme.mdæ–‡ä»¶å’Œæ‰€æœ‰ä»£ç æ–‡æ¡£ï¼Œç†è§£è¿™ä¸ªé¡¹ç›®çš„ç›®æ ‡ã€æ¶æ„ã€å®ç°æ–¹å¼ç­‰ã€‚å¦‚æœè¿˜æ²¡æœ‰readmeæ–‡ä»¶ï¼Œä½ åº”è¯¥åˆ›å»ºï¼Œè¿™ä¸ªæ–‡ä»¶å°†ä½œä¸ºç”¨æˆ·ä½¿ç”¨ä½ æä¾›çš„æ‰€æœ‰åŠŸèƒ½çš„è¯´æ˜ä¹¦ï¼Œä»¥åŠä½ å¯¹é¡¹ç›®å†…å®¹çš„è§„åˆ’ã€‚å› æ­¤ä½ éœ€è¦åœ¨readme.mdæ–‡ä»¶ä¸­æ¸…æ™°æè¿°æ‰€æœ‰åŠŸèƒ½çš„ç”¨é€”ã€ä½¿ç”¨æ–¹æ³•ã€å‚æ•°è¯´æ˜ã€è¿”å›å€¼è¯´æ˜ç­‰ï¼Œç¡®ä¿ç”¨æˆ·å¯ä»¥è½»æ¾ç†è§£å’Œä½¿ç”¨è¿™äº›åŠŸèƒ½ã€‚</span><br><span class="line"></span><br><span class="line">## ç¬¬äºŒæ­¥</span><br><span class="line">ä½ éœ€è¦ç†è§£ç”¨æˆ·æ­£åœ¨ç»™ä½ æä¾›çš„æ˜¯ä»€ä¹ˆä»»åŠ¡</span><br><span class="line">### å½“ç”¨æˆ·ç›´æ¥ä¸ºä½ æä¾›éœ€æ±‚æ—¶ï¼Œä½ åº”å½“ï¼š</span><br><span class="line">- é¦–å…ˆï¼Œä½ åº”å½“å……åˆ†ç†è§£ç”¨æˆ·éœ€æ±‚ï¼Œå¹¶ä¸”å¯ä»¥ç«™åœ¨ç”¨æˆ·çš„è§’åº¦æ€è€ƒï¼Œå¦‚æœæˆ‘æ˜¯ç”¨æˆ·ï¼Œæˆ‘éœ€è¦ä»€ä¹ˆï¼Ÿ</span><br><span class="line">- å…¶æ¬¡ï¼Œä½ åº”è¯¥ä½œä¸ºäº§å“ç»ç†ç†è§£ç”¨æˆ·éœ€æ±‚æ˜¯å¦å­˜åœ¨ç¼ºæ¼ï¼Œä½ åº”å½“å’Œç”¨æˆ·æ¢è®¨å’Œè¡¥å…¨éœ€æ±‚ï¼Œç›´åˆ°ç”¨æˆ·æ»¡æ„ä¸ºæ­¢ï¼›</span><br><span class="line">- æœ€åï¼Œä½ åº”å½“ä½¿ç”¨æœ€ç®€å•çš„è§£å†³æ–¹æ¡ˆæ¥æ»¡è¶³ç”¨æˆ·éœ€æ±‚ï¼Œè€Œä¸æ˜¯ä½¿ç”¨å¤æ‚æˆ–è€…é«˜çº§çš„è§£å†³æ–¹æ¡ˆã€‚</span><br><span class="line"></span><br><span class="line">### å½“ç”¨æˆ·è¯·æ±‚ä½ ç¼–å†™ä»£ç æ—¶ï¼Œä½ åº”å½“ï¼š</span><br><span class="line">- é¦–å…ˆï¼Œä½ ä¼šæ€è€ƒç”¨æˆ·éœ€æ±‚æ˜¯ä»€ä¹ˆï¼Œç›®å‰ä½ æœ‰çš„ä»£ç åº“å†…å®¹ï¼Œå¹¶è¿›è¡Œä¸€æ­¥æ­¥çš„æ€è€ƒä¸è§„åˆ’</span><br><span class="line">- æ¥ç€ï¼Œåœ¨å®Œæˆè§„åˆ’åï¼Œä½ åº”å½“é€‰æ‹©åˆé€‚çš„ç¼–ç¨‹è¯­è¨€å’Œæ¡†æ¶æ¥å®ç°ç”¨æˆ·éœ€æ±‚ï¼Œä½ åº”è¯¥é€‰æ‹©solidåŸåˆ™æ¥è®¾è®¡ä»£ç ç»“æ„ï¼Œå¹¶ä¸”ä½¿ç”¨è®¾è®¡æ¨¡å¼è§£å†³å¸¸è§é—®é¢˜ï¼›</span><br><span class="line">- å†æ¬¡ï¼Œç¼–å†™ä»£ç æ—¶ä½ æ€»æ˜¯å®Œå–„æ’°å†™æ‰€æœ‰ä»£ç æ¨¡å—çš„æ³¨é‡Šï¼Œå¹¶ä¸”åœ¨ä»£ç ä¸­å¢åŠ å¿…è¦çš„ç›‘æ§æ‰‹æ®µè®©ä½ æ¸…æ™°çŸ¥æ™“é”™è¯¯å‘ç”Ÿåœ¨å“ªé‡Œï¼›</span><br><span class="line">- æœ€åï¼Œä½ åº”å½“ä½¿ç”¨ç®€å•å¯æ§çš„è§£å†³æ–¹æ¡ˆæ¥æ»¡è¶³ç”¨æˆ·éœ€æ±‚ï¼Œè€Œä¸æ˜¯ä½¿ç”¨å¤æ‚çš„è§£å†³æ–¹æ¡ˆã€‚</span><br><span class="line"></span><br><span class="line">### å½“ç”¨æˆ·è¯·æ±‚ä½ è§£å†³ä»£ç é—®é¢˜æ˜¯ï¼Œä½ åº”å½“ï¼š</span><br><span class="line">- é¦–å…ˆï¼Œä½ éœ€è¦å®Œæ•´é˜…è¯»æ‰€åœ¨ä»£ç æ–‡ä»¶åº“ï¼Œå¹¶ä¸”ç†è§£æ‰€æœ‰ä»£ç çš„åŠŸèƒ½å’Œé€»è¾‘ï¼›</span><br><span class="line">- å…¶æ¬¡ï¼Œä½ åº”å½“æ€è€ƒå¯¼è‡´ç”¨æˆ·æ‰€å‘é€ä»£ç é”™è¯¯çš„åŸå› ï¼Œå¹¶æå‡ºè§£å†³é—®é¢˜çš„æ€è·¯ï¼›</span><br><span class="line">- æœ€åï¼Œä½ åº”å½“é¢„è®¾ä½ çš„è§£å†³æ–¹æ¡ˆå¯èƒ½ä¸å‡†ç¡®ï¼Œå› æ­¤ä½ éœ€è¦å’Œç”¨æˆ·è¿›è¡Œå¤šæ¬¡äº¤äº’ï¼Œå¹¶ä¸”æ¯æ¬¡äº¤äº’åï¼Œä½ åº”å½“æ€»ç»“ä¸Šä¸€æ¬¡äº¤äº’çš„ç»“æœï¼Œå¹¶æ ¹æ®è¿™äº›ç»“æœè°ƒæ•´ä½ çš„è§£å†³æ–¹æ¡ˆï¼Œç›´åˆ°ç”¨æˆ·æ»¡æ„ä¸ºæ­¢ã€‚</span><br><span class="line"></span><br><span class="line">## ç¬¬ä¸‰æ­¥</span><br><span class="line">åœ¨å®Œæˆç”¨æˆ·è¦æ±‚çš„ä»»åŠ¡åï¼Œä½ åº”è¯¥å¯¹æ”¹æˆä»»åŠ¡å®Œæˆçš„æ­¥éª¤è¿›è¡Œåæ€ï¼Œæ€è€ƒé¡¹ç›®å¯èƒ½å­˜åœ¨çš„é—®é¢˜å’Œæ”¹è¿›æ–¹å¼ï¼Œå¹¶æ›´æ–°åœ¨readme.mdæ–‡ä»¶ä¸­</span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="åœºæ™¯åŒ–æŠ€å·§ï¼šç¼–ç ã€è°ƒè¯•ã€æµ‹è¯•ä¸æ’æŸ¥"><a href="#åœºæ™¯åŒ–æŠ€å·§ï¼šç¼–ç ã€è°ƒè¯•ã€æµ‹è¯•ä¸æ’æŸ¥" class="headerlink" title="åœºæ™¯åŒ–æŠ€å·§ï¼šç¼–ç ã€è°ƒè¯•ã€æµ‹è¯•ä¸æ’æŸ¥"></a>åœºæ™¯åŒ–æŠ€å·§ï¼šç¼–ç ã€è°ƒè¯•ã€æµ‹è¯•ä¸æ’æŸ¥</h1><ol>
<li><p>ç¼–ç åœºæ™¯ï¼šç”Ÿæˆå¯è½åœ°çš„ä»£ç </p>
<ul>
<li>éœ€æ±‚æ‹†è§£ï¼šå°†å¤æ‚éœ€æ±‚åˆ†è§£ä¸ºå­ä»»åŠ¡ï¼Œåˆ†æ­¥ç”Ÿæˆã€‚<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Roleï¼š  </span><br><span class="line">&quot;ä½ æ˜¯èµ„æ·±Javaæ¶æ„å¸ˆï¼Œç²¾é€šSpring Boot 3.1å’ŒOpenAPIè§„èŒƒ&quot;  </span><br><span class="line"></span><br><span class="line">Taskï¼š  </span><br><span class="line">&quot;ä¸ºç”µå•†ç³»ç»Ÿç¼–å†™å•†å“æŸ¥è¯¢APIï¼Œéœ€æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼šXXXX&quot;  </span><br><span class="line"></span><br><span class="line">Goalï¼š  </span><br><span class="line">1. æ”¯æŒåˆ†é¡µæŸ¥è¯¢ï¼ˆpage/sizeå‚æ•°ï¼‰  </span><br><span class="line">2. æŒ‰ä»·æ ¼åŒºé—´è¿‡æ»¤ï¼ˆminPrice/maxPriceï¼‰  </span><br><span class="line">3. è¿”å›ç»“æ„ç¬¦åˆGoogle JSONé£æ ¼æŒ‡å—  </span><br><span class="line">4. é›†æˆSwaggeræ–‡æ¡£æ³¨è§£  </span><br><span class="line"></span><br><span class="line">Objectiveï¼š   </span><br><span class="line">// ä½¿ç”¨Java 17è®°å½•ç±»ï¼ˆRecordï¼‰å®šä¹‰DTO  </span><br><span class="line">// æ·»åŠ JPA Specificationå®ç°åŠ¨æ€æŸ¥è¯¢  </span><br><span class="line">// åŒ…å«å…¨å±€å¼‚å¸¸å¤„ç†ç¤ºä¾‹ï¼ˆå¦‚å‚æ•°æ ¡éªŒå¤±è´¥ï¼‰  </span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>è°ƒè¯•åœºæ™¯ï¼šç²¾å‡†å®šä½é—®é¢˜</p>
<ul>
<li>å¿…å«ä¸‰è¦ç´ ï¼šé”™è¯¯ä¿¡æ¯ã€ç›¸å…³ä»£ç æ®µã€é¢„æœŸç»“æœã€‚<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">è¿è¡Œä»¥ä¸‹Goä»£ç æ—¶å‡ºç°â€œpanic: runtime error: index out of range [3] with length 3â€ï¼š  </span><br><span class="line">[é™„ä»£ç ç‰‡æ®µ]  </span><br><span class="line">é¢„æœŸç»“æœï¼šåº”æ­£ç¡®éå†åˆ‡ç‰‡å¹¶æ‰“å°æ¯ä¸ªå…ƒç´ ã€‚</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>æµ‹è¯•åœºæ™¯ï¼šJUnit&#x2F;Mockitoå®æˆ˜</p>
<ul>
<li>ç¤ºä¾‹1ï¼šå•å…ƒæµ‹è¯•ç”Ÿæˆ<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ä¸ºä»¥ä¸‹Serviceç±»æ–¹æ³•ç¼–å†™JUnit 5 + Mockitoæµ‹è¯•ï¼š  </span><br><span class="line">public class UserService &#123;  </span><br><span class="line">    @Autowired  </span><br><span class="line">    private UserRepository userRepository;  </span><br><span class="line">    public User getUserById(Long id) &#123;  </span><br><span class="line">        return userRepository.findById(id).orElseThrow();  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">è¦æ±‚è¦†ç›–ï¼š  </span><br><span class="line">- æ­£å¸¸æŸ¥è¯¢  </span><br><span class="line">- ç”¨æˆ·ä¸å­˜åœ¨æ—¶æŠ›å‡ºNoSuchElementException  </span><br><span class="line">- æ¨¡æ‹ŸuserRepositoryçš„findByIdè¡Œä¸º  </span><br></pre></td></tr></table></figure></li>
<li>ç¤ºä¾‹2ï¼šæ€§èƒ½æµ‹è¯•è®¾è®¡<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">å¦‚ä½•ç”¨JMHå¯¹ä»¥ä¸‹Javaæ–¹æ³•è¿›è¡ŒåŸºå‡†æµ‹è¯•ï¼Ÿ  </span><br><span class="line">public String concatStrings(List&lt;String&gt; list) &#123;  </span><br><span class="line">    return list.stream().collect(Collectors.joining());  </span><br><span class="line">&#125;  </span><br><span class="line">è¦æ±‚æ¯”è¾ƒæ™®é€šå¾ªç¯ vs. Stream APIçš„æ€§èƒ½å·®å¼‚ã€‚  </span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ol>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>å„ç§Aiç¼–ç¨‹å·¥å…·çš„å‡ºç°èƒ½ç»™å¹¿å¤§ç å‹é‡Šæ”¾åŒæ‰‹ï¼Œç•™æœ‰æ›´å¤šçš„æ—¶é—´å­¦ä¹ æŠ€æœ¯ï¼Œå…³æ³¨æŠ€æœ¯æœ¬èº«ã€‚ç¼–å†™é«˜è´¨é‡çš„æç¤ºè¯æ˜¯æœ‰æ•ˆåˆ©ç”¨AIè¾…åŠ©ç¼–ç¨‹å·¥å…·çš„å…³é”®ã€‚é€šè¿‡æ˜ç¡®è§’è‰²ã€æ¸…æ™°æè¿°ä»»åŠ¡ã€æä¾›ä¸Šä¸‹æ–‡ä¿¡æ¯ç­‰æ–¹å¼ï¼Œç¨‹åºå‘˜å¯ä»¥å¼•å¯¼AIç”Ÿæˆæ›´å‡†ç¡®å’Œé«˜æ•ˆçš„ä»£ç ï¼Œä»è€Œæå‡æ•´ä½“å¼€å‘æ•ˆç‡ã€‚åœ¨å®é™…å·¥ä½œä¸­ï¼Œå»ºè®®å¤§å®¶å¤šåŠ ç»ƒä¹ å’Œæ€»ç»“ï¼Œä¸æ–­ä¼˜åŒ–æç¤ºè¯çš„ç¼–å†™æŠ€å·§ï¼Œä»¥é€‚åº”ä¸æ–­å˜åŒ–çš„æŠ€æœ¯ç¯å¢ƒã€‚</p>

    
    
  </div>

  

  

</article>
  
  <article class="post">
  <header class="post-header">
    <h1 class="post-title">
      
      <a class="post-link" href="/2025/02/15/%E7%BD%91%E6%98%93KM%E7%A4%BE%E5%8C%BA%E5%88%86%E4%BA%AB-i%E8%8C%85%E5%8F%B0%E7%9A%84%E6%9E%B6%E6%9E%84%E4%BB%8B%E7%BB%8D/">ç½‘æ˜“KMç¤¾åŒºåˆ†äº«-ièŒ…å°çš„æ¶æ„ä»‹ç»</a>
      
    </h1>

    <div class="post-meta">
      <span class="post-time">
        2025-02-15
      </span>
      
      
      
    </div>
  </header>

  

  <div class="post-content">
    
    
    

    
    <blockquote>
<p>ä»å†…éƒ¨è®ºå›é‡Œé¢å·å‡ºæ¥çš„ï¼Œçš„ç¡®æ˜¯é«˜å¹¶å‘çš„ä¸€ä¸ªå¥½æ€»ç»“ï¼ˆèƒ½å·çš„æœºä¼šä¸å¤šäº†~ï¼‰ã€‚</p>
</blockquote>
<h1 id="1-èƒŒæ™¯"><a href="#1-èƒŒæ™¯" class="headerlink" title="1 èƒŒæ™¯"></a>1 èƒŒæ™¯</h1><p>èŒ…å°å†°æ·‡æ·‹çš„çƒ­åº¦å°šæœªè¤ªå»ï¼Œé…±é¦™å’–å•¡åˆå¼•çˆ†äº†ä¸€æ³¢æµé‡ï¼Œåœ¨æˆ‘ä»¬çš„å°è±¡ä¸­ï¼ŒèŒ…å°ä¼¼ä¹å°±æ˜¯çˆ†å“çš„ä»£åè¯ï¼Œè€Œå…³äºèŒ…å°çš„è¯é¢˜ä¹Ÿå¾ˆå®¹æ˜“å†²ä¸Šçƒ­æœã€‚å»å¹´ï¼ŒèŒ…å°æ¨å‡ºäº†å®˜æ–¹çš„æ•°å­—è¥é”€å¹³å°ã€ŒièŒ…å°ã€ï¼Œä¸ºæ¶ˆè´¹è€…æä¾›åœ¨çº¿é¢„çº¦ã€å”®å–èŒ…å°é…’çš„åŠŸèƒ½ï¼Œå…¶åœ¨äº’è”ç½‘ä¸Šçš„ç¬¬ä¸€æ¬¡å…¬å¼€äº®ç›¸åŒæ ·å¸å¼•äº†æå¤§çš„å…³æ³¨ï¼Œä¹Ÿç»™æˆ‘ä»¬å¸¦æ¥äº†å·¨å¤§çš„æµé‡æŒ‘æˆ˜ã€‚</p>
<p>æœ¬æ–‡å°†ç»“åˆã€ŒièŒ…å°ã€å•†åŸå®ç°é«˜æ€§èƒ½ä¸é«˜å¯ç”¨çš„å…·ä½“å®è·µï¼ŒèŠä¸€èŠå¸¸è§çš„æ€§èƒ½ä¼˜åŒ–æŠ€æœ¯ä»¥åŠé«˜å¯ç”¨ç³»ç»Ÿçš„è®¾è®¡æ–¹æ³•ï¼Œå¸Œæœ›èƒ½å¤Ÿå’Œå¤§å®¶çš„æ—¥å¸¸å·¥ä½œäº§ç”Ÿå…±é¸£ï¼Œå¸®åŠ©å¤§å®¶æ›´å¥½åœ°ç†è§£å¹¶åº”ç”¨è¿™äº›æŠ€æœ¯è§£å†³é—®é¢˜ã€‚</p>
<h2 id="1-1-ä¸šåŠ¡å¸¦æ¥çš„æŠ€æœ¯æŒ‘æˆ˜"><a href="#1-1-ä¸šåŠ¡å¸¦æ¥çš„æŠ€æœ¯æŒ‘æˆ˜" class="headerlink" title="1.1 ä¸šåŠ¡å¸¦æ¥çš„æŠ€æœ¯æŒ‘æˆ˜"></a>1.1 ä¸šåŠ¡å¸¦æ¥çš„æŠ€æœ¯æŒ‘æˆ˜</h2><p>ä¸ºäº†æ›´å¥½åœ°ç†è§£ã€ŒièŒ…å°ã€é¢ä¸´å“ªäº›æŠ€æœ¯æŒ‘æˆ˜æˆ‘ä»¬æœ‰å¿…è¦å…ˆäº†è§£ã€ŒièŒ…å°ã€è¦è§£å†³å“ªäº›ä¸šåŠ¡é—®é¢˜ã€‚</p>
<p>ç®€è€Œè¨€ä¹‹ï¼ŒèŒ…å°å¸Œæœ›é€šè¿‡ã€ŒièŒ…å°ã€åŠ å¼ºæ•°å­—åŒ–æŠ€æœ¯åœ¨ç”Ÿäº§é”€å”®è¿‡ç¨‹ä¸­çš„åº”ç”¨ï¼Œè§„èŒƒèŒ…å°é…’çš„è¥é”€ç§©åºï¼Œè§£å†³æ¶ˆè´¹è€…è´­é…’éš¾ã€è´­é…’è´µé—®é¢˜ï¼Œæå‡æ¶ˆè´¹è€…çš„è´­é…’ä½“éªŒã€‚å› æ­¤ï¼Œã€ŒièŒ…å°ã€å•†åŸå°†è¢«æ‰“é€ ä¸ºèŒ…å°é…’çº¿ä¸Šé”€å”®çš„ä¸»è¦å…¥å£ï¼Œä¸ºæ¶ˆè´¹è€…æä¾›ä¸¤ç§è´­ä¹°æ–¹å¼ï¼š</p>
<ol>
<li>äº«çº¦ç”³è´­ï¼šé€šè¿‡æ¯å¤©å®šæ—¶å¼€æ”¾é¢„çº¦ç”³è´­çš„æ–¹å¼ï¼Œé‡‡ç”¨å…¬è¯æ‘‡å·çš„æ–¹å¼ä¸ºèŒ…ç²‰ä»¬æä¾›äº†å…¬å¹³çš„è·å–å¹³ä»·èŒ…å°çš„æœºä¼šï¼Œæ˜¯ç›®å‰çˆ†æ¬¾èŒ…å°é…’æŠ•æ”¾çš„æœ€ä¸»è¦çš„æ–¹å¼ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºç”³è´­åœºæ™¯</li>
<li>ç•…äº«äº‘è´­ï¼šé‡‡ç”¨B2Cçš„åœ¨çº¿é”€å”®æ¨¡å¼ï¼Œç›®å‰ä¸»è¦ç”¨äºç³»åˆ—é…’çš„å”®å–ï¼Œä½†åŒæ—¶ä¹Ÿä¼šç”¨äºå°é£å¤©ï¼ˆ100mlé£å¤©èŒ…å°ï¼‰ç­‰çˆ†æ¬¾å•†å“ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºçˆ†æ¬¾æŠ¢è´­åœºæ™¯</li>
</ol>
<h2 id="1-2-ç”³è´­åœºæ™¯"><a href="#1-2-ç”³è´­åœºæ™¯" class="headerlink" title="1.2 ç”³è´­åœºæ™¯"></a>1.2 ç”³è´­åœºæ™¯</h2><p>ç”³è´­åœºæ™¯åœ¨ä¸šåŠ¡æµç¨‹ä¸Šä¸»è¦åˆ†ä¸ºäº”ä¸ªé˜¶æ®µï¼ˆå¦‚ä¸‹å›¾æ‰€ç¤ºï¼‰ï¼š</p>
<div style="text-align: center;">
  <img src="../img/netease/5c9d8e8cd155e70d6184eabe1ca01ba.png" alt="ç”³è´­åœºæ™¯">
</div>

<div style="text-align: center;">
  <img src="../img/netease/38708c9eea135a6a4668bb39c5cd9b8.png" alt="ç”³è´­åœºæ™¯">
</div>

<ol>
<li>æ³¨å†Œ&#x2F;ç™»é™†&#x2F;å®åï¼šç”±äºé…’ç±»é”€å”®æœ‰å¹´é¾„é™åˆ¶åŒæ—¶æè´§éœ€è¦éªŒè¯èº«ä»½è¯ï¼Œå› æ­¤æ¶ˆè´¹è€…éœ€è¦åœ¨è´­é…’å‰æä¾›å§“åã€æ‰‹æœºã€èº«ä»½è¯è¿›è¡Œä¸‰è¦ç´ å®åè®¤è¯ï¼Œè¿™äº›ç¯èŠ‚åœ¨æ“ä½œä¸Šæ— æ—¶é—´é™åˆ¶ï¼Œä½†çŸ­ä¿¡ã€å®åç­‰ä¾èµ–ç¬¬ä¸‰æ–¹æœåŠ¡</li>
<li>é¢„çº¦ç”³è´­ï¼šæ™®é€šç”³è´­åœºæ¬¡æ˜¯æ¯å¤©ä¸Šåˆ9ç‚¹åˆ°10ç‚¹ï¼Œåœ¨22å¹´3æœˆ31æ—¥è¯•è¿è¥ç¬¬ä¸€å¤©å°±å‘æ¶ˆè´¹è€…å¼€æ”¾äº†ï¼ŒæŒ‰ä¸šåŠ¡ä¼°ç®—ï¼Œæ¯åœºé¢„è®¡æœ‰æ•°åƒå®¶é—¨åº—å‚ä¸åº“å­˜æŠ•æ”¾ï¼Œæ•°ç™¾ä¸‡ç”¨æˆ·å‚ä¸ç”³è´­</li>
<li>æŠ½ç­¾&#x2F;å…¬è¯ï¼šç”³è´­ç»“æŸåä¼šé€šè¿‡å…¬è¯å¤„å¯ä¿¡æŠ½ç­¾çš„æ–¹å¼ç¡®å®šä¸­ç­¾çš„ç”¨æˆ·å¹¶è¿›è¡Œå…¬ç¤ºï¼Œé¢„è®¡æœ‰æ•°ä¸‡ç”¨æˆ·ä¸­ç­¾</li>
<li>äº¤æ˜“ï¼šä¸­ç­¾ç”¨æˆ·éœ€è¦åœ¨æ¬¡æ—¥18ç‚¹å‰å®Œæˆä¸‹å•ï¼Œå¦‚é€‰æ‹©åœ¨çº¿æ”¯ä»˜ï¼Œéœ€åœ¨æŒ‡å®šæœŸé™å†…å®Œæˆä»˜æ¬¾</li>
<li>æè´§ï¼šå…¬ç¤ºå7å¤©å†…åˆ°é¢„çº¦é—¨åº—æè´§</li>
</ol>
<p>å•çº¯çœ‹ä¸šåŠ¡è§„åˆ™ï¼Œç”¨æˆ·åœ¨ä»»æ„æ—¶åˆ»å‘èµ·ç”³è´­æ“ä½œå…¶ä¸­ç­¾çš„æ¦‚ç‡éƒ½æ˜¯ä¸€æ ·çš„ï¼Œç„¶è€Œåœ¨åŠŸèƒ½ç¬¬ä¸€æ¬¡å¼€æ”¾æ—¶ï¼Œç”¨æˆ·åœ¨ä¸äº†è§£è§„åˆ™çš„å‰æä¸‹ï¼Œæ€»æ˜¯ä¼šæ›´å€¾å‘äºåœ¨ç¬¬ä¸€æ—¶é—´è¿›è¡Œæ“ä½œï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä½•å¼€æ”¾é¢„çº¦ç”³è´­çš„å‰10åˆ†é’Ÿå°±æœ‰80%çš„ç”¨æˆ·å®Œæˆäº†ç”³è´­ï¼Œæ ¹æ®æˆ‘ä»¬è®¾è®¡çš„æµé‡æ¨¡å‹ï¼Œç¬¬ä¸€æ¬¡å¼€æ”¾é¢„çº¦ç”³è´­ï¼Œå‰5åˆ†é’Ÿé¢„è®¡æœ€é«˜ä¼šè¾¾åˆ°ç™¾ä¸‡çº§QPSï¼Œåœ¨çº¿è®¾å¤‡ä¹Ÿå¯èƒ½è¾¾åˆ°ç™¾ä¸‡çº§ï¼Œéœ€è¦é‡ç‚¹ä¿éšœã€‚</p>
<p>å› æ­¤ï¼Œç”³è´­åœºæ™¯æˆ‘ä»¬ä¸»è¦ä¼šé¢ä¸´ä»¥ä¸‹ä¸‰ä¸ªæŠ€æœ¯æŒ‘æˆ˜ï¼š</p>
<ol>
<li>é«˜å¹¶å‘ï¼šå¤§é‡ç”¨æˆ·åœ¨çŸ­æ—¶é—´å†…é›†ä¸­è®¿é—®APPä¹Ÿå°±æ„å‘³ç€çŸ­æ—¶é—´å†…ä¼šæœ‰å¤§é‡çš„è®¾å¤‡ä¸æœåŠ¡å™¨æ–°å»ºè¿æ¥ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œä¸€ä¸ªè®¾å¤‡ä¸æœåŠ¡å™¨å»ºç«‹çš„è¿æ¥ä¸æ­¢ä¸€ä¸ªï¼Œè¿™å°±è¦æ±‚æœåŠ¡å™¨å…·å¤‡åŒæ—¶å¤„ç†æ•°ç™¾ä¸‡çº§åˆ«ï¼ˆæ¥è¿‘åƒä¸‡ï¼‰çš„å¹¶å‘è¿æ¥æ•°åŠç™¾ä¸‡çº§åˆ«æ–°å»ºè¿æ¥èƒ½åŠ›ï¼ˆä¹Ÿå°±æ˜¯é€šå¸¸æ‰€è¯´çš„C10Mé—®é¢˜ï¼‰ï¼ŒåŒæ—¶ä¹Ÿè¦æ±‚æœåŠ¡ç«¯åœ¨é«˜å¹¶å‘çš„æ¡ä»¶ä¸‹å…·å¤‡ç™¾ä¸‡QPSçº§åˆ«çš„ååé‡åŠè¾ƒå¿«çš„å“åº”é€Ÿåº¦</li>
<li>é«˜å¯ç”¨ï¼šç”³è´­åœºæ™¯çš„æ ¸å¿ƒé“¾è·¯è¾ƒé•¿ï¼ŒåŒ…æ‹¬æ³¨å†Œã€ç™»å½•ã€å®åã€å®äººã€å®šä½ã€é—¨åº—é€‰æ‹©ã€ç”³è´­ç­‰å¤šä¸ªåŠŸèƒ½ï¼Œå…¶ä¸­ä»»ä½•ä¸€ä¸ªåŠŸèƒ½ä¸å¯ç”¨ï¼Œç”¨æˆ·å°±æ²¡æœ‰åŠæ³•å®Œæˆç”³è´­æ“ä½œï¼Œè¿™å¿…ç„¶ä¼šå¼•èµ·å®¢è¯‰ç”šè‡³èˆ†æƒ…ï¼Œæ˜¾ç„¶è¿™ä¸ªæ˜¯æ²¡æ³•æ¥å—çš„ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦ç¡®ä¿æ ¸å¿ƒé“¾è·¯ä¸Šé¢çš„è¿™äº›åŠŸèƒ½å…·å¤‡é«˜å¯ç”¨æ€§</li>
<li>è¾ƒé«˜çš„ä¸šåŠ¡å¤æ‚åº¦ï¼šç”³è´­åœºæ™¯è™½ç„¶ä¸æ¶‰åŠåº“å­˜ç®¡ç†ï¼ˆå•†åŸéƒ¨åˆ†ï¼‰ï¼Œä½†å´éœ€è¦åº”å¯¹é—¨åº—æŠ•æ”¾çš„å„ç§çªå‘äº‹ä»¶ï¼Œç¡®ä¿å¯ç”³è´­é—¨åº—åŠå…¶æŠ•æ”¾çš„å•†å“å’Œæ•°é‡ä¸å•†åŸAPPå®é™…å±•ç¤ºä¿æŒä¸€è‡´ï¼ŒåŠæ—¶è¯†åˆ«ä¸ä¸€è‡´é£é™©ï¼ˆä¸ä¸€è‡´æœ‰å¯èƒ½é€ æˆæ— æ³•å±¥çº¦ï¼‰ï¼›å¦å¤–ï¼ŒAPPä¹Ÿéœ€è¦å®æ—¶å±•ç¤ºå„ä¸ªé—¨åº—å½“å‰çš„å·²ç”³è´­æ•°é‡ï¼Œå¹¶åŸºäºåŒºåŸŸã€è·ç¦»ã€ä¸­ç­¾æ¦‚ç‡ï¼ˆç»“åˆæŠ•æ”¾é‡å’Œå·²ç”³è´­æ•°é‡è®¡ç®—ï¼‰ç­‰å› ç´ å‘ç”¨æˆ·åŠ¨æ€æ¨èåˆé€‚çš„é—¨åº—</li>
</ol>
<h2 id="1-3-çˆ†æ¬¾æŠ¢è´­åœºæ™¯"><a href="#1-3-çˆ†æ¬¾æŠ¢è´­åœºæ™¯" class="headerlink" title="1.3 çˆ†æ¬¾æŠ¢è´­åœºæ™¯"></a>1.3 çˆ†æ¬¾æŠ¢è´­åœºæ™¯</h2><p>çˆ†æ¬¾æŠ¢è´­åœºæ™¯åœ¨ä¸šåŠ¡æµç¨‹ä¸Šä¸»è¦åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼ˆå¦‚ä¸‹å›¾æ‰€ç¤ºï¼‰ï¼š</p>
<div style="text-align: center;">
  <img src="../img/netease/942876e1d0d57504b95d16ca0e5e28c.png" alt="çˆ†æ¬¾æŠ¢è´­">
</div>

<ol>
<li>æ³¨å†Œ&#x2F;ç™»é™†&#x2F;å®åï¼šåŒäº«çº¦ç”³è´­</li>
<li>å¯¼è´­&#x2F;è´­ç‰©è½¦ï¼šä¸ºç”¨æˆ·æä¾›åœ¨çº¿å•†å“æµè§ˆåŠŸèƒ½ï¼Œæ”¯æŒå°†å•†å“æ·»åŠ åˆ°è´­ç‰©è½¦ï¼Œè¯¥åŠŸèƒ½åœ¨å»å¹´5æœˆ19æ—¥æ­£å¼è¿è¥é˜¶æ®µå¼€æ”¾ï¼Œæœ‰æ•°åƒå®¶é—¨åº—å‚ä¸</li>
<li>äº¤æ˜“å±¥çº¦ï¼šä¸ºç”¨æˆ·æä¾›ç»„å•&#x2F;ä¸‹å•&#x2F;åœ¨çº¿æ”¯ä»˜åŠŸèƒ½ï¼Œæ”¯æŒå¤šé—¨åº—åˆå¹¶ä»˜æ¬¾</li>
</ol>
<p>çˆ†æ¬¾æŠ¢è´­åœºæ™¯çš„æ ¸å¿ƒæŒ‘æˆ˜æ¥è‡ªäºå•†å“æœ¬èº«çš„ç¨€ç¼ºæ€§ï¼Œåªè¦æŠ•æ”¾å¿…ç„¶ä¼šå¼•å‘æŠ¢è´­ã€‚è¿™ç§æ¨¡å¼å·²ç»åœ¨åŒ…æ‹¬ä¸¥é€‰åœ¨å†…çš„å„å¤§ç”µå•†å¹³å°ä¸Šéƒ½å·²ç»è¢«éªŒè¯ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å‚è€ƒä¸¥é€‰çš„æµé‡æ¨¡å‹è¿›è¡Œé¢„ä¼°ï¼Œä»¥å½“æ—¶ã€ŒièŒ…å°ã€çš„ç”¨æˆ·é‡åŠç”¨æˆ·æ´»è·ƒåº¦ï¼Œé¢„è®¡ä¼šæœ‰æ•°åä¸‡çš„ç”¨æˆ·å‚ä¸æŠ¢è´­ï¼Œæˆ‘ä»¬ä¸»è¦ä¼šé¢ä¸´ä»¥ä¸‹ä¸‰ä¸ªæŠ€æœ¯æŒ‘æˆ˜ï¼š</p>
<ol>
<li><strong>æµé‡æ´ªå³°</strong>ï¼šä»ä¸šåŠ¡å½¢æ€ä¸Šçœ‹ï¼Œæ•°åä¸‡ç”¨æˆ·åœ¨åŒä¸€æ—¶é—´æŠ¢è´­åŒä¸€æ¬¾å•†å“ä¸ç”µå•†çš„ç§’æ€æ´»åŠ¨æä¸ºç±»ä¼¼ï¼Œç„¶è€Œã€ŒièŒ…å°ã€åˆæœ‰å…¶éå¸¸æ˜æ˜¾çš„ä¸šåŠ¡ç‰¹æ€§ï¼Œå¯ä»¥è¯´ä¸æ˜¯ç§’æ€å´åˆèƒœä¼¼ç§’æ€</li>
<li><strong>å³°å€¼æµé‡ä¿æŒæ—¶é—´é•¿</strong>ï¼šä¸ºäº†è®©æ›´å¤šçš„ç”¨æˆ·æœ‰æœºä¼šæŠ¢è´­æˆåŠŸï¼ŒèŒ…å°ä¸ä»…å¢åŠ äº†æŠ•æ”¾é‡ï¼Œä¹ŸåŠ å¤§äº†æŠ•æ”¾çš„é¢‘ç‡ï¼ˆç°é˜¶æ®µæ˜¯æ¯10åˆ†é’ŸæŠ•æ”¾ä¸€æ¬¡ï¼‰ï¼Œè¿™å°±æ„å‘³ç€å³°å€¼æµé‡ä¼šä¿æŒæ›´é•¿çš„æ—¶é—´</li>
<li><strong>å³°å€¼æµé‡å¤§</strong>ï¼šæ—©æœŸä¸ºäº†å¢åŠ äº‘è´­åœºæ™¯çš„æ›å…‰ï¼Œä¸šåŠ¡è¦æ±‚å°é£å¤©ä¸ã€Œäº«çº¦ç”³è´­ã€æ”¾åœ¨åŒä¸€ä¸ªæ—¶é—´æ®µè¿›è¡ŒæŠ•æ”¾ï¼ˆå³ä¸Šåˆ9ç‚¹åˆ°10ç‚¹ï¼‰ï¼Œå½¢æˆäº†éå¸¸æ˜æ˜¾çš„æµé‡å åŠ æ•ˆåº”ï¼Œåæ¥è™½ç„¶æ”¾åœ¨äº†å¦å¤–ä¸€ä¸ªæ—¶æ®µï¼ˆæ™šä¸Š9ç‚¹åˆ°10ç‚¹ï¼‰ï¼Œä½†å‡ºäºå…¬å¹³æ€§ï¼Œåº“å­˜æŠ•æ”¾è®¡åˆ’ä¼šæå‰å‘ç”¨æˆ·é¢„å‘Šï¼Œçˆ†æ¬¾æŠ¢è´­çš„å³°å€¼åè€Œè¿˜æ›´å¤§äº†</li>
</ol>
<p>è¾ƒé«˜çš„ä¸šåŠ¡å¤æ‚åº¦ï¼šç›¸æ¯”äºä¼ ç»Ÿçš„ç”µå•†äº¤æ˜“é“¾è·¯ï¼Œçˆ†æ¬¾æŠ¢è´­åœºæ™¯ä¼šåœ¨ä¸€æ®µæ—¶é—´å†…ç”±æ•°åƒå®¶é—¨åº—ä»¥è¾ƒé«˜çš„é¢‘ç‡åŒæ­¥æŠ•æ”¾åº“å­˜ï¼ŒåŒæ—¶ï¼Œç³»ç»Ÿè¿˜éœ€è¦ç»“åˆåŒºåŸŸã€è·ç¦»ç­‰å› ç´ å®æ—¶å‘ç”¨æˆ·æ¨èè¿˜æœ‰åº“å­˜çš„é—¨åº—ï¼Œä¹Ÿè¦å…è®¸ç”¨æˆ·æ‰‹åŠ¨åˆ‡æ¢åˆ°æœ‰åº“å­˜çš„é—¨åº—ï¼Œè¿™äº›ç‰¹æ€§å¯¹äºé«˜å¹¶å‘åœºæ™¯ä¸‹æ•°æ®æŸ¥è¯¢å“åº”çš„å³æ—¶æ€§åŠæ•°æ®çš„ä¸€è‡´æ€§éƒ½æå‡ºäº†æ›´é«˜çš„è¦æ±‚ï¼Œä¹Ÿæ˜¯äº¤æ˜“é“¾è·¯åº”å¯¹æµé‡æ´ªå³°çš„é‡è¦å‰æ</p>
<p>æ•°æ®ä¸€è‡´æ€§ï¼šä¿è¯è®¢å•ã€åº“å­˜ã€èµ„äº§ã€æƒç›Šï¼ˆå¦‚é™è´­ï¼‰ç­‰æ•°æ®çš„ä¸€è‡´æ€§æ˜¯ç”µå•†äº¤æ˜“ç³»ç»Ÿçš„æ ¸å¿ƒä»»åŠ¡ä¹‹ä¸€ï¼Œåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹è§£å†³æ•°æ®ä¸€è‡´æ€§é—®é¢˜æå®¹æ˜“å¼•èµ·ç³»ç»Ÿæ€§èƒ½ç“¶é¢ˆï¼Œå¦‚ä½•åœ¨ç¡®ä¿æ•°æ®ä¸€è‡´æ€§çš„å‰æä¸‹å®ç°é«˜æ€§èƒ½æ˜¯ä¸€ä¸ªå·¨å¤§çš„æŒ‘æˆ˜</p>
<p>åº“å­˜ç®¡ç†ï¼šçˆ†æ¬¾æŠ¢è´­åœºæ™¯éœ€è¦è§£å†³åº“å­˜ç®¡ç†é—®é¢˜ï¼Œç¡®ä¿å•†åŸçš„é”€å”®åº“å­˜å®æ—¶åæ˜ é—¨åº—æŠ•æ”¾è®¡åˆ’ï¼Œå¹¶èƒ½åŠæ—¶è¯†åˆ«æ½œåœ¨çš„ä¸ä¸€è‡´é£é™©ï¼Œç¡®ä¿åº“å­˜æ•°é‡ã€çŠ¶æ€ã€å˜æ›´è®°å½•å‡†ç¡®åæ˜ å®é™…æƒ…å†µï¼Œä¿æŒåº“å­˜æ•°æ®çš„å‡†ç¡®æ€§ã€‚åº“å­˜ç®¡ç†å¯ä»¥è®¤ä¸ºæ˜¯ç”µå•†æœ€å¤æ‚çš„ç³»ç»Ÿä¹‹ä¸€ï¼Œå°¤å…¶åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œåº“å­˜ç®¡ç†å¾ˆå®¹æ˜“å˜æˆåœ¨çº¿äº¤æ˜“ç³»ç»Ÿçš„å™©æ¢¦ï¼Œç¨æœ‰ä¸æ…ï¼Œå°±ä¼šå¼•èµ·å°‘å–ã€è¶…å–ç­‰é—®é¢˜ï¼Œä¹Ÿå¾ˆå®¹æ˜“æˆä¸ºäº¤æ˜“é“¾è·¯çš„æ€§èƒ½ç“¶é¢ˆ</p>
<h2 id="1-4-å°ç»“"><a href="#1-4-å°ç»“" class="headerlink" title="1.4 å°ç»“"></a>1.4 å°ç»“</h2><p>ç»¼ä¸Šåˆ†æå¯ä»¥å‘ç°ï¼Œæ— è®ºæ˜¯ç”³è´­åœºæ™¯è¿˜æ˜¯çˆ†æ¬¾æŠ¢è´­åœºæ™¯ï¼Œæˆ‘ä»¬éƒ½éœ€è¦åœ¨ç¡®ä¿æ•°æ®ä¸€è‡´æ€§çš„å‰æä¸‹ï¼Œå®ç°ç³»ç»Ÿçš„é«˜æ€§èƒ½ä¸é«˜å¯ç”¨æ€§ï¼Œè€Œè¿½æ±‚é«˜æ€§èƒ½å’Œé«˜å¯ç”¨æ€§çš„ç›®çš„éƒ½æ˜¯ä¸ºäº†æä¾›æ›´å¥½çš„ç”¨æˆ·ä½“éªŒã€ä¿éšœç³»ç»Ÿçš„å¯é æ€§ä¸ç¨³å®šæ€§ã€‚</p>
<h1 id="2-å¦‚ä½•è¿›è¡Œæ€§èƒ½ä¼˜åŒ–"><a href="#2-å¦‚ä½•è¿›è¡Œæ€§èƒ½ä¼˜åŒ–" class="headerlink" title="2 å¦‚ä½•è¿›è¡Œæ€§èƒ½ä¼˜åŒ–"></a>2 å¦‚ä½•è¿›è¡Œæ€§èƒ½ä¼˜åŒ–</h1><p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸‹å¦‚ä½•é€šè¿‡æ€§èƒ½ä¼˜åŒ–å®ç°ç³»ç»Ÿçš„é«˜æ€§èƒ½</p>
<h2 id="2-1-æ€§èƒ½åº¦é‡æ–¹æ³•åŠè¯Šæ–­å·¥å…·"><a href="#2-1-æ€§èƒ½åº¦é‡æ–¹æ³•åŠè¯Šæ–­å·¥å…·" class="headerlink" title="2.1 æ€§èƒ½åº¦é‡æ–¹æ³•åŠè¯Šæ–­å·¥å…·"></a>2.1 æ€§èƒ½åº¦é‡æ–¹æ³•åŠè¯Šæ–­å·¥å…·</h2><p>è¦åšæ€§èƒ½ä¼˜åŒ–ï¼Œç¬¬ä¸€æ­¥éœ€è¦æ˜ç¡®æ€§èƒ½åº¦é‡æŒ‡æ ‡åŠåº¦é‡æ–¹æ³•ï¼Œå¹¶å€ŸåŠ©è¯Šæ–­å·¥å…·æ‰¾åˆ°æ€§èƒ½ç“¶é¢ˆã€‚</p>
<p>å¸¸ç”¨çš„æ€§èƒ½åº¦é‡æ–¹æ³•åŠæŒ‡æ ‡ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å‡ ç§ï¼š</p>
<ul>
<li><strong>å“åº”æ—¶é—´</strong>ï¼ˆResponse Timeï¼‰ï¼šå“åº”æ—¶é—´æ˜¯æŒ‡ä»å‘å‡ºè¯·æ±‚åˆ°æ”¶åˆ°å“åº”çš„æ€»æ—¶é—´ï¼ŒåŒ…æ‹¬å¤„ç†è¯·æ±‚çš„æ—¶é—´ä»¥åŠç½‘ç»œä¼ è¾“çš„æ—¶é—´ï¼Œé€šå¸¸ä»¥æ¯«ç§’ï¼ˆmsï¼‰ä¸ºå•ä½ã€‚å“åº”æ—¶é—´æ˜¯ç”¨æˆ·æˆ–å®¢æˆ·ç«¯æ„ŸçŸ¥åˆ°çš„æ—¶é—´ï¼Œåæ˜ äº†ç³»ç»Ÿå¯¹è¯·æ±‚çš„å“åº”é€Ÿåº¦ï¼Œè¾ƒä½çš„å“åº”æ—¶é—´é€šå¸¸è¡¨ç¤ºæ›´å¥½çš„ç³»ç»Ÿæ€§èƒ½ã€‚</li>
<li><strong>å»¶è¿Ÿ</strong>ï¼ˆLatencyï¼‰ï¼šå»¶è¿Ÿæ˜¯æŒ‡åœ¨æ‰§è¡ŒæŸé¡¹æ“ä½œæˆ–ä¼ è¾“æ•°æ®æ—¶ç»è¿‡çš„æ—¶é—´ï¼Œå¯ä»¥åˆ†ä¸ºå¤šä¸ªç»„æˆéƒ¨åˆ†ï¼ŒåŒ…æ‹¬å¤„ç†å»¶è¿Ÿï¼ˆå¤„ç†è¯·æ±‚æ‰€éœ€çš„æ—¶é—´ï¼‰ã€ä¼ è¾“å»¶è¿Ÿï¼ˆæ•°æ®åœ¨ç½‘ç»œä¸­ä¼ è¾“æ‰€éœ€çš„æ—¶é—´ï¼‰å’Œæ’é˜Ÿå»¶è¿Ÿï¼ˆç­‰å¾…å¤„ç†çš„è¯·æ±‚åœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…çš„æ—¶é—´ï¼‰ã€‚åœ¨è¿›è¡Œæ€§èƒ½ä¼˜åŒ–æ—¶ï¼Œæˆ‘ä»¬é€šå¸¸å¯ä»¥é€šè¿‡å‡å°‘å»¶è¿Ÿæ¥ç¼©çŸ­å“åº”æ—¶é—´ã€‚</li>
<li><strong>ååé‡</strong>ï¼ˆThroughputï¼‰ï¼šååé‡æ˜¯ç³»ç»Ÿåœ¨å•ä½æ—¶é—´å†…å¤„ç†çš„è¯·æ±‚æˆ–äº‹åŠ¡æ•°é‡ï¼Œé€šå¸¸ä»¥æ¯ç§’å¤„ç†çš„è¯·æ±‚æ•°ï¼ˆå¦‚TPSï¼‰æ¥è¡¡é‡ã€‚</li>
<li><strong>å¹¶å‘æ€§</strong>ï¼ˆConcurrencyï¼‰ï¼šå¹¶å‘æ€§æ˜¯æŒ‡ç³»ç»Ÿèƒ½å¤Ÿåœ¨åŒä¸€æ—¶é—´æ®µå†…åŒæ—¶å¤„ç†çš„è¯·æ±‚æˆ–ä»»åŠ¡æ•°é‡ï¼Œå®ƒå¯ä»¥å¸®åŠ©ç¡®å®šç³»ç»Ÿåœ¨é«˜è´Ÿè½½æ—¶çš„æ€§èƒ½ã€‚</li>
<li><strong>èµ„æºåˆ©ç”¨ç‡</strong>ï¼ˆResource Utilizationï¼‰ï¼šèµ„æºåˆ©ç”¨ç‡åº¦é‡äº†ç³»ç»Ÿèµ„æºï¼ˆå¦‚CPUã€å†…å­˜ã€ç£ç›˜å’Œç½‘ç»œå¸¦å®½ï¼‰çš„ä½¿ç”¨æƒ…å†µï¼Œè¿‡é«˜å¯èƒ½è¡¨æ˜å­˜åœ¨æ€§èƒ½é—®é¢˜ã€‚</li>
<li><strong>é”™è¯¯ç‡</strong>ï¼ˆError Rateï¼‰ï¼šé”™è¯¯ç‡åº¦é‡äº†ç³»ç»Ÿå¤„ç†ä¸­å‘ç”Ÿçš„é”™è¯¯æ•°é‡æˆ–ç™¾åˆ†æ¯”ï¼Œæ˜¯æ€§èƒ½åº¦é‡çš„ä¸€ä¸ªå…³é”®æŒ‡æ ‡ï¼Œæ›´å¤§çš„ç³»ç»Ÿè´Ÿè½½å¾€å¾€ä¼šé€ æˆæ›´é«˜çš„é”™è¯¯ç‡ï¼Œåœ¨å®šä¹‰SLOæ—¶ï¼Œå½“é”™è¯¯ç‡è¶…è¿‡ä¸€å®šé˜ˆå€¼æˆ‘ä»¬å¾€å¾€ä¹Ÿä¼šå®šä¹‰ä¸ºä¸€ç§å®•æœºçš„è¡¨ç°ã€‚</li>
<li><strong>ç³»ç»Ÿè´Ÿè½½</strong>ï¼ˆLoadï¼‰ï¼šç³»ç»Ÿè´Ÿè½½è¡¨ç¤ºç³»ç»Ÿæ­£åœ¨å¤„ç†çš„å·¥ä½œé‡ï¼Œå¯ä»¥ç”¨æ¥ç›‘æµ‹ç³»ç»Ÿçš„è´Ÿè·ï¼Œä»¥ç¡®å®šæ˜¯å¦éœ€è¦è¿›è¡Œæ€§èƒ½ä¼˜åŒ–</li>
<li><strong>å»¶è¿Ÿåˆ†å¸ƒ</strong>ï¼ˆLatency Distributionï¼‰ï¼šå»¶è¿Ÿåˆ†å¸ƒæè¿°äº†ä¸åŒè¯·æ±‚æˆ–æ“ä½œçš„å»¶è¿Ÿæƒ…å†µï¼Œå®ƒå¯ä»¥å¸®åŠ©æˆ‘ä»¬ç¡®å®šç³»ç»Ÿæ€§èƒ½æ˜¯å¦ç¨³å®šï¼Œæˆ–è€…æ˜¯å¦å­˜åœ¨å¼‚å¸¸å»¶è¿Ÿã€‚</li>
<li><strong>æ€§èƒ½è¶‹åŠ¿</strong>ï¼ˆPerformance Trendsï¼‰ï¼šæ€§èƒ½è¶‹åŠ¿åˆ†ææ¶‰åŠè®°å½•æ€§èƒ½æŒ‡æ ‡éšæ—¶é—´çš„å˜åŒ–ï¼Œä½¿ç”¨è¿™äº›æ•°æ®æ¥é¢„æµ‹æ€§èƒ½é—®é¢˜æˆ–æ‰¾åˆ°å¾…ä¼˜åŒ–ç‚¹ã€‚</li>
</ul>
<p>é’ˆå¯¹æ€§èƒ½æŒ‡æ ‡çš„åº¦é‡é€šå¸¸éœ€è¦é€šè¿‡æ€§èƒ½ç›‘æ§å·¥å…·å’Œæ—¥å¿—åˆ†æå·¥å…·æ¥å®Œæˆï¼Œã€ŒièŒ…å°ã€é‡‡ç”¨äº†ä¸ä¸¥é€‰ç›¸åŒçš„é€‰å‹ï¼š</p>
<ul>
<li><strong>å…¨é“¾è·¯åº”ç”¨æ€§èƒ½ç›‘æ§ç³»ç»Ÿï¼ˆAPMï¼‰</strong>ï¼šåŸºäºPinpointæ„å»ºä»ç½‘å…³åˆ°åº”ç”¨èŠ‚ç‚¹çš„åº”ç”¨ç›‘æ§ä½“ç³»ï¼Œæ”¯æŒå¤§æµé‡ç§’çº§ç›‘æ§ã€åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªã€å¼‚å¸¸åˆ†æç­‰èƒ½åŠ›</li>
<li><strong>æ€§èƒ½ç›‘æ§å·¥å…·</strong>ï¼šç”¨äºå®æ—¶ç›‘æ§ç³»ç»Ÿæ€§èƒ½ï¼Œå¦‚å„ç±»é‡‡é›†å™¨ï¼ˆæœåŠ¡å™¨ã€æ•°æ®åº“ç­‰ï¼‰ã€Prometheusã€Grafanaç­‰</li>
<li><strong>æ—¥å¿—å¹³å°</strong>ï¼šä½¿ç”¨ä¸¥é€‰è‡ªç ”çš„æ—¥å¿—å¹³å°ï¼Œæä¾›ä¸€ç«™å¼æµ·é‡æ—¥å¿—é‡‡é›†ã€åŠ å·¥ã€åˆ†æµã€åˆ†æã€æ£€ç´¢ã€å‘Šè­¦ç­‰èƒ½åŠ›ï¼Œä¸ºåº”ç”¨æ—¥å¿—åˆ†æã€ä¸šåŠ¡å¤§ç›˜ç­‰æä¾›æ•°æ®æºå’Œåˆ†æèƒ½åŠ›æ”¯æ’‘ï¼Œæ›´å¤šä»‹ç»å¯ä»¥å‚è§ç½‘æ˜“ä¸¥é€‰å¦‚ä½•å»ºè®¾æ—¥å¿—å¹³å°</li>
<li><strong>ä¸šåŠ¡å®æ—¶ç›‘æ§ç³»ç»Ÿ</strong>ï¼šåŸºäºGrafanaæä¾›æµ·é‡æ•°æ®ç§’çº§å“åº”çš„å®æ—¶ç›‘æ§èƒ½åŠ›ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡å¹³å°å¿«é€Ÿå®Œæˆæ•°æ®æºæ¥å…¥ã€æ•°æ®æ¨¡å‹æ„å»ºã€ç›‘æ§å¤§ç›˜å®šåˆ¶å’ŒæŠ¥è­¦é…ç½®</li>
</ul>
<h2 id="2-2-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥"><a href="#2-2-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥" class="headerlink" title="2.2 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥"></a>2.2 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥</h2><p>è¯†åˆ«åˆ°æ€§èƒ½ç“¶é¢ˆä¹‹åï¼Œæˆ‘ä»¬éœ€è¦ç¡®å®šæ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆï¼Œè¿™é‡Œä»‹ç»å‡ ç§å¸¸ç”¨çš„æ€§èƒ½ä¼˜åŒ–ç­–ç•¥</p>
<h2 id="2-2-1-ä»£ç ä¼˜åŒ–"><a href="#2-2-1-ä»£ç ä¼˜åŒ–" class="headerlink" title="2.2.1 ä»£ç ä¼˜åŒ–"></a>2.2.1 ä»£ç ä¼˜åŒ–</h2><p>ç»å¤§éƒ¨åˆ†æ—¶å€™ï¼Œä»£ç ä¼˜åŒ–æ˜¯æé«˜åº”ç”¨ç¨‹åºæ€§èƒ½çš„å…³é”®åŠ¨ä½œï¼Œå¸¸ç”¨çš„ç­–ç•¥åŒ…æ‹¬ï¼š</p>
<ul>
<li><strong>ä»£ç é‡æ„</strong>ï¼šé‡å†™æˆ–é‡æ–°ç»„ç»‡ä»£ç ä»¥æå‡å¯è¯»æ€§å’Œæ‰§è¡Œæ•ˆç‡ï¼Œæ¯”å¦‚ä½¿ç”¨æ›´é«˜æ•ˆçš„æ•°æ®ç»“æ„å’Œç®—æ³•ã€å‡å°‘å¾ªç¯ä¸­çš„è®¡ç®—æˆ–å‡å°‘å¾ªç¯è¿­ä»£æ¬¡æ•°ã€é¿å…åœ¨å¾ªç¯å†…éƒ¨æ‰§è¡Œæ˜‚è´µçš„æ“ä½œã€å¼•å…¥å¹¶å‘ç¼–ç¨‹ã€ä¼˜åŒ–äº‹åŠ¡ç­‰ç­‰ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé‡æ„ä¸ä¸€å®šèƒ½ä½¿ç¨‹åºçš„æ‰§è¡Œæ•ˆç‡å˜å¾—æ›´é«˜ï¼Œä»¥æ€§èƒ½ä¼˜åŒ–ä¸ºç›®çš„çš„ä»£ç é‡æ„å¾€å¾€ä¹Ÿéœ€è¦ä¸ä»£ç çš„å¯ç»´æŠ¤æ€§ä¹‹é—´è¿›è¡Œæƒè¡¡</li>
<li><strong>å‡å°‘æ•°æ®åº“è®¿é—®</strong>ï¼šå¯ä»¥é€šè¿‡åˆå¹¶æŸ¥è¯¢ã€ä½¿ç”¨ç¼“å­˜ã€å¢åŠ å‰ç½®æ¡ä»¶åˆ¤æ–­æˆ–æ‰¹é‡æ“ä½œç­‰æ–¹å¼æ¥å‡å°‘æ•°æ®åº“è®¿é—®</li>
<li><strong>å‡å°‘æ‰‡å‡ºæ¯”</strong>ï¼šæ§åˆ¶æ‰‡å‡ºæ¯”çš„ç›®çš„æ˜¯é™åˆ¶ç³»ç»Ÿå‘å…¶ä»–æœåŠ¡æˆ–ç»„ä»¶å‘å‡ºçš„è¯·æ±‚æ•°é‡ï¼Œä»è€Œé™ä½è´Ÿè½½ï¼Œå‡å°‘æ‰‡å‡ºæ¯”çš„æœ¬è´¨æ˜¯å‡å°‘æœåŠ¡é—´çš„ä¾èµ–å…³ç³»åŠä¾èµ–åº¦ï¼Œé¿å…å¤§è§„æ¨¡çš„å¹¶å‘è¯·æ±‚å¯¼è‡´æ€§èƒ½ä¸‹é™ï¼Œä¹Ÿå¯ä»¥é™ä½æ•…éšœä¼ æ’­çš„é£é™©ã€‚æ‰‡å‡ºæ¯”å¯ç”¨äºåº¦é‡ç³»ç»Ÿå‘å…¶ä»–æœåŠ¡æˆ–ç»„ä»¶å‘é€çš„è¯·æ±‚æ•°é‡ï¼Œä¸€èˆ¬æˆ‘ä»¬è¿˜å¯ä»¥è¿›ä¸€æ­¥ç»†åŒ–ä¸ºå•æ¬¡è¯·æ±‚ä¸­å¯¹æŒ‡å®šæœåŠ¡ã€ç¼“å­˜çš„æ‰‡å‡ºæ¯”ï¼Œæ¯”å¦‚ä¸‹å•è¯·æ±‚å¦‚æœä¼šæŸ¥è¯¢ä¸¤æ¬¡å•†å“ä¸­å¿ƒçš„æ¥å£ï¼Œé‚£ä¸‹å•è¯·æ±‚å¯¹å•†å“ä¸­å¿ƒçš„æ‰‡å‡ºæ¯”å°±æ˜¯2ï¼Œå¾ˆæ˜¾ç„¶ï¼Œè¿™ä¸ªæ•°å€¼è¶Šå¤§ï¼Œè¯·æ±‚è¢«æ”¾å¤§çš„å€æ•°ä¹Ÿå°±è¶Šé«˜</li>
<li><strong>I&#x2F;Oä¼˜åŒ–</strong>ï¼šå¯ä»¥é€šè¿‡å°†å¤šæ¬¡I&#x2F;Oæ“ä½œè¿›è¡Œåˆå¹¶æˆ–è€…ä½¿ç”¨å¼‚æ­¥I&#x2F;Oæ¥å‡å°‘ç£ç›˜å’Œç½‘ç»œI&#x2F;Oæ“ä½œï¼Œå¸¸è§çš„å¦‚å¼‚æ­¥æ‰“å°æ—¥å¿—ã€å°†å¤šæ¬¡æœåŠ¡è°ƒç”¨åˆå¹¶æˆä¸€æ¬¡è°ƒç”¨ç­‰ç­‰</li>
<li><strong>èµ„æºæ± åŒ–</strong>ï¼šä½¿ç”¨èµ„æºæ± æ¥ç®¡ç†æ•°æ®åº“è¿æ¥ã€å¼‚æ­¥çº¿ç¨‹ç­‰èµ„æºï¼Œä»¥å‡å°‘èµ„æºåˆ›å»ºå’Œé”€æ¯å¸¦æ¥çš„å¼€é”€</li>
<li><strong>é¢„çƒ­</strong>ï¼šé¢„çƒ­æ˜¯ä¸€ç§é€šè¿‡åœ¨åº”ç”¨ç¨‹åºæˆ–ç³»ç»Ÿå¼€å§‹å¤„ç†å®é™…å·¥ä½œè´Ÿè½½ä¹‹å‰æ‰§è¡Œä¸€ç³»åˆ—æ“ä½œæ¥æé«˜æ€§èƒ½çš„æ–¹æ³•ï¼Œè¿™äº›æ“ä½œæ—¨åœ¨å°†ç³»ç»Ÿçš„å„ç§ç»„ä»¶ï¼ˆå¦‚CPUã€å†…å­˜ã€ç¼“å­˜ç­‰ï¼‰ç½®äºä¸€ä¸ªç¨³å®šä¸”é«˜æ•ˆçš„çŠ¶æ€ï¼Œä»¥ä¾¿åœ¨å¤„ç†çœŸå®å·¥ä½œè´Ÿè½½æ—¶è·å¾—æ›´å¥½çš„æ€§èƒ½ï¼Œå¸¸è§çš„é¢„çƒ­æ“ä½œåŒ…æ‹¬ç¼“å­˜é¢„çƒ­ã€è¿æ¥æ± é¢„çƒ­ã€èµ„æºåŠ è½½é¢„çƒ­ã€æ•°æ®åŠ è½½é¢„çƒ­ç­‰</li>
</ul>
<p>è¿™é‡Œä»¥çˆ†æ¬¾æŠ¢è´­åœºæ™¯ä¸‹å•æ¥å£æ€§èƒ½ä¼˜åŒ–ä¸ºä¾‹ä»‹ç»ä¸‹ä¸Šè¿°ç­–ç•¥çš„å…·ä½“åº”ç”¨ï¼š</p>
<ul>
<li><strong>å®šåˆ¶ç‹¬ç«‹ä¸‹å•é“¾è·¯</strong>ï¼šçˆ†æ¬¾æŠ¢è´­åœºæ™¯æ˜¯ä¸€ç§ç‰¹æ®Šçš„äº‘è´­ä¸‹å•åœºæ™¯ï¼Œæœ‰æ›´å¤šçš„é™åˆ¶æ¡ä»¶ï¼ˆå¦‚ä¸èƒ½åŠ è´­ï¼‰ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è£å‰ªæ‰ä¸€äº›ä¸å¿…è¦çš„æµç¨‹æˆ–è€…ç‰ºç‰²éƒ¨åˆ†ä»£ç å¯è¯»æ€§ä»¥æ¢å–æ›´é«˜çš„æ€§èƒ½</li>
<li><strong>ä¸‹å•è¯·æ±‚å¹‚ç­‰æ€§æ§åˆ¶</strong>ï¼šåœ¨çˆ†æ¬¾æŠ¢è´­åœºæ™¯ï¼Œç”±äºå¹¶å‘é‡æ˜¾è‘—å¢åŠ ï¼Œå“åº”æ—¶é—´ä¹Ÿä¼šæœ‰æ‰€å¢åŠ ï¼Œç”šè‡³ä¼šå‡ºç°å“åº”è¶…æ—¶çš„æƒ…å†µï¼Œå¾ˆå®¹æ˜“å¼•å‘ç”¨æˆ·è¿ç»­ç‚¹å‡»ï¼Œé€šè¿‡å¼•å…¥å¹‚ç­‰æ€§æ§åˆ¶ï¼Œä¸ä»…å¯ä»¥é™ä½èµ„æºå ç”¨æ—¶é—´ï¼Œä¹Ÿå¯ä»¥å‡å°‘ä¸å¿…è¦çš„åº“å­˜é”å®šã€æ‰©å¤§é”€å”®æœºä¼š</li>
<li><strong>æ§åˆ¶äº‹åŠ¡çš„ç²’åº¦</strong>ï¼šé€šè¿‡ç¼–ç¨‹å¼äº‹åŠ¡ï¼ˆTransactionTemplateï¼‰æ›¿ä»£å£°æ˜å¼äº‹åŠ¡ï¼ˆ@Transactionalï¼‰ï¼Œå¯ä»¥æ›´çµæ´»åœ°æ§åˆ¶äº‹åŠ¡çš„èŒƒå›´ï¼Œåœ¨äº‹åŠ¡ä¸­åªä¿ç•™å¿…è¦çš„æ“ä½œï¼Œé¿å…å¤§äº‹åŠ¡ï¼Œè¿™å°†æ˜¾è‘—å‡å°‘äº‹åŠ¡çš„é”å®šæ—¶é—´å’Œèµ„æºå ç”¨ï¼Œå¸¦æ¥æ€§èƒ½æå‡</li>
<li><strong>ä¼˜åŒ–åˆ†å¸ƒå¼äº‹åŠ¡</strong>ï¼šä¸ºäº†ä¿è¯ä¸‹å•é˜¶æ®µè®¢å•ã€åº“å­˜ã€èµ„äº§ã€æƒç›Šï¼ˆå¦‚é™è´­ï¼‰ç­‰æ•°æ®çš„ä¸€è‡´æ€§ï¼Œæˆ‘ä»¬å¼•å…¥äº†TCCï¼ˆTry-Confirm&#x2F;Cancelï¼‰æ¨¡å¼çš„åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œä½†åˆ†å¸ƒå¼äº‹åŠ¡å¾ˆå®¹æ˜“å¯¹æ€§èƒ½äº§ç”Ÿè´Ÿé¢å½±å“ï¼Œéœ€è¦è¿›è¡Œè°ƒä¼˜ï¼ˆå¦‚ä¸‹å›¾æ‰€ç¤ºï¼‰ï¼š</li>
</ul>
<div style="text-align: center;">
  <img src="../img/netease/359d21b4df4839e2458c4db4b2546c0.png" alt="åˆ†å¸ƒå¼äº‹åŠ¡">
</div>

<ul>
<li><strong>å¹‚ç­‰æ€§æ§åˆ¶</strong>ï¼šä¸»äº‹åŠ¡åœ¨è°ƒç”¨TCCæ–¹æ³•æ—¶å¯èƒ½å› ç½‘ç»œæ‹¥å µç­‰åŸå› è¶…æ—¶ï¼Œé€šå¸¸æˆ‘ä»¬ä¼šé€šè¿‡å¼•å…¥è¶…æ—¶ä¸é‡è¯•ç­–ç•¥æ¥æå‡æˆåŠŸç‡ï¼Œè¿™å°±è¦æ±‚åˆ†æ”¯äº‹åŠ¡éœ€è¦ä¿è¯TCCæ–¹æ³•çš„å¹‚ç­‰æ€§ï¼Œé¿å…é‡å¤æ›´æ–°ã€‚å¦å¤–éœ€è¦ç‰¹åˆ«é‡è§†ä¼˜åŒ–TCCæ–¹æ³•çš„æ‰§è¡Œæ€§èƒ½ï¼Œç¡®ä¿åœ¨é¢„è®¾çš„å‹åŠ›ä¸‹ï¼Œæœ‰è¶³å¤Ÿå¤§æ¯”ä¾‹çš„è¯·æ±‚RTä½äºè¶…æ—¶æ—¶é—´</li>
<li><strong>å…è®¸ç©ºå›æ»š</strong>ï¼šåœ¨å®é™…çš„ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå¯èƒ½å› ç½‘ç»œæ‹¥å µç­‰åŸå› é€ æˆCancelæ“ä½œå…ˆäºTryæ“ä½œåˆ°è¾¾ï¼Œå› æ­¤ï¼Œå…è®¸åˆ†æ”¯äº‹åŠ¡ç©ºå›æ»šå¯ä»¥é¿å…é‡è¯•ï¼Œä»è€Œå¸¦æ¥æ›´å¥½çš„æ€§èƒ½è¡¨ç°ï¼Œå³å…è®¸Cancelæ“ä½œåœ¨æ‰¾ä¸åˆ°å¾…å›æ»šçš„ä¸šåŠ¡ä¸»é”®çš„æƒ…å†µä¸‹ä¹Ÿè¿”å›æˆåŠŸå¹¶å°†è¯¥ä¸šåŠ¡ä¸»é”®è®°å½•ä¸‹æ¥ï¼ŒåŒæ—¶ä¹Ÿè¦ç¡®ä¿ç©ºå›æ»šä¸ä¼šäº§ç”Ÿå…¶ä»–é”™è¯¯æ•ˆæœ</li>
<li><strong>é˜²æ‚¬æŒ‚</strong>ï¼šå¦‚æœCancelæ“ä½œå…ˆäºTryæ“ä½œåˆ°è¾¾ä¸”Cancelæ“ä½œè¿”å›æˆåŠŸçš„æƒ…å†µä¸‹ï¼ˆå³å…è®¸ç©ºå›æ»šï¼‰ï¼Œåœ¨æ‰§è¡ŒTryæ“ä½œæ—¶ï¼Œæœ‰å¿…è¦æ£€æŸ¥ç©ºå›æ»šè®°å½•ä¸­æ˜¯å¦å­˜åœ¨è¯¥ä¸šåŠ¡ä¸»é”®ï¼Œå­˜åœ¨åˆ™ç›´æ¥æ‹’ç»æ‰§è¡Œï¼Œå¦åˆ™ï¼ˆæ²¡æœ‰æ‹’ç»æ‰§è¡Œçš„è¯ï¼‰ä¼šé€ æˆè¯¥åˆ†æ”¯äº‹åŠ¡æ‚¬æŒ‚</li>
<li><strong>å‡å°‘æ— æ•ˆå›æ»š</strong>ï¼šTryæ“ä½œå¯èƒ½é‡åˆ°é™æµã€æ ¡éªŒä¸é€šè¿‡ç­‰æƒ…å†µé€ æˆç›´æ¥è¿”å›ï¼Œæ²¡æœ‰æ‰§è¡Œå®é™…çš„ä¸šåŠ¡æ“ä½œï¼Œåœ¨è¿™ç±»åœºæ™¯ï¼Œå¯ä»¥åœ¨å›æ»šé˜¶æ®µä¸è°ƒç”¨åˆ†æ”¯äº‹åŠ¡çš„Cancelæ“ä½œï¼Œä»è€Œå¸¦æ¥æ›´å¥½çš„æ€§èƒ½è¡¨ç°</li>
</ul>
<p>é™è´­ä¼˜åŒ–ï¼šä¸ºäº†å¢åŠ å…¬å¹³æ€§ï¼Œçˆ†æ¬¾å•†å“ä¸€èˆ¬ä¼šè¿›è¡Œé™è´­ï¼Œå³é™åˆ¶åŒä¸€ä¸ªç”¨æˆ·åœ¨æŸä¸ªç‰¹å®šå‘¨æœŸå†…æˆ–è€…æŸä¸ªç‰¹å®šæ´»åŠ¨ä¸­è´­ä¹°åŒä¸€ä¸ªå•†å“çš„æ•°é‡ä¸Šé™ï¼Œé€šå¸¸æˆ‘ä»¬éœ€è¦å€ŸåŠ©åŠ é”ç­‰å¹¶å‘æ§åˆ¶æ‰‹æ®µæ¥ç¡®ä¿é™è´­æ•°æ®çš„ä¸€è‡´æ€§ï¼Œä¸åŒçš„å®ç°æ–¹å¼å¯¹äºæœ€ç»ˆçš„æ€§èƒ½è¡¨ç°æœ‰è¾ƒå¤§çš„å½±å“ï¼Œå¯ä»¥è¿›è¡Œå¦‚ä¸‹ä¼˜åŒ–ï¼š</p>
<ul>
<li><strong>åˆ†å¸ƒå¼é”</strong>ï¼šé€šè¿‡åœ¨ä¸‹å•å‚æ•°æ ¡éªŒé˜¶æ®µå¢åŠ åˆ†å¸ƒå¼é”ï¼Œç¡®ä¿åŒä¸€ä¸ªç”¨æˆ·æ— æ³•è¿ç»­ä¸‹å•è´­ä¹°åŒä¸€ä¸ªå•†å“ï¼Œç»“åˆä¸Šæ–‡æåˆ°çš„ä¸‹å•è¯·æ±‚çš„å¹‚ç­‰æ€§æ§åˆ¶ï¼Œå¯ä»¥æœç»åŒä¸€ä¸ªè´¦å·é€šè¿‡å¤šå¼€æˆ–è€…è¿ç»­ç‚¹å‡»ç­‰æ–¹å¼å¢å¤§æŠ¢è´­æˆåŠŸç‡ï¼›åŒæ—¶ï¼Œé‡‡ç”¨åœ¨å‚æ•°æ ¡éªŒé˜¶æ®µåŠ åˆ†å¸ƒå¼é”ç›¸æ¯”äºé™è´­æ£€æŸ¥é˜¶æ®µåŠ é”ï¼ˆæ— è®ºæ˜¯æ•°æ®åº“é”è¿˜æ˜¯åˆ†å¸ƒå¼é”ï¼‰æ¶ˆè€—çš„èµ„æºæ›´å°‘ï¼Œæ€§èƒ½è¡¨ç°æ›´ä¼˜</li>
<li><strong>ç¼“å­˜</strong>ï¼šé‡‡ç”¨åˆ†å¸ƒå¼ç¼“å­˜ï¼ˆRedisï¼‰è®°å½•é™è´­æƒç›Šæ¶ˆè€—æƒ…å†µï¼Œé™è´­æ£€æŸ¥é€šè¿‡ç¼“å­˜æ›¿ä»£æ•°æ®åº“æŸ¥è¯¢</li>
<li><strong>å‰ç½®æ ¡éªŒ</strong>ï¼šç»“åˆä¸šåŠ¡æµç¨‹ï¼Œå‰ç½®æ‹¦æˆªä¸æ»¡è¶³é™è´­è¦æ±‚çš„è¯·æ±‚ï¼Œæ¯”å¦‚åœ¨å•†è¯¦ã€ç»„å•ç­‰é˜¶æ®µè¿›è¡Œé™è´­æ£€æŸ¥ï¼Œç›¸æ¯”äºä¸‹å•é˜¶æ®µæ£€æŸ¥æ¶ˆè€—çš„èµ„æºæ›´å°‘ï¼Œæ€§èƒ½è¡¨ç°æ›´ä¼˜</li>
<li><strong>è®¢å•æ‰¹é‡æ“ä½œ</strong>ï¼šã€ŒièŒ…å°ã€é‡‡ç”¨çš„æ˜¯å…¸å‹çš„<strong>ä¸»å­è®¢å•ç»“æ„</strong>ï¼Œä¸»è®¢å•åˆå«æ”¯ä»˜è®¢å•ï¼Œç”±1~Nä¸ªå­è®¢å•æ„æˆï¼Œå­è®¢å•ä¸€èˆ¬é‡‡ç”¨åº—é“ºï¼ˆé—¨åº—ï¼‰ç²’åº¦ï¼Œè¿™ç§æ–¹å¼å¯ä»¥æ¯”è¾ƒå®¹æ˜“åœ°å®ç°åˆå¹¶æ”¯ä»˜ä»¥åŠåº—é“ºï¼ˆé—¨åº—ï¼‰ç²’åº¦çš„å®æ—¶åˆ†è´¦ã€‚åœ¨ä¸‹å•é˜¶æ®µï¼Œå‡è®¾ç”¨æˆ·åŒæ—¶æ”¯ä»˜Nä¸ªåº—é“ºï¼ˆé—¨åº—ï¼‰çš„å•†å“ï¼Œä»…è®¢å•è½åº“è¿™ä¸ªç¯èŠ‚å°±éœ€è¦1+Næ¬¡DBæ“ä½œï¼ˆä¸å«è®¢å•å•†å“å’Œè®¢å•åœ°å€è½åº“ï¼‰ï¼Œé€šè¿‡ä¼˜åŒ–ä¸šåŠ¡æµç¨‹ï¼Œåªéœ€è¦1æ¬¡DBæ“ä½œå°±å¯ä»¥è¾¾åˆ°ç›¸åŒçš„æ•ˆæœï¼Œä»è€Œå¸¦æ¥æ€§èƒ½æå‡</li>
</ul>
<div style="text-align: center;">
  <img src="../img/netease/5c9d8e8cd155e70d6184eabe1ca01ba.png" alt="è®¢å•æ‰¹é‡æ“ä½œ">
</div>

<p>ç”±äºçˆ†æ¬¾æŠ¢è´­éƒ½æ˜¯å•å•†å“ç«‹å³è´­ä¹°ï¼Œå› æ­¤ï¼Œåˆå¹¶æ’å…¥å„ä¸ªå­è®¢å•çš„è®¢å•å•†å“åŠè®¢å•åœ°å€ä¸ä¼šæå‡æ€§èƒ½ï¼Œåè€Œä¼šå¢åŠ ä¸å¿…è¦çš„ä»£ç å¤æ‚åº¦</p>
<ul>
<li><strong>è¿æ¥æ± åŠé¢„çƒ­</strong>ï¼šé€šè¿‡è¿æ¥æ± æ¥ç®¡ç†æ•°æ®åº“åŠRedisè¿æ¥ï¼Œæ ¹æ®åº”ç”¨å¹¶å‘åº¦åŠDBè´Ÿè½½æƒ…å†µåˆ†æè¿æ¥æ± å¤§å°å¹¶è®¾ç½®åˆç†çš„åˆå§‹åŒ–æ•°é‡ï¼Œå¯¹æ€§èƒ½æ”¹å–„æœ‰è¾ƒå¤§å¸®åŠ©ï¼Œåœ¨æ­¤åŸºç¡€ä¸Šï¼Œé¢„çƒ­ä¹Ÿå¯ä»¥è®©ç³»ç»Ÿå¯ä»¥æ›´å¿«åœ°è¿›å…¥åˆ°æœ€ä½³çŠ¶æ€ï¼Œæ¯”å¦‚æå‰å°†å•†å“ä¿¡æ¯åŠ è½½åˆ°æœ¬åœ°ç¼“å­˜å’Œåˆ†å¸ƒå¼ç¼“å­˜ã€åˆ©ç”¨å°±ç»ªæ¢é’ˆï¼ˆå¦‚SpringBoot Actuatoræä¾›çš„readinessï¼‰æå‰é¢„çƒ­æ¯ä¸ªæœåŠ¡å®ä¾‹ï¼ˆå°¤å…¶æ˜¯å…³é”®é“¾è·¯ä¸Šçš„å®ä¾‹ï¼‰ä»¥åŠç³»ç»Ÿå‘å¸ƒåæˆ–è€…å…³é”®äº‹ä»¶åˆ°æ¥ä¹‹å‰å¯åŠ¨å°æµé‡é¢„çƒ­ç­‰ç­‰</li>
</ul>
<p>é€šè¿‡é‡‡ç”¨ä¸Šè¿°ä¼˜åŒ–ç­–ç•¥ï¼Œæˆ‘ä»¬åœ¨ä¸å¢åŠ æœåŠ¡å™¨çš„å‰æä¸‹ï¼Œçˆ†æ¬¾æŠ¢è´­åœºæ™¯çš„æ•´ä½“ååé‡è¶…è¿‡æ™®é€šäº‘è´­åœºæ™¯çš„ä¸¤å€ä»¥ä¸Šï¼Œç›¸æ¯”ä¸æ—©æœŸäº¤ä»˜ç‰ˆæœ¬æ›´æ˜¯æå‡äº†ä¸‰å€ä»¥ä¸Šã€‚</p>
<h2 id="2-2-2-æ•°æ®åº“ä¼˜åŒ–"><a href="#2-2-2-æ•°æ®åº“ä¼˜åŒ–" class="headerlink" title="2.2.2 æ•°æ®åº“ä¼˜åŒ–"></a>2.2.2 æ•°æ®åº“ä¼˜åŒ–</h2><p>æ•°æ®åº“å¯¹ç³»ç»Ÿæ€§èƒ½ä¹Ÿæœ‰ç€éå¸¸é‡è¦çš„å½±å“ï¼Œå¸¸è§çš„æ•°æ®åº“ä¼˜åŒ–ç­–ç•¥åŒ…æ‹¬ï¼š</p>
<ul>
<li><strong>æ•°æ®æ¨¡å‹è®¾è®¡ä¼˜åŒ–</strong>ï¼šæ•°æ®æ¨¡å‹è®¾è®¡æ˜¯æŠ€æœ¯å®ç°æ–¹æ¡ˆçš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œå®ƒä¸ä»…ç›´æ¥å½±å“æ•°æ®åº“çš„æ€§èƒ½ï¼Œä¹Ÿä¼šå½±å“æ•°æ®åº“çš„å¯æ‰©å±•æ€§å’Œå¯ç»´æŠ¤æ€§ï¼Œé€šå¸¸éœ€è¦è€ƒè™‘ä»¥ä¸‹ä¸¤ä¸ªæ–¹é¢ï¼š</li>
<li><strong>é€‰æ‹©åˆé€‚çš„è®¾è®¡èŒƒå¼</strong></li>
<li><strong>è§„èŒƒåŒ–</strong>ï¼ˆNormalizationï¼‰å¯ä»¥å‡å°‘æ•°æ®å†—ä½™ï¼Œä½†å¯èƒ½éœ€è¦æ›´å¤šçš„è”è¡¨æ“ä½œ</li>
<li><strong>åè§„èŒƒåŒ–</strong>ï¼ˆDenormalizationï¼‰å¯ä»¥é€šè¿‡å¢åŠ å†—ä½™åˆ—ã€æ´¾ç”Ÿåˆ—ã€åˆå¹¶è¡¨ç­‰ç­–ç•¥æœ€å¤§ç¨‹åº¦é¿å…è”è¡¨æ“ä½œæˆ–å‡½æ•°è®¡ç®—ï¼Œæé«˜æŸ¥è¯¢æ€§èƒ½ï¼Œä½†ä¼šå¢åŠ æ•°æ®å†—ä½™ï¼Œæ¯”è¾ƒå…¸å‹çš„åè§„èŒƒåŒ–è®¾è®¡æ˜¯è®¢å•è¡¨ï¼Œé€šè¿‡é¢å¤–å†—ä½™é—¨åº—ã€ç»é”€å•†ç­‰å¸¸ç”¨ä½†å˜æ›´é¢‘ç‡å¾ˆä½çš„ä¿¡æ¯ï¼Œå¯ä»¥æå‡è®¢å•æŸ¥è¯¢çš„æ•ˆç‡</li>
<li><strong>é€‚å½“çš„æ•°æ®ç±»å‹å’Œé•¿åº¦</strong>ï¼šæ ¹æ®ä¸šåŠ¡éœ€æ±‚é€‰æ‹©é€‚å½“çš„ç±»å‹å’Œé•¿åº¦æ¥å­˜å‚¨æ•°æ®å¯ä»¥å‡å°‘å­˜å‚¨ç©ºé—´ï¼Œä¹Ÿå¯ä»¥æå‡æŸ¥è¯¢æ€§èƒ½ï¼Œå¦‚è°¨æ…ä½¿ç”¨å¤§æ•°æ®ç±»å‹ï¼ˆTEXT,CLOB,BLOBç­‰ï¼‰ï¼Œä½¿ç”¨æ•´æ•°è€Œä¸æ˜¯å­—ç¬¦ä¸²å­˜å‚¨å¸ƒå°”å€¼ï¼Œé¿å…å­˜å‚¨nullå€¼ç­‰</li>
<li><strong>ç´¢å¼•ä¼˜åŒ–</strong>ï¼š æ•°æ®åº“ç´¢å¼•å¯ä»¥æ˜¾è‘—æå‡æŸ¥è¯¢æ€§èƒ½ï¼Œéœ€è¦åˆç†åˆ›å»ºå¹¶ç»´æŠ¤ç´¢å¼•ï¼ŒåŒ…æ‹¬è€ƒè™‘å“ªäº›åˆ—ä»¥æ€æ ·çš„æ¬¡åºç»„åˆç´¢å¼•ã€é€‰æ‹©é€‚å½“çš„ç´¢å¼•ç±»å‹ä»¥åŠå®šæœŸé‡å»ºæˆ–é‡æ–°ç»„ç»‡ç´¢å¼•ç­‰ï¼›åŒæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦äº†è§£ç´¢å¼•åŒ¹é…çš„åŸºæœ¬åŸåˆ™ï¼Œå˜æ›´å‰å¯¹SQLä¸ç´¢å¼•è¿›è¡Œå®¡æŸ¥ï¼Œé¿å…æœ€ç»ˆä½¿ç”¨çš„ç´¢å¼•ä¸ç¬¦åˆé¢„æœŸï¼ˆå¯ä»¥å€ŸåŠ©æ…¢æŸ¥è¯¢æ—¥å¿—ã€explainç­‰å·¥å…·è¿›è¡Œåˆ†æè°ƒä¼˜ï¼‰ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç´¢å¼•ä¹Ÿå¹¶ä¸æ˜¯è¶Šå¤šè¶Šå¥½ï¼Œå®ƒä¼šå ç”¨é¢å¤–çš„ç©ºé—´ï¼Œä¼šå½±å“æ›´æ–°æ“ä½œçš„æ€§èƒ½</li>
<li><strong>æŸ¥è¯¢ä¼˜åŒ–</strong>ï¼šç¼–å†™é«˜æ•ˆçš„SQLæŸ¥è¯¢è¯­å¥ï¼ŒåŒ…æ‹¬å°½å¯èƒ½é¿å…ä½¿ç”¨SELECT *ã€é¿å…å…¨è¡¨æ‰«æã€è°¨æ…ä½¿ç”¨è”è¡¨æŸ¥è¯¢å’Œå­æŸ¥è¯¢ï¼ˆæˆ‘ä»¬åœ¨ä¸šåŠ¡ä»£ç ä¸­ç¦æ­¢ä½¿ç”¨ï¼‰ã€é™åˆ¶æŸ¥è¯¢è¿”å›çš„æ•°æ®é‡ç­‰</li>
<li><strong>ç¼“å­˜</strong>ï¼šé€‰æ‹©åˆé€‚çš„ç¼“å­˜ç»„ä»¶å’Œç¼“å­˜ç­–ç•¥æ¥å­˜å‚¨é¢‘ç¹è®¿é—®çš„æ•°æ®ï¼ˆå‚è§ã€Œæ— å¤„ä¸åœ¨çš„ç¼“å­˜ã€ç« èŠ‚ï¼‰ä»¥å‡å°‘å¯¹æ•°æ®åº“çš„è®¿é—®ï¼Œä»è€Œé™ä½æ•°æ®åº“è´Ÿè½½ï¼Œæå‡å“åº”é€Ÿåº¦</li>
<li><strong>è¯»å†™åˆ†ç¦»</strong>ï¼šåœ¨ä¸€äº›æ•°æ®åº“è´Ÿè½½æ¯”è¾ƒé«˜çš„ä¸šåŠ¡ä¸­ï¼Œå¯ä»¥å°†è¯»å–æ“ä½œä¸å†™å…¥æ“ä½œè¿›è¡Œåˆ†ç¦»ï¼Œåˆ†åˆ«è·¯ç”±åˆ°ä¸åŒçš„æ•°æ®åº“æœåŠ¡å™¨æˆ–æ•°æ®åº“å‰¯æœ¬ï¼Œä»è€Œé™ä½ä¸»åº“ï¼ˆå†™åº“ï¼‰çš„è´Ÿè½½ï¼Œæå‡å“åº”é€Ÿåº¦</li>
<li><strong>åˆ†åº“åˆ†è¡¨</strong>ï¼šå¯¹äºæ•°æ®è§„æ¨¡éå¸¸å¤§çš„æ•°æ®åº“ï¼Œå¯ä»¥å€ŸåŠ©åˆ†åº“åˆ†è¡¨æŠ€æœ¯å‡å°‘å•åº“çš„è´Ÿè½½ï¼Œä»è€Œæå‡æ•°æ®åº“çš„æ€§èƒ½ã€å¯ä¼¸ç¼©æ€§å’Œå®¹é”™æ€§</li>
</ul>
<p>è¿™é‡Œä»¥çˆ†æ¬¾æŠ¢è´­åœºæ™¯åº“å­˜æœåŠ¡çš„æ€§èƒ½ä¼˜åŒ–ä¸ºä¾‹ä»‹ç»ä¸‹è¿™äº›ç­–ç•¥çš„å…·ä½“åº”ç”¨ï¼š</p>
<ul>
<li><strong>æ•°æ®æ¨¡å‹è®¾è®¡</strong>ï¼šç»“åˆå•†åŸçš„ä¸šåŠ¡åœºæ™¯ï¼Œå­˜åœ¨æ•°åƒå®¶åº—é“ºï¼ˆé—¨åº—ï¼‰æŠ•æ”¾åŒä¸€ä¸ªå•†å“çš„æƒ…å†µï¼ˆå³å¤šé—¨åº—å…±ç”¨åŒä¸€ä¸ªå•†å“ï¼‰ï¼Œä¹Ÿå­˜åœ¨å•†å“ç‹¬å®¶é”€å”®çš„æƒ…å†µï¼ˆå³å•†å“åªåœ¨åŒä¸€å®¶åº—é“ºé”€å”®ï¼‰ï¼Œæ¯å®¶åº—é“ºï¼ˆé—¨åº—ï¼‰çš„é”€å”®åº“å­˜éœ€è¦å•ç‹¬ç®¡ç†ï¼ŒåŸºäºæ­¤ï¼Œæˆ‘ä»¬ä¸ºåº“å­˜æœåŠ¡è®¾è®¡äº†ä¸¤å¼ æ ¸å¿ƒè¡¨ï¼Œå³åº“å­˜è¡¨å’Œåº“å­˜æµæ°´è¡¨ï¼ˆå¦‚å›¾æ‰€ç¤ºï¼‰</li>
<li><strong>åè§„èŒƒåŒ–</strong>ï¼šåº“å­˜è¡¨æ–°å»ºå”¯ä¸€ç´¢å¼•(ShopId, SkuId)ï¼Œåº“å­˜æµæ°´è¡¨åˆ™å†—ä½™å­—æ®µShopIdå’ŒSkuIdï¼Œæ–°å»ºå”¯ä¸€ç´¢å¼•(ShopId, SkuId, OrderId, Type)</li>
</ul>
<div style="text-align: center;">
  <img src="../img/netease/8b5a051f0d633dad5fef4a41aa9d6f3.png" alt="åº“å­˜ç›¸å…³çš„æŸ¥è¯¢">
</div>

<ul>
<li><strong>é€‰æ‹©çš„æ•°æ®ç±»å‹</strong>ï¼šä»¥åº“å­˜æµæ°´è¡¨ä¸­çš„Typeå­—æ®µä¸ºä¾‹ï¼Œç”¨æ¥è¡¨ç¤ºåº“å­˜æ‰£å‡ã€å›æ»šã€æŠ•æ”¾ã€å›æ”¶ç­‰çŠ¶æ€ï¼Œæ˜¾ç„¶ç”¨tinyintå°±è¶³å¤Ÿè¿›è¡Œå­˜å‚¨äº†ï¼Œç›¸æ¯”äºsmallintã€intç±»å‹å¯ä»¥èŠ‚çœå­˜å‚¨ç©ºé—´</li>
<li><strong>æ•°æ®åº“é€‰å‹</strong>ï¼šåº“å­˜æµæ°´è¡¨é¢„è®¡æ¯å¹´æ–°äº§ç”Ÿçš„æ•°æ®åœ¨åƒä¸‡çº§ä¸”ä¼šæŒç»­å¢é•¿ï¼Œè€Œåº“å­˜æœåŠ¡åˆæ˜¯äº¤æ˜“é“¾è·¯çš„æ ¸å¿ƒä¾èµ–ï¼Œè¯»å†™æ“ä½œé¢‘ç¹ä¸”æœ‰æ˜æ˜¾ä¸šåŠ¡å³°å€¼ï¼Œå¦‚æœç”¨å•ä¸ªMySQLå®ä¾‹å»æ”¯æŒï¼Œå­˜å‚¨å’Œæ€§èƒ½ç“¶é¢ˆè¾ƒä¸ºæ˜æ˜¾ï¼Œå› æ­¤æˆ‘ä»¬é‡‡ç”¨äº†åˆ†åº“åˆ†è¡¨çš„æŠ€æœ¯ï¼ˆ<strong>ç½‘æ˜“è‡ªç ”çš„DDB</strong>ï¼‰</li>
<li><strong>è´Ÿè½½å‡è¡¡</strong>ï¼šå‡è¡¡å­—æ®µï¼ˆæ‹†åˆ†é”®ï¼‰å’Œå‡è¡¡ç­–ç•¥çš„é€‰æ‹©å¯¹äºæ€§èƒ½æœ‰éå¸¸æ˜æ˜¾çš„å½±å“ï¼Œéœ€è¦æ ¼å¤–é‡è§†ï¼Œåœ¨åº“å­˜æœåŠ¡è¿™ä¸ªä¾‹å­ä¸­ï¼Œåº“å­˜è¡¨å’Œåº“å­˜æµæ°´è¡¨æˆ‘ä»¬éƒ½ä½¿ç”¨ShopIdä½œä¸ºå‡è¡¡å­—æ®µä¸”ä½¿ç”¨ç›¸åŒçš„å‡è¡¡ç­–ç•¥ï¼Œä¸»è¦æœ‰ä»¥ä¸‹å‡ ç‚¹è€ƒè™‘ï¼š</li>
<li><strong>åº“å­˜ç›¸å…³çš„æŸ¥è¯¢</strong>ã€å˜æ›´éƒ½ä¼šæŒ‡å®šShopIdå’ŒSkuIdï¼Œåœ¨æœ‰æ•°åƒå®¶é—¨åº—æŠ•æ”¾åŒä¸€ä¸ªçˆ†æ¬¾å•†å“çš„æƒ…å†µä¸‹ï¼Œé‡‡ç”¨ShopIdä½œä¸ºå‡è¡¡å­—æ®µå¯ä»¥ä½¿æ•°æ®åˆ†å¸ƒå’Œæµé‡åˆ†å¸ƒæ›´ä¸ºå‡è¡¡ï¼Œåº“å­˜è¡¨é‡‡ç”¨ä¸åº“å­˜æµæ°´è¡¨ç›¸åŒçš„å‡è¡¡å­—æ®µå’Œå‡è¡¡ç­–ç•¥ï¼Œå¯ä»¥é¿å…XAäº‹åŠ¡ï¼Œå‡å°‘é”ç«äº‰</li>
<li><strong>åˆ†å¸ƒå¼ID</strong>ï¼šåŸºäºç¾å›¢çš„åˆ†å¸ƒå¼Idç®—æ³•Leafçš„ç»Ÿä¸€IDç”ŸæˆæœåŠ¡åœ¨é«˜å¹¶å‘åœºæ™¯å…·æœ‰ä½å»¶è¿Ÿã€é«˜ååã€é«˜å¯ç”¨ã€æ”¯æŒæ°´å¹³æ‰©å±•çš„ç‰¹ç‚¹ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥æ»¡è¶³ä¸šåŠ¡ä¸Šè‡ªå®šä¹‰çš„éœ€æ±‚ï¼Œæˆ‘ä»¬å°†å®ƒä½œä¸ºåˆ†å¸ƒå¼IDç”Ÿæˆçš„è§£å†³æ–¹æ¡ˆ</li>
<li><strong>å®šæœŸå½’æ¡£</strong>ï¼šæ•°æ®è§„æ¨¡çš„æŒç»­å¢é•¿ä¼šå¯¹æ€§èƒ½å¸¦æ¥è´Ÿé¢å½±å“ï¼Œå¯ä»¥è€ƒè™‘å°†æ—©æœŸçš„åº“å­˜æµæ°´ä¿¡æ¯è¿ç§»åˆ°å½’æ¡£è¡¨ï¼Œå¯ä»¥æå‡æ•°æ®åº“æ€§èƒ½</li>
</ul>
<h2 id="2-2-3-æ— å¤„ä¸åœ¨çš„ç¼“å­˜"><a href="#2-2-3-æ— å¤„ä¸åœ¨çš„ç¼“å­˜" class="headerlink" title="2.2.3 æ— å¤„ä¸åœ¨çš„ç¼“å­˜"></a>2.2.3 æ— å¤„ä¸åœ¨çš„ç¼“å­˜</h2><p>ç¼“å­˜æŠ€æœ¯æ˜¯ä¸€ç§è¢«å¹¿æ³›åº”ç”¨äºè®¡ç®—æœºç³»ç»Ÿå’Œåº”ç”¨ç¨‹åºä¸­çš„æ€§èƒ½ä¼˜åŒ–æ–¹æ³•ï¼Œå®ƒé€šè¿‡å°†æ•°æ®æˆ–è®¡ç®—ç»“æœæš‚æ—¶å­˜å‚¨åœ¨é«˜é€Ÿå­˜å‚¨ä»‹è´¨ä¸­ï¼Œä½¿ç³»ç»Ÿå¯ä»¥å¿«é€Ÿå“åº”è¯·æ±‚ã€è¿”å›æ•°æ®ï¼Œè€Œæ— éœ€æ¯æ¬¡éƒ½ä»æ…¢é€Ÿå­˜å‚¨ä»‹è´¨ï¼ˆå¦‚ç£ç›˜æˆ–è¿œç¨‹æœåŠ¡å™¨ç­‰ï¼‰ä¸­è·å–æ•°æ®ã€‚</p>
<p>åˆ©ç”¨å¥½ç¼“å­˜æŠ€æœ¯å¯ä»¥é™ä½èµ„æºè´Ÿè½½ï¼Œå‡å°‘å¯¹æ•°æ®åº“ã€ç½‘ç»œæˆ–åç«¯åº”ç”¨ç­‰å¤–éƒ¨èµ„æºçš„ä¾èµ–ï¼Œæ˜¾è‘—æå‡ç³»ç»Ÿçš„æ€§èƒ½ä¸å¯ç”¨æ€§ã€‚å¯ä»¥è¯´ï¼Œåœ¨æˆ‘ä»¬ç°æœ‰çš„ç³»ç»Ÿæ¶æ„ä¸­ï¼Œç¼“å­˜å‡ ä¹æ— å¤„ä¸åœ¨ï¼Œä»¥ç”³è´­åœºæ™¯ä¸ºä¾‹ï¼š</p>
<ul>
<li><strong>å®¢æˆ·ç«¯ï¼ˆAPPï¼‰</strong>ï¼šå®¢æˆ·ç«¯é€šè¿‡ç¼“å­˜é¢„ç½®åœ¨APPçš„æ•°æ®ã€ç¼“å­˜æ•°æ®è¯·æ±‚å“åº”ç­‰æ–¹å¼å‡å°‘å¯¹æœåŠ¡ç«¯çš„é¢‘ç¹è®¿é—®ï¼Œæä¾›æ›´ä¸ºæµç•…çš„ç”¨æˆ·ä½“éªŒï¼Œå°¤å…¶æœ‰åŠ©äºæ”¹å–„é¦–æ¬¡è®¿é—®æˆ–ä¸ç¨³å®šç½‘ç»œç¯å¢ƒä¸‹çš„è®¿é—®ä½“éªŒ</li>
<li><strong>é™æ€èµ„æºè®¿é—®åŠ é€Ÿ</strong>ï¼šé™æ€èµ„æºè®¿é—®åŠ é€Ÿçš„æ ¸å¿ƒåœ¨äºå°±è¿‘è®¿é—®ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡é™æ€åŒ–æŠ€æœ¯å°†åŠ¨æ€ç”Ÿæˆçš„å†…å®¹æˆ–ç½‘é¡µè½¬æ¢æˆé™æ€æ–‡ä»¶å¹¶å­˜å‚¨åˆ°CDNï¼ˆContent Delivery Networkï¼Œå†…å®¹åˆ†å‘ç½‘ç»œï¼‰æˆ–LBï¼ˆLoad Balancerï¼Œè´Ÿè½½å‡è¡¡ï¼‰ï¼Œåœ¨ç”¨æˆ·è¯·æ±‚æ—¶ç¦»ç”¨æˆ·æ›´è¿‘çš„èŠ‚ç‚¹å¯ä»¥ç›´æ¥æä¾›è¿™äº›é™æ€æ–‡ä»¶ï¼Œè€Œä¸å¿…å†æ¬¡è¯·æ±‚æœåŠ¡ç«¯è¿›è¡ŒåŠ¨æ€ç”Ÿæˆï¼Œå› æ­¤ï¼Œå¯ä»¥åŠ å¿«é¡µé¢åŠ è½½é€Ÿåº¦ã€æå‡ç½‘ç«™æˆ–åº”ç”¨ç¨‹åºçš„æ€§èƒ½ã€å‡å°‘æœåŠ¡å™¨è´Ÿè½½å¹¶é™ä½å¯¹æœåŠ¡å™¨èµ„æºçš„éœ€æ±‚ã€‚é€šå¸¸é™æ€åŒ–æŠ€æœ¯å¯ä»¥åº”ç”¨äºä¸ç»å¸¸å˜æ›´çš„å†…å®¹ã€è®¿é—®é‡è¾ƒå¤§çš„é¡µé¢ã€éœ€è¦SEOä¼˜åŒ–çš„é¡µé¢ã€é™æ€èµ„æºç­‰</li>
</ul>
<div style="text-align: center;">
  <img src="../img/netease/70d65dd9ee6014e47e150729c3cffbd.png" alt="CDN">
</div>

<ul>
<li><strong>æœåŠ¡ç«¯</strong>ï¼šå€ŸåŠ©ç¼“å­˜å¯ä»¥å‡å°‘å½“å‰åº”ç”¨å¯¹æ•°æ®åº“æˆ–è€…å…¶ä»–åç«¯æœåŠ¡çš„è®¿é—®ï¼Œé€šå¸¸æˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨åˆ†å¸ƒå¼ç¼“å­˜ï¼ˆå¦‚Redisï¼‰ï¼Œä½†åœ¨é«˜å¹¶å‘åœºæ™¯ï¼ˆå¦‚ç”³è´­åœºæ™¯ï¼‰ï¼Œä¸ºäº†å¢åŠ ç³»ç»Ÿæ•´ä½“çš„ååé‡ï¼Œä¹Ÿå¯ä»¥è€ƒè™‘å°†çƒ­ç‚¹æ•°æ®è®¾è®¡æˆäºŒçº§ç¼“å­˜ï¼Œå³åŒæ—¶ä½¿ç”¨æœ¬åœ°ç¼“å­˜ï¼ˆLocal Cacheï¼‰å’Œè¿œç«¯ç¼“å­˜ï¼ˆRemote Cacheï¼Œæˆ–è€…å«åˆ†å¸ƒå¼ç¼“å­˜ï¼‰</li>
</ul>
<div style="text-align: center;">
  <img src="../img/netease/0b822a67d09bd467efca771b70bcf64.png" alt="æœåŠ¡ç«¯">
</div>

<p>è™½ç„¶ç¼“å­˜æŠ€æœ¯å¯ä»¥æ˜¾è‘—æå‡æ€§èƒ½ï¼Œä½†åŒæ—¶ä¹Ÿæå¤§æå‡äº†ç³»ç»Ÿè®¾è®¡çš„å¤æ‚åº¦ï¼Œéœ€è¦è€ƒè™‘ç¼“å­˜çš„ä¸€è‡´æ€§ã€å¤±æ•ˆç­–ç•¥å’Œç¼“å­˜ç»´æŠ¤ç­‰å…³é”®é—®é¢˜ï¼Œå¦‚æœæ²¡æœ‰å¤„ç†å¥½ï¼Œå¾ˆå®¹æ˜“å‘ç”Ÿç¼“å­˜æ•°æ®ä¸ä¸€è‡´ã€ç¼“å­˜å¤§é¢ç§¯ç©¿é€ç”šè‡³å¼•å‘é›ªå´©ã€‚</p>
<p>ä»¥ç”³è´­åœºæ™¯ä½¿ç”¨çš„äºŒçº§ç¼“å­˜ä¸ºä¾‹ï¼Œæˆ‘ä»¬éœ€è¦å¤„ç†å¥½ä»¥ä¸‹é—®é¢˜ï¼š</p>
<ul>
<li><strong>æŠ€æœ¯é€‰å‹</strong>ï¼šæœ¬åœ°ç¼“å­˜é‡‡ç”¨Caffeineï¼Œè¿œç«¯ç¼“å­˜é‡‡ç”¨Redis Cluster</li>
<li><strong>Caffeine</strong>ï¼šç›¸æ¯”äºEhCacheã€Guavaç­‰ä¸»æµçš„ç¼“å­˜æ¡†æ¶ï¼Œæ‹¥æœ‰æ›´åŠ å¼ºå¤§çš„æ€§èƒ½è¡¨ç°ï¼Œä½¿ç”¨æ–¹å¼ä¸Šä¸Guavaç±»ä¼¼ï¼Œéå¸¸æ–¹ä¾¿</li>
<li><strong>Redis Cluster</strong>ï¼šRedis Clusteræ˜¯Redisæä¾›çš„åˆ†å¸ƒå¼ç¼“å­˜è§£å†³æ–¹æ¡ˆï¼Œä¹Ÿæ˜¯ç›®å‰ä¸»æµçš„è§£å†³æ–¹æ¡ˆï¼Œç›¸æ¯”äºProxyæ¨¡å¼æœ‰æ›´å¥½çš„æ€§èƒ½è¡¨ç°ï¼Œä½†æˆ‘ä»¬ä»ç„¶éœ€è¦é‡ç‚¹å…³æ³¨ç¡¬ä»¶ä»¥åŠæ··éƒ¨ç­‰å› ç´ å¯¹äºæ€§èƒ½åŠç¨³å®šæ€§çš„å½±å“</li>
<li><strong>é¿å…ç¼“å­˜ç©¿é€</strong>ï¼šä¼ ç»Ÿçš„å…³ç³»å‹æ•°æ®åº“å¯¹äºå¹¶å‘çš„æ‰¿å—èƒ½åŠ›éå¸¸è„†å¼±ï¼Œå¦‚æœæˆ‘ä»¬è®¾è®¡çš„ç¼“å­˜å‘½ä¸­ç‡ä¸é«˜å‡ºç°å¤§é¢ç§¯ç¼“å­˜ç©¿é€ï¼Œå¾ˆæœ‰å¯èƒ½å°†æ•°æ®åº“æ‹–å®ï¼Œå¦‚ä½•é¿å…ç¼“å­˜ç©¿é€æ˜¯æˆ‘ä»¬è®¾è®¡ç¼“å­˜æ—¶éœ€è¦é‡ç‚¹è€ƒè™‘çš„é—®é¢˜ï¼š</li>
<li>çƒ­ç‚¹ç¼“å­˜é‡‡ç”¨é¢„åŠ è½½ã€å®šæ—¶åˆ·æ–°åŠäº‹ä»¶è§¦å‘åˆ·æ–°ï¼ˆå¦‚æ•°æ®å˜æ›´ï¼‰çš„ç­–ç•¥ï¼Œä¿è¯100%å‘½ä¸­ç‡</li>
<li>å½“æŸ¥è¯¢çš„ç»“æœä¸ºç©ºæ—¶ï¼Œä»ç„¶å°†ç©ºç»“æœï¼ˆè‡ªå®šä¹‰NullObjectï¼‰å­˜å‚¨åˆ°ç¼“å­˜ä¸­ï¼ˆå¯ä»¥è®¾ç½®ä¸€ä¸ªè¾ƒçŸ­çš„è¿‡æœŸæ—¶é—´ï¼‰ï¼Œè¿™æ ·å¯ä»¥é˜²æ­¢æ¶æ„è¯·æ±‚çš„è¿ç»­æŸ¥è¯¢</li>
<li><strong>æ¶ˆæ¯é˜Ÿåˆ—ä¸å¼‚æ­¥åŒ–</strong><br>å¼‚æ­¥åŒ–çš„æ ¸å¿ƒæ€æƒ³æ˜¯å°†è€—æ—¶çš„æ“ä½œä»ä¸»æµç¨‹ä¸­åˆ†ç¦»å‡ºæ¥ï¼Œä»¥å…è®¸åº”ç”¨ç¨‹åºåœ¨ç­‰å¾…è¿™äº›æ“ä½œå®Œæˆçš„åŒæ—¶ç»§ç»­æ‰§è¡Œå…¶ä»–ä»»åŠ¡è€Œä¸ä¼šè¢«é˜»å¡ï¼Œä»è€Œæ”¹å–„ç³»ç»Ÿçš„å“åº”æ€§å’Œèµ„æºåˆ©ç”¨ç‡ã€‚</li>
</ul>
<p>å¼‚æ­¥åŒ–é€šå¸¸å¯ä»¥é€šè¿‡å¤šçº¿ç¨‹ã€å¤šè¿›ç¨‹ã€äº‹ä»¶é©±åŠ¨æˆ–å¼‚æ­¥ç¼–ç¨‹æ¨¡å‹ç­‰æ–¹å¼æ¥å®ç°ï¼Œæœ‰å¾ˆå¤šä¸­é—´ä»¶å’Œæ¡†æ¶å¯ä¾›æˆ‘ä»¬é€‰æ‹©ï¼Œæ¯”å¦‚é€šè¿‡<strong>Disruptor</strong>ã€<strong>BlockingQueue</strong>ç­‰æŠ€æœ¯å°†ä»»åŠ¡åˆ†è§£ä¸ºå¤šä¸ªçº¿ç¨‹æˆ–è¿›ç¨‹ä»¥å……åˆ†åˆ©ç”¨å¤šæ ¸å¤„ç†å™¨çš„æ€§èƒ½ï¼Œé€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMQï¼‰å®ç°å¼‚æ­¥æ¶ˆæ¯é€šä¿¡å’ŒæœåŠ¡è§£è€¦ï¼Œè¾¾åˆ°å¯¹æµé‡è¿›è¡Œå‰Šå³°å¡«è°·çš„æ•ˆæœï¼Œæå‡ç³»ç»Ÿçš„å¯æ‰©å±•æ€§å’Œæ€§èƒ½ã€‚</p>
<p>è¿™é‡Œé‡ç‚¹æä¸€ä¸‹æ¶ˆæ¯é˜Ÿåˆ—åœ¨ã€ŒièŒ…å°ã€çš„åº”ç”¨ï¼Œæ— è®ºåœ¨ç”³è´­åœºæ™¯è¿˜æ˜¯åœ¨çˆ†æ¬¾æŠ¢è´­åœºæ™¯ï¼ˆå¦‚ä¸‹å›¾æ‰€ç¤ºï¼‰ï¼Œæˆ‘ä»¬éƒ½éœ€è¦å€ŸåŠ©æ¶ˆæ¯é˜Ÿåˆ—å®ç°å¯¹æ´ªå³°æµé‡çš„å‰Šå³°å¡«è°·ï¼Œé¿å…æœåŠ¡å™¨è¿‡è½½æˆ–ç³»ç»Ÿå®•æœºï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥å®ç°æ•°æ®çš„æœ€ç»ˆä¸€è‡´æ€§ï¼Œç¡®ä¿æ¶ˆæ¯å¤„ç†çš„ç»“æœä¸ä¸šåŠ¡é€»è¾‘çš„ä¸€è‡´æ€§ã€‚</p>
<div style="text-align: center;">
  <img src="../img/netease/fff9e5cb5d1d4a7dbdbd4dc7f2b0fcc.png" alt="åœºæ™¯">
</div>

<p>ä¸éš¾å‘ç°ï¼Œè¿™å…¶ä¸­çš„å…³é”®æŒ‘æˆ˜åœ¨äºæ¶ˆæ¯é˜Ÿåˆ—æœ¬èº«çš„é«˜æ€§èƒ½ä»¥åŠåœ¨è®¾è®¡ä¸Šå¦‚ä½•ç¡®ä¿æ•°æ®çš„æœ€ç»ˆä¸€è‡´æ€§ã€‚</p>
<p>å…ˆæ¥çœ‹æ¶ˆæ¯é˜Ÿåˆ—çš„é€‰å‹ï¼Œåœ¨ä¸¥é€‰ï¼Œå› ä¸ºå†å²åŸå› åŒæ—¶å­˜åœ¨Kafkaã€Rabbitmqå’ŒRocketMQï¼Œä½†ç»¼åˆè€ƒè™‘æ€§èƒ½å’Œç¨³å®šæ€§è¡¨ç°ï¼ˆé«˜ååé‡ã€ä½å»¶è¿Ÿã€é«˜å¯ç”¨ï¼‰ã€åŠŸèƒ½ç‰¹æ€§ä¸°å¯Œåº¦ã€å·¥å…·æ”¯æŒä¸°å¯Œåº¦ã€ç¤¾åŒºæ´»è·ƒåº¦ç­‰ç»´åº¦ï¼ŒRocketMQæœ€ç»ˆæˆä¸ºä¸šåŠ¡ç³»ç»Ÿæ¶ˆæ¯é˜Ÿåˆ—çš„ä¸»æµé€‰å‹ï¼Œã€ŒièŒ…å°ã€åˆ™å»¶ç»­äº†è¿™ä¸€é€‰å‹ï¼Œé‡‡ç”¨ä¸»ä»éƒ¨ç½²æ¨¡å¼ï¼ˆ4.8ç‰ˆæœ¬ä¹‹å‰ä¸»ä»æ¨¡å¼ç›¸å¯¹Dledgeræ¨¡å¼åœ¨æ€§èƒ½ä¸Šæ›´æœ‰ä¼˜åŠ¿ï¼‰ã€‚</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸€ä¸‹å¦‚ä½•ç¡®ä¿æ•°æ®çš„æœ€ç»ˆä¸€è‡´æ€§ã€‚</p>
<p>å…ˆä»‹ç»å››ç§æˆ‘ä»¬å¹³æ—¶å¼€å‘è¿‡ç¨‹ä¸­æ¯”è¾ƒå®¹æ˜“å‡ºé”™çš„å®ç°æ–¹æ³•ï¼ˆå¦‚ä¸‹å›¾æ‰€ç¤ºï¼‰ï¼š</p>
<div style="text-align: center;">
  <img src="../img/netease/667be695bf6001287371101aa348f56.png" alt="å››ä¸ªæ–¹æ¡ˆ">
</div>

<ul>
<li><strong>æ–¹æ¡ˆä¸€</strong>ï¼šå…ˆæ‰§è¡Œæ•°æ®åº“æ“ä½œå†å‘é€æ¶ˆæ¯åˆ°MQï¼Œå¯èƒ½ä¼šå‡ºç°æ•°æ®åº“æ“ä½œæˆåŠŸï¼Œæ¶ˆæ¯å‘é€å¤±è´¥çš„æƒ…å†µ</li>
<li><strong>æ–¹æ¡ˆäºŒ</strong>ï¼šå…ˆå‘é€æ¶ˆæ¯åˆ°MQå†æ‰§è¡Œæ•°æ®åº“æ“ä½œï¼Œå¯èƒ½å‡ºç°æ¶ˆæ¯å‘é€æˆåŠŸï¼Œæ•°æ®åº“æ“ä½œå¤±è´¥çš„æƒ…å†µ</li>
<li><strong>æ–¹æ¡ˆä¸‰</strong>ï¼šåœ¨æ–¹æ¡ˆä¸€çš„åŸºç¡€ä¸Šï¼Œå¼€å¯æ•°æ®åº“äº‹åŠ¡ï¼Œè¿™ä¸ªæ–¹æ¡ˆåœ¨æ¶ˆæ¯å‘é€å¤±è´¥æŠ›å‡ºå¼‚å¸¸çš„æƒ…å†µä¸‹å¯ä»¥æ­£å¸¸å›æ»šï¼Œä½†æœ‰å¯èƒ½ä¼šå‡ºç°æ¶ˆæ¯å‘å¸ƒè‡³MQæˆåŠŸä½†è¯·æ±‚å¤±è´¥çš„æƒ…å†µï¼ˆå¦‚ç½‘ç»œæ‹¥å µç­‰åŸå› å“åº”è¶…æ—¶ï¼‰ï¼Œè¿™ç§æƒ…å†µä¹Ÿä¼šå¼•å‘äº‹åŠ¡æ•´ä½“å›æ»š</li>
<li><strong>æ–¹æ¡ˆå››</strong>ï¼šåœ¨æ–¹æ¡ˆäºŒçš„åŸºç¡€ä¸Šï¼Œå¼€å¯æ•°æ®åº“äº‹åŠ¡ï¼Œè¿™ä¸ªæ–¹æ¡ˆå¦‚æœæ•°æ®åº“æ“ä½œå¤±è´¥éœ€è¦å›æ»šï¼Œä½†MQå·²ç»å‘ç”ŸæˆåŠŸï¼Œæ²¡æœ‰åŠæ³•å›æ»š</li>
</ul>
<p>å¯è§ï¼Œä¸Šè¿°å››ä¸ªæ–¹æ¡ˆéƒ½æœ‰å¯èƒ½å‡ºç°æ•°æ®åº“æ“ä½œçŠ¶æ€å’Œæ¶ˆæ¯å‘é€çŠ¶æ€ä¸ä¸€è‡´çš„æƒ…å†µï¼Œå…¶ä¸­æ–¹æ¡ˆä¸€å¯èƒ½å‡ºç°æ•°æ®åº“æ“ä½œæˆåŠŸã€æ¶ˆæ¯å‘é€å¤±è´¥ï¼Œè¿™ç±»å¼‚å¸¸å¯ä»¥é€šè¿‡å¼•å…¥æ¶ˆæ¯è¡¥å¿æœºåˆ¶æ¥ç¡®ä¿æ¶ˆæ¯æœ€ç»ˆæˆåŠŸæŠ•é€’ï¼›æ–¹æ¡ˆäºŒã€ä¸‰ã€å››å¯èƒ½å‡ºç°æ¶ˆæ¯å‘é€æˆåŠŸã€æ•°æ®åº“æ“ä½œå¤±è´¥ï¼Œè¿™ç±»å¼‚å¸¸å¯ä»¥é€šè¿‡åœ¨æ¶ˆæ¯æ¶ˆè´¹ç«¯å¢åŠ æ¶ˆæ¯çŠ¶æ€ç¡®è®¤æˆ–è€…ç±»ä¼¼çš„æ ¡éªŒæœºåˆ¶ï¼Œç¡®ä¿è¢«æŠ•é€’å‡ºå»çš„æ¶ˆæ¯ä¸ä¼šå¯¹ä¸šåŠ¡äº§ç”Ÿè´Ÿé¢å½±å“ã€‚</p>
<p>æœ€åä»‹ç»ä¸¤ç§æ¯”è¾ƒå¸¸ç”¨çš„æ­£ç¡®å®ç°æ–¹æ³•ï¼š</p>
<ul>
<li><strong>æ–¹æ¡ˆäº”</strong>ï¼šåŸºäºRocketMQçš„äº‹åŠ¡æ¶ˆæ¯æ¥å®ç°</li>
</ul>
<div style="text-align: center;">
  <img src="../img/netease/4dbdec6fba905b4f5e19540f7607a53.png" alt="åŸºäºRocketMQçš„äº‹åŠ¡æ¶ˆæ¯æ¥å®ç°">
</div>

<ul>
<li>æ­¥éª¤ä¸€ï¼šæ¶ˆæ¯ç”Ÿäº§è€…å‘RocketMQå‘é€åŠäº‹åŠ¡æ¶ˆæ¯ï¼ˆ1. Prepareï¼‰ï¼ŒRocketMQç¡®è®¤æ¶ˆæ¯æ¥æ”¶çŠ¶æ€</li>
<li>æ­¥éª¤äºŒï¼šRocketMQæ¶ˆæ¯æ¥æ”¶æˆåŠŸï¼Œæ¶ˆæ¯ç”Ÿäº§è€…æ‰§è¡Œæœ¬åœ°äº‹åŠ¡çš„ä¸šåŠ¡é€»è¾‘</li>
<li>æ­¥éª¤ä¸‰ï¼šæ¶ˆæ¯ç”Ÿäº§è€…æ ¹æ®æœ¬åœ°äº‹åŠ¡çš„æ‰§è¡Œç»“æœå‘RocketMQæäº¤äºŒæ¬¡ç¡®è®¤ï¼ˆ2. Commit&#x2F;Rollbackï¼‰ï¼ŒRocketMQå°†æ­¥éª¤ä¸€ä¸­æ”¶åˆ°çš„åŠäº‹åŠ¡æ¶ˆæ¯æ ‡è®°ä¸ºå¯æŠ•é€’ï¼ˆæ¶ˆè´¹è€…å°±å¯ä»¥æ¶ˆè´¹åˆ°è¿™ä¸ªæ¶ˆæ¯ï¼‰<br>å¦‚æœå› æ–­ç½‘æˆ–è€…åº”ç”¨é‡å¯ç­‰åŸå› ï¼ŒäºŒæ¬¡ç¡®è®¤ï¼ˆ2. Commit&#x2F;Rollbackï¼‰æ²¡æœ‰æˆåŠŸæäº¤ï¼ŒRocketMQä¼šå®šæ—¶è§¦å‘äº‹åŠ¡æ¶ˆæ¯å›æŸ¥ï¼Œç¡®è®¤æ˜¯å¦éœ€è¦æŠ•é€’ï¼ˆå…œåº•ç­–ç•¥ï¼‰ï¼Œæ— éœ€æŠ•é€’çš„æ¶ˆæ¯ä¼šåœ¨è¿‡æœŸååˆ é™¤</li>
<li>æ­¥éª¤å››ï¼šRocketMQå°†æ¶ˆæ¯æŠ•é€’ç»™æ¶ˆæ¯æ¶ˆè´¹è€…ï¼ˆ3. æŠ•é€’æ¶ˆæ¯ï¼‰ï¼Œæ¶ˆæ¯æ¶ˆè´¹è€…é¦–å…ˆéœ€è¦è¿›è¡Œå¹‚ç­‰æ€§æ£€æŸ¥ï¼Œé€šè¿‡æ£€æŸ¥åæ‰§è¡Œæœ¬åœ°äº‹åŠ¡çš„ä¸šåŠ¡é€»è¾‘ï¼Œæœ€åè¿”å›æ‰§è¡Œç»“æœï¼ˆ4. Ackï¼‰</li>
<li><strong>æ–¹æ¡ˆå…­</strong>ï¼šåŸºäºæ¶ˆæ¯è¡¥å¿æœºåˆ¶æ¥å®ç°</li>
</ul>
<div style="text-align: center;">
  <img src="../img/netease/97457e7c70edc79df86acdf29075d74.png" alt="åŸºäºæ¶ˆæ¯è¡¥å¿æœºåˆ¶æ¥å®ç°">
</div>

<ul>
<li>æ­¥éª¤ä¸€ï¼šåœ¨åŒä¸€ä¸ªæœ¬åœ°äº‹åŠ¡ä¸­æ‰§è¡Œä¸šåŠ¡é€»è¾‘ä¸­çš„æ•°æ®åº“æ“ä½œå’Œæ–°å¢æ¶ˆæ¯è¡¥å¿è®°å½•ï¼ˆ1. Prepare: æ–°å¢è®°å½•ï¼‰</li>
<li>æ­¥éª¤äºŒï¼šæœ¬åœ°äº‹åŠ¡æäº¤åï¼Œå¯åŠ¨å¼‚æ­¥çº¿ç¨‹ï¼Œå‘RocketMQå‘é€æ¶ˆæ¯ï¼ˆ2. å‘é€æ¶ˆæ¯ï¼‰ï¼Œæ¶ˆæ¯å‘é€æˆåŠŸååˆ é™¤æ¶ˆæ¯è¡¥å¿è®°å½•ï¼ˆ3. Confirm: åˆ é™¤è®°å½•ï¼‰<br>å¦‚æœå› æ–­ç½‘æˆ–è€…åº”ç”¨é‡å¯ç­‰åŸå› ï¼Œå‘é€æ¶ˆæ¯å¤±è´¥æˆ–è€…æœªæˆåŠŸåˆ é™¤æ¶ˆæ¯è¡¥å¿è®°å½•ï¼Œæ¶ˆæ¯ç”Ÿäº§è€…ä¼šå®šæ—¶è§¦å‘æ¶ˆæ¯è¡¥å¿ï¼Œç¡®ä¿å‘é€åˆ°RocketMQçš„æ¶ˆæ¯è‡³å°‘å‘é€ä¸€æ¬¡ï¼ˆat least onceç­–ç•¥ï¼ŒMQæœ‰å¯èƒ½å­˜åœ¨å¤šæ¡ç›¸åŒçš„æ¶ˆæ¯ï¼‰</li>
<li>æ­¥éª¤ä¸‰ï¼šRocketMQå°†æ¶ˆæ¯æŠ•é€’ç»™æ¶ˆæ¯æ¶ˆè´¹è€…ï¼ˆ4. æŠ•é€’æ¶ˆæ¯ï¼‰ï¼Œæ¶ˆæ¯æ¶ˆè´¹è€…é¦–å…ˆéœ€è¦è¿›è¡Œå¹‚ç­‰æ€§æ£€æŸ¥ï¼ˆé¿å…é‡å¤æ‰§è¡ŒåŒä¸€ä¸ªæ¶ˆæ¯ï¼‰ï¼Œé€šè¿‡æ£€æŸ¥åæ‰§è¡Œæœ¬åœ°äº‹åŠ¡çš„ä¸šåŠ¡é€»è¾‘ï¼Œæœ€åè¿”å›æ‰§è¡Œç»“æœï¼ˆ5. Ackï¼‰</li>
</ul>
<p>ç»“åˆä¸šåŠ¡å®é™…æƒ…å†µï¼Œç”±äºRocketMQçš„äº‹åŠ¡æ¶ˆæ¯ç›¸æ¯”äºæ™®é€šæ¶ˆæ¯æ€§èƒ½ä¸Šè¿˜æ˜¯æœ‰ä¸å°çš„æŸå¤±ï¼Œæ— æ³•å®Œå…¨æ»¡è¶³æˆ‘ä»¬çš„æ€§èƒ½è¦æ±‚ï¼ˆæœåŠ¡å™¨è§„æ¨¡ä¸å˜çš„å‰æä¸‹ï¼‰ï¼Œå› æ­¤æˆ‘ä»¬æœ€ç»ˆé€‰æ‹©äº†å®ç°ä¸Šæ›´åŠ å¤æ‚çš„æ–¹æ¡ˆå…­ã€‚</p>
<h2 id="2-2-4-ç¡¬ä»¶å‡çº§åŠèµ„æºä¼˜åŒ–"><a href="#2-2-4-ç¡¬ä»¶å‡çº§åŠèµ„æºä¼˜åŒ–" class="headerlink" title="2.2.4 ç¡¬ä»¶å‡çº§åŠèµ„æºä¼˜åŒ–"></a>2.2.4 ç¡¬ä»¶å‡çº§åŠèµ„æºä¼˜åŒ–</h2><p>ç¡¬ä»¶çš„æ€§èƒ½å’Œèµ„æºåˆ©ç”¨ç‡åŒæ ·ä¹Ÿæ˜¯æˆ‘ä»¬æ€§èƒ½ä¼˜åŒ–è¿‡ç¨‹ä¸­éœ€è¦å…³æ³¨çš„åœ°æ–¹ï¼Œå¦‚æœæˆ‘ä»¬æŠŠä¸åŒçš„åº”ç”¨æ¯”å–»æˆå†›é˜Ÿä¸­ä¸åŒçš„å…µç§ï¼Œé‚£ä¹ˆç¡¬ä»¶å°±ç»™ä¸åŒå…µç§é…ç½®çš„è£…å¤‡ï¼Œåªæœ‰åˆç†æ­é…ï¼Œè¿™äº›è£…å¤‡æ‰èƒ½æœ€å¤§ç¨‹åº¦æå‡å„å…µç§çš„æˆ˜æ–—åŠ›ï¼Œè€Œåˆç†æ­é…è£…å¤‡çš„åº•å±‚é€»è¾‘ï¼Œæ˜¯å¯¹èµ„æºçš„æœ€å¤§åŒ–åˆ©ç”¨ã€é¿å…æµªè´¹ã€‚</p>
<p>äº‹å®ä¸Šï¼Œèµ„æºç­¹å¤‡å·¥ä½œå¾€å¾€æ˜¯å…ˆäºäº§å“å¼€å‘å·¥ä½œå¼€å±•çš„ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬çš„æ€§èƒ½ä¼˜åŒ–å·¥ä½œåœ¨ç»å¤§éƒ¨åˆ†æ—¶å€™æ˜¯åœ¨èµ„æºä¸å˜çš„å‰æä¸‹è¿›è¡Œçš„ã€‚ä¸ºäº†åˆ©ç”¨å¥½è¿™äº›èµ„æºï¼Œé€šå¸¸æˆ‘ä»¬éœ€è¦è§£å†³ä»¥ä¸‹ä¸‰ä¸ªé—®é¢˜ï¼š</p>
<ol>
<li><p><strong>èµ„æºç­¹å¤‡é˜¶æ®µ</strong>ï¼šå¦‚ä½•å‡†ç¡®åœ°é¢„ä¼°éœ€è¦çš„èµ„æºï¼Ÿ</p>
</li>
<li><p><strong>åº”ç”¨æ¶æ„</strong>ï¼šä»å·²çŸ¥çš„ä¸šåŠ¡ä¿¡æ¯ä¸­åˆ†ç¦»å‡ºä¸å˜çš„éƒ¨åˆ†å’Œå˜åŒ–çš„éƒ¨åˆ†ï¼Œè¾“å‡ºå…¨å±€åº”ç”¨æ¶æ„å’Œç³»ç»Ÿåº”ç”¨æ¶æ„ï¼ˆåŒ…å«åº”ç”¨åŠå…¶ä¾èµ–é¡¹ï¼‰ï¼Œä¸€èˆ¬è€Œè¨€ï¼Œä¸­åå°åº”ç”¨ä¸å˜çš„éƒ¨åˆ†æ›´å¤šå®¹æ˜“é¢„ä¼°ï¼Œå‰å°åº”ç”¨ä¸ç¡®å®šæ€§é«˜ä¹Ÿæ›´éš¾é¢„ä¼°ï¼Œä½†éšç€éœ€æ±‚é€æ¸æ˜æœ—ï¼ˆé€æ­¥è¿›å…¥äº§å“ç ”å‘é˜¶æ®µã€äº§å“è¿è¥é˜¶æ®µåï¼‰ï¼ŒåŠ ä¸Šæœ‰æ›´å¤šçš„æµ‹è¯•æ•°æ®ï¼Œé¢„ä¼°ä¹Ÿä¼šè¶Šæ¥è¶Šå‡†ç¡®ï¼Œå› æ­¤ï¼Œåº”ç”¨æ¶æ„åº”ä¿æŒæŒç»­æ¼”è¿›ä»¥æ›´å¥½åœ°å˜æ¸…ä¾èµ–å…³ç³»åŠèµ„æºéœ€æ±‚</p>
</li>
<li><p><strong>éƒ¨ç½²æ¶æ„åŠèµ„æºæ¸…å•</strong>ï¼šå°†åº”ç”¨æ¶æ„æ˜ å°„æˆéƒ¨ç½²æ¶æ„æ˜¯èµ„æºé¢„ä¼°çš„é‡è¦æ­¥éª¤ï¼Œè¿™ä¸ªé˜¶æ®µä¸€èˆ¬è¿˜æ²¡æœ‰åŠæ³•è¾“å‡ºå®Œæ•´çš„æµé‡æ¨¡å‹ï¼Œä½†æ¶æ„å¸ˆå¯ä»¥å€ŸåŠ©ä¸šåŠ¡é¢„åˆ¤ï¼ˆå¦‚ä»€ä¹ˆæ ·çš„ä¸šåŠ¡å½¢æ€ã€å¤šå°‘ç”¨æˆ·å‚ä¸ç­‰ï¼‰æ‹†è§£å‡ºæ ¸å¿ƒåŸŸçš„å‰ç«¯å…¥å£æµé‡ï¼ˆå¦‚ç”³è´­æµé‡ã€äº¤æ˜“æµé‡ï¼‰ï¼Œå„ä¸ªåŸŸå†é€å±‚æ‹†è§£åˆ°å„ä¸ªåº”ç”¨ï¼Œæœ€ç»ˆæ˜ å°„å‡ºèµ„æºæ¸…å•ï¼ˆä¹Ÿå°±æ˜¯ç¬¬ä¸€ç‰ˆèµ„æºæ¸…å•ï¼‰ï¼Œä¸éš¾æƒ³è±¡ï¼Œè¦æå‡è¿™ä¸ªé˜¶æ®µèµ„æºé¢„ä¼°å‡†ç¡®æ€§éå¸¸å›°éš¾ï¼Œéœ€è¦ä¸šåŠ¡æ–¹ã€å¼€å‘å›¢é˜Ÿã€è¿ç»´å›¢é˜Ÿç´§å¯†ååŒï¼Œä¸šåŠ¡è¾“å…¥è¶Šå……åˆ†é¢„ä¼°ä¼šè¶Šå‡†ç¡®ï¼Œåº”ç”¨æ¶æ„è®¾è®¡è¶Šå®Œæ•´é¢„ä¼°ä¼šè¶Šå‡†ç¡®</p>
</li>
</ol>
<p>äº§å“ç ”å‘é˜¶æ®µï¼šå¦‚ä½•ç»“åˆåº”ç”¨ç‰¹æ€§åˆç†åœ°æ­é…å’Œä½¿ç”¨èµ„æºï¼Ÿ</p>
<p>é€šå¸¸SREä¼šå®šä¹‰å‡ºä¸åŒçš„èµ„æºè§„æ ¼ä¾›å„ç±»åº”ç”¨é€‰æ‹©ï¼š</p>
<ul>
<li><strong>CPUæ€§èƒ½</strong>ï¼šCPUæ€§èƒ½å¯¹äºè®¡ç®—å¯†é›†å‹ä»»åŠ¡éå¸¸é‡è¦ï¼Œåº”ç”¨å¦‚æœéœ€è¦å¤§é‡è®¡ç®—ï¼Œéœ€è¦é…ç½®é«˜æ€§èƒ½çš„CPU</li>
<li><strong>å†…å­˜å®¹é‡</strong>ï¼šå†…å­˜å®¹é‡å¯¹äºæ•°æ®å¯†é›†å‹åº”ç”¨å’Œéœ€è¦ç¼“å­˜å¤§é‡æ•°æ®çš„åº”ç”¨è‡³å…³é‡è¦ï¼Œè¶³å¤Ÿçš„å†…å­˜å¯ä»¥å‡å°‘å¯¹ç£ç›˜æˆ–ç½‘ç»œçš„è®¿é—®ï¼Œæé«˜æ€§èƒ½</li>
<li><strong>å­˜å‚¨</strong>ï¼šå­˜å‚¨é…ç½®å–å†³äºæ•°æ®é‡å’Œæ€§èƒ½éœ€æ±‚ï¼Œä½¿ç”¨é«˜æ€§èƒ½å›ºæ€ç¡¬ç›˜ï¼ˆSSDï¼‰å¯ä»¥æé«˜æ•°æ®è¯»å†™é€Ÿåº¦</li>
<li><strong>ç½‘ç»œå¸¦å®½</strong>ï¼š å¦‚æœåº”ç”¨éœ€è¦å¤§é‡çš„æ•°æ®ä¼ è¾“ï¼Œç½‘ç»œå¸¦å®½æ˜¯ä¸€ä¸ªç“¶é¢ˆï¼Œä¸€èˆ¬è´Ÿè½½å‡è¡¡è®¾å¤‡ã€åº”ç”¨ç½‘å…³ã€CDNéœ€è¦é‡ç‚¹è€ƒè™‘</li>
<li><strong>å®¹é‡è§„åˆ’ä¸æµé‡æ¨¡å‹è®¾è®¡</strong>ï¼šè¿™ä¸ªé˜¶æ®µéœ€æ±‚å·²ç»éå¸¸æ˜ç¡®ï¼Œå¯ä»¥åŸºäºåœºæ™¯åŠæœ€æ–°çš„åº”ç”¨æ¶æ„è¿›è¡Œæ›´ä¸ºç»†è‡´çš„æµé‡æ‹†è§£ï¼Œè¯„ä¼°å‡ºæ¯ä¸ªç³»ç»Ÿï¼ˆå°¤å…¶æ˜¯æ ¸å¿ƒç³»ç»Ÿï¼‰çš„å®¹é‡è¦æ±‚åŠèµ„æºæ¸…å•ï¼Œå¹¶é€šè¿‡å‹æµ‹è¿›è¡ŒéªŒè¯ï¼Œç¡®ä¿ç³»ç»Ÿåœ¨å„ç§è´Ÿè½½æƒ…å†µä¸‹éƒ½èƒ½å¤Ÿæ­£å¸¸è¿è¡Œ</li>
<li><strong>äº§å“è¿è¥é˜¶æ®µ</strong>ï¼šå¦‚ä½•æœ€å¤§åŒ–åœ°åˆ©ç”¨å¥½ç°æœ‰çš„èµ„æºï¼Ÿ</li>
<li><strong>èµ„æºè¶…å”®æˆ–æ··éƒ¨</strong>ï¼šä¸€èˆ¬å¯ä»¥é€šè¿‡äº‘å‚å•†æä¾›çš„èµ„æºè¶…å”®èƒ½åŠ›æˆ–è€…ç ”å‘å›¢é˜Ÿä¸»åŠ¨å‘èµ·åº”ç”¨æ··éƒ¨æ¥æé«˜èµ„æºåˆ©ç”¨ç‡ï¼Œç„¶è€Œè¿™å´æ˜¯æŠŠåŒåˆƒå‰‘ï¼Œæ›´é«˜çš„èµ„æºåˆ©ç”¨ç‡ä¹Ÿå°±æ„å‘³ç€æ›´ä½çš„èµ„æºå®¹é”™ç‡ï¼Œä¸€æ—¦å‡ºç°é¢„æœŸä¹‹å¤–çš„æµé‡æˆ–è€…èµ„æºå ç”¨ï¼Œå¾ˆå®¹æ˜“æˆä¸ºå‹å®ç³»ç»Ÿçš„æœ€åä¸€æ ¹ç¨»è‰</li>
<li><strong>ç¡¬ä»¶å‡çº§åŠèµ„æºä¼˜åŒ–</strong>ï¼šé€šè¿‡è¯Šæ–­å·¥å…·è¯†åˆ«åœ¨å‹æµ‹æˆ–äº§å“è¿è¥è¿‡ç¨‹ä¸­å‡ºç°çš„èµ„æºå¼‚å¸¸ï¼Œå¦‚CPUä½¿ç”¨ç‡æˆ–Loadä¸å‡è¡¡ã€I&#x2F;Oå»¶è¿Ÿå¤§ã€å†…å­˜ä½¿ç”¨ç‡é«˜ç­‰ç‰¹å¾</li>
</ul>
<h2 id="2-3-å°ç»“"><a href="#2-3-å°ç»“" class="headerlink" title="2.3 å°ç»“"></a>2.3 å°ç»“</h2><p>æ€§èƒ½ä¼˜åŒ–æ˜¯äº§å“è®¾è®¡ã€ç ”å‘å’Œè¿è¥è¿‡ç¨‹ä¸­çš„ä¸€ä¸ªæå…¶é‡è¦çš„ç¯èŠ‚ï¼Œé€šè¿‡æ€§èƒ½ä¼˜åŒ–å¯ä»¥ç¡®ä¿æˆ‘ä»¬çš„ç³»ç»Ÿæ»¡è¶³æ€§èƒ½è®¾è®¡ç›®æ ‡ã€‚é€šå¸¸æˆ‘ä»¬éœ€è¦å…ˆå€ŸåŠ©æ€§èƒ½è¯Šæ–­å·¥å…·è¯†åˆ«æ€§èƒ½ç“¶é¢ˆï¼Œç„¶åç»“åˆå®é™…æƒ…å†µç»¼åˆé€‰æ‹©ä¸€ç§æˆ–è€…å¤šç§æ€§èƒ½ä¼˜åŒ–ç­–ç•¥ã€‚</p>
<p>ä½†éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œè¿‡æ—©çš„ä¼˜åŒ–å¯èƒ½ä¼šå¼•å…¥ä¸å¿…è¦çš„ä»£ç å¤æ‚æ€§è€Œæ€§èƒ½å´æœªå¿…æ”¹å–„ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬å»ºè®®åœ¨ç³»ç»Ÿå¼€å‘çš„æ—©æœŸé˜¶æ®µåº”æ›´ä¾§é‡äºä¿æŒä»£ç çš„å¯ç»´æŠ¤æ€§å’Œå¯è¯»æ€§ï¼Œéšç€ç³»ç»Ÿçš„æŒç»­æ¼”è¿›ï¼Œå†åŸºäºæ€§èƒ½è¯Šæ–­ç»“æœå¯¹ä»£ç è¿›è¡Œé’ˆå¯¹æ€§åœ°ä¼˜åŒ–ä»¥æ»¡è¶³æ€§èƒ½éœ€æ±‚ã€‚</p>
<h2 id="3-å®ç°é«˜å¯ç”¨çš„ä¸»è¦ç­–ç•¥"><a href="#3-å®ç°é«˜å¯ç”¨çš„ä¸»è¦ç­–ç•¥" class="headerlink" title="3 å®ç°é«˜å¯ç”¨çš„ä¸»è¦ç­–ç•¥"></a>3 å®ç°é«˜å¯ç”¨çš„ä¸»è¦ç­–ç•¥</h2><p>é«˜æ€§èƒ½å¹¶ä¸æ„å‘³ç€é«˜å¯ç”¨ï¼Œæœ‰äº›æå‡æ€§èƒ½çš„æ‰‹æ®µä¼šå¢åŠ ç³»ç»Ÿè´Ÿè½½ï¼Œåè€Œè¿˜ä¼šé™ä½å¯ç”¨æ€§ï¼Œè€Œä¸ºäº†å®ç°ç³»ç»Ÿçš„é«˜å¯ç”¨ï¼Œæˆ‘ä»¬é€šå¸¸éœ€è¦å¼•å…¥ä¸€äº›å¤æ‚æ€§æˆ–å†—ä½™ï¼Œå¯èƒ½è¿˜ä¼šå¯¹æ€§èƒ½äº§ç”Ÿä¸€å®šè´Ÿé¢å½±å“ã€‚</p>
<p>æœ¬ç« èŠ‚ä¼šé‡ç‚¹æ¢è®¨ä¸€ä¸‹åœ¨ç³»ç»Ÿæ¶æ„å’Œè®¾è®¡é˜¶æ®µå¦‚ä½•è€ƒè™‘å¯ç”¨æ€§ç›®æ ‡ã€‚</p>
<h2 id="3-1-é¢å‘å¤±è´¥çš„è®¾è®¡"><a href="#3-1-é¢å‘å¤±è´¥çš„è®¾è®¡" class="headerlink" title="3.1 é¢å‘å¤±è´¥çš„è®¾è®¡"></a>3.1 é¢å‘å¤±è´¥çš„è®¾è®¡</h2><p>ä»»ä½•æœåŠ¡å’Œç»„ä»¶éƒ½ä¸æ˜¯100%å¯é çš„ï¼Œå› æ­¤æ ¸å¿ƒç³»ç»Ÿçš„è®¾è®¡å»ºè®®é¢å‘å¤±è´¥è¿›è¡Œè®¾è®¡ï¼Œå³ç¡®ä¿åœ¨éƒ¨åˆ†ç»„ä»¶æˆ–æœåŠ¡æ•…éšœæ—¶ä»ç„¶èƒ½å¤Ÿç»§ç»­æä¾›æœåŠ¡ï¼Œæ¯”å¦‚å‰æ–‡æåˆ°çš„ç”³è´­åœºæ™¯å’Œçˆ†æ¬¾æŠ¢è´­åœºæ™¯éƒ½ä½¿ç”¨äº†è¿™ä¸€è®¾è®¡ç†å¿µã€‚</p>
<p>è¿™é‡Œæˆ‘ä»¬æ€»ç»“ä¸‹å‡ ç§å¸¸ç”¨çš„ç­–ç•¥ï¼š</p>
<ul>
<li><strong>æœ€å°åŒ–ä¾èµ–</strong>ï¼šè¦å‡å°‘å¯¹å¤–éƒ¨æœåŠ¡å’Œç»„ä»¶çš„ä¾èµ–ï¼Œç‰¹åˆ«æ˜¯å‡å°‘å¼ºä¾èµ–ï¼Œä»è€Œé™ä½æ•…éšœä¼ æ’­çš„é£é™©</li>
<li><strong>å†—ä½™å’Œå¤‡ä»½</strong>ï¼šé€šè¿‡å¼•å…¥å†—ä½™ç»„ä»¶æˆ–å¤‡ä»½ç³»ç»Ÿï¼Œåœ¨ä¸»è¦ç»„ä»¶æ•…éšœæ—¶å¯ä»¥æ— ç¼åˆ‡æ¢åˆ°å¤‡ç”¨ç»„ä»¶ï¼Œä»è€Œç¡®ä¿æœåŠ¡çš„è¿ç»­æ€§ï¼Œéœ€è¦ç‰¹åˆ«é‡è§†çš„æ˜¯ï¼Œå…³é”®ç»„ä»¶è¦é¿å…å•ç‚¹</li>
<li><strong>è‡ªåŠ¨æ•…éšœæ£€æµ‹å’Œæ¢å¤</strong>ï¼šä½¿ç³»ç»Ÿèƒ½å¤Ÿä¸»åŠ¨æ£€æµ‹æ•…éšœæˆ–å¼‚å¸¸æƒ…å†µï¼Œå¹¶é‡‡å–è‡ªåŠ¨åŒ–æªæ–½ä»¥æ¢å¤æ­£å¸¸è¿è¡Œï¼Œé€šè¿‡è¿™ç§æ–¹å¼å¯ä»¥å‡å°‘å¯¹äººå·¥å¹²é¢„çš„ä¾èµ–ï¼Œä»è€Œæ›´å¿«åœ°å“åº”é—®é¢˜ï¼Œé™ä½æœåŠ¡ä¸­æ–­çš„é£é™©</li>
<li><strong>è¶…æ—¶ä¸é‡è¯•</strong>ï¼šåœ¨ç½‘ç»œé€šä¿¡ä¸­ï¼Œè®¾ç½®é€‚å½“çš„è¶…æ—¶æ—¶é—´ï¼Œä»¥é˜²æ­¢è¯·æ±‚æŒ‚èµ·ï¼›ä½¿ç”¨é‡è¯•æœºåˆ¶ç¡®ä¿è¯·æ±‚çš„å¯é æ€§ï¼›ç»“åˆåˆç†çš„é€€é¿ç­–ç•¥ï¼Œé¿å…è¿‡åº¦é‡è¯•å¯¼è‡´æœåŠ¡å™¨è´Ÿè½½è¿‡é«˜</li>
<li><strong>é™æµä¸é™çº§</strong>ï¼šå®æ–½é™æµç­–ç•¥ï¼Œæ§åˆ¶è¯·æ±‚æµé‡ä»¥é˜²æ­¢ç³»ç»Ÿè¿‡è½½ï¼Œåœ¨é«˜è´Ÿè½½æˆ–æ•…éšœæ—¶é™çº§éƒ¨åˆ†åŠŸèƒ½ï¼Œä¿æŒæ ¸å¿ƒåŠŸèƒ½çš„å¯ç”¨æ€§</li>
<li><strong>ç›‘æ§ä¸æŠ¥è­¦</strong>ï¼šå»ºç«‹ç›‘æ§ç³»ç»Ÿï¼Œå®æ—¶è¿½è¸ªç³»ç»Ÿæ€§èƒ½å’Œå¥åº·çŠ¶æ€ï¼Œè®¾ç½®æŠ¥è­¦è§„åˆ™ä»¥åœ¨é—®é¢˜å‘ç”Ÿæ—¶åŠæ—¶é€šçŸ¥è¿ç»´å›¢é˜Ÿé‡‡å–è¡ŒåŠ¨</li>
<li><strong>åº”æ€¥é¢„æ¡ˆ</strong>ï¼šåˆ¶å®šåº”æ€¥é¢„æ¡ˆï¼Œåœ¨ç³»ç»Ÿæ•…éšœæˆ–ç´§æ€¥æƒ…å†µä¸‹å¿«é€Ÿé‡‡å–è¡ŒåŠ¨ä»¥è¾¾åˆ°æœ€å¤§é™åº¦ä¿æŠ¤ç³»ç»Ÿçš„ç›®çš„ï¼ŒåŒ…æ‹¬é™ä½ç³»ç»Ÿè´Ÿè½½ã€æ•…éšœæ­¢è¡€ä¸æ¢å¤ã€æ•°æ®å¤‡ä»½ç­‰ç­‰</li>
</ul>
<h2 id="3-2-å¾®æœåŠ¡æ¶æ„"><a href="#3-2-å¾®æœåŠ¡æ¶æ„" class="headerlink" title="3.2 å¾®æœåŠ¡æ¶æ„"></a>3.2 å¾®æœåŠ¡æ¶æ„</h2><p>å¾®æœåŠ¡æ¶æ„æ˜¯ä¸€ç§å…¸å‹çš„å®¹é”™æ¶æ„ï¼Œç”±äºã€ŒièŒ…å°ã€å•†åŸåœ¨è®¾è®¡é˜¶æ®µå·²ç»æ˜ç¡®äº†ä¸šåŠ¡æ¨¡å¼å’Œæµé‡æŒ‘æˆ˜ï¼Œå› æ­¤æˆ‘ä»¬æ²¡æœ‰åƒä¸¥é€‰æ—©æœŸé‚£æ ·é‡‡ç”¨å•ä½“æ¶æ„å¿«é€Ÿä¸Šçº¿ï¼Œè€Œæ˜¯ç›´æ¥é‡‡ç”¨å¾®æœåŠ¡æ¶æ„è¿›è¡Œè®¾è®¡ï¼ŒåŸºç¡€è®¾æ–½åˆ™å¤ç”¨äº†ä¸¥é€‰çš„Service Meshæ¶æ„ï¼ˆå‚è§ç½‘æ˜“ä¸¥é€‰ServiceMeshå®è·µï¼‰ï¼Œç›¸æ¯”äºå•ä½“æ¶æ„åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢å…·æœ‰æ˜æ˜¾ä¼˜åŠ¿ï¼š</p>
<ul>
<li><strong>æ•…éšœéš”ç¦»</strong>ï¼šå¾®æœåŠ¡æ¶æ„å°†ä¸€ä¸ªåº”ç”¨ç¨‹åºè¢«æ‹†åˆ†æˆä¸€ç»„å°å‹ã€ç‹¬ç«‹çš„æœåŠ¡ï¼Œæ¯ä¸ªæœåŠ¡éƒ½ä¸“æ³¨äºæ‰§è¡Œç‰¹å®šçš„ä¸šåŠ¡åŠŸèƒ½ï¼Œå½“ä¸€ä¸ªæœåŠ¡å‘ç”Ÿæ•…éšœæ—¶ï¼Œä¸ä¼šå½±å“å…¶ä»–æœåŠ¡çš„æ­£å¸¸è¿è¡Œï¼Œä»è€Œå‡å°äº†æ•…éšœçš„ä¼ æ’­èŒƒå›´ï¼Œæé«˜äº†æ•´ä½“ç³»ç»Ÿçš„å¯ç”¨æ€§</li>
<li><strong>æ°´å¹³æ‰©å±•</strong>ï¼šå¾®æœåŠ¡æ¶æ„ä½¿å¾—æ¯ä¸ªæœåŠ¡å¯ä»¥ç‹¬ç«‹åœ°è¿›è¡Œæ°´å¹³æ‰©å±•ï¼Œå¯ä»¥æ ¹æ®éœ€æ±‚å¢åŠ æˆ–å‡å°‘æœåŠ¡å®ä¾‹çš„æ•°é‡ï¼Œä»¥æ»¡è¶³ä¸åŒçš„è´Ÿè½½è¦æ±‚ï¼Œä»è€Œæé«˜äº†ç³»ç»Ÿçš„å¼¹æ€§å’Œå¯ç”¨æ€§</li>
<li><strong>å¿«é€Ÿæ•…éšœæ¢å¤</strong>ï¼šå¾®æœåŠ¡æ¶æ„å…·å¤‡è‡ªåŠ¨æ•…éšœæ£€æµ‹å’Œåˆ‡æ¢æœºåˆ¶ï¼Œç³»ç»Ÿèƒ½å¤Ÿåœ¨æ£€æµ‹åˆ°æ•…éšœæ—¶è‡ªåŠ¨å°†æµé‡åˆ‡æ¢åˆ°å…¶ä»–æœåŠ¡å®ä¾‹ï¼Œä»è€Œå®ç°å¿«é€Ÿæ•…éšœæ¢å¤ï¼Œå‡å°‘äº†æœåŠ¡ä¸­æ–­çš„æ—¶é—´</li>
<li><strong>åˆ†å¸ƒå¼éƒ¨ç½²</strong>ï¼šå¾®æœåŠ¡æ¶æ„æ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½²ï¼ŒæœåŠ¡å¯ä»¥éƒ¨ç½²åœ¨ä¸åŒçš„æœåŠ¡å™¨ä¸Šï¼ˆç”šè‡³å¯ä»¥è·¨æ•°æ®ä¸­å¿ƒè¿›è¡Œéƒ¨ç½²ï¼‰ï¼Œè¿™æä¾›äº†æ›´é«˜çº§åˆ«çš„å®¹é”™æ€§ï¼Œé¿å…å•ç‚¹æ•…éšœ</li>
<li><strong>çµæ´»çš„æ›´æ–°å’Œç»´æŠ¤</strong>ï¼šç”±äºæ¯ä¸ªæœåŠ¡éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œå¯ä»¥å•ç‹¬æ›´æ–°å’Œç»´æŠ¤ï¼Œè€Œä¸ä¼šå½±å“æ•´ä¸ªç³»ç»Ÿçš„å¯ç”¨æ€§ï¼Œè¿™é™ä½äº†ç»´æŠ¤å’Œæ›´æ–°è¿‡ç¨‹ä¸­çš„é£é™©ï¼Œå‡å°‘äº†ç³»ç»Ÿçš„åœæœºæ—¶é—´</li>
</ul>
<p>æœ‰äº†åŸºç¡€æ¶æ„æä¾›çš„æœåŠ¡æ²»ç†èƒ½åŠ›åŠ æŒï¼Œå¼€å‘éœ€è¦åœ¨ç³»ç»Ÿè®¾è®¡å’Œå¼€å‘é˜¶æ®µé‡ç‚¹å…³æ³¨ä»¥ä¸‹å‡ ç‚¹æ–¹é¢ï¼š</p>
<ul>
<li><strong>æœåŠ¡åˆ†çº§</strong>ï¼šæœåŠ¡åˆ†çº§æ˜¯æœåŠ¡å…³è”çš„ä¸€ä¸ªæ ‡ç­¾ï¼Œå¯ä»¥åŒºåˆ†å‡ºæ¯ä¸ªæœåŠ¡å¯¹äºä¸šåŠ¡å½±å“çš„é‡è¦ç¨‹åº¦ï¼Œæˆ‘ä»¬è®¤ä¸ºæ¯ä¸ªæœåŠ¡éƒ½åº”è¯¥æœ‰å¯¹åº”çš„åˆ†çº§æ ‡ç­¾ï¼Œå®ƒå¯ä»¥è®©æˆ‘ä»¬æ›´æ¸…æ™°åœ°äº†è§£æœåŠ¡çš„å¯ç”¨æ€§ç›®æ ‡ä»¥åŠæœåŠ¡ä¹‹é—´çš„ä¾èµ–å…³ç³»æ˜¯å¦åˆç†</li>
</ul>
<p>é€šå¸¸æ›´é«˜ç­‰çº§çš„æœåŠ¡åº”è¯¥åŒ¹é…æ›´é«˜ç­‰çº§çš„æœåŠ¡ä¿éšœï¼Œä¹Ÿåº”è¯¥å…·å¤‡æ›´é«˜çš„å¯ç”¨æ€§ï¼Œå› æ­¤ï¼Œè¦é¿å…é«˜ç­‰çº§çš„æœåŠ¡å¼ºä¾èµ–ä½ç­‰çº§çš„æœåŠ¡ï¼Œå¦åˆ™å®¹æ˜“é€ æˆé«˜ç­‰çº§çš„æœåŠ¡æ— æ³•è¾¾åˆ°æ—¢å®šçš„å¯ç”¨æ€§ç›®æ ‡</p>
<ul>
<li><strong>æœåŠ¡ä¾èµ–</strong>ï¼šç”±äºå¾®æœåŠ¡æ¶æ„ä¼šå°†æœåŠ¡æ‹†åˆ†æˆæ›´å°çš„å•å…ƒï¼Œè¿™å°±ä¸å¯é¿å…åœ°å¢åŠ äº†æœåŠ¡ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œé€šå¸¸æˆ‘ä»¬å¯ä»¥æ ¹æ®å¯¹æ•…éšœçš„å®¹å¿åº¦å°†ä¾èµ–å…³ç³»åŒºåˆ†ä¸ºå¼ºä¾èµ–å’Œå¼±ä¾èµ–ï¼Œåœ¨è®¾è®¡ä¸Šå»ºè®®éµå¾ªä»¥ä¸‹åŸåˆ™ï¼š</li>
<li><strong>å¼ºä¾èµ–å¼±åŒ–</strong>ï¼šå¼ºä¾èµ–çš„æœåŠ¡åº”å½“å°½é‡å‡å°‘æˆ–å‡å¼±ï¼Œä»¥é™ä½æ•´ä¸ªç³»ç»Ÿä¸­æŸä¸ªæœåŠ¡çš„æ•…éšœå¯¹å…¶ä»–æœåŠ¡çš„å½±å“</li>
<li><strong>å¼±ä¾èµ–å¼‚æ­¥åŒ–</strong>ï¼šå¼±ä¾èµ–çš„æœåŠ¡å¯ä»¥é‡‡ç”¨å¼‚æ­¥é€šä¿¡æ–¹å¼ï¼ˆå¦‚æ¶ˆæ¯é˜Ÿåˆ—ï¼‰ï¼Œä»¥é™ä½å¯¹ä¾èµ–æœåŠ¡çš„ç›´æ¥è°ƒç”¨ï¼Œæé«˜ç³»ç»Ÿçš„å¼¹æ€§å’Œå“åº”æ€§</li>
<li><strong>è¶…æ—¶æ²»ç†</strong>ï¼šè¶…æ—¶æ²»ç†æ˜¯é€šè¿‡ä¼˜åŒ–è¶…æ—¶æ—¶é—´ä¸é‡è¯•ç­–ç•¥ï¼Œä½¿å°½å¯èƒ½å¤šçš„è¯·æ±‚èƒ½å¤Ÿåœ¨é¢„æœŸæ—¶é—´å†…å¾—åˆ°æ­£å¸¸å“åº”ï¼Œæé«˜ç³»ç»Ÿçš„å“åº”æ€§ï¼Œæ˜¯ä¸€ç§é‡è¦çš„æœåŠ¡æ²»ç†æ‰‹æ®µ</li>
</ul>
<p>è¶…æ—¶æ—¶é—´çš„è®¾ç½®åº”å……åˆ†è€ƒè™‘ä¸šåŠ¡æœ¬èº«çš„å¤æ‚æ€§å’Œé¢„æœŸå“åº”æ—¶é—´ï¼Œåº”è®¾ç½®è¶³å¤Ÿé•¿ä»¥å®¹å¿æ­£å¸¸çš„å“åº”å»¶è¿Ÿï¼Œä½†ä¹Ÿä¸èƒ½è¿‡é•¿é¿å…æ— é™æœŸæŒ‚èµ·ç­‰å¾…</p>
<p>å“åº”è¶…æ—¶å¹¶ä¸ä¸€å®šæ„å‘³ç€ç›®æ ‡æœåŠ¡å·²ç»ä¸èƒ½å·¥ä½œï¼Œé€šè¿‡åˆç†çš„é‡è¯•æœºåˆ¶ï¼Œå³ä½¿åœ¨ç›®æ ‡æœåŠ¡å™¨æˆ–ç½‘ç»œæ•…éšœçš„æƒ…å†µä¸‹ä¹Ÿèƒ½å¤ŸæˆåŠŸå®Œæˆè¯·æ±‚ï¼Œä½†è¦ç¡®ä¿è¯·æ±‚çš„å¹‚ç­‰æ€§ï¼Œé¿å…é‡è¯•è¯·æ±‚å¯¹ä¸šåŠ¡äº§ç”Ÿè´Ÿé¢å½±å“</p>
<p>è®¾è®¡åˆç†çš„é€€é¿ç­–ç•¥ï¼ˆå¦‚æŒ‡æ•°é€€é¿ï¼‰ï¼Œé¿å…è¿ç»­é‡è¯•å¯¼è‡´æœåŠ¡å™¨è´Ÿè½½è¿‡é«˜ï¼Œå¦å¤–ï¼Œé‡è¯•æ¬¡æ•°ä¹Ÿåº”è¯¥æœ‰é™ï¼Œé¿å…æ— é™é‡è¯•</p>
<p>åœ¨æ”¾å¼ƒè¯·æ±‚åï¼Œç³»ç»Ÿå¯èƒ½é‡‡ç”¨é™çº§ç­–ç•¥ï¼Œæä¾›æœ‰é™çš„æœåŠ¡ï¼Œä»¥ç¡®ä¿æ ¸å¿ƒåŠŸèƒ½çš„å¯ç”¨æ€§</p>
<ul>
<li><strong>é™æµç­–ç•¥</strong>ï¼šé™æµæ˜¯ä¸€ç§é€šè¿‡æ§åˆ¶è¯·æ±‚æµé‡ä»¥é˜²æ­¢ç³»ç»Ÿè¿‡è½½çš„ç­–ç•¥ï¼Œä¹Ÿæ˜¯ä¸€ç§éå¸¸é‡è¦çš„æœåŠ¡æ²»ç†æ‰‹æ®µ</li>
</ul>
<p>é™æµä¼šå¸¦æ¥ä¸€å®šçš„æ€§èƒ½æŸè€—ï¼Œæˆ‘ä»¬å€ŸåŠ©åº”ç”¨ç½‘å…³ä¸é™æµä¸­é—´ä»¶å®ç°å¯¹æµå…¥ç½‘å…³åŠä¸šåŠ¡ç³»ç»Ÿçš„æµé‡è¿›è¡Œé™åˆ¶ï¼Œå„ä¸ªç³»ç»Ÿéœ€ç»“åˆæœåŠ¡ç­‰çº§ã€é¢„ä¼°æµé‡åŠåº”ç”¨å½“å‰èƒ½åŠ›é€‰æ‹©æ˜¯å¦å¼€å¯</p>
<p>é™æµå€¼çš„è®¾ç½®åº”å……åˆ†è€ƒè™‘åº”ç”¨è‡ªèº«çš„èƒ½åŠ›ï¼Œç”±äºç³»ç»Ÿæ¼”è¿›è¿‡ç¨‹ä¸­çš„ç†µå¢æ˜¯ä¸€ç§ä¸å¯é¿å…çš„è¶‹åŠ¿ï¼Œå»ºè®®é™æµå€¼è®¾ç½®æ—¶ä¿æŒä¸€å®šçš„ä½™é‡ï¼Œä»¥æœ€å¤§é™åº¦ä¸ºç³»ç»Ÿæä¾›æœ‰æ•ˆä¿æŠ¤</p>
<p>é™æµç­–ç•¥ä¸Šå¯ä»¥ä¸ºæ¯ä¸ªæœåŠ¡æˆ–æ¥å£è®¾ç½®æœ€å¤§è¯·æ±‚é€Ÿç‡ï¼Œä¹Ÿå¯ä»¥è¿›ä¸€æ­¥åŸºäºæ—¶é—´æ®µã€ç”¨æˆ·ã€IPåœ°å€ç­‰å› ç´ è¿›è¡Œç»†åŒ–</p>
<ul>
<li><strong>é™çº§ç­–ç•¥</strong>ï¼šé™çº§ç­–ç•¥æ˜¯ä¸€ç§åº”å¯¹ç³»ç»Ÿè´Ÿè½½è¿‡é«˜æˆ–æ•…éšœçš„ç­–ç•¥ï¼Œé€šè¿‡ç‰ºç‰²éå…³é”®åŠŸèƒ½ä»¥ä¿æŒæ ¸å¿ƒåŠŸèƒ½çš„æ­£å¸¸è¿è¡Œ</li>
<li><strong>ä¸»åŠ¨é™çº§</strong>ï¼šç³»ç»Ÿåœ¨ç›‘æµ‹åˆ°ä¸€å®šæ¡ä»¶æˆ–é¢„è®¾çš„è§„åˆ™è§¦å‘ä¸‹ï¼Œè‡ªåŠ¨æ‰§è¡Œé™çº§ç­–ç•¥ï¼ŒåŒ…æ‹¬è‡ªåŠ¨å…³é—­éå…³é”®åŠŸèƒ½ã€æ‹’ç»æŸäº›è¯·æ±‚ã€å‡å°‘èµ„æºåˆ†é…ç­‰</li>
<li><strong>æ‰‹åŠ¨é™çº§</strong>ï¼šè¿ç»´äººå‘˜æˆ–å¼€å‘äººå‘˜æ‰‹åŠ¨ä»‹å…¥æ‰§è¡Œé™çº§ç­–ç•¥ä»¥åº”å¯¹ç‰¹å®šçš„é—®é¢˜æˆ–å¼‚å¸¸æƒ…å†µï¼Œé€šå¸¸éƒ½æ˜¯åº”å¯¹å·²çŸ¥çš„é—®é¢˜æˆ–ç´§æ€¥æƒ…å†µï¼ŒåŸºäºé¢„æ¡ˆè¿›è¡Œæ“ä½œ</li>
<li><strong>ç†”æ–­ç­–ç•¥</strong>ï¼šå½“ä¸€ä¸ªæœåŠ¡åœ¨ä¸€æ®µæ—¶é—´å†…å‡ºç°è¿ç»­çš„å¤±è´¥ï¼Œç†”æ–­ç­–ç•¥ä¼šä¸­æ–­å¯¹è¯¥æœåŠ¡çš„è¯·æ±‚ï¼Œé¿å…å› é¢‘ç¹è¯·æ±‚å¤±è´¥è€Œå¯¼è‡´çš„èµ„æºæµªè´¹</li>
</ul>
<h2 id="3-3-å®¢æˆ·ç«¯ï¼ˆAPPï¼‰å®¹é”™è®¾è®¡"><a href="#3-3-å®¢æˆ·ç«¯ï¼ˆAPPï¼‰å®¹é”™è®¾è®¡" class="headerlink" title="3.3 å®¢æˆ·ç«¯ï¼ˆAPPï¼‰å®¹é”™è®¾è®¡"></a>3.3 å®¢æˆ·ç«¯ï¼ˆAPPï¼‰å®¹é”™è®¾è®¡</h2><p>å®¢æˆ·ç«¯ï¼ˆAPPï¼‰ä½œä¸ºç”¨æˆ·è·å¾—äº§å“æœåŠ¡çš„ä¸»è¦å…¥å£ï¼Œä¹Ÿå¤§é‡ä½¿ç”¨äº†å®¹é”™è®¾è®¡ã€‚</p>
<p>å®¹é”™è®¾è®¡å¯ä»¥æå‡å®¢æˆ·ç«¯æ•´ä½“çš„é²æ£’æ€§å’Œå¯ç”¨æ€§ï¼Œä»¥æ›´å¥½åœ°åº”å¯¹æœåŠ¡ç«¯æˆ–ç½‘ç»œç­‰å„ç§æ•…éšœå’Œå¼‚å¸¸æƒ…å†µï¼Œç¡®ä¿å®¢æˆ·ç«¯åœ¨é¢ä¸´è¿™äº›é—®é¢˜æ—¶ä»ç„¶èƒ½å¤Ÿæä¾›æœ‰é™çš„æœåŠ¡ï¼Œä¿æŒè‰¯å¥½çš„ç”¨æˆ·ä½“éªŒã€‚å› æ­¤ï¼Œå®¢æˆ·ç«¯çš„å®¹é”™è®¾è®¡å¾€å¾€ä¹Ÿå’Œäº§å“ç­–ç•¥æ¯æ¯ç›¸å…³ï¼Œè€Œä¸åŒçš„äº§å“ç­–ç•¥æœ€ç»ˆä¹Ÿä¼šå½±å“æŠ€æœ¯æ–¹æ¡ˆçš„é€‰æ‹©ï¼Œæ¯”å¦‚ï¼š</p>
<ol>
<li>é¦–é¡µæ— è®ºåœ¨å‡ºç°å“ªç±»å¼‚å¸¸éƒ½ä¸åº”è¯¥æŒ‚æ‰ï¼Œé‚£ä¹ˆï¼Œæˆ‘ä»¬åœ¨è®¾è®¡é˜¶æ®µå°±åº”è¯¥å……åˆ†è€ƒè™‘è¯·æ±‚å¤±è´¥ç­‰å¼‚å¸¸æƒ…å†µä¸‹å¦‚ä½•è¿›è¡Œå…œåº•å±•ç¤º</li>
<li>å¤§æµé‡åœºæ™¯å¯èƒ½é‡åˆ°é™æµç­‰å¼‚å¸¸ï¼Œå¯ä»¥é€šè¿‡è®¾è®¡ç­‰å¾…é¡µé¢æˆ–è€…æ’é˜ŸåŠ¨ç”»é¿å…æµç¨‹ä¸­æ–­ï¼ˆæ¯”å¦‚æ“ä½œäº†ä¸€åŠè¿›å…¥é”™è¯¯é¡µé¢ï¼‰ã€å‡è½»ç”¨æˆ·ç­‰å¾…çš„ç„¦è™‘æ„Ÿ</li>
<li>éšç€ç‰ˆæœ¬çš„æŒç»­è¿­ä»£ï¼Œæ—§ç‰ˆæœ¬APPçš„ç”¨æˆ·æ˜¯å¦è¿˜èƒ½æ­£å¸¸ä½¿ç”¨äº§å“æœåŠ¡</li>
</ol>
<p>è®¾è®¡æ˜ç¡®çš„å‰åç«¯äº¤äº’åè®®æœ‰åŠ©äºæ›´å¥½åœ°è§£å†³ä¸Šè¿°é—®é¢˜ï¼š</p>
<ul>
<li><strong>é”™è¯¯å¤„ç†å’Œå®¹é”™æœºåˆ¶</strong>ï¼šé€šè¿‡è§„å®šç»Ÿä¸€çš„é”™è¯¯ç å’Œé”™è¯¯ä¿¡æ¯ä¼ é€’æ–¹å¼ï¼Œä½¿APPèƒ½å¤Ÿæ•è·å’Œå¤„ç†å„ç§é”™è¯¯æƒ…å†µï¼ŒåŒ…æ‹¬ç½‘ç»œé”™è¯¯ã€æœåŠ¡ç«¯é”™è¯¯ã€æ•°æ®æ ¼å¼é”™è¯¯ç­‰ï¼Œè¿™æœ‰åŠ©äºå®¢æˆ·ç«¯å®ç°ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æ–¹æ³•ä»¥åº”å¯¹å„ç§å¼‚å¸¸æƒ…å†µ</li>
<li><strong>ç‰ˆæœ¬å…¼å®¹æ€§</strong>ï¼šé€šè¿‡ç‰ˆæœ¬æ§åˆ¶ï¼Œå¯ä»¥ç¡®ä¿åœ¨æœåŠ¡ç«¯å‡çº§æˆ–ä¿®æ”¹æ¥å£æ—¶ä¸ä¼šå½±å“ç°æœ‰çš„APPç‰ˆæœ¬ï¼Œä¿æŒå…¼å®¹æ€§ï¼›ä¹Ÿå¯ä»¥é€šè¿‡ç‰ˆæœ¬æ§åˆ¶ï¼Œæé†’ç”¨æˆ·æˆ–è€…å¼ºåˆ¶ç”¨æˆ·å‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬çš„APP</li>
<li><strong>é€šä¿¡å®‰å…¨</strong>ï¼šé€šè¿‡å®šä¹‰åŠ å¯†å’Œè®¤è¯è§„èŒƒï¼Œä»¥ç¡®ä¿é€šä¿¡çš„å®‰å…¨æ€§ï¼Œè¿™æœ‰åŠ©äºé˜²æ­¢æ•°æ®æ³„éœ²å’Œä¸­é—´äººæ”»å‡»ï¼Œæé«˜ç³»ç»Ÿçš„å¯é æ€§å’Œå®‰å…¨æ€§</li>
</ul>
<h2 id="3-4-å…¨é“¾è·¯å‹æµ‹"><a href="#3-4-å…¨é“¾è·¯å‹æµ‹" class="headerlink" title="3.4 å…¨é“¾è·¯å‹æµ‹"></a>3.4 å…¨é“¾è·¯å‹æµ‹</h2><p>ç±»ä¼¼ã€ŒièŒ…å°ã€è¿™æ ·å¤§å‹çš„ç”µå•†ç³»ç»Ÿï¼Œå…·æœ‰ä¸šåŠ¡åœºæ™¯å¤æ‚ã€æ ¸å¿ƒé“¾è·¯é•¿çš„ç‰¹ç‚¹ï¼Œé€šè¿‡ä¼ ç»Ÿçš„æµ‹è¯•æ–¹æ³•åœ¨æµ‹è¯•ç¯å¢ƒè¿›è¡Œå‹æµ‹ï¼Œå·²ç»éš¾ä»¥ç¡®ä¿ç³»ç»Ÿåœ¨é«˜è´Ÿè½½å’Œæç«¯åœºæ™¯ä¸‹çš„æ€§èƒ½ã€å¯ç”¨æ€§å’Œç¨³å®šæ€§äº†ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦å¼•å…¥å…¨é“¾è·¯å‹æµ‹ã€‚</p>
<p>å…¨é“¾è·¯å‹æµ‹æ˜¯åœ¨ç”Ÿäº§ç¯å¢ƒä¸­åŸºäºçœŸå®çš„ä¸šåŠ¡åœºæ™¯æ¨¡æ‹Ÿç”¨æˆ·æ“ä½œå’Œæµé‡ï¼Œä»¥å¯¹æ•´æ¡ä¸šåŠ¡é“¾è·¯è¿›è¡Œå‹åŠ›æµ‹è¯•ï¼Œä»è€Œè¯†åˆ«æ½œåœ¨çš„æ€§èƒ½ç“¶é¢ˆæˆ–å¼‚å¸¸ï¼Œæœ‰åŠ©äºæˆ‘ä»¬åŠæ—¶å‘ç°å¹¶è§£å†³ï¼Œç¡®ä¿ç³»ç»Ÿçš„é«˜æ€§èƒ½ã€é«˜å¯ç”¨å’Œç¨³å®šæ€§ã€‚</p>
<p>è¦å®ç°ç”Ÿäº§ç¯å¢ƒå…¨é“¾è·¯å¯å‹æµ‹ï¼Œé™¤äº†å‰æ–‡æåˆ°çš„APMã€æ—¥å¿—å¹³å°ç­‰ç›‘æ§è¯Šæ–­å·¥å…·ä¹‹å¤–ï¼Œè¿˜éœ€è¦å…·å¤‡ä»¥ä¸‹èƒ½åŠ›ï¼š</p>
<ul>
<li><strong>å…¨é“¾è·¯æµé‡æ ‡è®°é€ä¼ èƒ½åŠ›</strong>ï¼šé€šè¿‡å…¨é“¾è·¯æ”¯æŒå‹æµ‹æµé‡æ ‡è®°è¯†åˆ«å’Œä¼ é€’ï¼Œä½¿çº¿ä¸Šå…¨é“¾è·¯èƒ½åŒºåˆ†å‹æµ‹æµé‡å’ŒçœŸå®ç”¨æˆ·æµé‡ï¼Œä¿è¯åœ¨å¤§æµé‡å‹åŠ›æµ‹è¯•æ—¶ä¸ä¼šå¯¹çœŸå®ç”¨æˆ·ä½“éªŒä»¥åŠçœŸå®ç”¨æˆ·æ•°æ®é€ æˆå½±å“ï¼Œè§£å†³äº†å› ç¯å¢ƒå·®å¼‚é€ æˆå‹æµ‹ç»“æœä¸çœŸå®ï¼Œå¯ä»¥å……åˆ†éªŒè¯çº¿ä¸ŠæœåŠ¡åœ¨å¤§æµé‡ä¸‹çš„æ‰¿è½½èƒ½åŠ›</li>
<li><strong>æ•°æ®å­˜å‚¨è·¯ç”±</strong>ï¼šä½¿æ•°æ®åº“ã€ç¼“å­˜ã€MQã€æ—¥å¿—ç­‰å­˜å‚¨ä»‹è´¨å¯ä»¥è¯†åˆ«å‹æµ‹æµé‡ï¼Œå°†å‹æµ‹äº§ç”Ÿçš„æ•°æ®ä¸çœŸå®ç”¨æˆ·æ•°æ®åˆ†å¼€ä¿å­˜ï¼Œå®ç°å­˜å‚¨éš”ç¦»ï¼Œä¸ºçº¿ä¸Šå‹æµ‹æä¾›æ•°æ®å®‰å…¨ä¿éšœ</li>
<li><strong>å‹æµ‹å¹³å°</strong>ï¼šæä¾›åˆ†å¸ƒå¼é«˜å¹¶å‘å‹æµ‹èƒ½åŠ›ï¼Œæ”¯æŒä¸Šåƒå°å‹æµ‹æœºåŒæ—¶å‘å‡ºå‹æµ‹æµé‡ã€æ¨¡æ‹Ÿåƒä¸‡çº§ç”¨æˆ·è®¿é—®ï¼Œæ”¯æŒå¤§æµé‡ä¸‹çš„å‹æµ‹ç»“æœåˆ†æ</li>
</ul>
<p>å…¨é“¾è·¯å‹æµ‹è¦æ±‚æŠ€æœ¯å›¢é˜Ÿè¿›è¡Œæ›´é«˜æ•ˆçš„ååŒï¼Œå› æ­¤ï¼Œé™¤äº†å·¥å…·å’Œèƒ½åŠ›å±‚é¢çš„æ”¯æŒï¼Œå›¢é˜Ÿçš„æˆç†Ÿåº¦ä¹Ÿæ˜¯å½±å“è¿™é¡¹å·¥ä½œèƒ½å¦é¡ºåˆ©å¼€å±•çš„å…³é”®å› ç´ ï¼š</p>
<ul>
<li><strong>æ˜ç¡®æ ¸å¿ƒé“¾è·¯</strong>ï¼šéœ€è¦å…±åŒæ˜ç¡®å“ªäº›æ˜¯éœ€è¦é‡ç‚¹ä¿éšœçš„åœºæ™¯ï¼Œå¹¶é€šè¿‡ä¸šåŠ¡æ¢³ç†æ˜ç¡®æ¯ä¸ªåœºæ™¯å¯¹åº”çš„æ ¸å¿ƒé“¾è·¯</li>
<li><strong>å®¹é‡è§„åˆ’ä¸æµé‡æ¨¡å‹è®¾è®¡</strong>ï¼šç»“åˆäº§å“è¿è¥è®¡åˆ’ï¼Œå¯¹æ¯ä¸ªåœºæ™¯çš„æµé‡è¿›è¡Œé¢„ä¼°ä¸æ‹†è§£ï¼Œæ˜ç¡®æ ¸å¿ƒé“¾è·¯ä¸Šå„ä¸ªç³»ç»Ÿçš„æ€§èƒ½æŒ‡æ ‡ã€å®¹é‡æŒ‡æ ‡ã€SLAä»¥åŠå„è‡ªçš„å¼ºå¼±ä¾èµ–ï¼ˆåŒ…æ‹¬ç¬¬ä¸‰æ–¹æœåŠ¡ï¼Œå¦‚å„ç±»äº‘æœåŠ¡ï¼‰ï¼Œå¹¶æ˜ç¡®å¯¹ä¾èµ–æ–¹çš„æ€§èƒ½è¦æ±‚åŠé™çº§é¢„æ¡ˆ</li>
<li><strong>é™æµé…ç½®åŠé¢„æ¡ˆåˆ¶å®š</strong>ï¼šç»“åˆå„ä¸ªç³»ç»Ÿçš„æ€§èƒ½æŒ‡æ ‡å’Œå®¹é‡æŒ‡æ ‡ï¼Œæ˜ç¡®é™æµç­–ç•¥åŠé™æµå€¼ï¼Œæ¢³ç†å¯èƒ½å‡ºç°çš„å¼‚å¸¸åœºæ™¯å¹¶åˆ¶å®šé’ˆå¯¹æ€§çš„é¢„æ¡ˆï¼ˆå¦‚é™çº§ã€ç†”æ–­ç­‰ï¼‰</li>
<li><strong>å‹æµ‹æ‰§è¡ŒåŠé¢„æ¡ˆæ¼”ç»ƒ</strong>ï¼šå®šæœŸç»„ç»‡å…¨é“¾è·¯å‹æµ‹å¹¶åœ¨å‹æµ‹å‰ã€å‹æµ‹ä¸­è¿›è¡Œé¢„æ¡ˆæ¼”ç»ƒ</li>
<li><strong>ç›‘æ§ä¸æŠ¥è­¦</strong>ï¼šæ¯ä¸ªç³»ç»Ÿéœ€è¦åœ¨å„è‡ªçš„å…³é”®é“¾è·¯ä¸Šè®¾ç½®ç›‘æ§å’ŒæŠ¥è­¦ï¼Œä»¥ä¾¿åœ¨å‹æµ‹æœŸé—´èƒ½å®æ—¶ç›‘æµ‹æ€§èƒ½åŠå¼‚å¸¸ï¼Œå¹¶èƒ½å¤Ÿè¿›è¡Œå¿«é€Ÿå“åº”</li>
<li><strong>ç»“æœåˆ†æ</strong>ï¼šåˆ†æå¹¶è§£é‡Šå‹æµ‹ç»“æœï¼Œè¯†åˆ«é¢„æ¡ˆåŠç›‘æ§æŠ¥è­¦æ˜¯å¦æœ‰æ•ˆï¼Œè¯†åˆ«æ˜¯å¦å­˜åœ¨æ½œåœ¨çš„æ€§èƒ½é—®é¢˜å’Œä¼˜åŒ–æœºä¼šï¼Œæœ€ç»ˆäº§å‡ºå‹æµ‹æŠ¥å‘Š</li>
<li><strong>æ”¹è¿›ä¼˜åŒ–</strong>ï¼šå„ä¸ªå›¢é˜Ÿæ ¹æ®å‹æµ‹æŠ¥å‘Šè®¨è®ºå¹¶å®æ–½ä¼˜åŒ–ç­–ç•¥</li>
<li><strong>å¸¸æ€åŒ–åŸºçº¿å‹æµ‹åŠæ€§èƒ½å·¡æ£€</strong>ï¼šå»ºç«‹å¸¸æ€åŒ–æœºåˆ¶ï¼Œå®šæœŸå¯¹ç³»ç»Ÿè¿›è¡Œæ€§èƒ½æµ‹è¯•ä»¥å»ºç«‹æ€§èƒ½åŸºçº¿ï¼Œä»¥ä¾¿äº†è§£ç³»ç»Ÿåœ¨æ­£å¸¸å·¥ä½œè´Ÿè½½ä¸‹çš„æ€§èƒ½æŒ‡æ ‡ï¼›å®šæœŸç›‘æµ‹å’Œè¯„ä¼°ç³»ç»Ÿçš„æ€§èƒ½ï¼Œä»¥ä¾¿åŠæ—©å‘ç°å’Œè§£å†³æ€§èƒ½é—®é¢˜</li>
</ul>
<h2 id="3-5-å°ç»“"><a href="#3-5-å°ç»“" class="headerlink" title="3.5 å°ç»“"></a>3.5 å°ç»“</h2><p>è¦å®ç°ç³»ç»Ÿçš„é«˜å¯ç”¨æ€§ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ç³»ç»Ÿæ¶æ„å’Œè®¾è®¡é˜¶æ®µå……åˆ†è€ƒè™‘å„ç§æ•…éšœå’Œå¼‚å¸¸åœºæ™¯ï¼ŒåŒ…æ‹¬ç¡¬ä»¶æ•…éšœã€ç½‘ç»œä¸­æ–­ã€è½¯ä»¶é”™è¯¯ç­‰ï¼Œé€šè¿‡å‡å°‘ä¾èµ–ã€å¼•å…¥å†—ä½™å’Œå¤‡ä»½ã€å®ç°è‡ªåŠ¨æ•…éšœæ£€æµ‹ä¸æ¢å¤ã€å¢åŠ é™æµåŠåº”æ€¥é¢„æ¡ˆã€å¼•å…¥ç›‘æ§æŠ¥è­¦æœºåˆ¶ç­‰ç­–ç•¥æ¥å‡è½»çªå‘æµé‡æˆ–æ•…éšœå¯¹ç³»ç»Ÿäº§ç”Ÿçš„å½±å“ï¼Œç¡®ä¿åœ¨éƒ¨åˆ†ç»„ä»¶æˆ–æœåŠ¡æ•…éšœæ—¶ç³»ç»Ÿä»ç„¶èƒ½å¤Ÿç»§ç»­æä¾›æœåŠ¡ï¼ŒåŒæ—¶æˆ‘ä»¬ä¹Ÿå¿…è¦å€ŸåŠ©å…¨é“¾è·¯å‹æµ‹ç­‰æ‰‹æ®µè¯†åˆ«æ½œåœ¨çš„é—®é¢˜ä»¥ç¡®ä¿ä¸Šè¿°ç­–ç•¥æ˜¯æŒç»­æœ‰æ•ˆçš„ã€‚</p>
<h2 id="4-æ€»ç»“"><a href="#4-æ€»ç»“" class="headerlink" title="4 æ€»ç»“"></a>4 æ€»ç»“</h2><p>ã€ŒièŒ…å°ã€å•†åŸä½œä¸ºèŒ…å°é…’çº¿ä¸Šé”€å”®çš„ä¸»è¦å…¥å£ï¼Œä»è¯ç”Ÿçš„ç¬¬ä¸€å¤©å¼€å§‹å°±éœ€è¦è€ƒè™‘å¦‚ä½•æœ‰æ•ˆåœ°åº”å¯¹å¤§æµé‡é«˜å¹¶å‘çš„è€ƒéªŒï¼Œè¿™è¦æ±‚æˆ‘ä»¬åœ¨ä¿è¯æ•°æ®ä¸€è‡´æ€§çš„å‰æä¸‹ï¼Œå®ç°ç³»ç»Ÿçš„é«˜æ€§èƒ½å’Œé«˜å¯ç”¨ï¼Œå…¶ä¸­é«˜æ€§èƒ½æ„å‘³ç€æ›´å¿«çš„å“åº”æ—¶é—´å’Œæ›´å¤§çš„ååé‡ï¼Œå¯ä»¥åŒæ—¶ä¸ºæ›´å¤šçš„ç”¨æˆ·æä¾›æµç•…çš„æœåŠ¡ï¼Œè€Œé«˜å¯ç”¨åˆ™æ„å‘³ç€ç³»ç»Ÿéœ€è¦åœ¨é¢ä¸´æ•…éšœæˆ–å¼‚å¸¸æƒ…å†µæ—¶ä»ç„¶ä¿æŒå¯ç”¨æ€§ã€‚</p>
<p>ä¸ºäº†å®ç°ç³»ç»Ÿçš„é«˜æ€§èƒ½å’Œé«˜å¯ç”¨ï¼Œæˆ‘ä»¬éœ€è¦ç»“åˆä¸šåŠ¡è¯‰æ±‚ã€äº§å“è¿è¥æƒ…å†µåŠç³»ç»Ÿç°çŠ¶è¿›è¡Œåˆ†æï¼Œç»¼åˆé€‰å–ä¸€äº›æ€§èƒ½ä¼˜åŒ–æŠ€æœ¯ä¸é«˜å¯ç”¨ç³»ç»Ÿçš„è®¾è®¡æ–¹æ³•ï¼Œä½¿ç³»ç»Ÿåœ¨æ€§èƒ½ã€å¯ç”¨æ€§ã€å®‰å…¨æ€§ã€å¯ç»´æŠ¤æ€§ç­‰æ–¹é¢ä¿æŒä¸€ç§æœ€ä½³çš„å¹³è¡¡çŠ¶æ€ã€‚</p>
<p>æœ¬è´¨ä¸Šï¼Œç³»ç»Ÿçš„æ¶æ„å’Œè®¾è®¡å°±æ˜¯æƒè¡¡å’Œå–èˆçš„è¿‡ç¨‹ï¼Œæƒè¡¡æ€§èƒ½ä¸å¯ç”¨æ€§ã€æˆæœ¬ä¸æ€§èƒ½ã€å®‰å…¨æ€§ä¸ä¾¿åˆ©æ€§ã€æ‰©å±•æ€§ä¸å¤æ‚æ€§ï¼Œä¸åŒçš„ç³»ç»Ÿå¯èƒ½éœ€è¦ä¸åŒçš„æƒè¡¡ï¼Œæœ¬æ–‡å¸Œæœ›é€šè¿‡è¿™äº›å®é™…çš„æ¡ˆä¾‹å¸®åŠ©å¤§å®¶æ›´å¥½åœ°ç†è§£è¿™äº›æŠ€æœ¯å’Œç­–ç•¥ä»¥åŠèƒŒåçš„æƒè¡¡è¿‡ç¨‹ï¼Œä»è€Œå¯ä»¥æ›´å¥½åœ°åº”ç”¨åœ¨æˆ‘ä»¬æ—¥å¸¸çš„è®¾è®¡ä¸å¼€å‘è¿‡ç¨‹ä¸­ã€‚</p>

    
    
  </div>

  

  

</article>
  
  <article class="post">
  <header class="post-header">
    <h1 class="post-title">
      
      <a class="post-link" href="/2025/01/22/%E7%BD%91%E6%98%93%E7%89%9B%E9%A9%AC%E6%97%A5%E5%BF%97-week8/">ç½‘æ˜“ç‰›é©¬æ—¥å¿—-week8</a>
      
    </h1>

    <div class="post-meta">
      <span class="post-time">
        2025-01-22
      </span>
      
      
      
    </div>
  </header>

  

  <div class="post-content">
    
    
    

    
    <blockquote>
<p>System.out.println(â€œI am backâ€);</p>
</blockquote>
<h2 id="éœ€æ±‚10ï¼šä¿„ç½—æ–¯å°åº¦å…¬å¸çš„åç«¯æ”¹é€ "><a href="#éœ€æ±‚10ï¼šä¿„ç½—æ–¯å°åº¦å…¬å¸çš„åç«¯æ”¹é€ " class="headerlink" title="éœ€æ±‚10ï¼šä¿„ç½—æ–¯å°åº¦å…¬å¸çš„åç«¯æ”¹é€ "></a>éœ€æ±‚10ï¼šä¿„ç½—æ–¯å°åº¦å…¬å¸çš„åç«¯æ”¹é€ </h2><h3 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h3><p>ä¸ºäº†èƒ½å°½å¿«ä¸°å¯Œé¡µé¢å®ç°seoï¼Œä¼˜å…ˆå¼€æ”¾æ•°æ®ç»„åˆšæŒ–æ˜å‡ºæ¥çš„ä¿„ç½—æ–¯å°åº¦å…¬å¸è¯¦ç»†ä¿¡æ¯ï¼Œå½“å­˜é‡ä¸è¶³çš„æ—¶å€™å†å»æŒ‰ç…§åŸæœ‰é€»è¾‘å¼€æ”¾æ™®é€šå…¬å¸ã€‚æ­¤å¤–ä¸ºäº†ä¼˜åŒ–å…¨çƒæœå˜åŠ¨å¯¼è‡´çš„é¡µé¢å¤±æ•ˆï¼Œéœ€è¦åœ¨å‡ºæµ·é¡¹ç›®çš„esé‡Œé¢ä¿å­˜ä¸€ä»½å‰¯æœ¬ï¼Œå¦åˆ™ä¼šå½±å“è°·æ­Œæ”¶å½•ã€‚</p>
<h3 id="æ”¹è¿›ç»“æ„"><a href="#æ”¹è¿›ç»“æ„" class="headerlink" title="æ”¹è¿›ç»“æ„"></a>æ”¹è¿›ç»“æ„</h3><div style="text-align: center;">
  <img src="../img/netease/1736739033864.svg" alt="åç«¯æ¶æ„">
</div>

<p>åˆ†ä¸ºä¸¤ä¸ªæ–¹é¢å–æ•°æ®ï¼Œå…¨çƒæœå’Œæ‰©å±•esï¼Œæ‰©å±•esæ´—äº†ä¸€äº›ä¿„ç½—æ–¯å°åº¦å…¬å¸çš„æ‹“å±•ä¿¡æ¯ç”¨äºå±•ç¤ºï¼Œä¸å…¨çƒæœä¸»é”®idå…³è”ï¼Œä»è€Œå¯ä»¥ç»„è£…èµ·æ¥ä½œä¸ºä¸€ä¸ªæ›´å¤§çš„boã€‚ä½†æ˜¯å¦‚æœå½“å…¬å¸å¼€æ”¾ä¹‹åï¼Œå…¨çƒæœesæœ‰å˜åŠ¨å¯¼è‡´æ— æ³•è®¿é—®å°±ä¼šä¸¥é‡å½±å“è°·æ­Œæ”¶å½•ã€‚æ‰€ä»¥éœ€è¦æ›´æ”¹ä¿å­˜é€»è¾‘ï¼Œç›´æ¥åœ¨æ¯æ—¥æ–°å¢ä¸­æ‰§è¡Œç»„è£…ï¼Œå¦‚æœæ­¤æ—¶å…¨çƒæœæœ‰é‚£å°±ä¿ç•™ï¼Œä¸”å†™å›æ‰©å±•ç´¢å¼•ä¸­ã€‚å¦‚æœæ²¡æœ‰å°±è·³è¿‡ï¼Œè¿™æ ·ä»¥æ¥æ‰€æœ‰çš„ä¿¡æ¯å…¨éƒ¨éƒ½æŒä¹…åŒ–åˆ°æ‰©å±•esä¸­ï¼Œç”¨å…¬å¼å†™å°±æ˜¯Aï¼ˆå…¨çƒæœï¼‰+Bï¼ˆæ‰©å±•ï¼‰-&gt;ABï¼ˆç»„è£…åçš„å¤§å¯¹è±¡ï¼‰-&gt;å†™å›æ‰©å±•esã€‚</p>
<h3 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h3><ul>
<li>sourceBuilderæ„é€ ï¼šæŸ¥è¯¢æŒ‡å®šå›½å®¶ï¼Œæ ¹æ®è´¨é‡åˆ†æ•°å€’åºæ’åºï¼Œä½†æ˜¯è¿™æ ·é¡ºåºå¼€æ”¾ä¼šå¯¼è‡´é‡å¤æ‰«æçš„è¶Šæ¥è¶Šå¤šï¼Œåç»­ä¸€ä¸ªå°æ—¶æœ‰å¯èƒ½éƒ½è·‘ä¸å®Œäº†ã€‚</li>
<li>æŸ¥è¯¢å¼€æ”¾å…¬å¸çš„æœ€å¤§dataIdï¼Œç„¶åè¿½åŠ dataIdï¼Œå¾—åˆ°åŸå§‹è¾“å…¥Listã€‚</li>
<li>æ¥ä¸‹æ¥è¦ä¸€ä¸ªä¸ªå»è¯·æ±‚å…¨çƒæœå»ç»„è£…ä¸€ä¸ªæ›´å¤§çš„å¯¹è±¡ï¼Œå¦‚æœè¿”å›æœ‰é—®é¢˜å°±è¿‡æ»¤æ‰ä¸å…¥åº“ï¼Œè¿”å›æ— é—®é¢˜å°±ç›´æ¥upsertæ‹“å±•ç´¢å¼•ã€‚</li>
<li>æœ€åä½œä¸ºå¼€æ”¾å…¬å¸å†™å…¥æ•°æ®åº“</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ã€ä¿„ç½—æ–¯ã€å°åº¦ã€‘extendIndexç»„åˆå…¨çƒæœbaseä¿¡æ¯é‡æ–°å†™å…¥</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> country</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> param</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">upsertExtendDetailToDbAndEs</span><span class="params">(String country, String param)</span> &#123;</span><br><span class="line">    <span class="type">BoolQueryBuilder</span> <span class="variable">boolQuery</span> <span class="operator">=</span> QueryBuilders.boolQuery();</span><br><span class="line">    boolQuery.must(QueryBuilders.termQuery(<span class="string">&quot;standardCountry&quot;</span>, country));</span><br><span class="line">    <span class="type">SearchSourceBuilder</span> <span class="variable">sourceBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchSourceBuilder</span>()</span><br><span class="line">            .query(boolQuery)</span><br><span class="line">            .fetchSource(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;companyId&quot;</span>,<span class="string">&quot;name&quot;</span>&#125;, <span class="literal">null</span>)</span><br><span class="line">            .sort(<span class="string">&quot;dataQualityScore&quot;</span>,SortOrder.DESC)</span><br><span class="line">            .size(Integer.parseInt(param));</span><br><span class="line">    <span class="comment">//ä»esä¸­æŠ½å–æŒ‡å®šæ•°é‡çš„companyList</span></span><br><span class="line">    List&lt;SiteMapCompanyEntity&gt; originalCompanyList = loadCompanyToExtendIndex(companyExtendIndex, sourceBuilder, param);</span><br><span class="line">    <span class="comment">//è¿‡æ»¤å…¨çƒæœä¸å¼€æ”¾çš„å…¬å¸</span></span><br><span class="line">    List&lt;SiteMapCompanyEntity&gt; filterCompanyList = originalCompanyList.stream().filter(<span class="built_in">this</span>::filterAndUpsertCompanyExtendIndex).collect(Collectors.toList());</span><br><span class="line">    <span class="comment">//ä¿å­˜è¿›db</span></span><br><span class="line">    saveBatch(filterCompanyList);</span><br><span class="line">    log.info(<span class="string">&quot;upsertExtendDetailToDbAndEs success record &#123;&#125;&quot;</span>,filterCompanyList.size());</span><br><span class="line">    <span class="keyword">return</span> filterCompanyList.size();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ã€å…¶ä»–å›½å®¶ã€‘extendIndexç»„åˆå…¨çƒæœbaseä¿¡æ¯é‡æ–°å†™å…¥</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> param è¡¥é½æ¡æ•°</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">upsertNormalDetailToDbAndEs</span><span class="params">(String param)</span> &#123;</span><br><span class="line">    <span class="comment">// æœ‰åŸŸåçš„æ’å‰é¢(å¼ºåˆ¶æ’åº)</span></span><br><span class="line">    <span class="type">Script</span> <span class="variable">hasDomainScript</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Script</span>(<span class="string">&quot;if(doc[&#x27;domainCount&#x27;].size()&gt;0 &amp;&amp; doc[&#x27;domainCount&#x27;].value&gt;=1) return 1; else return 0&quot;</span>);</span><br><span class="line">    <span class="comment">// åŸŸåæ— æ•ˆçš„åç½®(å¼ºåˆ¶æ’åº)</span></span><br><span class="line">    <span class="type">Script</span> <span class="variable">invalidDomainScript</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Script</span>(<span class="string">&quot;if(doc[&#x27;domainStatus&#x27;].size()&gt;0 &amp;&amp; doc[&#x27;domainStatus&#x27;].value&gt;0) return 0; else return 1&quot;</span>);</span><br><span class="line">    <span class="comment">// æœ‰é‚®ç®±å‰ç½®</span></span><br><span class="line">    <span class="type">Script</span> <span class="variable">hasEmailScript</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Script</span>(<span class="string">&quot;if(doc[&#x27;emailCount&#x27;].size()&gt;0 &amp;&amp; doc[&#x27;emailCount&#x27;].value&gt;=1) return 1; else return 0&quot;</span>);</span><br><span class="line">    <span class="type">BoolQueryBuilder</span> <span class="variable">boolQuery</span> <span class="operator">=</span> QueryBuilders.boolQuery();</span><br><span class="line">    boolQuery.must(QueryBuilders.existsQuery(<span class="string">&quot;overviewDescription&quot;</span>));</span><br><span class="line">    boolQuery.must(QueryBuilders.existsQuery(<span class="string">&quot;name&quot;</span>));</span><br><span class="line">    boolQuery.must(QueryBuilders.existsQuery(<span class="string">&quot;companyId&quot;</span>));</span><br><span class="line">    boolQuery.mustNot(QueryBuilders.termQuery(<span class="string">&quot;disable&quot;</span>, <span class="string">&quot;true&quot;</span>));</span><br><span class="line">    boolQuery.must(QueryBuilders.wildcardQuery(<span class="string">&quot;overviewDescription&quot;</span>, <span class="string">&quot;*&quot;</span>));</span><br><span class="line">    <span class="type">SearchSourceBuilder</span> <span class="variable">sourceBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchSourceBuilder</span>()</span><br><span class="line">            .query(boolQuery) <span class="comment">// æŸ¥è¯¢å‚æ•°</span></span><br><span class="line">            .fetchSource(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;name&quot;</span>,<span class="string">&quot;companyId&quot;</span>&#125;,</span><br><span class="line">                    <span class="literal">null</span>)</span><br><span class="line">            .size(<span class="number">1000</span>)</span><br><span class="line">            <span class="comment">// æœ‰æ— åŸŸåæ’åº</span></span><br><span class="line">            .sort(SortBuilders.scriptSort(hasDomainScript, ScriptSortBuilder.ScriptSortType.NUMBER).order(SortOrder.DESC))</span><br><span class="line">            <span class="comment">// æ— æ•ˆåŸŸåæ’åº</span></span><br><span class="line">            .sort(SortBuilders.scriptSort(invalidDomainScript, ScriptSortBuilder.ScriptSortType.NUMBER).order(SortOrder.DESC))</span><br><span class="line">            <span class="comment">// æœ‰é‚®ç®±å‰ç½®</span></span><br><span class="line">            .sort(SortBuilders.scriptSort(hasEmailScript, ScriptSortBuilder.ScriptSortType.NUMBER).order(SortOrder.DESC));</span><br><span class="line">    <span class="comment">//ä»esä¸­æŠ½å–æŒ‡å®šæ•°é‡çš„companyList</span></span><br><span class="line">    List&lt;SiteMapCompanyEntity&gt; originalCompanyList = loadCompanyToExtendIndex(openCompanyIndex, sourceBuilder, param);</span><br><span class="line">    <span class="comment">//è¿‡æ»¤å…¨çƒæœä¸å¼€æ”¾çš„å…¬å¸</span></span><br><span class="line">    List&lt;SiteMapCompanyEntity&gt; filterCompanyList = originalCompanyList.stream().filter(<span class="built_in">this</span>::filterAndUpsertCompanyExtendIndex).collect(Collectors.toList());</span><br><span class="line">    <span class="comment">//ä¿å­˜è¿›db</span></span><br><span class="line">    saveBatch(filterCompanyList);</span><br><span class="line">    log.info(<span class="string">&quot;upsertNormalDetailToDbAndEs success record &#123;&#125;&quot;</span>,filterCompanyList.size());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æŸ¥è¯¢ç´¢å¼•å¹¶è½¬æ¢ä¸ºæ•°æ®åº“é€»è¾‘ï¼Œè¾“å‡ºæ˜¯å®é™…æ–°å¢å¼€æ”¾å…¬å¸ï¼Œå°å¾ªç¯ç”¨setå»é‡ï¼Œå¤§å¾ªç¯ç›´æ¥å»æ•°æ®åº“count&gt;0å»é‡ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é€šç”¨æ–°å¢å¼€æ”¾å…¬å¸é€»è¾‘</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> abstractIndex esç´¢å¼•</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> sourceBuilder esæŸ¥è¯¢æ¡ä»¶</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> param æŸ¥è¯¢æ•°é‡</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> å®é™…æ–°å¢å¼€æ”¾å…¬å¸List</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &lt;T&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; List&lt;SiteMapCompanyEntity&gt; <span class="title function_">loadCompanyToExtendIndex</span><span class="params">(AbstractIndex&lt;T&gt; abstractIndex,SearchSourceBuilder sourceBuilder,String param)</span>&#123;</span><br><span class="line">    <span class="type">SiteMapCompanyEntity</span> <span class="variable">maxCompany</span> <span class="operator">=</span> getMaxDataId();</span><br><span class="line">    <span class="type">long</span> <span class="variable">maxDataId</span> <span class="operator">=</span> maxCompany == <span class="literal">null</span> ? <span class="number">1</span> : maxCompany.getDataId();</span><br><span class="line">    <span class="type">AtomicInteger</span> <span class="variable">count</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>();</span><br><span class="line">    count.incrementAndGet();</span><br><span class="line">    List&lt;SiteMapCompanyEntity&gt; addList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    abstractIndex.scrollSearch(sourceBuilder, searchHits -&gt; &#123;</span><br><span class="line">        Set&lt;String&gt; companyIdSets = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (SearchHit searchHit : searchHits) &#123;</span><br><span class="line">            <span class="keyword">if</span> (addList.size() &gt;= Integer.parseInt(param)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            Map&lt;String, Object&gt; result = searchHit.getSourceAsMap();</span><br><span class="line">            <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> result.get(<span class="string">&quot;name&quot;</span>).toString();</span><br><span class="line">            <span class="type">String</span> <span class="variable">companyId</span> <span class="operator">=</span> result.get(<span class="string">&quot;companyId&quot;</span>).toString();</span><br><span class="line">            <span class="comment">//æœ¬è½®å»é‡</span></span><br><span class="line">            <span class="keyword">if</span> (companyIdSets.contains(companyId)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            companyIdSets.add(companyId);</span><br><span class="line">            <span class="comment">//å…¨å±€å»é‡</span></span><br><span class="line">            <span class="keyword">if</span> (isOpeningCompany(companyId))&#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//æ•°æ®åº“å¯¹è±¡è½¬æ¢ï¼ŒåŒ…è£…é¦–å­—æ¯ç­‰</span></span><br><span class="line">            <span class="type">SiteMapCompanyEntity</span> <span class="variable">siteMapCompanyEntity</span> <span class="operator">=</span> convertIndexToDbEntity(name, companyId);</span><br><span class="line">            siteMapCompanyEntity.setDataId(maxDataId + count.longValue());</span><br><span class="line">            count.getAndIncrement();</span><br><span class="line">            addList.add(siteMapCompanyEntity);</span><br><span class="line">            log.info(<span class="string">&quot;loadCompanyToExtendIndex add record &#123;&#125;&quot;</span>,JSON.toJSONString(siteMapCompanyEntity));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> addList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ€ååœ¨xxl-jobé‡Œé¢å®šä¹‰å®šæ—¶ä»»åŠ¡ï¼Œå¼€ä¸¤ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œåˆ†åˆ«è¾“å…¥â€Russia|1500â€ï¼Œâ€India|1500â€</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ–°å¢å…¬å¸æ•°æ®</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> param</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@XxlJob(&quot;addExtendToOpenDb&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ReturnT&lt;String&gt; <span class="title function_">addExtendToOpenDb</span><span class="params">(String param)</span> &#123;</span><br><span class="line">    param = StringUtils.isEmpty(param) ? <span class="string">&quot;1500&quot;</span> : param;</span><br><span class="line">    XxlJobLogger.log(<span class="string">&quot;addExtendToOpenDb job start&quot;</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        String[] params = param.split(<span class="string">&quot;\\|&quot;</span>);</span><br><span class="line">        <span class="comment">//å¸¦å›½å®¶å’Œæ•°é‡</span></span><br><span class="line">        <span class="keyword">if</span> (params.length == <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">loadedSize</span> <span class="operator">=</span> siteMapCompanyService.upsertExtendDetailToDbAndEs(params[<span class="number">0</span>], params[<span class="number">1</span>]);</span><br><span class="line">            <span class="type">int</span> <span class="variable">remainSize</span> <span class="operator">=</span> Integer.parseInt(params[<span class="number">1</span>]) - loadedSize;</span><br><span class="line">            <span class="keyword">if</span>(remainSize &gt; <span class="number">0</span>)&#123;</span><br><span class="line">                siteMapCompanyService.upsertNormalDetailToDbAndEs(String.valueOf(remainSize));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (params.length == <span class="number">1</span>) &#123;</span><br><span class="line">            siteMapCompanyService.upsertNormalDetailToDbAndEs(String.valueOf(params[<span class="number">0</span>]));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        XxlJobLogger.log(<span class="string">&quot;addExtendToOpenDb error&quot;</span>);</span><br><span class="line">        log.error(<span class="string">&quot;addExtendToOpenDb error&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">    XxlJobLogger.log(<span class="string">&quot;addExtendToOpenDb job end&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> ReturnT.SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="éœ€æ±‚11ï¼šAIGCèƒ½åŠ›â€”â€”å¤§æ¨¡å‹æ€»ç»“ç½‘é¡µ"><a href="#éœ€æ±‚11ï¼šAIGCèƒ½åŠ›â€”â€”å¤§æ¨¡å‹æ€»ç»“ç½‘é¡µ" class="headerlink" title="éœ€æ±‚11ï¼šAIGCèƒ½åŠ›â€”â€”å¤§æ¨¡å‹æ€»ç»“ç½‘é¡µ"></a>éœ€æ±‚11ï¼šAIGCèƒ½åŠ›â€”â€”å¤§æ¨¡å‹æ€»ç»“ç½‘é¡µ</h2><h3 id="èƒŒæ™¯-1"><a href="#èƒŒæ™¯-1" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h3><p>å‰é¢è¡¥å……çš„æ•°æ®è¿˜æ˜¯æ²¡èƒ½å½±å“seoï¼Œå¯èƒ½æ˜¯å› ä¸ºæ•°æ®ä¸å¤Ÿç‹¬ç‰¹ï¼ŒåŒè´¨æ€§å¤ªå¼ºã€‚å› æ­¤éœ€è¦ç”¨aiæ€»ç»“ä¸€ä¸‹ï¼Œåšå‡ºå·®å¼‚åŒ–çš„å†…å®¹ã€‚</p>
<h3 id="æç¤ºè¯"><a href="#æç¤ºè¯" class="headerlink" title="æç¤ºè¯"></a>æç¤ºè¯</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">The following text is taken from the official website of a company named: [bi-ehealthcare]. </span><br><span class="line">Based on the content provided, generate 6-8 self-questions and answers related to the company&#x27;s information. </span><br><span class="line">The question is information related to the company: the company&#x27;s products, industry, services, address and contact information (telephone, email, etc.), and other points of fact mentioned in the content provided, but not limited to this.</span><br><span class="line">Provide quality responses and avoid general responses such as &quot;Unfortunately, the text does not provide...&quot; . </span><br><span class="line">Avoid interference from privacy policies and cookies, and ensure that the total length of the reply is not less than 500 characters. In particular.</span><br><span class="line">Organize and translate your answers in English, as shown below:</span><br><span class="line">Q1: XXXX,</span><br><span class="line">A1: XXXX,</span><br><span class="line">Q2: XXXX,</span><br><span class="line">A2: XXXX</span><br></pre></td></tr></table></figure>

<h3 id="å¤§æ¨¡å‹çš„åŸç†ï¼ˆæŒ–ä¸ªå‘ã€åç»­ç ”ç©¶ï¼‰"><a href="#å¤§æ¨¡å‹çš„åŸç†ï¼ˆæŒ–ä¸ªå‘ã€åç»­ç ”ç©¶ï¼‰" class="headerlink" title="å¤§æ¨¡å‹çš„åŸç†ï¼ˆæŒ–ä¸ªå‘ã€åç»­ç ”ç©¶ï¼‰"></a>å¤§æ¨¡å‹çš„åŸç†ï¼ˆæŒ–ä¸ªå‘ã€åç»­ç ”ç©¶ï¼‰</h3><p>è¾“å…¥çš„æ˜¯æç¤ºè¯å’ŒåŸŸåï¼Œå¤§æ¨¡å‹ä¼šå»æ ¹æ®åŸŸåè·å¾—htmlé¡µé¢ï¼Œç„¶åæ ¹æ®pythonæŸäº›å·¥å…·å»é€’å½’æŒ–æ˜å­urlå’Œhtmlï¼Œæ‹¼æ¥tokenï¼Œç»“åˆRAGä»è€Œè·å¾—æ›´å¤§è§„æ¨¡çš„è¾“å…¥ï¼Œç„¶åæ ¹æ®æç¤ºè¯å»è°ƒç”¨llama3.2ï¼Œå¾—åˆ°è¾“å‡ºã€‚</p>

    
    
  </div>

  

  

</article>
  
  <article class="post">
  <header class="post-header">
    <h1 class="post-title">
      
      <a class="post-link" href="/2024/12/25/%E7%BD%91%E6%98%93%E7%89%9B%E9%A9%AC%E6%97%A5%E5%BF%97-week5%EF%BC%88%E5%AD%A6%E4%B9%A0%E7%89%88%EF%BC%89/">ç½‘æ˜“ç‰›é©¬æ—¥å¿—-week5ï¼ˆå­¦ä¹ ç‰ˆï¼‰</a>
      
    </h1>

    <div class="post-meta">
      <span class="post-time">
        2024-12-25
      </span>
      
      
      
    </div>
  </header>

  

  <div class="post-content">
    
    
    

    
    <h1 id="é‚®ç®±"><a href="#é‚®ç®±" class="headerlink" title="é‚®ç®±"></a>é‚®ç®±</h1><h2 id="é‚®ç®±æ³¨å†Œ"><a href="#é‚®ç®±æ³¨å†Œ" class="headerlink" title="é‚®ç®±æ³¨å†Œ"></a>é‚®ç®±æ³¨å†Œ</h2><p>ç”¨æˆ·è§†è§’ï¼šè¾“å…¥é‚®ç®±å’Œå¯†ç ï¼ˆæœ‰æ ¡éªŒï¼‰-&gt;å¡«å†™ä¸ªäººä¿¡æ¯-&gt;æ”¶åˆ°ç¡®è®¤é‚®ä»¶-&gt;ç‚¹å‡»è·³è½¬é“¾æ¥</p>
<h3 id="è¾“å…¥é‚®ç®±å’Œå¯†ç ï¼ˆæœ‰æ ¡éªŒï¼‰"><a href="#è¾“å…¥é‚®ç®±å’Œå¯†ç ï¼ˆæœ‰æ ¡éªŒï¼‰" class="headerlink" title="è¾“å…¥é‚®ç®±å’Œå¯†ç ï¼ˆæœ‰æ ¡éªŒï¼‰"></a>è¾“å…¥é‚®ç®±å’Œå¯†ç ï¼ˆæœ‰æ ¡éªŒï¼‰</h3><p>è¾“å…¥é‚®ç®±å¯†ç ï¼Œå‰ç«¯é€šè¿‡æ­£åˆ™è¡¨è¾¾å¼æ ¡éªŒå¯†ç æ ¼å¼ï¼Œåç«¯è¯·æ±‚&#x2F;email&#x2F;checkæ¥æ£€æŸ¥è´¦å·æ˜¯å¦å¯ç”¨ã€‚è¿™é‡Œå¯ç”¨æŒ‡çš„æ˜¯å·²ç»ç‚¹å‡»è¿‡éªŒè¯é‚®ä»¶çš„æˆ–è€…ç”¨oauthå·²ç»æ ¡éªŒè¿‡çš„ã€‚è¿™é‡Œæ²¡æ ¡éªŒè¿‡é‚®ä»¶çš„åº”è¯¥è¿˜æ˜¯å¯ä»¥é‡æ–°å‘èµ·æ³¨å†Œçš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> EmailSignUpCheckResp <span class="title function_">emailSignUpCheck</span><span class="params">(EmailSignupCheckReq emailSignupCheckReq, HttpServletRequest request)</span> &#123;</span><br><span class="line">    <span class="type">EmailSignUpCheckResp</span> <span class="variable">emailSignUpCheckResp</span> <span class="operator">=</span> EmailSignUpCheckResp.builder()</span><br><span class="line">            .emailSignUpCheckStatus(EmailSignUpCheckStatus.UN_SIGN_UP)</span><br><span class="line">            .build();</span><br><span class="line">    <span class="comment">// æ ¡éªŒæ³¨å†Œé‚®ç®±</span></span><br><span class="line">    <span class="type">UserEntity</span> <span class="variable">user</span> <span class="operator">=</span> userServiceImpl.getUserEntityByLoginUsername(emailSignupCheckReq.getEmail());</span><br><span class="line">    <span class="keyword">if</span> (Objects.nonNull(user)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (UserState.OPEN.getCode() == user.getState()) &#123;</span><br><span class="line">            emailSignUpCheckResp.setEmailSignUpCheckStatus(EmailSignUpCheckStatus.ALREADY_VERIFIED);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            emailSignUpCheckResp.setEmailSignUpCheckStatus(EmailSignUpCheckStatus.ALREADY_SIGN_UP);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> emailSignUpCheckResp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="æ³¨å†Œé€»è¾‘-ç¡®è®¤é‚®ä»¶çš„å›è°ƒé€»è¾‘"><a href="#æ³¨å†Œé€»è¾‘-ç¡®è®¤é‚®ä»¶çš„å›è°ƒé€»è¾‘" class="headerlink" title="æ³¨å†Œé€»è¾‘+ç¡®è®¤é‚®ä»¶çš„å›è°ƒé€»è¾‘"></a>æ³¨å†Œé€»è¾‘+ç¡®è®¤é‚®ä»¶çš„å›è°ƒé€»è¾‘</h3><ol>
<li>æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼šcheckæ ¡éªŒçš„æ˜¯æ˜¯å¦æœ‰æ•ˆã€‚è¿™é‡Œæ£€æŸ¥æ˜¯å¦åˆ«çš„æ–¹å¼å·²ç»æ³¨å†Œäº†ï¼ˆé€šè¿‡emailå­—æ®µæŸ¥ï¼‰</li>
<li>æ£€æŸ¥å¯†ç å¼ºåº¦</li>
<li>é‚€è¯·ç ï¼ˆæš‚æ—¶ä¸éœ€è¦ï¼‰</li>
<li>ä¿å­˜ç”¨æˆ·ä¿¡æ¯ï¼ˆä¸¤å¼ è¡¨ï¼Œä¸€å¼ å­˜ç”¨æˆ·å®ä½“ï¼Œå¦ä¸€å¼ å­˜è´¦å·å¯†ç å’Œç›ï¼‰</li>
<li>åŸ‹ç‚¹ä¸ŠæŠ¥</li>
</ol>
<p>è¿™é‡Œæœ€é‡è¦çš„æ˜¯â€œä¿å­˜ç”¨æˆ·ä¿¡æ¯â€ã€‚åœ¨æ³¨å†Œä¹‹åä¼šå…¥åº“è´¦å·å¯†ç ï¼Œä½†æ˜¯æœªæ¿€æ´»ï¼ˆå°±æ˜¯checkæ£€æŸ¥çš„é‚£ä¸ªå­—æ®µï¼Œåªæœ‰ç‚¹å‡»äº†é‚®ä»¶é“¾æ¥æ‰ä¼šæ¥æ”¶åˆ°ï¼‰ã€‚</p>
<p>éšåç”Ÿæˆä¸€ä¸ªUUIDä½œä¸ºå‚æ•°ä¼ ç»™é‚®ä»¶ï¼ŒåŒæ—¶ç¼“å­˜åœ¨redisä¸­ã€‚åœ¨é‚®ä»¶é‡Œé¢æ”¾è¿™ä¸ªé“¾æ¥å’Œå‚æ•°ï¼Œç‚¹å‡»çš„æ—¶å€™è‡ªåŠ¨å°±ä¼šå»è¯·æ±‚â€œ&#x2F;verify&#x2F;email?cs&#x3D;â€ã€‚<br>è¿™ä¸ªæ–¹æ³•ä¼šè§£æåŠ å¯†å‚æ•°ï¼Œä¸redisä¸­è¿›è¡Œæ¯”è¾ƒã€‚æ ¡éªŒæˆåŠŸåæ¿€æ´»ç”¨æˆ·çŠ¶æ€ï¼Œæœ€åèµ°è·å–tokençš„é€»è¾‘ï¼Œé‚£éƒ¨åˆ†ç­‰è®²ç™»å½•çš„æ—¶å€™å†è¯´ã€‚</p>
<h3 id="é‚®ç®±ç›¸å…³"><a href="#é‚®ç®±ç›¸å…³" class="headerlink" title="é‚®ç®±ç›¸å…³"></a>é‚®ç®±ç›¸å…³</h3><p>å‘é€çš„æ˜¯htmlï¼Œè¿™é‡Œç”¨åˆ°äº†FreeMarkerï¼Œæ¨¡æ¿é‡Œé¢åªæœ‰ä¸¤ä¸ªéœ€è¦åŠ¨æ€æ¢çš„ï¼Œä¸€ä¸ªæ˜¯ç§°å‘¼ä¸€ä¸ªæ˜¯å¯¹åº”çš„é‡å®šå‘é“¾æ¥ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String, Object&gt; templateParams = Maps.newHashMap();</span><br><span class="line">templateParams.put(<span class="string">&quot;accountName&quot;</span>, <span class="string">&quot;test&quot;</span>);</span><br><span class="line">templateParams.put(<span class="string">&quot;registerLink&quot;</span>, <span class="string">&quot;https://www.bilibili.com&quot;</span>);</span><br><span class="line"><span class="type">Resource</span> <span class="variable">resource</span> <span class="operator">=</span> resourceLoader.getResource(<span class="string">&quot;classpath:template/&quot;</span>+registerTemplate);</span><br><span class="line"><span class="type">byte</span>[] fileData = FileCopyUtils.copyToByteArray(resource.getInputStream());</span><br><span class="line"><span class="type">String</span> <span class="variable">template</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(fileData, StandardCharsets.UTF_8);</span><br><span class="line">textPart.setContent(template, <span class="string">&quot;text/html;charset=utf-8&quot;</span>);</span><br><span class="line"><span class="keyword">try</span> (<span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(template.getBytes())) &#123;</span><br><span class="line"><span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> FreemarkerUtils.process(inputStream, templateParams);</span><br><span class="line">    System.out.println(content);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åå‘é€é‚®ä»¶é…ç½®å°±å®Œäº†ï¼Œè¿™é‡Œæš‚æ—¶ç”¨çš„æ˜¯gmailï¼Œæœ€åå¾—æ­å»ºå…¬å¸é‚®ä»¶æœåŠ¡å™¨ã€‚</p>
<h3 id="é‚®ç®±ç™»å½•"><a href="#é‚®ç®±ç™»å½•" class="headerlink" title="é‚®ç®±ç™»å½•"></a>é‚®ç®±ç™»å½•</h3><ol>
<li>å„ç§å‚æ•°æ ¡éªŒï¼ŒåŒ…æ‹¬ä¸Šé¢ä¸€ç›´åœ¨è®²çš„æ¿€æ´»çŠ¶æ€ã€‚</li>
<li>å¯†ç æ ¡éªŒï¼ˆæ•°æ®åº“ç›æ˜¯Base64ï¼Œå¯ä»¥åŠ å¯†è§£å¯†çš„ï¼‰ï¼š encode(ç”¨æˆ·è¾“å…¥+Base64Decode(æ•°æ®åº“ç›)) &#x3D;&#x3D; æ•°æ®åº“åŠ å¯†åçš„å¯†ç ã€‚</li>
<li>æ ¡éªŒæˆåŠŸåˆ™ç™»å½•æˆåŠŸï¼Œé¦–å…ˆè§£æipåˆ°å›½å®¶å’Œçœä»½ä¿å­˜ã€‚ç„¶åç”Ÿæˆtokenä½œä¸ºsessionä¿å­˜åœ¨redisé‡Œé¢ï¼Œè®¾å®šè¿‡æœŸæ—¶é—´ä¸º7å¤©ã€‚</li>
<li>å°†tokenè¿”å›ç»™å‰ç«¯ï¼Œæ¯æ¬¡è¯·æ±‚éƒ½è¦æºå¸¦ã€‚</li>
</ol>
<h1 id="oauth"><a href="#oauth" class="headerlink" title="oauth"></a>oauth</h1><h2 id="è°·æ­Œcodeè§£æ"><a href="#è°·æ­Œcodeè§£æ" class="headerlink" title="è°·æ­Œcodeè§£æ"></a>è°·æ­Œcodeè§£æ</h2><p>ç±»ä¼¼å¾®ä¿¡å°ç¨‹åºï¼Œå‰ç«¯å…ˆå»è¯·æ±‚è°·æ­Œç™»å½•ï¼Œè°·æ­Œä¼šè¿”å›ä¸€ä¸ªcodeï¼Œåç«¯æ‹¿åˆ°è¿™ä¸ªcodeå»oauthé‡Œè·å¾—ç”¨æˆ·ç™»å½•ä¿¡æ¯ã€‚æ‹¿è¿™ä¸ªä¿¡æ¯å»ä¸šåŠ¡æ•°æ®åº“é‡ŒæŸ¥è¯¢æ˜¯å¦æœ‰è®°å½•æ¥åˆ¤æ–­æ˜¯æ³¨å†Œè¿˜æ˜¯ç™»å½•ã€‚</p>
<p>å¦‚æœæ²¡æœ‰å®é™…ç”¨æˆ·è¯´æ˜æ˜¯æ³¨å†Œï¼Œå¦‚æœæœ‰è¿˜éœ€è¦åˆ¤æ–­æ³¨å†Œæ–¹å¼æ˜¯å¦æ˜¯oauthï¼Œåˆ†ä¸ºå…¶ä»–æ–¹å¼æ³¨å†Œå’Œç›´æ¥ç™»å½•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> OAuthLoginUser <span class="title function_">getAuthUserInfo</span><span class="params">(OAuthUserInfoReq req)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!oAuthRequestFactory.support().contains(req.getOAuthType().toUpperCase())) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;getAuthUserInfo, source not supported, req: &#123;&#125;&quot;</span>, req);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BizException</span>(<span class="string">&quot;unsupported oauth type&quot;</span>, BizError.ENUM_PARAM_ERR.getCode());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æ‹¿ç€oauthå»è§£æï¼Œè·å¾—ç”¨æˆ·æ•°æ®</span></span><br><span class="line">    <span class="type">AuthRequest</span> <span class="variable">authRequest</span> <span class="operator">=</span> oAuthRequestFactory.create(req.getOAuthType());</span><br><span class="line">    AuthResponse&lt;AuthUser&gt; authResponse = authRequest.login(AuthCallback.builder().code(req.getCode()).build());</span><br><span class="line">    <span class="type">AuthUser</span> <span class="variable">authUserInfo</span> <span class="operator">=</span> authResponse.getData();</span><br><span class="line">    <span class="keyword">if</span> (Objects.isNull(authUserInfo)) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;getAuthUserInfo, authUserInfo is null, req: &#123;&#125;&quot;</span>, req);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BizException</span>(BizError.COMMON_ERR.getName(), BizError.COMMON_ERR.getCode());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç¼“å­˜è·å–çš„ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">accessCode</span> <span class="operator">=</span> CodeUtils.generateOAuthSignupCode();</span><br><span class="line">    redisManager.addOAuthUser(accessCode, authUserInfo);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ¤æ–­å½“å‰OAuthçŠ¶æ€</span></span><br><span class="line">    <span class="type">OAuthType</span> <span class="variable">oAuthType</span> <span class="operator">=</span> OAuthType.of(req.getOAuthType());</span><br><span class="line">    <span class="type">String</span> <span class="variable">userIdentify</span> <span class="operator">=</span> authUserInfo.getUsername();</span><br><span class="line">    OAuthStatus oAuthStatus;</span><br><span class="line">    <span class="type">UserEntity</span> <span class="variable">user</span> <span class="operator">=</span> userServiceImpl.getUserEntityByLoginUsername(userIdentify);</span><br><span class="line">    <span class="comment">//ç”¨æˆ·å®ä½“è¡¨æ²¡æœ‰å°±æ˜¯æ²¡æ³¨å†Œ</span></span><br><span class="line">    <span class="keyword">if</span> (Objects.nonNull(user)) &#123;</span><br><span class="line">        <span class="comment">//æŸ¥æŒ‡å®šæšä¸¾ä¿¡æ¯çš„</span></span><br><span class="line">        <span class="type">UserAuthEntity</span> <span class="variable">auth</span> <span class="operator">=</span> userAuthServiceImpl.getByIdentifier(userIdentify,</span><br><span class="line">                IdentityType.convert(oAuthType).getCode());</span><br><span class="line">        <span class="keyword">if</span> (Objects.nonNull(auth)) &#123;</span><br><span class="line">            <span class="comment">// åŒç§ç±»å‹é‡å¤æ³¨å†Œ</span></span><br><span class="line">            oAuthStatus = OAuthStatus.LOGIN;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// å·²ç»å­˜åœ¨å…¶ä»–æ–¹å¼æ³¨å†Œ</span></span><br><span class="line">            oAuthStatus = OAuthStatus.ANOTHER_SIGNUP_WAY;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        oAuthStatus = OAuthStatus.SIGNUP;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> OAuthLoginUser.convert(authUserInfo, accessCode, oAuthStatus);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å‰ç«¯å¯èƒ½ä¼šæ ¹æ®ä¸‰ç§æšä¸¾å€¼æ¥èµ°ç™»å½•ã€æ³¨å†Œå’Œæç¤ºé€»è¾‘ã€‚</p>
<h3 id="oauthæ³¨å†Œ"><a href="#oauthæ³¨å†Œ" class="headerlink" title="oauthæ³¨å†Œ"></a>oauthæ³¨å†Œ</h3><p>æ³¨å†Œé€»è¾‘åŸºæœ¬ä¸€è‡´ï¼Œå¤šäº†ä¸€ä¸ªä»redisä¸­æŸ¥è¯¢oauthçš„ç”¨æˆ·ä¿¡æ¯çš„è¿‡ç¨‹ï¼ˆä¾‹å¦‚googleä¿å­˜çš„å¤´åƒé“¾æ¥ï¼‰ï¼Œå¦‚æœæ²¡æŸ¥åˆ°å°±æ˜¯éªŒè¯è¶…æ—¶ï¼Œå¦‚æœæŸ¥åˆ°äº†ä½†æ˜¯ç”¨æˆ·ä¸åŒ¹é…å°±æŠ›å¼‚å¸¸ã€‚æœ€åç»™tokenï¼Œç„¶ååˆ é™¤oauthçš„éªŒè¯ä¿¡æ¯ã€‚</p>
<h3 id="oauthç™»å½•"><a href="#oauthç™»å½•" class="headerlink" title="oauthç™»å½•"></a>oauthç™»å½•</h3><p>åŸºæœ¬ä¸€è‡´ï¼Œä¹Ÿæ˜¯å¤šäº†ä¸€ä¸ªä»redisé‡Œé¢æ‹¿accesscodeçš„è¿‡ç¨‹ã€‚</p>

    
    
  </div>

  

  

</article>
  
  <article class="post">
  <header class="post-header">
    <h1 class="post-title">
      
      <a class="post-link" href="/2024/12/25/%E7%BD%91%E6%98%93%E7%89%9B%E9%A9%AC%E6%97%A5%E5%BF%97-week5/">ç½‘æ˜“ç‰›é©¬æ—¥å¿—-week5</a>
      
    </h1>

    <div class="post-meta">
      <span class="post-time">
        2024-12-25
      </span>
      
      
      
    </div>
  </header>

  

  <div class="post-content">
    
    
    

    
    <blockquote>
<p>å†™åœ¨å‰é¢ï¼šç»è¿‡ä¸€ä¸ªæœˆçš„å®ä¹ ï¼Œæˆ‘é€æ¸è§‰å¾—æ²Ÿé€šèƒ½åŠ›å’Œç†è§£èƒ½åŠ›è¿œæ¯”ä»£ç èƒ½åŠ›é‡è¦ã€‚ä¸è®ºæ˜¯åœ¨ç§‘ç ”ç»„ä¼šä¸Šçš„å“‘å£æ— è¨€ï¼Œè¿˜æ˜¯åœ¨å·¥ä½œä¸Šå¯¹æ¥çš„ä¸ƒå˜´å…«èˆŒï¼Œéƒ½æš´éœ²å‡ºäº†æˆ‘è¯­è¨€èƒ½åŠ›çš„æ¬ ç¼ºã€‚æˆ‘ä»åˆä¸­å¼€å§‹å°±çŸ¥é“è¿™æ˜¯æˆ‘çš„çŸ­æ¿ï¼Œä½†æ²¡æƒ³åˆ°æœ‰è¿™ä¹ˆçŸ­ã€‚è¿™ä¹Ÿå†æ¬¡ç»™æˆ‘æ•²å“äº†è­¦é’Ÿï¼Œä¸ç®¡ä½ æ˜¯ä»€ä¹ˆå­¦æœ¯æˆ–è€…æŠ€æœ¯å¤§å¸ˆï¼Œå­¦è¯´è¯å’Œå¬è¯´è¯æ˜¯æœ€åŸºæœ¬çš„ã€‚</p>
</blockquote>
<h2 id="éœ€æ±‚7ï¼šã€å‡ºæµ·é¡¹ç›®ã€‘ipé™æµ"><a href="#éœ€æ±‚7ï¼šã€å‡ºæµ·é¡¹ç›®ã€‘ipé™æµ" class="headerlink" title="éœ€æ±‚7ï¼šã€å‡ºæµ·é¡¹ç›®ã€‘ipé™æµ"></a>éœ€æ±‚7ï¼šã€å‡ºæµ·é¡¹ç›®ã€‘ipé™æµ</h2><p>æ³¨è§£+aop+lua+redis+æ»‘åŠ¨çª—å£é™æµç®—æ³•</p>
<h3 id="æ³¨è§£å’Œaop"><a href="#æ³¨è§£å’Œaop" class="headerlink" title="æ³¨è§£å’Œaop"></a>æ³¨è§£å’Œaop</h3><h4 id="æ³¨è§£"><a href="#æ³¨è§£" class="headerlink" title="æ³¨è§£"></a>æ³¨è§£</h4><p>æ ¹æ®å¤šä¸ªæ—¶é—´å•ä½é…ç½®é™æµå™¨ï¼Œå®šä¹‰äº†æ—¶é—´æšä¸¾ç±»ï¼ŒæŒ‰ç…§æ¯«ç§’å­˜å‚¨æŒç»­æ—¶é—´ï¼ˆå› ä¸ºæ³¨è§£åªèƒ½ç”¨æšä¸¾ï¼Œä¸èƒ½ç”¨æ­£å¸¸ç±»ï¼‰ã€‚</p>
<blockquote>
<p>æ­£å¸¸æ˜¯è¦ä¼ 3ä¸ªå€¼çš„ï¼šæ¬¡æ•°ï¼Œæ—¶é—´å•ä½ï¼Œè¶…æ—¶æ—¶é—´ï¼ˆä¸»è¦æ˜¯ç»™åé¢å¯¹redisè®¾ç½®expireTimeï¼‰ã€‚è¿™é‡Œä¸ºäº†æ–¹ä¾¿è¶…æ—¶æ—¶é—´ä¸æ—¶é—´å•ä½ä¸€è‡´ã€‚</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä½¿ç”¨ç¤ºä¾‹ï¼š1åˆ†é’Ÿé™åˆ¶10æ¬¡ï¼Œ1å°æ—¶é™åˆ¶500æ¬¡</span></span><br><span class="line"><span class="meta">@IpRateLimit(limit = &#123;10,500&#125;, timeUnit = &#123;TimeUnit.MINUTE,TimeUnit.HOUR&#125;)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//æ³¨è§£å®šä¹‰</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(ElementType.METHOD)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> IpRateLimit &#123;</span><br><span class="line">    <span class="type">int</span>[] limit();  <span class="comment">// é™æµå€¼</span></span><br><span class="line">    TimeUnit[] timeUnit();  <span class="comment">// æ—¶é—´å•ä½</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">TimeUnit</span> &#123;</span><br><span class="line">    YEAR(<span class="number">1</span>, <span class="string">&quot;YEAR&quot;</span>, <span class="number">1000L</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span> * <span class="number">30</span> * <span class="number">365</span>),</span><br><span class="line">    MONTH(<span class="number">2</span>, <span class="string">&quot;MONTH&quot;</span>, <span class="number">1000L</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span> * <span class="number">30</span>),</span><br><span class="line">    DAY(<span class="number">3</span>, <span class="string">&quot;DAY&quot;</span>, <span class="number">1000</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span>),</span><br><span class="line">    HOUR(<span class="number">4</span>, <span class="string">&quot;HOUR&quot;</span>, <span class="number">1000</span> * <span class="number">60</span> * <span class="number">60</span>),</span><br><span class="line">    MINUTE(<span class="number">5</span>, <span class="string">&quot;MINUTE&quot;</span>, <span class="number">1000</span> * <span class="number">60</span>),</span><br><span class="line">    SECOND(<span class="number">6</span>, <span class="string">&quot;SECOND&quot;</span>, <span class="number">1000</span>),</span><br><span class="line">    ;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> code;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String name;</span><br><span class="line">    <span class="comment">//å•ä½æ˜¯æ¯«ç§’</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> periodInMills;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="aop"><a href="#aop" class="headerlink" title="aop"></a>aop</h4><p>æ ¡éªŒæ³¨è§£é‡Œä¸¤ä¸ªæ•°ç»„é•¿åº¦å¿…é¡»ç›¸åŒï¼Œå¯¹æ¯ä¸€ä¸ªé…ç½®newä¸€ä¸ªé™æµå™¨æ¥æ‰§è¡Œredisè„šæœ¬ã€‚ï¼ˆæˆ‘åœ¨æƒ³è¿™é‡Œæ¯æ¬¡é™æµå°±newä¸€ä¸ªå¼€é”€ä¼šä¸ä¼šæœ‰ç‚¹å¤§ï¼Œä½†æ˜¯ä¸èƒ½ç”¨@serviceï¼Œå› ä¸ºæœ‰çŠ¶æ€çš„ï¼‰</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IpRateLimiterAspect</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> RedisLuaRateLimiter redisLuaRateLimiter;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Pointcut(&quot;@annotation(com.netease.cowork.sirius.it.data.overseas.server.frame.anno.IpRateLimit)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">rateLimiter</span><span class="params">()</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before(&quot;rateLimiter() &amp;&amp; @annotation(ipLimiter)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doBefore</span><span class="params">(JoinPoint joinPoint, IpRateLimit ipLimiter)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="type">int</span>[] limit = ipLimiter.limit();</span><br><span class="line">        TimeUnit[] timeUnits = ipLimiter.timeUnit();</span><br><span class="line">        <span class="keyword">if</span> (limit.length != timeUnits.length)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è·å–ç”¨æˆ·ip</span></span><br><span class="line">        <span class="type">ServletRequestAttributes</span> <span class="variable">attributes</span> <span class="operator">=</span> (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();</span><br><span class="line">        <span class="keyword">assert</span> attributes != <span class="literal">null</span>;</span><br><span class="line">        <span class="type">HttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> attributes.getRequest();</span><br><span class="line">        <span class="type">String</span> <span class="variable">ip</span> <span class="operator">=</span> request.getRemoteAddr();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; limit.length; i++) &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">periodInMills</span> <span class="operator">=</span> timeUnits[i].getPeriodInMills();</span><br><span class="line">            redisLuaRateLimiter = <span class="keyword">new</span> <span class="title class_">RedisLuaRateLimiter</span>(limit[i], periodInMills, periodInMills,timeUnits[i].getName());</span><br><span class="line">            <span class="keyword">if</span> (!redisLuaRateLimiter.tryAcquired(ip))&#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;æ“ä½œé¢‘ç¹ï¼Œè¯·ç¨åé‡è¯•&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="redis-luaå®ç°æ»‘åŠ¨çª—å£é™æµç®—æ³•"><a href="#redis-luaå®ç°æ»‘åŠ¨çª—å£é™æµç®—æ³•" class="headerlink" title="redis+luaå®ç°æ»‘åŠ¨çª—å£é™æµç®—æ³•"></a>redis+luaå®ç°æ»‘åŠ¨çª—å£é™æµç®—æ³•</h3><p>luaè„šæœ¬åœ¨è¿™é‡Œæœ€å¤§çš„ä½œç”¨å°±æ˜¯è§£å†³å¹¶å‘é—®é¢˜ï¼Œä¸”ä¿è¯åŸå­æ€§ã€‚åˆ†åˆ«è¯´è¿™ä¸ªå‡ ä¸ªå‚æ•°ï¼š</p>
<ul>
<li>KEYS[1]ï¼šString key &#x3D; prefix + ipã€‚ä¸šåŠ¡åç§°+ipã€‚å› ä¸ºå¯èƒ½æœ‰å¤šä¸ªä¸šåŠ¡éƒ½éœ€è¦é™æµã€‚</li>
<li>ARGV[1]ï¼šnow-periodInMillsã€‚æ—¶é—´æ ¡éªŒçš„åˆ†ç•Œçº¿ï¼Œå¾€åä¸ºéœ€è¦è®¡ç®—çš„æµé‡ã€‚</li>
<li>ARGV[2]ï¼šnow</li>
<li>ARGV[3]ï¼šUUID.randomUUID()çœŸæ­£çš„valueå€¼ï¼Œéšä¾¿å†™ä¸€ä¸ª</li>
<li>ARGV[4]ï¼šexpireInMills</li>
<li>ARGV[5]ï¼šlimit</li>
</ul>
<p>åŸºæœ¬åŸç†æ˜¯zsetçš„scoreå­˜æ—¶é—´æˆ³ï¼ŒZREMRANGEBYSCOREè¿™ä¸ªæ–¹æ³•ä¼šå»é™¤0åˆ°now-periodInMillsçš„æ‰€æœ‰å…ƒç´ ï¼Œå‰©ä¸‹çš„å°±æ˜¯è¦ç»Ÿè®¡çš„å…ƒç´ ã€‚ZCARDç”¨æ¥ç»Ÿè®¡å½“å‰å…ƒç´ æ•°é‡ï¼Œå¦‚æœæ¯”countå°å°±æ²¡æœ‰è¾¾åˆ°é™æµï¼ŒZADDè®¾ç½®valueï¼Œscoreå’Œè¶…æ—¶æ—¶é—´ã€‚å¦‚æœé™æµå°±è¿”å›ç‰¹æ®Šæ•°å­—ã€‚<br>æœ€ååªç”¨åˆ¤æ–­luaè„šæœ¬æ‰§è¡Œæ˜¯å¦æ˜¯1æ¥åˆ¤æ–­é™æµã€‚</p>
<p>å…¶ä»–çš„ä»£ç éƒ½æ˜¯javaæ“ä½œluaçš„æ–¹æ³•ï¼Œæ ¸å¿ƒå¦‚ä¸‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//é™æµ</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">REDIS_LIMIT_SCRIPT</span> <span class="operator">=</span> <span class="string">&quot;local removedCount = redis.call(&#x27;ZREMRANGEBYSCORE&#x27;, KEYS[1], 0, ARGV[1])\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;local currentCount = redis.call(&#x27;ZCARD&#x27;, KEYS[1])\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;if currentCount &lt; tonumber(ARGV[5]) then\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;    redis.call(&#x27;ZADD&#x27;, KEYS[1], ARGV[2], ARGV[3])\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;    redis.call(&#x27;PEXPIRE&#x27;, KEYS[1], ARGV[4])\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;    return 1\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;else\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;    return 0\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;end&quot;</span>;</span><br><span class="line"><span class="comment">//ç»Ÿè®¡rate</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">REDIS_LIMIT_COUNT_SCRIPT</span> <span class="operator">=</span> <span class="string">&quot;local removedCount = redis.call(&#x27;ZREMRANGEBYSCORE&#x27;, KEYS[1], 0, ARGV[1])\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;local currentCount = redis.call(&#x27;ZCARD&#x27;, KEYS[1])\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;return currentCount&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>ç»“è®ºæ˜¯å¯¹æ¯”æµ·å…³æœåŠ¡çš„é™æµï¼Œè¿™ç§å†™luaçš„æ–¹æ³•èƒ½å¿«ä¸‰å€ï¼Œé™æµé€Ÿåº¦50msï¼Œä»–ä»¬çš„150msã€‚è€Œä¸”é…ç½®ä¹Ÿå¾ˆç®€å•ã€‚</p>
<h2 id="éœ€æ±‚8ï¼šã€å‡ºæµ·é¡¹ç›®ã€‘sitemapä¸seoä¼˜åŒ–"><a href="#éœ€æ±‚8ï¼šã€å‡ºæµ·é¡¹ç›®ã€‘sitemapä¸seoä¼˜åŒ–" class="headerlink" title="éœ€æ±‚8ï¼šã€å‡ºæµ·é¡¹ç›®ã€‘sitemapä¸seoä¼˜åŒ–"></a>éœ€æ±‚8ï¼šã€å‡ºæµ·é¡¹ç›®ã€‘sitemapä¸seoä¼˜åŒ–</h2><blockquote>
<p><strong>ä»€ä¹ˆæ˜¯seoï¼Ÿ</strong></p>
<p>æœç´¢å¼•æ“ä¼˜åŒ–ï¼ŒæŒ‡çš„æ˜¯é€šè¿‡åˆç†æ‰‹æ®µå’Œä¸€äº›å°æŠ€å·§æå‡åœ¨è°·æ­Œä¸Šé¢çš„æ’åã€‚è¿™ä¸ªå‡ºæµ·é¡¹ç›®æœ€ç»ˆè¦è¾¾åˆ°çš„æ•ˆæœæ˜¯ï¼Œåœ¨è°·æ­Œä¸ŠæŸ¥è¯¢ä¸€ä¸ªå…¬å¸ï¼Œæˆ‘ä»¬çš„ç•Œé¢è¦æ¯”è¿™ä¸ªå…¬å¸é å‰ï¼Œä»è€Œè·å–è‡ªç„¶æµé‡ï¼Œæœ‰äº†è‡ªç„¶æµé‡å°±å¯ä»¥å˜ç°äº†ã€‚<br>ç±»ä¼¼å¤©çœ¼æŸ¥ï¼Œæ¯æ¬¡å»æŸ¥è¯¢ä¸€ä¸ªå…¬å¸çš„å®˜ç½‘ï¼Œå¤©çœ¼æŸ¥æ€»èƒ½æ¯”å®˜ç½‘é å‰ï¼ˆå…¶å®ä¹Ÿæœ‰å¯èƒ½æ˜¯ç™¾åº¦è‡ªå®¶ç‰¹æ®Šå…³ç…§ï¼‰ã€‚</p>
<p><strong>ä»€ä¹ˆæ˜¯sitemapï¼Ÿ</strong></p>
<p>sitemap.xmlæ˜¯ä¸€ä¸ªç«™ç‚¹åœ°å›¾ï¼Œç›¸å½“äºç»™è°·æ­Œçš„çˆ¬è™«ä¸€ä¸ªæŒ‡å¼•ï¼Œå‘Šè¯‰ä»–æˆ‘çš„ç½‘ç«™éƒ½æœ‰å“ªäº›è·¯å¾„éœ€è¦ä½ æ¥è®¿é—®çš„ï¼Œè¿™ä¸ªåœ°å›¾ä¸€çº§åªèƒ½æœ‰5wæ¡ï¼Œè€Œæˆ‘ä»¬çš„ä¸šåŠ¡è§„æ¨¡æœ‰6kwï¼Œæ‰€ä»¥é‡‡å–ä¸¤çº§ç´¢å¼•ï¼Œå¹¶é‡‡ç”¨gzè¿›è¡Œå‹ç¼©ã€‚<br>è€Œæˆ‘åšçš„å·¥ä½œæ˜¯å®šæ—¶æ›´æ–°è¿™ä¸ªsitemapå¹¶æ”¾åˆ°å‰ç«¯æœåŠ¡å™¨ä¸Šç»™çˆ¬è™«æ¥çˆ¬ã€‚</p>
</blockquote>
<h3 id="sitemapè‡ªåº•å‘ä¸Šæ„å»º"><a href="#sitemapè‡ªåº•å‘ä¸Šæ„å»º" class="headerlink" title="sitemapè‡ªåº•å‘ä¸Šæ„å»º"></a>sitemapè‡ªåº•å‘ä¸Šæ„å»º</h3><p>ç»™äº†ä¸¤å¼ è¡¨ï¼Œåº•å±‚å­˜å…¬å¸ï¼Œé¡¶å±‚å­˜ç´¢å¼•ã€‚æˆ‘æœ€åˆçš„æƒ³æ³•æ˜¯è‡ªåº•å‘ä¸Šæ„å»ºï¼Œæ¯æ¬¡æ›´æ–°å»åˆ é™¤é¡¶å±‚ï¼Œç„¶ååº•å±‚åˆ†é¡µè¿›è¡Œå‹ç¼©ï¼Œæœ€åæ„å»ºé¡¶å±‚ã€‚è¿™æ ·ä¼šæœ‰å‡ ä¸ªé—®é¢˜ï¼š</p>
<ol>
<li>æ·±åº¦åˆ†é¡µé—®é¢˜ï¼šå‰é¢è¯´äº†æ•°æ®é‡æœ€ç»ˆå¤§äº6kwï¼Œå¦‚æ­¤å¤§çš„æ•°æ®é‡åˆ°äº†åé¢è‚¯å®šæ›´æ–°ä¸åŠ¨çš„ã€‚æƒ³äº†åŠå¤©ç´¢å¼•ä¼˜åŒ–æœ€åmentorç»™å¦å†³äº†ã€‚</li>
<li>åˆ è¡¨é—®é¢˜ï¼šæ•°æ®åº“ä¸å…è®¸ä¼ ç©ºå‚æ•°ç›´æ¥åˆ è¡¨ï¼Œè€Œä¸”å¼€é”€å¾ˆå¤§ã€‚</li>
<li>seoé—®é¢˜ï¼šè™½ç„¶å¯†é›†åŒ–äº†è¡¨ä½†æ˜¯å¯èƒ½ä¼šé€ æˆæ³¢åŠ¨ï¼Œä¾‹å¦‚æŸä¸ªå…¬å¸çš„å‰å‡ ä¸ªå¤±æ•ˆäº†ï¼Œè¿™ä¸ªå…¬å¸å˜åŠ¨åˆ°åˆ«çš„ç´¢å¼•ä¹‹ä¸‹ï¼Œå¯èƒ½ä¼šå¯¹seoäº§ç”Ÿå½±å“ï¼Œæœ€å¥½è¿˜æ˜¯å›ºå®šä¸å˜ã€‚</li>
</ol>
<h3 id="sitemapè‡ªé¡¶å‘ä¸‹æ„å»º"><a href="#sitemapè‡ªé¡¶å‘ä¸‹æ„å»º" class="headerlink" title="sitemapè‡ªé¡¶å‘ä¸‹æ„å»º"></a>sitemapè‡ªé¡¶å‘ä¸‹æ„å»º</h3><p>è‡ªé¡¶å‘ä¸‹æ„å»ºå°±æ˜¯ç›´æ¥ç®—å¥½idèŒƒå›´ï¼Œæ•°æ®åº“betweenä¸€ä¸‹å°±å¯ä»¥æ‰¾åˆ°ï¼ŒæŠŠç´¢å¼•å½“ä½œæ§½æ¥ç”¨ï¼Œå¡«æ»¡äº†å°±æ”¾ä¸‹ä¸€ä¸ªã€‚ä¼˜ç‚¹ï¼š</p>
<ol>
<li>æ²¡æœ‰æ·±åº¦åˆ†é¡µé—®é¢˜ï¼Œç›´æ¥æ ¹æ®æœ‰ç´¢å¼•çš„idæŸ¥è¯¢ï¼Œæ•ˆç‡è‚¯å®šæ˜¯æ¯”limité«˜çš„ã€‚</li>
<li>ä¸€çº§ç´¢å¼•æ»¡äº†å°±å¼€è¾Ÿä¸€ä¸ªæ–°çš„ï¼Œæ•ˆç‡ä¹Ÿé«˜ã€‚</li>
</ol>
<p>ç¼ºç‚¹ï¼š</p>
<ol>
<li>ä¾èµ–é¡ºåºæ€§ï¼Œç¨å¾®ä¸­é—´è·¨åº¦å¤§äº†å°±ä¼šæœ‰é—®é¢˜ã€‚ä¾‹å¦‚é¦–å…ˆå­˜äº†1-100ï¼Œå†ä»40000-40100ã€‚æ¯é¡µ100æ¡ï¼Œæ­¤æ—¶æ¥äº†10000-10100å°±ä¸èƒ½ä¿è¯ä¸€çº§ç´¢å¼•çš„é¡ºåºäº†ã€‚</li>
<li>ä¸€çº§ç´¢å¼•çš„èµ·å§‹å’Œç»ˆç‚¹ä¼šæ˜¾å¾—æ²¡æœ‰æ„ä¹‰ï¼Œä¸­é—´æœ‰å¤§é‡å¤±æ•ˆçš„ï¼Œä¸”ä¸ä¸€å®šæœ‰åºã€‚</li>
</ol>
<p>æœ€ç»ˆé‡‡ç”¨äº†è¿™ç§æ–¹å¼ï¼Œesä¸­çš„æ•°æ®æ˜¯ä¸åŒºåˆ†æ–°æ—§çš„ï¼Œæ‰€ä»¥å¾—åšä¸€ä¸ªå”¯ä¸€æ€§æ ¡éªŒã€‚é™¤æ­¤ä¹‹å¤–è¿˜æœ‰ä¸€ä¸ªå½“å‰å¾ªç¯çš„å”¯ä¸€æ€§æ ¡éªŒã€‚</p>
<ul>
<li>é¦–å…ˆæŸ¥è¯¢å½“å‰æœ€å¤§å…¬å¸çš„idï¼Œé€šè¿‡AtomicIntegerè§£å†³çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œä»esæ¥çš„æ–°å¢æ•°æ®åŠ å…¥ï¼ŒåŒæ—¶è¦æ ¡éªŒæ˜¯å¦æ˜¯è‹±æ–‡å…¬å¸ï¼Œå¹¶å–å‡ºé¦–å­—æ¯ã€‚ï¼ˆè¿™é‡Œå†™äº†ä¸€å¤§å †å­—ç¬¦ä¸²å·¥å…·ï¼‰</li>
<li>è¿™æ ·åšäº†é‡å¤æ€§æ ¡éªŒçš„è¯å³ä½¿æ˜¯å¤±è´¥äº†ä¹Ÿèƒ½ä¿è¯ä¸ä¼šé‡å¤ã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getOpenCompanyIndex</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">BoolQueryBuilder</span> <span class="variable">boolQuery</span> <span class="operator">=</span> QueryBuilders.boolQuery();</span><br><span class="line">        boolQuery.must(QueryBuilders.existsQuery(<span class="string">&quot;summary.formatDomains&quot;</span>));</span><br><span class="line">        boolQuery.must(QueryBuilders.rangeQuery(<span class="string">&quot;emailCount&quot;</span>)</span><br><span class="line">                .gt(<span class="number">1</span>));</span><br><span class="line">        boolQuery.must(QueryBuilders.existsQuery(<span class="string">&quot;detail.productList&quot;</span>));</span><br><span class="line">        boolQuery.must(QueryBuilders.existsQuery(<span class="string">&quot;overviewDescription&quot;</span>));</span><br><span class="line">        boolQuery.must(QueryBuilders.existsQuery(<span class="string">&quot;detail.sic&quot;</span>));</span><br><span class="line">        boolQuery.must(QueryBuilders.existsQuery(<span class="string">&quot;detail.naics&quot;</span>));</span><br><span class="line">        boolQuery.must(QueryBuilders.existsQuery(<span class="string">&quot;customsItems&quot;</span>));</span><br><span class="line"></span><br><span class="line">        boolQuery.mustNot(QueryBuilders.termQuery(<span class="string">&quot;disable&quot;</span>, <span class="literal">true</span>));</span><br><span class="line">        <span class="type">SearchSourceBuilder</span> <span class="variable">sourceBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchSourceBuilder</span>()</span><br><span class="line">                .query(boolQuery) <span class="comment">// æŸ¥è¯¢å‚æ•°</span></span><br><span class="line">                .fetchSource(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;name&quot;</span>,<span class="string">&quot;companyId&quot;</span>&#125;,</span><br><span class="line">                        <span class="literal">null</span>)</span><br><span class="line">                .size(<span class="number">1000</span>);</span><br><span class="line">        <span class="keyword">if</span> (openCompanyIndex == <span class="literal">null</span>) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;openCompanyIndex is null&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">SiteMapCompanyEntity</span> <span class="variable">maxCompany</span> <span class="operator">=</span> siteMapCompanyService.getMaxDataId();</span><br><span class="line">        <span class="type">long</span> <span class="variable">maxDataId</span> <span class="operator">=</span> maxCompany == <span class="literal">null</span> ? <span class="number">1</span> : maxCompany.getDataId();</span><br><span class="line">        Set&lt;String&gt; strings = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">        <span class="type">AtomicInteger</span> <span class="variable">count</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>();</span><br><span class="line">        openCompanyIndex.scrollSearch(sourceBuilder, searchHits -&gt; &#123;</span><br><span class="line">            List&lt;SiteMapCompanyEntity&gt; addList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">            <span class="keyword">for</span> (SearchHit searchHit : searchHits) &#123;</span><br><span class="line">                Map&lt;String, Object&gt; result = searchHit.getSourceAsMap();</span><br><span class="line">                <span class="type">SiteMapCompanyEntity</span> <span class="variable">siteMapCompanyEntity</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SiteMapCompanyEntity</span>();</span><br><span class="line">                <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> result.get(<span class="string">&quot;name&quot;</span>).toString();</span><br><span class="line">                <span class="type">String</span> <span class="variable">companyId</span> <span class="operator">=</span> result.get(<span class="string">&quot;companyId&quot;</span>).toString();</span><br><span class="line">                <span class="comment">//æœ¬è½®å»é‡</span></span><br><span class="line">                <span class="keyword">if</span> (strings.contains(companyId)) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                strings.add(companyId);</span><br><span class="line">                <span class="comment">//å…¨å±€å»é‡</span></span><br><span class="line">                LambdaQueryWrapper&lt;SiteMapCompanyEntity&gt; lambdaQueryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">                lambdaQueryWrapper.eq(SiteMapCompanyEntity::getCompanyId, companyId);</span><br><span class="line">                <span class="keyword">if</span> (siteMapCompanyService.count(lambdaQueryWrapper) &gt; <span class="number">0</span>)&#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                siteMapCompanyEntity.setCompanyId(companyId);</span><br><span class="line">                <span class="comment">//ä¿ç•™åŸå§‹åç§°</span></span><br><span class="line">                siteMapCompanyEntity.setCompanyName(name);</span><br><span class="line">                siteMapCompanyEntity.setChangeFreq(ChangeFreqEnum.WEEKLY.getCode());</span><br><span class="line">                siteMapCompanyEntity.setDataPriority(<span class="number">1f</span>);</span><br><span class="line">                siteMapCompanyEntity.setCreateTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">                siteMapCompanyEntity.setUpdateTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">                siteMapCompanyEntity.setDataId(maxDataId + count.longValue());</span><br><span class="line">                <span class="comment">//éè‹±è¯­å…¬å¸</span></span><br><span class="line">                <span class="keyword">if</span> (!StringUtil.checkEnglishChar(name))&#123;</span><br><span class="line">                    siteMapCompanyEntity.setNavLetter(<span class="literal">null</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">temp</span> <span class="operator">=</span> StringUtil.removeAllPattern(name);</span><br><span class="line">                    siteMapCompanyEntity.setNavLetter(temp.substring(<span class="number">0</span>, <span class="number">1</span>).toUpperCase());</span><br><span class="line">                &#125;</span><br><span class="line">                count.getAndIncrement();</span><br><span class="line">                addList.add(siteMapCompanyEntity);</span><br><span class="line">            &#125;</span><br><span class="line">            siteMapCompanyService.saveBatch(addList);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">        log.info(String.valueOf(count));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Throwable e)&#123;</span><br><span class="line">        log.error(String.valueOf(e));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é‚£æ€ä¹ˆåšç”Ÿæˆçš„ï¼Œæ ¹æ®å…¬å¸çš„æœ€å¤§å€¼æœ€å°å€¼&#x2F;é¡µé¢å¤§å°å¾—åˆ°åç§»é‡ã€‚æ ¹æ®è¿™ä¸ªåç§»é‡å»æ›´æ–°å’ŒæŸ¥è¯¢ï¼Œåªå…³æ³¨æœ€åä¸€ä¸ªç´¢å¼•å—ï¼Œå¦‚æœæ²¡æ»¡å°±ä»è¿™é‡Œå¼€å§‹åŠ ï¼Œæ›´æ–°æœ€å¤§å€¼ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">generate</span><span class="params">()</span> &#123;</span><br><span class="line">    preprocess();</span><br><span class="line">    <span class="type">SiteMapCompanyEntity</span> <span class="variable">maxCompany</span> <span class="operator">=</span> siteMapCompanyService.getMaxDataId();</span><br><span class="line">    <span class="type">SiteMapCompanyEntity</span> <span class="variable">minCompany</span> <span class="operator">=</span> siteMapCompanyService.getMinDataId();</span><br><span class="line">    <span class="keyword">if</span> (maxCompany == <span class="literal">null</span> || minCompany == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    List&lt;CompletableFuture&lt;Void&gt;&gt; futures = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    Map&lt;Long,String&gt; siteMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="type">long</span> <span class="variable">minDataId</span> <span class="operator">=</span> minCompany.getDataId();</span><br><span class="line">    <span class="type">long</span> <span class="variable">maxDataId</span> <span class="operator">=</span> maxCompany.getDataId();</span><br><span class="line">    <span class="type">long</span> <span class="variable">pageLength</span> <span class="operator">=</span> (<span class="type">long</span>) Math.ceil((<span class="type">double</span>) (maxDataId - minDataId + <span class="number">1</span>) / PAGE_SIZE);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">long</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= pageLength; i++) &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">startDataId</span> <span class="operator">=</span> minDataId +  (i - <span class="number">1</span>) * PAGE_SIZE;</span><br><span class="line">        <span class="type">long</span> <span class="variable">endDataId</span> <span class="operator">=</span> minDataId + i * PAGE_SIZE - <span class="number">1</span>;</span><br><span class="line">        <span class="type">long</span> <span class="variable">page</span> <span class="operator">=</span> i;</span><br><span class="line">        CompletableFuture&lt;Void&gt; future = CompletableFuture.runAsync(() -&gt; &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">gzip</span> <span class="operator">=</span> xmlCompanyMapGenerator.generateCompanyMap(startDataId, endDataId,page);</span><br><span class="line">            <span class="keyword">if</span> (!StringUtils.isEmpty(gzip)) &#123;</span><br><span class="line">                siteMap.put(page,gzip);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, EXECUTOR);</span><br><span class="line">        futures.add(future);</span><br><span class="line">    &#125;</span><br><span class="line">    CompletableFuture.allOf(futures.toArray(<span class="keyword">new</span> <span class="title class_">CompletableFuture</span>[<span class="number">0</span>])).join();</span><br><span class="line">    generateXML(siteMap);</span><br><span class="line">    <span class="type">long</span> <span class="variable">count</span> <span class="operator">=</span> siteMapTopService.count();</span><br><span class="line">    List&lt;SiteMapTopEntity&gt; insertList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">long</span> <span class="variable">i</span> <span class="operator">=</span> Math.max(<span class="number">1</span>,count); i &lt;= pageLength; i++) &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">startDataId</span> <span class="operator">=</span> minDataId +  (i - <span class="number">1</span>) * PAGE_SIZE;</span><br><span class="line">        <span class="type">long</span> <span class="variable">endDataId</span> <span class="operator">=</span> Math.min(minDataId + i * PAGE_SIZE - <span class="number">1</span>, maxDataId);</span><br><span class="line">        <span class="type">SiteMapTopEntity</span> <span class="variable">siteMapTopEntity</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SiteMapTopEntity</span>();</span><br><span class="line">        siteMapTopEntity.setStartDataId(startDataId);</span><br><span class="line">        siteMapTopEntity.setEndDataId(endDataId);</span><br><span class="line"></span><br><span class="line">        siteMapTopEntity.setCreateTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        siteMapTopEntity.setUpdateTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        <span class="keyword">if</span> (count != <span class="number">0</span> &amp;&amp; i == count)&#123;</span><br><span class="line">            LambdaUpdateWrapper&lt;SiteMapTopEntity&gt; updateWrapper = <span class="keyword">new</span> <span class="title class_">LambdaUpdateWrapper</span>&lt;&gt;();</span><br><span class="line">            updateWrapper.eq(SiteMapTopEntity::getName,siteMap.get(i));</span><br><span class="line">            siteMapTopService.update(siteMapTopEntity,updateWrapper);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        siteMapTopEntity.setName(siteMap.get(i));</span><br><span class="line">        insertList.add(siteMapTopEntity);</span><br><span class="line">    &#125;</span><br><span class="line">    siteMapTopService.saveBatch(insertList);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¬¬ä¸€å‘¨é¦–å…ˆä¸Šäº†3wæ•°æ®ï¼Œæœªæ¥æ•°æ®é‡å¤§äº†è‚¯å®šè¦åˆ†åº“åˆ†è¡¨çš„ï¼Œä»¥åçš„äº‹æƒ…ä»¥åå†è¯´ã€‚</p>
<h2 id="éœ€æ±‚9ï¼šã€å‡ºæµ·é¡¹ç›®ã€‘ä¸€äº›é›¶ç¢çš„å°éœ€æ±‚"><a href="#éœ€æ±‚9ï¼šã€å‡ºæµ·é¡¹ç›®ã€‘ä¸€äº›é›¶ç¢çš„å°éœ€æ±‚" class="headerlink" title="éœ€æ±‚9ï¼šã€å‡ºæµ·é¡¹ç›®ã€‘ä¸€äº›é›¶ç¢çš„å°éœ€æ±‚"></a>éœ€æ±‚9ï¼šã€å‡ºæµ·é¡¹ç›®ã€‘ä¸€äº›é›¶ç¢çš„å°éœ€æ±‚</h2><h3 id="ã€æ¥å£ã€‘æ ¹æ®é¦–å­—æ¯å’Œé¡µç è¿”å›æ•°æ®"><a href="#ã€æ¥å£ã€‘æ ¹æ®é¦–å­—æ¯å’Œé¡µç è¿”å›æ•°æ®" class="headerlink" title="ã€æ¥å£ã€‘æ ¹æ®é¦–å­—æ¯å’Œé¡µç è¿”å›æ•°æ®"></a>ã€æ¥å£ã€‘æ ¹æ®é¦–å­—æ¯å’Œé¡µç è¿”å›æ•°æ®</h3><p>å°±æ˜¯ç®€å•çš„åˆ†é¡µé—®é¢˜ï¼Œä½†æ˜¯æœ‰ä¸€äº›å­—ç¬¦ä¸²å¤„ç†ã€‚æˆ‘å†™äº†ä¸€å¤§å †å­—ç¬¦ä¸²å·¥å…·ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> PageResp&lt;CompanyUrlResp&gt; <span class="title function_">getCompanyUrl</span><span class="params">(String navLetter, Integer pageNum)</span> &#123;</span><br><span class="line">    LambdaQueryWrapper&lt;SiteMapCompanyEntity&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isNotEmpty(navLetter)) &#123;</span><br><span class="line">        <span class="comment">//éè‹±æ–‡å›½å®¶</span></span><br><span class="line">        <span class="keyword">if</span> (navLetter.equals(<span class="string">&quot;Other&quot;</span>)) &#123;</span><br><span class="line">            queryWrapper.isNull(SiteMapCompanyEntity::getNavLetter);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!navLetter.matches(<span class="string">&quot;^[a-zA-Z]$&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BizException</span>(BizError.PARAM_ERR.getName(), BizError.PARAM_ERR.getCode());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            queryWrapper.eq(SiteMapCompanyEntity::getNavLetter, navLetter.toUpperCase());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BizException</span>(BizError.PARAM_ERR.getName(), BizError.PARAM_ERR.getCode());</span><br><span class="line">    &#125;</span><br><span class="line">    queryWrapper.eq(SiteMapCompanyEntity::getStatus, CompanyStatus.ACTIVE.getCode());</span><br><span class="line"></span><br><span class="line">    IPage&lt;SiteMapCompanyEntity&gt; page = <span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(pageNum, COMPANY_URL_PAGE_SIZE);</span><br><span class="line">    IPage&lt;SiteMapCompanyEntity&gt; userPage = siteMapCompanyService.page(page, queryWrapper);</span><br><span class="line">    List&lt;SiteMapCompanyEntity&gt; userList = userPage.getRecords();</span><br><span class="line">    <span class="comment">//ç»„è£…è¿”å›ç»“æœ</span></span><br><span class="line">    PageResp&lt;CompanyUrlResp&gt; pageResp = <span class="keyword">new</span> <span class="title class_">PageResp</span>&lt;&gt;();</span><br><span class="line">    pageResp.setPageNo(pageNum);</span><br><span class="line">    pageResp.setPageSize(COMPANY_URL_PAGE_SIZE);</span><br><span class="line">    pageResp.setTotalPage(userPage.getPages());</span><br><span class="line">    pageResp.setTotalSize(userPage.getTotal());</span><br><span class="line">    pageResp.setContent(userList.stream().map(item -&gt; &#123;</span><br><span class="line">        <span class="type">CompanyUrlResp</span> <span class="variable">companyUrlResp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CompanyUrlResp</span>();</span><br><span class="line">        companyUrlResp.setCompanyId(item.getCompanyId());</span><br><span class="line">        companyUrlResp.setCompanyName(StringUtil.firstLetterToUpperCaseByBlank(item.getCompanyName()));</span><br><span class="line">        <span class="keyword">if</span> (!StringUtil.checkEnglishChar(item.getCompanyName()))&#123;</span><br><span class="line">            companyUrlResp.setCompanyFormatName(<span class="string">&quot;Non-English-Company&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">temp</span> <span class="operator">=</span> StringUtil.formatCompanyNameToUrl(item.getCompanyName());</span><br><span class="line">            companyUrlResp.setCompanyFormatName(temp);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> companyUrlResp;</span><br><span class="line">    &#125;).collect(Collectors.toList()));</span><br><span class="line">    <span class="keyword">return</span> pageResp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ã€æ¥å£ã€‘å…¬å¸è¯¦æƒ…è·å–"><a href="#ã€æ¥å£ã€‘å…¬å¸è¯¦æƒ…è·å–" class="headerlink" title="ã€æ¥å£ã€‘å…¬å¸è¯¦æƒ…è·å–"></a>ã€æ¥å£ã€‘å…¬å¸è¯¦æƒ…è·å–</h3><p>ä¿®æ”¹äº†mentorçš„ä¸€ç‚¹é€»è¾‘ï¼Œåšäº†ä¸€ç‚¹æ ¡éªŒï¼š</p>
<ul>
<li>å› ä¸ºæŸ¥çš„æ˜¯å…¨çƒæœçš„æ•°æ®ï¼Œæœ‰å¯èƒ½æœªå…¬å¼€ï¼Œæ ¡éªŒåªæœ‰å¼€å¯çš„å…¬å¸æ‰èƒ½æŸ¥è¯¢ã€‚</li>
<li>å¦‚æœæ²¡æœ‰ç™»å½•ï¼Œdomainéšè”½ï¼Œè¿™é‡Œçœ‹threadlocalæœ‰æ²¡æœ‰ä¸œè¥¿å°±å¥½äº†ã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> CompanyBaseVO <span class="title function_">base</span><span class="params">(String companyId)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!siteMapCompanyService.isOpeningCompany(companyId)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BizException</span>(BizError.NON_OPENING_COMPANY.getName(), BizError.NON_OPENING_COMPANY.getCode());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> host+<span class="string">&quot;/api/auth/global/overseas/base&quot;</span>;</span><br><span class="line">        Map&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;companyId&quot;</span>, companyId);</span><br><span class="line">        map.put(<span class="string">&quot;appKey&quot;</span>, appKey);</span><br><span class="line">        map.put(<span class="string">&quot;appSecret&quot;</span>, appSecret);</span><br><span class="line">        map.put(<span class="string">&quot;timestamp&quot;</span>, String.valueOf(System.currentTimeMillis()));</span><br><span class="line">        map = OpenApiUtil.packageSign(map, appKey, appSecret);</span><br><span class="line">        <span class="type">String</span> <span class="variable">resut</span> <span class="operator">=</span> OkHttpUtil.get(url, map);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotBlank(resut)) &#123;</span><br><span class="line">            <span class="comment">// å›¾ç‰‡é“¾æ¥è½¬æ¢</span></span><br><span class="line">            resut = ImagePathConvert.convert(resut);</span><br><span class="line">            <span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> JSON.parseObject(resut);</span><br><span class="line">            <span class="type">String</span> <span class="variable">dataResult</span> <span class="operator">=</span> jsonObject.getString(<span class="string">&quot;data&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> loginAuth(JSON.parseObject(dataResult, CompanyBaseVO.class));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">        log.info(<span class="string">&quot;demo error&quot;</span>, e);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> CompanyBaseVO <span class="title function_">loginAuth</span><span class="params">(CompanyBaseVO companyBaseVO)</span>&#123;</span><br><span class="line">    <span class="type">UserInfoToken</span> <span class="variable">userInfoToken</span> <span class="operator">=</span> UserContext.getContent().getUserInfoToken();</span><br><span class="line">    <span class="comment">//æœªç™»å½•</span></span><br><span class="line">    <span class="keyword">if</span> (userInfoToken == <span class="literal">null</span>) &#123;</span><br><span class="line">        companyBaseVO.setDomain(<span class="string">&quot;*****&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> companyBaseVO;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

    
    
  </div>

  

  

</article>
  
  <article class="post">
  <header class="post-header">
    <h1 class="post-title">
      
      <a class="post-link" href="/2024/12/15/%E7%BD%91%E6%98%93%E7%89%9B%E9%A9%AC%E6%97%A5%E5%BF%97-week4/">ç½‘æ˜“ç‰›é©¬æ—¥å¿—-week4</a>
      
    </h1>

    <div class="post-meta">
      <span class="post-time">
        2024-12-15
      </span>
      
      
      
    </div>
  </header>

  

  <div class="post-content">
    
    
    

    
    <h2 id="éœ€æ±‚5ï¼šä¼˜åŒ–prompt"><a href="#éœ€æ±‚5ï¼šä¼˜åŒ–prompt" class="headerlink" title="éœ€æ±‚5ï¼šä¼˜åŒ–prompt"></a>éœ€æ±‚5ï¼šä¼˜åŒ–prompt</h2><h3 id="1-æç¤ºè¯ä¼˜åŒ–"><a href="#1-æç¤ºè¯ä¼˜åŒ–" class="headerlink" title="1.æç¤ºè¯ä¼˜åŒ–"></a>1.æç¤ºè¯ä¼˜åŒ–</h3><blockquote>
<p>å­¦ä¹ äº†promptå·¥ç¨‹ï¼Œä¸»è¦çš„ä¼˜åŒ–æ€è·¯æœ‰ï¼ˆ<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/QDzbfUkvSEalLxm3XX9rtA">å‚è€ƒè¿æ¥</a>ï¼‰ï¼š</p>
<ol>
<li>è§’è‰²æç¤ºï¼šâ€œå‡è®¾æˆ‘æ˜¯ä¸€ä¸ªåˆšå…¥è¡Œçš„ç”µå•†ä¹°å®¶â€ï¼Œç±»ä¼¼è¿™ç§å¯ä»¥å°†gptå¸¦å…¥è§’è‰²ï¼Œä»¥è¯¥è§’è‰²çš„è§†è§’è¿›è¡Œè¾“å‡º</li>
<li>æ€ç»´é“¾æç¤ºï¼šè®©gptä¸€æ­¥ä¸€æ­¥è¿›è¡Œæ€è€ƒï¼Œä¾‹å¦‚è®¡ç®—1+2+3ï¼Œå…ˆè®©gptç®—å‡º1+2&#x3D;3ï¼Œç„¶åå†å»ç®—3+3&#x3D;6ï¼Œæœ‰äº†æ€ç»´é“¾èƒ½å¤Ÿä½¿aiæ¸…æ™°æ€è€ƒè·¯å¾„ï¼ŒçŠ¯é”™çš„å¯èƒ½æ€§é™ä½</li>
<li>æ€ç»´æ ‘æç¤ºï¼šè·Ÿä¸Šé¢çš„æ€ç»´é“¾æ¯”èµ·æ¥ï¼Œæ€ç»´æ ‘è¦è€ƒè™‘ä¸åŒçš„åˆ†å‰ï¼Œåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­è¦è€ƒè™‘ä¸åŒçš„æƒ…å†µ</li>
<li>è‡ªä¸€è‡´æ€§æç¤ºï¼šå°†æ¨¡å‹çš„æ¸©åº¦å‡é«˜ï¼Œå¤šæ¬¡å»æ‰§è¡Œä¸€ä¸ªé—®é¢˜ï¼Œè¿”å›å…¶ä¸­æœ€é«˜é¢‘ç‡çš„ç­”æ¡ˆã€‚å¯¹äºæ¨èè¯çš„åœºæ™¯ä¸å¤ªé€‚ç”¨ï¼Œå› ä¸ºè°ƒç”¨æ¬¡æ•°æœ‰é™è€Œä¸”æ—¶å»¶è¾ƒå¤§ï¼Œè¢«mentorå¦å†³ã€‚</li>
<li>ReActæç¤ºï¼šç”¨pythonçš„apiè¿›è¡Œè°ƒç”¨ï¼ŒåŠŸèƒ½å¼ºå¤§ä½†ç”¨ä¸äº†ã€‚<br>ç»¼åˆä»¥ä¸Šçš„æ–¹æ³•ï¼Œåªæœ‰æ€ç»´é“¾å¯ä»¥ä½œä¸ºä¼˜åŒ–ã€‚</li>
</ol>
</blockquote>
<ol>
<li>è¿‘ä¼¼è¯ï¼šä¸­è¯‘è‹±</li>
</ol>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">String synonymsPrompt = MessageFormat.format(&quot;ä¸\&quot;&#123;0&#125;\&quot;æ„æ€ç›¸è¿‘çš„äº§å“æœ‰å“ªäº›ï¼Œ</span><br><span class="line">        è¯·ç”¨&#123;1&#125;åˆ—ä¸¾10ä¸ªäº§å“åã€‚è¦æ±‚ä¸åŒ…å«\&quot;&#123;0&#125;\&quot;ï¼Œ</span><br><span class="line">        è¾“å‡ºæ ¼å¼ä¸ºï¼šjsonArray&quot;, formatValue, language) + &quot;,[]&quot;;</span><br></pre></td></tr></table></figure>

<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">String synonymsPrompt = MessageFormat.format(&quot;What are the products with the similar meaning of \&quot;&#123;0&#125;\&quot;,\n&quot; +</span><br><span class="line">        &quot;Please list 10 product names in &#123;1&#125;. My request is not to include \&quot;&#123;0&#125;\&quot;,\n&quot; +</span><br><span class="line">        &quot;The output format is jsonArray&quot;, formatValue, language) + &quot;,[]&quot;;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>ç”µå•†è¯ï¼šè½¬ä¸ºä¸­æ–‡æ€ç»´é“¾</li>
</ol>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">String platformPrompt = MessageFormat.format(&quot;å‡è®¾æˆ‘æ˜¯ä¸€ä¸ªæ–°å…¥è¡Œçš„ç”µå•†å–å®¶ï¼Œ</span><br><span class="line">        ä¸»è¦ç»è¥çš„æ˜¯\&quot;&#123;0&#125;\&quot;ã€‚æˆ‘å¸Œæœ›èƒ½æœ‰æ›´å¤šçš„ç”¨æˆ·åœ¨amazon.comç­‰åŒç±»ç”µå•†ç½‘ç«™ä¸­æœç´¢åˆ°æˆ‘ï¼Œ</span><br><span class="line">        æˆ‘å¯ä»¥ä½¿ç”¨æ€æ ·çš„&#123;1&#125;äº§å“åå¯¹è‡ªå·±çš„äº§å“è¿›è¡Œæè¿°ï¼Ÿè¦æ±‚ä¸åŒ…å«\&quot;&#123;0&#125;\&quot;ï¼Œ</span><br><span class="line">        è¯·å»æ‰å°½å¯èƒ½å¤šçš„é•¿å°¾è¯ï¼Œæç‚¼å…±åŒçš„äº§å“æè¿°è¯ã€‚å¸®æˆ‘ç”¨&#123;2&#125;åŒä¹‰æ›¿æ¢10ä¸ªä¸åŒçš„äº§å“æè¿°ã€‚ä»…è¾“å‡ºæ›¿æ¢åçš„æ•°æ®ï¼Œ</span><br><span class="line">        æ ¼å¼ä¸ºï¼šjsonArray&quot;, formatValue, language, language) + &quot;,[]&quot;;   </span><br></pre></td></tr></table></figure>

<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">String platformPrompt = MessageFormat.format(&quot;è¯·æŒ‰ç…§å¦‚ä¸‹æç¤ºä¸€æ­¥æ­¥æ¨ç†ï¼š\n&quot; +</span><br><span class="line">        &quot;ç¬¬ä¸€æ­¥ï¼Œè¯·å°†äº§å“\&quot;&#123;0&#125;\&quot;ä»å“ç‰Œã€å‹å·ã€ææ–™ã€ç”¨é€”ç­‰æ–¹é¢è¿›è¡Œæ‰©å±•ï¼Œå°½é‡ç»†åˆ†ä¸”å…·ä½“åˆ°æŸä¸ªå“ç‰Œçš„æŸä¸ªäº§å“ã€‚\n&quot; +</span><br><span class="line">        &quot;ç¬¬äºŒæ­¥ï¼Œæ€è€ƒè¯¥äº§å“åœ¨amazon.comç­‰åŒç±»ç”µå•†ç½‘ç«™ä¸­æ˜¾ç¤ºç»™ç”¨æˆ·çš„å•†å“è¯æ˜¯ä»€ä¹ˆã€‚\n&quot; +</span><br><span class="line">        &quot;ç¬¬ä¸‰æ­¥ï¼Œæå–å•†å“è¯ä¸­çš„å…³é”®ä¿¡æ¯ï¼Œä¸å…è®¸å‡ºç°å“ç‰Œå’Œå‹å·ï¼Œé•¿åº¦ä¸¥æ ¼é™åˆ¶åœ¨30ä¸ªå­—æ¯ä»¥å†…ã€‚\n&quot; +</span><br><span class="line">        &quot;ç»¼åˆä»¥ä¸Šä¸‰æ­¥ï¼Œä»…ç”¨&#123;1&#125;è¾“å‡ºåä¸ªè¿™æ ·çš„äº§å“åï¼Œè¦æ±‚ä¸åŒ…å«\&quot;&#123;0&#125;\&quot;æ ¼å¼ä¸ºï¼šjsonArray,[]&quot;, formatValue, language) + &quot;,[]&quot;;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>è¡Œä¸šè¯ï¼šä¸­è¯‘è‹±</li>
</ol>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">prompt = &quot;æˆ‘æ˜¯ä¸€ä¸ªæ–°å…¥è¡Œçš„å¤–è´¸ä¾›åº”å•†ï¼Œä¸»è¦ç»è¥çš„æ˜¯&quot;+ formatValue +&quot;ã€‚æˆ‘çš„äº§å“å¯ä»¥åº”ç”¨äºå“ªäº›è¡Œä¸šçš„å“ªäº›äº§å“ï¼Ÿå¸®æˆ‘åˆ—ä¸¾3ä¸ªè¡Œä¸šï¼Œå¹¶æè¿°æ¨èè¿™äº›è¡Œä¸šçš„ç†ç”±ï¼Œåœ¨æ¯ä¸ªè¡Œä¸šä¸‹åˆ—ä¸¾5ä¸ªä½¿ç”¨è¯¥äº§å“åˆ¶é€ å‡ºæ¥çš„äº§å“åç§°ã€‚\n&quot; +</span><br><span class="line">        &quot;ç”¨jsonè¾“å‡ºï¼Œæ ¼å¼ä¸ºï¼š\n&quot; +</span><br><span class="line">        &quot;è¡Œä¸š1\n&quot; +</span><br><span class="line">        &quot;è¡Œä¸šåï¼šxxx\n&quot; +</span><br><span class="line">        &quot;æ¨èç†ç”±ï¼šxxx\n&quot; +</span><br><span class="line">        &quot;ç›¸å…³äº§å“ï¼šxxx\n&quot; +</span><br><span class="line">        &quot;è¦æ±‚ï¼š\n&quot; +</span><br><span class="line">        &quot;1ã€è¡Œä¸šåç§°ç”¨&#123;&quot;+languageVersion+&quot;&#125;ã€‚\n&quot; +</span><br><span class="line">        &quot;2ã€æ¨èç†ç”±ç”¨&#123;&quot;+languageVersion+&quot;&#125;ã€‚\n&quot; +</span><br><span class="line">        &quot;3ã€ç›¸å…³äº§å“ç”¨&#123;&quot;+language+&quot;&#125;ã€‚\n&quot; +</span><br><span class="line">        &quot;4ã€äº§å“åç§°ä¸èƒ½é‡å¤ã€‚\n&quot; +</span><br><span class="line">        &quot;5ã€äº§å“åç§°ä¸éœ€è¦åŒ…å«æè´¨ç­‰é™åˆ¶ã€‚\n&quot; +</span><br><span class="line">        &quot;6ã€ç›¸å…³äº§å“ç”¨#æ ¼å¼€ã€‚&quot; +</span><br><span class="line">        &quot;7ã€ä¸åŒ…å«\&quot;&quot;+formatValue+&quot;\&quot;ã€‚&quot;;</span><br></pre></td></tr></table></figure>

<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">prompt = &quot;I am a new foreign trade supplier, the main business is \&quot;&quot;+formatValue+&quot;\&quot;. Which products can my product be used in which industries? Give me a list of 3 industries and describe the reasons why you recommend them, and list 5 names of products made with that product under each industry.\n&quot; +</span><br><span class="line">        &quot;Output in json format:\n&quot; +</span><br><span class="line">        &quot; è¡Œä¸š1\n&quot; +</span><br><span class="line">        &quot; è¡Œä¸šåï¼šxxx\n&quot; +</span><br><span class="line">        &quot; æ¨èç†ç”±ï¼šxxx\n&quot; +</span><br><span class="line">        &quot; ç›¸å…³äº§å“ï¼šxxx\n&quot; +</span><br><span class="line">        &quot;Requirement: \&quot;\n&quot; +</span><br><span class="line">        &quot;1. the industry name with &#123;&quot;+languageVersion+&quot;&#125;.\n&quot; +</span><br><span class="line">        &quot;2. recommended reasons use &#123;&quot;+languageVersion+&quot;+&#125;.\n&quot; +</span><br><span class="line">        &quot;3. Use &#123;&quot;+language+&quot;&#125; for related products.\n&quot; +</span><br><span class="line">        &quot;4. the product name can not be repeated.\n&quot; +</span><br><span class="line">        &quot;5. the product name does not need to include material and other restrictions.\n&quot; +</span><br><span class="line">        &quot;6. related products are delimited with #\n&quot; +</span><br><span class="line">        &quot;7. \&quot;&quot;+formatValue+&quot;\&quot; is not included.&quot;;</span><br></pre></td></tr></table></figure>

<p>ä¸‰ä¸ªå°å°çš„ä¼˜åŒ–è€—è´¹äº†æˆ‘ä¸€å‘¨çš„æ—¶é—´ï¼Œå®é™…ä¸Šä¹Ÿæ²¡å¤šå°‘æå‡ã€‚</p>
<h3 id="2-ä»£ç é€»è¾‘"><a href="#2-ä»£ç é€»è¾‘" class="headerlink" title="2.ä»£ç é€»è¾‘"></a>2.ä»£ç é€»è¾‘</h3><h4 id="è¿‘ä¼¼è¯å’Œç”µå•†è¯"><a href="#è¿‘ä¼¼è¯å’Œç”µå•†è¯" class="headerlink" title="è¿‘ä¼¼è¯å’Œç”µå•†è¯"></a>è¿‘ä¼¼è¯å’Œç”µå•†è¯</h4><ul>
<li>é¦–å…ˆåˆ¤æ–­æ˜¯å¦ä¸ºç©ºï¼Œæˆ–è€…æ˜¯å¦ä¸ºæ•æ„Ÿè¯ï¼ˆè°ƒç”¨ç½‘æ˜“æ˜“ç›¾ï¼‰ï¼Œéšåä¼ å…¥ç”¨æˆ·ä¿¡æ¯ï¼Œè®¿é—®æœåŠ¡ã€‚</li>
<li>æœåŠ¡å†…éƒ¨ï¼šä¼ å…¥å‚æ•°ä¸­è¯­è¨€ä¸ºç©ºé»˜è®¤ä¸ºè‹±è¯­ï¼Œç„¶åç”¨CompletableFuture.supplyAsync()æ­é…çº¿ç¨‹æ± å®Œæˆgptçš„ä¸¤æ¬¡è¯·æ±‚ã€‚çº¿ç¨‹æ± å¦‚ä¸‹ï¼š</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//çº¿ç¨‹å·¥å‚ä»…ä»…æ”¹åï¼Œæ‹’ç»ç­–ç•¥æ˜¯å‘èµ·è€…è‡ªå·±æ¶ˆåŒ–</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ThreadFactory</span> <span class="variable">GPT_THREAD_FACTORY</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadFactoryBuilder</span>().setNameFormat(<span class="string">&quot;GptGrpcWrapper-gpt-pool-%d&quot;</span>).build();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">GPT_REQUEST_EXECUTOR</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(<span class="number">20</span>,</span><br><span class="line">        <span class="number">40</span>, <span class="number">60</span> * <span class="number">5L</span>, TimeUnit.SECONDS, <span class="keyword">new</span> <span class="title class_">LinkedBlockingDeque</span>&lt;&gt;(<span class="number">3000</span>), GPT_THREAD_FACTORY, <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.CallerRunsPolicy());</span><br></pre></td></tr></table></figure>

<ul>
<li>è¯·æ±‚æˆåŠŸçš„ç»“æœç¼“å­˜åœ¨redisä¸­100å¤©ï¼Œç¼“å­˜çš„keyæ˜¯â€cacheKeyPreFix + â€œv6â€ + â€œ:â€ + gptRecommendReqVO.getLanguage()+â€:â€+gptRecommendReqVO.getValue();â€</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Set&lt;String&gt; <span class="title function_">getRecommendWordV1</span><span class="params">(GptRecommendReqVO gptRecommendReqVO, AuthInfo authInfo, String prompt, String cacheKeyPreFix)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">cacheValue</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(gptRecommendReqVO.getValue())) &#123;</span><br><span class="line">            <span class="keyword">return</span> Collections.emptySet();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">formatValue</span> <span class="operator">=</span> FormatUtil.escapeFormat(gptRecommendReqVO.getValue());</span><br><span class="line">        <span class="keyword">if</span>(StringUtils.isBlank(formatValue) || formatValue.length()&lt;=<span class="number">1</span>)&#123;</span><br><span class="line">            log.info(<span class="string">&quot;GptGrpcWrapper value:&#123;&#125;,formatValue:&#123;&#125;&quot;</span>,gptRecommendReqVO.getValue(),formatValue);</span><br><span class="line">            <span class="keyword">return</span> Collections.emptySet();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(gptRecommendReqVO.getLanguage()==<span class="literal">null</span>)&#123;</span><br><span class="line">            gptRecommendReqVO.setLanguage(<span class="string">&quot;è‹±è¯­&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">language</span> <span class="operator">=</span> gptRecommendReqVO.getLanguage();</span><br><span class="line">        <span class="type">String</span> <span class="variable">cacheKey</span> <span class="operator">=</span> cacheKeyPreFix + <span class="string">&quot;v6&quot;</span> + <span class="string">&quot;:&quot;</span> + gptRecommendReqVO.getLanguage()+<span class="string">&quot;:&quot;</span>+gptRecommendReqVO.getValue();</span><br><span class="line">        cacheValue = recommendWordCache.get(cacheKey);</span><br><span class="line">        <span class="comment">//å‘½ä¸­</span></span><br><span class="line">        <span class="keyword">if</span>(StringUtils.isNotBlank(cacheValue))&#123;</span><br><span class="line">            log.info(<span class="string">&quot;GptGrpcWrapper call success,param:&#123;&#125;,result:&#123;&#125;&quot;</span>,JSON.toJSONString(gptRecommendReqVO),cacheValue);</span><br><span class="line">            <span class="comment">//å¤§æ®µæ–‡å­—ä¸­çš„[&quot;xxx1&quot;,&quot;xxx2&quot;,&quot;xxx3&quot;]</span></span><br><span class="line">            <span class="keyword">if</span>(cacheValue.contains(<span class="string">&quot;[&quot;</span>) &amp;&amp; cacheValue.contains(<span class="string">&quot;]&quot;</span>))&#123;</span><br><span class="line">                cacheValue = cacheValue.substring(cacheValue.indexOf(<span class="string">&quot;[&quot;</span>), cacheValue.lastIndexOf(<span class="string">&quot;]&quot;</span>) + <span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//åªå–å‰6ä¸ªï¼Œè¿™ä¸ªæ•°å€¼æ˜¯å‰ç«¯å®šçš„</span></span><br><span class="line">            Set&lt;String&gt; synonyms = getLimitSize(Lists.newArrayList(JSON.parseArray(cacheValue, String.class)), gptRecommendReqVO.getSize());</span><br><span class="line">            <span class="keyword">return</span> synonyms;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//æœªå‘½ä¸­</span></span><br><span class="line">        log.info(<span class="string">&quot;GptGrpcWrapper call param:&#123;&#125;,prompt:&#123;&#125;&quot;</span>,JSON.toJSONString(gptRecommendReqVO),prompt);</span><br><span class="line">        CompletableFuture&lt;String&gt; future = CompletableFuture.supplyAsync(</span><br><span class="line">                () -&gt; gptRequest(authInfo.getOrgId(),authInfo.getAccId(),authInfo.getEmail(),prompt, GPTModelVersionEnum.GPT_4O_MINI.getVersion()), GPT_REQUEST_EXECUTOR);</span><br><span class="line">        <span class="comment">//è¿™é‡Œå®é™…ä¸Šè¿˜æ˜¯åŒæ­¥è¯·æ±‚ï¼Œ&quot;gpt-recommard-future&quot;æ˜¯ä¸€ä¸ªæ—¥å¿—çš„åç§°ï¼Œè¶…æ—¶æ—¶é—´120s</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">res</span> <span class="operator">=</span> (String)FutureResultUtil.getResult(<span class="string">&quot;gpt-recommard-future&quot;</span>,future,<span class="number">120</span>, TimeUnit.SECONDS);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(res)) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;getRecommend failed.name:&#123;&#125;,language:&#123;&#125;&quot;</span>,formatValue, language);</span><br><span class="line">            <span class="keyword">return</span> Collections.emptySet();</span><br><span class="line">        &#125;</span><br><span class="line">        cacheValue = res;</span><br><span class="line">        <span class="comment">// æ¨èè¯ç¼“å­˜100å¤©</span></span><br><span class="line">        recommendWordCache.set(cacheKey,cacheValue,TimeUnit.DAYS.toMillis(<span class="number">100</span>));</span><br><span class="line">        log.info(<span class="string">&quot;GptGrpcWrapper call success,param:&#123;&#125;,result:&#123;&#125;&quot;</span>,JSON.toJSONString(gptRecommendReqVO),cacheValue);</span><br><span class="line">        <span class="keyword">if</span>(cacheValue.contains(<span class="string">&quot;[&quot;</span>) &amp;&amp; cacheValue.contains(<span class="string">&quot;]&quot;</span>))&#123;</span><br><span class="line">            cacheValue = cacheValue.substring(cacheValue.indexOf(<span class="string">&quot;[&quot;</span>), cacheValue.lastIndexOf(<span class="string">&quot;]&quot;</span>) + <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        Set&lt;String&gt; synonyms = getLimitSize(Lists.newArrayList(JSON.parseArray(cacheValue, String.class)), gptRecommendReqVO.getSize());</span><br><span class="line">        <span class="keyword">return</span> synonyms;</span><br><span class="line">    &#125;<span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="comment">//gptå‡ºçš„è¯å¦‚æœä¸å¸¸è§„ã€‚ä¾‹å¦‚æ˜¯â€œå¥½çš„ï¼Œæ¥ä¸‹æ¥ä¸ºæ‚¨è¾“å‡º....â€ï¼Œåœ¨JSON.parseArrayå°±ä¼šæŠ¥å¼‚å¸¸ä¸è¿”å›ç»™å‰ç«¯ã€‚</span></span><br><span class="line">        log.error(<span class="string">&quot;getGptRecommend param:&#123;&#125;&quot;</span>,JSON.toJSONString(gptRecommendReqVO), e);</span><br><span class="line">        <span class="keyword">return</span> Collections.emptySet();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<ol>
<li>redisåªå­˜gptåŸå§‹å›ç­”ï¼Œå¯ä»¥æ”¹æˆå¤„ç†åçš„å›ç­”</li>
<li>çº¿ç¨‹æ± å®é™…ä¸Šåªå°†è¿‘ä¼¼è¯å’Œç”µå•†è¯åšäº†å¼‚æ­¥ï¼Œåœ¨è¿™ä¸¤ä¸ªå•ç‹¬çš„è¯·æ±‚é‡Œé¢ç”¨futureå®é™…è¿˜æ˜¯åŒæ­¥ã€‚</li>
<li>gptå¦‚æœè¾“å‡ºä¸ç†æƒ³æœ‰ä¸¤é‡å¤„ç†ï¼Œé¦–å…ˆçœ‹æ˜¯å¦åŒ…å«äº†â€[â€œxxx1â€,â€xxx2â€,â€xxx3â€]â€ï¼Œç”¨subStringæå–å‡ºæ¥ï¼Œå®åœ¨æ˜¯æ²¡æœ‰é‚£åœ¨parseObjectå°±ä¼šæŠ¥é”™ï¼Œç»“æœè¿”å›ä¸ºç©ºã€‚</li>
</ol>
</blockquote>
<ul>
<li>æœ€åå¤„ç†è¿‘ä¼¼è¯å’Œç”µå•†è¯çš„ç»“æœï¼Œç”¨ä¸€ä¸ªå¤§çš„hashsetå»é‡ï¼ˆä½†æ˜¯å¤§å°å†™æ•æ„Ÿï¼Œè¿™é‡Œå¯ä»¥ä¼˜åŒ–æˆå…¨éƒ¨å°å†™å†æ¯”è¾ƒï¼‰</li>
<li>è°ƒç”¨GRPCï¼ˆæœ‰é“ç¿»è¯‘ï¼‰å…œåº•ï¼Œå…ˆåˆ¤æ–­æ˜¯å¦å‡ºç°ä¸­æ–‡ï¼Œæœ‰ä¸­æ–‡å°±ç¿»è¯‘ã€‚æ‰¹é‡ç¿»è¯‘è¿”å›å€¼æ˜¯mapï¼Œkeyæ˜¯åŸæ–‡ï¼Œvalueæ˜¯ç¿»è¯‘åçš„ã€‚æœ€åè¿›è¡Œç»„è£…è¿”å›ã€‚</li>
</ul>
<p><strong>æ€»ç»“ï¼šè°ƒç”¨æ˜“ç›¾è¿›è¡Œæ•æ„Ÿè¯æ£€æµ‹ï¼Œçº¿ç¨‹æ± +CompletableFutureå®Œæˆä¸¤æ¬¡gptæŸ¥è¯¢ï¼ŒgptæŸ¥è¯¢åšäº†ä¸€ç³»åˆ—å¼‚å¸¸å¤„ç†ï¼Œåœ¨redisä¸­ç¼“å­˜100å¤©ï¼Œæœ€åè°ƒç”¨æœ‰é“ç¿»è¯‘çš„grpcè¿›è¡Œå…œåº•ã€‚</strong></p>
<h4 id="è¡Œä¸šè¯"><a href="#è¡Œä¸šè¯" class="headerlink" title="è¡Œä¸šè¯"></a>è¡Œä¸šè¯</h4><ul>
<li>é¦–å…ˆåˆ¤æ–­æ˜¯å¦ä¸ºç©ºï¼Œæˆ–è€…æ˜¯å¦ä¸ºæ•æ„Ÿè¯ï¼ˆè°ƒç”¨ç½‘æ˜“æ˜“ç›¾ï¼‰ï¼Œéšåä¼ å…¥ç”¨æˆ·ä¿¡æ¯ï¼Œè®¿é—®æœåŠ¡ã€‚</li>
<li>æœåŠ¡å†…éƒ¨ï¼šå¤„ç†é€»è¾‘è·Ÿä¸Šæ–‡ç±»ä¼¼ï¼Œåœ¨redisä¸­å­˜å‚¨gptåŸå§‹å›ç­”ï¼Œä½†æ˜¯ç”±äºè¾“å‡ºçš„æ˜¯jsonï¼Œç›¸æ¯”äºè¿‘ä¼¼è¯å’Œè¡Œä¸šè¯çš„æ•°ç»„ï¼Œè¿™é‡Œæœ‰æ”¹å˜ã€‚</li>
<li>å»é™¤â€```jsonâ€å’Œâ€```â€œè¿™ç±»mdè¯­æ³•ï¼Œå†æ ¹æ®â€è¡Œä¸šä¸€ï¼ŒäºŒï¼Œä¸‰â€jsonå½¢å¼åŒ…è£…ã€‚</li>
<li>è¿™é‡Œè¦åšä¸€äº›å¼‚å¸¸å¤„ç†ä»¥å¢åŠ å¯ç”¨æ€§å’Œé²æ£’æ€§ï¼Œè™½ç„¶æç¤ºè¯é‡Œé¢å†™çš„æ˜¯ç”¨â€#â€œéš”å¼€ï¼Œä½†æ˜¯å®é™…ä¸Šå¯èƒ½è¿”å›çš„è¿˜æ˜¯â€,â€æˆ–è€…â€ã€â€ï¼Œç”¨ä¸€ä¸ªå‡½æ•°å¯¹å…¶è¿›è¡Œæ‹†åˆ†ã€‚</li>
<li>æœ€åè°ƒç”¨æœ‰é“ç¿»è¯‘å…œåº•ã€‚</li>
</ul>
<h2 id="éœ€æ±‚6ï¼šè®¢é˜…æ›´æ–°ä»»åŠ¡"><a href="#éœ€æ±‚6ï¼šè®¢é˜…æ›´æ–°ä»»åŠ¡" class="headerlink" title="éœ€æ±‚6ï¼šè®¢é˜…æ›´æ–°ä»»åŠ¡"></a>éœ€æ±‚6ï¼šè®¢é˜…æ›´æ–°ä»»åŠ¡</h2><p>è®¢é˜…æ›´æ–°é“¾è·¯ï¼š</p>
<ol>
<li>ç”¨æˆ·å‰ç«¯ç‚¹å‡»é¡µé¢å°±ä¼šæ›´æ–°è®¢é˜…å…¬å¸çš„watchTimeå­—æ®µï¼Œä¸€å¤©ä¹‹å†…åªæ›´æ–°ä¸€æ¬¡ã€‚</li>
<li>xxljobæ¯å‘¨æ‰«åº“ï¼Œæœç´¢çš„æ˜¯è®¢é˜…å…¬å¸çš„é‚£ä¸ªè¡¨ï¼Œå°†watchTimeåœ¨å‰ä¸€å‘¨çš„å…¬å¸å‘é€kafkaï¼ˆè‡ªå¢idè€Œä¸æ˜¯å…¬å¸idï¼‰</li>
<li>kafkaæ¶ˆè´¹è€…æ‹¿åˆ°è¿™äº›idå»æ•°æ®åº“æ‰¾å¯¹åº”çš„å…¬å¸ï¼Œå°†è®¢é˜…å…¬å¸è¡¨é¡¹å’Œå…¬å¸å®ä½“é¡¹ï¼ˆä»esæ¥çš„ï¼Œå¦‚æœå‰è€…æœ‰companyIdå°±ç›´æ¥æŸ¥è¯¢ï¼Œå¦‚æœæ²¡æœ‰å°±éœ€è¦æ ¹æ®åå­—å’Œåœ°åŒºæ¥æŸ¥è¯¢å¹¶ä¿å­˜ï¼‰ä½œä¸ºå‚æ•°ä¼ åˆ†åˆ«åˆ†æ<strong>facebookä¿¡æ¯ï¼ŒfacebookæåŠä¿¡æ¯ï¼Œæµ·å…³ä¿¡æ¯ï¼Œè”ç³»äººä¿¡æ¯</strong>ï¼Œå¼€äº†ä¸€ä¸ªçº¿ç¨‹æ± å¹¶è¡Œå¤„ç†è¿™äº›ã€‚</li>
</ol>
<h3 id="1-facebookä¿¡æ¯"><a href="#1-facebookä¿¡æ¯" class="headerlink" title="1.facebookä¿¡æ¯"></a>1.facebookä¿¡æ¯</h3><p>ä»£ç å¤ªé•¿äº†ï¼Œæ¢³ç†ä¸€ä¸‹å°±è¿™å‡ éƒ¨åˆ†ï¼š</p>
<ol>
<li>æ ¹æ®å…¬å¸å®ä½“ä¸­çš„ç›¸å…³facebooké“¾æ¥å»è¯·æ±‚GRPCæ¥å£ï¼Œè¿”å›facebookå®ä½“ï¼Œå…¶ä¸­åŒ…å«ä¸ªäººä¿¡æ¯ï¼Œç‚¹èµæ•°é‡ï¼Œæœ€è¿‘æ¨æ–‡ç­‰ä¿¡æ¯ã€‚</li>
<li>ä»è¿™é‡Œå¼€å§‹è¦æ³¨æ„é€»è¾‘ï¼Œæ¯”å¯¹çš„æ˜¯<strong>GRPCè¯·æ±‚æ¥çš„æ•°æ®</strong>å’Œ<strong>å½“å‰æ•°æ®åº“ä¸­æœ€æ–°çš„log</strong>ã€‚</li>
<li>å»æ•°æ®åº“ä¸­æŸ¥è¯¢7ç§typeçš„logï¼Œå…ˆå…¨éƒ¨æŸ¥å‡ºæ¥ï¼Œç„¶åå†é€šè¿‡streamå’Œsortå¾—åˆ°æœ€è¿‘æ—¶é—´çš„logã€‚</li>
<li>å°†è¿™äº›logåˆ†åˆ«ä¸GRPCè¯·æ±‚æ¥çš„æ•°æ®è¿›è¡Œæ¯”è¾ƒï¼Œä¾‹å¦‚åˆ¤æ–­facebookæ˜¯å¦æ›´æ–°äº†ï¼Œå°†æœ€è¿‘çš„ä¸€æ¡ç›¸å…³logçš„å†…å®¹æ‹‰å‡ºæ¥ä¸GRPCè¯·æ±‚æ¥çš„æ•°æ®è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœä¸ä¸€æ ·å°±éœ€è¦æ›´æ–°ï¼Œåœ¨åº“é‡Œé¢æ–°å¢ä¸€æ¡ã€‚</li>
</ol>
<blockquote>
<ol>
<li>facebookåœ°å€åˆå§‹åŒ–&#x2F;å˜æ›´</li>
<li>facebooké‚®ç®±åˆå§‹åŒ–&#x2F;å˜æ›´</li>
<li>facebookç½‘ç«™åœ°å€åˆå§‹åŒ–&#x2F;å˜æ›´</li>
<li>facebookç”µè¯åˆå§‹åŒ–&#x2F;å˜æ›´</li>
<li>facebookç‚¹èµã€å…³æ³¨åˆå§‹åŒ–</li>
<li>facebookä¸­å‘å¸ƒäº†æ–°å¸–å­</li>
<li>facebookè·å¾—1ä¸ªæ–°è¯„è®º</li>
</ol>
</blockquote>
<h3 id="2-facebookæåŠä¿¡æ¯"><a href="#2-facebookæåŠä¿¡æ¯" class="headerlink" title="2.facebookæåŠä¿¡æ¯"></a>2.facebookæåŠä¿¡æ¯</h3><ol>
<li>ç±»ä¼¼ä¸Šé¢çš„ï¼ŒæåŠæ¶ˆæ¯ä¹Ÿæ˜¯ä»GRPCæ¥çš„ï¼Œå¦‚æœè¿”å›ä¸ºnullç›´æ¥è¿”å›ï¼Œè¿™é‡Œæ˜¯ä¸€ä¸ªlistï¼Œåªå…³æ³¨æœ€æ–°çš„ï¼Œæ‰€ä»¥ä¹Ÿæœ‰stream+sortã€‚</li>
<li>å»æ•°æ®åº“æŸ¥è¯¢å½“å‰æœ€æ–°çš„logï¼Œä¸»è¦å…³æ³¨çš„æ˜¯è¿™ä¸ªè®°å½•çš„createTimeã€‚</li>
<li>å¦‚æœæ•°æ®åº“æ²¡æœ‰ï¼Œé‚£å°±è¯´æ˜æ˜¯æœ€æ–°æ›´æ–°çš„ï¼Œå‘æ•°æ®åº“æ’å…¥ä¸€æ¡æ–°çš„logè¡¨æ˜æœ‰è¢«æåŠï¼Œç›´æ¥è¿”å›ã€‚</li>
<li>å¦‚æœæ•°æ®åº“æœ‰ä½†logçš„æ—¶é—´æ¯”GRPCæ¥çš„æ—©ï¼Œè¯´æ˜æœ‰æ–°æåŠï¼Œè¿›è¡Œæ›´æ–°ã€‚</li>
</ol>
<h3 id="3-æµ·å…³ä¿¡æ¯"><a href="#3-æµ·å…³ä¿¡æ¯" class="headerlink" title="3.æµ·å…³ä¿¡æ¯"></a>3.æµ·å…³ä¿¡æ¯</h3><ol>
<li>å°†å…¬å¸åç§°æ ¼å¼åŒ–ï¼Œéšåå»æµ·å…³æ•°æ®é‡Œé¢æŸ¥æ‰¾æ–°å¢è¿›å‡ºå£æ•°æ®ï¼Œåˆ†åˆ«æ”¾åœ¨ä¸¤ä¸ªlisté‡Œé¢ã€‚</li>
<li>å¦‚æœæœ‰è¿›å‡ºå£å°±åˆ†åˆ«æ–°å¢logã€‚</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">customProcess</span><span class="params">(TbGlobalCollectEntity record, CompanySearchBO companyBO, Date startDate, Date endDate)</span> &#123;</span><br><span class="line">    <span class="comment">//æµ·å…³é‚£è¾¹çš„ç»Ÿä¸€æ ¼å¼&quot;CompanyName-COMBINE-TANZANIA&quot;ä¾‹å¦‚&quot;101 INVESTMENT-COMBINE-TANZANIA&quot;</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">nameAndCountry</span> <span class="operator">=</span> CompanyFormatUtils.combineCompanyNameAndCountry(companyBO.getName(), companyBO.getCountry());</span><br><span class="line">    <span class="comment">//å»å–å‡ºæ˜¨å¤©çš„æ–°å¢hscodeï¼Œè¿™ä¸ªè¡¨ä¸»è¦æ˜¯æµ·å…³ç³»ç»Ÿåœ¨ç»´æŠ¤</span></span><br><span class="line">    Map&lt;String, CustomInfoBO&gt; map = customDataComponent.batchGetCompanyNewTrxHscode(Lists.newArrayList(nameAndCountry), startDate, endDate);</span><br><span class="line">    List&lt;TbGlobalCollectLogEntity&gt; tbGlobalCollectLogEntities = Lists.newArrayList();</span><br><span class="line">    <span class="keyword">if</span>(map.containsKey(nameAndCountry))&#123;</span><br><span class="line">        <span class="type">CustomInfoBO</span> <span class="variable">customInfoBO</span> <span class="operator">=</span> map.get(nameAndCountry);</span><br><span class="line">        <span class="comment">//å‡ºå£</span></span><br><span class="line">        <span class="keyword">if</span>(!CollectionUtils.isEmpty(customInfoBO.getExportHsCodeList()))&#123;</span><br><span class="line">            <span class="type">TbGlobalCollectLogEntity</span> <span class="variable">t</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TbGlobalCollectLogEntity</span>();</span><br><span class="line">            t.setCollectId(record.getId());</span><br><span class="line">            t.setLogDesc(<span class="string">&quot;æ–°ä¾›åº”äº†hscodeä¸º&quot;</span> + Strings.join(customInfoBO.getExportHsCodeList(), <span class="string">&quot;,&quot;</span>) + <span class="string">&quot;ç­‰çš„å•†å“&quot;</span>);</span><br><span class="line">            t.setContent(JSON.toJSONString(customInfoBO.getExportHsCodeList()));</span><br><span class="line">            t.setType(CollectLogTypeEnum.CUSTOM_SHN.getType());</span><br><span class="line">            t.setCreateTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">            t.setUpdateTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">            t.setInit12(<span class="number">0</span>);</span><br><span class="line">            tbGlobalCollectLogEntities.add(t);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//è¿›å£</span></span><br><span class="line">        <span class="keyword">if</span>(!CollectionUtils.isEmpty(customInfoBO.getImportHsCodeList()))&#123;</span><br><span class="line">            <span class="type">TbGlobalCollectLogEntity</span> <span class="variable">t</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TbGlobalCollectLogEntity</span>();</span><br><span class="line">            t.setCollectId(record.getId());</span><br><span class="line">            t.setLogDesc(<span class="string">&quot;æ–°é‡‡è´­äº†hscodeä¸º&quot;</span> + Strings.join(customInfoBO.getImportHsCodeList(), <span class="string">&quot;,&quot;</span>) + <span class="string">&quot;ç­‰çš„å•†å“&quot;</span>);</span><br><span class="line">            t.setContent(JSON.toJSONString(customInfoBO.getImportHsCodeList()));</span><br><span class="line">            t.setType(CollectLogTypeEnum.CUSTOM_CON.getType());</span><br><span class="line">            t.setCreateTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">            t.setUpdateTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">            t.setInit12(<span class="number">0</span>);</span><br><span class="line">            tbGlobalCollectLogEntities.add(t);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!CollectionUtils.isEmpty(tbGlobalCollectLogEntities))&#123;</span><br><span class="line">        tbGlobalCollectLogEntityService.saveAll(tbGlobalCollectLogEntities);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-è”ç³»äººä¿¡æ¯"><a href="#4-è”ç³»äººä¿¡æ¯" class="headerlink" title="4.è”ç³»äººä¿¡æ¯"></a>4.è”ç³»äººä¿¡æ¯</h3>
    
    
  </div>

  

  

</article>
  
  <article class="post">
  <header class="post-header">
    <h1 class="post-title">
      
      <a class="post-link" href="/2024/12/05/%E7%BD%91%E6%98%93%E7%89%9B%E9%A9%AC%E6%97%A5%E5%BF%97-week3/">ç½‘æ˜“ç‰›é©¬æ—¥å¿—-week3</a>
      
    </h1>

    <div class="post-meta">
      <span class="post-time">
        2024-12-05
      </span>
      
      
      
    </div>
  </header>

  

  <div class="post-content">
    
    
    

    
    <h1 id="éœ€æ±‚3ï¼šä¼˜åŒ–åº”ç”¨ä¾§åˆ†é¡µæŸ¥è¯¢æ”¶è—æ¥å£"><a href="#éœ€æ±‚3ï¼šä¼˜åŒ–åº”ç”¨ä¾§åˆ†é¡µæŸ¥è¯¢æ”¶è—æ¥å£" class="headerlink" title="éœ€æ±‚3ï¼šä¼˜åŒ–åº”ç”¨ä¾§åˆ†é¡µæŸ¥è¯¢æ”¶è—æ¥å£"></a>éœ€æ±‚3ï¼šä¼˜åŒ–åº”ç”¨ä¾§åˆ†é¡µæŸ¥è¯¢æ”¶è—æ¥å£</h1><p>åˆ©ç”¨ä¸ŠwatchTimeå­—æ®µï¼Œxxljobåªæ›´æ–°ä¸Šä¸€å‘¨æŸ¥çœ‹è¿‡çš„æ¡ç›®ï¼Œå¯ä»¥å‡å°‘å¸¦å®½ã€‚</p>
<h2 id="1-æ”¹é€ åˆ¤æ–­é€»è¾‘"><a href="#1-æ”¹é€ åˆ¤æ–­é€»è¾‘" class="headerlink" title="1.æ”¹é€ åˆ¤æ–­é€»è¾‘"></a>1.æ”¹é€ åˆ¤æ–­é€»è¾‘</h2><p>ä¿å­˜watchTimeï¼Œé¦–å…ˆéœ€è¦è·å¾—è¯¥ç”¨æˆ·çš„accountIdï¼Œè¿˜è¦è·å–æŸä¸€æ¡æ¨èå¯¹è±¡çš„æ—§watchTimeï¼Œåˆ¤æ–­æ˜¯å¦æ˜¯ä»Šå¤©ï¼Œå¦‚æœæ˜¯ä¸€å¤©é‚£å°±ä¸ç”¨æ›´æ–°ï¼Œå¦‚æœæ˜¯ä¸€å¤©å°±éœ€è¦æ›´æ–°ã€‚</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if (!pageRes.getContent().isEmpty())&#123;</span><br><span class="line">    Date oldWatchTime = pageRes.getContent().get(0).getWatchTime();</span><br><span class="line">    watchTimeJudgeAndUpdate(Long.parseLong(AuthInfoUtils.getContext().getAuthInfo().getAccId()),oldWatchTime);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è¿™ä¸ªæ–¹æ³•æŒ‰é“ç†æ¥è¯´è¦å˜æˆå¼‚æ­¥çš„ï¼Œçœ‹åç»­ç”¨å¤šçº¿ç¨‹æˆ–è€…@Asyncè§£å†³</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">watchTimeJudgeAndUpdate</span><span class="params">(Long accountId,Date oldWatchTime)</span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//ä¸€å¤©åªä¿å­˜ä¸€æ¬¡watchTime</span></span><br><span class="line">        <span class="keyword">if</span> (oldWatchTime == <span class="literal">null</span> || !isSameDay(oldWatchTime,<span class="keyword">new</span> <span class="title class_">Date</span>()))&#123;</span><br><span class="line">            tbGlobalCollectEntityService.updateWatchTime(accountId);</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(<span class="string">&quot;watchTimeUpdate success , accountId : &#123;&#125;&quot;</span>,accountId);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Throwable e)&#123;</span><br><span class="line">        log.error(<span class="string">&quot;watchTimeUpdate failed , accountId : &#123;&#125;&quot;</span>,accountId,e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isSameDay</span><span class="params">(Date date1, Date date2)</span> &#123;</span><br><span class="line">    <span class="type">SimpleDateFormat</span> <span class="variable">sdf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyyMMdd&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> sdf.format(date1).equals(sdf.format(date2));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œåˆšå¼€å§‹æ˜¯ç”¨äº†jpaçš„æŠ½è±¡ä»“åº“ä¸€ä¸ªä¸€ä¸ªæ›´æ–°ï¼Œä½†æ˜¯mentorè¯´æ•ˆç‡å¤ªä½äº†ï¼Œä¸å¦‚ç›´æ¥å†™sqlï¼Œåœ¨è¿™ä¸ªæ–¹æ³•é‡Œé¢æ”¯æŒè·Ÿmybatisé‚£æ ·ç›´æ¥æ‰§è¡Œsqlã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TbGlobalCollectEntityService</span> <span class="keyword">extends</span> <span class="title class_">AbstractEasyEntityService</span>&lt;TbGlobalCollectEntity&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TbGlobalCollectRepository repository;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateWatchTime</span><span class="params">(Long accountId)</span>&#123;</span><br><span class="line">        repository.updateWatchTime(accountId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>sqlæ˜¯æ›´æ–°æ‰€æœ‰å½“å‰accountIdä¸‹ï¼Œæ²¡æœ‰å–æ¶ˆæ‰çš„æ¨èæ¡ç›®ï¼ŒæŠŠä»–ä»¬çš„watchTimeéƒ½æ”¹ä¸ºç°åœ¨ã€‚</p>
<p>è¿™é‡Œä¸éœ€è¦è¿”å›å½“å‰æ—¶é—´ï¼Œå°±æ›´åŠ è¯´æ˜è¿™ä¸ªåˆ¤æ–­é€»è¾‘è·Ÿå‰ç«¯æ²¡ä»€ä¹ˆå…³ç³»äº†ï¼Œæ‰€ä»¥åº”è¯¥ç”¨å¼‚æ­¥ã€‚</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Modifying</span><br><span class="line">@Transactional</span><br><span class="line">@Query(value = &quot;update TbGlobalCollectEntity p set p.watchTime=NOW() where p.status != -1 and p.accountId = :accountId&quot;)</span><br><span class="line">int updateWatchTime(@Param(&quot;accountId&quot;) Long accountId);</span><br></pre></td></tr></table></figure>

<h2 id="2-xxljobæ”¹é€ "><a href="#2-xxljobæ”¹é€ " class="headerlink" title="2.xxljobæ”¹é€ "></a>2.xxljobæ”¹é€ </h2><p>ä¿å­˜äº†watchTimeï¼Œæ¯å‘¨æ‰§è¡Œä¸€æ¬¡çš„å®šæ—¶ä»»åŠ¡éœ€è¦æ”¹æˆæŸ¥è¯¢æ‰€æœ‰watchTimeä¸ºä¸Šå‘¨çš„æ¡ç›®ã€‚</p>
<p>DateUtilè¿™ä¸ªå·¥å…·å¯ä»¥æ‰¾åˆ°ä»Šå¤©0ç‚¹å’Œä¸Šå‘¨0ç‚¹çš„Dateå¯¹è±¡ï¼Œç„¶åå†ç”¨jpaè¿›è¡ŒæŸ¥è¯¢ï¼ŒæŠŠæ‰€æœ‰çš„æ•°æ®æŠ•å…¥kafkaé‡Œã€‚</p>
<blockquote>
<p>ä¼˜åŒ–çš„æœ¬æ„æ˜¯å‡å°‘éƒ¨åˆ†æŒ–æ˜facebookçš„æµé‡ã€‚ä½†æ˜¯å› ä¸ºåœ¨è¿™ä¸ªtopicé‡Œé¢ä¸æ­¢æœ‰è¿™ä¸ªä»»åŠ¡ï¼Œè¿˜æœ‰éƒ¨åˆ†é€šè®¯å½•æŒ–æ˜çš„ä»»åŠ¡ã€‚å‡å°‘äº†è¿™éƒ¨åˆ†æµé‡åŒæ—¶ä¹Ÿä¼šå‡å°‘é€šè®¯å½•æŒ–æ˜çš„æµé‡ï¼Œä½†æ˜¯åè€…æ›´åŠ æœ‰ä»·å€¼ï¼Œå¹¶ä¸åº”è¯¥å‡å°‘ã€‚æ‰€ä»¥æŒ‰ç…§é“ç†æ¥è¯´åº”è¯¥åˆ†ä¸ºä¸¤ä¸ªtopicè¿›è¡Œæ“ä½œã€‚</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">collectLogUpdate</span><span class="params">(<span class="type">int</span> param)</span> &#123;</span><br><span class="line">    <span class="type">Date</span> <span class="variable">endDate</span> <span class="operator">=</span> DateUtil.trimAndIncreDate(<span class="keyword">new</span> <span class="title class_">Date</span>(),<span class="number">0</span>);</span><br><span class="line">    <span class="type">Date</span> <span class="variable">startDate</span> <span class="operator">=</span> DateUtil.trimAndDecreDate(<span class="keyword">new</span> <span class="title class_">Date</span>(), param);</span><br><span class="line">    List&lt;Specification&lt;TbGlobalCollectEntity&gt;&gt; specifications = Lists.newArrayList();</span><br><span class="line">    specifications.add(of(TbGlobalCollectEntity.class, <span class="string">&quot;status&quot;</span>, NEQ, GlobalSubscribeStatusEnum.DELETE.getStatus()));</span><br><span class="line">    specifications.add(of(TbGlobalCollectEntity.class, <span class="string">&quot;watchTime&quot;</span>, GTE, startDate));</span><br><span class="line">    specifications.add(of(TbGlobalCollectEntity.class, <span class="string">&quot;watchTime&quot;</span>, LTE, endDate));</span><br><span class="line">    List&lt;TbGlobalCollectEntity&gt; records = tbGlobalCollectEntityService.findAll(specifications);</span><br><span class="line">    <span class="keyword">if</span> (CollectionUtils.isEmpty(records)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (TbGlobalCollectEntity record : records) &#123;</span><br><span class="line">        kafkaProducer.send(KafkaConstants.COWORK_GLOBAL_COLLECT_DETAIL_CHANGE, String.valueOf(record.getId()), String.valueOf(record.getId()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="éœ€æ±‚4ï¼šæŸ¥éªŒ500æ¡æ•°æ®"><a href="#éœ€æ±‚4ï¼šæŸ¥éªŒ500æ¡æ•°æ®" class="headerlink" title="éœ€æ±‚4ï¼šæŸ¥éªŒ500æ¡æ•°æ®"></a>éœ€æ±‚4ï¼šæŸ¥éªŒ500æ¡æ•°æ®</h2><p>è¿™ä¸ªçš„å·¥ä½œé‡ä¸åœ¨ä»£ç ä¸Šè€Œåœ¨äºexcelä¸Šï¼Œå­¦åˆ°äº†ä¸€äº›æŠ€å·§ã€‚</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">GET cowork_global_domain_info/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot; must &quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;exists&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;recommendData&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">    ,&quot;sort&quot;: &#123;</span><br><span class="line">    &quot;_script&quot;: &#123;</span><br><span class="line">      &quot;script&quot;: &quot;Math.random()&quot;,</span><br><span class="line">      &quot;type&quot;: &quot;number&quot;,</span><br><span class="line">      &quot;order&quot;: &quot;asc&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  ,&quot;_source&quot;: [&quot;recommendData&quot;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>éœ€è¦æ³¨æ„çš„ç‚¹ï¼š</p>
<ol>
<li>éšæœºä»917wä¸­æ‰¾ï¼Œè¿™é‡Œsortè¦ç”¨randomè„šæœ¬</li>
<li>æœ€å¥½ä¸è¦ç”¨æ»šåŠ¨æŸ¥è¯¢ï¼Œæœ‰å¤šå°‘æ¡æ˜¯å¤šå°‘æ¡</li>
<li>searchHitå¯¹è±¡æ˜¯ä¸€ä¸ªå¤§çš„å¯¹è±¡DomainIndexBOï¼ŒrecommendDataåªæ˜¯å…¶ä¸­çš„ä¸€ä¸ªå­—æ®µã€‚æ‰€ä»¥getSourceAsStringåŒ…è£…çš„æ˜¯DomainIndexBOï¼Œåˆšå¼€å§‹ç±»å‹è½¬æ¢æ²¡å¼„æ˜ç™½è€½è¯¯å¾ˆä¹…ã€‚</li>
<li>excelå°æŠ€å·§ï¼šåœ¨è¿™ç§éœ€è¦ä¿ç•™å¾ˆå¤šå­—æ®µçš„æ—¶å€™å¯ä»¥ç”¨ï¿¥(dollarç¬¦)åˆ†å¼€ï¼Œå› ä¸ºå¾ˆå°‘æœ‰ä¸šåŠ¡é‡Œé¢ä¼šç”¨ï¼Œé˜²æ­¢è¯¯æ“ä½œã€‚ä¾‹å¦‚åœ¨è¿™ä¸ªåœºæ™¯é‡Œé¢æ—¥å¿—å¯ä»¥æ‰“å°æˆâ€{recommendData.domain}ï¿¥{recomendData.other}â€ï¼Œç„¶ååœ¨excelæŒ‰ç…§ï¿¥åˆ†è¡Œã€‚</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">esGet</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Script</span> <span class="variable">script</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Script</span>(<span class="string">&quot;Math.random()&quot;</span>);</span><br><span class="line">    <span class="type">ScriptSortBuilder</span> <span class="variable">sortBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ScriptSortBuilder</span>(script, ScriptSortBuilder.ScriptSortType.NUMBER)</span><br><span class="line">            .order(SortOrder.ASC);</span><br><span class="line">    <span class="type">BoolQueryBuilder</span> <span class="variable">boolQuery</span> <span class="operator">=</span> QueryBuilders.boolQuery();</span><br><span class="line">    boolQuery.must(QueryBuilders.existsQuery(<span class="string">&quot;recommendData&quot;</span>));</span><br><span class="line">    <span class="type">SearchSourceBuilder</span> <span class="variable">sourceBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchSourceBuilder</span>()</span><br><span class="line">            .query(boolQuery) <span class="comment">// æŸ¥è¯¢å‚æ•°</span></span><br><span class="line">            .fetchSource(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;recommendData&quot;</span>&#125;, <span class="literal">null</span>)</span><br><span class="line">            .sort(sortBuilder)</span><br><span class="line">            .size(<span class="number">500</span>);</span><br><span class="line">    SearchHit[] searchHits = domainDataIndex.query(sourceBuilder);</span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (SearchHit searchHit : searchHits) &#123;</span><br><span class="line">        <span class="type">DomainIndexBO</span> <span class="variable">domainIndexBO</span> <span class="operator">=</span> JSON.parseObject(searchHit.getSourceAsString(),DomainIndexBO.class);</span><br><span class="line">        <span class="type">RecommendDataBO</span> <span class="variable">recommendData</span> <span class="operator">=</span> domainIndexBO.getRecommendData();</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">stringBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        stringBuilder.append(<span class="string">&quot;$&quot;</span>);</span><br><span class="line">        stringBuilder.append(recommendData.getDomain()).append(<span class="string">&quot;$&quot;</span>);</span><br><span class="line">        stringBuilder.append(String.join(<span class="string">&quot;,&quot;</span>, recommendData.getProducts())).append(<span class="string">&quot;$&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (recommendData.getAliCategories().isEmpty())&#123;</span><br><span class="line">            stringBuilder.append(<span class="string">&quot;null&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (RecommendDataBO.AliCategory aliCategory : recommendData.getAliCategories()) &#123;</span><br><span class="line">                stringBuilder.append(aliCategory.getName()).append(<span class="string">&quot;:&quot;</span>).append(aliCategory.getScore()).append(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        stringBuilder.append(<span class="string">&quot;$&quot;</span>).append(recommendData.getIsBizP()).append(<span class="string">&quot;$&quot;</span>);</span><br><span class="line">        stringBuilder.append(recommendData.getIsBizVersion()).append(<span class="string">&quot;$&quot;</span>);</span><br><span class="line">        stringBuilder.append(recommendData.getProductsVersion()).append(<span class="string">&quot;$&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(recommendData.getAliCategoryVersion()))&#123;</span><br><span class="line">            stringBuilder.append(<span class="string">&quot;null&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            stringBuilder.append(recommendData.getAliCategoryVersion());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> stringBuilder.toString();</span><br><span class="line">        log.info(<span class="string">&quot;ç¬¬&quot;</span>+i+<span class="string">&quot;ä¸ª:&quot;</span>+result);</span><br><span class="line">        i++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ã€‚ã€‚ã€‚æœªå®Œå¾…ç»­</p>

    
    
  </div>

  

  

</article>
  
  <article class="post">
  <header class="post-header">
    <h1 class="post-title">
      
      <a class="post-link" href="/2024/12/02/%E7%BD%91%E6%98%93%E7%89%9B%E9%A9%AC%E6%97%A5%E5%BF%97-week1-2/">ç½‘æ˜“ç‰›é©¬æ—¥å¿—-week1-2</a>
      
    </h1>

    <div class="post-meta">
      <span class="post-time">
        2024-12-02
      </span>
      
      
      
    </div>
  </header>

  

  <div class="post-content">
    
    
    

    
    <h1 id="éœ€æ±‚1ï¼šä¸æ¨èä¾§æ•°æ®åŒæ­¥"><a href="#éœ€æ±‚1ï¼šä¸æ¨èä¾§æ•°æ®åŒæ­¥" class="headerlink" title="éœ€æ±‚1ï¼šä¸æ¨èä¾§æ•°æ®åŒæ­¥"></a>éœ€æ±‚1ï¼šä¸æ¨èä¾§æ•°æ®åŒæ­¥</h1><h2 id="1-é…ç½®kafka"><a href="#1-é…ç½®kafka" class="headerlink" title="1.é…ç½®kafka"></a>1.é…ç½®kafka</h2><p>kafkaæ‰¹é‡æ¶ˆè´¹ï¼Œè®¾ç½®æ¶ˆè´¹è€…ç»„ï¼Œä½¿å¾—æ¯æ¬¡æ¶ˆè´¹çš„æ—¶å€™ä»å¤´æ¶ˆè´¹</p>
<blockquote>
<p>æ¶ˆè´¹è€…ç»„èƒ½ä»å¤´å¼€å§‹æ¶ˆè´¹å¿…é¡»å¾—æœ‰æ¶ˆæ¯ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœæ¶ˆæ¯è¿‡æœŸäº†è¿˜æ˜¯æ¶ˆè´¹ä¸äº†çš„ï¼Œè¿™ä¸ªè¿‡æœŸæ—¶é—´åœ¨delete.retention.msé‡Œé¢é…ç½®ï¼Œå½“å‰topicçš„è¿‡æœŸæ—¶é—´æ˜¯604800000ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªç¤¼æ‹œã€‚</p>
<p>è¿˜æœ‰ä¸€ç§åŠæ³•æ˜¯é€šè¿‡kafkaç»™å®šçš„æŸä¸ªè„šæœ¬å‚æ•°æ¥æŒ‡å®šoffsetçš„æ¶ˆè´¹ä½ç½®ã€‚</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> KafkaListenerContainerFactory&lt;ConcurrentMessageListenerContainer&lt;String, String&gt;&gt;</span><br><span class="line"><span class="title function_">recommendDomainDataListenerContainer</span><span class="params">(KafkaProperties kafkaProperties)</span> &#123;</span><br><span class="line">    ConcurrentKafkaListenerContainerFactory&lt;String, String&gt; factory = <span class="keyword">new</span> <span class="title class_">ConcurrentKafkaListenerContainerFactory</span>&lt;&gt;();</span><br><span class="line">    Map&lt;String, Object&gt; map = kafkaProperties.buildConsumerProperties();</span><br><span class="line">    <span class="comment">//æ‰¹é‡æ¶ˆè´¹50ä¸ª</span></span><br><span class="line">    map.put(ConsumerConfig.MAX_POLL_RECORDS_CONFIG, <span class="number">50</span>);</span><br><span class="line">    map.put(ConsumerConfig.MAX_POLL_INTERVAL_MS_CONFIG, <span class="number">10</span> * <span class="number">60</span> * <span class="number">1000</span>);</span><br><span class="line">    map.put(ConsumerConfig.HEARTBEAT_INTERVAL_MS_CONFIG, <span class="number">3000</span>); <span class="comment">// 3ç§’ä¸ŠæŠ¥ä¸€æ¬¡å¿ƒè·³</span></span><br><span class="line">    map.put(ConsumerConfig.SESSION_TIMEOUT_MS_CONFIG, <span class="number">10</span> * <span class="number">60</span> * <span class="number">1000</span>);</span><br><span class="line">    map.put(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG, <span class="string">&quot;earliest&quot;</span>);<span class="comment">//æ¶ˆè´¹è€…ç»„æ¯æ¬¡éƒ½ä»å¤´å¼€å§‹æ¶ˆè´¹</span></span><br><span class="line">    ConsumerFactory&lt;String, String&gt; consumerFactory = <span class="keyword">new</span> <span class="title class_">DefaultKafkaConsumerFactory</span>&lt;&gt;(map);</span><br><span class="line">    factory.setConsumerFactory(consumerFactory);</span><br><span class="line">    factory.setConcurrency(<span class="number">2</span>); <span class="comment">// 2ä¸ªçº¿ç¨‹</span></span><br><span class="line">    factory.setBatchListener(<span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">return</span> factory;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-é…ç½®kafkaçš„æ¶ˆè´¹è€…"><a href="#2-é…ç½®kafkaçš„æ¶ˆè´¹è€…" class="headerlink" title="2.é…ç½®kafkaçš„æ¶ˆè´¹è€…"></a>2.é…ç½®kafkaçš„æ¶ˆè´¹è€…</h2><p>ç”±äºæ˜¯æ‰¹é‡è¯·æ±‚rpcæ¥å£ï¼Œå› æ­¤éœ€è¦è§£å†³è¯·æ±‚å¤±è´¥å¸¦æ¥çš„<strong>æ¶ˆæ¯ä¸¢å¤±</strong>é—®é¢˜ï¼Œæ„æ€æ˜¯å¦‚æœè¯·æ±‚å¤±è´¥äº†ï¼Œè¿™äº›domainè¿˜ä¼šè¢«æ¶ˆè´¹ï¼Œè¿™é‡Œçš„æ€è·¯æ˜¯ç”¨ä¸€ä¸ªsetæ¥ä¿å­˜æ²¡æœ‰æ¶ˆè´¹çš„domainï¼Œå¦‚æœåœ¨æŸå¤„å‡ºé”™äº†ï¼Œå°±ä¼šé‡æ–°å¾€kafkaé‡Œé¢å‘æ¶ˆæ¯ï¼Œå®ç°ä¸æ¼æ¶ˆæ¯ã€‚</p>
<blockquote>
<p>2024.12.2 åœ¨è¿™ä¸Šé¢æ ½äº†è·Ÿå¤´</p>
<p>æƒ³æ³•å¾ˆç¾å¥½ä½†æ˜¯å®é™…ä¸Šçº¿è¿˜æ˜¯å‡ºç°äº†æ¼æ¶ˆæ¯ï¼ŒæˆåŠŸç‡åªæœ‰90%ã€‚</p>
<p>é¦–å…ˆè¿™ä¸ªdomainSetä¸èƒ½è®¾ç½®æˆå…¨å±€å˜é‡ï¼Œå› ä¸ºæ‰€æœ‰çš„çº¿ç¨‹éƒ½ä¼šæ›´æ”¹è¿™ä¸ªå˜é‡ï¼Œä¼šæœ‰å¤æ‚çš„å¹¶å‘å®‰å…¨é—®é¢˜ã€‚å…¶æ¬¡æ˜¯å¯èƒ½å‡ºç°å¼‚å¸¸çš„æ—¶é—´ç‚¹ï¼š</p>
<ul>
<li>æ¶ˆè´¹çš„æ—¶å€™å°±å‡ºç°é—®é¢˜ï¼Œå¯èƒ½æ€§å¾ˆå°</li>
<li>æ‹¿ç€æ‰€æœ‰50æ¡å»è¯·æ±‚rpcæ¥å£çš„æ—¶å€™</li>
<li>rpcæ¥å£å¤±è´¥æˆ–è€…åˆ«çš„çŠ¶æ€ç </li>
<li>esæ›´æ–°å‡ºé”™</li>
</ul>
<p>ç”±æ­¤å¯è§éœ€è¦åœ¨rpcæ¥å£è¯·æ±‚ä¹‹å‰å°±è¦åˆå§‹åŒ–domainSetï¼Œæ‰€ä»¥åœ¨æ¶ˆè´¹æ¶ˆæ¯çš„æ—¶å€™å°±éœ€è¦åŒæ—¶åŠ å…¥domainSetã€‚ä½†å¦‚æœrpcæ¥å£è¯·æ±‚æˆåŠŸäº†ï¼Œéœ€è¦æ¸…ç©ºdomainSetï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸ºæœ‰å¯èƒ½domainæ˜¯50ä¸ªï¼Œé‚£è¾¹åªæœ‰40ä¸ªå¯è¿”å›åŸŸåï¼Œå¦‚æœå†æŒ‰ç…§50ä¸ªå°±ä¼šæœ‰æ¶ˆæ¯è¢«é‡å¤å‘é€ï¼Œä¾‹å¦‚è™½ç„¶æ¶ˆæ¯é‡Œé¢æœ‰<a target="_blank" rel="noopener" href="http://www.baidu.com,ä½†æ˜¯rpcæ¥å£é‡Œé¢æ­»æ´»æ²¡æœ‰,è¿™ä¸ªæ—¶å€™å†å»é‡æ–°å¾€kafkaé‡Œé¢æŠ•é‡æ–°æ¶ˆè´¹æ˜¯ä¸åˆé€‚çš„,æ‰€ä»¥åœ¨è¿™é‡Œéœ€è¦éå†response,ç„¶åä¿å­˜è¿›æ¸…ç©ºäº†çš„domainseté‡Œé¢./">www.baidu.comï¼Œä½†æ˜¯rpcæ¥å£é‡Œé¢æ­»æ´»æ²¡æœ‰ï¼Œè¿™ä¸ªæ—¶å€™å†å»é‡æ–°å¾€kafkaé‡Œé¢æŠ•é‡æ–°æ¶ˆè´¹æ˜¯ä¸åˆé€‚çš„ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œéœ€è¦éå†responseï¼Œç„¶åä¿å­˜è¿›æ¸…ç©ºäº†çš„domainSeté‡Œé¢ã€‚</a></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@KafkaListener(</span></span><br><span class="line"><span class="meta">        //è¿™é‡Œæ˜¯&#123;&#125;ï¼Œå¯ä»¥é…ç½®å¤šä¸ªtopic</span></span><br><span class="line"><span class="meta">        topics = &#123;TOPIC&#125;,</span></span><br><span class="line"><span class="meta">        groupId = &quot;recommendation-ready-group-bugfix-v1&quot;,</span></span><br><span class="line"><span class="meta">        containerFactory = &quot;recommendDomainDataListenerContainer&quot;</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listener</span><span class="params">(List&lt;ConsumerRecord&lt;String, String&gt;&gt; records)</span> &#123;</span><br><span class="line">    log.info(<span class="string">&quot;RecommendDomainDataListener | size:&#123;&#125;&quot;</span>, records.size());</span><br><span class="line">    Set&lt;String&gt; domains = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">    Set&lt;String&gt; domainSet = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">    <span class="type">StopWatch</span> <span class="variable">sw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StopWatch</span>();</span><br><span class="line">    sw.start();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">for</span>(ConsumerRecord&lt;String, String&gt; record :records) &#123;</span><br><span class="line">            <span class="type">JSONObject</span> <span class="variable">kafkaMsg</span> <span class="operator">=</span> JSON.parseObject(record.value());</span><br><span class="line">            <span class="type">String</span> <span class="variable">domain</span> <span class="operator">=</span> kafkaMsg.getString(<span class="string">&quot;domain&quot;</span>);</span><br><span class="line">            domain = DomainUtil.format(domain);</span><br><span class="line">            <span class="keyword">if</span>(StringUtils.isBlank(domain)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            domains.add(domain);</span><br><span class="line">            domainSet.add(domain);</span><br><span class="line">        &#125;</span><br><span class="line">        batchGetRecommendationDetail(domains,domainSet);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Throwable e)&#123;</span><br><span class="line">        <span class="keyword">for</span> (String domain : domainSet)&#123;</span><br><span class="line">            Map&lt;String,String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            map.put(<span class="string">&quot;domain&quot;</span>,domain);</span><br><span class="line">            kafkaProducer.send(TOPIC, domain, JSON.toJSONString(map));</span><br><span class="line">        &#125;</span><br><span class="line">        log.error(<span class="string">&quot;RecommendDomainDataListener | consumer message error. put in queue &#123;&#125;.&quot;</span>, JSON.toJSONString(domains),e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span> &#123;</span><br><span class="line">        sw.stop();</span><br><span class="line">        log.info(<span class="string">&quot;RecommendDomainDataListener | &#123;&#125;, cost: &#123;&#125;&quot;</span>, domains.size(), sw.getTime());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-GRPCè¯·æ±‚"><a href="#3-GRPCè¯·æ±‚" class="headerlink" title="3.GRPCè¯·æ±‚"></a>3.GRPCè¯·æ±‚</h2><p>grpcæ˜¯è®©è¿œç¨‹æ–¹æ³•å˜å¾—åƒæœ¬åœ°æ–¹æ³•ä¸€æ ·ç®€å•ï¼Œè¿™é‡Œç”¨äº†æ¨èä¾§çš„ä¸€ä¸ªæ¥å£ï¼Œç¡®å®åªç”¨å¼•ç”¨ä¸€ä¸ªjaråŒ…å°±è¡Œï¼ŒèƒŒåå°±æ˜¯ä¸€äº›å¤æ‚çš„ç½‘ç»œè¯·æ±‚ã€‚è¿™ä¸ªæ¥å£çš„å¯ä»¥ä¸€æ¬¡ä¼ 50ä¸ªdomainï¼ŒçŠ¶æ€ç ä¸»è¦å…³æ³¨429ï¼Œè¿™é‡Œæ˜¯è§¦å‘äº†é™æµï¼Œéœ€è¦æŒ‰ç…§ä¸Šé¢çš„æ–¹æ³•è¿›è¡Œé‡æ–°æ¶ˆè´¹ï¼Œæ¶ˆè´¹å¤šå°‘å‘é€å¤šå°‘ç›¸åŒçš„åŸŸåã€‚</p>
<blockquote>
<p>grpcæ–¹æ³•çš„qpsæ˜¯1ï¼Œè§¦å‘äº†é™æµè¦é™é€Ÿï¼ŒThread.sleep(1000);</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">batchGetRecommendationDetail</span><span class="params">(Set&lt;String&gt; domains,Set&lt;String&gt; domainSet)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    Recommendation.<span class="type">GetDomainInfosRequest</span> <span class="variable">request</span> <span class="operator">=</span> Recommendation.GetDomainInfosRequest.newBuilder()</span><br><span class="line">            .addAllDomains(domains)</span><br><span class="line">            .setDomainSourceValue(DOMAIN_SOURCE_GRPC_VALUE).build();</span><br><span class="line">    Recommendation.<span class="type">GetDomainInfosResponse</span> <span class="variable">response</span> <span class="operator">=</span> recommendationClient.getDomainInfos(request);</span><br><span class="line">    <span class="keyword">if</span> (response != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!response.getSuccess() || response.getCode() != GRPC_SUCCESS_CODE)&#123;</span><br><span class="line">            <span class="comment">//è§¦å‘grpcé™æµï¼Œè¯¥æ–¹æ³•é™é€Ÿï¼Œé‡æ–°æ¶ˆè´¹</span></span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(String.valueOf(response.getCode()));</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(<span class="string">&quot;getRecommendationDetail. code:&#123;&#125;&quot;</span>,response.getCode());</span><br><span class="line">        <span class="keyword">if</span>(!CollectionUtils.isEmpty(response.getDataList()))&#123;</span><br><span class="line">            List&lt;Recommendation.DomainInfo&gt; domainInfoList = response.getDataList();</span><br><span class="line">            <span class="keyword">for</span> (Recommendation.DomainInfo domainInfo : domainInfoList)&#123;</span><br><span class="line">                domainSet.add(domainInfo.getDomain());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (Recommendation.DomainInfo domainInfo : domainInfoList)&#123;</span><br><span class="line">                convert(domainInfo,domainSet);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Recommendation.GetDomainInfosResponse returns null&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="4-è½¬æ¢å¯¹è±¡"><a href="#4-è½¬æ¢å¯¹è±¡" class="headerlink" title="4.è½¬æ¢å¯¹è±¡"></a>4.è½¬æ¢å¯¹è±¡</h2><p>è¿™ä¸ªæ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œå°±æ˜¯æ‹·è´å±æ€§åˆ°å½“å‰é¡¹ç›®çš„bean</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ä¸»è¦ç†Ÿæ‚‰äº†æµ‹è¯•ç¯å¢ƒå’Œçº¿ä¸Šç¯å¢ƒï¼Œä»¥åŠkafkaçš„ä¸€äº›é…ç½®å’Œæœºåˆ¶ï¼Œå¯¹äºå¼‚å¸¸å¤„ç†çš„ç†è§£åŠ æ·±äº†ã€‚</p>
<h1 id="éœ€æ±‚2ï¼šå®šæ—¶å‘é€æ–°åŸŸå"><a href="#éœ€æ±‚2ï¼šå®šæ—¶å‘é€æ–°åŸŸå" class="headerlink" title="éœ€æ±‚2ï¼šå®šæ—¶å‘é€æ–°åŸŸå"></a>éœ€æ±‚2ï¼šå®šæ—¶å‘é€æ–°åŸŸå</h1><p>éœ€è¦æ¯å¤©çš„00:00å»esé‡Œé¢æ£€æŸ¥æ˜¨å¤©æ–°å¢çš„åŸŸåï¼Œé€šè¿‡kafkaå‘é€æ¶ˆæ¯ã€‚</p>
<ol>
<li>è®¡ç®—æ˜¨å¤©00:00åˆ°23ï¼š59çš„æ—¶é—´æˆ³ï¼šç”±äºå­—æ®µé‡Œé¢åªæœ‰updateTimeæ²¡æœ‰createTimeï¼Œè€Œä¸”ä¹Ÿæ˜¯ç”¨æ—¶é—´æˆ³æ¥ä¿å­˜çš„ï¼Œè¦å…ˆè®¡ç®—ä¸€ä¸‹æ—¶é—´ã€‚</li>
<li>æ‹¼esçš„æŸ¥è¯¢è¯­å¥ï¼šrangeæ¥æŸ¥è¯¢æ—¶é—´ï¼ŒsynFlagæ˜¯é˜²æ­¢é‡å¤å‘é€çš„ï¼Œæœ‰è¿™ä¸ªå­—æ®µçš„å¯ä»¥è®¤ä¸ºå·²ç»å‘è¿‡äº†ã€‚</li>
<li>scrollSearchå¾ªç¯æŸ¥æ‰¾ï¼Œä¸äº†è§£ï¼Œä½†æ˜¯å¤§å®¶éƒ½æ˜¯è¿™æ ·ç”¨çš„ã€‚</li>
</ol>
<blockquote>
<p>esçš„æ“ä½œè·Ÿæ•°æ®åº“å¾ˆåƒï¼Œè€Œä¸”ç½‘æ˜“å°è£…çš„å¾ˆå¥½ï¼Œindexå°±ç›¸å½“äºæ•°æ®åº“è¡¨åï¼ŒDomainDataIndexå¯ä»¥çœ‹ä½œmybatisçš„å®ç°ç±»ï¼ŒAbstractIndexå°±æ˜¯BaseMapperé‚£ç§ç”¨æ¥åŸºç¡€çš„</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@XxlJob(&quot;newDomainSyncRecommend&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ReturnT&lt;String&gt; <span class="title function_">newDomainSyncRecommend</span> <span class="params">(String param)</span> <span class="keyword">throws</span> ParseException &#123;</span><br><span class="line">    <span class="comment">//æ˜¨å¤©çš„åŒä¸€æ—¶åˆ»</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">yesterday</span> <span class="operator">=</span> System.currentTimeMillis() - <span class="number">1000</span> * <span class="number">3600</span> * <span class="number">24</span>;</span><br><span class="line">    <span class="comment">//æ˜¨å¤©é›¶ç‚¹é›¶åˆ†é›¶ç§’çš„æ¯«ç§’æ•°</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">zero</span> <span class="operator">=</span> yesterday / (<span class="number">1000</span> * <span class="number">3600</span> * <span class="number">24</span>) * (<span class="number">1000</span> * <span class="number">3600</span> * <span class="number">24</span>) - TimeZone.getDefault().getRawOffset();<span class="comment">//ä»Šå¤©é›¶ç‚¹é›¶åˆ†é›¶ç§’çš„æ¯«ç§’æ•°</span></span><br><span class="line">    <span class="comment">//æ˜¨å¤©23ç‚¹59åˆ†59ç§’çš„æ¯«ç§’æ•°</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">twelve</span> <span class="operator">=</span> zero + <span class="number">24</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">1000</span> - <span class="number">1</span>;</span><br><span class="line">    <span class="type">BoolQueryBuilder</span> <span class="variable">boolQuery</span> <span class="operator">=</span> QueryBuilders.boolQuery();</span><br><span class="line">    boolQuery.filter(QueryBuilders.rangeQuery(<span class="string">&quot;updateTime&quot;</span>)</span><br><span class="line">            .gte(zero)</span><br><span class="line">            .lte(twelve));</span><br><span class="line">    boolQuery.mustNot(QueryBuilders.existsQuery(<span class="string">&quot;synFlag&quot;</span>));</span><br><span class="line">    <span class="type">SearchSourceBuilder</span> <span class="variable">sourceBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchSourceBuilder</span>()</span><br><span class="line">            .query(boolQuery) <span class="comment">// æŸ¥è¯¢å‚æ•°</span></span><br><span class="line">            .fetchSource(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;domain&quot;</span>&#125;,</span><br><span class="line">                    <span class="literal">null</span>)</span><br><span class="line">            .size(<span class="number">100</span>);</span><br><span class="line">    <span class="keyword">if</span> (domainDataIndex == <span class="literal">null</span>) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;domainDataIndex is null&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    domainDataIndex.scrollSearch(sourceBuilder, searchHits -&gt; &#123;</span><br><span class="line">        <span class="keyword">for</span> (SearchHit searchHit : searchHits) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">domain</span> <span class="operator">=</span> searchHit.getId();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//æ›´æ–°åŒæ­¥æ ‡è¯†</span></span><br><span class="line">                Map&lt;String,Boolean&gt; updateMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">                updateMap.put(<span class="string">&quot;synFlag&quot;</span>,<span class="literal">true</span>);</span><br><span class="line">                domainDataIndex.updateByProcessor(domain,updateMap);</span><br><span class="line">                log.info(<span class="string">&quot;domainDataIndex upsert success ,domain : &#123;&#125;&quot;</span>,domain);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Throwable e)&#123;</span><br><span class="line">                log.error(<span class="string">&quot;domainDataIndex upsert failed ,domain : &#123;&#125;&quot;</span>,domain,e);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//ç»„ç»‡kafkaæ¶ˆæ¯</span></span><br><span class="line">            <span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">            jsonObject.put(<span class="string">&quot;domain&quot;</span>,domain);</span><br><span class="line">            kafkaProducer.send(<span class="string">&quot;new_domain_sync_recommend_topic&quot;</span>,domain,JSON.toJSONString(jsonObject));</span><br><span class="line">            log.info(<span class="string">&quot;kafka send success ,domain : &#123;&#125;&quot;</span>,domain);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> ReturnT.SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

    
    
  </div>

  

  

</article>
  
  <article class="post">
  <header class="post-header">
    <h1 class="post-title">
      
      <a class="post-link" href="/2024/10/19/%E9%A1%B9%E7%9B%AE%E9%9D%A2%E8%AF%95/">é¡¹ç›®é¢è¯•</a>
      
    </h1>

    <div class="post-meta">
      <span class="post-time">
        2024-10-19
      </span>
      
      
      
    </div>
  </header>

  

  <div class="post-content">
    
    
    

    
    <h2 id="ç™»å½•æµç¨‹å’Œç™»å½•çŠ¶æ€ä¿å­˜"><a href="#ç™»å½•æµç¨‹å’Œç™»å½•çŠ¶æ€ä¿å­˜" class="headerlink" title="ç™»å½•æµç¨‹å’Œç™»å½•çŠ¶æ€ä¿å­˜"></a>ç™»å½•æµç¨‹å’Œç™»å½•çŠ¶æ€ä¿å­˜</h2><ul>
<li>ä¹˜å®¢ç™»å½•ï¼šé¦–å…ˆæ ¹æ®å‰ç«¯å¾®ä¿¡å°ç¨‹åºä¼ æ¥çš„codeè¿›è¡Œä¹˜å®¢openidçš„è§£æï¼Œæ ¹æ®è¿™ä¸ªopenidè¿›è¡Œè½åº“ã€‚åœ¨æˆ‘ä»¬çš„é¡¹ç›®ä¸­ä¸ä¼šå¯¹å¤–æš´éœ²è¿™ä¸ªopenidï¼Œä½¿ç”¨çš„æ˜¯è‡ªå·±ç³»ç»Ÿçš„è‡ªå¢idã€‚å¦‚æœæ²¡æœ‰æ³¨å†Œå°±insertä¸€æ¡ã€‚æ¥ç€ç”¨rediså­˜å‚¨ç™»å½•çŠ¶æ€ï¼Œkeyæ˜¯UUIDï¼Œvalueæ˜¯è‡ªå·±æ•°æ®åº“çš„è‡ªå¢idã€‚æˆ‘ä»¬è¿™é‡Œç”¨çš„aop+threadlocal+æ³¨è§£ç±»ä¼¼ç½‘å…³çš„prehandleï¼Œå¤„ç†å‰ç«¯æ¯æ¬¡éƒ½æºå¸¦çš„tokenå­—æ®µï¼Œç„¶ååœ¨redisé‡Œæ ¹æ®è¿™ä¸ªkeyè¿›è¡ŒæŸ¥è¯¢ï¼Œå¦‚æœæ˜¯æ²¡æœ‰è¿™ä¸ªkeyå°±æ˜¯æ²¡æœ‰ç™»å½•è¿‡æœŸäº†ï¼Œå¦‚æœæ˜¯keyä¸ºç©ºå°±æ˜¯æ²¡æœ‰ç™»å½•ã€‚ç„¶åæ ¹æ®redisé‡Œçš„è¿™ä¸ªvalueå­˜å‚¨åˆ°threadlocalä¸­ï¼Œåç»­å°±å¯ä»¥ä»threadlocalä¸­getè¿™ä¸ªå­—æ®µè¿›è¡Œæ“ä½œã€‚</li>
<li>å¸æœºç™»å½•ï¼šæµç¨‹ä¸ä¸Šé¢çš„ç±»ä¼¼ï¼Œåªä¸è¿‡å¤šäº†é˜¿é‡Œäº‘çš„èº«ä»½æ ¡éªŒã€‚</li>
</ul>
<p><strong>threadLocalçš„åŸç†</strong></p>
<p>threadlocalæ˜¯æ ¹æ®çº¿ç¨‹ç‹¬ç«‹çš„å˜é‡ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯ä¸€ä¸ªçº¿ç¨‹å¯ä»¥å­˜å‚¨ä¸åŒçš„threadlocalï¼Œå½¼æ­¤æ˜¯éš”ç¦»çš„ã€‚å…¶åŸç†æ˜¯æ¯ä¸€ä¸ªThreadç±»éƒ½æœ‰ä¸€ä¸ªthreadLocalMapï¼Œè¿™ä¸ªmapç›¸å½“äºä¸€ä¸ªhashmapï¼Œkeyæ˜¯threadLocalå¯¹è±¡ï¼Œvalueæ˜¯å­˜å‚¨çš„å€¼ã€‚threadLocalæŸ¥è¯¢çš„æ—¶å€™å°±ä¼šå…ˆè·å–å½“å‰çº¿ç¨‹ï¼Œæ ¹æ®è¿™ä¸ªçº¿ç¨‹æ‰¾åˆ°threadLocalmapï¼Œå†æ‰¾åˆ°å…¶ä¸­çš„threadLocalå¯¹åº”çš„å€¼ã€‚</p>
<p><strong>threadLocalçš„å†…å­˜æ³„éœ²é—®é¢˜</strong></p>
<p>threadLocalmapçš„keyæ˜¯å¼±å¼•ç”¨ï¼Œvalueæ˜¯å¼ºå¼•ç”¨ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœthreadlocalæ²¡æœ‰å¤–éƒ¨å¼ºå¼•ç”¨å°±ä¼šè¢«å›æ”¶ï¼Œè€Œvalueä¸ä¼šè¢«å›æ”¶ã€‚è¿™ä¸ªæ—¶å€™å°±ä¼šæœ‰å†…å­˜æ³„éœ²é—®é¢˜äº†ã€‚è§£å†³æ–¹æ³•æ˜¯ä¸å†ä½¿ç”¨threadLocalå°±æ‰‹åŠ¨remove</p>
<h2 id="æœå¯»å‘¨å›´å¸æœºå’Œè®¢å•æ¨é€"><a href="#æœå¯»å‘¨å›´å¸æœºå’Œè®¢å•æ¨é€" class="headerlink" title="æœå¯»å‘¨å›´å¸æœºå’Œè®¢å•æ¨é€"></a>æœå¯»å‘¨å›´å¸æœºå’Œè®¢å•æ¨é€</h2><p>åœ¨å¸æœºå¼€å§‹æ¥å•ä¹‹åä¼šæŠŠè‡ªå·±çš„ä½ç½®ä¸Šä¼ åˆ°redisï¼Œç„¶åè¿›è¡Œç­‰å¾…ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­å¸æœºä¼šä¸æ–­è½®è¯¢è‡ªå·±redisçš„listæ˜¯å¦æœ‰æ•°æ®ã€‚åŒæ—¶ä¹˜å®¢ç«¯ä¸‹å•ä¹‹åä¼šæ–°å¢ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œä½¿ç”¨redisçš„grediuså‘½ä»¤æŸ¥è¯¢æ–¹åœ†5kmå†…çš„ç¬¦åˆè¦æ±‚çš„å¸æœºã€‚å¹¶ä¸”ä¸ºè¿™äº›å¸æœºçš„listéƒ½æ·»åŠ è¯¥è®¢å•å·ã€‚</p>
<p><strong>ä¸ºä»€ä¹ˆè¦ç”¨å®šæ—¶ä»»åŠ¡</strong></p>
<p>å› ä¸ºæ‰§è¡Œä¸€æ¬¡å¹¶ä¸ä¸€å®šå°±èƒ½åŠæ—¶å‘ç°å¸æœºï¼Œè½®è¯¢åˆå¤ªæ¶ˆè€—cpuï¼Œæ‰€ä»¥é‡‡ç”¨äº†å®šæ—¶ä»»åŠ¡ã€‚ä½¿ç”¨xxl-jobå¯ä»¥ç®¡ç†è¿™äº›å®šæ—¶ä»»åŠ¡ã€‚</p>
<p><strong>å¼‚å¸¸æ€ä¹ˆå¤„ç†çš„</strong></p>
<p>æœ‰ä¸€ä¸ªå…œåº•ç­–ç•¥å°±æ˜¯è¶…æ—¶15åˆ†é’Ÿè‡ªåŠ¨å–æ¶ˆï¼Œå¦‚æœåœ¨è¿è¡Œè¿‡ç¨‹ä¸­å‡ºç°å¤±è´¥é¦–å…ˆxxl-jobä¼šæ˜¾ç¤ºæ‰§è¡Œå¤±è´¥ï¼ŒåŒæ—¶è®°å½•æ—¥å¿—ã€‚</p>
<p><strong>å¦‚æœå‘¨å›´åªæœ‰ä¸€ä¸ªå¸æœºï¼Œä½†æ˜¯ä¸€ç›´ä¸æ¥å•ï¼Œå¦‚ä½•ä¿è¯ä»–çš„listä¸­æ¶ˆæ¯ä¸é‡å¤</strong></p>
<p>è¿™é‡Œä½¿ç”¨äº†redisçš„seté›†åˆï¼Œkeyæ˜¯è®¢å•çš„idï¼Œæ¯å½“ä»»åŠ¡è°ƒåº¦æœç´¢åˆ°æœ€è¿‘çš„å¸æœºä¹‹åé¦–å…ˆä¼šæ ¡éªŒå¸æœºçš„idæ˜¯å¦åœ¨setä¸­ï¼Œå¦‚æœä¸åœ¨æ‰å¯ä»¥åŠ å…¥è‡ªå·±çš„listã€‚å¦‚æœåœ¨çš„è¯è¯´æ˜æ˜¯é‡å¤æäº¤äº†ã€‚</p>
<p><strong>ä»»åŠ¡è°ƒåº¦ä½•æ—¶ç»ˆæ­¢</strong></p>
<p>åœ¨æŸ¥è¯¢å‘¨å›´å¸æœºä¹‹å‰éƒ½ä¼šå…ˆæ£€æŸ¥å½“å‰è®¢å•çš„çŠ¶æ€ï¼Œé€šè¿‡å¦ä¸€ä¸ªå¾®æœåŠ¡çš„è°ƒç”¨ã€‚å¦‚æœè¿™ä¸ªè®¢å•çš„çŠ¶æ€å‘ç”Ÿæ”¹å˜è¯´æ˜å·²ç»æœ‰å¸æœºæ¥å•äº†ï¼Œè¿™ä¸ªä»»åŠ¡å°±ä¼šæå‰ç»ˆæ­¢ã€‚</p>
<p><strong>ä¸ºä»€ä¹ˆä¸ç”¨mqå®ç°è¿™ä¸€éƒ¨åˆ†é€»è¾‘</strong></p>
<p>redisçš„é€Ÿåº¦è¾ƒå¿«ï¼Œæ¯•ç«Ÿç”¨æˆ·çš„è§„æ¨¡ä¸ä¼šå¾ˆå¤§ï¼Œlistçš„è§„æ¨¡ä¹Ÿä¸ä¼šå¾ˆå¤§ï¼Œæš‚æ—¶ä¸ä¼šå­˜åœ¨å¤§keyé—®é¢˜ã€‚è€Œä¸”ä¹Ÿéœ€è¦æ‰¹é‡å¤„ç†è¿™äº›æ¶ˆæ¯å’Œé¢‘ç¹çš„åˆ é™¤ï¼Œå¦‚æœä¸ºæ¯ä¸€ä¸ªå¸æœºéƒ½å»ºç«‹ä¸€ä¸ªqueueæœ‰ä¸€ç‚¹å¥¢ä¾ˆï¼Œç»¼åˆä¸‹æ¥è¿˜æ˜¯redisä¸­listèƒ½å¤Ÿç®€åŒ–æ“ä½œã€‚</p>
<h2 id="å¸æœºæŠ¢å•"><a href="#å¸æœºæŠ¢å•" class="headerlink" title="å¸æœºæŠ¢å•"></a>å¸æœºæŠ¢å•</h2><p>æ¯ä¸ªå¸æœºåœ¨æ¥å•çš„è¿‡ç¨‹ä¸­éƒ½ä¼šè½®è¯¢è‡ªå·±åœ¨redisä¸­çš„listæ˜¯å¦æœ‰æ•°æ®ï¼Œå¦‚æœæœ‰å‰ç«¯å°±ä¼šæ˜¾ç¤ºå¹¶ä¸”å¯ä»¥é€‰æ‹©è®¢å•è¿›è¡ŒæŠ¢å•ã€‚ä¸»è¦é€»è¾‘æ˜¯é¦–å…ˆä¼šæ£€æŸ¥æ˜¯å¦è¿˜æœ‰è®¢å•ï¼Œè¿™ä¸ªæ˜¯é€šè¿‡åœ¨redisçš„ä¸€ä¸ªæ ‡è¯†å®ç°çš„ï¼Œå†ä¸‹å•çš„æ—¶å€™ä¼šç»™redisä¸€ä¸ªæ ‡è¯†ã€‚ç›®çš„æ˜¯ä¸ç”¨å»æ•°æ®åº“æŸ¥æ‰¾å½“å‰è®¢å•çš„çŠ¶æ€èŠ‚çº¦æ•°æ®åº“å¼€é”€ã€‚ä¸ºäº†é˜²æ­¢è¶…å–è¦ç”¨åˆ†å¸ƒå¼é”ï¼Œä¸ºå½“å‰è®¢å•idåŠ é”ã€‚åŠ é”ä¹‹åå†æ¬¡æ ¡éªŒæ˜¯å¦æœ‰æ ‡è¯†ï¼Œè¿›è¡Œæ¥å•æ“ä½œååˆ é™¤è¿™ä¸ªæ ‡è¯†å’Œé‡Šæ”¾é”ï¼Œå®ŒæˆæŠ¢å•é€»è¾‘ã€‚</p>
<p><strong>åˆ†å¸ƒå¼é”ç”¨çš„æ˜¯ä»€ä¹ˆ</strong></p>
<p>åŸºäºredisionçš„åˆ†å¸ƒå¼é”ï¼Œé”ä½çš„æ˜¯å¸æœºlistä¸­çš„è®¢å•idã€‚æœ¬è´¨è¿˜æ˜¯åŸºäºsetnxçš„ï¼Œåªä¸è¿‡redissionæœ‰çœ‹é—¨ç‹—æœºåˆ¶èƒ½å¤Ÿå»¶é•¿æ‰§è¡Œæ—¶é—´ï¼Œä¿è¯ä»»åŠ¡èƒ½å¤Ÿè¿›è¡Œå®Œæˆè€Œä¸ä¼šå‡ºç°åˆ é™¤åˆ«äººçš„é”çš„æƒ…å†µã€‚è¿™é‡Œå¯ä»¥ä¼˜åŒ–çš„åœ°æ–¹å¯ä»¥åšæˆluaè„šæœ¬ï¼Œåæ­£æ ‡è¯†ä¹Ÿæ˜¯åœ¨redisé‡Œé¢çš„ã€‚é€»è¾‘æ˜¯æŸ¥è¯¢æ ‡è¯†ç„¶åå¼‚æ­¥ä¸‹å•ç»™mqã€‚ä¹Ÿä¼šç¼©çŸ­å¸æœºæŠ¢å•çš„å“åº”æ—¶é—´ï¼Œ</p>
<h2 id="å¸ä¹˜åŒæ˜¾"><a href="#å¸ä¹˜åŒæ˜¾" class="headerlink" title="å¸ä¹˜åŒæ˜¾"></a>å¸ä¹˜åŒæ˜¾</h2><p>åœ¨å¸æœºæ­£åœ¨å‰å¾€èµ·å§‹ç‚¹å’Œè¿›è¡ŒæœåŠ¡çš„æ—¶å€™ï¼Œä¹˜å®¢ä¹Ÿéœ€è¦çŸ¥é“å¸æœºåœ¨å“ªé‡Œã€‚å¸æœºä¼šå®šæ—¶å°†è‡ªå·±çš„æ•°æ®ä¸Šä¼ åˆ°mongodbä¸­ï¼Œä¹˜å®¢ç«¯ä¼šæ‰¾åˆ°æœ€è¿‘æ—¶é—´çš„å¸æœºç‚¹åæ ‡ï¼Œç„¶åè°ƒç”¨mapå¾®æœåŠ¡æ¸²æŸ“å‡ºè·¯å¾„ã€‚</p>
<p><strong>ä¸ºä»€ä¹ˆä½¿ç”¨mongodbï¼Œç”¨redisæˆ–è€…mysqlå­˜å‚¨å‘¢</strong></p>
<ul>
<li>è·¯å¾„æ•°æ®æ˜¯éœ€è¦æŒä¹…åŒ–ä¿å­˜çš„ï¼Œç”¨redisæ¯•ç«Ÿä¸æ˜¯è½åº“ï¼Œè€Œä¸”å­˜å‚¨çš„æ•°æ®é‡å¤§ä¸”åªéœ€è¦æ‰¾å‡ºæœ€è¿‘çš„ä¸€ä¸ªç‚¹ï¼Œå¤§éƒ¨åˆ†çš„æ•°æ®æ²¡æœ‰ç”¨ï¼Œä¼šæµªè´¹çè´µçš„ç¼“å­˜ç©ºé—´ï¼Œæ‰€ä»¥æœ€å¥½ä¸ç”¨redisã€‚</li>
<li>mysqlä¹Ÿä¸å¤ªé€‚åˆï¼Œå­˜å‚¨çš„ç‚¹æ•°æ®é‡å¾ˆå¤§è€Œmysqlè¶…è¿‡1kwæŸ¥è¯¢æ•ˆç‡å°±ä¼šå¾ˆä½ï¼Œä¹Ÿä¼šå­˜åœ¨æ·±åº¦åˆ†é¡µé—®é¢˜ï¼Œå¦‚æœå¤šä¸ªè®¢å•åŒæ—¶è¿›è¡Œå¹¶å‘ä¹Ÿæ˜¯mysqlçš„é—®é¢˜ã€‚å¤šä¸€ä¸ªå°‘ä¸€ä¸ªåæ ‡ç‚¹ä¸ä¼šæœ‰å¾ˆå¤§çš„é—®é¢˜ï¼Œæ‰€ä»¥ä½¿ç”¨å¦ä¸€ä¸ªæ•°æ®åº“è¿›è¡Œå­˜å‚¨ï¼Œç»è¿‡è°ƒç ”mongoèƒ½å¤Ÿæ»¡è¶³ã€‚</li>
</ul>
<p><strong>åŸºäºrocketmqçš„<del>å»¶è¿Ÿé˜Ÿåˆ—</del>å®Œæˆæ‰¹é‡å†™æ˜¯æ€ä¹ˆå®ç°çš„</strong></p>
<blockquote>
<p>è¿™é‡ŒçœŸæ˜¯çŠ¯äº†ä¸€ä¸ªå¤§é”™è¯¯ã€‚</p>
</blockquote>
<p>ä¸ºäº†å®ç°é«˜æ•ˆç‡å†™å¯ä»¥åˆå¹¶å¤šæ¬¡å†™è¯·æ±‚ï¼Œå®ç°æ‰¹é‡å†™ã€‚å…·ä½“æ˜¯è®¾ç½®rocketmqçš„æ‰¹é‡å¤„ç†åŠŸèƒ½ã€‚ä½†æ˜¯ä¼šå¢åŠ ä»£ç çš„å¤æ‚åº¦ï¼Œæ›´åŠ è½»é‡çº§çš„åšæ³•æ˜¯çº¿ç¨‹æ± å’Œé˜»å¡é˜Ÿåˆ—ã€‚</p>
<h2 id="å¼‚æ­¥ç¼–æ’"><a href="#å¼‚æ­¥ç¼–æ’" class="headerlink" title="å¼‚æ­¥ç¼–æ’"></a>å¼‚æ­¥ç¼–æ’</h2><p>åœ¨å®Œæˆè®¢å•åä¼šæœ‰ä¸€ç³»åˆ—çš„è®¡ç®—è¿‡ç¨‹ï¼Œä¾‹å¦‚é˜²åˆ·å•æ ¡éªŒï¼Œåˆ†è´¦è®¡ç®—ï¼Œæ¨é€è´¦å•ç­‰ã€‚</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[Start]</span><br><span class="line">   |</span><br><span class="line">   +--&gt; [è·å–è®¢å•ä¿¡æ¯]  ----+</span><br><span class="line">   |                        |</span><br><span class="line">   +--&gt; [è·å–å¸æœºä½ç½®] ------+--&gt; [ç­‰å¾…ä¸¤ä¸ªä»»åŠ¡å®Œæˆ]</span><br><span class="line">                                 |</span><br><span class="line">                                 v</span><br><span class="line">                       [è®¡ç®—è·ç¦»]</span><br><span class="line">                                 |</span><br><span class="line">               +-----------------+-----------------+</span><br><span class="line">               |                                   |</span><br><span class="line">        [è·ç¦» &gt; 2å…¬é‡Œ]                       [è·ç¦» &lt;= 2å…¬é‡Œ]</span><br><span class="line">               |                                   |</span><br><span class="line">         [æŠ›å‡ºå¼‚å¸¸]                         +----+----+</span><br><span class="line">                                               |         |</span><br><span class="line">                                       [è®¡ç®—å®é™…é‡Œç¨‹]   [è·å–è®¢å•æ•°é‡]</span><br><span class="line">                                               |         |</span><br><span class="line">                                       [è®¡ç®—è´¹ç”¨]    [è®¡ç®—å¥–åŠ±]</span><br><span class="line">                                               \         /</span><br><span class="line">                                                \       /</span><br><span class="line">                                        [è®¡ç®—åˆ†è´¦ä¿¡æ¯]</span><br><span class="line">                                               |</span><br><span class="line">                                      [å°è£…å¹¶æ›´æ–°è´¦å•]</span><br><span class="line">                                               |</span><br><span class="line">                                            [End]</span><br></pre></td></tr></table></figure>

<p>è€ƒè™‘å°†è·å–è®¢å•ä¿¡æ¯å’Œè·å–ç›®çš„åœ°è·ç¦»è¿›è¡Œå¹¶è¡Œå¤„ç†ï¼Œä½¿ç”¨supplyAsyncå®ç°ä¸¤ä¸ªçº¿ç¨‹ï¼Œæœ€ååˆå¹¶ä¸€èµ·è¿›è¡Œè®¡ç®—å¾—åˆ°ç»“æœï¼›å†æ ¡éªŒè·ç¦»æ˜¯å¦å†å¯ä»¥æ¥æ”¶çš„èŒƒå›´å†…ï¼Œå¦‚æœæ˜¯ä¸æ˜¯åˆ·å•å°±å¹¶è¡Œè·å–è®¢å•æ•°é‡å’Œè®¡ç®—å®é™…é‡Œç¨‹ï¼Œè¿™ä¸ªæ˜¯æ ¹æ®mongodbä¸­çš„æ•°æ®è®¡ç®—çš„ï¼Œå¾—åˆ°è¿™ä¸¤ä¸ªä¿¡æ¯è¿›è¡Œè´¦å•è®¡ç®—å’Œæ¨é€è´¦å•ã€‚ä¸»è¦æ˜¯å°†å‡ ä¸ªä¸ç›¸å…³çš„å¾®æœåŠ¡é€šè¿‡å¤šçº¿ç¨‹å¹¶è¡Œè·å–äº†ã€‚</p>
<p><strong>å¦‚ä½•æµ‹è¯•çš„40%æå‡</strong></p>
<p>æµ‹è¯•çš„è¯¥æ–¹æ³•çš„æ‰§è¡Œæ—¶é—´å‘ç°æ¯”åŸæ¥å¿«äº†40%ã€‚</p>
<h2 id="åˆ†å¸ƒå¼äº‹åŠ¡"><a href="#åˆ†å¸ƒå¼äº‹åŠ¡" class="headerlink" title="åˆ†å¸ƒå¼äº‹åŠ¡"></a>åˆ†å¸ƒå¼äº‹åŠ¡</h2><p><strong>TCCçš„æµç¨‹</strong></p>
<p>try-confirm-cancelï¼Œæ˜¯ä¸€ç§ä¸šåŠ¡å…¥ä¾µçš„åˆ†å¸ƒå¼äº‹åŠ¡æ–¹æ³•ã€‚tryé˜¶æ®µä¼šé¢„ç•™èµ„æºï¼Œconfirmé˜¶æ®µç¡®å®šåˆ†å¸ƒå¼äº‹åŠ¡ä¸‹æ‰€æœ‰çš„æ‰§è¡Œå™¨éƒ½å·²ç»æˆåŠŸé¢„ç•™ï¼Œå¦‚æœå…¨éƒ¨æˆåŠŸå°±æ‰§è¡Œconfirmæäº¤äº‹åŠ¡ï¼Œå¦‚æœå¤±è´¥äº†å°±æ‰§è¡Œè¡¥å¿æªæ–½cancelã€‚è¿™ç§æ–¹å¼æ¯”è¾ƒçµæ´»ï¼Œå¯ä»¥è‡ªå·±æ§åˆ¶äº‹åŠ¡ï¼Œä½†æ˜¯ä¹Ÿå…¥ä¾µäº†ä¸šåŠ¡ï¼Œä¼šé€ æˆä¸€äº›åˆ«çš„é—®é¢˜ï¼Œä¾‹å¦‚å¹‚ç­‰æ€§é—®é¢˜ï¼Œç©ºå›æ»šå’Œèµ„æºå€’æŒ‚ã€‚</p>
<p><strong>è§£é‡Šä¸€ä¸‹è¿™ä¸‰ä¸ªé—®é¢˜</strong></p>
<ul>
<li>å¹‚ç­‰æ€§ï¼šç”±äºç½‘ç»œæŠ–åŠ¨ç­‰é—®é¢˜å¯¼è‡´åœ¨confirmé˜¶æ®µå¯èƒ½å‡ºç°è¶…æ—¶é‡è¯•ï¼Œä½†æ˜¯æœ€ç»ˆä¸¤ä¸ªè¯·æ±‚éƒ½æ”¶åˆ°äº†ã€‚åœ¨seataçš„è§£å†³æ–¹å¼æ˜¯ç”¨ä¸€ä¸ªäº‹åŠ¡çŠ¶æ€è¡¨ï¼Œåœ¨confirm&#x2F;cancelçš„æ—¶å€™æäº¤ç»™äº‹åŠ¡çŠ¶æ€è¡¨ï¼Œåœ¨å¼€å§‹çš„æ—¶å€™åˆå»æ£€æŸ¥å­—æ®µçŠ¶æ€ï¼Œå¦‚æœæ˜¯å·²ç»confirmäº†çš„ï¼Œç¬¬äºŒä¸ªè¯·æ±‚å°±ä¼šè¢«å¿½ç•¥ï¼Œä»è€Œè¾¾åˆ°äº†å¹‚ç­‰æ€§</li>
<li>ç©ºå›æ»šï¼šåœ¨tryé˜¶æ®µæ²¡æœ‰æˆåŠŸçš„å¾®æœåŠ¡ä»ç„¶æ‰§è¡Œäº†å›æ»šï¼Œéœ€è¦å¯¹å¤±è´¥çš„å¾®æœåŠ¡è¿›è¡ŒåŒºåˆ«ã€‚åœ¨seataé‡Œä»ç„¶æ˜¯ç”¨äº‹åŠ¡çŠ¶æ€è¡¨ï¼Œåœ¨tryæˆåŠŸäº†æ‰ä¼šæœ‰statusï¼Œå›æ»šé˜¶æ®µæœ‰statusçš„æ‰èƒ½å›æ»š</li>
<li>èµ„æºå€’æŒ‚ï¼šç”±äºç½‘ç»œåŸå› tryé˜»å¡äº†ï¼Œç»“æœå›æ»šäº†ï¼Œä½†æ˜¯åç»­ç½‘ç»œæ¢å¤äº†ä»ç„¶ä¼šé¢„ç•™èµ„æºï¼Œä½¿å¾—èµ„æºè¢«å€’æŒ‚ã€‚è§£å†³æ–¹æ¡ˆä»ç„¶æ˜¯äº‹åŠ¡çŠ¶æ€è¡¨ï¼Œåœ¨å›æ»šçš„æ—¶å€™æ’å…¥ä¸€æ¡suspend&#x3D;4ï¼Œåœ¨tryçš„æ—¶å€™å…ˆæ ¡éªŒæ˜¯ä¸æ˜¯å€’æŒ‚äº†ï¼Œå¦‚æœ&#x3D;4å°±ä¸ç”¨é¢„ç•™èµ„æºã€‚</li>
</ul>
<p><strong>å…·ä½“åœ¨ä»£ç é‡Œæ˜¯æ€ä¹ˆåšçš„</strong></p>
<p>ä¾‹å¦‚æˆ‘ä»¬çš„æ”¯ä»˜æ¨¡å—ï¼Œéœ€è¦ä¿®æ”¹é‡‘é¢å’Œå•†å“æ•°é‡ï¼Œç„¶åä¸‹å•ã€‚è¿™ä¸ªæ—¶å€™å°±è¦ç”¨åˆ°åˆ†å¸ƒå¼äº‹åŠ¡äº†ã€‚æ¯ä¸€ä¸ªå¾®æœåŠ¡æ¨¡å—éƒ½è¦å®ç°tccä¸‰ä¸ªæ¥å£ï¼Œåœ¨tryçš„æ¥å£ä¸Šä½¿ç”¨@TwoPhaseBusinessActionï¼ŒæŒ‡å®šåœ¨seataæœåŠ¡ä¸­çš„idä»¥åŠå›æ»šå’Œæäº¤çš„æ–¹æ³•åï¼Œæ¥ç€åœ¨ä»£ç å®ç°å“åº”é€»è¾‘ã€‚å¯¹äºæ•°æ®åº“è€Œè¨€å¢åŠ ä¸€ä¸ªfrozenå­—æ®µï¼Œtryé˜¶æ®µé¦–å…ˆå‡å°‘æ•°é‡ï¼Œfrozenå¢åŠ ï¼Œcanceläº†å°±åšç›¸åæ“ä½œï¼Œå¦‚æœconfirmäº†å°±å‡å°‘frozenå®é™…æäº¤ã€‚</p>
<h2 id="è§„åˆ™å¼•æ“"><a href="#è§„åˆ™å¼•æ“" class="headerlink" title="è§„åˆ™å¼•æ“"></a>è§„åˆ™å¼•æ“</h2><p>ç”¨è§„åˆ™å¼•æ“åšäº†ä¸€äº›è®¡ç®—</p>
<ul>
<li>ä¾‹å¦‚æ ¹æ®è·ç¦»å’Œå®é™…é¢„ä¼°å‡ºä»·æ ¼ï¼Œä¾‹å¦‚åœ¨7ç‚¹ä¹‹å‰èµ·æ­¥ä»·æ˜¯å¤šå°‘å¤šå°‘é’±ï¼Œæ¯å…¬é‡Œçš„ä»·æ ¼è®¡ç®—ã€‚ä½¿ç”¨è§„åˆ™å¼•æ“é˜²æ­¢å°†è§„åˆ™å’Œä»·æ ¼ç¡¬ç¼–ç åœ¨ä»£ç é‡Œï¼Œæ–¹ä¾¿å®é™…éƒ¨ç½²åŠ¨æ€å˜æ›´ã€‚</li>
<li>è®¡ç®—è´¦å•ä¹Ÿä½¿ç”¨åˆ°äº†è§„åˆ™å¼•æ“ï¼Œä¾‹å¦‚æŒ‰ç…§ä»€ä¹ˆæ¯”ä¾‹åˆ†æˆï¼Œæ ¹æ®è®¢å•å¤šå°‘ç»™äºˆå¥–åŠ±</li>
</ul>
<p><strong>ä½†æ˜¯å®é™…å·¥ä½œé‡Œé¢éƒ½ä¸å¤ªä¼šç”¨åˆ°è¿™ä¸ªä½ çŸ¥é“æ˜¯ä¸ºä»€ä¹ˆå—</strong></p>
<p>æˆ‘è§‰å¾—é¦–å…ˆæ˜¯å­¦ä¹ æˆæœ¬çš„é—®é¢˜ï¼Œè¿™ä¸ªä¸œè¥¿è¯­æ³•ç¡®å®ä¹Ÿå¾ˆå†—æ‚ï¼Œè™½ç„¶åœ¨javaä»£ç é‡Œé¢ä¸ç”¨ç¡¬ç¼–ç äº†ï¼Œä½†æ˜¯å‡ ä¸ªifelseå´è¦ç”¨æ›´é•¿çš„ä»£ç è¡¨ç¤ºã€‚æŸäº›æ—¶å€™è¿™ä¸ªæœåŠ¡ä¹Ÿä¼šæˆä¸ºç“¶é¢ˆã€‚</p>
<h2 id="å®ä¹ é¡¹ç›®"><a href="#å®ä¹ é¡¹ç›®" class="headerlink" title="å®ä¹ é¡¹ç›®"></a>å®ä¹ é¡¹ç›®</h2><h3 id="ä¸šåŠ¡æ˜¯ä»€ä¹ˆ"><a href="#ä¸šåŠ¡æ˜¯ä»€ä¹ˆ" class="headerlink" title="ä¸šåŠ¡æ˜¯ä»€ä¹ˆ"></a>ä¸šåŠ¡æ˜¯ä»€ä¹ˆ</h3><p>å®ç°äººå·¥æ™ºèƒ½æ£€æµ‹å¹³å°å’Œä¸»å¹³å°çš„æ¥å£ï¼Œå…·ä½“æ˜¯å®šæ—¶å‘é€æŒ‡ä»¤åˆ°è§†é¢‘æµå¹³å°ï¼Œæˆªå›¾å…¥åº“åé€šè¿‡è¿™ä¸ªæ¥å£çš„ä¸€ç³»åˆ—å®šæ—¶ä»»åŠ¡æäº¤ç»™äººå·¥æ™ºèƒ½æ£€æµ‹å¹³å°è¿”å›ç»“æœè¿›è¡Œç»Ÿè®¡ã€‚ç»Ÿè®¡å®Œæˆåç”¨kafkaå¼‚æ­¥è½åº“å¹¶è¿”å›ç»™å‰ç«¯ã€‚é™¤æ­¤ä¹‹å¤–è¿˜æœ‰ä¸€äº›æ–‡æ¡£å’Œå¢åˆ æ”¹æŸ¥çš„å·¥ä½œã€‚</p>
<h3 id="xxl-jobæ˜¯æ€ä¹ˆç”¨çš„ï¼Œä½ çš„é¡¹ç›®é‡Œé¢æœ‰å“ªäº›å®šæ—¶ä»»åŠ¡ä¼šéœ€è¦ç”¨åˆ°è¿™ä¸ª"><a href="#xxl-jobæ˜¯æ€ä¹ˆç”¨çš„ï¼Œä½ çš„é¡¹ç›®é‡Œé¢æœ‰å“ªäº›å®šæ—¶ä»»åŠ¡ä¼šéœ€è¦ç”¨åˆ°è¿™ä¸ª" class="headerlink" title="xxl-jobæ˜¯æ€ä¹ˆç”¨çš„ï¼Œä½ çš„é¡¹ç›®é‡Œé¢æœ‰å“ªäº›å®šæ—¶ä»»åŠ¡ä¼šéœ€è¦ç”¨åˆ°è¿™ä¸ª"></a>xxl-jobæ˜¯æ€ä¹ˆç”¨çš„ï¼Œä½ çš„é¡¹ç›®é‡Œé¢æœ‰å“ªäº›å®šæ—¶ä»»åŠ¡ä¼šéœ€è¦ç”¨åˆ°è¿™ä¸ª</h3><p>xxl-jobæ˜¯ä¸€ä¸ªå¼€ç®±å³ç”¨çš„åˆ†å¸ƒå¼è°ƒåº¦å¹³å°ï¼Œä¸ä¼ ç»Ÿçš„quatazç›¸æ¯”å¯ä»¥åŠ¨æ€æ”¹å˜cronè¡¨è¾¾å¼ï¼Œè¿˜å…·æœ‰å¯è§†åŒ–çš„ç•Œé¢ã€‚ç”±äºå®ä¹ å•ä½åç«¯æœ‰å¾ˆå¤šçš„å®šæ—¶ä»»åŠ¡ï¼Œå†™æ­»cronè¡¨è¾¾å¼ä¸åˆ©äºç®¡ç†</p>
<ol>
<li>é¦–å…ˆæ˜¯æˆªå›¾æŒ‡ä»¤ï¼Œä¼šä¼ é€’å‡ ä¸ªå‚æ•°é€šè¿‡httpæ§åˆ¶è§†é¢‘æµå¹³å°ï¼Œå…¶ä¸­å‚æ•°ä¼šåŒ…å«é—´éš”æ—¶é—´ï¼Œè§†é¢‘æµå¹³å°ä¹Ÿä¼šæ ¹æ®è¿™ä¸ªè¿›è¡Œå®šæ—¶è½åº“ã€‚</li>
<li>æ¥ç€æ˜¯å®šæ—¶ç»™äººå·¥æ™ºèƒ½å¹³å°ä¼ è¾“ï¼Œå› ä¸ºå¹³å°æœ‰å¾ˆå¤šçš„æ£€æµ‹ç®—æ³•ï¼Œæ¥å£éƒ½ä¸æ˜¯å¾ˆç»Ÿä¸€ã€‚è¿™é‡Œæœ‰ä¸€äº›å¾ˆé•¿çš„ifåˆ¤å®šè¿‡ç¨‹ã€‚ä¾‹å¦‚æœªä½©æˆ´å®‰å…¨å¸½ æœªä½©æˆ´ç»ç¼˜æ‰‹å¥—  é è¿‘å˜å‹å™¨å‘Šè­¦ã€å·¥ä½œæœï¼Œæˆ–è€…æ˜¯ç”»é¢æ— äººã€‚è¿™é‡Œç”¨äº†ä¸€ä¸ªçº¿ç¨‹æ± æ¥å¹¶å‘å®Œæˆè¿™äº›å›¾ç‰‡çš„æ ¡éªŒå’Œä¼ è¾“ï¼Œè¿˜ç”¨äº†ç­–ç•¥æ¨¡å¼æŠŠè¿™äº›æ ¡éªŒçš„å¾ˆé•¿çš„ifelseç»™ç®€åŒ–äº†ã€‚å…·ä½“æ˜¯ç”¨ä¸€ä¸ªå…¬ç”¨çš„ç­–ç•¥æ¥å£ï¼Œç„¶åä¸Šä¸‹æ–‡ç±»ä¸­æ›¿æ¢è¿™ä¸ªæ¥å£çš„å®ç°ç±»æ¥å®Œæˆç­–ç•¥é€‰æ‹©ã€‚æœ€ååœ¨ç­–ç•¥å·¥å‚é‡Œé¢ç”¨å“ˆå¸Œè¡¨æ¥ä¿å­˜ç±»å‹å’Œå…·ä½“ç­–ç•¥çš„æ˜ å°„å…³ç³»ã€‚</li>
<li>è¿˜æœ‰ä¸€ä¸ªå®šæ—¶ä»»åŠ¡æ˜¯æ¯å¤©æ—©ä¸Š1ç‚¹é’Ÿåˆ é™¤ä¿å­˜äº†3å¤©ä»¥ä¸Šçš„ç…§ç‰‡</li>
<li>äººè„¸æ³¨å†Œæ¯åˆ†é’Ÿä»æ•°æ®åº“æŠ½200å¼ ç»™äººå·¥æ™ºèƒ½å¹³å°ï¼Œäººå·¥æ™ºèƒ½å¹³å°è‡ªå·±ä¹Ÿæœ‰æ•°æ®åº“ï¼Œåœ¨è¿™ä¸ªç³»ç»Ÿé‡Œé¢ä¹Ÿæœ‰ï¼Œè¿™ä¸ªæ—¶å€™è™½ç„¶æ˜¯é€šè¿‡httpä¼ è¾“çš„ï¼Œä½†æ˜¯ä¹Ÿå¯ä»¥çœ‹ä½œä¸€ä¸ªåˆ†å¸ƒå¼çš„äº‹åŠ¡ï¼Œç”±äºè¿™ä¸ªç³»ç»Ÿä¸šåŠ¡èŒƒå›´ä¸æ˜¯æˆ‘ä»¬çš„ï¼Œæ‰€ä»¥ç”¨åˆ†å¸ƒå¼äº‹åŠ¡ä¹Ÿä¸å¤ªåˆç†ã€‚æ‰€ä»¥å°±æƒ³åˆ°ç”¨kafkaä¿è¯æœ€ç»ˆä¸€è‡´æ€§ã€‚</li>
</ol>
<h3 id="kafkaæ€ä¹ˆä¿è¯æœ€ç»ˆä¸€è‡´æ€§çš„"><a href="#kafkaæ€ä¹ˆä¿è¯æœ€ç»ˆä¸€è‡´æ€§çš„" class="headerlink" title="kafkaæ€ä¹ˆä¿è¯æœ€ç»ˆä¸€è‡´æ€§çš„"></a>kafkaæ€ä¹ˆä¿è¯æœ€ç»ˆä¸€è‡´æ€§çš„</h3><p>ä¸»è¦ä¾èµ–kafkaçš„exactly onceè¯­ä¹‰ã€‚è¦å®ç°åªæäº¤ä¸€æ¬¡ä¸”åªèƒ½æ¶ˆè´¹ä¸€æ¬¡éœ€è¦ä¸‰æ–¹éƒ½åè°ƒã€‚å¯¹äºç”Ÿäº§è€…ä¹Ÿå°±æ˜¯æˆ‘ä»¬è¿™ä¸ªä»£ç é‡Œé¢ï¼Œè¦ä½¿ç”¨kafkaçš„å¹‚ç­‰å’Œäº‹åŠ¡ï¼Œé…ç½®kafkaçš„å¹‚ç­‰æ€§å¯ä»¥ä½¿ç”Ÿäº§è€…çš„æ¶ˆæ¯åªä¼šè¢«kafkaæ¥æ”¶ä¸€æ¬¡ï¼Œé…ç½®äº‹åŠ¡ä½¿å¾—æ¶ˆè´¹è€…åœ¨æ¶ˆè´¹æ¶ˆæ¯çš„æ—¶å€™åªèƒ½çœ‹åˆ°æäº¤äº‹åŠ¡çš„ï¼Œå¯¹äºkafkaè€Œè¨€ï¼Œç”±äºæˆ‘ä»¬å…¬å¸ä¹Ÿæ²¡é…ç½®kafkaé›†ç¾¤ï¼Œæ‰€ä»¥åªè®¾ç½®äº†acks&#x3D;1ï¼Œä¹Ÿå°±æ˜¯å†™å…¥æˆåŠŸåè¿”å›å›è°ƒå‡½æ•°ï¼Œè¿™æ ·èƒ½ä¿è¯kafkaä¸ä¸¢æ¶ˆæ¯ã€‚æ¶ˆè´¹è€…ä¸ºäº†ä¸é‡å¤æ¶ˆè´¹æ¶ˆæ¯ä¹Ÿéœ€è¦åšåˆ°å¹‚ç­‰ï¼Œè¿™é‡Œçš„å¹‚ç­‰æ ¡éªŒæ˜¯redisè¿›è¡Œå»é‡çš„ï¼Œç„¶åå†æ‰‹åŠ¨æäº¤ackã€‚è¿™æ ·èƒ½ä¿è¯å¦‚æœå‰é¢çš„å¹³å°æ‰§è¡Œå¤±è´¥äº†ï¼Œè¿™é‡Œçš„æ¥å£ä¹Ÿä¸ä¼šè½åº“ï¼›å¦‚æœæ‰§è¡ŒæˆåŠŸï¼Œé€šè¿‡kafkaçš„è¿™ä¸ªexactly onceå°±å¯ä»¥åªè½åº“ä¸€æ¬¡ã€‚</p>

    
    
  </div>

  

  

</article>
  
    
  <nav class="pagination">  
      
      
      <a class="next" href="/page/2/">  
        <span class="next-text">ä¸‹ä¸€é¡µ</span>  
        <i class="iconfont icon-right"></i>  
      </a>  
      
  </nav>  
  

  
</section>
        </div>
          

      </div>
    </main>
    <footer id="footer" class="footer">
      <!-- Social Links -->

<div class="social-links">
  
  
  
  
  <a href="mailto:1050886654@qq.com" class="iconfont icon-email" title="email"></a>
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <a target="_blank" rel="noopener" href="https://github.com/yyf1050886654" class="iconfont icon-github" title="github"></a>
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  

  
  
  <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
  
</div>



<div class="copyright">
  <span class="power-by">
    ç”± <a class="hexo-link" target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a> å¼ºåŠ›é©±åŠ¨
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    ä¸»é¢˜ -
    <a class="theme-link" target="_blank" rel="noopener" href="https://github.com/zeed-w-beez/hexo-theme-even">Even</a>
  </span>
  <span class="division">|</span>
  <span class="hosting-info">
    footer.hosting
  </span>

  <span class="copyright-year">
    <span>
      
      &copy;
      
      2024 - 2025      
    </span>

    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>

    <span class="author">Yifan Yang</span>
  </span>

</div>
    </footer>
    <div class="back-to-top" id="back-to-top"> <i class="iconfont icon-up"></i> </div>
  </div>
    

  







<script type="text/javascript" src="/lib/jquery"></script>



<script type="text/javascript" src="/lib/slideout"></script>



<script type="text/javascript" src="/lib/fancybox"></script>



  <script type="text/javascript" src="/js/src/even.js?v=3.0.0"></script>
</body>

</html>